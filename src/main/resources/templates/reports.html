<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DLP Shield - Reports & Analytics</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f3f4f6; overflow-x: hidden; }
        .dashboard-container { display: flex; min-height: 100vh; }
        .main-content { flex: 1; margin-left: 240px; transition: margin-left 0.3s; padding-top: 62px; }
        .main-content.expanded { margin-left: 70px; }
        .content-area { padding: 24px; }
        
        /* Header fixes for sidebar toggle */
        .top-header { left: 240px !important; }
        .main-content.expanded ~ .top-header { left: 70px !important; }
        
        .page-header { background: white; padding: 20px 24px; border-radius: 12px; border: 1px solid #e5e7eb; margin-bottom: 24px; display: flex; justify-content: space-between; align-items: center; }
        .page-title-section { display: flex; align-items: center; gap: 16px; }
        .page-icon { width: 48px; height: 48px; background: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center; }
        .page-icon i { font-size: 22px; color: white; }
        .page-title-text h1 { font-size: 1.5em; color: #111827; font-weight: 700; }
        .page-subtitle { color: #6b7280; font-size: 0.9em; }
        .generate-btn { padding: 10px 20px; background: #2563eb; color: white; border: none; border-radius: 8px; font-size: 0.9em; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; }
        .generate-btn:hover { background: #1d4ed8; }
        
        .filter-bar { background: white; padding: 16px 20px; border-radius: 12px; border: 1px solid #e5e7eb; margin-bottom: 20px; display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
        .filter-select { padding: 9px 12px; border: 1.5px solid #e5e7eb; border-radius: 8px; font-size: 0.9em; background: white; cursor: pointer; }
        .filter-btn { padding: 9px 16px; background: white; border: 1.5px solid #e5e7eb; border-radius: 8px; font-size: 0.9em; cursor: pointer; display: flex; align-items: center; gap: 6px; }
        .filter-btn:hover { background: #f9fafb; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .stat-card { background: white; padding: 18px; border-radius: 12px; border: 1px solid #e5e7eb; }
        .stat-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        .stat-label { font-size: 0.8em; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; }
        .stat-value { font-size: 1.8em; font-weight: 700; color: #111827; }
        .stat-icon { width: 42px; height: 42px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1em; }
        .stat-icon.red { background: #fee2e2; color: #dc2626; }
        .stat-icon.blue { background: #dbeafe; color: #3b82f6; }
        .stat-icon.green { background: #d1fae5; color: #10b981; }
        .stat-icon.purple { background: #e0e7ff; color: #6366f1; }
        .stat-change { font-size: 0.8em; color: #10b981; font-weight: 600; }
        
        .charts-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .chart-card { background: white; padding: 20px; border-radius: 12px; border: 1px solid #e5e7eb; }
        .chart-header { font-size: 1.05em; font-weight: 600; color: #111827; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid #e5e7eb; }
        
        .report-templates { background: white; padding: 20px; border-radius: 12px; border: 1px solid #e5e7eb; }
        .template-item { display: flex; justify-content: space-between; align-items: center; padding: 16px; background: #f9fafb; border-radius: 8px; margin-bottom: 12px; }
        .template-item:last-child { margin-bottom: 0; }
        .template-info { flex: 1; }
        .template-title { font-weight: 600; color: #111827; margin-bottom: 4px; }
        .template-desc { font-size: 0.85em; color: #6b7280; margin-bottom: 4px; }
        .template-date { font-size: 0.75em; color: #9ca3af; }
        .template-actions { display: flex; gap: 8px; }
        .btn-small { padding: 6px 12px; border-radius: 6px; font-size: 0.8em; font-weight: 600; cursor: pointer; border: none; display: flex; align-items: center; gap: 6px; }
        .btn-pdf { background: #dc2626; color: white; }
        .btn-pdf:hover { background: #b91c1c; }
        .btn-csv { background: #059669; color: white; }
        .btn-csv:hover { background: #047857; }
        
        @media (max-width: 1024px) { 
            .charts-grid { grid-template-columns: 1fr; } 
            .main-content { margin-left: 0; padding-top: 62px; }
            .top-header { left: 0 !important; }
        }
        @media (max-width: 968px) { 
            .main-content { margin-left: 0; padding-top: 62px; } 
            .stats-grid { grid-template-columns: repeat(2, 1fr); } 
            .top-header { left: 0 !important; }
        }
        @media (max-width: 640px) { 
            .content-area { padding: 16px; } 
            .stats-grid { grid-template-columns: 1fr; } 
            .filter-bar { flex-direction: column; align-items: stretch; } 
            .template-item { flex-direction: column; align-items: flex-start; gap: 12px; } 
            .template-actions { width: 100%; } 
            .btn-small { flex: 1; justify-content: center; }
            .main-content { padding-top: 62px; }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div id="sidebarContainer"></div>
        <main class="main-content" id="mainContent">
            <div id="headerContainer"></div>
            <div class="content-area">
                <div class="page-header">
                    <div class="page-title-section">
                        <div class="page-icon"><i class="fas fa-chart-line"></i></div>
                        <div class="page-title-text">
                            <h1>Reports & Analytics</h1>
                            <p class="page-subtitle">Generate insights and export security reports</p>
                        </div>
                    </div>
                    <button class="generate-btn" onclick="generateReport()">
                        <i class="fas fa-file-export"></i><span>Generate Report</span>
                    </button>
                </div>

                <div class="filter-bar">
                    <select class="filter-select">
                        <option>Last 30 days</option>
                        <option>Last 7 days</option>
                        <option>Last 90 days</option>
                        <option>Custom range</option>
                    </select>
                    <button class="filter-btn">
                        <i class="fas fa-filter"></i><span>More Filters</span>
                    </button>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-header">
                            <div>
                                <div class="stat-label">Total Violations</div>
                                <div class="stat-value">2,847</div>
                            </div>
                            <div class="stat-icon red"><i class="fas fa-triangle-exclamation"></i></div>
                        </div>
                        <div class="stat-change">+12% vs last period</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div>
                                <div class="stat-label">Policies Triggered</div>
                                <div class="stat-value">156</div>
                            </div>
                            <div class="stat-icon blue"><i class="fas fa-shield-alt"></i></div>
                        </div>
                        <div class="stat-change">Active policies</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div>
                                <div class="stat-label">Resolution Rate</div>
                                <div class="stat-value">94.2%</div>
                            </div>
                            <div class="stat-icon green"><i class="fas fa-check-circle"></i></div>
                        </div>
                        <div class="stat-change">+2.1% improvement</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div>
                                <div class="stat-label">Avg Response Time</div>
                                <div class="stat-value">4.2m</div>
                            </div>
                            <div class="stat-icon purple"><i class="fas fa-clock"></i></div>
                        </div>
                        <div class="stat-change">-30s faster</div>
                    </div>
                </div>

                <div class="charts-grid">
                    <div class="chart-card">
                        <div class="chart-header">Violations by Policy Type</div>
                        <div style="height: 200px; display: flex; align-items: flex-end; gap: 16px; padding: 20px;">
                            <div style="flex: 1; background: linear-gradient(180deg, #3b82f6 0%, #60a5fa 100%); border-radius: 8px 8px 0 0; height: 80%; display: flex; flex-direction: column; justify-content: flex-end; align-items: center; padding-bottom: 8px; color: white; font-weight: 600; font-size: 0.9em;">
                                <div>145</div>
                            </div>
                            <div style="flex: 1; background: linear-gradient(180deg, #3b82f6 0%, #60a5fa 100%); border-radius: 8px 8px 0 0; height: 100%; display: flex; flex-direction: column; justify-content: flex-end; align-items: center; padding-bottom: 8px; color: white; font-weight: 600; font-size: 0.9em;">
                                <div>289</div>
                            </div>
                            <div style="flex: 1; background: linear-gradient(180deg, #3b82f6 0%, #60a5fa 100%); border-radius: 8px 8px 0 0; height: 65%; display: flex; flex-direction: column; justify-content: flex-end; align-items: center; padding-bottom: 8px; color: white; font-weight: 600; font-size: 0.9em;">
                                <div>187</div>
                            </div>
                            <div style="flex: 1; background: linear-gradient(180deg, #3b82f6 0%, #60a5fa 100%); border-radius: 8px 8px 0 0; height: 45%; display: flex; flex-direction: column; justify-content: flex-end; align-items: center; padding-bottom: 8px; color: white; font-weight: 600; font-size: 0.9em;">
                                <div>92</div>
                            </div>
                            <div style="flex: 1; background: linear-gradient(180deg, #3b82f6 0%, #60a5fa 100%); border-radius: 8px 8px 0 0; height: 55%; display: flex; flex-direction: column; justify-content: flex-end; align-items: center; padding-bottom: 8px; color: white; font-weight: 600; font-size: 0.9em;">
                                <div>134</div>
                            </div>
                        </div>
                        <div style="display: flex; justify-content: space-around; padding-top: 12px;">
                            <span style="font-size: 0.75em; color: #6b7280;">USB Block</span>
                            <span style="font-size: 0.75em; color: #6b7280;">File Monitor</span>
                            <span style="font-size: 0.75em; color: #6b7280;">Network</span>
                            <span style="font-size: 0.75em; color: #6b7280;">OCR</span>
                            <span style="font-size: 0.75em; color: #6b7280;">Email</span>
                        </div>
                    </div>

                    <div class="chart-card">
                        <div class="chart-header">Threat Trend (6 Months)</div>
                        <svg width="100%" height="240" viewBox="0 0 400 200" style="margin-top: 12px;">
                            <polyline points="20,140 85,125 150,135 215,110 280,120 345,105" fill="none" stroke="#3b82f6" stroke-width="3"/>
                            <polyline points="20,140 85,125 150,135 215,110 280,120 345,105 345,200 20,200" fill="url(#grad2)" opacity="0.3"/>
                            <defs>
                                <linearGradient id="grad2" x1="0%" y1="0%" x2="0%" y2="100%">
                                    <stop offset="0%" style="stop-color:#3b82f6;stop-opacity:0.5" />
                                    <stop offset="100%" style="stop-color:#3b82f6;stop-opacity:0" />
                                </linearGradient>
                            </defs>
                            <text x="20" y="190" font-size="10" fill="#6b7280">Jan</text>
                            <text x="150" y="190" font-size="10" fill="#6b7280">Mar</text>
                            <text x="280" y="190" font-size="10" fill="#6b7280">May</text>
                        </svg>
                    </div>
                </div>

                <div class="report-templates">
                    <div class="chart-header">Report Templates</div>
                    
                    <div class="template-item">
                        <div class="template-info">
                            <div class="template-title">Executive Summary</div>
                            <div class="template-desc">High-level overview for leadership</div>
                            <div class="template-date">Last generated: 2024-01-14</div>
                        </div>
                        <div class="template-actions">
                            <button class="btn-small btn-pdf"><i class="fas fa-file-pdf"></i> PDF</button>
                            <button class="btn-small btn-csv"><i class="fas fa-file-csv"></i> CSV</button>
                        </div>
                    </div>

                    <div class="template-item">
                        <div class="template-info">
                            <div class="template-title">Policy Compliance Report</div>
                            <div class="template-desc">Detailed policy adherence metrics</div>
                            <div class="template-date">Last generated: 2024-01-13</div>
                        </div>
                        <div class="template-actions">
                            <button class="btn-small btn-pdf"><i class="fas fa-file-pdf"></i> PDF</button>
                            <button class="btn-small btn-csv"><i class="fas fa-file-csv"></i> CSV</button>
                        </div>
                    </div>

                    <div class="template-item">
                        <div class="template-info">
                            <div class="template-title">Threat Analysis</div>
                            <div class="template-desc">In-depth threat pattern analysis</div>
                            <div class="template-date">Last generated: 2024-01-12</div>
                        </div>
                        <div class="template-actions">
                            <button class="btn-small btn-pdf"><i class="fas fa-file-pdf"></i> PDF</button>
                            <button class="btn-small btn-csv"><i class="fas fa-file-csv"></i> CSV</button>
                        </div>
                    </div>

                    <div class="template-item">
                        <div class="template-info">
                            <div class="template-title">Agent Status Report</div>
                            <div class="template-desc">Endpoint health and coverage</div>
                            <div class="template-date">Last generated: 2024-01-11</div>
                        </div>
                        <div class="template-actions">
                            <button class="btn-small btn-pdf"><i class="fas fa-file-pdf"></i> PDF</button>
                            <button class="btn-small btn-csv"><i class="fas fa-file-csv"></i> CSV</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Check login status
        // Check login status
        async function checkAuth() {
                try {
                    const response = await fetch("/api/auth/check", {
                        credentials: "include"
                    });

                    if (!response.ok) {
                        throw new Error("Not authenticated");
                    }

                    const result = await response.json();

                    if (!result.success) {
                        window.location.href = "index.html";
                    }

                } catch (err) {
                    window.location.href = "index.html";
                }
            }

        // Load components function
        async function loadComponent(url, containerId) {
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const html = await response.text();
                document.getElementById(containerId).innerHTML = html;
                
                // Execute any scripts in the loaded HTML
                const scripts = document.getElementById(containerId).getElementsByTagName('script');
                for (let script of scripts) {
                    try {
                        if (script.src) {
                            const newScript = document.createElement('script');
                            newScript.src = script.src;
                            document.head.appendChild(newScript);
                        } else {
                            eval(script.textContent);
                        }
                    } catch (e) {
                        console.error('Error executing script:', e);
                    }
                }
            } catch (error) {
                console.error('Error loading component:', error);
                document.getElementById(containerId).innerHTML = `<div style="color: red; padding: 20px;">Error loading component: ${error.message}</div>`;
            }
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadComponent('sidebar.html', 'sidebarContainer');
            loadComponent('page-header.html', 'headerContainer');
            
            // Set active page in sidebar after it loads
            setTimeout(() => {
                const currentPage = 'reports.html';
                const navLinks = document.querySelectorAll('.nav-link[data-page], .sub-menu-item[data-page]');
                navLinks.forEach(link => {
                    const href = link.getAttribute('href');
                    if (href === currentPage) {
                        link.classList.add('active');
                        
                        // Open parent submenu if it's a submenu item
                        const parentSubMenu = link.closest('.sub-menu');
                        const parentNavLink = parentSubMenu ? parentSubMenu.previousElementSibling : null;
                        if (parentSubMenu && parentNavLink) {
                            parentSubMenu.classList.add('open');
                            parentNavLink.classList.add('expanded');
                        }
                    }
                });
            }, 300);
        });

        // Generate report function
        function generateReport() {
            alert('Opening report generator...');
            // In real implementation, this would open a modal or redirect to generate-report.html
        }

        // Handle sidebar toggle
        window.addEventListener('sidebarToggle', function(event) {
            const mainContent = document.getElementById('mainContent');
            const header = document.querySelector('.top-header');
            
            if (event.detail.collapsed) {
                mainContent.classList.add('expanded');
                if (header) header.style.left = '70px';
            } else {
                mainContent.classList.remove('expanded');
                if (header) header.style.left = '240px';
            }
        });

        // Handle window resize
        window.addEventListener('resize', function() {
            if (window.innerWidth <= 968) {
                const mainContent = document.getElementById('mainContent');
                const header = document.querySelector('.top-header');
                if (mainContent) mainContent.style.marginLeft = '0';
                if (header) header.style.left = '0';
            }
        });
    </script>
</body>
</html>