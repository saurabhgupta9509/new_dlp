<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Agent Details - DLP Shield</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        background: #f3f4f6;
        overflow-x: hidden;
      }

      .dashboard-container {
        display: flex;
        min-height: 100vh;
      }

      /* ================ SIDEBAR STYLES ================ */
      .sidebar {
        width: 240px;
        background: linear-gradient(180deg, #1e40af 0%, #1e3a8a 100%);
        color: white;
        position: fixed;
        height: 100vh;
        display: flex;
        flex-direction: column;
        transition: width 0.3s ease;
        z-index: 1000;
        left: 0;
        top: 0;
        overflow: hidden;
      }

      .sidebar::-webkit-scrollbar {
        width: 4px;
      }

      .sidebar::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.3);
        border-radius: 4px;
      }

      .sidebar-header {
        padding: 18px 16px;
        display: flex;
        align-items: center;
        gap: 10px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        flex-shrink: 0;
      }

      .sidebar-logo {
        width: 38px;
        height: 38px;
        background: white;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
      }

      .sidebar-logo i {
        font-size: 20px;
        color: #2563eb;
      }

      .sidebar-title {
        font-size: 1.2em;
        font-weight: 700;
        white-space: nowrap;
        transition:
          opacity 0.2s,
          width 0.3s;
        overflow: hidden;
      }

      .nav-menu {
        padding: 12px 0;
        overflow-y: auto;
        overflow-x: hidden;
        flex: 1;
      }

      .nav-item {
        margin: 2px 8px;
      }

      .nav-link {
        display: flex;
        align-items: center;
        padding: 10px 12px;
        color: rgba(255, 255, 255, 0.8);
        text-decoration: none;
        border-radius: 8px;
        transition: all 0.2s;
        font-size: 0.9em;
        cursor: pointer;
        white-space: nowrap;
      }

      .nav-link:hover {
        background: rgba(255, 255, 255, 0.1);
        color: white;
      }

      .nav-link.active,
      .sub-menu-item.active {
        background: rgba(255, 255, 255, 0.15);
        color: white;
        font-weight: 600;
      }

      .nav-link i:first-child {
        width: 20px;
        font-size: 0.95em;
        margin-right: 10px;
        flex-shrink: 0;
      }

      .chevron-icon {
        margin-left: auto !important;
        font-size: 0.7em !important;
        transition: transform 0.3s;
        width: auto !important;
        flex-shrink: 0;
      }

      .nav-link.expanded .chevron-icon {
        transform: rotate(180deg);
      }

      .sub-menu {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease;
      }

      .sub-menu.open {
        max-height: 500px;
      }

      .sub-menu-item {
        display: flex;
        align-items: center;
        padding: 8px 12px 8px 42px;
        color: rgba(255, 255, 255, 0.7);
        text-decoration: none;
        font-size: 0.85em;
        transition: all 0.2s;
        border-radius: 8px;
        margin: 2px 0;
        white-space: nowrap;
      }

      .sub-menu-item:hover {
        color: white;
        background: rgba(255, 255, 255, 0.08);
      }

      .sub-menu-item::before {
        content: "â€¢";
        margin-right: 10px;
        font-size: 1.2em;
      }

      .sidebar-footer {
        padding: 12px 16px;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        flex-shrink: 0;
      }

      .collapse-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 10px;
        background: rgba(255, 255, 255, 0.1);
        border: none;
        color: white;
        border-radius: 8px;
        cursor: pointer;
        width: 100%;
        font-size: 0.85em;
        transition: all 0.2s;
        white-space: nowrap;
        overflow: hidden;
      }

      .collapse-btn:hover {
        background: rgba(255, 255, 255, 0.15);
      }

      .collapse-btn i {
        transition: transform 0.3s;
        flex-shrink: 0;
      }

      /* Sidebar collapsed state */
      .sidebar.collapsed {
        width: 70px;
      }

      .sidebar.collapsed .sidebar-title {
        opacity: 0;
        width: 0;
      }

      .sidebar.collapsed .nav-link span,
      .sidebar.collapsed .collapse-btn span {
        display: none;
      }

      .sidebar.collapsed .sub-menu {
        display: none !important;
      }

      .sidebar.collapsed .nav-link {
        justify-content: center;
        padding: 10px;
      }

      .sidebar.collapsed .nav-link i:first-child {
        margin-right: 0;
      }

      .sidebar.collapsed .chevron-icon {
        display: none;
      }

      .sidebar.collapsed .collapse-btn {
        justify-content: center;
      }

      .sidebar.collapsed .collapse-btn i {
        transform: rotate(180deg);
      }

      /* Mobile Overlay */
      .sidebar-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 999;
        opacity: 0;
        transition: opacity 0.3s;
      }

      .sidebar-overlay.active {
        display: block;
        opacity: 1;
      }

      /* ================ HEADER STYLES ================ */
      .top-header {
        background: white;
        padding: 14px 24px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        border-bottom: 1px solid #e5e7eb;
        position: fixed;
        top: 0;
        left: 240px;
        right: 0;
        z-index: 500;
        gap: 16px;
        transition: left 0.3s ease;
      }

      .mobile-menu-toggle {
        display: none;
        background: none;
        border: none;
        color: #6b7280;
        font-size: 1.3em;
        cursor: pointer;
        padding: 8px;
        transition: color 0.2s;
      }

      .mobile-menu-toggle:hover {
        color: #111827;
      }

      .search-bar {
        flex: 1;
        max-width: 400px;
        position: relative;
      }

      .search-bar i {
        position: absolute;
        left: 14px;
        top: 50%;
        transform: translateY(-50%);
        color: #9ca3af;
        font-size: 0.9em;
      }

      .search-input {
        width: 100%;
        padding: 9px 14px 9px 38px;
        border: 1.5px solid #e5e7eb;
        border-radius: 8px;
        font-size: 0.9em;
        background: #f9fafb;
        transition: all 0.3s ease;
      }

      .search-input:focus {
        outline: none;
        border-color: #3b82f6;
        background: white;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }

      .header-actions {
        display: flex;
        align-items: center;
        gap: 16px;
      }

      .notification-btn {
        position: relative;
        background: none;
        border: none;
        color: #6b7280;
        font-size: 1.1em;
        cursor: pointer;
        padding: 8px;
        transition: all 0.2s;
        border-radius: 8px;
      }

      .notification-btn:hover {
        color: #111827;
        background: #f3f4f6;
      }

      .notification-btn.active {
        color: #2563eb;
        background: #eff6ff;
      }

      .notification-badge {
        position: absolute;
        top: 4px;
        right: 4px;
        background: #ef4444;
        color: white;
        font-size: 0.65em;
        min-width: 18px;
        height: 18px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        padding: 0 4px;
      }

      .user-profile {
        display: flex;
        align-items: center;
        gap: 10px;
        cursor: pointer;
        padding: 6px 10px;
        border-radius: 8px;
        transition: background 0.2s;
        position: relative;
      }

      .user-profile:hover {
        background: #f3f4f6;
      }

      .user-avatar {
        width: 36px;
        height: 36px;
        background: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        font-size: 0.9em;
        flex-shrink: 0;
      }

      .user-info {
        display: flex;
        flex-direction: column;
      }

      .user-name {
        font-size: 0.9em;
        font-weight: 600;
        color: #111827;
      }

      .user-role {
        font-size: 0.75em;
        color: #6b7280;
      }

      .dropdown-icon {
        color: #6b7280;
        font-size: 0.75em;
        margin-left: 4px;
        transition: transform 0.3s;
      }

      .user-profile.active .dropdown-icon {
        transform: rotate(180deg);
      }

      .user-dropdown {
        position: absolute;
        top: 100%;
        right: 0;
        margin-top: 8px;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        box-shadow:
          0 4px 6px rgba(0, 0, 0, 0.07),
          0 10px 15px rgba(0, 0, 0, 0.1);
        min-width: 200px;
        opacity: 0;
        visibility: hidden;
        transform: translateY(-10px);
        transition: all 0.3s ease;
        z-index: 1000;
      }

      .user-dropdown.show {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
      }

      .dropdown-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 14px;
        color: #374151;
        text-decoration: none;
        font-size: 0.9em;
        transition: background 0.2s;
      }

      .dropdown-item:first-child {
        border-radius: 8px 8px 0 0;
      }

      .dropdown-item:last-child {
        border-radius: 0 0 8px 8px;
      }

      .dropdown-item:hover {
        background: #f3f4f6;
      }

      .dropdown-item i {
        width: 18px;
        color: #6b7280;
        font-size: 0.95em;
      }

      .dropdown-item.danger {
        color: #dc2626;
      }

      .dropdown-item.danger i {
        color: #dc2626;
      }

      .dropdown-divider {
        height: 1px;
        background: #e5e7eb;
        margin: 4px 0;
      }

      /* ================ NOTIFICATIONS PANEL ================ */
      .notifications-panel {
        position: fixed;
        top: 0;
        right: -50%;
        width: 50%;
        max-width: 600px;
        height: 100vh;
        background: white;
        box-shadow: -4px 0 15px rgba(0, 0, 0, 0.1);
        z-index: 1001;
        display: flex;
        flex-direction: column;
        transition: right 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .notifications-panel.show {
        right: 0;
      }

      .notifications-header {
        padding: 20px 24px;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
      }

      .notifications-header h3 {
        font-size: 1.2em;
        font-weight: 700;
        color: #111827;
      }

      .close-notifications {
        background: none;
        border: none;
        color: #6b7280;
        font-size: 1.2em;
        cursor: pointer;
        padding: 6px;
        border-radius: 6px;
        transition: all 0.2s;
      }

      .close-notifications:hover {
        background: #f3f4f6;
        color: #111827;
      }

      .notifications-tabs {
        display: flex;
        border-bottom: 1px solid #e5e7eb;
        padding: 0 24px;
        flex-shrink: 0;
      }

      .tab-btn {
        flex: 1;
        padding: 12px;
        background: none;
        border: none;
        color: #6b7280;
        font-size: 0.9em;
        font-weight: 500;
        cursor: pointer;
        border-bottom: 2px solid transparent;
        transition: all 0.2s;
      }

      .tab-btn:hover {
        color: #111827;
      }

      .tab-btn.active {
        color: #2563eb;
        border-bottom-color: #2563eb;
      }

      .notifications-content {
        flex: 1;
        overflow-y: auto;
        padding: 12px 0;
      }

      .notifications-content::-webkit-scrollbar {
        width: 6px;
      }

      .notifications-content::-webkit-scrollbar-thumb {
        background: #d1d5db;
        border-radius: 3px;
      }

      .notification-item {
        display: flex;
        gap: 12px;
        padding: 14px 24px;
        cursor: pointer;
        transition: background 0.2s;
        border-left: 3px solid transparent;
      }

      .notification-item:hover {
        background: #f9fafb;
      }

      .notification-item.unread {
        background: #eff6ff;
        border-left-color: #3b82f6;
      }

      .notification-item.unread:hover {
        background: #dbeafe;
      }

      .notification-icon {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.1em;
        flex-shrink: 0;
      }

      .notification-icon.critical {
        background: #fee2e2;
        color: #dc2626;
      }

      .notification-icon.warning {
        background: #fef3c7;
        color: #f59e0b;
      }

      .notification-icon.info {
        background: #dbeafe;
        color: #3b82f6;
      }

      .notification-icon.success {
        background: #d1fae5;
        color: #10b981;
      }

      .notification-body {
        flex: 1;
      }

      .notification-title {
        font-size: 0.9em;
        font-weight: 600;
        color: #111827;
        margin-bottom: 4px;
      }

      .notification-text {
        font-size: 0.85em;
        color: #6b7280;
        margin-bottom: 6px;
        line-height: 1.4;
      }

      .notification-time {
        font-size: 0.75em;
        color: #9ca3af;
      }

      .notification-dot {
        width: 8px;
        height: 8px;
        background: #3b82f6;
        border-radius: 50%;
        flex-shrink: 0;
        margin-top: 8px;
      }

      .notification-item:not(.unread) .notification-dot {
        display: none;
      }

      .notifications-footer {
        padding: 16px 24px;
        border-top: 1px solid #e5e7eb;
        flex-shrink: 0;
      }

      .view-all-btn {
        display: block;
        width: 100%;
        padding: 10px;
        background: #f3f4f6;
        color: #2563eb;
        text-align: center;
        text-decoration: none;
        border-radius: 8px;
        font-size: 0.9em;
        font-weight: 600;
        transition: all 0.2s;
      }

      .view-all-btn:hover {
        background: #e5e7eb;
      }

      .notification-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.4);
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
      }

      .notification-overlay.show {
        opacity: 1;
        visibility: visible;
      }

      /* Main Content Area */
      .main-content {
        flex: 1;
        margin-left: 240px;
        transition: margin-left 0.3s ease;
        min-height: 100vh;
        padding-top: 70px;
      }

      .main-content.expanded {
        margin-left: 70px;
      }

      .content-area {
        padding: 24px;
      }

      /* Back Button */
      .back-button-container {
        margin-bottom: 20px;
      }

      .back-button {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 10px 16px;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        color: #374151;
        font-size: 0.9em;
        font-weight: 500;
        text-decoration: none;
        transition: all 0.2s;
      }

      .back-button:hover {
        background: #f9fafb;
        border-color: #d1d5db;
        color: #111827;
      }

      .back-button i {
        font-size: 0.9em;
      }

      /* Agent Profile Card */
      .agent-profile-card {
        background: white;
        border-radius: 12px;
        border: 1px solid #e5e7eb;
        padding: 24px;
        margin-bottom: 24px;
      }

      .profile-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        flex-wrap: wrap;
        gap: 20px;
        margin-bottom: 24px;
      }

      .profile-info {
        display: flex;
        align-items: center;
        gap: 16px;
      }

      .profile-avatar {
        width: 64px;
        height: 64px;
        border-radius: 12px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        font-weight: 700;
      }

      .profile-details h1 {
        font-size: 1.5em;
        color: #111827;
        margin-bottom: 6px;
      }

      .profile-meta {
        display: flex;
        gap: 16px;
        flex-wrap: wrap;
        font-size: 0.9em;
        color: #6b7280;
      }

      .profile-meta-item {
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .profile-actions {
        display: flex;
        gap: 10px;
      }

      .btn {
        padding: 10px 18px;
        border: none;
        border-radius: 8px;
        font-size: 0.9em;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }

      .btn-primary {
        background: #2563eb;
        color: white;
      }

      .btn-primary:hover {
        background: #1d4ed8;
      }

      .btn-secondary {
        background: #f3f4f6;
        color: #374151;
      }

      .btn-secondary:hover {
        background: #e5e7eb;
      }

      .btn-danger {
        background: #dc2626;
        color: white;
      }

      .btn-danger:hover {
        background: #b91c1c;
      }

      /* Stats Grid */
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 16px;
      }

      .stat-box {
        background: #f9fafb;
        padding: 14px;
        border-radius: 8px;
        border: 1px solid #e5e7eb;
      }

      .stat-label {
        font-size: 0.75em;
        color: #6b7280;
        margin-bottom: 6px;
        text-transform: uppercase;
      }

      .stat-value {
        font-size: 1.4em;
        font-weight: 700;
        color: #111827;
      }

      /* Tabs */
      .tabs-container {
        background: white;
        border-radius: 12px;
        border: 1px solid #e5e7eb;
        overflow: hidden;
      }

      .tabs-nav {
        display: flex;
        border-bottom: 1px solid #e5e7eb;
        overflow-x: auto;
        background: #f9fafb;
      }

      .tab-btn {
        padding: 14px 20px;
        background: none;
        border: none;
        font-size: 0.9em;
        font-weight: 500;
        color: #6b7280;
        cursor: pointer;
        transition: all 0.2s;
        border-bottom: 2px solid transparent;
        white-space: nowrap;
      }

      .tab-btn:hover {
        color: #111827;
        background: #f3f4f6;
      }

      .tab-btn.active {
        color: #2563eb;
        border-bottom-color: #2563eb;
        background: white;
      }

      .tab-content {
        display: none;
        padding: 24px;
      }

      .tab-content.active {
        display: block;
      }

      /* Overview Tab */
      .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
      }

      .info-card {
        background: #f9fafb;
        padding: 18px;
        border-radius: 10px;
        border: 1px solid #e5e7eb;
      }

      .info-card h3 {
        font-size: 0.95em;
        color: #111827;
        font-weight: 600;
        margin-bottom: 14px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .info-card h3 i {
        color: #2563eb;
      }

      .info-row {
        display: flex;
        justify-content: space-between;
        padding: 10px 0;
        border-bottom: 1px solid #e5e7eb;
      }

      .info-row:last-child {
        border-bottom: none;
      }

      .info-label {
        font-size: 0.85em;
        color: #6b7280;
      }

      .info-value {
        font-size: 0.85em;
        color: #111827;
        font-weight: 500;
      }

      /* URL History Tab */
      .url-filters {
        display: flex;
        gap: 12px;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }

      .filter-input {
        flex: 1;
        min-width: 200px;
        padding: 10px 14px;
        border: 1.5px solid #e5e7eb;
        border-radius: 8px;
        font-size: 0.9em;
      }

      .filter-input:focus {
        outline: none;
        border-color: #2563eb;
      }

      .url-table {
        width: 100%;
        border-collapse: collapse;
      }

      .url-table thead {
        background: #f9fafb;
      }

      .url-table th {
        padding: 12px;
        text-align: left;
        font-size: 0.8em;
        font-weight: 600;
        color: #6b7280;
        text-transform: uppercase;
        border-bottom: 1px solid #e5e7eb;
      }

      .url-table td {
        padding: 12px;
        font-size: 0.9em;
        border-bottom: 1px solid #f3f4f6;
      }

      .url-table tr:hover {
        background: #f9fafb;
      }

      .url-link {
        color: #2563eb;
        text-decoration: none;
      }

      .url-link:hover {
        text-decoration: underline;
      }

      .category-tag {
        padding: 4px 10px;
        border-radius: 6px;
        font-size: 0.8em;
        font-weight: 500;
      }

      .category-tag.work {
        background: #dbeafe;
        color: #1e40af;
      }

      .category-tag.social {
        background: #fef3c7;
        color: #92400e;
      }

      .category-tag.blocked {
        background: #fee2e2;
        color: #991b1b;
      }

      .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 10px;
        border-radius: 6px;
        font-size: 0.85em;
        font-weight: 500;
      }

      .status-badge.online {
        background: #d1fae5;
        color: #065f46;
      }

      .status-badge.online::before {
        content: "";
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: #10b981;
      }

      .status-badge.offline {
        background: #f3f4f6;
        color: #6b7280;
      }

      /* App Usage Tab */
      .charts-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 24px;
        margin-bottom: 24px;
      }

      .chart-box {
        background: white;
        padding: 20px 24px;
        border-radius: 12px;
        border: 1px solid #e5e7eb;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.03);
      }

      .chart-box h3 {
        margin-bottom: 24px;
        font-size: 0.95em;
        color: #111827;
        font-weight: 600;
      }

      /* Pie Chart with Side Legend Layout */
      .pie-chart-layout {
        display: flex;
        align-items: center;
        gap: 32px;
        justify-content: center;
      }

      .circular-chart-container {
        position: relative;
        width: 180px;
        height: 180px;
        flex-shrink: 0;
      }

      .circular-chart-center {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        z-index: 10;
      }

      .circular-chart-value {
        font-size: 2.2em;
        font-weight: 700;
        color: #111827;
        line-height: 1;
      }

      .circular-chart-label {
        font-size: 0.7em;
        color: #9ca3af;
        margin-top: 2px;
      }

      .chart-legend {
        display: flex;
        flex-direction: column;
        gap: 10px;
        flex: 1;
        max-width: 180px;
      }

      .legend-item {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .legend-color {
        width: 32px;
        height: 32px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
      }

      .legend-color i {
        font-size: 0.85em;
        color: white;
      }

      .legend-details {
        flex: 1;
      }

      .legend-label {
        color: #6b7280;
        font-size: 0.8em;
        display: block;
        margin-bottom: 2px;
        font-weight: 400;
      }

      .legend-value {
        font-weight: 600;
        color: #111827;
        font-size: 0.95em;
      }

      .app-list {
        display: grid;
        gap: 12px;
      }

      .app-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 14px;
        background: #f9fafb;
        border-radius: 8px;
        border: 1px solid #e5e7eb;
      }

      .app-info {
        display: flex;
        gap: 12px;
        align-items: center;
      }

      .app-icon {
        width: 40px;
        height: 40px;
        background: white;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 1px solid #e5e7eb;
      }

      .app-details h4 {
        font-size: 0.95em;
        color: #111827;
        margin-bottom: 2px;
      }

      .app-details p {
        font-size: 0.8em;
        color: #6b7280;
      }

      .app-time {
        font-size: 1.1em;
        font-weight: 700;
        color: #2563eb;
      }

      /* Certificate Tab */
      .certificate-container {
        max-width: 1100px;
        margin: 0 auto;
      }

      .certificate-layout {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 24px;
      }

      .certificate-card {
        background: white;
        padding: 32px;
        border-radius: 16px;
        border: 1px solid #e5e7eb;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }

      .cert-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 30px;
      }

      .cert-icon {
        width: 48px;
        height: 48px;
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        color: white;
      }

      .cert-title {
        font-size: 1.3em;
        margin: 0;
        font-weight: 600;
        color: #111827;
      }

      .cert-score-circle {
        width: 180px;
        height: 180px;
        border-radius: 50%;
        background: white;
        margin: 20px auto 24px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        position: relative;
      }

      .cert-score-circle::before {
        content: "";
        position: absolute;
        inset: -6px;
        border-radius: 50%;
        padding: 6px;
        background: conic-gradient(
          from 0deg,
          #fbbf24 0%,
          #06b6d4 25%,
          #3b82f6 50%,
          #8b5cf6 75%,
          #ec4899 90%,
          #fbbf24 100%
        );
        -webkit-mask:
          linear-gradient(#fff 0 0) content-box,
          linear-gradient(#fff 0 0);
        -webkit-mask-composite: xor;
        mask-composite: exclude;
      }

      .cert-score {
        font-size: 3.5em;
        font-weight: 700;
        color: #111827;
        line-height: 1;
      }

      .cert-max {
        font-size: 1.2em;
        color: #6b7280;
        margin-top: 2px;
      }

      .cert-grade {
        text-align: center;
        font-size: 1em;
        font-weight: 600;
        padding: 10px 24px;
        background: #eff6ff;
        color: #1e40af;
        border-radius: 24px;
        display: inline-block;
        margin: 0 auto 28px;
        border: 1px solid #dbeafe;
      }

      .cert-metrics {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 14px;
      }

      .cert-metric {
        background: #f9fafb;
        padding: 18px;
        border-radius: 12px;
        border: 1px solid #e5e7eb;
      }

      .cert-metric-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 12px;
      }

      .cert-metric-icon {
        width: 36px;
        height: 36px;
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1em;
      }

      .cert-metric-label {
        font-size: 0.8em;
        color: #6b7280;
        text-transform: capitalize;
        font-weight: 500;
      }

      .cert-metric-value {
        font-size: 2em;
        font-weight: 700;
        color: #111827;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .cert-metric-trend {
        font-size: 0.5em;
        color: #10b981;
      }

      .cert-metric.compliance .cert-metric-value {
        color: #10b981;
      }

      .ai-analysis {
        background: white;
        padding: 32px;
        border-radius: 16px;
        border: 1px solid #e5e7eb;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      }

      .ai-analysis-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 24px;
      }

      .ai-icon {
        width: 40px;
        height: 40px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.2em;
      }

      .ai-analysis h3 {
        color: #111827;
        margin: 0;
        font-size: 1.2em;
        font-weight: 600;
      }

      .analysis-section {
        margin-bottom: 24px;
      }

      .analysis-section:last-child {
        margin-bottom: 0;
      }

      .section-header {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 12px;
      }

      .section-icon {
        width: 28px;
        height: 28px;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.9em;
      }

      .section-icon.positive {
        background: #d1fae5;
        color: #065f46;
      }

      .section-icon.warning {
        background: #fef3c7;
        color: #92400e;
      }

      .section-icon.info {
        background: #dbeafe;
        color: #1e40af;
      }

      .ai-analysis h4 {
        color: #374151;
        margin: 0;
        font-size: 1em;
        font-weight: 600;
      }

      .ai-analysis ul {
        margin: 0;
        padding-left: 20px;
        color: #6b7280;
      }

      .ai-analysis li {
        margin-bottom: 8px;
        font-size: 0.9em;
        line-height: 1.5;
      }

      /* Policy Cards */
      .policy-list {
        display: grid;
        gap: 16px;
      }

      .policy-card {
        background: #f9fafb;
        padding: 18px;
        border-radius: 10px;
        border: 1px solid #e5e7eb;
      }

      .policy-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }

      .policy-title {
        font-size: 1em;
        color: #111827;
        font-weight: 600;
      }

      .policy-status {
        padding: 4px 10px;
        border-radius: 6px;
        font-size: 0.8em;
        font-weight: 500;
      }

      .policy-status.active {
        background: #d1fae5;
        color: #065f46;
      }

      .policy-desc {
        font-size: 0.85em;
        color: #6b7280;
        margin-bottom: 12px;
      }

      .policy-rules {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }

      .rule-tag {
        padding: 4px 10px;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        font-size: 0.8em;
        color: #374151;
      }

      /* Activity Timeline */
      .activity-timeline {
        position: relative;
        padding-left: 30px;
      }

      .activity-timeline::before {
        content: "";
        position: absolute;
        left: 8px;
        top: 0;
        bottom: 0;
        width: 2px;
        background: #e5e7eb;
      }

      .activity-item {
        position: relative;
        margin-bottom: 20px;
      }

      .activity-item::before {
        content: "";
        position: absolute;
        left: -25px;
        top: 6px;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: #3b82f6;
        border: 2px solid white;
      }

      .activity-time {
        font-size: 0.8em;
        color: #9ca3af;
        margin-bottom: 4px;
      }

      .activity-content {
        background: #f9fafb;
        padding: 12px;
        border-radius: 8px;
        border: 1px solid #e5e7eb;
      }

      .activity-content h4 {
        font-size: 0.9em;
        color: #111827;
        margin-bottom: 4px;
      }

      .activity-content p {
        font-size: 0.85em;
        color: #6b7280;
      }

      .policy-delete-btn {
        background: #fee2e2;
        border: none;
        color: #b91c1c;
        width: 32px;
        height: 32px;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
      }

      .policy-delete-btn:hover {
        background: #dc2626;
        color: white;
      }

      /* BLOCKED URLs / PARTIAL ACCESS */
      .burl-stats-row {
        display: flex;
        gap: 20px;
        margin-bottom: 24px;
        flex-wrap: wrap;
      }

      .burl-stat-card {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 20px 24px;
        display: flex;
        align-items: center;
        gap: 16px;
        flex: 1;
        min-width: 180px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
      }

      .burl-stat-icon {
        width: 52px;
        height: 52px;
        background: #eff6ff;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #2563eb;
        font-size: 1.4em;
        flex-shrink: 0;
      }

      .burl-stat-icon.pa-icon {
        background: #ecfdf5;
        color: #059669;
      }

      .burl-stat-label {
        font-size: 0.78em;
        color: #6b7280;
        margin-bottom: 4px;
        text-transform: uppercase;
        letter-spacing: 0.4px;
      }

      .burl-stat-value {
        font-size: 1.8em;
        font-weight: 700;
        color: #111827;
        line-height: 1;
      }

      .burl-stat-sub {
        font-size: 0.78em;
        color: #9ca3af;
        margin-top: 4px;
      }

      .burl-toolbar {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 18px;
        flex-wrap: wrap;
      }

      .burl-search-wrap {
        position: relative;
        flex: 1;
        min-width: 180px;
      }

      .burl-search {
        width: 100%;
        padding: 9px 14px 9px 36px;
        border: 1.5px solid #e5e7eb;
        border-radius: 8px;
        font-size: 0.88em;
        background: #f9fafb;
        transition: all 0.2s;
      }

      .burl-search:focus {
        outline: none;
        border-color: #2563eb;
        background: white;
      }

      .burl-search-icon {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: #9ca3af;
        font-size: 0.85em;
        pointer-events: none;
      }

      .burl-select {
        padding: 9px 12px;
        border: 1.5px solid #e5e7eb;
        border-radius: 8px;
        font-size: 0.88em;
        color: #374151;
        background: white;
        cursor: pointer;
        min-width: 130px;
      }

      .burl-select:focus {
        outline: none;
        border-color: #2563eb;
      }

      .burl-btn-refresh {
        width: 38px;
        height: 38px;
        border: 1.5px solid #e5e7eb;
        border-radius: 8px;
        background: white;
        color: #6b7280;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        flex-shrink: 0;
      }

      .burl-btn-refresh:hover {
        background: #f3f4f6;
        color: #111827;
      }

      .burl-table-wrap {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        overflow: hidden;
        margin-bottom: 24px;
      }

      .burl-table {
        width: 100%;
        border-collapse: collapse;
      }

      .burl-table thead {
        background: #f9fafb;
      }

      .burl-table th {
        padding: 11px 14px;
        text-align: left;
        font-size: 0.78em;
        font-weight: 600;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.4px;
        border-bottom: 1px solid #e5e7eb;
        white-space: nowrap;
      }

      .burl-table td {
        padding: 13px 14px;
        font-size: 0.88em;
        border-bottom: 1px solid #f3f4f6;
        vertical-align: middle;
      }

      .burl-table tbody tr:last-child td {
        border-bottom: none;
      }

      .burl-table tbody tr:hover {
        background: #f9fafb;
      }

      .burl-url-name {
        font-weight: 600;
        color: #111827;
        font-size: 0.92em;
      }

      .burl-url-reason {
        font-size: 0.78em;
        color: #9ca3af;
        margin-top: 2px;
      }

      .burl-domain {
        color: #6b7280;
        font-size: 0.85em;
      }

      .burl-date {
        color: #9ca3af;
        font-size: 0.82em;
        white-space: nowrap;
      }

      .burl-tag {
        display: inline-block;
        padding: 3px 10px;
        border-radius: 5px;
        font-size: 0.78em;
        font-weight: 500;
      }

      .burl-tag.entertainment {
        background: #dbeafe;
        color: #1e40af;
      }

      .burl-tag.social {
        background: #fef3c7;
        color: #92400e;
      }

      .burl-tag.work {
        background: #d1fae5;
        color: #065f46;
      }

      .burl-tag.monitor {
        background: #e0f2fe;
        color: #0369a1;
      }

      .burl-scope {
        display: inline-block;
        padding: 3px 10px;
        border-radius: 5px;
        font-size: 0.78em;
        font-weight: 500;
      }

      .burl-scope.global {
        background: #d1fae5;
        color: #065f46;
      }

      .burl-scope.device {
        background: #fef3c7;
        color: #92400e;
      }

      .burl-status {
        display: inline-block;
        padding: 3px 10px;
        border-radius: 5px;
        font-size: 0.78em;
        font-weight: 500;
      }

      .burl-status.active {
        background: #d1fae5;
        color: #065f46;
      }

      .burl-actions {
        display: flex;
        gap: 6px;
      }

      .burl-action-btn {
        width: 30px;
        height: 30px;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        background: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.75em;
        transition: all 0.2s;
      }

      .burl-action-btn.edit {
        color: #2563eb;
      }

      .burl-action-btn.edit:hover {
        background: #dbeafe;
        border-color: #93c5fd;
      }

      .burl-action-btn.delete {
        color: #6b7280;
      }

      .burl-action-btn.delete:hover {
        background: #f3f4f6;
      }

      .mburl-section {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 20px 24px;
      }

      .mburl-title {
        font-size: 0.95em;
        font-weight: 600;
        color: #111827;
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .mburl-title i {
        color: #ef4444;
      }

      .mburl-item {
        display: flex;
        align-items: center;
        gap: 14px;
        padding: 12px 0;
        border-bottom: 1px solid #f3f4f6;
      }

      .mburl-item:last-child {
        border-bottom: none;
      }

      .mburl-rank {
        width: 32px;
        height: 32px;
        background: #f3f4f6;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.78em;
        font-weight: 700;
        color: #6b7280;
        flex-shrink: 0;
      }

      .mburl-info {
        flex: 1;
      }

      .mburl-name {
        font-size: 0.9em;
        font-weight: 600;
        color: #111827;
      }

      .mburl-domain {
        font-size: 0.78em;
        color: #9ca3af;
      }

      .mburl-count-wrap {
        text-align: right;
      }

      .mburl-count {
        font-size: 1.3em;
        font-weight: 700;
        color: #ef4444;
        line-height: 1;
      }

      .mburl-count-label {
        font-size: 0.72em;
        color: #9ca3af;
      }

      /* MODALS */
      .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 2000;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        visibility: hidden;
        transition: all 0.25s;
      }

      .modal-overlay.show {
        opacity: 1;
        visibility: visible;
      }

      .modal-box {
        background: white;
        border-radius: 12px;
        width: 90%;
        max-width: 520px;
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2);
        transform: translateY(-20px);
        transition: transform 0.25s;
      }

      .modal-overlay.show .modal-box {
        transform: translateY(0);
      }

      .modal-header {
        padding: 18px 24px;
        background: #2563eb;
        border-radius: 12px 12px 0 0;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .modal-header h3 {
        color: white;
        font-size: 1.05em;
        font-weight: 600;
        margin: 0;
      }

      .modal-close {
        background: none;
        border: none;
        color: rgba(255, 255, 255, 0.8);
        font-size: 1.2em;
        cursor: pointer;
        padding: 4px;
        border-radius: 4px;
        transition: color 0.2s;
      }

      .modal-close:hover {
        color: white;
      }

      .modal-body {
        padding: 24px;
      }

      .modal-field {
        margin-bottom: 18px;
      }

      .modal-field label {
        display: block;
        font-size: 0.85em;
        font-weight: 600;
        color: #374151;
        margin-bottom: 6px;
      }

      .modal-field input,
      .modal-field textarea,
      .modal-field select {
        width: 100%;
        padding: 9px 12px;
        border: 1.5px solid #e5e7eb;
        border-radius: 8px;
        font-size: 0.9em;
        font-family: inherit;
        transition: border-color 0.2s;
        background: white;
      }

      .modal-field input:focus,
      .modal-field textarea:focus,
      .modal-field select:focus {
        outline: none;
        border-color: #2563eb;
      }

      .modal-field textarea {
        resize: vertical;
        min-height: 80px;
      }

      .modal-field .hint {
        font-size: 0.75em;
        color: #9ca3af;
        margin-top: 4px;
      }

      .modal-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 14px;
      }

      .modal-check {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.88em;
        color: #374151;
        cursor: pointer;
        margin-bottom: 10px;
      }

      .modal-check input[type="checkbox"] {
        width: 16px;
        height: 16px;
        accent-color: #2563eb;
        cursor: pointer;
      }

      .modal-footer {
        padding: 16px 24px;
        border-top: 1px solid #e5e7eb;
        display: flex;
        justify-content: flex-end;
        gap: 10px;
      }

      .modal-btn-cancel {
        padding: 9px 20px;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        background: white;
        color: #374151;
        font-size: 0.88em;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
      }

      .modal-btn-cancel:hover {
        background: #f3f4f6;
      }

      .modal-btn-save {
        padding: 9px 20px;
        border: none;
        border-radius: 8px;
        background: #2563eb;
        color: white;
        font-size: 0.88em;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
      }

      .modal-btn-save:hover {
        background: #1d4ed8;
      }

      .modal-btn-save.green {
        background: #059669;
      }

      .modal-btn-save.green:hover {
        background: #047857;
      }

      @media (max-width: 968px) {
        .main-content {
          margin-left: 0;
          width: 100%;
        }

        .top-header {
          left: 0 !important;
        }

        .mobile-menu-toggle {
          display: block;
        }

        .sidebar {
          transform: translateX(-100%);
          width: 260px;
          transition: transform 0.3s ease;
        }

        .sidebar.mobile-open {
          transform: translateX(0);
        }

        .sidebar.collapsed {
          transform: translateX(-100%);
          width: 260px;
        }

        .user-info {
          display: none;
        }

        .dropdown-icon {
          display: none;
        }

        .notifications-panel {
          width: 80%;
          right: -80%;
          max-width: none;
        }

        .notifications-panel.show {
          right: 0;
        }

        .info-grid {
          grid-template-columns: 1fr;
        }

        .charts-row {
          grid-template-columns: 1fr;
        }

        .certificate-layout {
          grid-template-columns: 1fr;
        }

        .cert-metrics {
          grid-template-columns: 1fr;
        }
      }

      @media (max-width: 640px) {
        .content-area {
          padding: 16px;
        }

        .search-bar {
          display: none;
        }

        .stats-grid {
          grid-template-columns: 1fr;
        }

        .notifications-panel {
          width: 100%;
          right: -100%;
        }
      }

      .url-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
      }

      .url-table thead {
        background: #f9fafb;
      }

      .url-table th {
        padding: 12px;
        text-align: left;
        font-size: 0.8em;
        font-weight: 600;
        color: #6b7280;
        text-transform: uppercase;
        border-bottom: 1px solid #e5e7eb;
      }

      .url-table td {
        padding: 12px;
        font-size: 0.9em;
        border-bottom: 1px solid #f3f4f6;
      }

      .url-table tr:hover {
        background: #f9fafb;
      }

      .url-link {
        color: #2563eb;
        text-decoration: none;
      }

      .url-link:hover {
        text-decoration: underline;
      }
      /* ================ URL HISTORY IMPROVED STYLES ================ */
.url-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
    flex-wrap: wrap;
    gap: 15px;
}

.url-header-left {
    display: flex;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
}

.url-header-left h3 {
    font-size: 1.2rem;
    font-weight: 600;
    color: #1e293b;
    margin: 0;
    display: flex;
    align-items: center;
}

.url-badge {
    background: #e2e8f0;
    color: #475569;
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 500;
}

.url-header-right {
    display: flex;
    gap: 10px;
    align-items: center;
}

.url-search-wrapper {
    position: relative;
    width: 280px;
}

.search-icon {
    position: absolute;
    left: 12px;
    top: 50%;
    transform: translateY(-50%);
    color: #94a3b8;
    font-size: 0.9rem;
}

.url-search-input {
    width: 100%;
    padding: 10px 10px 10px 38px;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    font-size: 0.9rem;
    background: white;
    transition: all 0.2s;
}

.url-search-input:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.url-refresh-btn {
    width: 38px;
    height: 38px;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    background: white;
    color: #64748b;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
}

.url-refresh-btn:hover {
    background: #f8fafc;
    color: #2563eb;
    border-color: #3b82f6;
}

.url-stats-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 16px;
    margin-bottom: 24px;
}

.url-stat-card {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    padding: 18px;
    display: flex;
    align-items: center;
    gap: 16px;
    transition: all 0.2s;
    box-shadow: 0 1px 3px rgba(0,0,0,0.02);
}

.url-stat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    border-color: #cbd5e1;
}

.url-stat-icon {
    width: 48px;
    height: 48px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
}

.url-stat-icon.blue {
    background: #dbeafe;
    color: #2563eb;
}

.url-stat-icon.purple {
    background: #f3e8ff;
    color: #9333ea;
}

.url-stat-icon.orange {
    background: #fff3cd;
    color: #f59e0b;
}

.url-stat-icon.red {
    background: #fee2e2;
    color: #dc2626;
}

.url-stat-content {
    flex: 1;
}

.url-stat-label {
    font-size: 0.8rem;
    color: #64748b;
    margin-bottom: 4px;
    font-weight: 500;
}

.url-stat-value {
    font-size: 1.8rem;
    font-weight: 700;
    color: #1e293b;
    line-height: 1.2;
}

.url-stat-trend {
    font-size: 0.7rem;
    color: #94a3b8;
    margin-top: 4px;
}

.url-filter-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    flex-wrap: wrap;
    gap: 15px;
    background: white;
    padding: 12px 16px;
    border-radius: 10px;
    border: 1px solid #e2e8f0;
}

.url-filter-tabs {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}

.url-filter-tab {
    padding: 6px 14px;
    border: none;
    border-radius: 20px;
    background: #f1f5f9;
    color: #475569;
    font-size: 0.85rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
}

.url-filter-tab:hover {
    background: #e2e8f0;
}

.url-filter-tab.active {
    background: #2563eb;
    color: white;
}

.url-filter-actions {
    display: flex;
    gap: 10px;
}

.url-filter-select {
    padding: 6px 12px;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    font-size: 0.85rem;
    color: #1e293b;
    background: white;
    cursor: pointer;
    min-width: 130px;
}

.url-filter-select:focus {
    outline: none;
    border-color: #3b82f6;
}

.url-table-container {
    background: white;
    border-radius: 12px;
    border: 1px solid #e2e8f0;
    overflow: hidden;
    margin-bottom: 20px;
}

.url-table {
    width: 100%;
    border-collapse: collapse;
}

.url-table thead {
    background: #f8fafc;
    border-bottom: 1px solid #e2e8f0;
}

.url-table th {
    padding: 14px 16px;
    text-align: left;
    font-size: 0.8rem;
    font-weight: 600;
    color: #475569;
    text-transform: uppercase;
    letter-spacing: 0.3px;
}

.url-table td {
    padding: 14px 16px;
    font-size: 0.9rem;
    border-bottom: 1px solid #f1f5f9;
    color: #334155;
}

.url-table tbody tr:hover {
    background: #f8fafc;
}

.url-table tbody tr:last-child td {
    border-bottom: none;
}

.url-favicon {
    width: 16px;
    height: 16px;
    margin-right: 8px;
    vertical-align: middle;
}

.url-link {
    color: #2563eb;
    text-decoration: none;
    font-weight: 500;
    word-break: break-all;
}

.url-link:hover {
    text-decoration: underline;
}

.url-domain-badge {
    background: #f1f5f9;
    color: #475569;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 0.75rem;
    margin-left: 6px;
}

.status-badge {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 500;
}

.status-badge.allowed {
    background: #d1fae5;
    color: #065f46;
}

.status-badge.blocked {
    background: #fee2e2;
    color: #991b1b;
}

.browser-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    background: #f1f5f9;
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 0.75rem;
    color: #475569;
}

.browser-badge i {
    font-size: 0.7rem;
}

.time-cell {
    font-size: 0.85rem;
    color: #64748b;
    white-space: nowrap;
}

.url-loading {
    text-align: center;
    padding: 40px;
    background: white;
    border-radius: 12px;
    border: 1px solid #e2e8f0;
}

.url-loading .spinner {
    width: 40px;
    height: 40px;
    border: 3px solid #f1f5f9;
    border-top-color: #3b82f6;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin: 0 auto 15px;
}

.url-no-data {
    text-align: center;
    padding: 60px;
    background: white;
    border-radius: 12px;
    border: 1px solid #e2e8f0;
}

.url-no-data i {
    font-size: 48px;
    color: #94a3b8;
    margin-bottom: 16px;
}

.url-no-data h4 {
    font-size: 1.2rem;
    color: #1e293b;
    margin-bottom: 8px;
}

.url-no-data p {
    color: #64748b;
    font-size: 0.9rem;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Responsive */
@media (max-width: 1200px) {
    .url-stats-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}

@media (max-width: 768px) {
    .url-header {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .url-search-wrapper {
        width: 100%;
    }
    
    .url-filter-bar {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .url-filter-actions {
        width: 100%;
    }
    
    .url-filter-select {
        flex: 1;
    }
    
    .url-table {
        display: block;
        overflow-x: auto;
    }
}
    </style>
  </head>

  <body>
    <div class="dashboard-container">
      <!-- ==================== SIDEBAR ==================== -->
      <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
          <div class="sidebar-logo">
            <i class="fas fa-shield-halved"></i>
          </div>
          <div class="sidebar-title">DLP Shield</div>
        </div>

        <nav class="nav-menu">
          <div class="nav-item">
            <a href="dashboard" class="nav-link" data-page="dashboard">
              <i class="fas fa-th-large"></i>
              <span>Dashboard</span>
            </a>
          </div>

          <div class="nav-item">
            <a href="alerts" class="nav-link" data-page="alerts">
              <i class="fas fa-triangle-exclamation"></i>
              <span>Alerts &amp; Incidents</span>
            </a>
          </div>

          <div class="nav-item">
            <div class="nav-link nav-dropdown" onclick="toggleSubMenu(this)">
              <i class="fas fa-shield-alt"></i>
              <span>Policies</span>
              <i class="fas fa-chevron-down chevron-icon"></i>
            </div>
            <div class="sub-menu">
              <a
                href="manage-agents"
                class="sub-menu-item"
                data-page="manage-agents"
                >Manage Agents</a
              >
              <!-- <a href="file-policies.html" class="sub-menu-item" data-page="file-policies">File Policies</a> -->
              <a
                href="assign-policy"
                class="sub-menu-item"
                data-page="assign-policy"
                >Assign Policy</a
              >
            </div>
          </div>

          <!-- <div class="nav-item">
                    <a href="agents.html" class="nav-link" data-page="agents">
                        <i class="fas fa-desktop"></i>
                        <span>Agents / Endpoints</span>
                    </a>
                </div> -->

          <div class="nav-item">
            <div class="nav-link nav-dropdown" onclick="toggleSubMenu(this)">
              <i class="fas fa-eye"></i>
              <span>OCR &amp; Image Analysis</span>
              <i class="fas fa-chevron-down chevron-icon"></i>
            </div>
            <div class="sub-menu">
              <a
                href="ocr-dashboard"
                class="sub-menu-item"
                data-page="ocr-dashboard"
                >OCR Dashboard</a
              >
              <!--                        <a href="ocr-policies" class="sub-menu-item" data-page="ocr-policies">OCR Policies</a>-->
            </div>
          </div>

          <div class="nav-item">
            <div class="nav-link nav-dropdown" onclick="toggleSubMenu(this)">
              <i class="fas fa-file-lines"></i>
              <span>Reports &amp; Logs</span>
              <i class="fas fa-chevron-down chevron-icon"></i>
            </div>
            <div class="sub-menu">
              <a href="reports" class="sub-menu-item" data-page="reports"
                >Reports</a
              >
              <a
                href="generate-report"
                class="sub-menu-item"
                data-page="generate-report"
                >Generate Report</a
              >
              <a href="audit-logs" class="sub-menu-item" data-page="audit-logs"
                >Audit Logs</a
              >
              <a
                href="device-logs"
                class="sub-menu-item"
                data-page="device-logs"
                >Device Logs</a
              >
            </div>
          </div>

          <div class="nav-item">
            <div class="nav-link nav-dropdown" onclick="toggleSubMenu(this)">
              <i class="fas fa-users"></i>
              <span>Users &amp; Roles</span>
              <i class="fas fa-chevron-down chevron-icon"></i>
            </div>
            <div class="sub-menu">
              <a href="users" class="sub-menu-item" data-page="users">Users</a>
              <a href="roles" class="sub-menu-item" data-page="roles"
                >Roles &amp; Permissions</a
              >
              <a
                href="permissions"
                class="sub-menu-item"
                data-page="permissions"
                >Permissions</a
              >
            </div>
          </div>

          <div class="nav-item">
            <div class="nav-link nav-dropdown" onclick="toggleSubMenu(this)">
              <i class="fas fa-gear"></i>
              <span>Settings</span>
              <i class="fas fa-chevron-down chevron-icon"></i>
            </div>
            <div class="sub-menu">
              <a href="general" class="sub-menu-item" data-page="general"
                >General</a
              >
              <a href="security" class="sub-menu-item" data-page="security"
                >Security</a
              >
              <a
                href="integrations"
                class="sub-menu-item"
                data-page="integrations"
                >Integrations</a
              >
              <a
                href="data-retention"
                class="sub-menu-item"
                data-page="data-retention"
                >Data Retention</a
              >
            </div>
          </div>
        </nav>

        <div class="sidebar-footer">
          <button class="collapse-btn" onclick="toggleSidebar()">
            <i class="fas fa-chevron-left"></i>
            <span>Collapse</span>
          </button>
        </div>
      </aside>

      <!-- Mobile Overlay (for sidebar) -->
      <div
        class="sidebar-overlay"
        id="sidebarOverlay"
        onclick="closeMobileSidebar()"
      ></div>

      <!-- ==================== HEADER ==================== -->
      <header class="top-header" id="topHeader">
        <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">
          <i class="fas fa-bars"></i>
        </button>

        <div class="search-bar">
          <i class="fas fa-search"></i>
          <input
            type="text"
            class="search-input"
            placeholder="Search alerts, agents, policies..."
          />
        </div>

        <div class="header-actions">
          <button class="notification-btn" onclick="toggleNotifications(event)">
            <i class="fas fa-bell"></i>
            <span class="notification-badge">5</span>
          </button>

          <div class="user-profile" onclick="toggleUserDropdown(event)">
            <div class="user-avatar">[[${userInitials}]]</div>
            <div class="user-info">
              <div class="user-name">[[${userName}]]</div>
              <!--                        <div class="user-role">[[${userRole}]]</div>-->
              <div id="userEmail">[[${userEmail}]]</div>
            </div>
            <i class="fas fa-chevron-down dropdown-icon"></i>

            <div class="user-dropdown" id="userDropdown">
              <a href="general" class="dropdown-item">
                <i class="fas fa-gear"></i>
                <span>Settings</span>
              </a>
              <a href="#" class="dropdown-item">
                <i class="fas fa-circle-question"></i>
                <span>Help &amp; Support</span>
              </a>
              <div class="dropdown-divider"></div>
              <a
                href="index"
                class="dropdown-item danger"
                onclick="logout(event)"
              >
                <i class="fas fa-right-from-bracket"></i>
                <span>Sign out</span>
              </a>
            </div>
          </div>
        </div>
      </header>

      <!-- ==================== NOTIFICATIONS PANEL ==================== -->
      <div class="notifications-panel" id="notificationsPanel">
        <div class="notifications-header">
          <h3>Notifications</h3>
          <button class="close-notifications" onclick="closeNotifications()">
            <i class="fas fa-times"></i>
          </button>
        </div>

        <div class="notifications-tabs">
          <button class="tab-btn active" onclick="switchTab(event, 'all')">
            All (5)
          </button>
          <button class="tab-btn" onclick="switchTab(event, 'unread')">
            Unread (3)
          </button>
        </div>

        <div class="notifications-content" id="notificationsContent">
          <div class="notification-item unread">
            <div class="notification-icon critical">
              <i class="fas fa-shield-exclamation"></i>
            </div>
            <div class="notification-body">
              <div class="notification-title">Critical Policy Violation</div>
              <div class="notification-text">
                User attempted to copy sensitive files to USB drive
              </div>
              <div class="notification-time">2 minutes ago</div>
            </div>
            <div class="notification-dot"></div>
          </div>

          <div class="notification-item unread">
            <div class="notification-icon warning">
              <i class="fas fa-triangle-exclamation"></i>
            </div>
            <div class="notification-body">
              <div class="notification-title">Agent Offline</div>
              <div class="notification-text">
                DESKTOP-DEF456 has been offline for 2 hours
              </div>
              <div class="notification-time">15 minutes ago</div>
            </div>
            <div class="notification-dot"></div>
          </div>

          <div class="notification-item unread">
            <div class="notification-icon info">
              <i class="fas fa-info-circle"></i>
            </div>
            <div class="notification-body">
              <div class="notification-title">Policy Updated</div>
              <div class="notification-text">
                File Protection Policy has been modified by Admin
              </div>
              <div class="notification-time">1 hour ago</div>
            </div>
            <div class="notification-dot"></div>
          </div>

          <div class="notification-item">
            <div class="notification-icon success">
              <i class="fas fa-check-circle"></i>
            </div>
            <div class="notification-body">
              <div class="notification-title">Agent Connected</div>
              <div class="notification-text">
                New agent LAPTOP-XYZ789 successfully registered
              </div>
              <div class="notification-time">3 hours ago</div>
            </div>
          </div>

          <div class="notification-item">
            <div class="notification-icon info">
              <i class="fas fa-file-alt"></i>
            </div>
            <div class="notification-body">
              <div class="notification-title">Report Generated</div>
              <div class="notification-text">
                Weekly security report is ready for review
              </div>
              <div class="notification-time">5 hours ago</div>
            </div>
          </div>
        </div>

        <div class="notifications-footer">
          <a href="alerts" class="view-all-btn">View All Notifications</a>
        </div>
      </div>

      <!-- Notification Overlay -->
      <div
        class="notification-overlay"
        id="notificationOverlay"
        onclick="closeNotifications()"
      ></div>

      <!-- Main Content -->
      <main class="main-content" id="mainContent">
        <div class="content-area">
          <!-- Back Button -->
          <div class="back-button-container">
            <a href="manage-agents" class="back-button">
              <i class="fas fa-arrow-left"></i>
              Back to Agents
            </a>
          </div>

          <!-- <div class="agent-profile-card" data-agent-id="[[${agentId}]]"> -->
          <div class="agent-profile-card" th:data-agent-id="${agentId}">
            <div class="profile-header">
              <div class="profile-info">
                <div class="profile-avatar">JD</div>
                <div class="profile-details">
                  <h1 id="agentHostname">DESKTOP-ABC123</h1>
                  <div class="profile-meta" id="agentMeta">
                    <span class="profile-meta-item"
                      ><i class="fas fa-user" id="agentEmail">
                        john.doe@company.com</i
                      ></span
                    >
                    <span class="profile-meta-item" id="agentIp"
                      ><i class="fas fa-network-wired"></i> 192.168.1.100</span
                    >
                    <span class="profile-meta-item" id="agentOs"
                      ><i class="fas fa-windows"></i> Windows 11 Pro</span
                    >
                  </div>
                </div>
              </div>
              <
              <div class="profile-actions">
                <button class="btn btn-secondary" onclick="editAgent()">
                  <i class="fas fa-edit"></i> Edit
                </button>
                <button class="btn btn-primary" onclick="generateCert()">
                  <i class="fas fa-certificate"></i> Generate Certificate
                </button>
                <button class="btn btn-danger" onclick="deleteAgent()">
                  <i class="fas fa-trash"></i> Delete
                </button>
              </div>
            </div>
            <div class="stats-grid">
              <div class="stat-box">
                <div class="stat-label">Score</div>
                <div class="stat-value" id="overviewScore">95/100</div>
              </div>
              <div class="stat-box">
                <div class="stat-label">URLs Visited</div>
                <div class="stat-value" id="overviewUrlsVisited">0</div>
              </div>
              <div class="stat-box">
                <div class="stat-label">Apps Used</div>
                <div class="stat-value" id="overviewAppsUsed">0</div>
              </div>
              <div class="stat-box">
                <div class="stat-label">Violations</div>
                <div class="stat-value" id="overviewViolations">0</div>
              </div>
              <div class="stat-box">
                <div class="stat-label">Uptime</div>
                <div class="stat-value" id="overviewUptime">98.5%</div>
              </div>
              <div class="stat-box">
                <div class="stat-label">Last Seen</div>
                <div class="stat-value" id="overviewLastSeen">2m ago</div>
              </div>
            </div>
          </div>

          <div class="tabs-container">
            <div class="tabs-nav">
              <button
                class="tab-btn active"
                onclick="openTab(event, 'overview')"
              >
                <i class="fas fa-chart-line"></i> Overview
              </button>
              <button class="tab-btn" onclick="openTab(event, 'policies')">
                <i class="fas fa-shield-alt"></i> Policies
              </button>
              <button class="tab-btn" onclick="openTab(event, 'urlHistory')">
                <i class="fas fa-globe"></i> URL History
              </button>
              <button class="tab-btn" onclick="openTab(event, 'appUsage')">
                <i class="fas fa-window-maximize"></i> App Usage
              </button>
              <button class="tab-btn" onclick="openTab(event, 'certificate')">
                <i class="fas fa-certificate"></i> Certificate
              </button>
              <button class="tab-btn" onclick="openTab(event, 'blockedUrls')">
                <i class="fas fa-ban"></i> Blocked URLs
              </button>
              <button class="tab-btn" onclick="openTab(event, 'partialAccess')">
                <i class="fas fa-eye"></i> Partial Access
              </button>
              <button class="tab-btn" onclick="openTab(event, 'activity')">
                <i class="fas fa-clock-rotate-left"></i> Activity Logs
              </button>
            </div>

            <div id="overview" class="tab-content active">
              <div class="info-grid">
                <div class="info-card">
                  <h3><i class="fas fa-desktop"></i> System Information</h3>
                  <div class="info-row">
                    <span class="info-label">OS</span
                    ><span class="info-value">Windows 11 Pro</span>
                  </div>
                  <div class="info-row">
                    <span class="info-label">Version</span
                    ><span class="info-value">22H2 Build 22621</span>
                  </div>
                  <div class="info-row">
                    <span class="info-label">Processor</span
                    ><span class="info-value">Intel i7-12700K</span>
                  </div>
                  <div class="info-row">
                    <span class="info-label">RAM</span
                    ><span class="info-value">32 GB</span>
                  </div>
                  <div class="info-row">
                    <span class="info-label">Storage</span
                    ><span class="info-value">512GB (235GB Free)</span>
                  </div>
                </div>
                <div class="info-card">
                  <h3><i class="fas fa-network-wired"></i> Network</h3>
                  <div class="info-row">
                    <span class="info-label">IP Address</span
                    ><span class="info-value">192.168.1.100</span>
                  </div>
                  <div class="info-row">
                    <span class="info-label">MAC</span
                    ><span class="info-value">00:1B:44:11:3A:B7</span>
                  </div>
                  <div class="info-row">
                    <span class="info-label">Subnet</span
                    ><span class="info-value">255.255.255.0</span>
                  </div>
                  <div class="info-row">
                    <span class="info-label">Gateway</span
                    ><span class="info-value">192.168.1.1</span>
                  </div>
                  <div class="info-row">
                    <span class="info-label">DNS</span
                    ><span class="info-value">8.8.8.8</span>
                  </div>
                </div>
                <div class="info-card">
                  <h3><i class="fas fa-user"></i> User Details</h3>
                  <div class="info-row">
                    <span class="info-label">Username</span
                    ><span class="info-value">jdoe</span>
                  </div>
                  <div class="info-row">
                    <span class="info-label">Email</span
                    ><span class="info-value">john.doe@company.com</span>
                  </div>
                  <div class="info-row">
                    <span class="info-label">Department</span
                    ><span class="info-value">IT</span>
                  </div>
                  <div class="info-row">
                    <span class="info-label">Role</span
                    ><span class="info-value">Sr. Developer</span>
                  </div>
                  <div class="info-row">
                    <span class="info-label">Phone</span
                    ><span class="info-value">+91 98765 43210</span>
                  </div>
                </div>
                <div class="info-card">
                  <h3><i class="fas fa-cog"></i> Agent Config</h3>
                  <div class="info-row">
                    <span class="info-label">Version</span
                    ><span class="info-value">v2.4.1</span>
                  </div>
                  <div class="info-row">
                    <span class="info-label">Installed</span
                    ><span class="info-value">Jan 15, 2025</span>
                  </div>
                  <div class="info-row">
                    <span class="info-label">Updated</span
                    ><span class="info-value">Feb 1, 2025</span>
                  </div>
                  <div class="info-row">
                    <span class="info-label">Mode</span
                    ><span class="info-value">Active</span>
                  </div>
                  <div class="info-row">
                    <span class="info-label">Auto Update</span
                    ><span class="info-value">Enabled</span>
                  </div>
                </div>
              </div>
            </div>

            <div id="urlHistory" class="tab-content">
              <!-- Header with title and search -->
              <div class="url-header">
                <div class="url-header-left">
                  <h3>
                    <i
                      class="fas fa-globe"
                      style="color: #2563eb; margin-right: 10px"
                    ></i
                    >URL History
                  </h3>
                  <span class="url-badge">Real-time browsing activity</span>
                </div>
                <div class="url-header-right">
                  <div class="url-search-wrapper">
                    <i class="fas fa-search search-icon"></i>
                    <input
                      type="text"
                      class="url-search-input"
                      placeholder="Search URLs, domains..."
                      id="searchUrls"
                      onkeyup="filterUrlTable()"
                    />
                  </div>
                  <button
                    class="url-refresh-btn"
                    onclick="loadWebHistory(getAgentIdFromUrl())"
                    title="Refresh"
                  >
                    <i class="fas fa-sync-alt"></i>
                  </button>
                </div>
              </div>

              <!-- Statistics Cards -->
              <div class="url-stats-grid">
                <div class="url-stat-card">
                  <div class="url-stat-icon blue">
                    <i class="fas fa-link"></i>
                  </div>
                  <div class="url-stat-content">
                    <div class="url-stat-label">Total Visits</div>
                    <div class="url-stat-value" id="totalUrlVisits">0</div>
                    <div class="url-stat-trend">Last 30 days</div>
                  </div>
                </div>
                <div class="url-stat-card">
                  <div class="url-stat-icon purple">
                    <i class="fas fa-clock"></i>
                  </div>
                  <div class="url-stat-content">
                    <div class="url-stat-label">Unique Domains</div>
                    <div class="url-stat-value" id="uniqueDomains">0</div>
                    <div class="url-stat-trend">Different sites</div>
                  </div>
                </div>
                <div class="url-stat-card">
                  <div class="url-stat-icon orange">
                    <i class="fas fa-exclamation-triangle"></i>
                  </div>
                  <div class="url-stat-content">
                    <div class="url-stat-label">Suspicious</div>
                    <div class="url-stat-value" id="totalSuspiciousUrls">0</div>
                    <div class="url-stat-trend">Flagged content</div>
                  </div>
                </div>
                <div class="url-stat-card">
                  <div class="url-stat-icon red">
                    <i class="fas fa-ban"></i>
                  </div>
                  <div class="url-stat-content">
                    <div class="url-stat-label">Blocked</div>
                    <div class="url-stat-value" id="totalBlockedUrls">0</div>
                    <div class="url-stat-trend">Policy violations</div>
                  </div>
                </div>
              </div>

              <!-- Filter Bar -->
              <div class="url-filter-bar">
                <div class="url-filter-tabs">
                  <button
                    class="url-filter-tab active"
                    onclick="filterUrlByType('all')"
                  >
                    All
                  </button>
                  <button
                    class="url-filter-tab"
                    onclick="filterUrlByType('today')"
                  >
                    Today
                  </button>
                  <button
                    class="url-filter-tab"
                    onclick="filterUrlByType('week')"
                  >
                    This Week
                  </button>
                  <button
                    class="url-filter-tab"
                    onclick="filterUrlByType('month')"
                  >
                    This Month
                  </button>
                </div>
                <div class="url-filter-actions">
                  <select
                    class="url-filter-select"
                    id="urlBrowserFilter"
                    onchange="filterUrlTable()"
                  >
                    <option value="">All Browsers</option>
                    <option value="chrome">Chrome</option>
                    <option value="firefox">Firefox</option>
                    <option value="edge">Edge</option>
                    <option value="unknown">Unknown</option>
                  </select>
                  <select
                    class="url-filter-select"
                    id="urlStatusFilter"
                    onchange="filterUrlTable()"
                  >
                    <option value="">All Status</option>
                    <option value="allowed">Allowed</option>
                    <option value="blocked">Blocked</option>
                  </select>
                </div>
              </div>

              <!-- URL History Table Container -->
              <div id="urlsContainer" class="url-table-container">
                <!-- Table will be populated dynamically -->
              </div>

              <!-- Loading Spinner -->
              <div class="url-loading" id="urlsLoading" style="display: none">
                <div class="spinner"></div>
                <p>Loading URL history...</p>
              </div>

              <!-- No Data Message (hidden by default) -->
              <div class="url-no-data" id="noUrlData" style="display: none">
                <i class="fas fa-globe"></i>
                <h4>No URL History Found</h4>
                <p>
                  This agent hasn't visited any websites yet or tracking is
                  disabled.
                </p>
              </div>
            </div>
            <div id="appUsage" class="tab-content">
              <div class="charts-row">
                <div class="chart-box">
                  <h3>Usage Distribution by Category</h3>
                  <div class="pie-chart-layout">
                    <div class="circular-chart-container">
                      <canvas id="appPieChart"></canvas>
                      <div class="circular-chart-center">
                        <div class="circular-chart-value" id="totalCategories">
                          0
                        </div>
                        <div class="circular-chart-label">Categories</div>
                      </div>
                    </div>
                    <div class="chart-legend" id="categoryLegend">
                      <!-- Categories will be populated dynamically -->
                      <div class="legend-item">
                        <div class="legend-color" style="background: #9ca3af">
                          <i class="fas fa-question"></i>
                        </div>
                        <div class="legend-details">
                          <span class="legend-label">No Data</span>
                          <span class="legend-value">0%</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="chart-box">
                  <h3>Usage Trend (Last 7 Days)</h3>
                  <div style="height: 300px; position: relative">
                    <canvas id="appLineChart"></canvas>
                  </div>
                </div>
              </div>
              <h3 style="margin-bottom: 16px; font-size: 1.1em; color: #111827">
                Top Applications
              </h3>
              <div class="app-list" id="topAppsList">
                <!-- Top apps will be populated dynamically -->
                <div class="text-center" style="padding: 40px; color: #6b7280">
                  <i
                    class="fas fa-chart-pie"
                    style="font-size: 48px; margin-bottom: 16px; opacity: 0.5"
                  ></i>
                  <p>Loading app usage data...</p>
                </div>
              </div>
            </div>

            <div id="certificate" class="tab-content">
              <div class="certificate-container">
                <div class="certificate-layout">
                  <div class="certificate-card">
                    <div class="cert-header">
                      <div class="cert-icon">
                        <i class="fas fa-award"></i>
                      </div>
                      <h2 class="cert-title">Agent Behavior Certificate</h2>
                    </div>

                    <div class="cert-score-circle">
                      <div class="cert-score">95</div>
                      <div class="cert-max">/100</div>
                    </div>

                    <div style="text-align: center">
                      <div class="cert-grade">
                        <i class="fas fa-star" style="margin-right: 6px"></i
                        >Grade: A+ Excellent
                      </div>
                    </div>

                    <div class="cert-metrics">
                      <div class="cert-metric">
                        <div class="cert-metric-header">
                          <div class="cert-metric-icon">
                            <i class="fas fa-chart-line"></i>
                          </div>
                          <div class="cert-metric-label">Productivity</div>
                        </div>
                        <div class="cert-metric-value">
                          92%
                          <span class="cert-metric-trend"
                            ><i class="fas fa-arrow-up"></i
                          ></span>
                        </div>
                      </div>
                      <div class="cert-metric compliance">
                        <div class="cert-metric-header">
                          <div class="cert-metric-icon">
                            <i class="fas fa-check-circle"></i>
                          </div>
                          <div class="cert-metric-label">Compliance</div>
                        </div>
                        <div class="cert-metric-value">
                          100%
                          <span class="cert-metric-trend"
                            ><i class="fas fa-arrow-up"></i
                          ></span>
                        </div>
                      </div>
                      <div class="cert-metric">
                        <div class="cert-metric-header">
                          <div class="cert-metric-icon">
                            <i class="fas fa-shield-alt"></i>
                          </div>
                          <div class="cert-metric-label">Security</div>
                        </div>
                        <div class="cert-metric-value">
                          98%
                          <span class="cert-metric-trend"
                            ><i class="fas fa-arrow-up"></i
                          ></span>
                        </div>
                      </div>
                      <div class="cert-metric">
                        <div class="cert-metric-header">
                          <div class="cert-metric-icon">
                            <i class="fas fa-clock"></i>
                          </div>
                          <div class="cert-metric-label">Uptime</div>
                        </div>
                        <div class="cert-metric-value">
                          98.5%
                          <span class="cert-metric-trend"
                            ><i class="fas fa-arrow-up"></i
                          ></span>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="ai-analysis">
                    <div class="ai-analysis-header">
                      <div class="ai-icon">
                        <i class="fas fa-robot"></i>
                      </div>
                      <h3>AI Behavior Analysis</h3>
                    </div>

                    <div class="analysis-section">
                      <div class="section-header">
                        <div class="section-icon positive">âœ…</div>
                        <h4>Positive Behaviors</h4>
                      </div>
                      <ul>
                        <li>
                          71% web activity is work-related (GitHub, Stack
                          Overflow)
                        </li>
                        <li>No policy violations in last 30 days</li>
                        <li>Regular security updates applied</li>
                        <li>Minimal social media during work hours</li>
                      </ul>
                    </div>

                    <div class="analysis-section">
                      <div class="section-header">
                        <div class="section-icon warning">âš ï¸</div>
                        <h4>Areas for Improvement</h4>
                      </div>
                      <ul>
                        <li>
                          Occasional shopping sites during work hours (low risk)
                        </li>
                        <li>Time management on communication tools</li>
                      </ul>
                    </div>

                    <div class="analysis-section">
                      <div class="section-header">
                        <div class="section-icon info">ðŸŽ¯</div>
                        <h4>Recommendations</h4>
                      </div>
                      <ul>
                        <li>Maintain current high-performance standards</li>
                        <li>Continue using approved collaboration tools</li>
                      </ul>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div id="policies" class="tab-content">
              <div class="policy-list">
                <div class="policy-card">
                  <div class="policy-header">
                    <h4 class="policy-title">Web Browsing Policy - IT</h4>
                    <div style="display: flex; align-items: center; gap: 10px">
                      <span class="policy-status active">Active</span>
                      <button
                        class="policy-delete-btn"
                        onclick="deletePolicy(this)"
                        title="Delete"
                      >
                        <i class="fas fa-trash"></i>
                      </button>
                    </div>
                  </div>
                  <p class="policy-desc">
                    Controls web browsing for IT employees. Blocks malicious
                    sites and monitors usage.
                  </p>
                  <div class="policy-rules">
                    <span class="rule-tag">Block Gambling</span
                    ><span class="rule-tag">Block Adult Content</span
                    ><span class="rule-tag">Monitor Social Media</span>
                  </div>
                </div>

                <div class="policy-card">
                  <div class="policy-header">
                    <h4 class="policy-title">File Transfer Policy</h4>
                    <div style="display: flex; align-items: center; gap: 10px">
                      <span class="policy-status active">Active</span>
                      <button
                        class="policy-delete-btn"
                        onclick="deletePolicy(this)"
                        title="Delete"
                      >
                        <i class="fas fa-trash"></i>
                      </button>
                    </div>
                  </div>
                  <p class="policy-desc">
                    Monitors file transfers via USB, email, cloud. Prevents data
                    exfiltration.
                  </p>
                  <div class="policy-rules">
                    <span class="rule-tag">USB Monitoring</span
                    ><span class="rule-tag">Email Scan</span
                    ><span class="rule-tag">Cloud Control</span>
                  </div>
                </div>

                <div class="policy-card">
                  <div class="policy-header">
                    <h4 class="policy-title">Application Control</h4>
                    <div style="display: flex; align-items: center; gap: 10px">
                      <span class="policy-status active">Active</span>
                      <button
                        class="policy-delete-btn"
                        onclick="deletePolicy(this)"
                        title="Delete"
                      >
                        <i class="fas fa-trash"></i>
                      </button>
                    </div>
                  </div>
                  <p class="policy-desc">
                    Manages approved applications. Prevents unauthorized
                    software.
                  </p>
                  <div class="policy-rules">
                    <span class="rule-tag">Whitelist Apps</span
                    ><span class="rule-tag">Block Unauthorized</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- ======== BLOCKED URLs TAB ======== -->
            <!-- ======== BLOCKED URLs TAB (READ-ONLY) ======== -->
<div id="blockedUrls" class="tab-content">
    <!-- Stats Cards -->
    <div class="burl-stats-row">
        <div class="burl-stat-card">
            <div class="burl-stat-icon"><i class="fas fa-globe"></i></div>
            <div>
                <div class="burl-stat-label">Total Blocked URLs</div>
                <div class="burl-stat-value" id="totalBlockedUrlsCount">0</div>
                <div class="burl-stat-sub">Active policies</div>
            </div>
        </div>
        <div class="burl-stat-card">
            <div class="burl-stat-icon"><i class="fas fa-tags"></i></div>
            <div>
                <div class="burl-stat-label">Categories</div>
                <div class="burl-stat-value" id="blockedUrlCategories">0</div>
                <div class="burl-stat-sub">Different types</div>
            </div>
        </div>
        <div class="burl-stat-card">
            <div class="burl-stat-icon"><i class="fas fa-calendar"></i></div>
            <div>
                <div class="burl-stat-label">Last Updated</div>
                <div class="burl-stat-value" id="blockedUrlLastUpdated">-</div>
                <div class="burl-stat-sub">From policy</div>
            </div>
        </div>
    </div>

    <!-- Toolbar (READ-ONLY - Search only) -->
    <div class="burl-toolbar">
        <div class="burl-search-wrap" style="max-width: 300px;">
            <input type="text" class="burl-search" id="burlSearch" 
                   placeholder="Search URLs..." onkeyup="filterBurlTable()">
            <i class="fas fa-search burl-search-icon"></i>
        </div>
        <select class="burl-select" id="burlCategoryFilter" onchange="filterBurlTable()">
            <option value="">All Categories</option>
            <option value="Social Media">Social Media</option>
            <option value="Gaming">Gaming</option>
            <option value="Shopping">Shopping</option>
            <option value="Entertainment">Entertainment</option>
            <option value="Malware/Phishing">Malware/Phishing</option>
            <option value="Productivity">Productivity</option>
            <option value="Custom">Custom</option>
        </select>
        <button class="burl-btn-refresh" onclick="loadBlockedUrls(getAgentIdFromUrl())" 
                title="Refresh">
            <i class="fas fa-rotate-right"></i>
        </button>
        <div style="margin-left: auto;">
            <span class="badge" style="background: #e2e8f0; color: #475569; padding: 6px 12px; border-radius: 20px;">
                <i class="fas fa-info-circle"></i> Read-only view (manage in Assign Policy)
            </span>
        </div>
    </div>

    <!-- Blocked URLs Table (READ-ONLY - No action buttons) -->
    <div class="burl-table-wrap">
        <table class="burl-table" id="burlTable">
            <thead>
                <tr>
                    <th>URL Pattern</th>
                    <th>Domain</th>
                    <th>Category</th>
                    <th>Scope</th>
                    <th>Status</th>
                    <th>Added By</th>
                    <!-- <th>Date Added</th>
                    <th>Hit Count</th> -->
                </tr>
            </thead>
            <tbody id="burlTbody">
                <!-- Populated by JavaScript -->
            </tbody>
        </table>
    </div>

    <!-- No Data Message -->
    <div id="noBlockedUrlsMessage" style="display: none; text-align: center; padding: 40px; background: white; border-radius: 12px;">
        <i class="fas fa-ban" style="font-size: 48px; color: #9ca3af; margin-bottom: 16px;"></i>
        <h4 style="color: #374151; margin-bottom: 8px;">No Blocked URLs</h4>
        <p style="color: #6b7280;">No URL blocking policies have been assigned to this agent.</p>
        <p style="color: #6b7280; font-size: 0.9em; margin-top: 8px;">
            <i class="fas fa-arrow-right"></i> Go to <strong>Assign Policy</strong> to create blocked URL rules.
        </p>
    </div>
</div>

            <!-- ======== PARTIAL ACCESS TAB ======== -->
            <div id="partialAccess" class="tab-content">
              <!-- Stats Cards -->
              <div class="burl-stats-row">
                <div class="burl-stat-card">
                  <div class="burl-stat-icon pa-icon">
                    <i class="fas fa-globe"></i>
                  </div>
                  <div class="burl-stat-info">
                    <div class="burl-stat-label">Total Sites</div>
                    <div class="burl-stat-value">0</div>
                    <div class="burl-stat-sub">0 Active</div>
                  </div>
                </div>
                <div class="burl-stat-card">
                  <div class="burl-stat-icon pa-icon">
                    <i class="fas fa-tags"></i>
                  </div>
                  <div class="burl-stat-info">
                    <div class="burl-stat-label">Categories</div>
                    <div class="burl-stat-value">0</div>
                    <div class="burl-stat-sub">Different types</div>
                  </div>
                </div>
              </div>

              <div class="burl-toolbar">
                <div class="burl-search-wrap">
                  <input
                    type="text"
                    class="burl-search"
                    id="paSearch"
                    placeholder="Search sites..."
                    oninput="filterPaTable()"
                  />
                  <i class="fas fa-search burl-search-icon"></i>
                </div>
                <select
                  class="burl-select"
                  id="paStatusFilter"
                  onchange="filterPaTable()"
                >
                  <option value="">All Status</option>
                  <option value="Active">Active</option>
                  <option value="Inactive">Inactive</option>
                </select>
                <select
                  class="burl-select"
                  id="paScopeFilter"
                  onchange="filterPaTable()"
                >
                  <option value="">All Scope</option>
                  <option value="Global">Global</option>
                  <option value="Device">Device</option>
                  <option value="User">User</option>
                </select>
                <button
                  class="burl-btn-refresh"
                  onclick="loadPartialAccessSites(getAgentIdFromUrl())"
                >
                  <i class="fas fa-rotate-right"></i>
                </button>
                <div style="margin-left: auto; display: flex; gap: 10px">
                  <button class="btn btn-primary" onclick="openAddPaModal()">
                    <i class="fas fa-plus-circle"></i> Add Site
                  </button>
                </div>
              </div>

              <div class="burl-table-wrap">
                <table class="burl-table" id="paTable">
                  <thead>
                    <tr>
                      <th>URL Pattern</th>
                      <th>Domain</th>
                      <th>Permissions</th>
                      <th>Category</th>
                      <th>Scope</th>
                      <th>Status</th>
                      <th>Updated</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="paTbody">
                    <!-- Will be populated by JavaScript -->
                  </tbody>
                </table>
              </div>
            </div>

            <div id="activity" class="tab-content">
              <div class="activity-timeline">
                <div class="activity-item">
                  <div class="activity-time">Today, 2:15 PM</div>
                  <div class="activity-content">
                    <h4>Application Launched</h4>
                    <p>Started Visual Studio Code v1.85.0</p>
                  </div>
                </div>
                <div class="activity-item">
                  <div class="activity-time">Today, 2:10 PM</div>
                  <div class="activity-content">
                    <h4>Web Access</h4>
                    <p>Visited github.com - Allowed (Work Related)</p>
                  </div>
                </div>
                <div class="activity-item">
                  <div class="activity-time">Today, 1:45 PM</div>
                  <div class="activity-content">
                    <h4>File Transfer</h4>
                    <p>Downloaded project_docs.zip (5.2 MB) - Allowed</p>
                  </div>
                </div>
                <div class="activity-item">
                  <div class="activity-time">Today, 12:30 PM</div>
                  <div class="activity-content">
                    <h4>System Event</h4>
                    <p>Agent heartbeat sent - Status: Online</p>
                  </div>
                </div>
                <div class="activity-item">
                  <div class="activity-time">Today, 11:20 AM</div>
                  <div class="activity-content">
                    <h4>Web Access</h4>
                    <p>Visited stackoverflow.com - Allowed</p>
                  </div>
                </div>
                <div class="activity-item">
                  <div class="activity-time">Today, 10:00 AM</div>
                  <div class="activity-content">
                    <h4>System Login</h4>
                    <p>User jdoe logged in successfully</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>

    <!-- ======== ADD BLOCKED URL MODAL ======== -->
    <div class="modal-overlay" id="addBurlModal">
      <div class="modal-box">
        <div class="modal-header">
          <h3>Add Blocked URL</h3>
          <button class="modal-close" onclick="closeModal('addBurlModal')">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="modal-body">
          <div class="modal-field">
            <label>URL Pattern <span style="color: #ef4444">*</span></label>
            <input
              type="text"
              id="burl_pattern"
              placeholder="www.netflix.com"
            />
            <div class="hint">
              Use wildcards (*) for patterns. Example: *.facebook.com blocks all
              Facebook subdomains
            </div>
          </div>
          <div class="modal-field">
            <label>Reason for Blocking</label>
            <textarea
              id="burl_reason"
              placeholder="Why is this URL being blocked?"
            ></textarea>
          </div>
          <div class="modal-row">
            <div class="modal-field">
              <label>Category</label>
              <select id="burl_category">
                <option value="">Select Category</option>
                <option>Social Media</option>
                <option>Gaming</option>
                <option>Shopping</option>
                <option>Entertainment</option>
                <option>Malware/Phishing</option>
                <option>Productivity</option>
                <option>Other</option>
              </select>
            </div>
            <div class="modal-field">
              <label>Scope</label>
              <select id="burl_scope">
                <option>Global (All Devices)</option>
                <option>Specific Device</option>
                <option>Specific User</option>
              </select>
            </div>
          </div>
          <label class="modal-check"
            ><input type="checkbox" id="burl_active" checked /> Active (Start
            blocking immediately)</label
          >
        </div>
        <div class="modal-footer">
          <button class="modal-btn-cancel" onclick="closeModal('addBurlModal')">
            Cancel
          </button>
          <button class="modal-btn-save" onclick="saveBurl()">Save URL</button>
        </div>
      </div>
    </div>

    <!-- ======== ADD PARTIAL ACCESS SITE MODAL ======== -->
    <div class="modal-overlay" id="addPaModal">
      <div class="modal-box">
        <div class="modal-header" style="background: #0891b2">
          <h3>Add Partial Access Site</h3>
          <button class="modal-close" onclick="closeModal('addPaModal')">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="modal-body">
          <div class="modal-field">
            <label>URL Pattern <span style="color: #ef4444">*</span></label>
            <input
              type="text"
              id="pa_pattern"
              placeholder="e.g., chat.deepseek.com"
            />
            <div class="hint">
              Use wildcards (*) for patterns. Example: *.work.com allows access
              to work-related sites
            </div>
          </div>
          <div class="modal-field">
            <label>Reason</label>
            <textarea
              id="pa_reason"
              placeholder="Why is this site partially accessible?"
            ></textarea>
          </div>
          <div class="modal-row">
            <div class="modal-field">
              <label>Category</label>
              <select id="pa_category">
                <option value="">Select Category</option>
                <option>Work</option>
                <option>Social Media</option>
                <option>Entertainment</option>
                <option>Productivity</option>
                <option>Other</option>
              </select>
            </div>
            <div class="modal-field">
              <label>Scope</label>
              <select id="pa_scope">
                <option>Global (All Devices)</option>
                <option>Specific Device</option>
                <option>Specific User</option>
              </select>
            </div>
          </div>
          <div class="modal-row" style="margin-bottom: 14px">
            <label class="modal-check"
              ><input type="checkbox" id="pa_upload" /> Allow File Upload</label
            >
            <label class="modal-check"
              ><input type="checkbox" id="pa_download" /> Allow File
              Download</label
            >
          </div>
          <div class="modal-field">
            <label>Monitor Mode</label>
            <select id="pa_monitor">
              <option>Block (Default)</option>
              <option>Warn</option>
              <option>Log Only</option>
            </select>
            <div class="hint">
              Block: Prevent actions | Warn: Show warning | Log Only: Only log
              attempts
            </div>
          </div>
          <div class="modal-field">
            <label>Restricted File Types (Optional)</label>
            <input
              type="text"
              id="pa_filetypes"
              placeholder="exe, zip, bat, dmg (comma separated)"
            />
            <div class="hint">
              File types that are still restricted even on partial access sites
            </div>
          </div>
          <label class="modal-check"
            ><input type="checkbox" id="pa_active" checked /> Active (Start
            monitoring immediately)</label
          >
        </div>
        <div class="modal-footer">
          <button class="modal-btn-cancel" onclick="closeModal('addPaModal')">
            Cancel
          </button>
          <button class="modal-btn-save green" onclick="savePa()">
            Save Site
          </button>
        </div>
      </div>
    </div>

    <!-- ======== EDIT BLOCKED URL MODAL ======== -->
    <div class="modal-overlay" id="editBurlModal">
      <div class="modal-box">
        <div class="modal-header">
          <h3>Edit Blocked URL</h3>
          <button class="modal-close" onclick="closeModal('editBurlModal')">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="modal-body">
          <div class="modal-field">
            <label>URL Pattern <span style="color: #ef4444">*</span></label>
            <input
              type="text"
              id="edit_burl_pattern"
              placeholder="www.netflix.com"
            />
            <div class="hint">
              Use wildcards (*) for patterns. Example: *.facebook.com blocks all
              Facebook subdomains
            </div>
          </div>
          <div class="modal-field">
            <label>Reason for Blocking</label>
            <textarea
              id="edit_burl_reason"
              placeholder="Why is this URL being blocked?"
            ></textarea>
          </div>
          <div class="modal-row">
            <div class="modal-field">
              <label>Category</label>
              <select id="edit_burl_category">
                <option value="">Select Category</option>
                <option>Social Media</option>
                <option>Gaming</option>
                <option>Shopping</option>
                <option>Entertainment</option>
                <option>Malware/Phishing</option>
                <option>Productivity</option>
                <option>Other</option>
              </select>
            </div>
            <div class="modal-field">
              <label>Scope</label>
              <select id="edit_burl_scope">
                <option>Global (All Devices)</option>
                <option>Specific Device</option>
                <option>Specific User</option>
              </select>
            </div>
          </div>
          <label class="modal-check"
            ><input type="checkbox" id="edit_burl_active" /> Active (Start
            blocking immediately)</label
          >
        </div>
        <div class="modal-footer">
          <button
            class="modal-btn-cancel"
            onclick="closeModal('editBurlModal')"
          >
            Cancel
          </button>
          <button class="modal-btn-save" onclick="updateBurl()">
            Update URL
          </button>
        </div>
      </div>
    </div>

    <!-- ======== EDIT PARTIAL ACCESS SITE MODAL ======== -->
    <div class="modal-overlay" id="editPaModal">
      <div class="modal-box">
        <div class="modal-header" style="background: #0891b2">
          <h3>Edit Partial Access Site</h3>
          <button class="modal-close" onclick="closeModal('editPaModal')">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="modal-body">
          <div class="modal-field">
            <label>URL Pattern <span style="color: #ef4444">*</span></label>
            <input
              type="text"
              id="edit_pa_pattern"
              placeholder="e.g., chat.deepseek.com"
            />
            <div class="hint">
              Use wildcards (*) for patterns. Example: *.work.com allows access
              to work-related sites
            </div>
          </div>
          <div class="modal-field">
            <label>Reason</label>
            <textarea
              id="edit_pa_reason"
              placeholder="Why is this site partially accessible?"
            ></textarea>
          </div>
          <div class="modal-row">
            <div class="modal-field">
              <label>Category</label>
              <select id="edit_pa_category">
                <option value="">Select Category</option>
                <option>Work</option>
                <option>Social Media</option>
                <option>Entertainment</option>
                <option>Productivity</option>
                <option>Other</option>
              </select>
            </div>
            <div class="modal-field">
              <label>Scope</label>
              <select id="edit_pa_scope">
                <option>Global (All Devices)</option>
                <option>Specific Device</option>
                <option>Specific User</option>
              </select>
            </div>
          </div>
          <div class="modal-row" style="margin-bottom: 14px">
            <label class="modal-check"
              ><input type="checkbox" id="edit_pa_upload" /> Allow File
              Upload</label
            >
            <label class="modal-check"
              ><input type="checkbox" id="edit_pa_download" /> Allow File
              Download</label
            >
          </div>
          <div class="modal-field">
            <label>Monitor Mode</label>
            <select id="edit_pa_monitor">
              <option>Block (Default)</option>
              <option>Warn</option>
              <option>Log Only</option>
            </select>
            <div class="hint">
              Block: Prevent actions | Warn: Show warning | Log Only: Only log
              attempts
            </div>
          </div>
          <div class="modal-field">
            <label>Restricted File Types (Optional)</label>
            <input
              type="text"
              id="edit_pa_filetypes"
              placeholder="exe, zip, bat, dmg (comma separated)"
            />
            <div class="hint">
              File types that are still restricted even on partial access sites
            </div>
          </div>
          <label class="modal-check"
            ><input type="checkbox" id="edit_pa_active" /> Active (Start
            monitoring immediately)</label
          >
        </div>
        <div class="modal-footer">
          <button class="modal-btn-cancel" onclick="closeModal('editPaModal')">
            Cancel
          </button>
          <button class="modal-btn-save green" onclick="updatePa()">
            Update Site
          </button>
        </div>
      </div>
    </div>

    <script th:inline="javascript">
      let appPieChartInstance = null;
      let appLineChartInstance = null;

      async function loadAgentDetails(agentId) {
        try {
          // Try the detail endpoint first
          const response = await fetch(`/api/admin/agents/${agentId}/detail`, {
            credentials: "include",
          });

          if (response.ok) {
            const result = await response.json();
            console.log("Agent details loaded:", result);
            if (result.success && result.data) {
              updateProfileCard(result.data);
              loadViolationsFromAgent(result.data);
              return;
            }
          }

          // Fallback to agents list
          const listResponse = await fetch(`/api/admin/agents`, {
            credentials: "include",
          });
          const listResult = await listResponse.json();

          if (listResult.success) {
            const agent = listResult.data.find(
              (a) => a.id.toString() === agentId,
            );
            if (agent) {
              console.log("Agent loaded from list:", agent);
              updateProfileCard(agent);
              loadViolationsFromAgent(result.data);
            }
          }
        } catch (error) {
          console.error("Failed to load agent details:", error);
        }
      }
      function updateProfileCard(agent) {
        console.log("Updating profile card with:", agent);

        // Update hostname (h1 element)
        const hostnameEl = document.getElementById("agentHostname");
        if (hostnameEl) {
          hostnameEl.textContent =
            agent.username || agent.username || "Unknown Host";
        }
        // Update email
        const emailEl = document.getElementById("agentEmail");
        if (emailEl) {
          emailEl.textContent = agent.email || "No email";
        }

        // Update IP address
        const ipEl = document.getElementById("agentIp");
        if (ipEl) {
          ipEl.textContent = agent.ipAddress || "N/A";
        }

        // Update OS info
        const osEl = document.getElementById("agentOs");
        if (osEl) {
          osEl.textContent = "Windows 11 Pro"; // Default
        }

        // Update Last Seen
        const lastSeenEl = document.getElementById("overviewLastSeen");
        if (lastSeenEl && agent.lastHeartbeat) {
          lastSeenEl.textContent = formatTimeAgo(agent.lastHeartbeat);
        }
      }

      function loadViolationsFromAgent(agent) {
        // Try to get violations from OCR statuses
        if (agent.ocrStatuses && agent.ocrStatuses.length > 0) {
          const totalViolations = agent.ocrStatuses.reduce((sum, status) => {
            return sum + (status.violationsLast24h || 0);
          }, 0);

          const violationsEl = document.getElementById("overviewViolations");
          if (violationsEl) {
            violationsEl.textContent = totalViolations;

            // Color code based on violations count
            if (totalViolations > 0) {
              violationsEl.style.color =
                totalViolations > 5 ? "#dc2626" : "#f59e0b";
            } else {
              violationsEl.style.color = "#111827";
            }
          }
        }
      }
      async function loadViolations(agentId) {
        try {
          // Try to get violations from OCR statuses
          const response = await fetch(`/api/admin/agents/${agentId}/detail`, {
            credentials: "include",
          });

          if (response.ok) {
            const result = await response.json();
            if (result.success && result.data && result.data.ocrStatuses) {
              // Sum violations from all OCR statuses
              const totalViolations = result.data.ocrStatuses.reduce(
                (sum, status) => {
                  return sum + (status.violationsLast24h || 0);
                },
                0,
              );

              const violationsEl =
                document.getElementById("overviewViolations");
              if (violationsEl) {
                violationsEl.textContent = totalViolations;

                // Color code based on violations count
                if (totalViolations > 0) {
                  violationsEl.style.color =
                    totalViolations > 5 ? "#dc2626" : "#f59e0b";
                } else {
                  violationsEl.style.color = "#111827";
                }
              }
            }
          }
        } catch (error) {
          console.error("Failed to load violations:", error);
        }
      }

      function formatTimeAgo(dateString) {
        if (!dateString) return "Never";

        const date = new Date(dateString);
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        if (diffMins < 1) return "Just now";
        if (diffMins < 60) return `${diffMins}m ago`;

        if (diffMins < 1) return "Just now";
        if (diffMins < 60) return `${diffMins}m ago`;

        const diffHours = Math.floor(diffMins / 60);
        if (diffHours < 24) return `${diffHours}h ago`;

        const diffDays = Math.floor(diffHours / 24);
        return `${diffDays}d ago`;
      }

      function editAgent() {
        const agentId = getAgentIdFromUrl();
        if (agentId) {
          window.location.href = `agent-edit?id=${agentId}`;
        } else {
          alert("Could not determine agent ID");
        }
      }

      // Delete agent function (update this too)
      async function deleteAgent() {
        const agentId = getAgentIdFromUrl();
        if (!agentId) {
          alert("Could not determine agent ID");
          return;
        }

        if (
          confirm(
            "Are you sure you want to delete this agent? This action cannot be undone.",
          )
        ) {
          try {
            const response = await fetch(`/api/admin/agents/${agentId}`, {
              method: "DELETE",
              credentials: "include",
            });

            const result = await response.json();

            if (result.success) {
              alert("Agent deleted successfully!");
              window.location.href = "manage-agents";
            } else {
              alert(
                "Failed to delete agent: " +
                  (result.message || "Unknown error"),
              );
            }
          } catch (error) {
            console.error("Error deleting agent:", error);
            alert("Error deleting agent: " + error.message);
          }
        }
      }

      function loadAgentPolicies(agentId) {
        fetch(`/api/admin/agents/${agentId}/policies`)
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              displayAgentPolicies(data.data);
            } else {
              console.error("Failed to load policies:", data.message);
              showPoliciesError();
            }
          })
          .catch((error) => {
            console.error("Error loading policies:", error);
            showPoliciesError();
          });
      }

      async function loadBlockedUrls(agentId) {
    try {
        const response = await fetch(`/api/admin/agents/${agentId}/blocked-urls`, {
            credentials: "include",
        });
        const result = await response.json();

        const tbody = document.getElementById("burlTbody");
        const noDataMsg = document.getElementById("noBlockedUrlsMessage");
        const table = document.getElementById("burlTable");

        if (!tbody) return;

        if (result.success && result.data && result.data.length > 0) {
            // Show table, hide no-data message
            if (table) table.style.display = "table";
            if (noDataMsg) noDataMsg.style.display = "none";
            
            renderBlockedUrlsTable(result.data);
            updateBlockedUrlStats(result.data);
        } else {
            // Hide table, show no-data message
            if (table) table.style.display = "none";
            if (noDataMsg) {
                noDataMsg.style.display = "block";
                // Update agent ID in message
                const link = noDataMsg.querySelector('a');
                if (link) {
                    link.href = `assign-policy?agent=${agentId}`;
                }
            }
            
            // Clear table
            tbody.innerHTML = "";
            
            // Reset stats
            document.getElementById("totalBlockedUrlsCount").textContent = "0";
            document.getElementById("blockedUrlCategories").textContent = "0";
            document.getElementById("blockedUrlLastUpdated").textContent = "-";
        }
    } catch (error) {
        console.error("Failed to load blocked URLs:", error);
        const tbody = document.getElementById("burlTbody");
        if (tbody) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" class="text-center" style="padding: 40px; color: #ef4444;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 24px; margin-bottom: 10px;"></i>
                        <p>Error loading blocked URLs: ${error.message}</p>
                    </td>
                </tr>
            `;
        }
    }
      }
function renderBlockedUrlsTable(urls) {
    const tbody = document.getElementById("burlTbody");
    if (!tbody) return;

    tbody.innerHTML = "";

    urls.forEach((url) => {
        const row = document.createElement("tr");
        
        // Format date with fallback
        let addedDate = "N/A";
        if (url.createdAt) {
            try {
                const date = new Date(url.createdAt);
                // Check if date is valid
                if (!isNaN(date.getTime())) {
                    addedDate = date.toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                }
            } catch (e) {
                console.warn("Invalid date:", url.createdAt);
            }
        }

        // Determine category class
        let categoryClass = "entertainment";
        const category = (url.category || "Other").toLowerCase();
        
        if (category.includes("social")) {
            categoryClass = "social";
        } else if (category.includes("work") || category.includes("productivity")) {
            categoryClass = "work";
        } else if (category.includes("malware") || category.includes("phishing")) {
            categoryClass = "danger";
        }

        // Determine scope
        const scope = url.global ? "Global" : (url.deviceId ? "Device" : "User");
        const scopeClass = url.global ? "global" : "device";

        row.innerHTML = `
            <td>
                <div class="burl-url-name">${escapeHtml(url.urlPattern)}</div>
                ${url.reason ? `<div class="burl-url-reason">${escapeHtml(url.reason)}</div>` : ''}
            </td>
            <td class="burl-domain">${escapeHtml(url.domain || url.urlPattern)}</td>
            <td><span class="burl-tag ${categoryClass}">${escapeHtml(url.category || "Other")}</span></td>
            <td><span class="burl-scope ${scopeClass}">${scope}</span></td>
            <td>
                <span class="burl-status ${url.active ? "active" : "inactive"}">
                    ${url.active ? "Active" : "Inactive"}
                </span>
            </td>
            <td>${escapeHtml(url.addedBy || "System")}</td>
            <td class="burl-date">${addedDate}</td>
            <td class="text-center"><span class="badge">${url.hitCount || 0}</span></td>
        `;
        
        tbody.appendChild(row);
    });

    // Update last updated stat
    updateLastUpdatedStat(urls);
    
    // Initialize filter
    filterBurlTable();
}

function updateLastUpdatedStat(urls) {
    if (urls.length > 0) {
        // Find the most recent date from either updatedAt or createdAt
        const dates = urls
            .map(u => {
                if (u.updatedAt) return new Date(u.updatedAt);
                if (u.createdAt) return new Date(u.createdAt);
                return null;
            })
            .filter(d => d && !isNaN(d.getTime()))
            .sort((a, b) => b - a);
        
        if (dates.length > 0) {
            const lastUpdated = dates[0].toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
            document.getElementById("blockedUrlLastUpdated").textContent = lastUpdated;
        } else {
            document.getElementById("blockedUrlLastUpdated").textContent = "-";
        }
    } else {
        document.getElementById("blockedUrlLastUpdated").textContent = "-";
    }
}


  function escapeHtml(unsafe) {
    if (!unsafe) return "";
    return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
}
      function updateBlockedUrlStats(urls) {
    const totalUrls = urls.length;
    const activeUrls = urls.filter(u => u.active).length;
    
    // Update total count
    const totalEl = document.getElementById("totalBlockedUrlsCount");
    if (totalEl) totalEl.textContent = totalUrls;

    // Update categories count
    const categories = new Set(urls.map(u => u.category || "Other")).size;
    const categoriesEl = document.getElementById("blockedUrlCategories");
    if (categoriesEl) categoriesEl.textContent = categories;

    // Update last updated
    if (urls.length > 0) {
        const latestDate = urls
            .map(u => u.updatedAt || u.createdAt)
            .filter(d => d)
            .sort((a, b) => new Date(b) - new Date(a))[0];
        
        if (latestDate) {
            const lastUpdated = new Date(latestDate).toLocaleDateString();
            document.getElementById("blockedUrlLastUpdated").textContent = lastUpdated;
        }
    }
}

      function editBlockedUrl(urlId) {
        fetch(`/api/admin/blocked-urls/${urlId}`)
          .then((res) => res.json())
          .then((result) => {
            if (result.success) {
              // Populate edit modal with url data
              const url = result.data;
              document.getElementById("edit_burl_pattern").value =
                url.urlPattern;
              document.getElementById("edit_burl_reason").value =
                url.reason || "";

              // Set category
              const catSelect = document.getElementById("edit_burl_category");
              for (let i = 0; i < catSelect.options.length; i++) {
                if (
                  catSelect.options[i].text.toLowerCase() ===
                  (url.category || "Other").toLowerCase()
                ) {
                  catSelect.selectedIndex = i;
                  break;
                }
              }

              // Set scope
              const scopeSelect = document.getElementById("edit_burl_scope");
              if (url.global) {
                scopeSelect.selectedIndex = 0;
              } else if (url.deviceId) {
                scopeSelect.selectedIndex = 1;
              } else {
                scopeSelect.selectedIndex = 2;
              }

              document.getElementById("edit_burl_active").checked = url.active;

              window._editUrlId = urlId;
              openModal("editBurlModal");
            }
          });
      }

      function deleteBlockedUrl(urlId) {
        if (!confirm("Are you sure you want to delete this blocked URL?")) {
          return;
        }

        const agentId = getAgentIdFromUrl();

        fetch(`/api/admin/blocked-urls/${urlId}`, {
          method: "DELETE",
        })
          .then((res) => res.json())
          .then((result) => {
            if (result.success) {
              showNotification("URL deleted successfully", "success");
              loadBlockedUrls(agentId);
            } else {
              showNotification("Failed to delete URL", "error");
            }
          })
          .catch((error) => {
            console.error("Error deleting URL:", error);
            showNotification("Error deleting URL", "error");
          });
      }

     async function loadWebHistory(agentId) {
    const urlsContainer = document.getElementById("urlsContainer");
    const urlsLoading = document.getElementById("urlsLoading");
    const noDataDiv = document.getElementById("noUrlData");
    
    if (!urlsContainer || !urlsLoading) return;

    urlsLoading.style.display = "block";
    urlsContainer.innerHTML = "";
    if (noDataDiv) noDataDiv.style.display = "none";

    try {
        const resp = await fetch(`/api/admin/web-history-detailed/${agentId}`, {
            credentials: "include",
        });
        const result = await resp.json();
        urlsLoading.style.display = "none";

        if (!result.success || !result.data || result.data.length === 0) {
            if (noDataDiv) noDataDiv.style.display = "block";
            
            // Update stats with zeros
            updateUrlStats([]);
            return;
        }

        const history = result.data;
        
        // Update stats
        updateUrlStats(history);
        
        // Store in global variable for filtering
        window.urlHistoryData = history;
        
        // Render table
        renderUrlTable(history);

    } catch (e) {
        console.error("Failed to load web history", e);
        urlsLoading.style.display = "none";
        urlsContainer.innerHTML = '<div class="url-no-data"><i class="fas fa-exclamation-triangle" style="color: #ef4444;"></i><h4>Error Loading Data</h4><p>Failed to load URL history. Please try again.</p><button onclick="loadWebHistory(getAgentIdFromUrl())" class="btn btn-primary" style="margin-top: 16px;"><i class="fas fa-sync-alt"></i> Retry</button></div>';
    }
}

  function updateUrlStats(history) {
    // Total visits
    const totalVisitsEl = document.getElementById("totalUrlVisits");
    if (totalVisitsEl) totalVisitsEl.textContent = history.length;

    // Unique domains
    const domains = new Set();
    history.forEach(item => {
        try {
            const url = new URL(item.url);
            domains.add(url.hostname);
        } catch {
            // Simple extraction if URL parsing fails
            const match = item.url.match(/^(?:https?:\/\/)?(?:www\.)?([^\/]+)/i);
            const domain = match ? match[1] : item.url;
            domains.add(domain);
        }
    });
    const uniqueDomainsEl = document.getElementById("uniqueDomains");
    if (uniqueDomainsEl) uniqueDomainsEl.textContent = domains.size;

    // Blocked count
    const blocked = history.filter(h => h.blocked === true).length;
    const totalBlockedEl = document.getElementById("totalBlockedUrls");
    if (totalBlockedEl) totalBlockedEl.textContent = blocked;

    // Suspicious count - customize this logic as needed
    const suspicious = history.filter(h => {
        const url = h.url || '';
        const lowerUrl = url.toLowerCase();
        return lowerUrl.includes('login') || 
               lowerUrl.includes('signin') || 
               lowerUrl.includes('bank') || 
               lowerUrl.includes('pay') ||
               lowerUrl.includes('password') ||
               lowerUrl.includes('secure') ||
               lowerUrl.includes('auth');
    }).length;
    const totalSuspiciousEl = document.getElementById("totalSuspiciousUrls");
    if (totalSuspiciousEl) totalSuspiciousEl.textContent = suspicious;

    // Update overview stat
    const overviewUrls = document.getElementById("overviewUrlsVisited");
    if (overviewUrls) overviewUrls.textContent = history.length.toLocaleString();
}

  function detectBrowser(userAgent, url) {
    if (!userAgent) return "Unknown";
    
    const ua = userAgent.toLowerCase();
    if (ua.includes('chrome')) return 'Chrome';
    if (ua.includes('firefox')) return 'Firefox';
    if (ua.includes('edge')) return 'Edge';
    if (ua.includes('safari')) return 'Safari';
    if (ua.includes('opera')) return 'Opera';
    return 'Unknown';
}


function extractDomain(url) {
    try {
        const urlObj = new URL(url);
        return urlObj.hostname;
    } catch {
        // Simple extraction
        const match = url.match(/^(?:https?:\/\/)?(?:www\.)?([^\/]+)/i);
        return match ? match[1] : url;
    }
}

function getFaviconUrl(domain) {
    return `https://www.google.com/s2/favicons?domain=${domain}&sz=16`;
}

function renderUrlTable(history) {
    const urlsContainer = document.getElementById("urlsContainer");
    
    let html = `
        <table class="url-table">
            <thead>
                <tr>
                    <th>Time</th>
                    <th>URL</th>
                    <th>Browser</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
    `;

    history.forEach((entry) => {
        // Format timestamp
        let timeStr = '';
        let dateObj = null;
        
        if (Array.isArray(entry.visitTimestamp)) {
            const [year, month, day, hour, minute, second] = entry.visitTimestamp;
            dateObj = new Date(year, month - 1, day, hour, minute, second);
            timeStr = dateObj.toLocaleString('en-US', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric',
                hour: '2-digit', 
                minute: '2-digit',
                second: '2-digit',
                hour12: true 
            });
        } else {
            dateObj = new Date(entry.visitTimestamp || entry.timestamp);
            timeStr = dateObj.toLocaleString();
        }
        
        // Get relative time
        const now = new Date();
        const diffMs = now - dateObj;
        const diffMins = Math.floor(diffMs / 60000);
        let relativeTime = '';
        if (diffMins < 1) relativeTime = 'Just now';
        else if (diffMins < 60) relativeTime = `${diffMins}m ago`;
        else if (diffMins < 1440) relativeTime = `${Math.floor(diffMins / 60)}h ago`;
        else relativeTime = `${Math.floor(diffMins / 1440)}d ago`;

        const url = entry.url || '';
        const domain = extractDomain(url);
        const browser = entry.browser || 'Unknown';
        const blockedFlag = entry.blocked === true;
        
        // Detect browser icon
        let browserIcon = 'fa-globe';
        if (browser.toLowerCase().includes('chrome')) browserIcon = 'fa-chrome';
        else if (browser.toLowerCase().includes('firefox')) browserIcon = 'fa-firefox';
        else if (browser.toLowerCase().includes('edge')) browserIcon = 'fa-edge';
        else if (browser.toLowerCase().includes('safari')) browserIcon = 'fa-safari';
        
        html += `
            <tr class="url-row" data-url="${url.toLowerCase()}" data-browser="${browser.toLowerCase()}" data-status="${blockedFlag ? 'blocked' : 'allowed'}">
                <td class="time-cell">
                    <div>${timeStr}</div>
                    <small style="color: #94a3b8;">${relativeTime}</small>
                </td>
                <td>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <img src="${getFaviconUrl(domain)}" alt="" class="url-favicon" onerror="this.style.display='none'">
                        <div>
                            <a href="${url}" class="url-link" target="_blank" rel="noreferrer">${url}</a>
                            <div>
                                <span class="url-domain-badge">${domain}</span>
                            </div>
                        </div>
                    </div>
                </td>
                <td>
                    <span class="browser-badge">
                        <i class="fab ${browserIcon}"></i>
                        ${browser}
                    </span>
                </td>
                <td>
                    <span class="status-badge ${blockedFlag ? 'blocked' : 'allowed'}">
                        ${blockedFlag ? 'Blocked' : 'Allowed'}
                    </span>
                </td>
            </tr>
        `;
    });

    html += "</tbody></table>";
    urlsContainer.innerHTML = html;
}

// Filter functions
function filterUrlTable() {
    const searchTerm = document.getElementById('searchUrls').value.toLowerCase();
    const browserFilter = document.getElementById('urlBrowserFilter').value.toLowerCase();
    const statusFilter = document.getElementById('urlStatusFilter').value.toLowerCase();
    
    const rows = document.querySelectorAll('.url-row');
    
    rows.forEach(row => {
        const url = row.dataset.url;
        const browser = row.dataset.browser;
        const status = row.dataset.status;
        
        const matchesSearch = url.includes(searchTerm);
        const matchesBrowser = !browserFilter || browser.includes(browserFilter);
        const matchesStatus = !statusFilter || status === statusFilter;
        
        row.style.display = matchesSearch && matchesBrowser && matchesStatus ? '' : 'none';
    });
}

function filterUrlByType(type) {
    // Update active tab
    document.querySelectorAll('.url-filter-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    event.target.classList.add('active');
    
    const now = new Date();
    const rows = document.querySelectorAll('.url-row');
    
    rows.forEach(row => {
        const timeCell = row.querySelector('.time-cell');
        if (!timeCell) return;
        
        // Get the timestamp from the first div (not the relative time)
        const timeText = timeCell.childNodes[0]?.textContent?.trim();
        if (!timeText) return;
        
        const rowDate = new Date(timeText);
        
        let show = true;
        if (type === 'today') {
            show = rowDate.toDateString() === now.toDateString();
        } else if (type === 'week') {
            const weekAgo = new Date(now);
            weekAgo.setDate(now.getDate() - 7);
            show = rowDate >= weekAgo;
        } else if (type === 'month') {
            const monthAgo = new Date(now);
            monthAgo.setMonth(now.getMonth() - 1);
            show = rowDate >= monthAgo;
        }
        
        row.style.display = show ? '' : 'none';
    });
}
      async function loadAppUsage(agentId) {
        const pieCtx = document.getElementById("appPieChart");
        const lineCtx = document.getElementById("appLineChart");
        const topAppsList = document.getElementById("topAppsList");
        const categoryLegend = document.getElementById("categoryLegend");
        const totalCategoriesEl = document.getElementById("totalCategories");

        if (!pieCtx || !lineCtx || !topAppsList) return;

        try {
          // Show loading state
          topAppsList.innerHTML = `
            <div class="text-center" style="padding: 40px; color: #6b7280;">
                <i class="fas fa-spinner fa-spin" style="font-size: 48px; margin-bottom: 16px; opacity: 0.5;"></i>
                <p>Loading app usage data...</p>
            </div>
        `;

          const resp = await fetch(`/api/admin/app-usage/${agentId}?limit=50`, {
            credentials: "include",
          });
          const result = await resp.json();

          if (!result.success || !result.data || result.data.length === 0) {
            topAppsList.innerHTML = `
                <div class="text-center" style="padding: 60px; background: #f9fafb; border-radius: 12px;">
                    <i class="fas fa-chart-pie" style="font-size: 48px; color: #9ca3af; margin-bottom: 16px;"></i>
                    <h4 style="color: #374151; margin-bottom: 8px;">No App Usage Data</h4>
                    <p style="color: #6b7280;">This agent hasn't reported any app usage yet.</p>
                </div>
            `;

            // Clear charts
            if (pieCtx) {
              if (appPieChartInstance) appPieChartInstance.destroy();
              const ctx = pieCtx.getContext("2d");
              ctx.clearRect(0, 0, pieCtx.width, pieCtx.height);
            }
            if (lineCtx) {
              if (appLineChartInstance) appLineChartInstance.destroy();
              const ctx = lineCtx.getContext("2d");
              ctx.clearRect(0, 0, lineCtx.width, lineCtx.height);
            }

            if (totalCategoriesEl) totalCategoriesEl.textContent = "0";
            if (categoryLegend) {
              categoryLegend.innerHTML = `
                    <div class="legend-item">
                        <div class="legend-color" style="background: #9ca3af;">
                            <i class="fas fa-question"></i>
                        </div>
                        <div class="legend-details">
                            <span class="legend-label">No Data</span>
                            <span class="legend-value">0%</span>
                        </div>
                    </div>
                `;
            }

            // Update overview stat
            const overviewApps = document.getElementById("overviewAppsUsed");
            if (overviewApps) overviewApps.textContent = "0";

            return;
          }

          // Get the latest entry (most recent)
          const latest = result.data[0];
          let payload = {};

          try {
            payload = latest.payloadJson ? JSON.parse(latest.payloadJson) : {};
          } catch (e) {
            console.warn("Failed to parse app usage payloadJson", e);
          }

          // Update overview stat with total apps tracked
          const totalAppsTracked =
            payload.total_apps_tracked || payload.totalAppsTracked || 0;
          const overviewApps = document.getElementById("overviewAppsUsed");
          if (overviewApps) overviewApps.textContent = totalAppsTracked;

          // Process category breakdown for pie chart
          const categoryBreakdown =
            payload.category_breakdown || payload.categoryBreakdown || {};
          const categories = Object.keys(categoryBreakdown);
          const categoryValues = Object.values(categoryBreakdown);

          // Calculate total time for percentages
          const totalTime = categoryValues.reduce((a, b) => a + b, 0);

          if (totalCategoriesEl)
            totalCategoriesEl.textContent = categories.length;

          // Generate colors for categories
          const colors = [
            "#3b82f6",
            "#10b981",
            "#f59e0b",
            "#8b5cf6",
            "#ec4899",
            "#6366f1",
            "#14b8a6",
            "#f97316",
          ];

          // Update category legend
          if (categoryLegend) {
            if (categories.length > 0) {
              let legendHtml = "";
              categories.forEach((category, index) => {
                const percentage =
                  totalTime > 0
                    ? ((categoryValues[index] / totalTime) * 100).toFixed(1)
                    : 0;
                const color = colors[index % colors.length];
                legendHtml += `
                        <div class="legend-item">
                            <div class="legend-color" style="background: ${color};">
                                <i class="fas fa-${getCategoryIcon(category)}"></i>
                            </div>
                            <div class="legend-details">
                                <span class="legend-label">${category}</span>
                                <span class="legend-value">${percentage}%</span>
                            </div>
                        </div>
                    `;
              });
              categoryLegend.innerHTML = legendHtml;
            } else {
              categoryLegend.innerHTML = `
                    <div class="legend-item">
                        <div class="legend-color" style="background: #9ca3af;">
                            <i class="fas fa-question"></i>
                        </div>
                        <div class="legend-details">
                            <span class="legend-label">No Data</span>
                            <span class="legend-value">0%</span>
                        </div>
                    </div>
                `;
            }
          }

          // Create/Update Pie Chart
          if (categories.length > 0) {
            if (appPieChartInstance) {
              appPieChartInstance.destroy();
            }

            appPieChartInstance = new Chart(pieCtx, {
              type: "doughnut",
              data: {
                labels: categories,
                datasets: [
                  {
                    data: categoryValues,
                    backgroundColor: colors.slice(0, categories.length),
                    borderWidth: 4,
                    borderColor: "#ffffff",
                    borderRadius: 8,
                    spacing: 2,
                  },
                ],
              },
              options: {
                responsive: true,
                maintainAspectRatio: true,
                cutout: "70%",
                plugins: {
                  legend: { display: false },
                  tooltip: {
                    callbacks: {
                      label: function (context) {
                        const value = context.raw;
                        const percentage =
                          totalTime > 0
                            ? ((value / totalTime) * 100).toFixed(1)
                            : 0;
                        return `${context.label}: ${formatTime(value)} (${percentage}%)`;
                      },
                    },
                  },
                },
              },
            });
          }

          // Process top apps
          const topApps = payload.top_apps || payload.topApps || [];

          if (topApps.length > 0) {
            let appsHtml = "";
            topApps.forEach((app, index) => {
              const appName = app.app || app.name || "Unknown";
              const timeInSeconds = app.active_time || app.activeTime || 0;
              const category = app.category || "Other";
              const sessions = app.sessions || 0;

              appsHtml += `
                    <div class="app-item">
                        <div class="app-info">
                            <div class="app-icon">
                                <i class="fas fa-${getAppIcon(appName)}" style="font-size: 1.3em; color: ${getAppColor(appName)};"></i>
                            </div>
                            <div class="app-details">
                                <h4>${appName}</h4>
                                <p>${category} Â· ${sessions} session${sessions !== 1 ? "s" : ""}</p>
                            </div>
                        </div>
                        <div class="app-time">${formatTime(timeInSeconds)}</div>
                    </div>
                `;
            });
            topAppsList.innerHTML = appsHtml;
          } else {
            topAppsList.innerHTML = `
                <div class="text-center" style="padding: 40px; background: #f9fafb; border-radius: 12px;">
                    <i class="fas fa-info-circle" style="font-size: 32px; color: #9ca3af; margin-bottom: 12px;"></i>
                    <p style="color: #6b7280;">No top applications data available yet.</p>
                </div>
            `;
          }

          // Process timeline data for line chart
          const entries = result.data;
          if (entries.length > 0) {
            // Get last 7 days of data (or less if not available)
            const timelineData = entries.slice(0, 7).reverse();

            // FIXED: Proper date parsing with consistent variable name
            const labels = timelineData.map((entry) => {
              let dateStr = entry.receivedAt || entry.timestamp;

              if (!dateStr) return "Unknown";

              try {
                let date;

                // Check if it's an array (your backend format)
                if (Array.isArray(dateStr)) {
                  // Format: [year, month, day, hour, minute, second, nano]
                  const [year, month, day, hour, minute, second] = dateStr;
                  // Note: month is 0-indexed in JS Date (0 = January)
                  date = new Date(year, month - 1, day, hour, minute, second);
                }
                // Handle string format
                else if (typeof dateStr === "string") {
                  // Try to parse the date string
                  let cleanDateStr = dateStr.replace(" ", "T");
                  date = new Date(cleanDateStr);

                  // If still invalid, try alternative parsing
                  if (isNaN(date.getTime())) {
                    // Try parsing as ISO string
                    date = new Date(dateStr);
                  }
                }
                // Handle number (timestamp)
                else if (typeof dateStr === "number") {
                  date = new Date(dateStr);
                } else {
                  date = new Date(dateStr);
                }

                // Check if date is valid
                if (isNaN(date.getTime())) {
                  console.warn("Invalid date:", dateStr);
                  return "Unknown";
                }

                return date.toLocaleDateString("en-US", {
                  month: "short",
                  day: "numeric",
                });
              } catch (e) {
                console.warn("Error parsing date:", dateStr, e);
                return "Unknown";
              }
            });

            // Log to see what we're getting (for debugging)
            console.log("Timeline data:", timelineData);
            console.log("Parsed labels:", labels);

            // FIXED: Safely parse payload JSON
            const values = timelineData.map((entry) => {
              try {
                if (entry.payloadJson) {
                  const p =
                    typeof entry.payloadJson === "string"
                      ? JSON.parse(entry.payloadJson)
                      : entry.payloadJson;
                  return p.active_usage_time || p.activeUsageTime || 0;
                }
              } catch {
                // Ignore parse errors
              }
              return 0;
            });

            // Only create chart if we have valid data
            const validLabels = labels.filter((l) => l !== "Unknown");
            const validValues = values.slice(0, validLabels.length);

            if (validLabels.length > 0 && validValues.some((v) => v > 0)) {
              if (appLineChartInstance) {
                appLineChartInstance.destroy();
              }

              const ctx = lineCtx.getContext("2d");
              const gradient = ctx.createLinearGradient(0, 0, 0, 300);
              gradient.addColorStop(0, "rgba(59, 130, 246, 0.2)");
              gradient.addColorStop(1, "rgba(59, 130, 246, 0)");

              appLineChartInstance = new Chart(lineCtx, {
                type: "line",
                data: {
                  labels: validLabels,
                  datasets: [
                    {
                      label: "Active Usage Time",
                      data: validValues,
                      borderColor: "#3b82f6",
                      backgroundColor: gradient,
                      tension: 0.4,
                      fill: true,
                      borderWidth: 2,
                      pointBackgroundColor: "#3b82f6",
                      pointBorderColor: "#ffffff",
                      pointBorderWidth: 2,
                      pointRadius: 4,
                      pointHoverRadius: 6,
                    },
                  ],
                },
                options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  plugins: {
                    legend: { display: false },
                    tooltip: {
                      callbacks: {
                        label: function (context) {
                          return `Active Time: ${formatTime(context.raw)}`;
                        },
                      },
                    },
                  },
                  scales: {
                    y: {
                      beginAtZero: true,
                      ticks: {
                        callback: function (value) {
                          return formatTime(value);
                        },
                      },
                    },
                  },
                },
              });
            } else {
              // Clear chart if no valid data
              if (appLineChartInstance) {
                appLineChartInstance.destroy();
                appLineChartInstance = null;
              }
              const ctx = lineCtx.getContext("2d");
              ctx.clearRect(0, 0, lineCtx.width, lineCtx.height);

              // Show "No data" message on chart
              ctx.font = "14px Arial";
              ctx.fillStyle = "#9ca3af";
              ctx.textAlign = "center";
              ctx.fillText(
                "No timeline data available",
                lineCtx.width / 2,
                lineCtx.height / 2,
              );
            }
          }
        } catch (e) {
          console.error("Failed to load app usage", e);
          topAppsList.innerHTML = `
            <div class="text-center" style="padding: 40px; background: #fef2f2; border-radius: 12px;">
                <i class="fas fa-exclamation-triangle" style="font-size: 32px; color: #ef4444; margin-bottom: 12px;"></i>
                <h4 style="color: #991b1b; margin-bottom: 8px;">Error Loading Data</h4>
                <p style="color: #b91c1c;">Failed to load app usage data. Please try again.</p>
                <button onclick="loadAppUsage('${agentId}')" class="btn btn-primary" style="margin-top: 16px;">
                    <i class="fas fa-sync-alt"></i> Retry
                </button>
            </div>
        `;
        }
      }
      // Helper function to format time
      function formatTime(seconds) {
        if (!seconds || seconds < 0) return "0s";

        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        const secs = Math.floor(seconds % 60);

        if (hours > 0) {
          return `${hours}h ${minutes}m`;
        } else if (minutes > 0) {
          return `${minutes}m ${secs}s`;
        } else {
          return `${secs}s`;
        }
      }

      // Helper function to get icon for app
      function getAppIcon(appName) {
        const name = appName.toLowerCase();
        if (
          name.includes("chrome") ||
          name.includes("firefox") ||
          name.includes("edge") ||
          name.includes("browser")
        ) {
          return "globe";
        } else if (
          name.includes("code") ||
          name.includes("vscode") ||
          name.includes("visual") ||
          name.includes("intellij")
        ) {
          return "code";
        } else if (
          name.includes("word") ||
          name.includes("excel") ||
          name.includes("powerpoint") ||
          name.includes("outlook")
        ) {
          return "file-alt";
        } else if (
          name.includes("spotify") ||
          name.includes("vlc") ||
          name.includes("media")
        ) {
          return "music";
        } else if (
          name.includes("slack") ||
          name.includes("teams") ||
          name.includes("discord")
        ) {
          return "comment";
        } else {
          return "window-maximize";
        }
      }

      // partial
      async function loadPartialAccessSites(agentId) {
        try {
          const response = await fetch(
            `/api/admin/agents/${agentId}/partial-access`,
            {
              credentials: "include",
            },
          );
          const result = await response.json();

          if (result.success && result.data) {
            renderPartialAccessTable(result.data);
            updatePartialAccessStats(result.data);
          } else {
            document.getElementById("paTbody").innerHTML = `
                <tr>
                    <td colspan="8" class="text-center" style="padding: 40px; color: #6b7280;">
                        <i class="fas fa-info-circle" style="font-size: 24px; margin-bottom: 10px;"></i>
                        <p>No partial access sites configured</p>
                    </td>
                </tr>
            `;
            updatePartialAccessStats([]);
          }
        } catch (error) {
          console.error("Failed to load partial access sites:", error);
          document.getElementById("paTbody").innerHTML = `
            <tr>
                <td colspan="8" class="text-center" style="padding: 40px; color: #ef4444;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 24px; margin-bottom: 10px;"></i>
                    <p>Error loading partial access sites</p>
                </td>
            </tr>
        `;
        }
      }

      function renderPartialAccessTable(sites) {
        const tbody = document.getElementById("paTbody");
        if (!tbody) return;

        tbody.innerHTML = "";

        sites.forEach((site) => {
          const row = document.createElement("tr");
          row.dataset.siteId = site.id;

          let permissionClass = "monitor";
          let permissionText = site.monitorMode || "Monitor";

          if (!site.allowUpload && !site.allowDownload) {
            permissionText = "No Upload/Download";
          } else if (!site.allowUpload) {
            permissionText = "No Upload";
          } else if (!site.allowDownload) {
            permissionText = "No Download";
          }

          const updatedDate = site.updatedAt
            ? new Date(site.updatedAt).toLocaleDateString()
            : "N/A";

          row.innerHTML = `
            <td>
                <div class="burl-url-name">${site.urlPattern}</div>
                <div class="burl-url-reason">${site.reason || ""}</div>
            </td>
            <td class="burl-domain">${site.urlPattern}</td>
            <td><span class="burl-tag ${permissionClass}">${permissionText}</span></td>
            <td><span class="burl-tag work">${site.category || "Other"}</span></td>
            <td><span class="burl-scope ${site.scope || "device"}">${formatScope(site.scope)}</span></td>
            <td><span class="burl-status ${site.active ? "active" : "inactive"}">${site.active ? "Active" : "Inactive"}</span></td>
            <td class="burl-date">${updatedDate}</td>
            <td>
                <div class="burl-actions">
                    <button class="burl-action-btn edit" title="Edit" onclick="openEditPaModal(this)">
                        <i class="fas fa-pen"></i>
                    </button>
                    <button class="burl-action-btn delete" title="Delete" onclick="deletePartialAccessSite(${site.id})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        `;
          tbody.appendChild(row);
        });
      }

      function formatScope(scope) {
        switch (scope) {
          case "global":
            return "Global";
          case "user":
            return "User";
          case "device":
            return "Device";
          default:
            return "Device";
        }
      }

      function updatePartialAccessStats(sites) {
        const totalSites = sites.length;
        const activeSites = sites.filter((s) => s.active).length;

        const statValue = document.querySelector(
          "#partialAccess .burl-stat-value",
        );
        const statSub = document.querySelector("#partialAccess .burl-stat-sub");
        if (statValue) statValue.textContent = totalSites;
        if (statSub) statSub.textContent = `${activeSites} Active`;

        const categories = new Set(sites.map((s) => s.category || "Other"))
          .size;
        const categoryElements = document.querySelectorAll(
          "#partialAccess .burl-stat-card",
        );
        if (categoryElements.length > 1) {
          categoryElements[1].querySelector(".burl-stat-value").textContent =
            categories;
        }
      }

      // Edit function (opens modal with site data)
      function editPartialAccessSite(siteId) {
        // Fetch site details and open edit modal
        fetch(`/api/admin/partial-access/${siteId}`)
          .then((res) => res.json())
          .then((result) => {
            if (result.success) {
              openEditPaModal(result.data);
            }
          });
      }

      function openAddPaModal() {
        document.getElementById("pa_pattern").value = "";
        document.getElementById("pa_reason").value = "";
        document.getElementById("pa_category").value = "";
        document.getElementById("pa_scope").selectedIndex = 0;
        document.getElementById("pa_upload").checked = false;
        document.getElementById("pa_download").checked = false;
        document.getElementById("pa_monitor").value = "block";
        document.getElementById("pa_filetypes").value = "";
        document.getElementById("pa_active").checked = true;
        openModal("addPaModal");
      }

      function savePa() {
        var pattern = document.getElementById("pa_pattern").value.trim();
        if (!pattern) {
          alert("URL Pattern is required");
          return;
        }

        const fileTypesInput = document
          .getElementById("pa_filetypes")
          .value.trim();
        const restrictedFileTypes = fileTypesInput
          ? fileTypesInput
              .split(",")
              .map((s) => s.trim())
              .filter((s) => s.length > 0)
          : [];

        const scope = document.getElementById("pa_scope").value;
        const isGlobal = scope === "global";
        const agentId = getAgentIdFromUrl();

        if (!agentId) {
          alert("Could not determine agent ID");
          return;
        }

        var siteData = {
          urlPattern: pattern,
          domain: pattern,
          reason: document.getElementById("pa_reason").value,
          category: document.getElementById("pa_category").value || "Other",
          active: document.getElementById("pa_active").checked,
          global: isGlobal,
          allowUpload: document.getElementById("pa_upload").checked,
          allowDownload: document.getElementById("pa_download").checked,
          monitorMode: document.getElementById("pa_monitor").value,
          restrictedFileTypes: restrictedFileTypes,
          deviceId: isGlobal ? null : agentId.toString(),
        };

        const saveBtn = document.querySelector("#addPaModal .modal-btn-save");
        const originalText = saveBtn.innerHTML;
        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
        saveBtn.disabled = true;

        fetch("/api/admin/partial-access", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          credentials: "include",
          body: JSON.stringify(siteData),
        })
          .then((response) => response.json())
          .then((result) => {
            if (result.success) {
              showNotification("Site added successfully", "success");
              closeModal("addPaModal");
              return updateAgentPolicy(agentId);
            } else {
              throw new Error(result.message || "Failed to add site");
            }
          })
          .then(() => {
            loadPartialAccessSites(agentId);
          })
          .catch((error) => {
            console.error("Error adding site:", error);
            showNotification("Error adding site: " + error.message, "error");
          })
          .finally(() => {
            saveBtn.innerHTML = originalText;
            saveBtn.disabled = false;
          });
      }

      function updateAgentPolicy(agentId) {
        return fetch(`/api/admin/agents/${agentId}/partial-access`, {
          credentials: "include",
        })
          .then((res) => res.json())
          .then((result) => {
            if (!result.success || !result.data) {
              throw new Error("Failed to fetch current sites");
            }

            const sites = result.data.map((site) => ({
              urlPattern: site.urlPattern,
              category: site.category || "Other",
              monitorMode: site.monitorMode || "block",
              scope: site.scope || "device",
              reason: site.reason || "",
              allowUpload: site.allowUpload || false,
              allowDownload: site.allowDownload || false,
              restrictedFileTypes: site.restrictedFileTypes || [],
              active: site.active !== false,
            }));

            return fetch("/api/admin/assign-protection", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              credentials: "include",
              body: JSON.stringify({
                agentIds: [parseInt(agentId)],
                policyCode: "WEB_PARTIAL_ACCESS",
                policyData: JSON.stringify({
                  enabled: sites.length > 0,
                  partialAccessSites: sites,
                }),
              }),
            });
          })
          .then((res) => res.json())
          .then((result) => {
            if (!result.success) {
              console.warn("Policy update warning:", result.message);
            }
          });
      }

      function openEditPaModal(btn) {
        const row = btn.closest("tr");
        if (!row) return;

        const siteId = row.dataset.siteId;
        const cells = row.querySelectorAll("td");
        const urlName =
          cells[0].querySelector(".burl-url-name")?.textContent || "";
        const urlReason =
          cells[0].querySelector(".burl-url-reason")?.textContent || "";
        const permissionText =
          cells[2].querySelector(".burl-tag")?.textContent || "";
        const categoryText =
          cells[3].querySelector(".burl-tag")?.textContent || "Other";
        const scopeText =
          cells[4].querySelector(".burl-scope")?.textContent || "Device";

        document.getElementById("edit_pa_pattern").value = urlName;
        document.getElementById("edit_pa_reason").value = urlReason;

        const categoryMap = {
          Work: "Work",
          "Social Media": "Social",
          Entertainment: "Entertainment",
          Productivity: "Productivity",
          Other: "Other",
        };
        const catSelect = document.getElementById("edit_pa_category");
        for (let i = 0; i < catSelect.options.length; i++) {
          if (catSelect.options[i].text === categoryText) {
            catSelect.selectedIndex = i;
            break;
          }
        }

        const isUploadAllowed = !permissionText.includes("No Upload");
        const isDownloadAllowed = !permissionText.includes("No Download");
        document.getElementById("edit_pa_upload").checked = isUploadAllowed;
        document.getElementById("edit_pa_download").checked = isDownloadAllowed;

        const monitorMap = { Block: "block", Warn: "warn", "Log Only": "log" };
        const monSelect = document.getElementById("edit_pa_monitor");
        for (let i = 0; i < monSelect.options.length; i++) {
          if (
            monSelect.options[i].text
              .toLowerCase()
              .includes(permissionText.toLowerCase())
          ) {
            monSelect.selectedIndex = i;
            break;
          }
        }

        const scopeMap = { Global: "global", User: "user", Device: "device" };
        const scopeSelect = document.getElementById("edit_pa_scope");
        for (let i = 0; i < scopeSelect.options.length; i++) {
          if (scopeSelect.options[i].text === scopeText) {
            scopeSelect.selectedIndex = i;
            break;
          }
        }

        const isActive =
          cells[5].querySelector(".burl-status")?.textContent === "Active";
        document.getElementById("edit_pa_active").checked = isActive;

        document.getElementById("edit_pa_filetypes").value = "";

        window._editPaRow = row;
        openModal("editPaModal");
      }

      function deletePartialAccessSite(siteId) {
        if (
          !confirm("Are you sure you want to delete this partial access site?")
        ) {
          return;
        }

        const agentId = getAgentIdFromUrl();

        fetch(`/api/admin/partial-access/${siteId}`, {
          method: "DELETE",
        })
          .then((res) => res.json())
          .then((result) => {
            if (result.success) {
              showNotification("Site deleted successfully", "success");
              return updateAgentPolicy(agentId);
            } else {
              throw new Error(result.message || "Delete failed");
            }
          })
          .then(() => {
            loadPartialAccessSites(agentId);
          })
          .catch((error) => {
            console.error("Error deleting site:", error);
            showNotification("Error deleting site: " + error.message, "error");
          });
      }

      // Helper function to get color for app
      function getAppColor(appName) {
        const name = appName.toLowerCase();
        if (name.includes("chrome")) return "#4285f4";
        if (name.includes("firefox")) return "#ff7139";
        if (name.includes("edge")) return "#0078d4";
        if (name.includes("code") || name.includes("vscode")) return "#007acc";
        if (name.includes("visual")) return "#5C2D91";
        if (name.includes("slack")) return "#4A154B";
        if (name.includes("teams")) return "#6264A7";
        if (name.includes("spotify")) return "#1DB954";
        return "#2563eb";
      }

      // Helper function to get icon for category
      function getCategoryIcon(category) {
        const cat = category.toLowerCase();
        if (cat.includes("browser")) return "globe";
        if (cat.includes("communication")) return "comment";
        if (cat.includes("social")) return "users";
        if (cat.includes("productivity")) return "tasks";
        if (cat.includes("development")) return "code";
        if (cat.includes("creative")) return "paint-brush";
        if (cat.includes("entertainment")) return "film";
        if (cat.includes("utility")) return "wrench";
        return "chart-pie";
      }

      // Function to display policies in the Policies tab
      function displayAgentPolicies(policies) {
        const policyContainer = document.querySelector(
          "#policies .policy-list",
        );
        if (!policyContainer) return;

        if (!policies || policies.length === 0) {
          policyContainer.innerHTML = `
            <div style="text-align: center; padding: 40px; background: #f9fafb; border-radius: 8px;">
                <i class="fas fa-shield-alt" style="font-size: 48px; color: #9ca3af; margin-bottom: 16px;"></i>
                <h4 style="color: #374151; margin-bottom: 8px;">No Active Policies</h4>
                <p style="color: #6b7280;">This agent doesn't have any active policies yet.</p>
            </div>
        `;
          return;
        }

        let html = "";
        policies.forEach((policy) => {
          // Parse policy data if it's JSON
          let rules = [];
          try {
            if (policy.policyData) {
              const data = JSON.parse(policy.policyData);
              if (Array.isArray(data)) {
                rules = data;
              } else if (typeof data === "object") {
                rules = Object.values(data);
              }
            }
          } catch (e) {
            // If not JSON, use as string
            if (policy.policyData) {
              rules = [policy.policyData];
            }
          }

          // Generate rule tags
          const ruleTags =
            rules.length > 0
              ? rules
                  .map((rule) => `<span class="rule-tag">${rule}</span>`)
                  .join("")
              : '<span class="rule-tag">No specific rules</span>';

          html += `
            <div class="policy-card" data-policy-id="${policy.id}" data-policy-code="${policy.policyCode}">
                <div class="policy-header">
                    <h4 class="policy-title">${policy.name || policy.policyCode}</h4>
                    <div style="display:flex; align-items:center; gap:10px;">
                        <span class="policy-status active">Active</span>
                        <button class="policy-delete-btn" onclick="removePolicyFromAgent(this)" title="Remove">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                <p class="policy-desc">${policy.description || "No description available"}</p>
                <div class="policy-rules">
                    ${ruleTags}
                </div>
            </div>
        `;
        });

        policyContainer.innerHTML = html;
      }

      // Function to show error state
      function showPoliciesError() {
        const policyContainer = document.querySelector(
          "#policies .policy-list",
        );
        if (policyContainer) {
          policyContainer.innerHTML = `
            <div style="text-align: center; padding: 40px; background: #f9fafb; border-radius: 8px;">
                <i class="fas fa-exclamation-triangle" style="font-size: 48px; color: #ef4444; margin-bottom: 16px;"></i>
                <h4 style="color: #374151; margin-bottom: 8px;">Error Loading Policies</h4>
                <p style="color: #6b7280;">Failed to load policies. Please try again.</p>
                <button onclick="loadAgentPolicies(getAgentIdFromUrl())" class="btn btn-primary" style="margin-top: 16px;">
                    <i class="fas fa-sync-alt"></i> Retry
                </button>
            </div>
        `;
        }
      }

      // Helper function to get agent ID from URL
      function getAgentIdFromUrl() {
        const urlParams = new URLSearchParams(window.location.search);
        const id = urlParams.get("id");
        if (id) return id;

        // Try to extract from the current page context
        // You might need to adjust this based on how you're passing the agent ID
        const agentName = document.querySelector(
          ".profile-details h1",
        )?.textContent;
        if (agentName) {
          // If you have a mapping or can extract from somewhere else
          // For now, you might want to store the agent ID in a data attribute
          return document.querySelector(".profile-card")?.dataset.agentId;
        }
        return null;
      }

      // Function to remove policy from agent
      function removePolicyFromAgent(buttonElement) {
        if (
          !confirm(
            "Are you sure you want to remove this policy from the agent?",
          )
        ) {
          return;
        }

        // Get the policy card
        const policyCard = buttonElement.closest(".policy-card");
        if (!policyCard) return;

        // Get policy details from data attributes
        const policyCode = policyCard.dataset.policyCode;
        const policyId = policyCard.dataset.policyId;
        const agentId = getAgentIdFromUrl();

        if (!agentId) {
          alert("Could not determine agent ID");
          return;
        }

        if (!policyCode) {
          alert("Could not determine policy code");
          return;
        }

        console.log("Removing policy:", { policyId, policyCode, agentId });

        // Disable the button to prevent double submission
        buttonElement.disabled = true;
        buttonElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

        // Call the deactivate-protection endpoint
        fetch("/api/admin/deactivate-protection", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            agentIds: [parseInt(agentId)],
            policyCode: policyCode,
          }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              // Remove the policy card from UI with animation
              policyCard.style.transition = "all 0.3s ease";
              policyCard.style.opacity = "0";
              policyCard.style.transform = "translateX(20px)";

              setTimeout(() => {
                policyCard.remove();

                // Check if there are no more policies
                const policyContainer = document.querySelector(
                  "#policies .policy-list",
                );
                if (policyContainer.children.length === 0) {
                  displayAgentPolicies([]);
                }

                // Show success message
                showNotification("Policy removed successfully", "success");
              }, 300);
            } else {
              // Re-enable the button
              buttonElement.disabled = false;
              buttonElement.innerHTML = '<i class="fas fa-trash"></i>';

              // Show error message
              showNotification(
                "Failed to remove policy: " + (data.message || "Unknown error"),
                "error",
              );
            }
          })
          .catch((error) => {
            console.error("Error removing policy:", error);

            // Re-enable the button
            buttonElement.disabled = false;
            buttonElement.innerHTML = '<i class="fas fa-trash"></i>';

            // Show error message
            showNotification(
              "Error removing policy: " + error.message,
              "error",
            );
          });
      }

      function showNotification(message, type = "info") {
        // Check if notification container exists, if not create it
        let notificationContainer = document.getElementById(
          "notification-container",
        );
        if (!notificationContainer) {
          notificationContainer = document.createElement("div");
          notificationContainer.id = "notification-container";
          notificationContainer.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
        `;
          document.body.appendChild(notificationContainer);
        }

        // Create notification element
        const notification = document.createElement("div");
        notification.style.cssText = `
        background: ${type === "success" ? "#10b981" : type === "error" ? "#ef4444" : "#3b82f6"};
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        margin-bottom: 10px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        display: flex;
        align-items: center;
        gap: 10px;
        animation: slideIn 0.3s ease;
        font-size: 0.9em;
    `;

        // Add icon based on type
        const icon =
          type === "success"
            ? "fa-check-circle"
            : type === "error"
              ? "fa-exclamation-circle"
              : "fa-info-circle";

        notification.innerHTML = `
        <i class="fas ${icon}"></i>
        <span>${message}</span>
    `;

        // Add to container
        notificationContainer.appendChild(notification);

        // Auto remove after 3 seconds
        setTimeout(() => {
          notification.style.animation = "slideOut 0.3s ease";
          setTimeout(() => {
            notification.remove();
          }, 300);
        }, 3000);
      }

      // Add CSS animations
      const style = document.createElement("style");
      style.textContent = `
    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    @keyframes slideOut {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(100%);
            opacity: 0;
        }
    }
`;
      document.head.appendChild(style);
      /* ==================== SIDEBAR & HEADER FUNCTIONS ==================== */

      function toggleSubMenu(element) {
        var sidebar = document.getElementById("sidebar");
        if (sidebar.classList.contains("collapsed")) return;

        var subMenu = element.nextElementSibling;
        var allSubMenus = document.querySelectorAll(".sub-menu");
        var allDropdowns = document.querySelectorAll(".nav-dropdown");

        // Close other open submenus
        allSubMenus.forEach(function (menu) {
          if (menu !== subMenu) menu.classList.remove("open");
        });
        allDropdowns.forEach(function (link) {
          if (link !== element) link.classList.remove("expanded");
        });

        // Toggle current
        element.classList.toggle("expanded");
        subMenu.classList.toggle("open");
      }

      function toggleSidebar() {
        var sidebar = document.getElementById("sidebar");
        var mainContent = document.getElementById("mainContent");
        var header = document.getElementById("topHeader");

        sidebar.classList.toggle("collapsed");
        var isCollapsed = sidebar.classList.contains("collapsed");

        if (mainContent) mainContent.classList.toggle("expanded");

        // Update header left position instantly
        if (header) {
          header.style.left = isCollapsed ? "70px" : "240px";
        }

        // Close all submenus when collapsing
        if (isCollapsed) {
          document.querySelectorAll(".sub-menu").forEach(function (m) {
            m.classList.remove("open");
          });
          document.querySelectorAll(".nav-dropdown").forEach(function (l) {
            l.classList.remove("expanded");
          });
        }

        // Dispatch event in case other scripts listen
        window.dispatchEvent(
          new CustomEvent("sidebarToggle", {
            detail: { collapsed: isCollapsed },
          }),
        );
      }

      function openMobileSidebar() {
        var sidebar = document.getElementById("sidebar");
        var overlay = document.getElementById("sidebarOverlay");
        if (sidebar) sidebar.classList.add("mobile-open");
        if (overlay) overlay.classList.add("active");
      }

      function closeMobileSidebar() {
        var sidebar = document.getElementById("sidebar");
        var overlay = document.getElementById("sidebarOverlay");
        if (sidebar) sidebar.classList.remove("mobile-open");
        if (overlay) overlay.classList.remove("active");
      }

      function toggleMobileMenu() {
        var sidebar = document.getElementById("sidebar");
        var overlay = document.getElementById("sidebarOverlay");
        if (!sidebar) return;

        if (sidebar.classList.contains("mobile-open")) {
          closeMobileSidebar();
        } else {
          openMobileSidebar();
        }
      }

      function toggleNotifications(event) {
        event.stopPropagation();
        var panel = document.getElementById("notificationsPanel");
        var overlay = document.getElementById("notificationOverlay");
        var btn = event.currentTarget;
        if (!panel || !overlay) return;

        if (panel.classList.contains("show")) {
          closeNotifications();
        } else {
          closeUserDropdown();
          panel.classList.add("show");
          overlay.classList.add("show");
          btn.classList.add("active");
          document.body.style.overflow = "hidden";
        }
      }

      function closeNotifications() {
        var panel = document.getElementById("notificationsPanel");
        var overlay = document.getElementById("notificationOverlay");
        var btn = document.querySelector(".notification-btn");
        if (panel) panel.classList.remove("show");
        if (overlay) overlay.classList.remove("show");
        if (btn) btn.classList.remove("active");
        document.body.style.overflow = "";
      }

      function switchTab(event, tabName) {
        document.querySelectorAll(".tab-btn").forEach(function (t) {
          t.classList.remove("active");
        });
        event.currentTarget.classList.add("active");
        document
          .querySelectorAll(".notification-item")
          .forEach(function (item) {
            item.style.display =
              tabName === "unread" && !item.classList.contains("unread")
                ? "none"
                : "flex";
          });
      }

      function toggleUserDropdown(event) {
        event.stopPropagation();
        var dropdown = document.getElementById("userDropdown");
        var userProfile = event.currentTarget;
        if (!dropdown) return;

        if (dropdown.classList.contains("show")) {
          closeUserDropdown();
        } else {
          closeNotifications();
          dropdown.classList.add("show");
          userProfile.classList.add("active");
        }
      }

      function closeUserDropdown() {
        var dropdown = document.getElementById("userDropdown");
        var userProfile = document.querySelector(".user-profile");
        if (dropdown) dropdown.classList.remove("show");
        if (userProfile) userProfile.classList.remove("active");
      }

      function logout(event) {
        event.preventDefault();
        window.location.href = "/logout";
      }

      function setActiveMenuItem() {
        var currentPage =
          window.location.pathname.split("/").pop() || "agent-view";
        if (!currentPage) currentPage = "agent-view";

        // Main nav links
        document
          .querySelectorAll(".nav-link[data-page]")
          .forEach(function (link) {
            var href = link.getAttribute("href");
            if (href === currentPage) {
              link.classList.add("active");
            }
          });

        // Sub-menu items
        document
          .querySelectorAll(".sub-menu-item[data-page]")
          .forEach(function (item) {
            var href = item.getAttribute("href");
            if (href === currentPage) {
              item.classList.add("active");
              var parentSubMenu = item.closest(".sub-menu");
              if (parentSubMenu) {
                parentSubMenu.classList.add("open");
                var parentNav = parentSubMenu.previousElementSibling;
                if (parentNav) parentNav.classList.add("expanded");
              }
            }
          });
      }

      // Also load policies when the Policies tab is clicked
      document.addEventListener("click", function (e) {
        const tabBtn = e.target.closest('.tab-btn[onclick*="policies"]');
        if (tabBtn) {
          setTimeout(() => {
            const agentId = getAgentIdFromUrl();
            if (agentId) {
              loadAgentPolicies(agentId);
            }
          }, 100);
        }
      });

      // Close dropdowns on outside click
      document.addEventListener("click", function (e) {
        var userProfile = document.querySelector(".user-profile");
        var notificationBtn = document.querySelector(".notification-btn");
        var notificationPanel = document.getElementById("notificationsPanel");

        if (userProfile && !userProfile.contains(e.target)) closeUserDropdown();
        if (
          notificationBtn &&
          notificationPanel &&
          !notificationBtn.contains(e.target) &&
          !notificationPanel.contains(e.target)
        ) {
          closeNotifications();
        }
      });

      // Close on escape key
      document.addEventListener("keydown", function (e) {
        if (e.key === "Escape") {
          closeNotifications();
          closeUserDropdown();
          closeMobileSidebar();
        }
      });

      // Resize handler
      var resizeTimer;
      window.addEventListener("resize", function () {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(function () {
          if (window.innerWidth > 968) {
            closeMobileSidebar();
            // Restore header left based on sidebar state
            var sidebar = document.getElementById("sidebar");
            var header = document.getElementById("topHeader");
            if (sidebar && header) {
              header.style.left = sidebar.classList.contains("collapsed")
                ? "70px"
                : "240px";
            }
          }
        }, 150);
      });

      // Handle window resize for responsive behavior
      window.addEventListener("resize", function () {
        const sidebar = document.getElementById("sidebar");
        const headerContainer = document.getElementById("topHeader");
        const mainContent = document.getElementById("mainContent");

        if (window.innerWidth <= 968) {
          if (sidebar) sidebar.classList.remove("collapsed");
          if (mainContent) mainContent.classList.remove("expanded");
          if (headerContainer) {
            headerContainer.style.left = "0";
          }
        }
      });

      /* ==================== AGENT VIEW FUNCTIONS ==================== */

      function openTab(evt, tabName) {
        document
          .querySelectorAll(".tab-content")
          .forEach((t) => t.classList.remove("active"));
        document
          .querySelectorAll(".tab-btn")
          .forEach((b) => b.classList.remove("active"));
        document.getElementById(tabName).classList.add("active");
        evt.currentTarget.classList.add("active");

        const agentId = getAgentIdFromUrl();
        if (!agentId) return;
        loadAgentDetails(agentId);
        loadViolations(agentId);

        if (tabName === "urlHistory") {
          loadWebHistory(agentId);
        } else if (tabName === "appUsage") {
          loadAppUsage(agentId);
        } else if (tabName === "policies") {
          loadAgentPolicies(agentId);
        } else if (tabName === "partialAccess") {
          loadPartialAccessSites(agentId);
        } else if (tabName === "blockedUrls") {
          loadBlockedUrls(agentId); // âœ… Add this line
        }
      }

      function generateCert() {
        const agentId = getAgentIdFromUrl();
        if (!agentId) {
          alert("Could not determine agent ID");
          return;
        }

        // You can implement certificate generation logic here
        alert(`Generating certificate for agent ${agentId}...`);
        // Redirect to certificate page or open modal
        // window.location.href = `generate-certificate?agentId=${agentId}`;
      }

      function deleteAgent() {
        if (confirm("Delete agent?")) {
          alert("Deleted!");
          window.location.href = "manage-agents";
        }
      }
      function deletePolicy(btn) {
        if (confirm("Remove this policy from agent?"))
          btn.closest(".policy-card").remove();
      }

      window.addEventListener("load", () => {
        const urlParams = new URLSearchParams(window.location.search);
        const tabToOpen = urlParams.get("tab");
        const agentId = getAgentIdFromUrl();

        if (agentId) {
          // Load profile data immediately
          loadAgentDetails(agentId);
          loadViolations(agentId);
          loadWebHistory(agentId);
          loadAppUsage(agentId);
        }

        if (tabToOpen) {
          const tabBtn = document.querySelector(
            `button[onclick*="'${tabToOpen}'"]`,
          );
          if (tabBtn) {
            const mockEvent = { currentTarget: tabBtn };
            openTab(mockEvent, tabToOpen);
          }
        }
      });

      /* ---- Modal helpers ---- */
      function openModal(id) {
        document.getElementById(id).classList.add("show");
        document.body.style.overflow = "hidden";
      }
      function closeModal(id) {
        document.getElementById(id).classList.remove("show");
        document.body.style.overflow = "";
      }
      document.querySelectorAll(".modal-overlay").forEach(function (m) {
        m.addEventListener("click", function (e) {
          if (e.target === m) closeModal(m.id);
        });
      });

      /* ---- Blocked URL actions ---- */
      function openAddBurlModal() {
        document.getElementById("burl_pattern").value = "";
        document.getElementById("burl_reason").value = "";
        document.getElementById("burl_category").value = "";
        document.getElementById("burl_scope").selectedIndex = 0;
        document.getElementById("burl_active").checked = true;
        openModal("addBurlModal");
      }

      function saveBurl() {
        var pattern = document.getElementById("burl_pattern").value.trim();
        if (!pattern) {
          alert("URL Pattern is required");
          return;
        }
        var category =
          document.getElementById("burl_category").value || "Other";
        var scope = document.getElementById("burl_scope").value;
        var scopeClass = scope.includes("Global") ? "global" : "device";
        var scopeLabel = scope.includes("Global") ? "Global" : "Device: This";
        var tbody = document.getElementById("burlTbody");
        var row = document.createElement("tr");
        row.innerHTML =
          '<td><div class="burl-url-name">' +
          pattern +
          '</div><div class="burl-url-reason">' +
          document.getElementById("burl_reason").value +
          "</div></td>" +
          '<td class="burl-domain">' +
          pattern +
          "</td>" +
          '<td><span class="burl-tag entertainment">' +
          category +
          "</span></td>" +
          '<td><span class="burl-scope ' +
          scopeClass +
          '">' +
          scopeLabel +
          "</span></td>" +
          '<td><span class="burl-status active">Active</span></td>' +
          '<td class="burl-date">Just now</td>' +
          '<td><div class="burl-actions"><button class="burl-action-btn edit" title="Edit" onclick="openEditBurlModal(this)"><i class="fas fa-pen"></i></button><button class="burl-action-btn delete" title="Delete" onclick="deleteBurlRow(this)"><i class="fas fa-trash"></i></button></div></td>';
        tbody.appendChild(row);
        closeModal("addBurlModal");
      }

      function deleteBurlRow(btn) {
        if (confirm("Delete this blocked URL?")) btn.closest("tr").remove();
      }

      var _editBurlRow = null;
      function openEditBurlModal(btn) {
        _editBurlRow = btn.closest("tr");
        var cells = _editBurlRow.querySelectorAll("td");
        var urlName = cells[0].querySelector(".burl-url-name");
        var urlReason = cells[0].querySelector(".burl-url-reason");
        document.getElementById("edit_burl_pattern").value = urlName
          ? urlName.textContent.trim()
          : "";
        document.getElementById("edit_burl_reason").value = urlReason
          ? urlReason.textContent.trim()
          : "";
        var catTag = cells[2].querySelector(".burl-tag");
        var catText = catTag ? catTag.textContent.trim() : "";
        var catSel = document.getElementById("edit_burl_category");
        for (var i = 0; i < catSel.options.length; i++) {
          if (catSel.options[i].text.toLowerCase() === catText.toLowerCase()) {
            catSel.selectedIndex = i;
            break;
          }
        }
        var scopeEl = cells[3].querySelector(".burl-scope");
        var scopeText = scopeEl ? scopeEl.textContent.trim() : "";
        var scopeSel = document.getElementById("edit_burl_scope");
        scopeSel.selectedIndex = scopeText.toLowerCase().includes("global")
          ? 0
          : scopeText.toLowerCase().includes("user")
            ? 2
            : 1;
        var statusEl = cells[4].querySelector(".burl-status");
        document.getElementById("edit_burl_active").checked = statusEl
          ? statusEl.textContent.trim().toLowerCase() === "active"
          : true;
        openModal("editBurlModal");
      }

      function updateBurl() {
        var pattern = document.getElementById("edit_burl_pattern").value.trim();
        if (!pattern) {
          alert("URL Pattern is required");
          return;
        }
        if (!_editBurlRow) return;
        var cells = _editBurlRow.querySelectorAll("td");
        var category =
          document.getElementById("edit_burl_category").value || "Other";
        var scopeVal = document.getElementById("edit_burl_scope").value;
        var scopeClass = scopeVal.includes("Global")
          ? "global"
          : scopeVal.includes("User")
            ? "user"
            : "device";
        var scopeLabel = scopeVal.includes("Global")
          ? "Global"
          : scopeVal.includes("User")
            ? "User"
            : "Device: This";
        var isActive = document.getElementById("edit_burl_active").checked;
        cells[0].querySelector(".burl-url-name").textContent = pattern;
        cells[0].querySelector(".burl-url-reason").textContent =
          document.getElementById("edit_burl_reason").value;
        cells[1].textContent = pattern;
        cells[2].innerHTML =
          '<span class="burl-tag entertainment">' + category + "</span>";
        cells[3].innerHTML =
          '<span class="burl-scope ' +
          scopeClass +
          '">' +
          scopeLabel +
          "</span>";
        cells[4].innerHTML =
          '<span class="burl-status ' +
          (isActive ? "active" : "inactive") +
          '">' +
          (isActive ? "Active" : "Inactive") +
          "</span>";
        closeModal("editBurlModal");
      }

      function deletePaRow(btn) {
        if (confirm("Delete this partial access site?"))
          btn.closest("tr").remove();
      }

      function updatePa() {
        if (!window._editPaRow) return;

        var pattern = document.getElementById("edit_pa_pattern").value.trim();
        if (!pattern) {
          alert("URL Pattern is required");
          return;
        }

        const fileTypesInput = document
          .getElementById("edit_pa_filetypes")
          .value.trim();
        const restrictedFileTypes = fileTypesInput
          ? fileTypesInput
              .split(",")
              .map((s) => s.trim())
              .filter((s) => s.length > 0)
          : [];

        const scope = document.getElementById("edit_pa_scope").value;
        const isGlobal = scope === "global";
        const agentId = getAgentIdFromUrl();
        const siteId = window._editPaRow.dataset.siteId;

        var siteData = {
          urlPattern: pattern,
          domain: pattern,
          reason: document.getElementById("edit_pa_reason").value,
          category:
            document.getElementById("edit_pa_category").value || "Other",
          active: document.getElementById("edit_pa_active").checked,
          global: isGlobal,
          allowUpload: document.getElementById("edit_pa_upload").checked,
          allowDownload: document.getElementById("edit_pa_download").checked,
          monitorMode: document.getElementById("edit_pa_monitor").value,
          restrictedFileTypes: restrictedFileTypes,
        };

        const updateBtn = document.querySelector(
          "#editPaModal .modal-btn-save",
        );
        const originalText = updateBtn.innerHTML;
        updateBtn.innerHTML =
          '<i class="fas fa-spinner fa-spin"></i> Updating...';
        updateBtn.disabled = true;

        fetch(`/api/admin/partial-access/${siteId}`, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
          },
          credentials: "include",
          body: JSON.stringify(siteData),
        })
          .then((response) => response.json())
          .then((result) => {
            if (result.success) {
              showNotification("Site updated successfully", "success");
              closeModal("editPaModal");
              return updateAgentPolicy(agentId);
            } else {
              throw new Error(result.message || "Update failed");
            }
          })
          .then(() => {
            loadPartialAccessSites(agentId);
          })
          .catch((error) => {
            console.error("Error updating site:", error);
            showNotification("Error updating site: " + error.message, "error");
          })
          .finally(() => {
            updateBtn.innerHTML = originalText;
            updateBtn.disabled = false;
            window._editPaRow = null;
          });
      }

      /* ---- Filter helpers ---- */
      function filterBurlTable() {
    const searchTerm = document.getElementById("burlSearch")?.value.toLowerCase() || "";
    const categoryFilter = document.getElementById("burlCategoryFilter")?.value.toLowerCase() || "";
    
    const rows = document.querySelectorAll("#burlTbody tr");
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        const category = row.querySelector(".burl-tag")?.textContent.toLowerCase() || "";
        
        const matchesSearch = text.includes(searchTerm);
        const matchesCategory = !categoryFilter || category.includes(categoryFilter);
        
        row.style.display = matchesSearch && matchesCategory ? "" : "none";
    });
}


      function filterPaTable() {
        var q = document.getElementById("paSearch").value.toLowerCase();
        var st = document.getElementById("paStatusFilter").value.toLowerCase();
        var sc = document.getElementById("paScopeFilter").value.toLowerCase();

        document.querySelectorAll("#paTbody tr").forEach(function (r) {
          var txt = r.textContent.toLowerCase();
          r.style.display =
            txt.includes(q) &&
            (!st || txt.includes(st)) &&
            (!sc || txt.includes(sc))
              ? ""
              : "none";
        });
      }

      // Initialize on DOM ready
      document.addEventListener("DOMContentLoaded", function () {
        setActiveMenuItem();
        <!--            loadAdminInfo();-->

        setTimeout(() => {
          const agentId = getAgentIdFromUrl();
          if (agentId) {
            loadAgentPolicies(agentId);
          } else {
            console.warn("Could not determine agent ID for loading policies");
          }
        }, 500); // Small delay to ensure DOM is ready
      });
    </script>
  </body>
</html>
