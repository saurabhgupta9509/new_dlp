<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" >
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent Details - DLP Shield</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f3f4f6; overflow-x: hidden; }
        .dashboard-container { display: flex; min-height: 100vh; }
        
        /* ================ SIDEBAR STYLES ================ */
        .sidebar {
            width: 240px;
            background: linear-gradient(180deg, #1e40af 0%, #1e3a8a 100%);
            color: white;
            position: fixed;
            height: 100vh;
            display: flex;
            flex-direction: column;
            transition: width 0.3s ease;
            z-index: 1000;
            left: 0;
            top: 0;
            overflow: hidden;
        }

        .sidebar::-webkit-scrollbar { width: 4px; }
        .sidebar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.3); border-radius: 4px; }

        .sidebar-header {
            padding: 18px 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            flex-shrink: 0;
        }

        .sidebar-logo {
            width: 38px;
            height: 38px;
            background: white;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .sidebar-logo i { font-size: 20px; color: #2563eb; }

        .sidebar-title {
            font-size: 1.2em;
            font-weight: 700;
            white-space: nowrap;
            transition: opacity 0.2s, width 0.3s;
            overflow: hidden;
        }

        .nav-menu {
            padding: 12px 0;
            overflow-y: auto;
            overflow-x: hidden;
            flex: 1;
        }

        .nav-item { margin: 2px 8px; }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 10px 12px;
            color: rgba(255,255,255,0.8);
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.2s;
            font-size: 0.9em;
            cursor: pointer;
            white-space: nowrap;
        }

        .nav-link:hover { background: rgba(255,255,255,0.1); color: white; }

        .nav-link.active,
        .sub-menu-item.active {
            background: rgba(255,255,255,0.15);
            color: white;
            font-weight: 600;
        }

        .nav-link i:first-child {
            width: 20px;
            font-size: 0.95em;
            margin-right: 10px;
            flex-shrink: 0;
        }

        .chevron-icon {
            margin-left: auto !important;
            font-size: 0.7em !important;
            transition: transform 0.3s;
            width: auto !important;
            flex-shrink: 0;
        }

        .nav-link.expanded .chevron-icon { transform: rotate(180deg); }

        .sub-menu {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .sub-menu.open { max-height: 500px; }

        .sub-menu-item {
            display: flex;
            align-items: center;
            padding: 8px 12px 8px 42px;
            color: rgba(255,255,255,0.7);
            text-decoration: none;
            font-size: 0.85em;
            transition: all 0.2s;
            border-radius: 8px;
            margin: 2px 0;
            white-space: nowrap;
        }

        .sub-menu-item:hover { color: white; background: rgba(255,255,255,0.08); }
        .sub-menu-item::before { content: 'â€¢'; margin-right: 10px; font-size: 1.2em; }

        .sidebar-footer {
            padding: 12px 16px;
            border-top: 1px solid rgba(255,255,255,0.1);
            flex-shrink: 0;
        }

        .collapse-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px;
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            font-size: 0.85em;
            transition: all 0.2s;
            white-space: nowrap;
            overflow: hidden;
        }

        .collapse-btn:hover { background: rgba(255,255,255,0.15); }
        .collapse-btn i { transition: transform 0.3s; flex-shrink: 0; }

        /* Sidebar collapsed state */
        .sidebar.collapsed { width: 70px; }
        .sidebar.collapsed .sidebar-title { opacity: 0; width: 0; }
        .sidebar.collapsed .nav-link span,
        .sidebar.collapsed .collapse-btn span { display: none; }
        .sidebar.collapsed .sub-menu { display: none !important; }
        .sidebar.collapsed .nav-link { justify-content: center; padding: 10px; }
        .sidebar.collapsed .nav-link i:first-child { margin-right: 0; }
        .sidebar.collapsed .chevron-icon { display: none; }
        .sidebar.collapsed .collapse-btn { justify-content: center; }
        .sidebar.collapsed .collapse-btn i { transform: rotate(180deg); }

        /* Mobile Overlay */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .sidebar-overlay.active { display: block; opacity: 1; }

        /* ================ HEADER STYLES ================ */
        .top-header {
            background: white;
            padding: 14px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #e5e7eb;
            position: fixed;
            top: 0;
            left: 240px;
            right: 0;
            z-index: 500;
            gap: 16px;
            transition: left 0.3s ease;
        }

        .mobile-menu-toggle {
            display: none;
            background: none;
            border: none;
            color: #6b7280;
            font-size: 1.3em;
            cursor: pointer;
            padding: 8px;
            transition: color 0.2s;
        }

        .mobile-menu-toggle:hover { color: #111827; }

        .search-bar { flex: 1; max-width: 400px; position: relative; }

        .search-bar i {
            position: absolute;
            left: 14px; top: 50%;
            transform: translateY(-50%);
            color: #9ca3af;
            font-size: 0.9em;
        }

        .search-input {
            width: 100%;
            padding: 9px 14px 9px 38px;
            border: 1.5px solid #e5e7eb;
            border-radius: 8px;
            font-size: 0.9em;
            background: #f9fafb;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: #3b82f6;
            background: white;
            box-shadow: 0 0 0 3px rgba(59,130,246,0.1);
        }

        .header-actions { display: flex; align-items: center; gap: 16px; }

        .notification-btn {
            position: relative;
            background: none;
            border: none;
            color: #6b7280;
            font-size: 1.1em;
            cursor: pointer;
            padding: 8px;
            transition: all 0.2s;
            border-radius: 8px;
        }

        .notification-btn:hover { color: #111827; background: #f3f4f6; }
        .notification-btn.active { color: #2563eb; background: #eff6ff; }

        .notification-badge {
            position: absolute;
            top: 4px; right: 4px;
            background: #ef4444;
            color: white;
            font-size: 0.65em;
            min-width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            padding: 0 4px;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            padding: 6px 10px;
            border-radius: 8px;
            transition: background 0.2s;
            position: relative;
        }

        .user-profile:hover { background: #f3f4f6; }

        .user-avatar {
            width: 36px; height: 36px;
            background: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.9em;
            flex-shrink: 0;
        }

        .user-info { display: flex; flex-direction: column; }
        .user-name { font-size: 0.9em; font-weight: 600; color: #111827; }
        .user-role { font-size: 0.75em; color: #6b7280; }

        .dropdown-icon {
            color: #6b7280;
            font-size: 0.75em;
            margin-left: 4px;
            transition: transform 0.3s;
        }

        .user-profile.active .dropdown-icon { transform: rotate(180deg); }

        .user-dropdown {
            position: absolute;
            top: 100%; right: 0;
            margin-top: 8px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.07), 0 10px 15px rgba(0,0,0,0.1);
            min-width: 200px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .user-dropdown.show { opacity: 1; visibility: visible; transform: translateY(0); }

        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 14px;
            color: #374151;
            text-decoration: none;
            font-size: 0.9em;
            transition: background 0.2s;
        }

        .dropdown-item:first-child { border-radius: 8px 8px 0 0; }
        .dropdown-item:last-child { border-radius: 0 0 8px 8px; }
        .dropdown-item:hover { background: #f3f4f6; }
        .dropdown-item i { width: 18px; color: #6b7280; font-size: 0.95em; }
        .dropdown-item.danger { color: #dc2626; }
        .dropdown-item.danger i { color: #dc2626; }
        .dropdown-divider { height: 1px; background: #e5e7eb; margin: 4px 0; }

        /* ================ NOTIFICATIONS PANEL ================ */
        .notifications-panel {
            position: fixed;
            top: 0; right: -50%;
            width: 50%;
            max-width: 600px;
            height: 100vh;
            background: white;
            box-shadow: -4px 0 15px rgba(0,0,0,0.1);
            z-index: 1001;
            display: flex;
            flex-direction: column;
            transition: right 0.4s cubic-bezier(0.4,0,0.2,1);
        }

        .notifications-panel.show { right: 0; }

        .notifications-header {
            padding: 20px 24px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .notifications-header h3 { font-size: 1.2em; font-weight: 700; color: #111827; }

        .close-notifications {
            background: none; border: none;
            color: #6b7280; font-size: 1.2em;
            cursor: pointer; padding: 6px;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .close-notifications:hover { background: #f3f4f6; color: #111827; }

        .notifications-tabs {
            display: flex;
            border-bottom: 1px solid #e5e7eb;
            padding: 0 24px;
            flex-shrink: 0;
        }

        .tab-btn {
            flex: 1; padding: 12px;
            background: none; border: none;
            color: #6b7280; font-size: 0.9em;
            font-weight: 500; cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .tab-btn:hover { color: #111827; }
        .tab-btn.active { color: #2563eb; border-bottom-color: #2563eb; }

        .notifications-content { flex: 1; overflow-y: auto; padding: 12px 0; }
        .notifications-content::-webkit-scrollbar { width: 6px; }
        .notifications-content::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 3px; }

        .notification-item {
            display: flex;
            gap: 12px;
            padding: 14px 24px;
            cursor: pointer;
            transition: background 0.2s;
            border-left: 3px solid transparent;
        }

        .notification-item:hover { background: #f9fafb; }
        .notification-item.unread { background: #eff6ff; border-left-color: #3b82f6; }
        .notification-item.unread:hover { background: #dbeafe; }

        .notification-icon {
            width: 40px; height: 40px;
            border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.1em; flex-shrink: 0;
        }

        .notification-icon.critical { background: #fee2e2; color: #dc2626; }
        .notification-icon.warning  { background: #fef3c7; color: #f59e0b; }
        .notification-icon.info     { background: #dbeafe; color: #3b82f6; }
        .notification-icon.success  { background: #d1fae5; color: #10b981; }

        .notification-body { flex: 1; }
        .notification-title { font-size: 0.9em; font-weight: 600; color: #111827; margin-bottom: 4px; }
        .notification-text  { font-size: 0.85em; color: #6b7280; margin-bottom: 6px; line-height: 1.4; }
        .notification-time  { font-size: 0.75em; color: #9ca3af; }

        .notification-dot {
            width: 8px; height: 8px;
            background: #3b82f6;
            border-radius: 50%;
            flex-shrink: 0;
            margin-top: 8px;
        }

        .notification-item:not(.unread) .notification-dot { display: none; }

        .notifications-footer { padding: 16px 24px; border-top: 1px solid #e5e7eb; flex-shrink: 0; }

        .view-all-btn {
            display: block; width: 100%; padding: 10px;
            background: #f3f4f6; color: #2563eb;
            text-align: center; text-decoration: none;
            border-radius: 8px; font-size: 0.9em;
            font-weight: 600; transition: all 0.2s;
        }

        .view-all-btn:hover { background: #e5e7eb; }

        .notification-overlay {
            position: fixed; top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.4);
            z-index: 1000;
            opacity: 0; visibility: hidden;
            transition: all 0.3s ease;
        }

        .notification-overlay.show { opacity: 1; visibility: visible; }

        /* Main Content Area */
        .main-content {
            flex: 1;
            margin-left: 240px;
            transition: margin-left 0.3s ease;
            min-height: 100vh;
            padding-top: 70px;
        }

        .main-content.expanded {
            margin-left: 70px;
        }

        .content-area {
            padding: 24px;
        }

        /* Back Button */
        .back-button-container { margin-bottom: 20px; }
        .back-button { display: inline-flex; align-items: center; gap: 8px; padding: 10px 16px; background: white; border: 1px solid #e5e7eb; border-radius: 8px; color: #374151; font-size: 0.9em; font-weight: 500; text-decoration: none; transition: all 0.2s; }
        .back-button:hover { background: #f9fafb; border-color: #d1d5db; color: #111827; }
        .back-button i { font-size: 0.9em; }
        
        /* Agent Profile Card */
        .agent-profile-card { background: white; border-radius: 12px; border: 1px solid #e5e7eb; padding: 24px; margin-bottom: 24px; }
        .profile-header { display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 20px; margin-bottom: 24px; }
        .profile-info { display: flex; align-items: center; gap: 16px; }
        .profile-avatar { width: 64px; height: 64px; border-radius: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: 700; }
        .profile-details h1 { font-size: 1.5em; color: #111827; margin-bottom: 6px; }
        .profile-meta { display: flex; gap: 16px; flex-wrap: wrap; font-size: 0.9em; color: #6b7280; }
        .profile-meta-item { display: flex; align-items: center; gap: 6px; }
        .profile-actions { display: flex; gap: 10px; }
        .btn { padding: 10px 18px; border: none; border-radius: 8px; font-size: 0.9em; font-weight: 500; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background: #2563eb; color: white; }
        .btn-primary:hover { background: #1d4ed8; }
        .btn-secondary { background: #f3f4f6; color: #374151; }
        .btn-secondary:hover { background: #e5e7eb; }
        .btn-danger { background: #dc2626; color: white; }
        .btn-danger:hover { background: #b91c1c; }
        
        /* Stats Grid */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; }
        .stat-box { background: #f9fafb; padding: 14px; border-radius: 8px; border: 1px solid #e5e7eb; }
        .stat-label { font-size: 0.75em; color: #6b7280; margin-bottom: 6px; text-transform: uppercase; }
        .stat-value { font-size: 1.4em; font-weight: 700; color: #111827; }
        
        /* Tabs */
        .tabs-container { background: white; border-radius: 12px; border: 1px solid #e5e7eb; overflow: hidden; }
        .tabs-nav { display: flex; border-bottom: 1px solid #e5e7eb; overflow-x: auto; background: #f9fafb; }
        .tab-btn { padding: 14px 20px; background: none; border: none; font-size: 0.9em; font-weight: 500; color: #6b7280; cursor: pointer; transition: all 0.2s; border-bottom: 2px solid transparent; white-space: nowrap; }
        .tab-btn:hover { color: #111827; background: #f3f4f6; }
        .tab-btn.active { color: #2563eb; border-bottom-color: #2563eb; background: white; }
        .tab-content { display: none; padding: 24px; }
        .tab-content.active { display: block; }
        
        /* Overview Tab */
        .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .info-card { background: #f9fafb; padding: 18px; border-radius: 10px; border: 1px solid #e5e7eb; }
        .info-card h3 { font-size: 0.95em; color: #111827; font-weight: 600; margin-bottom: 14px; display: flex; align-items: center; gap: 8px; }
        .info-card h3 i { color: #2563eb; }
        .info-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #e5e7eb; }
        .info-row:last-child { border-bottom: none; }
        .info-label { font-size: 0.85em; color: #6b7280; }
        .info-value { font-size: 0.85em; color: #111827; font-weight: 500; }
        
        /* URL History Tab */
        .url-filters { display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; }
        .filter-input { flex: 1; min-width: 200px; padding: 10px 14px; border: 1.5px solid #e5e7eb; border-radius: 8px; font-size: 0.9em; }
        .filter-input:focus { outline: none; border-color: #2563eb; }
        .url-table { width: 100%; border-collapse: collapse; }
        .url-table thead { background: #f9fafb; }
        .url-table th { padding: 12px; text-align: left; font-size: 0.8em; font-weight: 600; color: #6b7280; text-transform: uppercase; border-bottom: 1px solid #e5e7eb; }
        .url-table td { padding: 12px; font-size: 0.9em; border-bottom: 1px solid #f3f4f6; }
        .url-table tr:hover { background: #f9fafb; }
        .url-link { color: #2563eb; text-decoration: none; }
        .url-link:hover { text-decoration: underline; }
        .category-tag { padding: 4px 10px; border-radius: 6px; font-size: 0.8em; font-weight: 500; }
        .category-tag.work { background: #dbeafe; color: #1e40af; }
        .category-tag.social { background: #fef3c7; color: #92400e; }
        .category-tag.blocked { background: #fee2e2; color: #991b1b; }
        .status-badge { display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; border-radius: 6px; font-size: 0.85em; font-weight: 500; }
        .status-badge.online { background: #d1fae5; color: #065f46; }
        .status-badge.online::before { content: ''; width: 6px; height: 6px; border-radius: 50%; background: #10b981; }
        .status-badge.offline { background: #f3f4f6; color: #6b7280; }
        
        /* App Usage Tab */
        .charts-row { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px; }
        .chart-box { 
            background: white; 
            padding: 20px 24px; 
            border-radius: 12px; 
            border: 1px solid #e5e7eb; 
            box-shadow: 0 1px 2px rgba(0,0,0,0.03);
        }
        .chart-box h3 { 
            margin-bottom: 24px; 
            font-size: 0.95em; 
            color: #111827; 
            font-weight: 600;
        }
        
        /* Pie Chart with Side Legend Layout */
        .pie-chart-layout { display: flex; align-items: center; gap: 32px; justify-content: center; }
        .circular-chart-container { position: relative; width: 180px; height: 180px; flex-shrink: 0; }
        .circular-chart-center { 
            position: absolute; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%); 
            text-align: center; 
            z-index: 10; 
        }
        .circular-chart-value { font-size: 2.2em; font-weight: 700; color: #111827; line-height: 1; }
        .circular-chart-label { font-size: 0.7em; color: #9ca3af; margin-top: 2px; }
        
        .chart-legend { display: flex; flex-direction: column; gap: 10px; flex: 1; max-width: 180px; }
        .legend-item { display: flex; align-items: center; gap: 10px; }
        .legend-color { 
            width: 32px; 
            height: 32px; 
            border-radius: 8px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            flex-shrink: 0; 
        }
        .legend-color i { font-size: 0.85em; color: white; }
        .legend-details { flex: 1; }
        .legend-label { 
            color: #6b7280; 
            font-size: 0.8em; 
            display: block; 
            margin-bottom: 2px;
            font-weight: 400;
        }
        .legend-value { 
            font-weight: 600; 
            color: #111827; 
            font-size: 0.95em; 
        }
        
        .app-list { display: grid; gap: 12px; }
        .app-item { display: flex; justify-content: space-between; align-items: center; padding: 14px; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb; }
        .app-info { display: flex; gap: 12px; align-items: center; }
        .app-icon { width: 40px; height: 40px; background: white; border-radius: 8px; display: flex; align-items: center; justify-content: center; border: 1px solid #e5e7eb; }
        .app-details h4 { font-size: 0.95em; color: #111827; margin-bottom: 2px; }
        .app-details p { font-size: 0.8em; color: #6b7280; }
        .app-time { font-size: 1.1em; font-weight: 700; color: #2563eb; }
        
        /* Certificate Tab */
        .certificate-container { max-width: 1100px; margin: 0 auto; }
        .certificate-layout { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
        
        .certificate-card { 
            background: white; 
            padding: 32px; 
            border-radius: 16px; 
            border: 1px solid #e5e7eb;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .cert-header { 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            margin-bottom: 30px;
        }
        .cert-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
        }
        .cert-title { font-size: 1.3em; margin: 0; font-weight: 600; color: #111827; }
        
        .cert-score-circle { 
            width: 180px; 
            height: 180px; 
            border-radius: 50%; 
            background: white; 
            margin: 20px auto 24px; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center;
            position: relative;
        }
        .cert-score-circle::before {
            content: '';
            position: absolute;
            inset: -6px;
            border-radius: 50%;
            padding: 6px;
            background: conic-gradient(from 0deg, #fbbf24 0%, #06b6d4 25%, #3b82f6 50%, #8b5cf6 75%, #ec4899 90%, #fbbf24 100%);
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
        }
        .cert-score { font-size: 3.5em; font-weight: 700; color: #111827; line-height: 1; }
        .cert-max { font-size: 1.2em; color: #6b7280; margin-top: 2px; }
        
        .cert-grade { 
            text-align: center; 
            font-size: 1em; 
            font-weight: 600;
            padding: 10px 24px;
            background: #eff6ff;
            color: #1e40af;
            border-radius: 24px;
            display: inline-block;
            margin: 0 auto 28px;
            border: 1px solid #dbeafe;
        }
        
        .cert-metrics { 
            display: grid; 
            grid-template-columns: repeat(2, 1fr); 
            gap: 14px;
        }
        .cert-metric { 
            background: #f9fafb; 
            padding: 18px; 
            border-radius: 12px;
            border: 1px solid #e5e7eb;
        }
        .cert-metric-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }
        .cert-metric-icon {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1em;
        }
        .cert-metric-label { 
            font-size: 0.8em; 
            color: #6b7280;
            text-transform: capitalize;
            font-weight: 500;
        }
        .cert-metric-value { 
            font-size: 2em; 
            font-weight: 700;
            color: #111827;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .cert-metric-trend {
            font-size: 0.5em;
            color: #10b981;
        }
        .cert-metric.compliance .cert-metric-value {
            color: #10b981;
        }
        
        .ai-analysis { 
            background: white; 
            padding: 32px; 
            border-radius: 16px; 
            border: 1px solid #e5e7eb;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .ai-analysis-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 24px;
        }
        .ai-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2em;
        }
        .ai-analysis h3 { 
            color: #111827; 
            margin: 0;
            font-size: 1.2em;
            font-weight: 600;
        }
        
        .analysis-section {
            margin-bottom: 24px;
        }
        .analysis-section:last-child {
            margin-bottom: 0;
        }
        
        .section-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }
        .section-icon {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9em;
        }
        .section-icon.positive { background: #d1fae5; color: #065f46; }
        .section-icon.warning { background: #fef3c7; color: #92400e; }
        .section-icon.info { background: #dbeafe; color: #1e40af; }
        
        .ai-analysis h4 { 
            color: #374151; 
            margin: 0;
            font-size: 1em;
            font-weight: 600;
        }
        .ai-analysis ul { 
            margin: 0;
            padding-left: 20px;
            color: #6b7280; 
        }
        .ai-analysis li { 
            margin-bottom: 8px; 
            font-size: 0.9em;
            line-height: 1.5;
        }
        
        /* Policy Cards */
        .policy-list { display: grid; gap: 16px; }
        .policy-card { background: #f9fafb; padding: 18px; border-radius: 10px; border: 1px solid #e5e7eb; }
        .policy-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .policy-title { font-size: 1em; color: #111827; font-weight: 600; }
        .policy-status { padding: 4px 10px; border-radius: 6px; font-size: 0.8em; font-weight: 500; }
        .policy-status.active { background: #d1fae5; color: #065f46; }
        .policy-desc { font-size: 0.85em; color: #6b7280; margin-bottom: 12px; }
        .policy-rules { display: flex; gap: 8px; flex-wrap: wrap; }
        .rule-tag { padding: 4px 10px; background: white; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 0.8em; color: #374151; }
        
        /* Activity Timeline */
        .activity-timeline { position: relative; padding-left: 30px; }
        .activity-timeline::before { content: ''; position: absolute; left: 8px; top: 0; bottom: 0; width: 2px; background: #e5e7eb; }
        .activity-item { position: relative; margin-bottom: 20px; }
        .activity-item::before { content: ''; position: absolute; left: -25px; top: 6px; width: 10px; height: 10px; border-radius: 50%; background: #3b82f6; border: 2px solid white; }
        .activity-time { font-size: 0.8em; color: #9ca3af; margin-bottom: 4px; }
        .activity-content { background: #f9fafb; padding: 12px; border-radius: 8px; border: 1px solid #e5e7eb; }
        .activity-content h4 { font-size: 0.9em; color: #111827; margin-bottom: 4px; }
        .activity-content p { font-size: 0.85em; color: #6b7280; }
        
        .policy-delete-btn { background:#fee2e2; border:none; color:#b91c1c; width:32px; height:32px; border-radius:8px; cursor:pointer; transition:all 0.2s; }
        .policy-delete-btn:hover { background:#dc2626; color:white; }

        /* BLOCKED URLs / PARTIAL ACCESS */
        .burl-stats-row { display:flex; gap:20px; margin-bottom:24px; flex-wrap:wrap; }
        .burl-stat-card { background:white; border:1px solid #e5e7eb; border-radius:12px; padding:20px 24px; display:flex; align-items:center; gap:16px; flex:1; min-width:180px; box-shadow:0 1px 2px rgba(0,0,0,0.04); }
        .burl-stat-icon { width:52px; height:52px; background:#eff6ff; border-radius:12px; display:flex; align-items:center; justify-content:center; color:#2563eb; font-size:1.4em; flex-shrink:0; }
        .burl-stat-icon.pa-icon { background:#ecfdf5; color:#059669; }
        .burl-stat-label { font-size:0.78em; color:#6b7280; margin-bottom:4px; text-transform:uppercase; letter-spacing:0.4px; }
        .burl-stat-value { font-size:1.8em; font-weight:700; color:#111827; line-height:1; }
        .burl-stat-sub { font-size:0.78em; color:#9ca3af; margin-top:4px; }
        .burl-toolbar { display:flex; align-items:center; gap:10px; margin-bottom:18px; flex-wrap:wrap; }
        .burl-search-wrap { position:relative; flex:1; min-width:180px; }
        .burl-search { width:100%; padding:9px 14px 9px 36px; border:1.5px solid #e5e7eb; border-radius:8px; font-size:0.88em; background:#f9fafb; transition:all 0.2s; }
        .burl-search:focus { outline:none; border-color:#2563eb; background:white; }
        .burl-search-icon { position:absolute; left:12px; top:50%; transform:translateY(-50%); color:#9ca3af; font-size:0.85em; pointer-events:none; }
        .burl-select { padding:9px 12px; border:1.5px solid #e5e7eb; border-radius:8px; font-size:0.88em; color:#374151; background:white; cursor:pointer; min-width:130px; }
        .burl-select:focus { outline:none; border-color:#2563eb; }
        .burl-btn-refresh { width:38px; height:38px; border:1.5px solid #e5e7eb; border-radius:8px; background:white; color:#6b7280; cursor:pointer; display:flex; align-items:center; justify-content:center; transition:all 0.2s; flex-shrink:0; }
        .burl-btn-refresh:hover { background:#f3f4f6; color:#111827; }
        .burl-table-wrap { background:white; border:1px solid #e5e7eb; border-radius:12px; overflow:hidden; margin-bottom:24px; }
        .burl-table { width:100%; border-collapse:collapse; }
        .burl-table thead { background:#f9fafb; }
        .burl-table th { padding:11px 14px; text-align:left; font-size:0.78em; font-weight:600; color:#6b7280; text-transform:uppercase; letter-spacing:0.4px; border-bottom:1px solid #e5e7eb; white-space:nowrap; }
        .burl-table td { padding:13px 14px; font-size:0.88em; border-bottom:1px solid #f3f4f6; vertical-align:middle; }
        .burl-table tbody tr:last-child td { border-bottom:none; }
        .burl-table tbody tr:hover { background:#f9fafb; }
        .burl-url-name { font-weight:600; color:#111827; font-size:0.92em; }
        .burl-url-reason { font-size:0.78em; color:#9ca3af; margin-top:2px; }
        .burl-domain { color:#6b7280; font-size:0.85em; }
        .burl-date { color:#9ca3af; font-size:0.82em; white-space:nowrap; }
        .burl-tag { display:inline-block; padding:3px 10px; border-radius:5px; font-size:0.78em; font-weight:500; }
        .burl-tag.entertainment { background:#dbeafe; color:#1e40af; }
        .burl-tag.social { background:#fef3c7; color:#92400e; }
        .burl-tag.work { background:#d1fae5; color:#065f46; }
        .burl-tag.monitor { background:#e0f2fe; color:#0369a1; }
        .burl-scope { display:inline-block; padding:3px 10px; border-radius:5px; font-size:0.78em; font-weight:500; }
        .burl-scope.global { background:#d1fae5; color:#065f46; }
        .burl-scope.device { background:#fef3c7; color:#92400e; }
        .burl-status { display:inline-block; padding:3px 10px; border-radius:5px; font-size:0.78em; font-weight:500; }
        .burl-status.active { background:#d1fae5; color:#065f46; }
        .burl-actions { display:flex; gap:6px; }
        .burl-action-btn { width:30px; height:30px; border:1px solid #e5e7eb; border-radius:6px; background:white; cursor:pointer; display:flex; align-items:center; justify-content:center; font-size:0.75em; transition:all 0.2s; }
        .burl-action-btn.edit { color:#2563eb; }
        .burl-action-btn.edit:hover { background:#dbeafe; border-color:#93c5fd; }
        .burl-action-btn.delete { color:#6b7280; }
        .burl-action-btn.delete:hover { background:#f3f4f6; }
        .mburl-section { background:white; border:1px solid #e5e7eb; border-radius:12px; padding:20px 24px; }
        .mburl-title { font-size:0.95em; font-weight:600; color:#111827; margin-bottom:16px; display:flex; align-items:center; gap:8px; }
        .mburl-title i { color:#ef4444; }
        .mburl-item { display:flex; align-items:center; gap:14px; padding:12px 0; border-bottom:1px solid #f3f4f6; }
        .mburl-item:last-child { border-bottom:none; }
        .mburl-rank { width:32px; height:32px; background:#f3f4f6; border-radius:6px; display:flex; align-items:center; justify-content:center; font-size:0.78em; font-weight:700; color:#6b7280; flex-shrink:0; }
        .mburl-info { flex:1; }
        .mburl-name { font-size:0.9em; font-weight:600; color:#111827; }
        .mburl-domain { font-size:0.78em; color:#9ca3af; }
        .mburl-count-wrap { text-align:right; }
        .mburl-count { font-size:1.3em; font-weight:700; color:#ef4444; line-height:1; }
        .mburl-count-label { font-size:0.72em; color:#9ca3af; }
        
        /* MODALS */
        .modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:2000; display:flex; align-items:center; justify-content:center; opacity:0; visibility:hidden; transition:all 0.25s; }
        .modal-overlay.show { opacity:1; visibility:visible; }
        .modal-box { background:white; border-radius:12px; width:90%; max-width:520px; box-shadow:0 20px 50px rgba(0,0,0,0.2); transform:translateY(-20px); transition:transform 0.25s; }
        .modal-overlay.show .modal-box { transform:translateY(0); }
        .modal-header { padding:18px 24px; background:#2563eb; border-radius:12px 12px 0 0; display:flex; align-items:center; justify-content:space-between; }
        .modal-header h3 { color:white; font-size:1.05em; font-weight:600; margin:0; }
        .modal-close { background:none; border:none; color:rgba(255,255,255,0.8); font-size:1.2em; cursor:pointer; padding:4px; border-radius:4px; transition:color 0.2s; }
        .modal-close:hover { color:white; }
        .modal-body { padding:24px; }
        .modal-field { margin-bottom:18px; }
        .modal-field label { display:block; font-size:0.85em; font-weight:600; color:#374151; margin-bottom:6px; }
        .modal-field input,.modal-field textarea,.modal-field select { width:100%; padding:9px 12px; border:1.5px solid #e5e7eb; border-radius:8px; font-size:0.9em; font-family:inherit; transition:border-color 0.2s; background:white; }
        .modal-field input:focus,.modal-field textarea:focus,.modal-field select:focus { outline:none; border-color:#2563eb; }
        .modal-field textarea { resize:vertical; min-height:80px; }
        .modal-field .hint { font-size:0.75em; color:#9ca3af; margin-top:4px; }
        .modal-row { display:grid; grid-template-columns:1fr 1fr; gap:14px; }
        .modal-check { display:flex; align-items:center; gap:8px; font-size:0.88em; color:#374151; cursor:pointer; margin-bottom:10px; }
        .modal-check input[type=checkbox] { width:16px; height:16px; accent-color:#2563eb; cursor:pointer; }
        .modal-footer { padding:16px 24px; border-top:1px solid #e5e7eb; display:flex; justify-content:flex-end; gap:10px; }
        .modal-btn-cancel { padding:9px 20px; border:1px solid #e5e7eb; border-radius:8px; background:white; color:#374151; font-size:0.88em; font-weight:500; cursor:pointer; transition:all 0.2s; }
        .modal-btn-cancel:hover { background:#f3f4f6; }
        .modal-btn-save { padding:9px 20px; border:none; border-radius:8px; background:#2563eb; color:white; font-size:0.88em; font-weight:500; cursor:pointer; transition:all 0.2s; }
        .modal-btn-save:hover { background:#1d4ed8; }
        .modal-btn-save.green { background:#059669; }
        .modal-btn-save.green:hover { background:#047857; }
        
        @media (max-width: 968px) {
            .main-content { margin-left: 0; width: 100%; }
            .top-header { left: 0 !important; }
            .mobile-menu-toggle { display: block; }
            .sidebar { transform: translateX(-100%); width: 260px; transition: transform 0.3s ease; }
            .sidebar.mobile-open { transform: translateX(0); }
            .sidebar.collapsed { transform: translateX(-100%); width: 260px; }
            .user-info { display: none; }
            .dropdown-icon { display: none; }
            .notifications-panel { width: 80%; right: -80%; max-width: none; }
            .notifications-panel.show { right: 0; }
            .info-grid { grid-template-columns: 1fr; }
            .charts-row { grid-template-columns: 1fr; }
            .certificate-layout { grid-template-columns: 1fr; }
            .cert-metrics { grid-template-columns: 1fr; }
        }
        
        @media (max-width: 640px) {
            .content-area { padding: 16px; }
            .search-bar { display: none; }
            .stats-grid { grid-template-columns: 1fr; }
            .notifications-panel { width: 100%; right: -100%; }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- ==================== SIDEBAR ==================== -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <i class="fas fa-shield-halved"></i>
                </div>
                <div class="sidebar-title">DLP Shield</div>
            </div>

            <nav class="nav-menu">
                <div class="nav-item">
                    <a href="dashboard" class="nav-link" data-page="dashboard">
                        <i class="fas fa-th-large"></i>
                        <span>Dashboard</span>
                    </a>
                </div>

                <div class="nav-item">
                    <a href="alerts" class="nav-link" data-page="alerts">
                        <i class="fas fa-triangle-exclamation"></i>
                        <span>Alerts &amp; Incidents</span>
                    </a>
                </div>

                <div class="nav-item">
                    <div class="nav-link nav-dropdown" onclick="toggleSubMenu(this)">
                        <i class="fas fa-shield-alt"></i>
                        <span>Policies</span>
                        <i class="fas fa-chevron-down chevron-icon"></i>
                    </div>
                    <div class="sub-menu">
                        <a href="manage-agents" class="sub-menu-item" data-page="manage-agents">Manage Agents</a>
                        <!-- <a href="file-policies.html" class="sub-menu-item" data-page="file-policies">File Policies</a> -->
                        <a href="assign-policy" class="sub-menu-item" data-page="assign-policy">Assign Policy</a>
                    </div>
                </div>

                <!-- <div class="nav-item">
                    <a href="agents.html" class="nav-link" data-page="agents">
                        <i class="fas fa-desktop"></i>
                        <span>Agents / Endpoints</span>
                    </a>
                </div> -->

                <div class="nav-item">
                    <div class="nav-link nav-dropdown" onclick="toggleSubMenu(this)">
                        <i class="fas fa-eye"></i>
                        <span>OCR &amp; Image Analysis</span>
                        <i class="fas fa-chevron-down chevron-icon"></i>
                    </div>
                    <div class="sub-menu">
                        <a href="ocr-dashboard" class="sub-menu-item" data-page="ocr-dashboard">OCR Dashboard</a>
<!--                        <a href="ocr-policies" class="sub-menu-item" data-page="ocr-policies">OCR Policies</a>-->
                    </div>
                </div>

                <div class="nav-item">
                    <div class="nav-link nav-dropdown" onclick="toggleSubMenu(this)">
                        <i class="fas fa-file-lines"></i>
                        <span>Reports &amp; Logs</span>
                        <i class="fas fa-chevron-down chevron-icon"></i>
                    </div>
                    <div class="sub-menu">
                        <a href="reports" class="sub-menu-item" data-page="reports">Reports</a>
                        <a href="generate-report" class="sub-menu-item" data-page="generate-report">Generate Report</a>
                        <a href="audit-logs" class="sub-menu-item" data-page="audit-logs">Audit Logs</a>
                        <a href="device-logs" class="sub-menu-item" data-page="device-logs">Device Logs</a>
                    </div>
                </div>

                <div class="nav-item">
                    <div class="nav-link nav-dropdown" onclick="toggleSubMenu(this)">
                        <i class="fas fa-users"></i>
                        <span>Users &amp; Roles</span>
                        <i class="fas fa-chevron-down chevron-icon"></i>
                    </div>
                    <div class="sub-menu">
                        <a href="users" class="sub-menu-item" data-page="users">Users</a>
                        <a href="roles" class="sub-menu-item" data-page="roles">Roles &amp; Permissions</a>
                        <a href="permissions" class="sub-menu-item" data-page="permissions">Permissions</a>
                    </div>
                </div>

                <div class="nav-item">
                    <div class="nav-link nav-dropdown" onclick="toggleSubMenu(this)">
                        <i class="fas fa-gear"></i>
                        <span>Settings</span>
                        <i class="fas fa-chevron-down chevron-icon"></i>
                    </div>
                    <div class="sub-menu">
                        <a href="general" class="sub-menu-item" data-page="general">General</a>
                        <a href="security" class="sub-menu-item" data-page="security">Security</a>
                        <a href="integrations" class="sub-menu-item" data-page="integrations">Integrations</a>
                        <a href="data-retention" class="sub-menu-item" data-page="data-retention">Data Retention</a>
                    </div>
                </div>
            </nav>

            <div class="sidebar-footer">
                <button class="collapse-btn" onclick="toggleSidebar()">
                    <i class="fas fa-chevron-left"></i>
                    <span>Collapse</span>
                </button>
            </div>
        </aside>

        <!-- Mobile Overlay (for sidebar) -->
        <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeMobileSidebar()"></div>

        <!-- ==================== HEADER ==================== -->
        <header class="top-header" id="topHeader">
            <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">
                <i class="fas fa-bars"></i>
            </button>

            <div class="search-bar">
                <i class="fas fa-search"></i>
                <input type="text" class="search-input" placeholder="Search alerts, agents, policies...">
            </div>

            <div class="header-actions">
                <button class="notification-btn" onclick="toggleNotifications(event)">
                    <i class="fas fa-bell"></i>
                    <span class="notification-badge">5</span>
                </button>

                <div class="user-profile" onclick="toggleUserDropdown(event)">
                    <div class="user-avatar">[[${userInitials}]]</div>
                    <div class="user-info">
                        <div class="user-name">[[${userName}]]</div>
<!--                        <div class="user-role">[[${userRole}]]</div>-->
                        <div id="userEmail">[[${userEmail}]]</div>
                    </div>
                    <i class="fas fa-chevron-down dropdown-icon"></i>

                    <div class="user-dropdown" id="userDropdown">
                        <a href="general" class="dropdown-item">
                            <i class="fas fa-gear"></i>
                            <span>Settings</span>
                        </a>
                        <a href="#" class="dropdown-item">
                            <i class="fas fa-circle-question"></i>
                            <span>Help &amp; Support</span>
                        </a>
                        <div class="dropdown-divider"></div>
                        <a href="index" class="dropdown-item danger" onclick="logout(event)">
                            <i class="fas fa-right-from-bracket"></i>
                            <span>Sign out</span>
                        </a>
                    </div>
                </div>
            </div>
        </header>

        <!-- ==================== NOTIFICATIONS PANEL ==================== -->
        <div class="notifications-panel" id="notificationsPanel">
            <div class="notifications-header">
                <h3>Notifications</h3>
                <button class="close-notifications" onclick="closeNotifications()">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="notifications-tabs">
                <button class="tab-btn active" onclick="switchTab(event, 'all')">All (5)</button>
                <button class="tab-btn" onclick="switchTab(event, 'unread')">Unread (3)</button>
            </div>

            <div class="notifications-content" id="notificationsContent">
                <div class="notification-item unread">
                    <div class="notification-icon critical">
                        <i class="fas fa-shield-exclamation"></i>
                    </div>
                    <div class="notification-body">
                        <div class="notification-title">Critical Policy Violation</div>
                        <div class="notification-text">User attempted to copy sensitive files to USB drive</div>
                        <div class="notification-time">2 minutes ago</div>
                    </div>
                    <div class="notification-dot"></div>
                </div>

                <div class="notification-item unread">
                    <div class="notification-icon warning">
                        <i class="fas fa-triangle-exclamation"></i>
                    </div>
                    <div class="notification-body">
                        <div class="notification-title">Agent Offline</div>
                        <div class="notification-text">DESKTOP-DEF456 has been offline for 2 hours</div>
                        <div class="notification-time">15 minutes ago</div>
                    </div>
                    <div class="notification-dot"></div>
                </div>

                <div class="notification-item unread">
                    <div class="notification-icon info">
                        <i class="fas fa-info-circle"></i>
                    </div>
                    <div class="notification-body">
                        <div class="notification-title">Policy Updated</div>
                        <div class="notification-text">File Protection Policy has been modified by Admin</div>
                        <div class="notification-time">1 hour ago</div>
                    </div>
                    <div class="notification-dot"></div>
                </div>

                <div class="notification-item">
                    <div class="notification-icon success">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="notification-body">
                        <div class="notification-title">Agent Connected</div>
                        <div class="notification-text">New agent LAPTOP-XYZ789 successfully registered</div>
                        <div class="notification-time">3 hours ago</div>
                    </div>
                </div>

                <div class="notification-item">
                    <div class="notification-icon info">
                        <i class="fas fa-file-alt"></i>
                    </div>
                    <div class="notification-body">
                        <div class="notification-title">Report Generated</div>
                        <div class="notification-text">Weekly security report is ready for review</div>
                        <div class="notification-time">5 hours ago</div>
                    </div>
                </div>
            </div>

            <div class="notifications-footer">
                <a href="alerts" class="view-all-btn">View All Notifications</a>
            </div>
        </div>

        <!-- Notification Overlay -->
        <div class="notification-overlay" id="notificationOverlay" onclick="closeNotifications()"></div>

        <!-- Main Content -->
        <main class="main-content" id="mainContent">
            <div class="content-area">
                <!-- Back Button -->
                <div class="back-button-container">
                    <a href="manage-agents" class="back-button">
                        <i class="fas fa-arrow-left"></i>
                        Back to Agents
                    </a>
                </div>

                <!-- <div class="agent-profile-card" data-agent-id="[[${agentId}]]"> -->
                <div class="agent-profile-card" th:data-agent-id="${agentId}">
                    <div class="profile-header">
                        <div class="profile-info">
                            <div class="profile-avatar">JD</div>
                            <div class="profile-details">
                                <h1>DESKTOP-ABC123</h1>
                                <div class="profile-meta">
                                    <span class="profile-meta-item"><i class="fas fa-user"></i> john.doe@company.com</span>
                                    <span class="profile-meta-item"><i class="fas fa-network-wired"></i> 192.168.1.100</span>
                                    <span class="profile-meta-item"><i class="fas fa-windows"></i> Windows 11 Pro</span>
                                </div>
                            </div>
                        </div>
                        <div class="profile-actions">
                            <button class="btn btn-secondary" onclick="window.location.href='agent-edit?id=DESKTOP-ABC123'"><i class="fas fa-edit"></i> Edit</button>
                            <button class="btn btn-primary" onclick="generateCert()"><i class="fas fa-certificate"></i> Generate Certificate</button>
                            <button class="btn btn-danger" onclick="deleteAgent()"><i class="fas fa-trash"></i> Delete</button>
                        </div>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-box"><div class="stat-label">Score</div><div class="stat-value">95/100</div></div>
                        <div class="stat-box"><div class="stat-label">URLs Visited</div><div class="stat-value">1,247</div></div>
                        <div class="stat-box"><div class="stat-label">Apps Used</div><div class="stat-value">28</div></div>
                        <div class="stat-box"><div class="stat-label">Violations</div><div class="stat-value">0</div></div>
                        <div class="stat-box"><div class="stat-label">Uptime</div><div class="stat-value">98.5%</div></div>
                        <div class="stat-box"><div class="stat-label">Last Seen</div><div class="stat-value">2m ago</div></div>
                    </div>
                </div>

                <div class="tabs-container">
                    <div class="tabs-nav">
                        <button class="tab-btn active" onclick="openTab(event, 'overview')"><i class="fas fa-chart-line"></i> Overview</button>
                        <button class="tab-btn" onclick="openTab(event, 'policies')"><i class="fas fa-shield-alt"></i> Policies</button>
                        <button class="tab-btn" onclick="openTab(event, 'urlHistory')"><i class="fas fa-globe"></i> URL History</button>
                        <button class="tab-btn" onclick="openTab(event, 'appUsage')"><i class="fas fa-window-maximize"></i> App Usage</button>
                        <button class="tab-btn" onclick="openTab(event, 'certificate')"><i class="fas fa-certificate"></i> Certificate</button>
                        <button class="tab-btn" onclick="openTab(event, 'blockedUrls')"><i class="fas fa-ban"></i> Blocked URLs</button>
                        <button class="tab-btn" onclick="openTab(event, 'partialAccess')"><i class="fas fa-eye"></i> Partial Access</button>
                        <button class="tab-btn" onclick="openTab(event, 'activity')"><i class="fas fa-clock-rotate-left"></i> Activity Logs</button>
                    </div>

                    <div id="overview" class="tab-content active">
                        <div class="info-grid">
                            <div class="info-card">
                                <h3><i class="fas fa-desktop"></i> System Information</h3>
                                <div class="info-row"><span class="info-label">OS</span><span class="info-value">Windows 11 Pro</span></div>
                                <div class="info-row"><span class="info-label">Version</span><span class="info-value">22H2 Build 22621</span></div>
                                <div class="info-row"><span class="info-label">Processor</span><span class="info-value">Intel i7-12700K</span></div>
                                <div class="info-row"><span class="info-label">RAM</span><span class="info-value">32 GB</span></div>
                                <div class="info-row"><span class="info-label">Storage</span><span class="info-value">512GB (235GB Free)</span></div>
                            </div>
                            <div class="info-card">
                                <h3><i class="fas fa-network-wired"></i> Network</h3>
                                <div class="info-row"><span class="info-label">IP Address</span><span class="info-value">192.168.1.100</span></div>
                                <div class="info-row"><span class="info-label">MAC</span><span class="info-value">00:1B:44:11:3A:B7</span></div>
                                <div class="info-row"><span class="info-label">Subnet</span><span class="info-value">255.255.255.0</span></div>
                                <div class="info-row"><span class="info-label">Gateway</span><span class="info-value">192.168.1.1</span></div>
                                <div class="info-row"><span class="info-label">DNS</span><span class="info-value">8.8.8.8</span></div>
                            </div>
                            <div class="info-card">
                                <h3><i class="fas fa-user"></i> User Details</h3>
                                <div class="info-row"><span class="info-label">Username</span><span class="info-value">jdoe</span></div>
                                <div class="info-row"><span class="info-label">Email</span><span class="info-value">john.doe@company.com</span></div>
                                <div class="info-row"><span class="info-label">Department</span><span class="info-value">IT</span></div>
                                <div class="info-row"><span class="info-label">Role</span><span class="info-value">Sr. Developer</span></div>
                                <div class="info-row"><span class="info-label">Phone</span><span class="info-value">+91 98765 43210</span></div>
                            </div>
                            <div class="info-card">
                                <h3><i class="fas fa-cog"></i> Agent Config</h3>
                                <div class="info-row"><span class="info-label">Version</span><span class="info-value">v2.4.1</span></div>
                                <div class="info-row"><span class="info-label">Installed</span><span class="info-value">Jan 15, 2025</span></div>
                                <div class="info-row"><span class="info-label">Updated</span><span class="info-value">Feb 1, 2025</span></div>
                                <div class="info-row"><span class="info-label">Mode</span><span class="info-value">Active</span></div>
                                <div class="info-row"><span class="info-label">Auto Update</span><span class="info-value">Enabled</span></div>
                            </div>
                        </div>
                    </div>

                    <div id="urlHistory" class="tab-content">
                        <div class="url-filters">
                            <input type="text" class="filter-input" placeholder="Search URLs...">
                            <select class="filter-input"><option>All Categories</option><option>Work</option><option>Social</option><option>Blocked</option></select>
                            <select class="filter-input"><option>Today</option><option>This Week</option><option>This Month</option></select>
                        </div>
                        <table class="url-table">
                            <thead><tr><th>URL</th><th>Category</th><th>Visits</th><th>Time Spent</th><th>Last Visit</th><th>Status</th></tr></thead>
                            <tbody>
                                <tr><td><a href="#" class="url-link">github.com/company/project</a></td><td><span class="category-tag work">Work</span></td><td>87</td><td>4h 32m</td><td>5m ago</td><td><span class="status-badge online">Allowed</span></td></tr>
                                <tr><td><a href="#" class="url-link">stackoverflow.com</a></td><td><span class="category-tag work">Work</span></td><td>52</td><td>2h 15m</td><td>15m ago</td><td><span class="status-badge online">Allowed</span></td></tr>
                                <tr><td><a href="#" class="url-link">linkedin.com</a></td><td><span class="category-tag social">Social</span></td><td>12</td><td>45m</td><td>1h ago</td><td><span class="status-badge online">Allowed</span></td></tr>
                                <tr><td><a href="#" class="url-link">gambling-site.com</a></td><td><span class="category-tag blocked">Blocked</span></td><td>1</td><td>0m</td><td>3d ago</td><td><span class="status-badge offline">Blocked</span></td></tr>
                            </tbody>
                        </table>
                    </div>

                    <div id="appUsage" class="tab-content">
                        <div class="charts-row">
                            <div class="chart-box">
                                <h3>Usage Distribution</h3>
                                <div class="pie-chart-layout">
                                    <div class="circular-chart-container">
                                        <canvas id="appPieChart"></canvas>
                                        <div class="circular-chart-center">
                                            <div class="circular-chart-value">37</div>
                                            <div class="circular-chart-label">Apps</div>
                                        </div>
                                    </div>
                                    <div class="chart-legend">
                                        <div class="legend-item">
                                            <div class="legend-color" style="background: #3b82f6;">
                                                <i class="fas fa-code"></i>
                                            </div>
                                            <div class="legend-details">
                                                <span class="legend-label">Dev Tools</span>
                                                <span class="legend-value">35%</span>
                                            </div>
                                        </div>
                                        <div class="legend-item">
                                            <div class="legend-color" style="background: #10b981;">
                                                <i class="fab fa-chrome"></i>
                                            </div>
                                            <div class="legend-details">
                                                <span class="legend-label">Browsers</span>
                                                <span class="legend-value">28%</span>
                                            </div>
                                        </div>
                                        <div class="legend-item">
                                            <div class="legend-color" style="background: #f59e0b;">
                                                <i class="fas fa-comment"></i>
                                            </div>
                                            <div class="legend-details">
                                                <span class="legend-label">Communication</span>
                                                <span class="legend-value">18%</span>
                                            </div>
                                        </div>
                                        <div class="legend-item">
                                            <div class="legend-color" style="background: #8b5cf6;">
                                                <i class="fas fa-tasks"></i>
                                            </div>
                                            <div class="legend-details">
                                                <span class="legend-label">Productivity</span>
                                                <span class="legend-value">12%</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="chart-box">
                                <h3>Weekly Trend</h3>
                                <div style="height: 300px; position: relative;">
                                    <canvas id="appLineChart"></canvas>
                                </div>
                            </div>
                        </div>
                        
                        <h3 style="margin-bottom: 16px; font-size: 1.1em; color: #111827;">Top Applications</h3>
                        <div class="app-list">
                            <div class="app-item">
                                <div class="app-info">
                                    <div class="app-icon"><i class="fab fa-chrome" style="font-size: 1.3em; color: #4285f4;"></i></div>
                                    <div class="app-details"><h4>Google Chrome</h4><p>Web Browser</p></div>
                                </div>
                                <div class="app-time">6h 45m</div>
                            </div>
                            <div class="app-item">
                                <div class="app-info">
                                    <div class="app-icon"><i class="fab fa-microsoft" style="font-size: 1.3em; color: #0078d4;"></i></div>
                                    <div class="app-details"><h4>VS Code</h4><p>Code Editor</p></div>
                                </div>
                                <div class="app-time">5h 20m</div>
                            </div>
                            <div class="app-item">
                                <div class="app-info">
                                    <div class="app-icon"><i class="fas fa-envelope" style="font-size: 1.3em; color: #0072c6;"></i></div>
                                    <div class="app-details"><h4>Outlook</h4><p>Email Client</p></div>
                                </div>
                                <div class="app-time">2h 30m</div>
                            </div>
                        </div>
                    </div>

                    <div id="certificate" class="tab-content">
                        <div class="certificate-container">
                            <div class="certificate-layout">
                                <div class="certificate-card">
                                    <div class="cert-header">
                                        <div class="cert-icon">
                                            <i class="fas fa-award"></i>
                                        </div>
                                        <h2 class="cert-title">Agent Behavior Certificate</h2>
                                    </div>
                                    
                                    <div class="cert-score-circle">
                                        <div class="cert-score">95</div>
                                        <div class="cert-max">/100</div>
                                    </div>
                                    
                                    <div style="text-align: center;">
                                        <div class="cert-grade"><i class="fas fa-star" style="margin-right: 6px;"></i>Grade: A+ Excellent</div>
                                    </div>
                                    
                                    <div class="cert-metrics">
                                        <div class="cert-metric">
                                            <div class="cert-metric-header">
                                                <div class="cert-metric-icon">
                                                    <i class="fas fa-chart-line"></i>
                                                </div>
                                                <div class="cert-metric-label">Productivity</div>
                                            </div>
                                            <div class="cert-metric-value">
                                                92%
                                                <span class="cert-metric-trend"><i class="fas fa-arrow-up"></i></span>
                                            </div>
                                        </div>
                                        <div class="cert-metric compliance">
                                            <div class="cert-metric-header">
                                                <div class="cert-metric-icon">
                                                    <i class="fas fa-check-circle"></i>
                                                </div>
                                                <div class="cert-metric-label">Compliance</div>
                                            </div>
                                            <div class="cert-metric-value">
                                                100%
                                                <span class="cert-metric-trend"><i class="fas fa-arrow-up"></i></span>
                                            </div>
                                        </div>
                                        <div class="cert-metric">
                                            <div class="cert-metric-header">
                                                <div class="cert-metric-icon">
                                                    <i class="fas fa-shield-alt"></i>
                                                </div>
                                                <div class="cert-metric-label">Security</div>
                                            </div>
                                            <div class="cert-metric-value">
                                                98%
                                                <span class="cert-metric-trend"><i class="fas fa-arrow-up"></i></span>
                                            </div>
                                        </div>
                                        <div class="cert-metric">
                                            <div class="cert-metric-header">
                                                <div class="cert-metric-icon">
                                                    <i class="fas fa-clock"></i>
                                                </div>
                                                <div class="cert-metric-label">Uptime</div>
                                            </div>
                                            <div class="cert-metric-value">
                                                98.5%
                                                <span class="cert-metric-trend"><i class="fas fa-arrow-up"></i></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="ai-analysis">
                                    <div class="ai-analysis-header">
                                        <div class="ai-icon">
                                            <i class="fas fa-robot"></i>
                                        </div>
                                        <h3>AI Behavior Analysis</h3>
                                    </div>
                                    
                                    <div class="analysis-section">
                                        <div class="section-header">
                                            <div class="section-icon positive">âœ…</div>
                                            <h4>Positive Behaviors</h4>
                                        </div>
                                        <ul>
                                            <li>71% web activity is work-related (GitHub, Stack Overflow)</li>
                                            <li>No policy violations in last 30 days</li>
                                            <li>Regular security updates applied</li>
                                            <li>Minimal social media during work hours</li>
                                        </ul>
                                    </div>
                                    
                                    <div class="analysis-section">
                                        <div class="section-header">
                                            <div class="section-icon warning">âš ï¸</div>
                                            <h4>Areas for Improvement</h4>
                                        </div>
                                        <ul>
                                            <li>Occasional shopping sites during work hours (low risk)</li>
                                            <li>Time management on communication tools</li>
                                        </ul>
                                    </div>
                                    
                                    <div class="analysis-section">
                                        <div class="section-header">
                                            <div class="section-icon info">ðŸŽ¯</div>
                                            <h4>Recommendations</h4>
                                        </div>
                                        <ul>
                                            <li>Maintain current high-performance standards</li>
                                            <li>Continue using approved collaboration tools</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="policies" class="tab-content">
                        <div class="policy-list">

                            <div class="policy-card">
                                <div class="policy-header">
                                    <h4 class="policy-title">Web Browsing Policy - IT</h4>
                                    <div style="display:flex; align-items:center; gap:10px;">
                                        <span class="policy-status active">Active</span>
                                        <button class="policy-delete-btn" onclick="deletePolicy(this)" title="Delete"><i class="fas fa-trash"></i></button>
                                    </div>
                                </div>
                                <p class="policy-desc">Controls web browsing for IT employees. Blocks malicious sites and monitors usage.</p>
                                <div class="policy-rules"><span class="rule-tag">Block Gambling</span><span class="rule-tag">Block Adult Content</span><span class="rule-tag">Monitor Social Media</span></div>
                            </div>

                            <div class="policy-card">
                                <div class="policy-header">
                                    <h4 class="policy-title">File Transfer Policy</h4>
                                    <div style="display:flex; align-items:center; gap:10px;">
                                        <span class="policy-status active">Active</span>
                                        <button class="policy-delete-btn" onclick="deletePolicy(this)" title="Delete"><i class="fas fa-trash"></i></button>
                                    </div>
                                </div>
                                <p class="policy-desc">Monitors file transfers via USB, email, cloud. Prevents data exfiltration.</p>
                                <div class="policy-rules"><span class="rule-tag">USB Monitoring</span><span class="rule-tag">Email Scan</span><span class="rule-tag">Cloud Control</span></div>
                            </div>

                            <div class="policy-card">
                                <div class="policy-header">
                                    <h4 class="policy-title">Application Control</h4>
                                    <div style="display:flex; align-items:center; gap:10px;">
                                        <span class="policy-status active">Active</span>
                                        <button class="policy-delete-btn" onclick="deletePolicy(this)" title="Delete"><i class="fas fa-trash"></i></button>
                                    </div>
                                </div>
                                <p class="policy-desc">Manages approved applications. Prevents unauthorized software.</p>
                                <div class="policy-rules"><span class="rule-tag">Whitelist Apps</span><span class="rule-tag">Block Unauthorized</span></div>
                            </div>

                        </div>
                    </div>

                    <!-- ======== BLOCKED URLs TAB ======== -->
                    <div id="blockedUrls" class="tab-content">

                        <div class="burl-stats-row">
                            <div class="burl-stat-card">
                                <div class="burl-stat-icon"><i class="fas fa-globe"></i></div>
                                <div class="burl-stat-info">
                                    <div class="burl-stat-label">Total URLs</div>
                                    <div class="burl-stat-value">2</div>
                                    <div class="burl-stat-sub">2 Active</div>
                                </div>
                            </div>
                            <div class="burl-stat-card">
                                <div class="burl-stat-icon"><i class="fas fa-earth-americas"></i></div>
                                <div class="burl-stat-info">
                                    <div class="burl-stat-label">Global Rules</div>
                                    <div class="burl-stat-value">1</div>
                                    <div class="burl-stat-sub">Applied to all</div>
                                </div>
                            </div>
                            <div class="burl-stat-card">
                                <div class="burl-stat-icon"><i class="fas fa-tags"></i></div>
                                <div class="burl-stat-info">
                                    <div class="burl-stat-label">Categories</div>
                                    <div class="burl-stat-value">2</div>
                                    <div class="burl-stat-sub">Different types</div>
                                </div>
                            </div>
                        </div>

                        <div class="burl-toolbar">
                            <div class="burl-search-wrap">
                                <input type="text" class="burl-search" id="burlSearch" placeholder="Search URLs..." oninput="filterBurlTable()">
                                <i class="fas fa-search burl-search-icon"></i>
                            </div>
                            <select class="burl-select" id="burlStatusFilter" onchange="filterBurlTable()">
                                <option value="">All Status</option>
                                <option value="Active">Active</option>
                                <option value="Inactive">Inactive</option>
                            </select>
                            <select class="burl-select" id="burlScopeFilter" onchange="filterBurlTable()">
                                <option value="">All Scope</option>
                                <option value="Global">Global</option>
                                <option value="Device">Device</option>
                                <option value="User">User</option>
                            </select>
                            <button class="burl-btn-refresh"><i class="fas fa-rotate-right"></i></button>
                            <div style="margin-left:auto; display:flex; gap:10px;">
                                <button class="btn btn-primary" onclick="openAddBurlModal()"><i class="fas fa-plus-circle"></i> Add URL</button>
                                <button class="btn btn-secondary" style="background:#10b981;color:white;" onclick="alert('Bulk add')"><i class="fas fa-plus-circle"></i> Bulk Add</button>
                            </div>
                        </div>

                        <div class="burl-table-wrap">
                            <table class="burl-table" id="burlTable">
                                <thead>
                                    <tr>
                                        <th>URL Pattern</th>
                                        <th>Domain</th>
                                        <th>Category</th>
                                        <th>Scope</th>
                                        <th>Status</th>
                                        <th>Updated</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="burlTbody">
                                    <tr>
                                        <td>
                                            <div class="burl-url-name">www.netflix.com</div>
                                            <div class="burl-url-reason">Entertainment streaming</div>
                                        </td>
                                        <td class="burl-domain">www.netflix.com</td>
                                        <td><span class="burl-tag entertainment">Entertainment</span></td>
                                        <td><span class="burl-scope global">Global</span></td>
                                        <td><span class="burl-status active">Active</span></td>
                                        <td class="burl-date">5 hours ago</td>
                                        <td>
                                            <div class="burl-actions">
                                                <button class="burl-action-btn edit" title="Edit" onclick="openEditBurlModal(this)"><i class="fas fa-pen"></i></button>
                                                <button class="burl-action-btn delete" title="Delete" onclick="deleteBurlRow(this)"><i class="fas fa-trash"></i></button>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <div class="burl-url-name">facebook.com</div>
                                            <div class="burl-url-reason">Social media</div>
                                        </td>
                                        <td class="burl-domain">facebook.com</td>
                                        <td><span class="burl-tag social">Social</span></td>
                                        <td><span class="burl-scope device">Device: DESKTOP-Aâ€¦</span></td>
                                        <td><span class="burl-status active">Active</span></td>
                                        <td class="burl-date">28 days ago</td>
                                        <td>
                                            <div class="burl-actions">
                                                <button class="burl-action-btn edit" title="Edit" onclick="openEditBurlModal(this)"><i class="fas fa-pen"></i></button>
                                                <button class="burl-action-btn delete" title="Delete" onclick="deleteBurlRow(this)"><i class="fas fa-trash"></i></button>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <div class="mburl-section">
                            <div class="mburl-title"><i class="fas fa-chart-bar"></i> Most Blocked URLs</div>
                            <div class="mburl-list" id="mbUrlList">
                                <div class="mburl-item">
                                    <div class="mburl-rank">#1</div>
                                    <div class="mburl-info">
                                        <div class="mburl-name">facebook.com</div>
                                        <div class="mburl-domain">facebook.com</div>
                                    </div>
                                    <div class="mburl-count-wrap">
                                        <div class="mburl-count">0</div>
                                        <div class="mburl-count-label">blocked</div>
                                    </div>
                                </div>
                                <div class="mburl-item">
                                    <div class="mburl-rank">#2</div>
                                    <div class="mburl-info">
                                        <div class="mburl-name">www.netflix.com</div>
                                        <div class="mburl-domain">www.netflix.com</div>
                                    </div>
                                    <div class="mburl-count-wrap">
                                        <div class="mburl-count">0</div>
                                        <div class="mburl-count-label">blocked</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ======== PARTIAL ACCESS TAB ======== -->
                    <div id="partialAccess" class="tab-content">

                        <div class="burl-stats-row">
                            <div class="burl-stat-card">
                                <div class="burl-stat-icon pa-icon"><i class="fas fa-globe"></i></div>
                                <div class="burl-stat-info">
                                    <div class="burl-stat-label">Total Sites</div>
                                    <div class="burl-stat-value">1</div>
                                    <div class="burl-stat-sub">1 Active</div>
                                </div>
                            </div>
                            <div class="burl-stat-card">
                                <div class="burl-stat-icon pa-icon"><i class="fas fa-tags"></i></div>
                                <div class="burl-stat-info">
                                    <div class="burl-stat-label">Categories</div>
                                    <div class="burl-stat-value">1</div>
                                    <div class="burl-stat-sub">Different types</div>
                                </div>
                            </div>
                        </div>

                        <div class="burl-toolbar">
                            <div class="burl-search-wrap">
                                <input type="text" class="burl-search" id="paSearch" placeholder="Search sites..." oninput="filterPaTable()">
                                <i class="fas fa-search burl-search-icon"></i>
                            </div>
                            <select class="burl-select" id="paStatusFilter" onchange="filterPaTable()">
                                <option value="">All Status</option>
                                <option value="Active">Active</option>
                                <option value="Inactive">Inactive</option>
                            </select>
                            <select class="burl-select" id="paScopeFilter" onchange="filterPaTable()">
                                <option value="">All Scope</option>
                                <option value="Global">Global</option>
                                <option value="Device">Device</option>
                                <option value="User">User</option>
                            </select>
                            <button class="burl-btn-refresh"><i class="fas fa-rotate-right"></i></button>
                            <div style="margin-left:auto; display:flex; gap:10px;">
                                <button class="btn btn-primary" onclick="openAddPaModal()"><i class="fas fa-plus-circle"></i> Add Site</button>
                                <button class="btn btn-secondary" style="background:#10b981;color:white;" onclick="alert('Bulk add')"><i class="fas fa-plus-circle"></i> Bulk Add</button>
                            </div>
                        </div>

                        <div class="burl-table-wrap">
                            <table class="burl-table" id="paTable">
                                <thead>
                                    <tr>
                                        <th>URL Pattern</th>
                                        <th>Domain</th>
                                        <th>Permissions</th>
                                        <th>Category</th>
                                        <th>Scope</th>
                                        <th>Status</th>
                                        <th>Updated</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="paTbody">
                                    <tr>
                                        <td>
                                            <div class="burl-url-name">chat.deepseek.com</div>
                                            <div class="burl-url-reason">cant upload or download</div>
                                        </td>
                                        <td class="burl-domain">chat.deepseek.com</td>
                                        <td><span class="burl-tag monitor">Monitor Only</span></td>
                                        <td><span class="burl-tag work">work</span></td>
                                        <td><span class="burl-scope device">Device: DESKTOP-Aâ€¦</span></td>
                                        <td><span class="burl-status active">Active</span></td>
                                        <td class="burl-date">28 days ago</td>
                                        <td>
                                            <div class="burl-actions">
                                                <button class="burl-action-btn edit" title="Edit" onclick="openEditPaModal(this)"><i class="fas fa-pen"></i></button>
                                                <button class="burl-action-btn delete" title="Delete" onclick="deletePaRow(this)"><i class="fas fa-trash"></i></button>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div id="activity" class="tab-content">
                        <div class="activity-timeline">
                            <div class="activity-item"><div class="activity-time">Today, 2:15 PM</div><div class="activity-content"><h4>Application Launched</h4><p>Started Visual Studio Code v1.85.0</p></div></div>
                            <div class="activity-item"><div class="activity-time">Today, 2:10 PM</div><div class="activity-content"><h4>Web Access</h4><p>Visited github.com - Allowed (Work Related)</p></div></div>
                            <div class="activity-item"><div class="activity-time">Today, 1:45 PM</div><div class="activity-content"><h4>File Transfer</h4><p>Downloaded project_docs.zip (5.2 MB) - Allowed</p></div></div>
                            <div class="activity-item"><div class="activity-time">Today, 12:30 PM</div><div class="activity-content"><h4>System Event</h4><p>Agent heartbeat sent - Status: Online</p></div></div>
                            <div class="activity-item"><div class="activity-time">Today, 11:20 AM</div><div class="activity-content"><h4>Web Access</h4><p>Visited stackoverflow.com - Allowed</p></div></div>
                            <div class="activity-item"><div class="activity-time">Today, 10:00 AM</div><div class="activity-content"><h4>System Login</h4><p>User jdoe logged in successfully</p></div></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- ======== ADD BLOCKED URL MODAL ======== -->
    <div class="modal-overlay" id="addBurlModal">
        <div class="modal-box">
            <div class="modal-header">
                <h3>Add Blocked URL</h3>
                <button class="modal-close" onclick="closeModal('addBurlModal')"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="modal-field">
                    <label>URL Pattern <span style="color:#ef4444">*</span></label>
                    <input type="text" id="burl_pattern" placeholder="www.netflix.com">
                    <div class="hint">Use wildcards (*) for patterns. Example: *.facebook.com blocks all Facebook subdomains</div>
                </div>
                <div class="modal-field">
                    <label>Reason for Blocking</label>
                    <textarea id="burl_reason" placeholder="Why is this URL being blocked?"></textarea>
                </div>
                <div class="modal-row">
                    <div class="modal-field">
                        <label>Category</label>
                        <select id="burl_category">
                            <option value="">Select Category</option>
                            <option>Social Media</option>
                            <option>Gaming</option>
                            <option>Shopping</option>
                            <option>Entertainment</option>
                            <option>Malware/Phishing</option>
                            <option>Productivity</option>
                            <option>Other</option>
                        </select>
                    </div>
                    <div class="modal-field">
                        <label>Scope</label>
                        <select id="burl_scope">
                            <option>Global (All Devices)</option>
                            <option>Specific Device</option>
                            <option>Specific User</option>
                        </select>
                    </div>
                </div>
                <label class="modal-check"><input type="checkbox" id="burl_active" checked> Active (Start blocking immediately)</label>
            </div>
            <div class="modal-footer">
                <button class="modal-btn-cancel" onclick="closeModal('addBurlModal')">Cancel</button>
                <button class="modal-btn-save" onclick="saveBurl()">Save URL</button>
            </div>
        </div>
    </div>

    <!-- ======== ADD PARTIAL ACCESS SITE MODAL ======== -->
    <div class="modal-overlay" id="addPaModal">
        <div class="modal-box">
            <div class="modal-header" style="background:#0891b2;">
                <h3>Add Partial Access Site</h3>
                <button class="modal-close" onclick="closeModal('addPaModal')"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="modal-field">
                    <label>URL Pattern <span style="color:#ef4444">*</span></label>
                    <input type="text" id="pa_pattern" placeholder="e.g., chat.deepseek.com">
                    <div class="hint">Use wildcards (*) for patterns. Example: *.work.com allows access to work-related sites</div>
                </div>
                <div class="modal-field">
                    <label>Reason</label>
                    <textarea id="pa_reason" placeholder="Why is this site partially accessible?"></textarea>
                </div>
                <div class="modal-row">
                    <div class="modal-field">
                        <label>Category</label>
                        <select id="pa_category">
                            <option value="">Select Category</option>
                            <option>Work</option>
                            <option>Social Media</option>
                            <option>Entertainment</option>
                            <option>Productivity</option>
                            <option>Other</option>
                        </select>
                    </div>
                    <div class="modal-field">
                        <label>Scope</label>
                        <select id="pa_scope">
                            <option>Global (All Devices)</option>
                            <option>Specific Device</option>
                            <option>Specific User</option>
                        </select>
                    </div>
                </div>
                <div class="modal-row" style="margin-bottom:14px;">
                    <label class="modal-check"><input type="checkbox" id="pa_upload"> Allow File Upload</label>
                    <label class="modal-check"><input type="checkbox" id="pa_download"> Allow File Download</label>
                </div>
                <div class="modal-field">
                    <label>Monitor Mode</label>
                    <select id="pa_monitor">
                        <option>Block (Default)</option>
                        <option>Warn</option>
                        <option>Log Only</option>
                    </select>
                    <div class="hint">Block: Prevent actions | Warn: Show warning | Log Only: Only log attempts</div>
                </div>
                <div class="modal-field">
                    <label>Restricted File Types (Optional)</label>
                    <input type="text" id="pa_filetypes" placeholder="exe, zip, bat, dmg (comma separated)">
                    <div class="hint">File types that are still restricted even on partial access sites</div>
                </div>
                <label class="modal-check"><input type="checkbox" id="pa_active" checked> Active (Start monitoring immediately)</label>
            </div>
            <div class="modal-footer">
                <button class="modal-btn-cancel" onclick="closeModal('addPaModal')">Cancel</button>
                <button class="modal-btn-save green" onclick="savePa()">Save Site</button>
            </div>
        </div>
    </div>

    <!-- ======== EDIT BLOCKED URL MODAL ======== -->
    <div class="modal-overlay" id="editBurlModal">
        <div class="modal-box">
            <div class="modal-header">
                <h3>Edit Blocked URL</h3>
                <button class="modal-close" onclick="closeModal('editBurlModal')"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="modal-field">
                    <label>URL Pattern <span style="color:#ef4444">*</span></label>
                    <input type="text" id="edit_burl_pattern" placeholder="www.netflix.com">
                    <div class="hint">Use wildcards (*) for patterns. Example: *.facebook.com blocks all Facebook subdomains</div>
                </div>
                <div class="modal-field">
                    <label>Reason for Blocking</label>
                    <textarea id="edit_burl_reason" placeholder="Why is this URL being blocked?"></textarea>
                </div>
                <div class="modal-row">
                    <div class="modal-field">
                        <label>Category</label>
                        <select id="edit_burl_category">
                            <option value="">Select Category</option>
                            <option>Social Media</option>
                            <option>Gaming</option>
                            <option>Shopping</option>
                            <option>Entertainment</option>
                            <option>Malware/Phishing</option>
                            <option>Productivity</option>
                            <option>Other</option>
                        </select>
                    </div>
                    <div class="modal-field">
                        <label>Scope</label>
                        <select id="edit_burl_scope">
                            <option>Global (All Devices)</option>
                            <option>Specific Device</option>
                            <option>Specific User</option>
                        </select>
                    </div>
                </div>
                <label class="modal-check"><input type="checkbox" id="edit_burl_active"> Active (Start blocking immediately)</label>
            </div>
            <div class="modal-footer">
                <button class="modal-btn-cancel" onclick="closeModal('editBurlModal')">Cancel</button>
                <button class="modal-btn-save" onclick="updateBurl()">Update URL</button>
            </div>
        </div>
    </div>

    <!-- ======== EDIT PARTIAL ACCESS SITE MODAL ======== -->
    <div class="modal-overlay" id="editPaModal">
        <div class="modal-box">
            <div class="modal-header" style="background:#0891b2;">
                <h3>Edit Partial Access Site</h3>
                <button class="modal-close" onclick="closeModal('editPaModal')"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="modal-field">
                    <label>URL Pattern <span style="color:#ef4444">*</span></label>
                    <input type="text" id="edit_pa_pattern" placeholder="e.g., chat.deepseek.com">
                    <div class="hint">Use wildcards (*) for patterns. Example: *.work.com allows access to work-related sites</div>
                </div>
                <div class="modal-field">
                    <label>Reason</label>
                    <textarea id="edit_pa_reason" placeholder="Why is this site partially accessible?"></textarea>
                </div>
                <div class="modal-row">
                    <div class="modal-field">
                        <label>Category</label>
                        <select id="edit_pa_category">
                            <option value="">Select Category</option>
                            <option>Work</option>
                            <option>Social Media</option>
                            <option>Entertainment</option>
                            <option>Productivity</option>
                            <option>Other</option>
                        </select>
                    </div>
                    <div class="modal-field">
                        <label>Scope</label>
                        <select id="edit_pa_scope">
                            <option>Global (All Devices)</option>
                            <option>Specific Device</option>
                            <option>Specific User</option>
                        </select>
                    </div>
                </div>
                <div class="modal-row" style="margin-bottom:14px;">
                    <label class="modal-check"><input type="checkbox" id="edit_pa_upload"> Allow File Upload</label>
                    <label class="modal-check"><input type="checkbox" id="edit_pa_download"> Allow File Download</label>
                </div>
                <div class="modal-field">
                    <label>Monitor Mode</label>
                    <select id="edit_pa_monitor">
                        <option>Block (Default)</option>
                        <option>Warn</option>
                        <option>Log Only</option>
                    </select>
                    <div class="hint">Block: Prevent actions | Warn: Show warning | Log Only: Only log attempts</div>
                </div>
                <div class="modal-field">
                    <label>Restricted File Types (Optional)</label>
                    <input type="text" id="edit_pa_filetypes" placeholder="exe, zip, bat, dmg (comma separated)">
                    <div class="hint">File types that are still restricted even on partial access sites</div>
                </div>
                <label class="modal-check"><input type="checkbox" id="edit_pa_active"> Active (Start monitoring immediately)</label>
            </div>
            <div class="modal-footer">
                <button class="modal-btn-cancel" onclick="closeModal('editPaModal')">Cancel</button>
                <button class="modal-btn-save green" onclick="updatePa()">Update Site</button>
            </div>
        </div>
    </div>

    <script th:inline="javascript">
        

           /* ==================== AUTHENTICATION & USER DATA ==================== */
<!--    const userData = {-->
<!--        username: [[${username}]],-->
<!--        userName: [[${userName}]],-->
<!--        userInitials: [[${userInitials}]],-->
<!--        userRole: [[${userRole}]],-->
<!--        userEmail: [[${userEmail}]],-->
<!--        userId: [[${userId}]]-->
<!--    };-->

<!--    function loadAdminInfo() {-->
<!--        const userName = document.querySelector(".user-name");-->
<!--        const userAvatar = document.querySelector(".user-avatar");-->
<!--        const userRole = document.querySelector(".user-role");-->
<!-- -->
<!--        if (userName && userData.userName) {-->
<!--            userName.textContent = userData.userName;-->
<!--        }-->
<!-- -->
<!--        if (userAvatar && userData.userInitials) {-->
<!--            userAvatar.textContent = userData.userInitials;-->
<!--        }-->
<!-- -->
<!--        if (userRole && userData.userRole) {-->
<!--            userRole.textContent = userData.userRole;-->
<!--        }-->
<!--      }-->
        


      function loadAgentPolicies(agentId) {
    fetch(`/api/admin/agents/${agentId}/policies`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayAgentPolicies(data.data);
            } else {
                console.error('Failed to load policies:', data.message);
                showPoliciesError();
            }
        })
        .catch(error => {
            console.error('Error loading policies:', error);
            showPoliciesError();
        });
}

// Function to display policies in the Policies tab
function displayAgentPolicies(policies) {
    const policyContainer = document.querySelector('#policies .policy-list');
    if (!policyContainer) return;
    
    if (!policies || policies.length === 0) {
        policyContainer.innerHTML = `
            <div style="text-align: center; padding: 40px; background: #f9fafb; border-radius: 8px;">
                <i class="fas fa-shield-alt" style="font-size: 48px; color: #9ca3af; margin-bottom: 16px;"></i>
                <h4 style="color: #374151; margin-bottom: 8px;">No Active Policies</h4>
                <p style="color: #6b7280;">This agent doesn't have any active policies yet.</p>
            </div>
        `;
        return;
    }
    
    let html = '';
    policies.forEach(policy => {
        // Parse policy data if it's JSON
        let rules = [];
        try {
            if (policy.policyData) {
                const data = JSON.parse(policy.policyData);
                if (Array.isArray(data)) {
                    rules = data;
                } else if (typeof data === 'object') {
                    rules = Object.values(data);
                }
            }
        } catch (e) {
            // If not JSON, use as string
            if (policy.policyData) {
                rules = [policy.policyData];
            }
        }
        
        // Generate rule tags
        const ruleTags = rules.length > 0 
            ? rules.map(rule => `<span class="rule-tag">${rule}</span>`).join('')
            : '<span class="rule-tag">No specific rules</span>';
        
        html += `
            <div class="policy-card" data-policy-id="${policy.id}" data-policy-code="${policy.policyCode}">
                <div class="policy-header">
                    <h4 class="policy-title">${policy.name || policy.policyCode}</h4>
                    <div style="display:flex; align-items:center; gap:10px;">
                        <span class="policy-status active">Active</span>
                        <button class="policy-delete-btn" onclick="removePolicyFromAgent(this)" title="Remove">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                <p class="policy-desc">${policy.description || 'No description available'}</p>
                <div class="policy-rules">
                    ${ruleTags}
                </div>
            </div>
        `;
    });
    
    policyContainer.innerHTML = html;
}

// Function to show error state
function showPoliciesError() {
    const policyContainer = document.querySelector('#policies .policy-list');
    if (policyContainer) {
        policyContainer.innerHTML = `
            <div style="text-align: center; padding: 40px; background: #f9fafb; border-radius: 8px;">
                <i class="fas fa-exclamation-triangle" style="font-size: 48px; color: #ef4444; margin-bottom: 16px;"></i>
                <h4 style="color: #374151; margin-bottom: 8px;">Error Loading Policies</h4>
                <p style="color: #6b7280;">Failed to load policies. Please try again.</p>
                <button onclick="loadAgentPolicies(getAgentIdFromUrl())" class="btn btn-primary" style="margin-top: 16px;">
                    <i class="fas fa-sync-alt"></i> Retry
                </button>
            </div>
        `;
    }
}

// Helper function to get agent ID from URL
function getAgentIdFromUrl() {
    const urlParams = new URLSearchParams(window.location.search);
    const id = urlParams.get('id');
    if (id) return id;
    
    // Try to extract from the current page context
    // You might need to adjust this based on how you're passing the agent ID
    const agentName = document.querySelector('.profile-details h1')?.textContent;
    if (agentName) {
        // If you have a mapping or can extract from somewhere else
        // For now, you might want to store the agent ID in a data attribute
        return document.querySelector('.profile-card')?.dataset.agentId;
    }
    return null;
}

// Function to remove policy from agent
function removePolicyFromAgent(buttonElement) {
    if (!confirm('Are you sure you want to remove this policy from the agent?')) {
        return;
    }
    
    // Get the policy card
    const policyCard = buttonElement.closest('.policy-card');
    if (!policyCard) return;
    
    // Get policy details from data attributes
    const policyCode = policyCard.dataset.policyCode;
    const policyId = policyCard.dataset.policyId;
    const agentId = getAgentIdFromUrl();
    
    if (!agentId) {
        alert('Could not determine agent ID');
        return;
    }
    
    if (!policyCode) {
        alert('Could not determine policy code');
        return;
    }
    
    console.log('Removing policy:', { policyId, policyCode, agentId });
    
    // Disable the button to prevent double submission
    buttonElement.disabled = true;
    buttonElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    
    // Call the deactivate-protection endpoint
    fetch('/api/admin/deactivate-protection', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            agentIds: [parseInt(agentId)],
            policyCode: policyCode
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Remove the policy card from UI with animation
            policyCard.style.transition = 'all 0.3s ease';
            policyCard.style.opacity = '0';
            policyCard.style.transform = 'translateX(20px)';
            
            setTimeout(() => {
                policyCard.remove();
                
                // Check if there are no more policies
                const policyContainer = document.querySelector('#policies .policy-list');
                if (policyContainer.children.length === 0) {
                    displayAgentPolicies([]);
                }
                
                // Show success message
                showNotification('Policy removed successfully', 'success');
            }, 300);
        } else {
            // Re-enable the button
            buttonElement.disabled = false;
            buttonElement.innerHTML = '<i class="fas fa-trash"></i>';
            
            // Show error message
            showNotification('Failed to remove policy: ' + (data.message || 'Unknown error'), 'error');
        }
    })
    .catch(error => {
        console.error('Error removing policy:', error);
        
        // Re-enable the button
        buttonElement.disabled = false;
        buttonElement.innerHTML = '<i class="fas fa-trash"></i>';
        
        // Show error message
        showNotification('Error removing policy: ' + error.message, 'error');
    });
}

       function showNotification(message, type = 'info') {
    // Check if notification container exists, if not create it
    let notificationContainer = document.getElementById('notification-container');
    if (!notificationContainer) {
        notificationContainer = document.createElement('div');
        notificationContainer.id = 'notification-container';
        notificationContainer.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
        `;
        document.body.appendChild(notificationContainer);
    }
    
    // Create notification element
    const notification = document.createElement('div');
    notification.style.cssText = `
        background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        margin-bottom: 10px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        display: flex;
        align-items: center;
        gap: 10px;
        animation: slideIn 0.3s ease;
        font-size: 0.9em;
    `;
    
    // Add icon based on type
    const icon = type === 'success' ? 'fa-check-circle' : 
                 type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle';
    
    notification.innerHTML = `
        <i class="fas ${icon}"></i>
        <span>${message}</span>
    `;
    
    // Add to container
    notificationContainer.appendChild(notification);
    
    // Auto remove after 3 seconds
    setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => {
            notification.remove();
        }, 300);
    }, 3000);
}

// Add CSS animations
const style = document.createElement('style');
style.textContent = `
    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    @keyframes slideOut {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(100%);
            opacity: 0;
        }
    }
`;
document.head.appendChild(style);
        /* ==================== SIDEBAR & HEADER FUNCTIONS ==================== */
        
        function toggleSubMenu(element) {
            var sidebar = document.getElementById('sidebar');
            if (sidebar.classList.contains('collapsed')) return;

            var subMenu = element.nextElementSibling;
            var allSubMenus = document.querySelectorAll('.sub-menu');
            var allDropdowns = document.querySelectorAll('.nav-dropdown');

            // Close other open submenus
            allSubMenus.forEach(function (menu) {
                if (menu !== subMenu) menu.classList.remove('open');
            });
            allDropdowns.forEach(function (link) {
                if (link !== element) link.classList.remove('expanded');
            });

            // Toggle current
            element.classList.toggle('expanded');
            subMenu.classList.toggle('open');
        }

        function toggleSidebar() {
            var sidebar = document.getElementById('sidebar');
            var mainContent = document.getElementById('mainContent');
            var header = document.getElementById('topHeader');

            sidebar.classList.toggle('collapsed');
            var isCollapsed = sidebar.classList.contains('collapsed');

            if (mainContent) mainContent.classList.toggle('expanded');

            // Update header left position instantly
            if (header) {
                header.style.left = isCollapsed ? '70px' : '240px';
            }

            // Close all submenus when collapsing
            if (isCollapsed) {
                document.querySelectorAll('.sub-menu').forEach(function (m) { m.classList.remove('open'); });
                document.querySelectorAll('.nav-dropdown').forEach(function (l) { l.classList.remove('expanded'); });
            }

            // Dispatch event in case other scripts listen
            window.dispatchEvent(new CustomEvent('sidebarToggle', { detail: { collapsed: isCollapsed } }));
        }

        function openMobileSidebar() {
            var sidebar = document.getElementById('sidebar');
            var overlay = document.getElementById('sidebarOverlay');
            if (sidebar) sidebar.classList.add('mobile-open');
            if (overlay) overlay.classList.add('active');
        }

        function closeMobileSidebar() {
            var sidebar = document.getElementById('sidebar');
            var overlay = document.getElementById('sidebarOverlay');
            if (sidebar) sidebar.classList.remove('mobile-open');
            if (overlay) overlay.classList.remove('active');
        }

        function toggleMobileMenu() {
            var sidebar = document.getElementById('sidebar');
            var overlay = document.getElementById('sidebarOverlay');
            if (!sidebar) return;

            if (sidebar.classList.contains('mobile-open')) {
                closeMobileSidebar();
            } else {
                openMobileSidebar();
            }
        }

        function toggleNotifications(event) {
            event.stopPropagation();
            var panel = document.getElementById('notificationsPanel');
            var overlay = document.getElementById('notificationOverlay');
            var btn = event.currentTarget;
            if (!panel || !overlay) return;

            if (panel.classList.contains('show')) {
                closeNotifications();
            } else {
                closeUserDropdown();
                panel.classList.add('show');
                overlay.classList.add('show');
                btn.classList.add('active');
                document.body.style.overflow = 'hidden';
            }
        }

        function closeNotifications() {
            var panel = document.getElementById('notificationsPanel');
            var overlay = document.getElementById('notificationOverlay');
            var btn = document.querySelector('.notification-btn');
            if (panel) panel.classList.remove('show');
            if (overlay) overlay.classList.remove('show');
            if (btn) btn.classList.remove('active');
            document.body.style.overflow = '';
        }

        function switchTab(event, tabName) {
            document.querySelectorAll('.tab-btn').forEach(function (t) { t.classList.remove('active'); });
            event.currentTarget.classList.add('active');
            document.querySelectorAll('.notification-item').forEach(function (item) {
                item.style.display = (tabName === 'unread' && !item.classList.contains('unread')) ? 'none' : 'flex';
            });
        }

        function toggleUserDropdown(event) {
            event.stopPropagation();
            var dropdown = document.getElementById('userDropdown');
            var userProfile = event.currentTarget;
            if (!dropdown) return;

            if (dropdown.classList.contains('show')) {
                closeUserDropdown();
            } else {
                closeNotifications();
                dropdown.classList.add('show');
                userProfile.classList.add('active');
            }
        }

        function closeUserDropdown() {
            var dropdown = document.getElementById('userDropdown');
            var userProfile = document.querySelector('.user-profile');
            if (dropdown) dropdown.classList.remove('show');
            if (userProfile) userProfile.classList.remove('active');
        }

        function logout(event) {
            event.preventDefault();
            window.location.href = '/logout';
        }

        function setActiveMenuItem() {
            var currentPage = window.location.pathname.split('/').pop() || 'agent-view';
            if (!currentPage) currentPage = 'agent-view';

            // Main nav links
            document.querySelectorAll('.nav-link[data-page]').forEach(function (link) {
                var href = link.getAttribute('href');
                if (href === currentPage) {
                    link.classList.add('active');
                }
            });

            // Sub-menu items
            document.querySelectorAll('.sub-menu-item[data-page]').forEach(function (item) {
                var href = item.getAttribute('href');
                if (href === currentPage) {
                    item.classList.add('active');
                    var parentSubMenu = item.closest('.sub-menu');
                    if (parentSubMenu) {
                        parentSubMenu.classList.add('open');
                        var parentNav = parentSubMenu.previousElementSibling;
                        if (parentNav) parentNav.classList.add('expanded');
                    }
                }
            });
        }
        
        // Also load policies when the Policies tab is clicked
        document.addEventListener('click', function(e) {
            const tabBtn = e.target.closest('.tab-btn[onclick*="policies"]');
            if (tabBtn) {
                setTimeout(() => {
                    const agentId = getAgentIdFromUrl();
                    if (agentId) {
                        loadAgentPolicies(agentId);
                    }
                }, 100);
            }
        });

        // Close dropdowns on outside click
        document.addEventListener('click', function (e) {
            var userProfile = document.querySelector('.user-profile');
            var notificationBtn = document.querySelector('.notification-btn');
            var notificationPanel = document.getElementById('notificationsPanel');

            if (userProfile && !userProfile.contains(e.target)) closeUserDropdown();
            if (notificationBtn && notificationPanel &&
                !notificationBtn.contains(e.target) &&
                !notificationPanel.contains(e.target)) {
                closeNotifications();
            }
        });

        // Close on escape key
        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape') {
                closeNotifications();
                closeUserDropdown();
                closeMobileSidebar();
            }
        });

        // Resize handler
        var resizeTimer;
        window.addEventListener('resize', function () {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(function () {
                if (window.innerWidth > 968) {
                    closeMobileSidebar();
                    // Restore header left based on sidebar state
                    var sidebar = document.getElementById('sidebar');
                    var header = document.getElementById('topHeader');
                    if (sidebar && header) {
                        header.style.left = sidebar.classList.contains('collapsed') ? '70px' : '240px';
                    }
                }
            }, 150);
        });

        // Handle window resize for responsive behavior
        window.addEventListener('resize', function() {
            const sidebar = document.getElementById('sidebar');
            const headerContainer = document.getElementById('topHeader');
            const mainContent = document.getElementById('mainContent');
            
            if (window.innerWidth <= 968) {
                if (sidebar) sidebar.classList.remove('collapsed');
                if (mainContent) mainContent.classList.remove('expanded');
                if (headerContainer) {
                    headerContainer.style.left = '0';
                }
            }
        });

        /* ==================== AGENT VIEW FUNCTIONS ==================== */
        
        function openTab(evt, tabName) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            evt.currentTarget.classList.add('active');
        }
        
        function generateCert() { alert('Generating certificate via AI...'); }
        function deleteAgent() { if(confirm('Delete agent?')) { alert('Deleted!'); window.location.href = 'manage-agents'; } }
        function deletePolicy(btn) { if(confirm('Remove this policy from agent?')) btn.closest('.policy-card').remove(); }
        
        window.addEventListener('load', () => {
            // Check if a specific tab should be opened via URL parameter
            const urlParams = new URLSearchParams(window.location.search);
            const tabToOpen = urlParams.get('tab');
            if (tabToOpen) {
                const tabBtn = document.querySelector(`button[onclick*="'${tabToOpen}'"]`);
                if (tabBtn) {
                    // Create a mock event object
                    const mockEvent = { currentTarget: tabBtn };
                    openTab(mockEvent, tabToOpen);
                }
            }
            
            // Modern Doughnut Chart
            const pieCtx = document.getElementById('appPieChart');
            if (pieCtx) {
                new Chart(pieCtx, { 
                    type: 'doughnut', 
                    data: { 
                        labels: ['Dev Tools', 'Browsers', 'Communication', 'Productivity'], 
                        datasets: [{ 
                            data: [35, 28, 18, 12], 
                            backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#8b5cf6'],
                            borderWidth: 6,
                            borderColor: '#ffffff',
                            borderRadius: 0,
                            spacing: 0
                        }] 
                    }, 
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: true,
                        cutout: '65%',
                        plugins: { 
                            legend: { display: false },
                            tooltip: {
                                enabled: true,
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                padding: 10,
                                cornerRadius: 6,
                                titleFont: { size: 12 },
                                bodyFont: { size: 11 },
                                callbacks: {
                                    label: function(context) {
                                        return context.label + ': ' + context.parsed + '%';
                                    }
                                }
                            }
                        }
                    } 
                });
            }
            
            // Smooth Line Chart with gradient fill
            const lineCtx = document.getElementById('appLineChart');
            if (lineCtx) {
                const gradientBlue = lineCtx.getContext('2d').createLinearGradient(0, 0, 0, 300);
                gradientBlue.addColorStop(0, 'rgba(59, 130, 246, 0.15)');
                gradientBlue.addColorStop(1, 'rgba(59, 130, 246, 0)');
                
                const gradientGreen = lineCtx.getContext('2d').createLinearGradient(0, 0, 0, 300);
                gradientGreen.addColorStop(0, 'rgba(16, 185, 129, 0.15)');
                gradientGreen.addColorStop(1, 'rgba(16, 185, 129, 0)');
                
                new Chart(lineCtx, { 
                    type: 'line', 
                    data: { 
                        labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'], 
                        datasets: [
                            { 
                                label: 'VS Code', 
                                data: [5.2, 6.1, 5.8, 6.5, 5.9, 2.1, 0.3], 
                                borderColor: '#3b82f6', 
                                backgroundColor: gradientBlue,
                                tension: 0.4,
                                fill: true,
                                borderWidth: 2.5,
                                pointRadius: 4,
                                pointHoverRadius: 6,
                                pointBackgroundColor: '#3b82f6',
                                pointBorderColor: '#fff',
                                pointBorderWidth: 2
                            }, 
                            { 
                                label: 'Chrome', 
                                data: [4.8, 5.2, 6.3, 5.9, 6.8, 3.2, 1.5], 
                                borderColor: '#10b981',
                                backgroundColor: gradientGreen, 
                                tension: 0.4,
                                fill: true,
                                borderWidth: 2.5,
                                pointRadius: 4,
                                pointHoverRadius: 6,
                                pointBackgroundColor: '#10b981',
                                pointBorderColor: '#fff',
                                pointBorderWidth: 2
                            }
                        ] 
                    }, 
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false,
                        plugins: { 
                            legend: { 
                                display: true,
                                position: 'bottom',
                                labels: {
                                    padding: 12,
                                    font: { size: 11, weight: '500' },
                                    usePointStyle: true,
                                    pointStyle: 'circle',
                                    boxWidth: 8,
                                    boxHeight: 8
                                }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                padding: 10,
                                cornerRadius: 6,
                                titleFont: { size: 12 },
                                bodyFont: { size: 11 }
                            }
                        }, 
                        scales: { 
                            y: { 
                                beginAtZero: true,
                                max: 7,
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.04)',
                                    drawBorder: false
                                },
                                ticks: {
                                    font: { size: 10 },
                                    color: '#9ca3af',
                                    padding: 8,
                                    callback: function(value) {
                                        return value + 'h';
                                    }
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    font: { size: 10 },
                                    color: '#9ca3af',
                                    padding: 8
                                }
                            }
                        },
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        }
                    } 
                });
            }
        });

        /* ---- Modal helpers ---- */
        function openModal(id) { document.getElementById(id).classList.add('show'); document.body.style.overflow='hidden'; }
        function closeModal(id) { document.getElementById(id).classList.remove('show'); document.body.style.overflow=''; }
        document.querySelectorAll('.modal-overlay').forEach(function(m){ m.addEventListener('click', function(e){ if(e.target===m) closeModal(m.id); }); });

        /* ---- Blocked URL actions ---- */
        function openAddBurlModal() { 
            document.getElementById('burl_pattern').value=''; 
            document.getElementById('burl_reason').value=''; 
            document.getElementById('burl_category').value=''; 
            document.getElementById('burl_scope').selectedIndex=0; 
            document.getElementById('burl_active').checked=true; 
            openModal('addBurlModal'); 
        }
        
        function saveBurl() {
            var pattern = document.getElementById('burl_pattern').value.trim();
            if (!pattern) { alert('URL Pattern is required'); return; }
            var category = document.getElementById('burl_category').value || 'Other';
            var scope = document.getElementById('burl_scope').value;
            var scopeClass = scope.includes('Global') ? 'global' : 'device';
            var scopeLabel = scope.includes('Global') ? 'Global' : 'Device: This';
            var tbody = document.getElementById('burlTbody');
            var row = document.createElement('tr');
            row.innerHTML = '<td><div class="burl-url-name">'+pattern+'</div><div class="burl-url-reason">'+document.getElementById('burl_reason').value+'</div></td>'
                +'<td class="burl-domain">'+pattern+'</td>'
                +'<td><span class="burl-tag entertainment">'+category+'</span></td>'
                +'<td><span class="burl-scope '+scopeClass+'">'+scopeLabel+'</span></td>'
                +'<td><span class="burl-status active">Active</span></td>'
                +'<td class="burl-date">Just now</td>'
                +'<td><div class="burl-actions"><button class="burl-action-btn edit" title="Edit" onclick="openEditBurlModal(this)"><i class="fas fa-pen"></i></button><button class="burl-action-btn delete" title="Delete" onclick="deleteBurlRow(this)"><i class="fas fa-trash"></i></button></div></td>';
            tbody.appendChild(row);
            closeModal('addBurlModal');
        }
        
        function deleteBurlRow(btn) { if(confirm('Delete this blocked URL?')) btn.closest('tr').remove(); }
        
        var _editBurlRow = null;
        function openEditBurlModal(btn) {
            _editBurlRow = btn.closest('tr');
            var cells = _editBurlRow.querySelectorAll('td');
            var urlName = cells[0].querySelector('.burl-url-name');
            var urlReason = cells[0].querySelector('.burl-url-reason');
            document.getElementById('edit_burl_pattern').value = urlName ? urlName.textContent.trim() : '';
            document.getElementById('edit_burl_reason').value = urlReason ? urlReason.textContent.trim() : '';
            var catTag = cells[2].querySelector('.burl-tag');
            var catText = catTag ? catTag.textContent.trim() : '';
            var catSel = document.getElementById('edit_burl_category');
            for (var i = 0; i < catSel.options.length; i++) {
                if (catSel.options[i].text.toLowerCase() === catText.toLowerCase()) { catSel.selectedIndex = i; break; }
            }
            var scopeEl = cells[3].querySelector('.burl-scope');
            var scopeText = scopeEl ? scopeEl.textContent.trim() : '';
            var scopeSel = document.getElementById('edit_burl_scope');
            scopeSel.selectedIndex = scopeText.toLowerCase().includes('global') ? 0 : scopeText.toLowerCase().includes('user') ? 2 : 1;
            var statusEl = cells[4].querySelector('.burl-status');
            document.getElementById('edit_burl_active').checked = statusEl ? statusEl.textContent.trim().toLowerCase() === 'active' : true;
            openModal('editBurlModal');
        }
        
        function updateBurl() {
            var pattern = document.getElementById('edit_burl_pattern').value.trim();
            if (!pattern) { alert('URL Pattern is required'); return; }
            if (!_editBurlRow) return;
            var cells = _editBurlRow.querySelectorAll('td');
            var category = document.getElementById('edit_burl_category').value || 'Other';
            var scopeVal = document.getElementById('edit_burl_scope').value;
            var scopeClass = scopeVal.includes('Global') ? 'global' : scopeVal.includes('User') ? 'user' : 'device';
            var scopeLabel = scopeVal.includes('Global') ? 'Global' : scopeVal.includes('User') ? 'User' : 'Device: This';
            var isActive = document.getElementById('edit_burl_active').checked;
            cells[0].querySelector('.burl-url-name').textContent = pattern;
            cells[0].querySelector('.burl-url-reason').textContent = document.getElementById('edit_burl_reason').value;
            cells[1].textContent = pattern;
            cells[2].innerHTML = '<span class="burl-tag entertainment">' + category + '</span>';
            cells[3].innerHTML = '<span class="burl-scope ' + scopeClass + '">' + scopeLabel + '</span>';
            cells[4].innerHTML = '<span class="burl-status ' + (isActive ? 'active' : 'inactive') + '">' + (isActive ? 'Active' : 'Inactive') + '</span>';
            closeModal('editBurlModal');
        }

        /* ---- Partial Access actions ---- */
        function openAddPaModal() { 
            document.getElementById('pa_pattern').value=''; 
            document.getElementById('pa_reason').value=''; 
            document.getElementById('pa_category').value=''; 
            document.getElementById('pa_scope').selectedIndex=0; 
            document.getElementById('pa_active').checked=true; 
            openModal('addPaModal'); 
        }
        
        function savePa() {
            var pattern = document.getElementById('pa_pattern').value.trim();
            if (!pattern) { alert('URL Pattern is required'); return; }
            var category = document.getElementById('pa_category').value || 'Work';
            var scope = document.getElementById('pa_scope').value;
            var scopeClass = scope.includes('Global') ? 'global' : 'device';
            var scopeLabel = scope.includes('Global') ? 'Global' : 'Device: This';
            var monitor = document.getElementById('pa_monitor').value;
            var tbody = document.getElementById('paTbody');
            var row = document.createElement('tr');
            row.innerHTML = '<td><div class="burl-url-name">'+pattern+'</div><div class="burl-url-reason">'+document.getElementById('pa_reason').value+'</div></td>'
                +'<td class="burl-domain">'+pattern+'</td>'
                +'<td><span class="burl-tag monitor">'+monitor+'</span></td>'
                +'<td><span class="burl-tag work">'+category+'</span></td>'
                +'<td><span class="burl-scope '+scopeClass+'">'+scopeLabel+'</span></td>'
                +'<td><span class="burl-status active">Active</span></td>'
                +'<td class="burl-date">Just now</td>'
                +'<td><div class="burl-actions"><button class="burl-action-btn edit" title="Edit" onclick="openEditPaModal(this)"><i class="fas fa-pen"></i></button><button class="burl-action-btn delete" title="Delete" onclick="deletePaRow(this)"><i class="fas fa-trash"></i></button></div></td>';
            tbody.appendChild(row);
            closeModal('addPaModal');
        }
        
        function deletePaRow(btn) { if(confirm('Delete this partial access site?')) btn.closest('tr').remove(); }
        
        var _editPaRow = null;
        function openEditPaModal(btn) {
            _editPaRow = btn.closest('tr');
            var cells = _editPaRow.querySelectorAll('td');
            var urlName = cells[0].querySelector('.burl-url-name');
            var urlReason = cells[0].querySelector('.burl-url-reason');
            document.getElementById('edit_pa_pattern').value = urlName ? urlName.textContent.trim() : '';
            document.getElementById('edit_pa_reason').value = urlReason ? urlReason.textContent.trim() : '';
            var monTag = cells[2].querySelector('.burl-tag');
            var monText = monTag ? monTag.textContent.trim() : '';
            var monSel = document.getElementById('edit_pa_monitor');
            for (var i = 0; i < monSel.options.length; i++) {
                if (monSel.options[i].text.toLowerCase().includes(monText.toLowerCase().split(' ')[0])) { monSel.selectedIndex = i; break; }
            }
            var catTag = cells[3].querySelector('.burl-tag');
            var catText = catTag ? catTag.textContent.trim() : '';
            var catSel = document.getElementById('edit_pa_category');
            for (var i = 0; i < catSel.options.length; i++) {
                if (catSel.options[i].text.toLowerCase() === catText.toLowerCase()) { catSel.selectedIndex = i; break; }
            }
            var scopeEl = cells[4].querySelector('.burl-scope');
            var scopeText = scopeEl ? scopeEl.textContent.trim() : '';
            var scopeSel = document.getElementById('edit_pa_scope');
            scopeSel.selectedIndex = scopeText.toLowerCase().includes('global') ? 0 : scopeText.toLowerCase().includes('user') ? 2 : 1;
            var statusEl = cells[5].querySelector('.burl-status');
            document.getElementById('edit_pa_active').checked = statusEl ? statusEl.textContent.trim().toLowerCase() === 'active' : true;
            openModal('editPaModal');
        }
        
        function updatePa() {
            var pattern = document.getElementById('edit_pa_pattern').value.trim();
            if (!pattern) { alert('URL Pattern is required'); return; }
            if (!_editPaRow) return;
            var cells = _editPaRow.querySelectorAll('td');
            var category = document.getElementById('edit_pa_category').value || 'Work';
            var scopeVal = document.getElementById('edit_pa_scope').value;
            var scopeClass = scopeVal.includes('Global') ? 'global' : scopeVal.includes('User') ? 'user' : 'device';
            var scopeLabel = scopeVal.includes('Global') ? 'Global' : scopeVal.includes('User') ? 'User' : 'Device: This';
            var monitor = document.getElementById('edit_pa_monitor').value;
            var isActive = document.getElementById('edit_pa_active').checked;
            cells[0].querySelector('.burl-url-name').textContent = pattern;
            cells[0].querySelector('.burl-url-reason').textContent = document.getElementById('edit_pa_reason').value;
            cells[1].textContent = pattern;
            cells[2].innerHTML = '<span class="burl-tag monitor">' + monitor + '</span>';
            cells[3].innerHTML = '<span class="burl-tag work">' + category + '</span>';
            cells[4].innerHTML = '<span class="burl-scope ' + scopeClass + '">' + scopeLabel + '</span>';
            cells[5].innerHTML = '<span class="burl-status ' + (isActive ? 'active' : 'inactive') + '">' + (isActive ? 'Active' : 'Inactive') + '</span>';
            closeModal('editPaModal');
        }

        /* ---- Filter helpers ---- */
        function filterBurlTable() {
            var q = document.getElementById('burlSearch').value.toLowerCase();
            var st = document.getElementById('burlStatusFilter').value.toLowerCase();
            var sc = document.getElementById('burlScopeFilter').value.toLowerCase();
            document.querySelectorAll('#burlTbody tr').forEach(function(r){
                var txt = r.textContent.toLowerCase();
                r.style.display = (txt.includes(q) && (!st||txt.includes(st)) && (!sc||txt.includes(sc))) ? '' : 'none';
            });
        }
        
        function filterPaTable() {
            var q = document.getElementById('paSearch').value.toLowerCase();
            var st = document.getElementById('paStatusFilter').value.toLowerCase();
            var sc = document.getElementById('paScopeFilter').value.toLowerCase();
            document.querySelectorAll('#paTbody tr').forEach(function(r){
                var txt = r.textContent.toLowerCase();
                r.style.display = (txt.includes(q) && (!st||txt.includes(st)) && (!sc||txt.includes(sc))) ? '' : 'none';
            });
        }

        // Initialize on DOM ready
        document.addEventListener('DOMContentLoaded', function() {
            setActiveMenuItem();
<!--            loadAdminInfo();-->

            setTimeout(() => {
                const agentId = getAgentIdFromUrl();
                if (agentId) {
                    loadAgentPolicies(agentId);
                } else {
                    console.warn('Could not determine agent ID for loading policies');
                }
            }, 500); // Small delay to ensure DOM is ready

        });
    </script>
</body>
</html>