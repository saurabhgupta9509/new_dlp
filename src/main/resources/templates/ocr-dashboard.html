<!-- <!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DLP Shield - OCR & Image Analysis</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background: #f3f4f6;
        overflow-x: hidden;
      }

      .dashboard-container {
        display: flex;
        min-height: 100vh;
        max-width: 100vw;
        overflow-x: hidden;
      }

      .main-content {
        flex: 1;
        margin-left: 240px;
        transition: margin-left 0.3s ease;
        min-height: 100vh;
        max-width: calc(100vw - 240px);
        overflow-x: hidden;
      }

      .main-content.expanded {
        margin-left: 70px;
        max-width: calc(100vw - 70px);
      }

      .content-area {
        padding: 24px;
        padding-top: 100px;
        max-width: 1400px;
        margin: 0 auto;
      }

      /* ================ SIDEBAR STYLES ================ */
      .sidebar {
        width: 240px;
        background: linear-gradient(180deg, #1e40af 0%, #1e3a8a 100%);
        color: white;
        position: fixed;
        height: 100vh;
        display: flex;
        flex-direction: column;
        transition: width 0.3s ease;
        z-index: 1000;
        left: 0;
        top: 0;
        overflow: hidden;
      }

      .sidebar::-webkit-scrollbar {
        width: 4px;
      }

      .sidebar::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.3);
        border-radius: 4px;
      }

      .sidebar-header {
        padding: 18px 16px;
        display: flex;
        align-items: center;
        gap: 10px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        flex-shrink: 0;
      }

      .sidebar-logo {
        width: 38px;
        height: 38px;
        background: white;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
      }

      .sidebar-logo i {
        font-size: 20px;
        color: #2563eb;
      }

      .sidebar-title {
        font-size: 1.2em;
        font-weight: 700;
        white-space: nowrap;
        transition: opacity 0.2s, width 0.3s;
        overflow: hidden;
      }

      .nav-menu {
        padding: 12px 0;
        overflow-y: auto;
        overflow-x: hidden;
        flex: 1;
      }

      .nav-item {
        margin: 2px 8px;
      }

      .nav-link {
        display: flex;
        align-items: center;
        padding: 10px 12px;
        color: rgba(255, 255, 255, 0.8);
        text-decoration: none;
        border-radius: 8px;
        transition: all 0.2s;
        font-size: 0.9em;
        cursor: pointer;
        white-space: nowrap;
      }

      .nav-link:hover {
        background: rgba(255, 255, 255, 0.1);
        color: white;
      }

      .nav-link.active,
      .sub-menu-item.active {
        background: rgba(255, 255, 255, 0.15);
        color: white;
        font-weight: 600;
      }

      .nav-link i:first-child {
        width: 20px;
        font-size: 0.95em;
        margin-right: 10px;
        flex-shrink: 0;
      }

      .chevron-icon {
        margin-left: auto !important;
        font-size: 0.7em !important;
        transition: transform 0.3s;
        width: auto !important;
        flex-shrink: 0;
      }

      .nav-link.expanded .chevron-icon {
        transform: rotate(180deg);
      }

      .sub-menu {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease;
      }

      .sub-menu.open {
        max-height: 500px;
      }

      .sub-menu-item {
        display: flex;
        align-items: center;
        padding: 8px 12px 8px 42px;
        color: rgba(255, 255, 255, 0.7);
        text-decoration: none;
        font-size: 0.85em;
        transition: all 0.2s;
        border-radius: 8px;
        margin: 2px 0;
        white-space: nowrap;
      }

      .sub-menu-item:hover {
        color: white;
        background: rgba(255, 255, 255, 0.08);
      }

      .sub-menu-item::before {
        content: "â€¢";
        margin-right: 10px;
        font-size: 1.2em;
      }

      .sidebar-footer {
        padding: 12px 16px;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        flex-shrink: 0;
      }

      .collapse-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 10px;
        background: rgba(255, 255, 255, 0.1);
        border: none;
        color: white;
        border-radius: 8px;
        cursor: pointer;
        width: 100%;
        font-size: 0.85em;
        transition: all 0.2s;
        white-space: nowrap;
        overflow: hidden;
      }

      .collapse-btn:hover {
        background: rgba(255, 255, 255, 0.15);
      }

      .collapse-btn i {
        transition: transform 0.3s;
        flex-shrink: 0;
      }

      /* Sidebar collapsed state */
      .sidebar.collapsed {
        width: 70px;
      }

      .sidebar.collapsed .sidebar-title {
        opacity: 0;
        width: 0;
      }

      .sidebar.collapsed .nav-link span,
      .sidebar.collapsed .collapse-btn span {
        display: none;
      }

      .sidebar.collapsed .sub-menu {
        display: none !important;
      }

      .sidebar.collapsed .nav-link {
        justify-content: center;
        padding: 10px;
      }

      .sidebar.collapsed .nav-link i:first-child {
        margin-right: 0;
      }

      .sidebar.collapsed .chevron-icon {
        display: none;
      }

      .sidebar.collapsed .collapse-btn {
        justify-content: center;
      }

      .sidebar.collapsed .collapse-btn i {
        transform: rotate(180deg);
      }

      /* Mobile Overlay */
      .sidebar-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 999;
        opacity: 0;
        transition: opacity 0.3s;
      }

      .sidebar-overlay.active {
        display: block;
        opacity: 1;
      }

      /* ================ HEADER STYLES ================ */
      .top-header {
        background: white;
        padding: 14px 24px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        border-bottom: 1px solid #e5e7eb;
        position: fixed;
        top: 0;
        left: 240px;
        right: 0;
        z-index: 500;
        gap: 16px;
        transition: left 0.3s ease;
      }

      .mobile-menu-toggle {
        display: none;
        background: none;
        border: none;
        color: #6b7280;
        font-size: 1.3em;
        cursor: pointer;
        padding: 8px;
        transition: color 0.2s;
      }

      .mobile-menu-toggle:hover {
        color: #111827;
      }

      .search-bar {
        flex: 1;
        max-width: 400px;
        position: relative;
      }

      .search-bar i {
        position: absolute;
        left: 14px;
        top: 50%;
        transform: translateY(-50%);
        color: #9ca3af;
        font-size: 0.9em;
      }

      .search-input {
        width: 100%;
        padding: 9px 14px 9px 38px;
        border: 1.5px solid #e5e7eb;
        border-radius: 8px;
        font-size: 0.9em;
        background: #f9fafb;
        transition: all 0.3s ease;
      }

      .search-input:focus {
        outline: none;
        border-color: #3b82f6;
        background: white;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }

      .header-actions {
        display: flex;
        align-items: center;
        gap: 16px;
      }

      .notification-btn {
        position: relative;
        background: none;
        border: none;
        color: #6b7280;
        font-size: 1.1em;
        cursor: pointer;
        padding: 8px;
        transition: all 0.2s;
        border-radius: 8px;
      }

      .notification-btn:hover {
        color: #111827;
        background: #f3f4f6;
      }

      .notification-btn.active {
        color: #2563eb;
        background: #eff6ff;
      }

      .notification-badge {
        position: absolute;
        top: 4px;
        right: 4px;
        background: #ef4444;
        color: white;
        font-size: 0.65em;
        min-width: 18px;
        height: 18px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        padding: 0 4px;
      }

      .user-profile {
        display: flex;
        align-items: center;
        gap: 10px;
        cursor: pointer;
        padding: 6px 10px;
        border-radius: 8px;
        transition: background 0.2s;
        position: relative;
      }

      .user-profile:hover {
        background: #f3f4f6;
      }

      .user-avatar {
        width: 36px;
        height: 36px;
        background: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        font-size: 0.9em;
        flex-shrink: 0;
      }

      .user-info {
        display: flex;
        flex-direction: column;
      }

      .user-name {
        font-size: 0.9em;
        font-weight: 600;
        color: #111827;
      }

      .user-role {
        font-size: 0.75em;
        color: #6b7280;
      }

      .dropdown-icon {
        color: #6b7280;
        font-size: 0.75em;
        margin-left: 4px;
        transition: transform 0.3s;
      }

      .user-profile.active .dropdown-icon {
        transform: rotate(180deg);
      }

      .user-dropdown {
        position: absolute;
        top: 100%;
        right: 0;
        margin-top: 8px;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07),
          0 10px 15px rgba(0, 0, 0, 0.1);
        min-width: 200px;
        opacity: 0;
        visibility: hidden;
        transform: translateY(-10px);
        transition: all 0.3s ease;
        z-index: 1000;
      }

      .user-dropdown.show {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
      }

      .dropdown-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 14px;
        color: #374151;
        text-decoration: none;
        font-size: 0.9em;
        transition: background 0.2s;
      }

      .dropdown-item:first-child {
        border-radius: 8px 8px 0 0;
      }

      .dropdown-item:last-child {
        border-radius: 0 0 8px 8px;
      }

      .dropdown-item:hover {
        background: #f3f4f6;
      }

      .dropdown-item i {
        width: 18px;
        color: #6b7280;
        font-size: 0.95em;
      }

      .dropdown-item.danger {
        color: #dc2626;
      }

      .dropdown-item.danger i {
        color: #dc2626;
      }

      .dropdown-divider {
        height: 1px;
        background: #e5e7eb;
        margin: 4px 0;
      }

      /* ================ NOTIFICATIONS PANEL ================ */
      .notifications-panel {
        position: fixed;
        top: 0;
        right: -50%;
        width: 50%;
        max-width: 600px;
        height: 100vh;
        background: white;
        box-shadow: -4px 0 15px rgba(0, 0, 0, 0.1);
        z-index: 1001;
        display: flex;
        flex-direction: column;
        transition: right 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .notifications-panel.show {
        right: 0;
      }

      .notifications-header {
        padding: 20px 24px;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
      }

      .notifications-header h3 {
        font-size: 1.2em;
        font-weight: 700;
        color: #111827;
      }

      .close-notifications {
        background: none;
        border: none;
        color: #6b7280;
        font-size: 1.2em;
        cursor: pointer;
        padding: 6px;
        border-radius: 6px;
        transition: all 0.2s;
      }

      .close-notifications:hover {
        background: #f3f4f6;
        color: #111827;
      }

      .notifications-tabs {
        display: flex;
        border-bottom: 1px solid #e5e7eb;
        padding: 0 24px;
        flex-shrink: 0;
      }

      .tab-btn {
        flex: 1;
        padding: 12px;
        background: none;
        border: none;
        color: #6b7280;
        font-size: 0.9em;
        font-weight: 500;
        cursor: pointer;
        border-bottom: 2px solid transparent;
        transition: all 0.2s;
      }

      .tab-btn:hover {
        color: #111827;
      }

      .tab-btn.active {
        color: #2563eb;
        border-bottom-color: #2563eb;
      }

      .notifications-content {
        flex: 1;
        overflow-y: auto;
        padding: 12px 0;
      }

      .notifications-content::-webkit-scrollbar {
        width: 6px;
      }

      .notifications-content::-webkit-scrollbar-thumb {
        background: #d1d5db;
        border-radius: 3px;
      }

      .notification-item {
        display: flex;
        gap: 12px;
        padding: 14px 24px;
        cursor: pointer;
        transition: background 0.2s;
        border-left: 3px solid transparent;
      }

      .notification-item:hover {
        background: #f9fafb;
      }

      .notification-item.unread {
        background: #eff6ff;
        border-left-color: #3b82f6;
      }

      .notification-item.unread:hover {
        background: #dbeafe;
      }

      .notification-icon {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.1em;
        flex-shrink: 0;
      }

      .notification-icon.critical {
        background: #fee2e2;
        color: #dc2626;
      }

      .notification-icon.warning {
        background: #fef3c7;
        color: #f59e0b;
      }

      .notification-icon.info {
        background: #dbeafe;
        color: #3b82f6;
      }

      .notification-icon.success {
        background: #d1fae5;
        color: #10b981;
      }

      .notification-body {
        flex: 1;
      }

      .notification-title {
        font-size: 0.9em;
        font-weight: 600;
        color: #111827;
        margin-bottom: 4px;
      }

      .notification-text {
        font-size: 0.85em;
        color: #6b7280;
        margin-bottom: 6px;
        line-height: 1.4;
      }

      .notification-time {
        font-size: 0.75em;
        color: #9ca3af;
      }

      .notification-dot {
        width: 8px;
        height: 8px;
        background: #3b82f6;
        border-radius: 50%;
        flex-shrink: 0;
        margin-top: 8px;
      }

      .notification-item:not(.unread) .notification-dot {
        display: none;
      }

      .notifications-footer {
        padding: 16px 24px;
        border-top: 1px solid #e5e7eb;
        flex-shrink: 0;
      }

      .view-all-btn {
        display: block;
        width: 100%;
        padding: 10px;
        background: #f3f4f6;
        color: #2563eb;
        text-align: center;
        text-decoration: none;
        border-radius: 8px;
        font-size: 0.9em;
        font-weight: 600;
        transition: all 0.2s;
      }

      .view-all-btn:hover {
        background: #e5e7eb;
      }

      .notification-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.4);
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
      }

      .notification-overlay.show {
        opacity: 1;
        visibility: visible;
      }

      /* OCR Page Styles */
      .page-header {
        background: white;
        padding: 20px 24px;
        border-radius: 12px;
        border: 1px solid #e5e7eb;
        margin-bottom: 24px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .page-title-section {
        display: flex;
        align-items: center;
        gap: 16px;
      }

      .page-icon {
        width: 48px;
        height: 48px;
        background: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .page-icon i {
        font-size: 22px;
        color: white;
      }

      .page-title-text h1 {
        font-size: 1.5em;
        color: #111827;
        font-weight: 700;
      }

      .page-subtitle {
        color: #6b7280;
        font-size: 0.9em;
      }

      .refresh-btn {
        padding: 10px 18px;
        background: #2563eb;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 0.9em;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s;
      }

      .refresh-btn:hover {
        background: #1d4ed8;
      }

      .refresh-btn:disabled {
        background: #9ca3af;
        cursor: not-allowed;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 16px;
        margin-bottom: 24px;
      }

      .stat-card {
        background: white;
        padding: 18px;
        border-radius: 12px;
        border: 1px solid #e5e7eb;
      }

      .stat-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 10px;
      }

      .stat-label {
        font-size: 0.8em;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 8px;
      }

      .stat-value {
        font-size: 1.7em;
        font-weight: 700;
        color: #111827;
      }

      .stat-icon {
        width: 42px;
        height: 42px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1em;
      }

      .stat-icon.blue {
        background: #dbeafe;
        color: #3b82f6;
      }

      .stat-icon.green {
        background: #d1fae5;
        color: #10b981;
      }

      .stat-icon.red {
        background: #fee2e2;
        color: #dc2626;
      }

      .stat-icon.yellow {
        background: #fef3c7;
        color: #f59e0b;
      }

      .stat-subtitle {
        font-size: 0.8em;
        color: #10b981;
        font-weight: 600;
      }

      .stat-subtitle.warning {
        color: #dc2626;
      }

      .content-grid {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
      }

      .card {
        background: white;
        padding: 20px;
        border-radius: 12px;
        border: 1px solid #e5e7eb;
      }

      .card-header {
        font-size: 1.05em;
        font-weight: 600;
        color: #111827;
        margin-bottom: 16px;
        padding-bottom: 12px;
        border-bottom: 1px solid #e5e7eb;
      }

      .agent-table {
        width: 100%;
        border-collapse: collapse;
      }

      .agent-table thead {
        background: #f9fafb;
      }

      .agent-table th {
        padding: 10px 12px;
        text-align: left;
        font-size: 0.75em;
        font-weight: 600;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border-bottom: 1px solid #e5e7eb;
      }

      .agent-table td {
        padding: 12px 12px;
        font-size: 0.85em;
        color: #374151;
        border-bottom: 1px solid #f3f4f6;
      }

      .agent-table tbody tr {
        cursor: pointer;
        transition: background 0.2s;
      }

      .agent-table tbody tr:hover {
        background: #f9fafb;
      }

      .status-dot {
        display: inline-block;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        margin-right: 6px;
      }

      .status-dot.active {
        background: #10b981;
      }

      .status-dot.inactive {
        background: #9ca3af;
      }

      .threat-bar {
        width: 100%;
        height: 6px;
        background: #e5e7eb;
        border-radius: 3px;
        overflow: hidden;
      }

      .threat-fill {
        height: 100%;
        background: linear-gradient(
          90deg,
          #10b981 0%,
          #f59e0b 50%,
          #dc2626 100%
        );
        transition: width 0.3s;
      }

      .violation-item {
        padding: 12px;
        background: #f9fafb;
        border-radius: 8px;
        margin-bottom: 10px;
        cursor: pointer;
        transition: all 0.2s;
      }

      .violation-item:hover {
        background: #f3f4f6;
        transform: translateX(2px);
      }

      .violation-item:last-child {
        margin-bottom: 0;
      }

      .violation-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 6px;
      }

      .violation-title {
        font-size: 0.9em;
        font-weight: 600;
        color: #111827;
      }

      .violation-time {
        font-size: 0.75em;
        color: #9ca3af;
      }

      .violation-details {
        font-size: 0.8em;
        color: #6b7280;
      }

      .violation-score {
        display: inline-block;
        padding: 3px 8px;
        border-radius: 4px;
        font-size: 0.75em;
        font-weight: 600;
        margin-top: 6px;
      }

      .score-high {
        background: #fee2e2;
        color: #dc2626;
      }

      .score-medium {
        background: #fef3c7;
        color: #f59e0b;
      }

      .score-low {
        background: #d1fae5;
        color: #059669;
      }

      /* Modal Styles */
      .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1001;
        animation: fadeIn 0.2s;
      }

      .modal-content {
        background: white;
        padding: 24px;
        border-radius: 12px;
        width: 90%;
        max-width: 500px;
        max-height: 80vh;
        overflow-y: auto;
        animation: slideUp 0.3s;
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
      }

      .modal-header h3 {
        margin: 0;
        font-size: 1.2em;
        color: #111827;
      }

      .modal-close {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #6b7280;
        transition: color 0.2s;
      }

      .modal-close:hover {
        color: #111827;
      }

      .modal-body {
        margin-bottom: 20px;
      }

      .modal-footer {
        display: flex;
        gap: 8px;
      }

      .modal-btn {
        flex: 1;
        padding: 10px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.2s;
      }

      .modal-btn-primary {
        background: #2563eb;
        color: white;
      }

      .modal-btn-primary:hover {
        background: #1d4ed8;
      }

      .modal-btn-secondary {
        background: #e5e7eb;
        color: #374151;
      }

      .modal-btn-secondary:hover {
        background: #d1d5db;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      @keyframes slideUp {
        from {
          transform: translateY(20px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      /* Enhanced Responsive Styles */
      @media (max-width: 1200px) {
        .content-grid {
          grid-template-columns: 1.5fr 1fr;
        }
      }

      @media (max-width: 968px) {
        .main-content {
          margin-left: 0;
          max-width: 100vw;
        }

        .top-header {
          left: 0;
        }

        .mobile-menu-toggle {
          display: block;
        }

        .sidebar {
          transform: translateX(-100%);
          transition: transform 0.3s ease;
        }

        .sidebar.mobile-open {
          transform: translateX(0);
        }

        .content-grid {
          grid-template-columns: 1fr;
        }

        .stats-grid {
          grid-template-columns: repeat(2, 1fr);
        }
      }

      @media (max-width: 768px) {
        .content-area {
          padding: 16px;
          padding-top: 80px;
        }

        .notifications-panel {
          width: 90%;
          right: -90%;
        }

        .page-header {
          flex-direction: column;
          align-items: flex-start;
          gap: 12px;
          padding: 16px;
        }

        .stats-grid {
          grid-template-columns: 1fr;
        }

        .page-title-section {
          width: 100%;
        }

        .refresh-btn {
          width: 100%;
          justify-content: center;
        }

        .user-info {
          display: none;
        }
      }

      @media (max-width: 640px) {
        .content-area {
          padding: 12px;
          padding-top: 70px;
        }

        .stat-card {
          padding: 14px;
        }

        .card {
          padding: 16px;
        }

        .agent-table td,
        .agent-table th {
          padding: 8px 10px;
          font-size: 0.8em;
        }

        .violation-item {
          padding: 10px;
        }

        .page-icon {
          width: 40px;
          height: 40px;
        }

        .page-icon i {
          font-size: 18px;
        }

        .page-title-text h1 {
          font-size: 1.3em;
        }

        .stat-value {
          font-size: 1.5em;
        }

        .stat-icon {
          width: 36px;
          height: 36px;
        }
      }
    </style>
  </head>
  <body>
    <div class="dashboard-container">
      <!-- ==================== SIDEBAR ==================== 
      <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
          <div class="sidebar-logo">
            <i class="fas fa-shield-halved"></i>
          </div>
          <div class="sidebar-title">DLP Shield</div>
        </div>

        <nav class="nav-menu">
          <div class="nav-item">
            <a href="dashboard.html" class="nav-link" data-page="dashboard">
              <i class="fas fa-th-large"></i>
              <span>Dashboard</span>
            </a>
          </div>

          <div class="nav-item">
            <a href="alerts.html" class="nav-link" data-page="alerts">
              <i class="fas fa-triangle-exclamation"></i>
              <span>Alerts &amp; Incidents</span>
            </a>
          </div>

          <div class="nav-item">
            <div class="nav-link nav-dropdown" onclick="toggleSubMenu(this)">
              <i class="fas fa-shield-alt"></i>
              <span>Policies</span>
              <i class="fas fa-chevron-down chevron-icon"></i>
            </div>
            <div class="sub-menu">
              <a
                href="manage-agents.html"
                class="sub-menu-item"
                data-page="manage-agents"
                >Manage Agents</a
              >
              <a
                href="file-policies.html"
                class="sub-menu-item"
                data-page="file-policies"
                >File Policies</a
              >
              <a
                href="assign-policy.html"
                class="sub-menu-item"
                data-page="assign-policy"
                >Assign Policy</a
              >
            </div>
          </div>

          <div class="nav-item">
            <a href="agents.html" class="nav-link" data-page="agents">
              <i class="fas fa-desktop"></i>
              <span>Agents / Endpoints</span>
            </a>
          </div>

          <div class="nav-item">
            <div class="nav-link nav-dropdown expanded" onclick="toggleSubMenu(this)">
              <i class="fas fa-eye"></i>
              <span>OCR &amp; Image Analysis</span>
              <i class="fas fa-chevron-down chevron-icon"></i>
            </div>
            <div class="sub-menu open">
              <a
                href="ocr-dashboard.html"
                class="sub-menu-item active"
                data-page="ocr-dashboard"
                >OCR Dashboard</a
              >
              <a
                href="ocr-policies.html"
                class="sub-menu-item"
                data-page="ocr-policies"
                >OCR Policies</a
              >
            </div>
          </div>

          <div class="nav-item">
            <div class="nav-link nav-dropdown" onclick="toggleSubMenu(this)">
              <i class="fas fa-file-lines"></i>
              <span>Reports &amp; Logs</span>
              <i class="fas fa-chevron-down chevron-icon"></i>
            </div>
            <div class="sub-menu">
              <a href="reports.html" class="sub-menu-item" data-page="reports"
                >Reports</a
              >
              <a
                href="generate-report.html"
                class="sub-menu-item"
                data-page="generate-report"
                >Generate Report</a
              >
              <a
                href="audit-logs.html"
                class="sub-menu-item"
                data-page="audit-logs"
                >Audit Logs</a
              >
              <a
                href="device-logs.html"
                class="sub-menu-item"
                data-page="device-logs"
                >Device Logs</a
              >
            </div>
          </div>

          <div class="nav-item">
            <div class="nav-link nav-dropdown" onclick="toggleSubMenu(this)">
              <i class="fas fa-users"></i>
              <span>Users &amp; Roles</span>
              <i class="fas fa-chevron-down chevron-icon"></i>
            </div>
            <div class="sub-menu">
              <a href="users.html" class="sub-menu-item" data-page="users"
                >Users</a
              >
              <a href="roles.html" class="sub-menu-item" data-page="roles"
                >Roles &amp; Permissions</a
              >
              <a
                href="permissions.html"
                class="sub-menu-item"
                data-page="permissions"
                >Permissions</a
              >
            </div>
          </div>

          <div class="nav-item">
            <div class="nav-link nav-dropdown" onclick="toggleSubMenu(this)">
              <i class="fas fa-gear"></i>
              <span>Settings</span>
              <i class="fas fa-chevron-down chevron-icon"></i>
            </div>
            <div class="sub-menu">
              <a href="general.html" class="sub-menu-item" data-page="general"
                >General</a
              >
              <a href="security.html" class="sub-menu-item" data-page="security"
                >Security</a
              >
              <a
                href="integrations.html"
                class="sub-menu-item"
                data-page="integrations"
                >Integrations</a
              >
              <a
                href="data-retention.html"
                class="sub-menu-item"
                data-page="data-retention"
                >Data Retention</a
              >
            </div>
          </div>
        </nav>

        <div class="sidebar-footer">
          <button class="collapse-btn" onclick="toggleSidebar()">
            <i class="fas fa-chevron-left"></i>
            <span>Collapse</span>
          </button>
        </div>
      </aside>

      <!-- Mobile Overlay (for sidebar)
      <div
        class="sidebar-overlay"
        id="sidebarOverlay"
        onclick="closeMobileSidebar()"
      ></div>

      <!-- ==================== HEADER ==================== 
      <header class="top-header" id="topHeader">
        <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">
          <i class="fas fa-bars"></i>
        </button>

        <div class="search-bar">
          <i class="fas fa-search"></i>
          <input
            type="text"
            class="search-input"
            placeholder="Search alerts, agents, policies..."
          />
        </div>

        <div class="header-actions">
          <button class="notification-btn" onclick="toggleNotifications(event)">
            <i class="fas fa-bell"></i>
            <span class="notification-badge" id="alertBadge">5</span>
          </button>

          <div class="user-profile" onclick="toggleUserDropdown(event)">
            <div class="user-avatar">A</div>
            <div class="user-info">
              <div class="user-name">Admin</div>
              <div class="user-role">Security Admin</div>
            </div>
            <i class="fas fa-chevron-down dropdown-icon"></i>

            <div class="user-dropdown" id="userDropdown">
              <a href="general.html" class="dropdown-item">
                <i class="fas fa-gear"></i>
                <span>Settings</span>
              </a>
              <a href="#" class="dropdown-item">
                <i class="fas fa-circle-question"></i>
                <span>Help &amp; Support</span>
              </a>
              <div class="dropdown-divider"></div>
              <a
                href="index.html"
                class="dropdown-item danger"
                onclick="logout(event)"
              >
                <i class="fas fa-right-from-bracket"></i>
                <span>Sign out</span>
              </a>
            </div>
          </div>
        </div>
      </header>

      <!-- ==================== NOTIFICATIONS PANEL ==================== 
      <div class="notifications-panel" id="notificationsPanel">
        <div class="notifications-header">
          <h3>Notifications</h3>
          <button class="close-notifications" onclick="closeNotifications()">
            <i class="fas fa-times"></i>
          </button>
        </div>

        <div class="notifications-tabs">
          <button class="tab-btn active" onclick="switchTab(event, 'all')">
            All (5)
          </button>
          <button class="tab-btn" onclick="switchTab(event, 'unread')">
            Unread (3)
          </button>
        </div>

        <div class="notifications-content" id="notificationsContent">
          <div class="notification-item unread">
            <div class="notification-icon critical">
              <i class="fas fa-shield-exclamation"></i>
            </div>
            <div class="notification-body">
              <div class="notification-title">Critical Policy Violation</div>
              <div class="notification-text">
                User attempted to copy sensitive files to USB drive
              </div>
              <div class="notification-time">2 minutes ago</div>
            </div>
            <div class="notification-dot"></div>
          </div>

          <div class="notification-item unread">
            <div class="notification-icon warning">
              <i class="fas fa-triangle-exclamation"></i>
            </div>
            <div class="notification-body">
              <div class="notification-title">Agent Offline</div>
              <div class="notification-text">
                DESKTOP-DEF456 has been offline for 2 hours
              </div>
              <div class="notification-time">15 minutes ago</div>
            </div>
            <div class="notification-dot"></div>
          </div>

          <div class="notification-item unread">
            <div class="notification-icon info">
              <i class="fas fa-info-circle"></i>
            </div>
            <div class="notification-body">
              <div class="notification-title">Policy Updated</div>
              <div class="notification-text">
                File Protection Policy has been modified by Admin
              </div>
              <div class="notification-time">1 hour ago</div>
            </div>
            <div class="notification-dot"></div>
          </div>

          <div class="notification-item">
            <div class="notification-icon success">
              <i class="fas fa-check-circle"></i>
            </div>
            <div class="notification-body">
              <div class="notification-title">Agent Connected</div>
              <div class="notification-text">
                New agent LAPTOP-XYZ789 successfully registered
              </div>
              <div class="notification-time">3 hours ago</div>
            </div>
          </div>

          <div class="notification-item">
            <div class="notification-icon info">
              <i class="fas fa-file-alt"></i>
            </div>
            <div class="notification-body">
              <div class="notification-title">Report Generated</div>
              <div class="notification-text">
                Weekly security report is ready for review
              </div>
              <div class="notification-time">5 hours ago</div>
            </div>
          </div>
        </div>

        <div class="notifications-footer">
          <a href="alerts.html" class="view-all-btn">View All Notifications</a>
        </div>
      </div>

      <!-- Notification Overlay 
      <div
        class="notification-overlay"
        id="notificationOverlay"
        onclick="closeNotifications()"
      ></div>

      <main class="main-content" id="mainContent">
        <div class="content-area">
          <div class="page-header">
            <div class="page-title-section">
              <div class="page-icon"><i class="fas fa-eye"></i></div>
              <div class="page-title-text">
                <h1>OCR & Image Analysis</h1>
                <p class="page-subtitle">
                  Monitor screen content and detect sensitive data
                </p>
              </div>
            </div>
            <button class="refresh-btn" onclick="refreshData()">
              <i class="fas fa-rotate"></i><span>Refresh (5s)</span>
            </button>
          </div>

          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-header">
                <div>
                  <div class="stat-label">OCR-Capable Agents</div>
                  <div class="stat-value" id="totalCapableAgents">0</div>
                </div>
                <div class="stat-icon blue"><i class="fas fa-desktop"></i></div>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-header">
                <div>
                  <div class="stat-label">Active OCR Agents</div>
                  <div class="stat-value" id="activeOcrAgents">0</div>
                </div>
                <div class="stat-icon green">
                  <i class="fas fa-chart-line"></i>
                </div>
              </div>
              <div class="stat-subtitle" id="coveragePercentage">0% coverage</div>
            </div>
            <div class="stat-card">
              <div class="stat-header">
                <div>
                  <div class="stat-label">High Threat Agents</div>
                  <div class="stat-value" id="highThreatCount">0</div>
                </div>
                <div class="stat-icon red">
                  <i class="fas fa-triangle-exclamation"></i>
                </div>
              </div>
              <div class="stat-subtitle warning">Threat score >70%</div>
            </div>
            <div class="stat-card">
              <div class="stat-header">
                <div>
                  <div class="stat-label">Violations (24h)</div>
                  <div class="stat-value" id="totalViolations24h">0</div>
                </div>
                <div class="stat-icon yellow"><i class="fas fa-bell"></i></div>
              </div>
              <div class="stat-subtitle" id="violationsTrend">Loading...</div>
            </div>
          </div>

          <div class="content-grid">
            <div class="card">
              <div class="card-header">OCR Agent Status</div>
              <table class="agent-table">
                <thead>
                  <tr>
                    <th>Agent</th>
                    <th>OCR Status</th>
                    <th>Threat Score</th>
                    <th>Last Screenshot</th>
                    <th>Violations</th>
                  </tr>
                </thead>
                <tbody id="agentTableBody">
                  <!-- Agent rows will be populated by JavaScript 
                </tbody>
              </table>
            </div>

            <div class="card">
              <div class="card-header">Recent Violations</div>
              <div id="recentViolationsList">
                <!-- Violations will be dynamically loaded here 
                <div class="loading-placeholder">
                  <div class="violation-item" style="opacity: 0.6">
                    <div class="violation-header">
                      <div class="violation-title">Loading...</div>
                      <div class="violation-time">--:--</div>
                    </div>
                    <div class="violation-details">
                      Fetching recent violations
                    </div>
                    <span class="violation-score score-low">0% confidence</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>

    <script>
      /* ==================== AUTHENTICATION & USER DATA ==================== */

      async function checkAuth() {
        try {
          const response = await fetch("/api/auth/check", {
            credentials: "include",
          });

          if (!response.ok) {
            throw new Error("Not authenticated");
          }

          const result = await response.json();

          if (!result.success) {
            window.location.href = "index.html";
            return null;
          }

          if (result.data) {
            localStorage.setItem("userData", JSON.stringify(result.data));
            return result.data;
          }

          return null;
        } catch (err) {
          window.location.href = "index.html";
          return null;
        }
      }

      // Load admin info into header
      function loadAdminInfo() {
        const userDataStr = localStorage.getItem("userData");

        if (userDataStr) {
          try {
            const userData = JSON.parse(userDataStr);

            const userName = document.querySelector(".user-name");
            const userAvatar = document.querySelector(".user-avatar");
            const userRole = document.querySelector(".user-role");

            if (userName) {
              const namePart = userData.username || "Admin";
              const formattedName = namePart
                .split(".")
                .map((n) => n.charAt(0).toUpperCase() + n.slice(1))
                .join(" ");
              userName.textContent = formattedName;
            }

            if (userAvatar) {
              const namePart = userData.username || "Admin";
              const initials = namePart
                .split(".")
                .map((n) => (n[0] ? n[0].toUpperCase() : ""))
                .join("");
              userAvatar.textContent = initials || "A";
            }

            if (userRole) {
              userRole.textContent = userData.role || "Security Admin";
            }
          } catch (e) {
            console.error("Error parsing user data:", e);
          }
        }
      }

      async function refreshUserData() {
        const userData = await checkAuth();
        if (userData) {
          localStorage.setItem("userData", JSON.stringify(userData));
          loadAdminInfo();
        }
      }

      // Refresh every 5 minutes
      setInterval(refreshUserData, 5 * 60 * 1000);

      /* ==================== SIDEBAR FUNCTIONS ==================== */

      function toggleSubMenu(element) {
        var sidebar = document.getElementById("sidebar");
        if (sidebar.classList.contains("collapsed")) return;

        var subMenu = element.nextElementSibling;
        var allSubMenus = document.querySelectorAll(".sub-menu");
        var allDropdowns = document.querySelectorAll(".nav-dropdown");

        // Close other open submenus
        allSubMenus.forEach(function (menu) {
          if (menu !== subMenu) menu.classList.remove("open");
        });
        allDropdowns.forEach(function (link) {
          if (link !== element) link.classList.remove("expanded");
        });

        // Toggle current
        element.classList.toggle("expanded");
        subMenu.classList.toggle("open");
      }

      function toggleSidebar() {
        var sidebar = document.getElementById("sidebar");
        var mainContent = document.getElementById("mainContent");
        var header = document.getElementById("topHeader");

        sidebar.classList.toggle("collapsed");
        var isCollapsed = sidebar.classList.contains("collapsed");

        if (mainContent) mainContent.classList.toggle("expanded");

        // Update header left position
        if (header) {
          header.style.left = isCollapsed ? "70px" : "240px";
        }

        // Close all submenus when collapsing
        if (isCollapsed) {
          document.querySelectorAll(".sub-menu").forEach(function (m) {
            m.classList.remove("open");
          });
          document.querySelectorAll(".nav-dropdown").forEach(function (l) {
            l.classList.remove("expanded");
          });
        }

        // Dispatch event for other components
        window.dispatchEvent(
          new CustomEvent("sidebarToggle", {
            detail: { collapsed: isCollapsed },
          })
        );
      }

      function openMobileSidebar() {
        var sidebar = document.getElementById("sidebar");
        var overlay = document.getElementById("sidebarOverlay");
        if (sidebar) sidebar.classList.add("mobile-open");
        if (overlay) overlay.classList.add("active");
      }

      function closeMobileSidebar() {
        var sidebar = document.getElementById("sidebar");
        var overlay = document.getElementById("sidebarOverlay");
        if (sidebar) sidebar.classList.remove("mobile-open");
        if (overlay) overlay.classList.remove("active");
      }

      function toggleMobileMenu() {
        var sidebar = document.getElementById("sidebar");
        var overlay = document.getElementById("sidebarOverlay");
        if (!sidebar) return;

        if (sidebar.classList.contains("mobile-open")) {
          closeMobileSidebar();
        } else {
          openMobileSidebar();
        }
      }

      function setActiveMenuItem() {
        var currentPage = window.location.pathname.split('/').pop() || 'ocr-dashboard.html';

        // First remove all active classes
        document.querySelectorAll('.nav-link, .sub-menu-item').forEach(function(el) {
          el.classList.remove('active');
        });

        // Handle sub-menu items
        document.querySelectorAll('.sub-menu-item[data-page]').forEach(function (item) {
          var href = item.getAttribute('href');
          if (href === currentPage) {
            item.classList.add('active');
            var parentSubMenu = item.closest('.sub-menu');
            if (parentSubMenu) {
              parentSubMenu.classList.add('open');
              var parentNav = parentSubMenu.previousElementSibling;
              if (parentNav) parentNav.classList.add('expanded');
            }
          }
        });

        // Handle main nav links
        document.querySelectorAll('.nav-link[data-page]').forEach(function (link) {
          var href = link.getAttribute('href');
          if (href === currentPage) {
            link.classList.add('active');
          }
        });
      }

      /* ==================== HEADER FUNCTIONS ==================== */

      function toggleNotifications(event) {
        event.stopPropagation();
        var panel = document.getElementById("notificationsPanel");
        var overlay = document.getElementById("notificationOverlay");
        var btn = event.currentTarget;
        if (!panel || !overlay) return;

        if (panel.classList.contains("show")) {
          closeNotifications();
        } else {
          closeUserDropdown();
          panel.classList.add("show");
          overlay.classList.add("show");
          btn.classList.add("active");
          document.body.style.overflow = "hidden";
        }
      }

      function closeNotifications() {
        var panel = document.getElementById("notificationsPanel");
        var overlay = document.getElementById("notificationOverlay");
        var btn = document.querySelector(".notification-btn");
        if (panel) panel.classList.remove("show");
        if (overlay) overlay.classList.remove("show");
        if (btn) btn.classList.remove("active");
        document.body.style.overflow = "";
      }

      function switchTab(event, tabName) {
        document.querySelectorAll(".tab-btn").forEach(function (t) {
          t.classList.remove("active");
        });
        event.currentTarget.classList.add("active");

        document
          .querySelectorAll(".notification-item")
          .forEach(function (item) {
            item.style.display =
              tabName === "unread" && !item.classList.contains("unread")
                ? "none"
                : "flex";
          });
      }

      function toggleUserDropdown(event) {
        event.stopPropagation();
        var dropdown = document.getElementById("userDropdown");
        var userProfile = event.currentTarget;
        if (!dropdown) return;

        if (dropdown.classList.contains("show")) {
          closeUserDropdown();
        } else {
          closeNotifications();
          dropdown.classList.add("show");
          userProfile.classList.add("active");
        }
      }

      function closeUserDropdown() {
        var dropdown = document.getElementById("userDropdown");
        var userProfile = document.querySelector(".user-profile");
        if (dropdown) dropdown.classList.remove("show");
        if (userProfile) userProfile.classList.remove("active");
      }

      function logout(event) {
        event.preventDefault();

        fetch("/api/auth/logout", {
          method: "POST",
          credentials: "include",
        }).finally(() => {
          localStorage.removeItem("isLoggedIn");
          localStorage.removeItem("userEmail");
          localStorage.removeItem("userData");
          window.location.href = "index.html";
        });
      }

      // Close dropdowns when clicking outside
      document.addEventListener("click", function (event) {
        if (!event.target.closest(".user-profile")) {
          closeUserDropdown();
        }
        if (
          !event.target.closest(".notification-btn") &&
          !event.target.closest(".notifications-panel")
        ) {
          closeNotifications();
        }
      });

      /* ==================== OCR DASHBOARD FUNCTIONS ==================== */

      // Global variables
      let ocrDashboardStats = {
        totalCapableAgents: 0,
        activeOcrAgents: 0,
        highThreatCount: 0,
        totalViolations24h: 0,
        coveragePercentage: 0,
        lastUpdated: null,
        summary: null,
        agents: [],
      };

      let autoRefreshInterval = null;

      // Safe element getter with null check
      function getElementSafe(id) {
        const element = document.getElementById(id);
        if (!element) {
          console.warn(`âš ï¸ Element with id "${id}" not found`);
        }
        return element;
      }

      // Update element text safely
      function updateElementText(id, text) {
        const element = getElementSafe(id);
        if (element) {
          element.textContent = text;
        }
      }

      async function callApi(path, options = {}) {
        const defaultOptions = {
          method: "GET",
          credentials: "include",
          headers: { "Content-Type": "application/json" },
        };

        const opts = { ...defaultOptions, ...options };

        try {
          const response = await fetch(path, opts);
          const text = await response.text();
          const json = text ? JSON.parse(text) : null;

          if (!response.ok) {
            throw new Error(json?.message || `HTTP ${response.status}`);
          }

          return json;
        } catch (error) {
          console.error(`API call to ${path} failed:`, error);
          throw error;
        }
      }

      // Main function to load OCR dashboard data
      async function loadOcrDashboardData() {
        try {
          console.log("ðŸ”„ Loading OCR dashboard data...");

          // Show loading state safely
          updateElementText("totalCapableAgents", "...");
          updateElementText("activeOcrAgents", "...");
          updateElementText("highThreatCount", "...");
          updateElementText("totalViolations24h", "...");
          updateElementText("coveragePercentage", "Loading...");

          // Fetch data from backend APIs
          const [statusResult, summaryResult, highThreatResult] = await Promise.all([
            fetch("/api/admin/ocr/status", { credentials: "include" }),
            fetch("/api/admin/ocr/summary", { credentials: "include" }),
            fetch("/api/admin/ocr/high-threat-agents/count", { credentials: "include" })
          ]);

          if (!statusResult.ok) {
            throw new Error(`Status API failed: ${statusResult.status}`);
          }

          if (!summaryResult.ok) {
            throw new Error(`Summary API failed: ${summaryResult.status}`);
          }

          const statusData = await statusResult.json();
          const summaryData = await summaryResult.json();
          const highThreatData = highThreatResult.ok ? await highThreatResult.json() : null;

          console.log("ðŸ“Š Status data:", statusData);
          console.log("ðŸ“ˆ Summary data:", summaryData);

          if (!statusData.success) {
            throw new Error(
              `Status API error: ${statusData.message || "Unknown error"}`
            );
          }

          // Update stats
          const agents = statusData.data || [];
          const summary = summaryData;

          // Calculate statistics
          const totalCapable = summary.totalCapableAgents || agents.length;
          const activeOcr =
            summary.activeOcr ||
            agents.filter(
              (a) => a.ocrEnabled === true || a.ocr_enabled === true
            ).length;

          const highThreat = highThreatData?.data?.count || 
                            agents.filter(a => {
                              const score = a.currentThreatScore || a.current_threat_score || 0;
                              return score >= 70;
                            }).length;

          const violations24h = agents.reduce((sum, a) => {
            return sum + (a.violationsLast24h || a.violations_last_24h || 0);
          }, 0);

          const coveragePercentage =
            totalCapable > 0 ? Math.round((activeOcr / totalCapable) * 100) : 0;

          // Update UI
          updateDashboardUI(
            totalCapable,
            activeOcr,
            highThreat,
            violations24h,
            coveragePercentage
          );

          // Store data for later use
          ocrDashboardStats = {
            totalCapableAgents: totalCapable,
            activeOcrAgents: activeOcr,
            highThreatCount: highThreat,
            totalViolations24h: violations24h,
            coveragePercentage: coveragePercentage,
            lastUpdated: new Date(),
            summary: summary,
            agents: agents,
          };

          // Also update the agent table with real data
          updateAgentTable(agents);

          // Load recent violations
          await loadRecentViolations();

          console.log("âœ… OCR dashboard data loaded:", ocrDashboardStats);
        } catch (error) {
          console.error("âŒ Error loading OCR dashboard:", error);

          // Show error in UI safely
          updateElementText("totalCapableAgents", "Error");
          updateElementText("activeOcrAgents", "Error");
          updateElementText("highThreatCount", "Error");
          updateElementText("totalViolations24h", "Error");
          updateElementText("coveragePercentage", "Error");
        }
      }

      // Update the dashboard UI with new data
      function updateDashboardUI(
        totalCapable,
        activeOcr,
        highThreat,
        violations24h,
        coveragePercentage
      ) {
        // Update the HTML elements
        updateElementText("totalCapableAgents", totalCapable);
        updateElementText("activeOcrAgents", activeOcr);
        updateElementText("highThreatCount", highThreat);
        updateElementText("totalViolations24h", violations24h);

        const coverageEl = getElementSafe("coveragePercentage");
        if (coverageEl) {
          coverageEl.textContent = `${coveragePercentage}% coverage`;
        }

        // Update last updated time
        const now = new Date();
        const trendEl = getElementSafe("violationsTrend");
        if (trendEl) {
          trendEl.textContent = `Updated: ${now.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" })}`;
          trendEl.style.color = "#6b7280";
        }
      }

      async function loadRecentViolations() {
        try {
          console.log('ðŸ”„ Loading recent violations...');

          // First, get all agents with OCR status
          const statusResult = await callApi("/api/admin/ocr/status", {
            credentials: "include"
          });

          if (!statusResult || !statusResult.success) {
            throw new Error(`Status API failed: ${statusResult?.message || 'Unknown error'}`);
          }

          const agents = statusResult.data || [];
          console.log("ðŸ“Š Agents from OCR status API:", agents);

          // Create a mapping of agent ID to hostname
          const agentHostnameMap = {};

          agents.forEach(agent => {
            const agentId = agent.agentId || agent.agent_id;

            const hostname = agent.hostname ||
                           agent.agent_hostname ||
                           agent.agentHostname ||
                           `Agent ${agentId}`;

            const username = agent.username ||
                           agent.agent_username ||
                           agent.agentUsername ||
                           'N/A';

            if (agentId) {
              agentHostnameMap[agentId] = {
                hostname: hostname,
                username: username,
                rawAgentData: agent
              };
            }
          });

          console.log("ðŸ“Š Agent hostname mapping:", agentHostnameMap);

          if (agents.length === 0) {
            displayRecentViolations([], agentHostnameMap);
            return [];
          }

          // Get violations for ALL agents in parallel
          const violationPromises = agents.map(async (agent) => {
            try {
              const agentId = agent.agentId || agent.agent_id;

              const response = await fetch(`/api/admin/ocr/violations/${agentId}`, {
                credentials: "include"
              });

              if (response.ok) {
                const result = await response.json();
                if (result.success && result.data) {
                  return result.data.map(violation => ({
                    ...violation,
                    agent_id: agentId,
                    agent_hostname: agentHostnameMap[agentId]?.hostname ||
                                  violation.agent_hostname ||
                                  violation.agentHostname ||
                                  `Agent ${agentId}`,
                    agent_username: agentHostnameMap[agentId]?.username ||
                                   violation.agent_username ||
                                   violation.agentUsername ||
                                   'N/A'
                  }));
                }
              }
              return [];
            } catch (error) {
              console.warn(`Failed to get violations for agent ${agent.agentId}:`, error);
              return [];
            }
          });

          // Wait for all requests to complete
          const violationsArrays = await Promise.all(violationPromises);

          // Flatten the array and sort by timestamp
          let allViolations = [];
          violationsArrays.forEach(arr => {
            allViolations = allViolations.concat(arr);
          });

          // Sort by timestamp (newest first)
          allViolations.sort((a, b) => {
            const timeA = new Date(a.timestamp || 0);
            const timeB = new Date(b.timestamp || 0);
            return timeB - timeA;
        });
        
        // Take only the 5 most recent violations
        const recentViolations = allViolations.slice(0, 7);
        
        console.log(`âœ… Loaded ${recentViolations.length} recent violations`);
        
        // Display the violations
        displayRecentViolations(recentViolations ,agentHostnameMap);
        
        return recentViolations;
        
    } catch (error) {
        console.error('âŒ Error loading recent violations:', error);
        
        // // Show error in UI
        const container = document.getElementById('recentViolationsList');
        if (container) {
            container.innerHTML = `
                <div class="violation-item" style="background: #fee2e2; border-left: 3px solid #dc2626;">
                    <div class="violation-header">
                        <div class="violation-title" style="color: #dc2626;">Error</div>
                        <div class="violation-time">Failed to load</div>
                    </div>
                    <div class="violation-details">${error.message}</div>
                    <span class="violation-score score-high" onclick="retryLoadViolations()" 
                          style="cursor: pointer; background: #dc2626; color: white;">
                        Click to retry
                    </span>
                </div>
            `;
        }
             // Show error in UI - FIXED: call displayRecentViolations with empty array
        // displayRecentViolations([], {});
        return [];
    }
}

// Add this helper function if not already defined
function retryLoadViolations() {
    loadRecentViolations();
    }
/*
<!--      // Function to display violations in the desired format-->
<!--      function displayRecentViolations(violations , agentHostnameMap = {}) {-->
<!--        const container = document.getElementById("recentViolationsList");-->
<!--        if (!container) {-->
<!--          console.warn("âš ï¸ Recent violations container not found");-->
<!--          return;-->
<!--        }-->

<!--        if (violations.length === 0) {-->
<!--          container.innerHTML = `-->
<!--            <div class="violation-item" style="opacity: 0.7;">-->
<!--                <div class="violation-header">-->
<!--                    <div class="violation-title">No violations found</div>-->
<!--                    <div class="violation-time">&#45;&#45;:&#45;&#45;</div>-->
<!--                </div>-->
<!--                <div class="violation-details">No recent violations detected</div>-->
<!--                <span class="violation-score score-low">0% confidence</span>-->
<!--            </div>-->
<!--        `;-->
<!--          return;-->
<!--        }-->

<!--        // Sort violations by timestamp (newest first)-->
<!--        violations.sort(-->
<!--          (a, b) => new Date(b.timestamp) - new Date(a.timestamp),-->
<!--        );-->

<!--        // Take only the first 5 violations-->
<!--        const recentViolations = violations.slice(0, 7);-->

<!--        // Create HTML for each violation-->
<!--        const violationsHtml = recentViolations-->
<!--          .map((violation, index) => {-->
<!--            // Extract data with fallbacks-->
<!--            const agentId =-->
<!--              violation.agent_id || violation.agentId || "Unknown";-->
<!--            let hostname =-->
<!--              violation.agent_hostname ||-->
<!--              violation.agentHostname ||-->
<!--               agentHostnameMap[agentId]?.hostname || -->
<!--             `Agent ${agentId}`;-->
<!--               // If hostname is an IP address, try to get the actual hostname-->
<!--            // You might want to check if it looks like an IP address-->
<!--            const ipPattern = /^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$/;-->
<!--            if (ipPattern.test(hostname) && agentHostnameMap[agentId]?.hostname) {-->
<!--                hostname = agentHostnameMap[agentId].hostname;-->
<!--            }-->

<!--            const username =-->
<!--              violation.agent_username ||-->
<!--              violation.agentUsername ||-->
<!--              agentHostnameMap[agentId]?.username || -->
<!--              "N/A";-->

<!--            // Format display name-->
<!--            let displayName = hostname;-->
<!--            if (username !== 'N/A') {-->
<!--                displayName = `${hostname} (${username})`;-->
<!--            }-->
<!--             // Remove "(agent)" suffix if present-->
<!--            displayName = displayName.replace(/\s*\(agent\)$/i, '');-->
<!--            // Format time-->
<!--            const timeAgo = formatTimeAgo(violation.timestamp);-->

<!--            // Get violation type-->
<!--            const violationType = getViolationTypeDisplay(-->
<!--              violation.rule_type || violation.ruleType,-->
<!--            );-->

<!--            // Calculate confidence-->
<!--            const confidence = Math.round((violation.confidence || 0) * 100);-->
<!--            const confidenceClass = getConfidenceClass(-->
<!--              violation.confidence || 0,-->
<!--            );-->

<!--            // Get matched text snippet-->
<!--            const matchedText =-->
<!--              violation.matched_text ||-->
<!--              violation.matchedText ||-->
<!--              "No text available";-->
<!--            const textSnippet =-->
<!--              matchedText.length > 50-->
<!--                ? matchedText.substring(0, 50) + "..."-->
<!--                : matchedText;-->

<!--            // Create violation item-->
<!--            return `-->
<!--            <div class="violation-item" onclick="viewViolationDetail(${violation.id || index}, '${agentId}')">-->
<!--                <div class="violation-header">-->
<!--                    <div class="violation-title">${escapeHtml(displayName)}</div>-->
<!--                    <div class="violation-time">${timeAgo}</div>-->
<!--                </div>-->
<!--                <div class="violation-details">${escapeHtml(violationType)}</div>-->
<!--                <div class="violation-snippet" style="font-size: 0.75em; color: #6b7280; margin-top: 4px;">-->
<!--                    "${escapeHtml(textSnippet)}"-->
<!--                </div>-->
<!--                <span class="violation-score ${confidenceClass}">${confidence}% confidence</span>-->
<!--            </div>-->
<!--        `;-->
<!--          })-->
<!--          .join("");-->

<!--        container.innerHTML = violationsHtml;-->
<!--      }
      function displayRecentViolations(violations, agentHostnameMap = {}) {
        const container = document.getElementById("recentViolationsList");
        if (!container) {
          console.warn("âš ï¸ Recent violations container not found");
          return;
        }

        if (violations.length === 0) {
          container.innerHTML = `
            <div class="violation-item" style="opacity: 0.7;">
                <div class="violation-header">
                    <div class="violation-title">No violations found</div>
                    <div class="violation-time">--:--</div>
                </div>
                <div class="violation-details">No recent violations detected</div>
                <span class="violation-score score-low">0% confidence</span>
            </div>
          `;
          return;
        }

        // Sort violations by timestamp (newest first)
        violations.sort(
          (a, b) => new Date(b.timestamp) - new Date(a.timestamp)
        );

        // Take only the first 7 violations
        const recentViolations = violations.slice(0, 7);

        // Create HTML for each violation
        const violationsHtml = recentViolations
          .map((violation, index) => {
            const agentId = violation.agent_id || violation.agentId || "Unknown";

            const hostname = agentHostnameMap[agentId]?.hostname ||
                            violation.agent_hostname ||
                            violation.agentHostname ||
                            `Agent ${agentId}`;

            const username = agentHostnameMap[agentId]?.username ||
                            violation.agent_username ||
                            violation.agentUsername ||
                            '';

            let displayName = hostname;
            if (username && username !== 'N/A' && username !== '') {
              displayName = `${hostname} (${username})`;
            }

            const timeAgo = formatTimeAgo(violation.timestamp);

            const violationType = getViolationTypeDisplay(
              violation.rule_type || violation.ruleType
            );

            const confidence = Math.round((violation.confidence || 0) * 100);
            const confidenceClass = getConfidenceClass(
              violation.confidence || 0
            );

            const matchedText = violation.matched_text ||
                              violation.matchedText ||
                              "No text available";
            const textSnippet = matchedText.length > 50
              ? matchedText.substring(0, 50) + "..."
              : matchedText;

            return `
            <div class="violation-item" onclick="viewViolationDetail('${violation.id || index}', '${agentId}')">
                <div class="violation-header">
                    <div class="violation-title">${escapeHtml(displayName)}</div>
                    <div class="violation-time">${timeAgo}</div>
                </div>
                <div class="violation-details">${escapeHtml(violationType.toLowerCase())}</div>
                <div class="violation-snippet" style="font-size: 0.75em; color: #6b7280; margin-top: 4px; font-family: monospace;">
                    "${escapeHtml(textSnippet)}"
                </div>
                <span class="violation-score ${confidenceClass}">${confidence}% confidence</span>
            </div>
          `;
          })
          .join("");

        container.innerHTML = violationsHtml;
      }

      // Helper function to get violation type display name
      function getViolationTypeDisplay(ruleType) {
        if (!ruleType) return "Unknown Violation";

        const typeMap = {
          CREDIT_CARD: "Credit Card Number",
          CREDIT_CARD_NUMBER: "Credit Card Number",
          SSN: "Social Security Number",
          SOCIAL_SECURITY: "Social Security Number",
          BANK_ACCOUNT: "Bank Account",
          BANK_ACCOUNT_NUMBER: "Bank Account",
          AADHAAR: "Aadhaar Number",
          PASSWORD: "Password",
          PII: "Personal Information",
          PERSONAL_INFO: "Personal Information",
          PHONE_NUMBER: "Phone Number",
          EMAIL_ADDRESS: "Email Address",
          DRIVER_LICENSE: "Driver License",
          PASSPORT: "Passport Number",
          TAX_ID: "Tax ID",
        };

        return typeMap[ruleType] || ruleType.replace(/_/g, " ");
      }

      // Helper function to get confidence class
      function getConfidenceClass(confidence) {
        if (confidence >= 0.9) return "score-high";
        if (confidence >= 0.7) return "score-medium";
        return "score-low";
      }

      // Update the agent table with real data
      function updateAgentTable(agents) {
        const tbody = document.getElementById("agentTableBody");
        if (!tbody) {
          console.warn("âš ï¸ Agent table tbody not found");
          return;
        }

        // Clear existing rows
        tbody.innerHTML = "";

        if (agents.length === 0) {
          // Show empty state
          tbody.innerHTML = `
            <tr>
              <td colspan="5" style="text-align: center; padding: 40px; color: #6b7280;">
                No OCR agents found
              </td>
            </tr>
          `;
          return;
        }

        // Create rows for each agent
        agents.forEach((agent, index) => {
          const hostname =
            agent.agentHostname ||
            agent.agent_hostname ||
            `Agent ${agent.agentId || agent.agent_id || "Unknown"}`;

          const username =
            agent.agent_username ||
            agent.agentUsername ||
            agent.agentHostname ||
            agent.agent_hostname ||
            "Unknown";

          const isActive =
            agent.ocrEnabled === true || agent.ocr_enabled === true;
          const threatScore =
            agent.currentThreatScore || agent.current_threat_score || 0;
          const violations =
            agent.violationsLast24h || agent.violations_last_24h || 0;
          const lastScreenshot =
            agent.lastScreenshotTime || agent.last_screenshot_time;
          const agentId = agent.agentId || agent.agent_id || index;

          // Determine color for violations count
          let color = "#dc2626"; // red
          if (violations === 0)
            color = "#6b7280"; // gray
          else if (violations < 5) color = "#f59e0b"; // orange

          const row = document.createElement("tr");
          row.setAttribute("onclick", `viewAgentDetails('${agentId}')`);
          row.style.cursor = "pointer";

          row.innerHTML = `
            <td>
              <strong>${escapeHtml(hostname)}</strong>
              <br>
              <span style="font-size: 0.75em; color: #6b7280;">${escapeHtml(username)}</span>
            </td>
            <td>
              <span class="status-dot ${isActive ? "active" : "inactive"}"></span>
              ${isActive ? "Active" : "Inactive"}
            </td>
            <td>
              <div style="display: flex; align-items: center; gap: 8px;">
                <div class="threat-bar" style="width: 60px;">
                  <div class="threat-fill" style="width: ${Math.min(threatScore, 100)}%;"></div>
                </div>
                <span style="font-weight: 600;">${threatScore}%</span>
              </div>
            </td>
            <td>${lastScreenshot ? formatTimeAgo(lastScreenshot) : "N/A"}</td>
            <td><strong style="color: ${color};">${violations}</strong></td>
          `;

          tbody.appendChild(row);
        });
      }

      // Helper function to escape HTML
      function escapeHtml(text) {
        if (!text) return "";
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      // Helper function to format time ago
      function formatTimeAgo(timestamp) {
        if (!timestamp) return "N/A";

        try {
          const date = new Date(timestamp);
          const now = new Date();

          const diffMs = now.getTime() - date.getTime();
          const diffMins = Math.floor(diffMs / 60000);
          const diffHours = Math.floor(diffMs / 3600000);
          const diffDays = Math.floor(diffMs / 86400000);

          if (diffMins < 1) return "Just now";
          if (diffMins < 60) return `${diffMins}m ago`;
          if (diffHours < 24) return `${diffHours}h ago`;
          return `${diffDays}d ago`;
        } catch (e) {
          console.error('Error parsing date:', e);
          return "Invalid date";
        }
      }

      // Dashboard functions
      function refreshData() {
        console.log("ðŸ”„ Manual refresh triggered");
        loadOcrDashboardData();

        // Show visual feedback
        const btn = document.querySelector(".refresh-btn");
        if (btn) {
          const originalText = btn.innerHTML;
          btn.innerHTML =
            '<i class="fas fa-spinner fa-spin"></i><span>Refreshing...</span>';
          btn.disabled = true;

          setTimeout(() => {
            btn.innerHTML = originalText;
            btn.disabled = false;
          }, 1000);
        }
      }

      // Start auto-refresh
      function startAutoRefresh() {
        stopAutoRefresh(); // Clear any existing interval

        autoRefreshInterval = setInterval(() => {
          console.log("ðŸ”„ Auto-refreshing OCR data...");
          loadOcrDashboardData();
        }, 5000); // Refresh every 5 seconds

        console.log("âœ… Auto-refresh started (5s interval)");
      }

      // Stop auto-refresh
      function stopAutoRefresh() {
        if (autoRefreshInterval) {
          clearInterval(autoRefreshInterval);
          autoRefreshInterval = null;
          console.log("â¹ï¸ Auto-refresh stopped");
        }
      }

      // View agent details
      async function viewAgentDetails(agentId) {
        console.log(`ðŸ‘ï¸ Viewing details for agent: ${agentId}`);

        try {
          const response = await fetch(`/api/admin/ocr/violations/${agentId}`, {
            credentials: "include",
          });

          if (response.ok) {
            const result = await response.json();
            if (result.success) {
              const violations = result.data || [];

              const violationTypes = violations
                .map((v) => v.ruleType || v.rule_type || "Unknown")
                .join(", ");

              alert(
                `Agent ${agentId} Details:\n\n` +
                  `Total Violations: ${violations.length}\n` +
                  `Violation Types: ${violationTypes || "None"}\n\n` +
                  `Click OK to view more details in the console.`
              );

              console.log(`Agent ${agentId} violations:`, violations);
            }
          }
        } catch (error) {
          console.error("Error fetching agent violations:", error);
          alert(
            `Viewing details for agent: ${agentId}\n\nCheck console for API errors.`
          );
        }
      }

      // Function to view violation details
      async function viewViolationDetail(violationId, agentId) {
        console.log(
          `ðŸ” Viewing violation detail: ${violationId} for agent ${agentId}`
        );

        try {
          const response = await fetch(
            `/api/admin/ocr/violation/${violationId}`,
            {
              credentials: "include",
            }
          );

          if (response.ok) {
            const result = await response.json();
            if (result.success) {
              const violation = result.data;
              showViolationModal(violation);
            } else {
              showBasicViolationInfo(violationId, agentId);
            }
          } else {
            showBasicViolationInfo(violationId, agentId);
          }
        } catch (error) {
          console.error("Error fetching violation details:", error);
          showBasicViolationInfo(violationId, agentId);
        }
      }

      // Function to show violation in a modal
      function showViolationModal(violation) {
        const confidence = Math.round((violation.confidence || 0) * 100);
        const ruleType = getViolationTypeDisplay(
          violation.rule_type || violation.ruleType
        );
        const matchedText =
          violation.matched_text ||
          violation.matchedText ||
          "No text available";
        const timestamp = new Date(violation.timestamp).toLocaleString();
        const agentName =
          violation.agent_hostname ||
          violation.agentHostname ||
          "Unknown Agent";
        const username =
          violation.agent_username || violation.agentUsername || "N/A";

        const modalHtml = `
        <div class="modal" onclick="if(event.target === this) closeModal()">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Violation Details</h3>
                    <button class="modal-close" onclick="closeModal()">Ã—</button>
                </div>
                
                <div class="modal-body">
                    <div style="margin-bottom: 16px;">
                        <div style="font-weight: 600; color: #111827;">${escapeHtml(agentName)} (${escapeHtml(username)})</div>
                        <div style="font-size: 0.875em; color: #6b7280;">${timestamp}</div>
                    </div>
                    
                    <div style="background: #f9fafb; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="font-weight: 600;">Violation Type:</span>
                            <span>${escapeHtml(ruleType)}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="font-weight: 600;">Confidence:</span>
                            <span style="background: ${confidence >= 90 ? "#fee2e2" : confidence >= 70 ? "#fef3c7" : "#d1fae5"}; 
                                  color: ${confidence >= 90 ? "#dc2626" : confidence >= 70 ? "#d97706" : "#059669"}; 
                                  padding: 4px 8px; border-radius: 4px; font-weight: 600;">
                                ${confidence}%
                            </span>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 16px;">
                        <div style="font-weight: 600; margin-bottom: 8px;">Matched Text:</div>
                        <div style="background: #f3f4f6; padding: 12px; border-radius: 6px; font-family: monospace; white-space: pre-wrap; word-break: break-all;">
                            ${escapeHtml(matchedText)}
                        </div>
                    </div>
                    
                    ${
                      violation.screenshot_path || violation.screenshotPath
                        ? `
                    <div style="margin-bottom: 16px;">
                        <div style="font-weight: 600; margin-bottom: 8px;">Screenshot:</div>
                        <div style="text-align: center;">
                            <img src="/api/admin/ocr/screenshot/${violation.id}" 
                                 alt="Violation Screenshot" 
                                 style="max-width: 100%; border-radius: 6px; border: 1px solid #e5e7eb;"
                                 onerror="this.style.display='none'">
                        </div>
                    </div>
                    `
                        : ""
                    }
                </div>
                
                <div class="modal-footer">
                    <button class="modal-btn modal-btn-secondary" onclick="closeModal()">Close</button>
                    <button class="modal-btn modal-btn-primary" onclick="takeActionOnViolation(${violation.id})">Take Action</button>
                </div>
            </div>
        </div>
      `;

        const modalContainer = document.createElement("div");
        modalContainer.innerHTML = modalHtml;
        document.body.appendChild(modalContainer.firstChild);
      }

      // Function to show basic violation info
      function showBasicViolationInfo(violationId, agentId) {
        alert(
          `Violation ID: ${violationId}\nAgent ID: ${agentId}\n\nThis would show detailed information from the API.`
        );
      }

      // Function to close modal
      function closeModal() {
        const modal = document.querySelector(".modal");
        if (modal) {
          modal.remove();
        }
      }

      // Function to take action on violation
      function takeActionOnViolation(violationId) {
        alert(
          `Taking action on violation ${violationId}\n\nThis would trigger automated remediation actions.`
        );
        closeModal();
      }

      // Function to retry loading violations
      function retryLoadViolations() {
        loadRecentViolations();
      }

      /* ==================== EVENT LISTENERS ==================== */

      window.addEventListener("resize", function () {
        const sidebar = document.getElementById("sidebar");
        const mainContent = document.getElementById("mainContent");
        const header = document.getElementById("topHeader");
        const windowWidth = window.innerWidth;

        if (windowWidth <= 968) {
          if (sidebar) sidebar.classList.remove("collapsed");
          if (mainContent) mainContent.classList.remove("expanded");
          if (header) {
            header.style.left = "0";
          }
        } else {
          if (sidebar && mainContent && header) {
            if (sidebar.classList.contains("collapsed")) {
              mainContent.classList.add("expanded");
              header.style.left = "70px";
            } else {
              mainContent.classList.remove("expanded");
              header.style.left = "240px";
            }
          }
        }
      });

      window.addEventListener("sidebarToggle", function (event) {
        const header = document.getElementById("topHeader");
        const mainContent = document.getElementById("mainContent");

        if (header && mainContent) {
          if (event.detail.collapsed) {
            header.style.left = "70px";
            mainContent.classList.add("expanded");
          } else {
            header.style.left = "240px";
            mainContent.classList.remove("expanded");
          }
        }
      });

      document.addEventListener("click", function (e) {
        const sidebar = document.getElementById("sidebar");
        const mobileMenuToggle = document.querySelector(".mobile-menu-toggle");

        if (sidebar && window.innerWidth <= 968) {
          if (
            !sidebar.contains(e.target) &&
            (!mobileMenuToggle || !mobileMenuToggle.contains(e.target))
          ) {
            sidebar.classList.remove("mobile-open");
            const overlay = document.getElementById("sidebarOverlay");
            if (overlay) {
              overlay.classList.remove("active");
            }
          }
        }
      });

      // Initialize on DOM ready
      document.addEventListener("DOMContentLoaded", async function () {
        console.log("ðŸ“„ DOM loaded, initializing OCR dashboard...");

        try {
          const userData = await checkAuth();
          if (userData) {
            loadAdminInfo();
          }

          setActiveMenuItem();

          await loadOcrDashboardData();
          startAutoRefresh();

          const sidebar = document.getElementById("sidebar");
          const mainContent = document.getElementById("mainContent");
          const header = document.getElementById("topHeader");
          const windowWidth = window.innerWidth;

          if (sidebar && mainContent && header) {
            if (windowWidth <= 968) {
              mainContent.classList.remove("expanded");
              header.style.left = "0";
            } else {
              if (sidebar.classList.contains("collapsed")) {
                mainContent.classList.add("expanded");
                header.style.left = "70px";
              } else {
                mainContent.classList.remove("expanded");
                header.style.left = "240px";
              }
            }
          }
        } catch (error) {
          console.error("Error initializing page:", error);
        }
      });

      // Make functions globally available
      window.refreshData = refreshData;
      window.viewAgentDetails = viewAgentDetails;
      window.viewViolationDetail = viewViolationDetail;
      window.closeModal = closeModal;
      window.takeActionOnViolation = takeActionOnViolation;
      window.retryLoadViolations = retryLoadViolations;
    </script>
  </body>
</html> -->



<!DOCTYPE html>
<<<<<<< HEAD
<html lang="en" xmlns:th="http://www.thymeleaf.org">
=======
<html lang="en"xmlns:th="http://www.thymeleaf.org">
>>>>>>> 8d476d2a36a10307e0748cbf1f5ce139560af312
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DLP Shield - OCR & Image Analysis</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background: #f3f4f6;
        overflow-x: hidden;
      }

      .dashboard-container {
        display: flex;
        min-height: 100vh;
        max-width: 100vw;
        overflow-x: hidden;
      }

      .main-content {
        flex: 1;
        margin-left: 240px;
        transition: margin-left 0.3s ease;
        min-height: 100vh;
        max-width: calc(100vw - 240px);
        overflow-x: hidden;
      }

      .main-content.expanded {
        margin-left: 70px;
        max-width: calc(100vw - 70px);
      }

      .content-area {
        padding: 24px;
        padding-top: 100px;
        max-width: 1400px;
        margin: 0 auto;
      }

      /* ================ SIDEBAR STYLES ================ */
      .sidebar {
        width: 240px;
        background: linear-gradient(180deg, #1e40af 0%, #1e3a8a 100%);
        color: white;
        position: fixed;
        height: 100vh;
        display: flex;
        flex-direction: column;
        transition: width 0.3s ease;
        z-index: 1000;
        left: 0;
        top: 0;
        overflow: hidden;
      }

      .sidebar::-webkit-scrollbar {
        width: 4px;
      }

      .sidebar::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.3);
        border-radius: 4px;
      }

      .sidebar-header {
        padding: 18px 16px;
        display: flex;
        align-items: center;
        gap: 10px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        flex-shrink: 0;
      }

      .sidebar-logo {
        width: 38px;
        height: 38px;
        background: white;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
      }

      .sidebar-logo i {
        font-size: 20px;
        color: #2563eb;
      }

      .sidebar-title {
        font-size: 1.2em;
        font-weight: 700;
        white-space: nowrap;
        transition: opacity 0.2s, width 0.3s;
        overflow: hidden;
      }

      .nav-menu {
        padding: 12px 0;
        overflow-y: auto;
        overflow-x: hidden;
        flex: 1;
      }

      .nav-item {
        margin: 2px 8px;
      }

      .nav-link {
        display: flex;
        align-items: center;
        padding: 10px 12px;
        color: rgba(255, 255, 255, 0.8);
        text-decoration: none;
        border-radius: 8px;
        transition: all 0.2s;
        font-size: 0.9em;
        cursor: pointer;
        white-space: nowrap;
      }

      .nav-link:hover {
        background: rgba(255, 255, 255, 0.1);
        color: white;
      }

      .nav-link.active,
      .sub-menu-item.active {
        background: rgba(255, 255, 255, 0.15);
        color: white;
        font-weight: 600;
      }

      .nav-link i:first-child {
        width: 20px;
        font-size: 0.95em;
        margin-right: 10px;
        flex-shrink: 0;
      }

      .chevron-icon {
        margin-left: auto !important;
        font-size: 0.7em !important;
        transition: transform 0.3s;
        width: auto !important;
        flex-shrink: 0;
      }

      .nav-link.expanded .chevron-icon {
        transform: rotate(180deg);
      }

      .sub-menu {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease;
      }

      .sub-menu.open {
        max-height: 500px;
      }

      .sub-menu-item {
        display: flex;
        align-items: center;
        padding: 8px 12px 8px 42px;
        color: rgba(255, 255, 255, 0.7);
        text-decoration: none;
        font-size: 0.85em;
        transition: all 0.2s;
        border-radius: 8px;
        margin: 2px 0;
        white-space: nowrap;
      }

      .sub-menu-item:hover {
        color: white;
        background: rgba(255, 255, 255, 0.08);
      }

      .sub-menu-item::before {
        content: "â€¢";
        margin-right: 10px;
        font-size: 1.2em;
      }

      .sidebar-footer {
        padding: 12px 16px;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        flex-shrink: 0;
      }

      .collapse-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 10px;
        background: rgba(255, 255, 255, 0.1);
        border: none;
        color: white;
        border-radius: 8px;
        cursor: pointer;
        width: 100%;
        font-size: 0.85em;
        transition: all 0.2s;
        white-space: nowrap;
        overflow: hidden;
      }

      .collapse-btn:hover {
        background: rgba(255, 255, 255, 0.15);
      }

      .collapse-btn i {
        transition: transform 0.3s;
        flex-shrink: 0;
      }

      /* Sidebar collapsed state */
      .sidebar.collapsed {
        width: 70px;
      }

      .sidebar.collapsed .sidebar-title {
        opacity: 0;
        width: 0;
      }

      .sidebar.collapsed .nav-link span,
      .sidebar.collapsed .collapse-btn span {
        display: none;
      }

      .sidebar.collapsed .sub-menu {
        display: none !important;
      }

      .sidebar.collapsed .nav-link {
        justify-content: center;
        padding: 10px;
      }

      .sidebar.collapsed .nav-link i:first-child {
        margin-right: 0;
      }

      .sidebar.collapsed .chevron-icon {
        display: none;
      }

      .sidebar.collapsed .collapse-btn {
        justify-content: center;
      }

      .sidebar.collapsed .collapse-btn i {
        transform: rotate(180deg);
      }

      /* Mobile Overlay */
      .sidebar-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 999;
        opacity: 0;
        transition: opacity 0.3s;
      }

      .sidebar-overlay.active {
        display: block;
        opacity: 1;
      }

      /* ================ HEADER STYLES ================ */
      .top-header {
        background: white;
        padding: 14px 24px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        border-bottom: 1px solid #e5e7eb;
        position: fixed;
        top: 0;
        left: 240px;
        right: 0;
        z-index: 500;
        gap: 16px;
        transition: left 0.3s ease;
      }

      .mobile-menu-toggle {
        display: none;
        background: none;
        border: none;
        color: #6b7280;
        font-size: 1.3em;
        cursor: pointer;
        padding: 8px;
        transition: color 0.2s;
      }

      .mobile-menu-toggle:hover {
        color: #111827;
      }

      .search-bar {
        flex: 1;
        max-width: 400px;
        position: relative;
      }

      .search-bar i {
        position: absolute;
        left: 14px;
        top: 50%;
        transform: translateY(-50%);
        color: #9ca3af;
        font-size: 0.9em;
      }

      .search-input {
        width: 100%;
        padding: 9px 14px 9px 38px;
        border: 1.5px solid #e5e7eb;
        border-radius: 8px;
        font-size: 0.9em;
        background: #f9fafb;
        transition: all 0.3s ease;
      }

      .search-input:focus {
        outline: none;
        border-color: #3b82f6;
        background: white;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }

      .header-actions {
        display: flex;
        align-items: center;
        gap: 16px;
      }

      .notification-btn {
        position: relative;
        background: none;
        border: none;
        color: #6b7280;
        font-size: 1.1em;
        cursor: pointer;
        padding: 8px;
        transition: all 0.2s;
        border-radius: 8px;
      }

      .notification-btn:hover {
        color: #111827;
        background: #f3f4f6;
      }

      .notification-btn.active {
        color: #2563eb;
        background: #eff6ff;
      }

      .notification-badge {
        position: absolute;
        top: 4px;
        right: 4px;
        background: #ef4444;
        color: white;
        font-size: 0.65em;
        min-width: 18px;
        height: 18px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        padding: 0 4px;
      }

      .user-profile {
        display: flex;
        align-items: center;
        gap: 10px;
        cursor: pointer;
        padding: 6px 10px;
        border-radius: 8px;
        transition: background 0.2s;
        position: relative;
      }

      .user-profile:hover {
        background: #f3f4f6;
      }

      .user-avatar {
        width: 36px;
        height: 36px;
        background: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        font-size: 0.9em;
        flex-shrink: 0;
      }

      .user-info {
        display: flex;
        flex-direction: column;
      }

      .user-name {
        font-size: 0.9em;
        font-weight: 600;
        color: #111827;
      }

      .user-role {
        font-size: 0.75em;
        color: #6b7280;
      }

      .dropdown-icon {
        color: #6b7280;
        font-size: 0.75em;
        margin-left: 4px;
        transition: transform 0.3s;
      }

      .user-profile.active .dropdown-icon {
        transform: rotate(180deg);
      }

      .user-dropdown {
        position: absolute;
        top: 100%;
        right: 0;
        margin-top: 8px;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07),
          0 10px 15px rgba(0, 0, 0, 0.1);
        min-width: 200px;
        opacity: 0;
        visibility: hidden;
        transform: translateY(-10px);
        transition: all 0.3s ease;
        z-index: 1000;
      }

      .user-dropdown.show {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
      }

      .dropdown-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 14px;
        color: #374151;
        text-decoration: none;
        font-size: 0.9em;
        transition: background 0.2s;
      }

      .dropdown-item:first-child {
        border-radius: 8px 8px 0 0;
      }

      .dropdown-item:last-child {
        border-radius: 0 0 8px 8px;
      }

      .dropdown-item:hover {
        background: #f3f4f6;
      }

      .dropdown-item i {
        width: 18px;
        color: #6b7280;
        font-size: 0.95em;
      }

      .dropdown-item.danger {
        color: #dc2626;
      }

      .dropdown-item.danger i {
        color: #dc2626;
      }

      .dropdown-divider {
        height: 1px;
        background: #e5e7eb;
        margin: 4px 0;
      }

      /* ================ NOTIFICATIONS PANEL ================ */
      .notifications-panel {
        position: fixed;
        top: 0;
        right: -50%;
        width: 50%;
        max-width: 600px;
        height: 100vh;
        background: white;
        box-shadow: -4px 0 15px rgba(0, 0, 0, 0.1);
        z-index: 1001;
        display: flex;
        flex-direction: column;
        transition: right 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .notifications-panel.show {
        right: 0;
      }

      .notifications-header {
        padding: 20px 24px;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
      }

      .notifications-header h3 {
        font-size: 1.2em;
        font-weight: 700;
        color: #111827;
      }

      .close-notifications {
        background: none;
        border: none;
        color: #6b7280;
        font-size: 1.2em;
        cursor: pointer;
        padding: 6px;
        border-radius: 6px;
        transition: all 0.2s;
      }

      .close-notifications:hover {
        background: #f3f4f6;
        color: #111827;
      }

      .notifications-tabs {
        display: flex;
        border-bottom: 1px solid #e5e7eb;
        padding: 0 24px;
        flex-shrink: 0;
      }

      .tab-btn {
        flex: 1;
        padding: 12px;
        background: none;
        border: none;
        color: #6b7280;
        font-size: 0.9em;
        font-weight: 500;
        cursor: pointer;
        border-bottom: 2px solid transparent;
        transition: all 0.2s;
      }

      .tab-btn:hover {
        color: #111827;
      }

      .tab-btn.active {
        color: #2563eb;
        border-bottom-color: #2563eb;
      }

      .notifications-content {
        flex: 1;
        overflow-y: auto;
        padding: 12px 0;
      }

      .notifications-content::-webkit-scrollbar {
        width: 6px;
      }

      .notifications-content::-webkit-scrollbar-thumb {
        background: #d1d5db;
        border-radius: 3px;
      }

      .notification-item {
        display: flex;
        gap: 12px;
        padding: 14px 24px;
        cursor: pointer;
        transition: background 0.2s;
        border-left: 3px solid transparent;
      }

      .notification-item:hover {
        background: #f9fafb;
      }

      .notification-item.unread {
        background: #eff6ff;
        border-left-color: #3b82f6;
      }

      .notification-item.unread:hover {
        background: #dbeafe;
      }

      .notification-icon {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.1em;
        flex-shrink: 0;
      }

      .notification-icon.critical {
        background: #fee2e2;
        color: #dc2626;
      }

      .notification-icon.warning {
        background: #fef3c7;
        color: #f59e0b;
      }

      .notification-icon.info {
        background: #dbeafe;
        color: #3b82f6;
      }

      .notification-icon.success {
        background: #d1fae5;
        color: #10b981;
      }

      .notification-body {
        flex: 1;
      }

      .notification-title {
        font-size: 0.9em;
        font-weight: 600;
        color: #111827;
        margin-bottom: 4px;
      }

      .notification-text {
        font-size: 0.85em;
        color: #6b7280;
        margin-bottom: 6px;
        line-height: 1.4;
      }

      .notification-time {
        font-size: 0.75em;
        color: #9ca3af;
      }

      .notification-dot {
        width: 8px;
        height: 8px;
        background: #3b82f6;
        border-radius: 50%;
        flex-shrink: 0;
        margin-top: 8px;
      }

      .notification-item:not(.unread) .notification-dot {
        display: none;
      }

      .notifications-footer {
        padding: 16px 24px;
        border-top: 1px solid #e5e7eb;
        flex-shrink: 0;
      }

      .view-all-btn {
        display: block;
        width: 100%;
        padding: 10px;
        background: #f3f4f6;
        color: #2563eb;
        text-align: center;
        text-decoration: none;
        border-radius: 8px;
        font-size: 0.9em;
        font-weight: 600;
        transition: all 0.2s;
      }

      .view-all-btn:hover {
        background: #e5e7eb;
      }

      .notification-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.4);
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
      }

      .notification-overlay.show {
        opacity: 1;
        visibility: visible;
      }

      /* OCR Page Styles */
      .page-header {
        background: white;
        padding: 20px 24px;
        border-radius: 12px;
        border: 1px solid #e5e7eb;
        margin-bottom: 24px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .page-title-section {
        display: flex;
        align-items: center;
        gap: 16px;
      }

      .page-icon {
        width: 48px;
        height: 48px;
        background: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .page-icon i {
        font-size: 22px;
        color: white;
      }

      .page-title-text h1 {
        font-size: 1.5em;
        color: #111827;
        font-weight: 700;
      }

      .page-subtitle {
        color: #6b7280;
        font-size: 0.9em;
      }

      .refresh-btn {
        padding: 10px 18px;
        background: #2563eb;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 0.9em;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s;
      }

      .refresh-btn:hover {
        background: #1d4ed8;
      }

      .refresh-btn:disabled {
        background: #9ca3af;
        cursor: not-allowed;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 16px;
        margin-bottom: 24px;
      }

      .stat-card {
        background: white;
        padding: 18px;
        border-radius: 12px;
        border: 1px solid #e5e7eb;
      }

      .stat-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 10px;
      }

      .stat-label {
        font-size: 0.8em;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 8px;
      }

      .stat-value {
        font-size: 1.7em;
        font-weight: 700;
        color: #111827;
      }

      .stat-icon {
        width: 42px;
        height: 42px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1em;
      }

      .stat-icon.blue {
        background: #dbeafe;
        color: #3b82f6;
      }

      .stat-icon.green {
        background: #d1fae5;
        color: #10b981;
      }

      .stat-icon.red {
        background: #fee2e2;
        color: #dc2626;
      }

      .stat-icon.yellow {
        background: #fef3c7;
        color: #f59e0b;
      }

      .stat-subtitle {
        font-size: 0.8em;
        color: #10b981;
        font-weight: 600;
      }

      .stat-subtitle.warning {
        color: #dc2626;
      }

      .content-grid {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
      }

      .card {
        background: white;
        padding: 20px;
        border-radius: 12px;
        border: 1px solid #e5e7eb;
      }

      .card-header {
        font-size: 1.05em;
        font-weight: 600;
        color: #111827;
        margin-bottom: 16px;
        padding-bottom: 12px;
        border-bottom: 1px solid #e5e7eb;
      }

      .agent-table {
        width: 100%;
        border-collapse: collapse;
      }

      .agent-table thead {
        background: #f9fafb;
      }

      .agent-table th {
        padding: 10px 12px;
        text-align: left;
        font-size: 0.75em;
        font-weight: 600;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border-bottom: 1px solid #e5e7eb;
      }

      .agent-table td {
        padding: 12px 12px;
        font-size: 0.85em;
        color: #374151;
        border-bottom: 1px solid #f3f4f6;
      }

      .agent-table tbody tr {
        cursor: pointer;
        transition: background 0.2s;
      }

      .agent-table tbody tr:hover {
        background: #f9fafb;
      }

      .status-dot {
        display: inline-block;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        margin-right: 6px;
      }

      .status-dot.active {
        background: #10b981;
      }

      .status-dot.inactive {
        background: #9ca3af;
      }

      .threat-bar {
        width: 100%;
        height: 6px;
        background: #e5e7eb;
        border-radius: 3px;
        overflow: hidden;
      }

      .threat-fill {
        height: 100%;
        background: linear-gradient(
          90deg,
          #10b981 0%,
          #f59e0b 50%,
          #dc2626 100%
        );
        transition: width 0.3s;
      }

      .violation-item {
        padding: 12px;
        background: #f9fafb;
        border-radius: 8px;
        margin-bottom: 10px;
        cursor: pointer;
        transition: all 0.2s;
      }

      .violation-item:hover {
        background: #f3f4f6;
        transform: translateX(2px);
      }

      .violation-item:last-child {
        margin-bottom: 0;
      }

      .violation-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 6px;
      }

      .violation-title {
        font-size: 0.9em;
        font-weight: 600;
        color: #111827;
      }

      .violation-time {
        font-size: 0.75em;
        color: #9ca3af;
      }

      .violation-details {
        font-size: 0.8em;
        color: #6b7280;
      }

      .violation-score {
        display: inline-block;
        padding: 3px 8px;
        border-radius: 4px;
        font-size: 0.75em;
        font-weight: 600;
        margin-top: 6px;
      }

      .score-high {
        background: #fee2e2;
        color: #dc2626;
      }

      .score-medium {
        background: #fef3c7;
        color: #f59e0b;
      }

      .score-low {
        background: #d1fae5;
        color: #059669;
      }

      /* Modal Styles */
      .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1001;
        animation: fadeIn 0.2s;
      }

      .modal-content {
        background: white;
        padding: 24px;
        border-radius: 12px;
        width: 90%;
        max-width: 500px;
        max-height: 80vh;
        overflow-y: auto;
        animation: slideUp 0.3s;
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
      }

      .modal-header h3 {
        margin: 0;
        font-size: 1.2em;
        color: #111827;
      }

      .modal-close {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #6b7280;
        transition: color 0.2s;
      }

      .modal-close:hover {
        color: #111827;
      }

      .modal-body {
        margin-bottom: 20px;
      }

      .modal-footer {
        display: flex;
        gap: 8px;
      }

      .modal-btn {
        flex: 1;
        padding: 10px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.2s;
      }

      .modal-btn-primary {
        background: #2563eb;
        color: white;
      }

      .modal-btn-primary:hover {
        background: #1d4ed8;
      }

      .modal-btn-secondary {
        background: #e5e7eb;
        color: #374151;
      }

      .modal-btn-secondary:hover {
        background: #d1d5db;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      @keyframes slideUp {
        from {
          transform: translateY(20px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      /* Enhanced Responsive Styles */
      @media (max-width: 1200px) {
        .content-grid {
          grid-template-columns: 1.5fr 1fr;
        }
      }

      @media (max-width: 968px) {
        .main-content {
          margin-left: 0;
          max-width: 100vw;
        }

        .top-header {
          left: 0;
        }

        .mobile-menu-toggle {
          display: block;
        }

        .sidebar {
          transform: translateX(-100%);
          transition: transform 0.3s ease;
        }

        .sidebar.mobile-open {
          transform: translateX(0);
        }

        .content-grid {
          grid-template-columns: 1fr;
        }

        .stats-grid {
          grid-template-columns: repeat(2, 1fr);
        }
      }

      @media (max-width: 768px) {
        .content-area {
          padding: 16px;
          padding-top: 80px;
        }

        .notifications-panel {
          width: 90%;
          right: -90%;
        }

        .page-header {
          flex-direction: column;
          align-items: flex-start;
          gap: 12px;
          padding: 16px;
        }

        .stats-grid {
          grid-template-columns: 1fr;
        }

        .page-title-section {
          width: 100%;
        }

        .refresh-btn {
          width: 100%;
          justify-content: center;
        }

        .user-info {
          display: none;
        }
      }

      @media (max-width: 640px) {
        .content-area {
          padding: 12px;
          padding-top: 70px;
        }

        .stat-card {
          padding: 14px;
        }

        .card {
          padding: 16px;
        }

        .agent-table td,
        .agent-table th {
          padding: 8px 10px;
          font-size: 0.8em;
        }

        .violation-item {
          padding: 10px;
        }

        .page-icon {
          width: 40px;
          height: 40px;
        }

        .page-icon i {
          font-size: 18px;
        }

        .page-title-text h1 {
          font-size: 1.3em;
        }

        .stat-value {
          font-size: 1.5em;
        }

        .stat-icon {
          width: 36px;
          height: 36px;
        }
      }
    </style>
  </head>
  <body>
    <div class="dashboard-container">
      <!-- ==================== SIDEBAR ==================== -->
      <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
          <div class="sidebar-logo">
            <i class="fas fa-shield-halved"></i>
          </div>
          <div class="sidebar-title">DLP Shield</div>
        </div>

        <nav class="nav-menu">
          <div class="nav-item">
            <a href="dashboard.html" class="nav-link" data-page="dashboard">
              <i class="fas fa-th-large"></i>
              <span>Dashboard</span>
            </a>
          </div>

          <div class="nav-item">
            <a href="alerts.html" class="nav-link" data-page="alerts">
              <i class="fas fa-triangle-exclamation"></i>
              <span>Alerts &amp; Incidents</span>
            </a>
          </div>

          <div class="nav-item">
            <div class="nav-link nav-dropdown" onclick="toggleSubMenu(this)">
              <i class="fas fa-shield-alt"></i>
              <span>Policies</span>
              <i class="fas fa-chevron-down chevron-icon"></i>
            </div>
            <div class="sub-menu">
              <a
                href="manage-agents.html"
                class="sub-menu-item"
                data-page="manage-agents"
                >Manage Agents</a
              >
              <a
                href="file-policies.html"
                class="sub-menu-item"
                data-page="file-policies"
                >File Policies</a
              >
              <a
                href="assign-policy.html"
                class="sub-menu-item"
                data-page="assign-policy"
                >Assign Policy</a
              >
            </div>
          </div>

          <div class="nav-item">
            <a href="agents.html" class="nav-link" data-page="agents">
              <i class="fas fa-desktop"></i>
              <span>Agents / Endpoints</span>
            </a>
          </div>

          <div class="nav-item">
            <div class="nav-link nav-dropdown expanded" onclick="toggleSubMenu(this)">
              <i class="fas fa-eye"></i>
              <span>OCR &amp; Image Analysis</span>
              <i class="fas fa-chevron-down chevron-icon"></i>
            </div>
            <div class="sub-menu open">
              <a
                href="ocr-dashboard.html"
                class="sub-menu-item active"
                data-page="ocr-dashboard"
                >OCR Dashboard</a
              >
              <a
                href="ocr-policies.html"
                class="sub-menu-item"
                data-page="ocr-policies"
                >OCR Policies</a
              >
            </div>
          </div>

          <div class="nav-item">
            <div class="nav-link nav-dropdown" onclick="toggleSubMenu(this)">
              <i class="fas fa-file-lines"></i>
              <span>Reports &amp; Logs</span>
              <i class="fas fa-chevron-down chevron-icon"></i>
            </div>
            <div class="sub-menu">
              <a href="reports.html" class="sub-menu-item" data-page="reports"
                >Reports</a
              >
              <a
                href="generate-report.html"
                class="sub-menu-item"
                data-page="generate-report"
                >Generate Report</a
              >
              <a
                href="audit-logs.html"
                class="sub-menu-item"
                data-page="audit-logs"
                >Audit Logs</a
              >
              <a
                href="device-logs.html"
                class="sub-menu-item"
                data-page="device-logs"
                >Device Logs</a
              >
            </div>
          </div>

          <div class="nav-item">
            <div class="nav-link nav-dropdown" onclick="toggleSubMenu(this)">
              <i class="fas fa-users"></i>
              <span>Users &amp; Roles</span>
              <i class="fas fa-chevron-down chevron-icon"></i>
            </div>
            <div class="sub-menu">
              <a href="users.html" class="sub-menu-item" data-page="users"
                >Users</a
              >
              <a href="roles.html" class="sub-menu-item" data-page="roles"
                >Roles &amp; Permissions</a
              >
              <a
                href="permissions.html"
                class="sub-menu-item"
                data-page="permissions"
                >Permissions</a
              >
            </div>
          </div>

          <div class="nav-item">
            <div class="nav-link nav-dropdown" onclick="toggleSubMenu(this)">
              <i class="fas fa-gear"></i>
              <span>Settings</span>
              <i class="fas fa-chevron-down chevron-icon"></i>
            </div>
            <div class="sub-menu">
              <a href="general.html" class="sub-menu-item" data-page="general"
                >General</a
              >
              <a href="security.html" class="sub-menu-item" data-page="security"
                >Security</a
              >
              <a
                href="integrations.html"
                class="sub-menu-item"
                data-page="integrations"
                >Integrations</a
              >
              <a
                href="data-retention.html"
                class="sub-menu-item"
                data-page="data-retention"
                >Data Retention</a
              >
            </div>
          </div>
        </nav>

        <div class="sidebar-footer">
          <button class="collapse-btn" onclick="toggleSidebar()">
            <i class="fas fa-chevron-left"></i>
            <span>Collapse</span>
          </button>
        </div>
      </aside>

      <!-- Mobile Overlay (for sidebar) -->
      <div
        class="sidebar-overlay"
        id="sidebarOverlay"
        onclick="closeMobileSidebar()"
      ></div>

      <!-- ==================== HEADER ==================== -->
      <header class="top-header" id="topHeader">
        <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">
          <i class="fas fa-bars"></i>
        </button>

        <div class="search-bar">
          <i class="fas fa-search"></i>
          <input
            type="text"
            class="search-input"
            placeholder="Search alerts, agents, policies..."
          />
        </div>

        <div class="header-actions">
          <button class="notification-btn" onclick="toggleNotifications(event)">
            <i class="fas fa-bell"></i>
            <span class="notification-badge" id="alertBadge">5</span>
          </button>

          <div class="user-profile" onclick="toggleUserDropdown(event)">
            <div class="user-avatar">A</div>
            <div class="user-info">
              <div class="user-name">Admin</div>
              <div class="user-role">Security Admin</div>
            </div>
            <i class="fas fa-chevron-down dropdown-icon"></i>

            <div class="user-dropdown" id="userDropdown">
              <a href="general.html" class="dropdown-item">
                <i class="fas fa-gear"></i>
                <span>Settings</span>
              </a>
              <a href="#" class="dropdown-item">
                <i class="fas fa-circle-question"></i>
                <span>Help &amp; Support</span>
              </a>
              <div class="dropdown-divider"></div>
              <a
                href="index.html"
                class="dropdown-item danger"
                onclick="logout(event)"
              >
                <i class="fas fa-right-from-bracket"></i>
                <span>Sign out</span>
              </a>
            </div>
          </div>
        </div>
      </header>

      <!-- ==================== NOTIFICATIONS PANEL ==================== -->
      <div class="notifications-panel" id="notificationsPanel">
        <div class="notifications-header">
          <h3>Notifications</h3>
          <button class="close-notifications" onclick="closeNotifications()">
            <i class="fas fa-times"></i>
          </button>
        </div>

        <div class="notifications-tabs">
          <button class="tab-btn active" onclick="switchTab(event, 'all')">
            All (5)
          </button>
          <button class="tab-btn" onclick="switchTab(event, 'unread')">
            Unread (3)
          </button>
        </div>

        <div class="notifications-content" id="notificationsContent">
          <div class="notification-item unread">
            <div class="notification-icon critical">
              <i class="fas fa-shield-exclamation"></i>
            </div>
            <div class="notification-body">
              <div class="notification-title">Critical Policy Violation</div>
              <div class="notification-text">
                User attempted to copy sensitive files to USB drive
              </div>
              <div class="notification-time">2 minutes ago</div>
            </div>
            <div class="notification-dot"></div>
          </div>

          <div class="notification-item unread">
            <div class="notification-icon warning">
              <i class="fas fa-triangle-exclamation"></i>
            </div>
            <div class="notification-body">
              <div class="notification-title">Agent Offline</div>
              <div class="notification-text">
                DESKTOP-DEF456 has been offline for 2 hours
              </div>
              <div class="notification-time">15 minutes ago</div>
            </div>
            <div class="notification-dot"></div>
          </div>

          <div class="notification-item unread">
            <div class="notification-icon info">
              <i class="fas fa-info-circle"></i>
            </div>
            <div class="notification-body">
              <div class="notification-title">Policy Updated</div>
              <div class="notification-text">
                File Protection Policy has been modified by Admin
              </div>
              <div class="notification-time">1 hour ago</div>
            </div>
            <div class="notification-dot"></div>
          </div>

          <div class="notification-item">
            <div class="notification-icon success">
              <i class="fas fa-check-circle"></i>
            </div>
            <div class="notification-body">
              <div class="notification-title">Agent Connected</div>
              <div class="notification-text">
                New agent LAPTOP-XYZ789 successfully registered
              </div>
              <div class="notification-time">3 hours ago</div>
            </div>
          </div>

          <div class="notification-item">
            <div class="notification-icon info">
              <i class="fas fa-file-alt"></i>
            </div>
            <div class="notification-body">
              <div class="notification-title">Report Generated</div>
              <div class="notification-text">
                Weekly security report is ready for review
              </div>
              <div class="notification-time">5 hours ago</div>
            </div>
          </div>
        </div>

        <div class="notifications-footer">
          <a href="alerts.html" class="view-all-btn">View All Notifications</a>
        </div>
      </div>

      <!-- Notification Overlay -->
      <div
        class="notification-overlay"
        id="notificationOverlay"
        onclick="closeNotifications()"
      ></div>

      <main class="main-content" id="mainContent">
        <div class="content-area">
          <div class="page-header">
            <div class="page-title-section">
              <div class="page-icon"><i class="fas fa-eye"></i></div>
              <div class="page-title-text">
                <h1>OCR & Image Analysis</h1>
                <p class="page-subtitle">
                  Monitor screen content and detect sensitive data
                </p>
              </div>
            </div>
            <button class="refresh-btn" onclick="refreshData()">
              <i class="fas fa-rotate"></i><span>Refresh (5s)</span>
            </button>
          </div>

          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-header">
                <div>
                  <div class="stat-label">OCR-Capable Agents</div>
                  <div class="stat-value" id="totalCapableAgents">0</div>
                </div>
                <div class="stat-icon blue"><i class="fas fa-desktop"></i></div>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-header">
                <div>
                  <div class="stat-label">Active OCR Agents</div>
                  <div class="stat-value" id="activeOcrAgents">0</div>
                </div>
                <div class="stat-icon green">
                  <i class="fas fa-chart-line"></i>
                </div>
              </div>
              <div class="stat-subtitle" id="coveragePercentage">0% coverage</div>
            </div>
            <div class="stat-card">
              <div class="stat-header">
                <div>
                  <div class="stat-label">High Threat Agents</div>
                  <div class="stat-value" id="highThreatCount">0</div>
                </div>
                <div class="stat-icon red">
                  <i class="fas fa-triangle-exclamation"></i>
                </div>
              </div>
              <div class="stat-subtitle warning">Threat score >70%</div>
            </div>
            <div class="stat-card">
              <div class="stat-header">
                <div>
                  <div class="stat-label">Violations (24h)</div>
                  <div class="stat-value" id="totalViolations24h">0</div>
                </div>
                <div class="stat-icon yellow"><i class="fas fa-bell"></i></div>
              </div>
              <div class="stat-subtitle" id="violationsTrend">Loading...</div>
            </div>
          </div>

          <div class="content-grid">
            <div class="card">
              <div class="card-header">OCR Agent Status</div>
              <table class="agent-table">
                <thead>
                  <tr>
                    <th>Agent</th>
                    <th>OCR Status</th>
                    <th>Threat Score</th>
                    <th>Last Screenshot</th>
                    <th>Violations</th>
                  </tr>
                </thead>
                <tbody id="agentTableBody">
                  <!-- Agent rows will be populated by JavaScript -->
                </tbody>
              </table>
            </div>

            <div class="card">
              <div class="card-header">Recent Violations</div>
              <div id="recentViolationsList">
                <!-- Violations will be dynamically loaded here -->
                <div class="loading-placeholder">
                  <div class="violation-item" style="opacity: 0.6">
                    <div class="violation-header">
                      <div class="violation-title">Loading...</div>
                      <div class="violation-time">--:--</div>
                    </div>
                    <div class="violation-details">
                      Fetching recent violations
                    </div>
                    <span class="violation-score score-low">0% confidence</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>

    <script th:inline="javascript">
      /* ==================== AUTHENTICATION & USER DATA ==================== */

        // User data is passed directly from the controller
      const userData = {
        username: [[${username}]],
        userName: [[${userName}]],
        userInitials: [[${userInitials}]],
        userRole: [[${userRole}]],
        userEmail: [[${userEmail}]],
        userId: [[${userId}]]
      };
      console.log('User data loaded from server:', userData);

      // Load admin info into header
      function loadAdminInfo() {
        const userName = document.querySelector(".user-name");
        const userAvatar = document.querySelector(".user-avatar");
        const userRole = document.querySelector(".user-role");

        if (userName && userData.userName) {
          userName.textContent = userData.userName;
        }

        if (userAvatar && userData.userInitials) {
          userAvatar.textContent = userData.userInitials;
        }

        if (userRole && userData.userRole) {
          userRole.textContent = userData.userRole;
        }
      }

      /* ==================== SIDEBAR FUNCTIONS ==================== */

      function toggleSubMenu(element) {
        var sidebar = document.getElementById("sidebar");
        if (sidebar.classList.contains("collapsed")) return;

        var subMenu = element.nextElementSibling;
        var allSubMenus = document.querySelectorAll(".sub-menu");
        var allDropdowns = document.querySelectorAll(".nav-dropdown");

        // Close other open submenus
        allSubMenus.forEach(function (menu) {
          if (menu !== subMenu) menu.classList.remove("open");
        });
        allDropdowns.forEach(function (link) {
          if (link !== element) link.classList.remove("expanded");
        });

        // Toggle current
        element.classList.toggle("expanded");
        subMenu.classList.toggle("open");
      }

      function toggleSidebar() {
        var sidebar = document.getElementById("sidebar");
        var mainContent = document.getElementById("mainContent");
        var header = document.getElementById("topHeader");

        sidebar.classList.toggle("collapsed");
        var isCollapsed = sidebar.classList.contains("collapsed");

        if (mainContent) mainContent.classList.toggle("expanded");

        // Update header left position
        if (header) {
          header.style.left = isCollapsed ? "70px" : "240px";
        }

        // Close all submenus when collapsing
        if (isCollapsed) {
          document.querySelectorAll(".sub-menu").forEach(function (m) {
            m.classList.remove("open");
          });
          document.querySelectorAll(".nav-dropdown").forEach(function (l) {
            l.classList.remove("expanded");
          });
        }

        // Dispatch event for other components
        window.dispatchEvent(
          new CustomEvent("sidebarToggle", {
            detail: { collapsed: isCollapsed },
          })
        );
      }

      function openMobileSidebar() {
        var sidebar = document.getElementById("sidebar");
        var overlay = document.getElementById("sidebarOverlay");
        if (sidebar) sidebar.classList.add("mobile-open");
        if (overlay) overlay.classList.add("active");
      }

      function closeMobileSidebar() {
        var sidebar = document.getElementById("sidebar");
        var overlay = document.getElementById("sidebarOverlay");
        if (sidebar) sidebar.classList.remove("mobile-open");
        if (overlay) overlay.classList.remove("active");
      }

      function toggleMobileMenu() {
        var sidebar = document.getElementById("sidebar");
        var overlay = document.getElementById("sidebarOverlay");
        if (!sidebar) return;

        if (sidebar.classList.contains("mobile-open")) {
          closeMobileSidebar();
        } else {
          openMobileSidebar();
        }
      }

      function setActiveMenuItem() {
        var currentPage = window.location.pathname.split('/').pop() || 'ocr-dashboard.html';

        // First remove all active classes
        document.querySelectorAll('.nav-link, .sub-menu-item').forEach(function(el) {
          el.classList.remove('active');
        });

        // Handle sub-menu items
        document.querySelectorAll('.sub-menu-item[data-page]').forEach(function (item) {
          var href = item.getAttribute('href');
          if (href === currentPage) {
            item.classList.add('active');
            var parentSubMenu = item.closest('.sub-menu');
            if (parentSubMenu) {
              parentSubMenu.classList.add('open');
              var parentNav = parentSubMenu.previousElementSibling;
              if (parentNav) parentNav.classList.add('expanded');
            }
          }
        });

        // Handle main nav links
        document.querySelectorAll('.nav-link[data-page]').forEach(function (link) {
          var href = link.getAttribute('href');
          if (href === currentPage) {
            link.classList.add('active');
          }
        });
      }

      /* ==================== HEADER FUNCTIONS ==================== */

      function toggleNotifications(event) {
        event.stopPropagation();
        var panel = document.getElementById("notificationsPanel");
        var overlay = document.getElementById("notificationOverlay");
        var btn = event.currentTarget;
        if (!panel || !overlay) return;

        if (panel.classList.contains("show")) {
          closeNotifications();
        } else {
          closeUserDropdown();
          panel.classList.add("show");
          overlay.classList.add("show");
          btn.classList.add("active");
          document.body.style.overflow = "hidden";
        }
      }

      function closeNotifications() {
        var panel = document.getElementById("notificationsPanel");
        var overlay = document.getElementById("notificationOverlay");
        var btn = document.querySelector(".notification-btn");
        if (panel) panel.classList.remove("show");
        if (overlay) overlay.classList.remove("show");
        if (btn) btn.classList.remove("active");
        document.body.style.overflow = "";
      }

      function switchTab(event, tabName) {
        document.querySelectorAll(".tab-btn").forEach(function (t) {
          t.classList.remove("active");
        });
        event.currentTarget.classList.add("active");

        document
          .querySelectorAll(".notification-item")
          .forEach(function (item) {
            item.style.display =
              tabName === "unread" && !item.classList.contains("unread")
                ? "none"
                : "flex";
          });
      }

      function toggleUserDropdown(event) {
        event.stopPropagation();
        var dropdown = document.getElementById("userDropdown");
        var userProfile = event.currentTarget;
        if (!dropdown) return;

        if (dropdown.classList.contains("show")) {
          closeUserDropdown();
        } else {
          closeNotifications();
          dropdown.classList.add("show");
          userProfile.classList.add("active");
        }
      }

      function closeUserDropdown() {
        var dropdown = document.getElementById("userDropdown");
        var userProfile = document.querySelector(".user-profile");
        if (dropdown) dropdown.classList.remove("show");
        if (userProfile) userProfile.classList.remove("active");
      }

      function logout(event) {
        event.preventDefault();
        window.location.href = "/logout";
      }

      // Close dropdowns when clicking outside
      document.addEventListener("click", function (event) {
        if (!event.target.closest(".user-profile")) {
          closeUserDropdown();
        }
        if (
          !event.target.closest(".notification-btn") &&
          !event.target.closest(".notifications-panel")
        ) {
          closeNotifications();
        }
      });

      /* ==================== OCR DASHBOARD FUNCTIONS ==================== */

      // Global variables
      let ocrDashboardStats = {
        totalCapableAgents: 0,
        activeOcrAgents: 0,
        highThreatCount: 0,
        totalViolations24h: 0,
        coveragePercentage: 0,
        lastUpdated: null,
        summary: null,
        agents: [],
      };

      let autoRefreshInterval = null;

      // Safe element getter with null check
      function getElementSafe(id) {
        const element = document.getElementById(id);
        if (!element) {
          console.warn(`âš ï¸ Element with id "${id}" not found`);
        }
        return element;
      }

      // Update element text safely
      function updateElementText(id, text) {
        const element = getElementSafe(id);
        if (element) {
          element.textContent = text;
        }
      }

      async function callApi(path, options = {}) {
        const defaultOptions = {
          method: "GET",
          credentials: "include",
          headers: { "Content-Type": "application/json" },
        };

        const opts = { ...defaultOptions, ...options };

        try {
          const response = await fetch(path, opts);
          const text = await response.text();
          const json = text ? JSON.parse(text) : null;

          if (!response.ok) {
            throw new Error(json?.message || `HTTP ${response.status}`);
          }

          return json;
        } catch (error) {
          console.error(`API call to ${path} failed:`, error);
          throw error;
        }
      }

      // Main function to load OCR dashboard data
      async function loadOcrDashboardData() {
        try {
          console.log("ðŸ”„ Loading OCR dashboard data...");

          // Show loading state safely
          updateElementText("totalCapableAgents", "...");
          updateElementText("activeOcrAgents", "...");
          updateElementText("highThreatCount", "...");
          updateElementText("totalViolations24h", "...");
          updateElementText("coveragePercentage", "Loading...");

          // Fetch data from backend APIs
          const [statusResult, summaryResult, highThreatResult] = await Promise.all([
            fetch("/api/admin/ocr/status", { credentials: "include" }),
            fetch("/api/admin/ocr/summary", { credentials: "include" }),
            fetch("/api/admin/ocr/high-threat-agents/count", { credentials: "include" })
          ]);

          if (!statusResult.ok) {
            throw new Error(`Status API failed: ${statusResult.status}`);
          }

          if (!summaryResult.ok) {
            throw new Error(`Summary API failed: ${summaryResult.status}`);
          }

          const statusData = await statusResult.json();
          const summaryData = await summaryResult.json();
          const highThreatData = highThreatResult.ok ? await highThreatResult.json() : null;

          console.log("ðŸ“Š Status data:", statusData);
          console.log("ðŸ“ˆ Summary data:", summaryData);

          if (!statusData.success) {
            throw new Error(
              `Status API error: ${statusData.message || "Unknown error"}`
            );
          }

          // Update stats
          const agents = statusData.data || [];
          const summary = summaryData;

          // Calculate statistics
          const totalCapable = summary.totalCapableAgents || agents.length;
          const activeOcr =
            summary.activeOcr ||
            agents.filter(
              (a) => a.ocrEnabled === true || a.ocr_enabled === true
            ).length;

          const highThreat = highThreatData?.data?.count || 
                            agents.filter(a => {
                              const score = a.currentThreatScore || a.current_threat_score || 0;
                              return score >= 70;
                            }).length;

          const violations24h = agents.reduce((sum, a) => {
            return sum + (a.violationsLast24h || a.violations_last_24h || 0);
          }, 0);

          const coveragePercentage =
            totalCapable > 0 ? Math.round((activeOcr / totalCapable) * 100) : 0;

          // Update UI
          updateDashboardUI(
            totalCapable,
            activeOcr,
            highThreat,
            violations24h,
            coveragePercentage
          );

          // Store data for later use
          ocrDashboardStats = {
            totalCapableAgents: totalCapable,
            activeOcrAgents: activeOcr,
            highThreatCount: highThreat,
            totalViolations24h: violations24h,
            coveragePercentage: coveragePercentage,
            lastUpdated: new Date(),
            summary: summary,
            agents: agents,
          };

          // Also update the agent table with real data
          updateAgentTable(agents);

          // Load recent violations
          await loadRecentViolations();

          console.log("âœ… OCR dashboard data loaded:", ocrDashboardStats);
        } catch (error) {
          console.error("âŒ Error loading OCR dashboard:", error);

          // Show error in UI safely
          updateElementText("totalCapableAgents", "Error");
          updateElementText("activeOcrAgents", "Error");
          updateElementText("highThreatCount", "Error");
          updateElementText("totalViolations24h", "Error");
          updateElementText("coveragePercentage", "Error");
        }
      }

      // Update the dashboard UI with new data
      function updateDashboardUI(
        totalCapable,
        activeOcr,
        highThreat,
        violations24h,
        coveragePercentage
      ) {
        // Update the HTML elements
        updateElementText("totalCapableAgents", totalCapable);
        updateElementText("activeOcrAgents", activeOcr);
        updateElementText("highThreatCount", highThreat);
        updateElementText("totalViolations24h", violations24h);

        const coverageEl = getElementSafe("coveragePercentage");
        if (coverageEl) {
          coverageEl.textContent = `${coveragePercentage}% coverage`;
        }

        // Update last updated time
        const now = new Date();
        const trendEl = getElementSafe("violationsTrend");
        if (trendEl) {
          trendEl.textContent = `Updated: ${now.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" })}`;
          trendEl.style.color = "#6b7280";
        }
      }

      async function loadRecentViolations() {
        try {
          console.log('ðŸ”„ Loading recent violations...');

          // First, get all agents with OCR status
          const statusResult = await callApi("/api/admin/ocr/status", {
            credentials: "include"
          });

          if (!statusResult || !statusResult.success) {
            throw new Error(`Status API failed: ${statusResult?.message || 'Unknown error'}`);
          }

          const agents = statusResult.data || [];
          console.log("ðŸ“Š Agents from OCR status API:", agents);

          // Create a mapping of agent ID to hostname
          const agentHostnameMap = {};

          agents.forEach(agent => {
            const agentId = agent.agentId || agent.agent_id;

            const hostname = agent.hostname ||
                           agent.agent_hostname ||
                           agent.agentHostname ||
                           `Agent ${agentId}`;

            const username = agent.username ||
                           agent.agent_username ||
                           agent.agentUsername ||
                           'N/A';

            if (agentId) {
              agentHostnameMap[agentId] = {
                hostname: hostname,
                username: username,
                rawAgentData: agent
              };
            }
          });

          console.log("ðŸ“Š Agent hostname mapping:", agentHostnameMap);

          if (agents.length === 0) {
            displayRecentViolations([], agentHostnameMap);
            return [];
          }

          // Get violations for ALL agents in parallel
          const violationPromises = agents.map(async (agent) => {
            try {
              const agentId = agent.agentId || agent.agent_id;

              const response = await fetch(`/api/admin/ocr/violations/${agentId}`, {
                credentials: "include"
              });

              if (response.ok) {
                const result = await response.json();
                if (result.success && result.data) {
                  return result.data.map(violation => ({
                    ...violation,
                    agent_id: agentId,
                    agent_hostname: agentHostnameMap[agentId]?.hostname ||
                                  violation.agent_hostname ||
                                  violation.agentHostname ||
                                  `Agent ${agentId}`,
                    agent_username: agentHostnameMap[agentId]?.username ||
                                   violation.agent_username ||
                                   violation.agentUsername ||
                                   'N/A'
                  }));
                }
              }
              return [];
            } catch (error) {
              console.warn(`Failed to get violations for agent ${agent.agentId}:`, error);
              return [];
            }
          });

          // Wait for all requests to complete
          const violationsArrays = await Promise.all(violationPromises);

          // Flatten the array and sort by timestamp
          let allViolations = [];
          violationsArrays.forEach(arr => {
            allViolations = allViolations.concat(arr);
          });

          // Sort by timestamp (newest first)
          allViolations.sort((a, b) => {
            const timeA = new Date(a.timestamp || 0);
            const timeB = new Date(b.timestamp || 0);
            return timeB - timeA;
          });

          // Take only the 7 most recent violations
          const recentViolations = allViolations.slice(0, 7);

          console.log(`âœ… Loaded ${recentViolations.length} recent violations`);

          // Display the violations
          displayRecentViolations(recentViolations, agentHostnameMap);

          return recentViolations;
        } catch (error) {
          console.error('âŒ Error loading recent violations:', error);
          displayRecentViolations([], {});
          return [];
        }
      }

      function displayRecentViolations(violations, agentHostnameMap = {}) {
        const container = document.getElementById("recentViolationsList");
        if (!container) {
          console.warn("âš ï¸ Recent violations container not found");
          return;
        }

        if (violations.length === 0) {
          container.innerHTML = `
            <div class="violation-item" style="opacity: 0.7;">
                <div class="violation-header">
                    <div class="violation-title">No violations found</div>
                    <div class="violation-time">--:--</div>
                </div>
                <div class="violation-details">No recent violations detected</div>
                <span class="violation-score score-low">0% confidence</span>
            </div>
          `;
          return;
        }

        // Sort violations by timestamp (newest first)
        violations.sort(
          (a, b) => new Date(b.timestamp) - new Date(a.timestamp)
        );

        // Take only the first 7 violations
        const recentViolations = violations.slice(0, 7);

        // Create HTML for each violation
        const violationsHtml = recentViolations
          .map((violation, index) => {
            const agentId = violation.agent_id || violation.agentId || "Unknown";

            const hostname = agentHostnameMap[agentId]?.hostname ||
                            violation.agent_hostname ||
                            violation.agentHostname ||
                            `Agent ${agentId}`;

            const username = agentHostnameMap[agentId]?.username ||
                            violation.agent_username ||
                            violation.agentUsername ||
                            '';

            let displayName = hostname;
            if (username && username !== 'N/A' && username !== '') {
              displayName = `${hostname} (${username})`;
            }

            const timeAgo = formatTimeAgo(violation.timestamp);

            const violationType = getViolationTypeDisplay(
              violation.rule_type || violation.ruleType
            );

            const confidence = Math.round((violation.confidence || 0) * 100);
            const confidenceClass = getConfidenceClass(
              violation.confidence || 0
            );

            const matchedText = violation.matched_text ||
                              violation.matchedText ||
                              "No text available";
            const textSnippet = matchedText.length > 50
              ? matchedText.substring(0, 50) + "..."
              : matchedText;

            return `
            <div class="violation-item" onclick="viewViolationDetail('${violation.id || index}', '${agentId}')">
                <div class="violation-header">
                    <div class="violation-title">${escapeHtml(displayName)}</div>
                    <div class="violation-time">${timeAgo}</div>
                </div>
                <div class="violation-details">${escapeHtml(violationType.toLowerCase())}</div>
                <div class="violation-snippet" style="font-size: 0.75em; color: #6b7280; margin-top: 4px; font-family: monospace;">
                    "${escapeHtml(textSnippet)}"
                </div>
                <span class="violation-score ${confidenceClass}">${confidence}% confidence</span>
            </div>
          `;
          })
          .join("");

        container.innerHTML = violationsHtml;
      }

      // Helper function to get violation type display name
      function getViolationTypeDisplay(ruleType) {
        if (!ruleType) return "Unknown Violation";

        const typeMap = {
          CREDIT_CARD: "Credit Card Number",
          CREDIT_CARD_NUMBER: "Credit Card Number",
          SSN: "Social Security Number",
          SOCIAL_SECURITY: "Social Security Number",
          BANK_ACCOUNT: "Bank Account",
          BANK_ACCOUNT_NUMBER: "Bank Account",
          AADHAAR: "Aadhaar Number",
          PASSWORD: "Password",
          PII: "Personal Information",
          PERSONAL_INFO: "Personal Information",
          PHONE_NUMBER: "Phone Number",
          EMAIL_ADDRESS: "Email Address",
          DRIVER_LICENSE: "Driver License",
          PASSPORT: "Passport Number",
          TAX_ID: "Tax ID",
        };

        return typeMap[ruleType] || ruleType.replace(/_/g, " ");
      }

      // Helper function to get confidence class
      function getConfidenceClass(confidence) {
        if (confidence >= 0.9) return "score-high";
        if (confidence >= 0.7) return "score-medium";
        return "score-low";
      }

      // Update the agent table with real data
      function updateAgentTable(agents) {
        const tbody = document.getElementById("agentTableBody");
        if (!tbody) {
          console.warn("âš ï¸ Agent table tbody not found");
          return;
        }

        // Clear existing rows
        tbody.innerHTML = "";

        if (agents.length === 0) {
          // Show empty state
          tbody.innerHTML = `
            <tr>
              <td colspan="5" style="text-align: center; padding: 40px; color: #6b7280;">
                No OCR agents found
              </td>
            </tr>
          `;
          return;
        }

        // Create rows for each agent
        agents.forEach((agent, index) => {
          const hostname =
            agent.agentHostname ||
            agent.agent_hostname ||
            `Agent ${agent.agentId || agent.agent_id || "Unknown"}`;

          const username =
            agent.agent_username ||
            agent.agentUsername ||
            agent.agentHostname ||
            agent.agent_hostname ||
            "Unknown";

          const isActive =
            agent.ocrEnabled === true || agent.ocr_enabled === true;
          const threatScore =
            agent.currentThreatScore || agent.current_threat_score || 0;
          const violations =
            agent.violationsLast24h || agent.violations_last_24h || 0;
          const lastScreenshot =
            agent.lastScreenshotTime || agent.last_screenshot_time;
          const agentId = agent.agentId || agent.agent_id || index;

          // Determine color for violations count
          let color = "#dc2626"; // red
          if (violations === 0)
            color = "#6b7280"; // gray
          else if (violations < 5) color = "#f59e0b"; // orange

          const row = document.createElement("tr");
          row.setAttribute("onclick", `viewAgentDetails('${agentId}')`);
          row.style.cursor = "pointer";

          row.innerHTML = `
            <td>
              <strong>${escapeHtml(hostname)}</strong>
              <br>
              <span style="font-size: 0.75em; color: #6b7280;">${escapeHtml(username)}</span>
            </td>
            <td>
              <span class="status-dot ${isActive ? "active" : "inactive"}"></span>
              ${isActive ? "Active" : "Inactive"}
            </td>
            <td>
              <div style="display: flex; align-items: center; gap: 8px;">
                <div class="threat-bar" style="width: 60px;">
                  <div class="threat-fill" style="width: ${Math.min(threatScore, 100)}%;"></div>
                </div>
                <span style="font-weight: 600;">${threatScore}%</span>
              </div>
            </td>
            <td>${lastScreenshot ? formatTimeAgo(lastScreenshot) : "N/A"}</td>
            <td><strong style="color: ${color};">${violations}</strong></td>
          `;

          tbody.appendChild(row);
        });
      }

      // Helper function to escape HTML
      function escapeHtml(text) {
        if (!text) return "";
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      // Helper function to format time ago
      function formatTimeAgo(timestamp) {
        if (!timestamp) return "N/A";

        try {
          const date = new Date(timestamp);
          const now = new Date();

          const diffMs = now.getTime() - date.getTime();
          const diffMins = Math.floor(diffMs / 60000);
          const diffHours = Math.floor(diffMs / 3600000);
          const diffDays = Math.floor(diffMs / 86400000);

          if (diffMins < 1) return "Just now";
          if (diffMins < 60) return `${diffMins}m ago`;
          if (diffHours < 24) return `${diffHours}h ago`;
          return `${diffDays}d ago`;
        } catch (e) {
          console.error('Error parsing date:', e);
          return "Invalid date";
        }
      }

      // Dashboard functions
      function refreshData() {
        console.log("ðŸ”„ Manual refresh triggered");
        loadOcrDashboardData();

        // Show visual feedback
        const btn = document.querySelector(".refresh-btn");
        if (btn) {
          const originalText = btn.innerHTML;
          btn.innerHTML =
            '<i class="fas fa-spinner fa-spin"></i><span>Refreshing...</span>';
          btn.disabled = true;

          setTimeout(() => {
            btn.innerHTML = originalText;
            btn.disabled = false;
          }, 1000);
        }
      }

      // Start auto-refresh
      function startAutoRefresh() {
        stopAutoRefresh(); // Clear any existing interval

        autoRefreshInterval = setInterval(() => {
          console.log("ðŸ”„ Auto-refreshing OCR data...");
          loadOcrDashboardData();
        }, 5000); // Refresh every 5 seconds

        console.log("âœ… Auto-refresh started (5s interval)");
      }

      // Stop auto-refresh
      function stopAutoRefresh() {
        if (autoRefreshInterval) {
          clearInterval(autoRefreshInterval);
          autoRefreshInterval = null;
          console.log("â¹ï¸ Auto-refresh stopped");
        }
      }

      // View agent details
      async function viewAgentDetails(agentId) {
        console.log(`ðŸ‘ï¸ Viewing details for agent: ${agentId}`);

        try {
          const response = await fetch(`/api/admin/ocr/violations/${agentId}`, {
            credentials: "include",
          });

          if (response.ok) {
            const result = await response.json();
            if (result.success) {
              const violations = result.data || [];

              const violationTypes = violations
                .map((v) => v.ruleType || v.rule_type || "Unknown")
                .join(", ");

              alert(
                `Agent ${agentId} Details:\n\n` +
                  `Total Violations: ${violations.length}\n` +
                  `Violation Types: ${violationTypes || "None"}\n\n` +
                  `Click OK to view more details in the console.`
              );

              console.log(`Agent ${agentId} violations:`, violations);
            }
          }
        } catch (error) {
          console.error("Error fetching agent violations:", error);
          alert(
            `Viewing details for agent: ${agentId}\n\nCheck console for API errors.`
          );
        }
      }

      // Function to view violation details
      async function viewViolationDetail(violationId, agentId) {
        console.log(
          `ðŸ” Viewing violation detail: ${violationId} for agent ${agentId}`
        );

        try {
          const response = await fetch(
            `/api/admin/ocr/violation/${violationId}`,
            {
              credentials: "include",
            }
          );

          if (response.ok) {
            const result = await response.json();
            if (result.success) {
              const violation = result.data;
              showViolationModal(violation);
            } else {
              showBasicViolationInfo(violationId, agentId);
            }
          } else {
            showBasicViolationInfo(violationId, agentId);
          }
        } catch (error) {
          console.error("Error fetching violation details:", error);
          showBasicViolationInfo(violationId, agentId);
        }
      }

      // Function to show violation in a modal
      function showViolationModal(violation) {
        const confidence = Math.round((violation.confidence || 0) * 100);
        const ruleType = getViolationTypeDisplay(
          violation.rule_type || violation.ruleType
        );
        const matchedText =
          violation.matched_text ||
          violation.matchedText ||
          "No text available";
        const timestamp = new Date(violation.timestamp).toLocaleString();
        const agentName =
          violation.agent_hostname ||
          violation.agentHostname ||
          "Unknown Agent";
        const username =
          violation.agent_username || violation.agentUsername || "N/A";

        const modalHtml = `
        <div class="modal" onclick="if(event.target === this) closeModal()">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Violation Details</h3>
                    <button class="modal-close" onclick="closeModal()">Ã—</button>
                </div>
                
                <div class="modal-body">
                    <div style="margin-bottom: 16px;">
                        <div style="font-weight: 600; color: #111827;">${escapeHtml(agentName)} (${escapeHtml(username)})</div>
                        <div style="font-size: 0.875em; color: #6b7280;">${timestamp}</div>
                    </div>
                    
                    <div style="background: #f9fafb; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="font-weight: 600;">Violation Type:</span>
                            <span>${escapeHtml(ruleType)}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="font-weight: 600;">Confidence:</span>
                            <span style="background: ${confidence >= 90 ? "#fee2e2" : confidence >= 70 ? "#fef3c7" : "#d1fae5"}; 
                                  color: ${confidence >= 90 ? "#dc2626" : confidence >= 70 ? "#d97706" : "#059669"}; 
                                  padding: 4px 8px; border-radius: 4px; font-weight: 600;">
                                ${confidence}%
                            </span>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 16px;">
                        <div style="font-weight: 600; margin-bottom: 8px;">Matched Text:</div>
                        <div style="background: #f3f4f6; padding: 12px; border-radius: 6px; font-family: monospace; white-space: pre-wrap; word-break: break-all;">
                            ${escapeHtml(matchedText)}
                        </div>
                    </div>
                    
                    ${
                      violation.screenshot_path || violation.screenshotPath
                        ? `
                    <div style="margin-bottom: 16px;">
                        <div style="font-weight: 600; margin-bottom: 8px;">Screenshot:</div>
                        <div style="text-align: center;">
                            <img src="/api/admin/ocr/screenshot/${violation.id}" 
                                 alt="Violation Screenshot" 
                                 style="max-width: 100%; border-radius: 6px; border: 1px solid #e5e7eb;"
                                 onerror="this.style.display='none'">
                        </div>
                    </div>
                    `
                        : ""
                    }
                </div>
                
                <div class="modal-footer">
                    <button class="modal-btn modal-btn-secondary" onclick="closeModal()">Close</button>
                    <button class="modal-btn modal-btn-primary" onclick="takeActionOnViolation(${violation.id})">Take Action</button>
                </div>
            </div>
        </div>
      `;

        const modalContainer = document.createElement("div");
        modalContainer.innerHTML = modalHtml;
        document.body.appendChild(modalContainer.firstChild);
      }

      // Function to show basic violation info
      function showBasicViolationInfo(violationId, agentId) {
        alert(
          `Violation ID: ${violationId}\nAgent ID: ${agentId}\n\nThis would show detailed information from the API.`
        );
      }

      // Function to close modal
      function closeModal() {
        const modal = document.querySelector(".modal");
        if (modal) {
          modal.remove();
        }
      }

      // Function to take action on violation
      function takeActionOnViolation(violationId) {
        alert(
          `Taking action on violation ${violationId}\n\nThis would trigger automated remediation actions.`
        );
        closeModal();
      }

      // Function to retry loading violations
      function retryLoadViolations() {
        loadRecentViolations();
      }

      /* ==================== EVENT LISTENERS ==================== */

      window.addEventListener("resize", function () {
        const sidebar = document.getElementById("sidebar");
        const mainContent = document.getElementById("mainContent");
        const header = document.getElementById("topHeader");
        const windowWidth = window.innerWidth;

        if (windowWidth <= 968) {
          if (sidebar) sidebar.classList.remove("collapsed");
          if (mainContent) mainContent.classList.remove("expanded");
          if (header) {
            header.style.left = "0";
          }
        } else {
          if (sidebar && mainContent && header) {
            if (sidebar.classList.contains("collapsed")) {
              mainContent.classList.add("expanded");
              header.style.left = "70px";
            } else {
              mainContent.classList.remove("expanded");
              header.style.left = "240px";
            }
          }
        }
      });

      window.addEventListener("sidebarToggle", function (event) {
        const header = document.getElementById("topHeader");
        const mainContent = document.getElementById("mainContent");

        if (header && mainContent) {
          if (event.detail.collapsed) {
            header.style.left = "70px";
            mainContent.classList.add("expanded");
          } else {
            header.style.left = "240px";
            mainContent.classList.remove("expanded");
          }
        }
      });

      document.addEventListener("click", function (e) {
        const sidebar = document.getElementById("sidebar");
        const mobileMenuToggle = document.querySelector(".mobile-menu-toggle");

        if (sidebar && window.innerWidth <= 968) {
          if (
            !sidebar.contains(e.target) &&
            (!mobileMenuToggle || !mobileMenuToggle.contains(e.target))
          ) {
            sidebar.classList.remove("mobile-open");
            const overlay = document.getElementById("sidebarOverlay");
            if (overlay) {
              overlay.classList.remove("active");
            }
          }
        }
      });

      // Initialize on DOM ready
      document.addEventListener("DOMContentLoaded", async function () {
        console.log("ðŸ“„ DOM loaded, initializing OCR dashboard...");
             // Just load admin info directly - no auth check needed
        loadAdminInfo();
        
        setActiveMenuItem();
        await loadOcrDashboardData();
        startAutoRefresh();
      });

      // Make functions globally available
      window.refreshData = refreshData;
      window.viewAgentDetails = viewAgentDetails;
      window.viewViolationDetail = viewViolationDetail;
      window.closeModal = closeModal;
      window.takeActionOnViolation = takeActionOnViolation;
      window.retryLoadViolations = retryLoadViolations;
    </script>
  </body>
</html>