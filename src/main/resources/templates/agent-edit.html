<!-- 
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Edit Agent - DLP Shield</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: #f8fafc;
        color: #1e293b;
        overflow-x: hidden;
      }

      .dashboard-container {
        display: flex;
        min-height: 100vh;
        max-width: 100vw;
        overflow-x: hidden;
      }

      .main-content {
        flex: 1;
        margin-left: 240px;
        transition: margin-left 0.3s ease;
        min-height: 100vh;
        max-width: calc(100vw - 240px);
        overflow-x: hidden;
      }

      .main-content.expanded {
        margin-left: 70px;
        max-width: calc(100vw - 70px);
      }

      .content-area {
        padding: 24px;
        padding-top: 100px;
        max-width: 1400px;
        margin: 0 auto;
        width: 100%;
      }

      /* ================ SIDEBAR STYLES ================ */
      .sidebar {
        width: 240px;
        background: linear-gradient(180deg, #1e40af 0%, #1e3a8a 100%);
        color: white;
        position: fixed;
        height: 100vh;
        display: flex;
        flex-direction: column;
        transition: width 0.3s ease;
        z-index: 1000;
        left: 0;
        top: 0;
        overflow: hidden;
      }

      .sidebar::-webkit-scrollbar {
        width: 4px;
      }

      .sidebar::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.3);
        border-radius: 4px;
      }

      .sidebar-header {
        padding: 18px 16px;
        display: flex;
        align-items: center;
        gap: 10px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        flex-shrink: 0;
      }

      .sidebar-logo {
        width: 38px;
        height: 38px;
        background: white;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
      }

      .sidebar-logo i {
        font-size: 20px;
        color: #2563eb;
      }

      .sidebar-title {
        font-size: 1.2em;
        font-weight: 700;
        white-space: nowrap;
        transition: opacity 0.2s, width 0.3s;
        overflow: hidden;
      }

      .nav-menu {
        padding: 12px 0;
        overflow-y: auto;
        overflow-x: hidden;
        flex: 1;
      }

      .nav-item {
        margin: 2px 8px;
      }

      .nav-link {
        display: flex;
        align-items: center;
        padding: 10px 12px;
        color: rgba(255, 255, 255, 0.8);
        text-decoration: none;
        border-radius: 8px;
        transition: all 0.2s;
        font-size: 0.9em;
        cursor: pointer;
        white-space: nowrap;
      }

      .nav-link:hover {
        background: rgba(255, 255, 255, 0.1);
        color: white;
      }

      .nav-link.active,
      .sub-menu-item.active {
        background: rgba(255, 255, 255, 0.15);
        color: white;
        font-weight: 600;
      }

      .nav-link i:first-child {
        width: 20px;
        font-size: 0.95em;
        margin-right: 10px;
        flex-shrink: 0;
      }

      .chevron-icon {
        margin-left: auto !important;
        font-size: 0.7em !important;
        transition: transform 0.3s;
        width: auto !important;
        flex-shrink: 0;
      }

      .nav-link.expanded .chevron-icon {
        transform: rotate(180deg);
      }

      .sub-menu {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease;
      }

      .sub-menu.open {
        max-height: 500px;
      }

      .sub-menu-item {
        display: flex;
        align-items: center;
        padding: 8px 12px 8px 42px;
        color: rgba(255, 255, 255, 0.7);
        text-decoration: none;
        font-size: 0.85em;
        transition: all 0.2s;
        border-radius: 8px;
        margin: 2px 0;
        white-space: nowrap;
      }

      .sub-menu-item:hover {
        color: white;
        background: rgba(255, 255, 255, 0.08);
      }

      .sub-menu-item::before {
        content: "•";
        margin-right: 10px;
        font-size: 1.2em;
      }

      .sidebar-footer {
        padding: 12px 16px;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        flex-shrink: 0;
      }

      .collapse-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 10px;
        background: rgba(255, 255, 255, 0.1);
        border: none;
        color: white;
        border-radius: 8px;
        cursor: pointer;
        width: 100%;
        font-size: 0.85em;
        transition: all 0.2s;
        white-space: nowrap;
        overflow: hidden;
      }

      .collapse-btn:hover {
        background: rgba(255, 255, 255, 0.15);
      }

      .collapse-btn i {
        transition: transform 0.3s;
        flex-shrink: 0;
      }

      /* Sidebar collapsed state */
      .sidebar.collapsed {
        width: 70px;
      }

      .sidebar.collapsed .sidebar-title {
        opacity: 0;
        width: 0;
      }

      .sidebar.collapsed .nav-link span,
      .sidebar.collapsed .collapse-btn span {
        display: none;
      }

      .sidebar.collapsed .sub-menu {
        display: none !important;
      }

      .sidebar.collapsed .nav-link {
        justify-content: center;
        padding: 10px;
      }

      .sidebar.collapsed .nav-link i:first-child {
        margin-right: 0;
      }

      .sidebar.collapsed .chevron-icon {
        display: none;
      }

      .sidebar.collapsed .collapse-btn {
        justify-content: center;
      }

      .sidebar.collapsed .collapse-btn i {
        transform: rotate(180deg);
      }

      /* Mobile Overlay */
      .sidebar-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 999;
        opacity: 0;
        transition: opacity 0.3s;
      }

      .sidebar-overlay.active {
        display: block;
        opacity: 1;
      }

      /* ================ HEADER STYLES ================ */
      .top-header {
        background: white;
        padding: 14px 24px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        border-bottom: 1px solid #e5e7eb;
        position: fixed;
        top: 0;
        left: 240px;
        right: 0;
        z-index: 500;
        gap: 16px;
        transition: left 0.3s ease;
      }

      .mobile-menu-toggle {
        display: none;
        background: none;
        border: none;
        color: #6b7280;
        font-size: 1.3em;
        cursor: pointer;
        padding: 8px;
        transition: color 0.2s;
      }

      .mobile-menu-toggle:hover {
        color: #111827;
      }

      .search-bar {
        flex: 1;
        max-width: 400px;
        position: relative;
      }

      .search-bar i {
        position: absolute;
        left: 14px;
        top: 50%;
        transform: translateY(-50%);
        color: #9ca3af;
        font-size: 0.9em;
      }

      .search-input {
        width: 100%;
        padding: 9px 14px 9px 38px;
        border: 1.5px solid #e5e7eb;
        border-radius: 8px;
        font-size: 0.9em;
        background: #f9fafb;
        transition: all 0.3s ease;
      }

      .search-input:focus {
        outline: none;
        border-color: #3b82f6;
        background: white;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }

      .header-actions {
        display: flex;
        align-items: center;
        gap: 16px;
      }

      .notification-btn {
        position: relative;
        background: none;
        border: none;
        color: #6b7280;
        font-size: 1.1em;
        cursor: pointer;
        padding: 8px;
        transition: all 0.2s;
        border-radius: 8px;
      }

      .notification-btn:hover {
        color: #111827;
        background: #f3f4f6;
      }

      .notification-btn.active {
        color: #2563eb;
        background: #eff6ff;
      }

      .notification-badge {
        position: absolute;
        top: 4px;
        right: 4px;
        background: #ef4444;
        color: white;
        font-size: 0.65em;
        min-width: 18px;
        height: 18px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        padding: 0 4px;
      }

      .user-profile {
        display: flex;
        align-items: center;
        gap: 10px;
        cursor: pointer;
        padding: 6px 10px;
        border-radius: 8px;
        transition: background 0.2s;
        position: relative;
      }

      .user-profile:hover {
        background: #f3f4f6;
      }

      .user-avatar {
        width: 36px;
        height: 36px;
        background: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        font-size: 0.9em;
        flex-shrink: 0;
      }

      .user-info {
        display: flex;
        flex-direction: column;
      }

      .user-name {
        font-size: 0.9em;
        font-weight: 600;
        color: #111827;
      }

      .user-role {
        font-size: 0.75em;
        color: #6b7280;
      }

      .dropdown-icon {
        color: #6b7280;
        font-size: 0.75em;
        margin-left: 4px;
        transition: transform 0.3s;
      }

      .user-profile.active .dropdown-icon {
        transform: rotate(180deg);
      }

      .user-dropdown {
        position: absolute;
        top: 100%;
        right: 0;
        margin-top: 8px;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07),
          0 10px 15px rgba(0, 0, 0, 0.1);
        min-width: 200px;
        opacity: 0;
        visibility: hidden;
        transform: translateY(-10px);
        transition: all 0.3s ease;
        z-index: 1000;
      }

      .user-dropdown.show {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
      }

      .dropdown-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 14px;
        color: #374151;
        text-decoration: none;
        font-size: 0.9em;
        transition: background 0.2s;
      }

      .dropdown-item:first-child {
        border-radius: 8px 8px 0 0;
      }

      .dropdown-item:last-child {
        border-radius: 0 0 8px 8px;
      }

      .dropdown-item:hover {
        background: #f3f4f6;
      }

      .dropdown-item i {
        width: 18px;
        color: #6b7280;
        font-size: 0.95em;
      }

      .dropdown-item.danger {
        color: #dc2626;
      }

      .dropdown-item.danger i {
        color: #dc2626;
      }

      .dropdown-divider {
        height: 1px;
        background: #e5e7eb;
        margin: 4px 0;
      }

      /* ================ NOTIFICATIONS PANEL ================ */
      .notifications-panel {
        position: fixed;
        top: 0;
        right: -50%;
        width: 50%;
        max-width: 600px;
        height: 100vh;
        background: white;
        box-shadow: -4px 0 15px rgba(0, 0, 0, 0.1);
        z-index: 1001;
        display: flex;
        flex-direction: column;
        transition: right 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .notifications-panel.show {
        right: 0;
      }

      .notifications-header {
        padding: 20px 24px;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
      }

      .notifications-header h3 {
        font-size: 1.2em;
        font-weight: 700;
        color: #111827;
      }

      .close-notifications {
        background: none;
        border: none;
        color: #6b7280;
        font-size: 1.2em;
        cursor: pointer;
        padding: 6px;
        border-radius: 6px;
        transition: all 0.2s;
      }

      .close-notifications:hover {
        background: #f3f4f6;
        color: #111827;
      }

      .notifications-tabs {
        display: flex;
        border-bottom: 1px solid #e5e7eb;
        padding: 0 24px;
        flex-shrink: 0;
      }

      .tab-btn {
        flex: 1;
        padding: 12px;
        background: none;
        border: none;
        color: #6b7280;
        font-size: 0.9em;
        font-weight: 500;
        cursor: pointer;
        border-bottom: 2px solid transparent;
        transition: all 0.2s;
      }

      .tab-btn:hover {
        color: #111827;
      }

      .tab-btn.active {
        color: #2563eb;
        border-bottom-color: #2563eb;
      }

      .notifications-content {
        flex: 1;
        overflow-y: auto;
        padding: 12px 0;
      }

      .notifications-content::-webkit-scrollbar {
        width: 6px;
      }

      .notifications-content::-webkit-scrollbar-thumb {
        background: #d1d5db;
        border-radius: 3px;
      }

      .notification-item {
        display: flex;
        gap: 12px;
        padding: 14px 24px;
        cursor: pointer;
        transition: background 0.2s;
        border-left: 3px solid transparent;
      }

      .notification-item:hover {
        background: #f9fafb;
      }

      .notification-item.unread {
        background: #eff6ff;
        border-left-color: #3b82f6;
      }

      .notification-item.unread:hover {
        background: #dbeafe;
      }

      .notification-icon {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.1em;
        flex-shrink: 0;
      }

      .notification-icon.critical {
        background: #fee2e2;
        color: #dc2626;
      }

      .notification-icon.warning {
        background: #fef3c7;
        color: #f59e0b;
      }

      .notification-icon.info {
        background: #dbeafe;
        color: #3b82f6;
      }

      .notification-icon.success {
        background: #d1fae5;
        color: #10b981;
      }

      .notification-body {
        flex: 1;
      }

      .notification-title {
        font-size: 0.9em;
        font-weight: 600;
        color: #111827;
        margin-bottom: 4px;
      }

      .notification-text {
        font-size: 0.85em;
        color: #6b7280;
        margin-bottom: 6px;
        line-height: 1.4;
      }

      .notification-time {
        font-size: 0.75em;
        color: #9ca3af;
      }

      .notification-dot {
        width: 8px;
        height: 8px;
        background: #3b82f6;
        border-radius: 50%;
        flex-shrink: 0;
        margin-top: 8px;
      }

      .notification-item:not(.unread) .notification-dot {
        display: none;
      }

      .notifications-footer {
        padding: 16px 24px;
        border-top: 1px solid #e5e7eb;
        flex-shrink: 0;
      }

      .view-all-btn {
        display: block;
        width: 100%;
        padding: 10px;
        background: #f3f4f6;
        color: #2563eb;
        text-align: center;
        text-decoration: none;
        border-radius: 8px;
        font-size: 0.9em;
        font-weight: 600;
        transition: all 0.2s;
      }

      .view-all-btn:hover {
        background: #e5e7eb;
      }

      .notification-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.4);
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
      }

      .notification-overlay.show {
        opacity: 1;
        visibility: visible;
      }

      /* Edit Agent Page Styles */
      .back-button {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 10px 16px;
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        color: #475569;
        text-decoration: none;
        font-size: 14px;
        margin-bottom: 20px;
        transition: all 0.2s;
      }

      .back-button:hover {
        background: #f8fafc;
        border-color: #cbd5e1;
      }

      .page-header {
        background: white;
        padding: 24px;
        border-radius: 12px;
        border: 1px solid #e5e7eb;
        margin-bottom: 24px;
      }

      .page-title-section {
        display: flex;
        align-items: center;
        gap: 16px;
        flex-wrap: wrap;
      }

      .page-icon {
        width: 48px;
        height: 48px;
        background: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
      }

      .page-icon i {
        font-size: 22px;
        color: white;
      }

      .page-title-text h1 {
        font-size: 1.5em;
        color: #111827;
        font-weight: 700;
        line-height: 1.2;
      }

      .page-subtitle {
        color: #6b7280;
        font-size: 0.9em;
        margin-top: 4px;
      }

      .agent-status {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 16px;
        background: #ffffff;
        color: #065f46;
        border-radius: 20px;
        font-size: 14px;
        font-weight: 500;
        margin-left: auto;
      }

      .agent-status.offline {
        background: #fee2e2;
        color: #991b1b;
      }

      .form-container {
        background: white;
        padding: 32px;
        border-radius: 12px;
        border: 1px solid #e5e7eb;
        width: 100%;
      }

      .form-section {
        margin-bottom: 32px;
      }

      .form-section:last-child {
        margin-bottom: 0;
      }

      .section-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 20px;
        padding-bottom: 12px;
        border-bottom: 2px solid #f1f5f9;
      }

      .section-header i {
        font-size: 20px;
        color: #3b82f6;
      }

      .section-header h2 {
        font-size: 18px;
        color: #1e293b;
      }

      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
      }

      .form-row.full {
        grid-template-columns: 1fr;
      }

      .form-group {
        display: flex;
        flex-direction: column;
      }

      .form-group label {
        font-size: 14px;
        font-weight: 500;
        color: #475569;
        margin-bottom: 8px;
      }

      .form-group label .required {
        color: #ef4444;
      }

      .form-group input,
      .form-group select,
      .form-group textarea {
        padding: 12px 14px;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        font-size: 14px;
        font-family: inherit;
        transition: all 0.2s;
      }

      .form-group input:focus,
      .form-group select:focus,
      .form-group textarea:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }

      .form-group input:disabled,
      .form-group select:disabled {
        background: #f8fafc;
        color: #94a3b8;
        cursor: not-allowed;
      }

      .form-group textarea {
        resize: vertical;
        min-height: 100px;
      }

      .form-help {
        font-size: 12px;
        color: #94a3b8;
        margin-top: 4px;
      }

      .info-card {
        background: #f0f9ff;
        border: 1px solid #bfdbfe;
        border-left: 4px solid #3b82f6;
        padding: 16px;
        border-radius: 8px;
        margin-bottom: 20px;
      }

      .info-card h3 {
        font-size: 14px;
        color: #1e40af;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .info-card p {
        font-size: 13px;
        color: #475569;
        margin-bottom: 8px;
      }

      .info-card p:last-child {
        margin-bottom: 0;
      }

      .info-item {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid #e0f2fe;
      }

      .info-item:last-child {
        border-bottom: none;
      }

      .info-label {
        font-weight: 500;
        color: #1e40af;
      }

      .info-value {
        color: #475569;
      }

      .form-actions {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        margin-top: 32px;
        padding-top: 24px;
        border-top: 2px solid #f1f5f9;
      }

      .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }

      .btn-primary {
        background: #3b82f6;
        color: white;
      }

      .btn-primary:hover {
        background: #2563eb;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
      }

      .btn-primary:disabled {
        opacity: 0.7;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .btn-secondary {
        background: #e2e8f0;
        color: #475569;
      }

      .btn-secondary:hover {
        background: #cbd5e1;
      }

      .btn-warning {
        background: #f59e0b;
        color: white;
      }

      .btn-warning:hover {
        background: #d97706;
      }

      .spinner {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: #fff;
        animation: spin 0.8s linear infinite;
        margin-right: 8px;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      /* Responsive */
      @media (max-width: 1200px) {
        .main-content {
          margin-left: 70px;
          max-width: calc(100vw - 70px);
        }

        .top-header {
          left: 70px;
        }
      }

      @media (max-width: 968px) {
        .main-content {
          margin-left: 0;
          max-width: 100vw;
        }

        .top-header {
          left: 0;
        }

        .mobile-menu-toggle {
          display: block;
        }

        .sidebar {
          transform: translateX(-100%);
          transition: transform 0.3s ease;
        }

        .sidebar.mobile-open {
          transform: translateX(0);
        }

        .content-area {
          padding: 16px;
          padding-top: 80px;
        }

        .form-row {
          grid-template-columns: 1fr;
        }

        .form-container {
          padding: 20px;
        }

        .form-actions {
          flex-wrap: wrap;
        }

        .page-title-section {
          flex-direction: column;
          align-items: flex-start;
        }

        .agent-status {
          margin-left: 0;
        }

        .user-info {
          display: none;
        }
      }

      @media (max-width: 768px) {
        .notifications-panel {
          width: 90%;
          right: -90%;
        }

        .form-actions {
          flex-direction: column;
        }

        .btn {
          width: 100%;
          justify-content: center;
        }
      }

      @media (max-width: 640px) {
        .content-area {
          padding: 12px;
          padding-top: 70px;
        }

        .form-container {
          padding: 16px;
        }

        .btn {
          padding: 10px 16px;
          font-size: 13px;
        }

        .page-title-text h1 {
          font-size: 1.3em;
        }

        .page-icon {
          width: 40px;
          height: 40px;
        }

        .page-icon i {
          font-size: 18px;
        }
      }
    </style>
  </head>
  <body>
    <div class="dashboard-container">
      // ==================== SIDEBAR ==================== 
      <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
          <div class="sidebar-logo">
            <i class="fas fa-shield-halved"></i>
          </div>
          <div class="sidebar-title">DLP Shield</div>
        </div>

        <nav class="nav-menu">
          <div class="nav-item">
            <a href="dashboard.html" class="nav-link" data-page="dashboard">
              <i class="fas fa-th-large"></i>
              <span>Dashboard</span>
            </a>
          </div>

          <div class="nav-item">
            <a href="alerts.html" class="nav-link" data-page="alerts">
              <i class="fas fa-triangle-exclamation"></i>
              <span>Alerts &amp; Incidents</span>
            </a>
          </div>

          <div class="nav-item">
            <div class="nav-link nav-dropdown" onclick="toggleSubMenu(this)">
              <i class="fas fa-shield-alt"></i>
              <span>Policies</span>
              <i class="fas fa-chevron-down chevron-icon"></i>
            </div>
            <div class="sub-menu">
              <a
                href="manage-agents.html"
                class="sub-menu-item"
                data-page="manage-agents"
                >Manage Agents</a
              >
              <a
                href="file-policies.html"
                class="sub-menu-item"
                data-page="file-policies"
                >File Policies</a
              >
              <a
                href="assign-policy.html"
                class="sub-menu-item"
                data-page="assign-policy"
                >Assign Policy</a
              >
            </div>
          </div>

          <div class="nav-item">
            <a href="agents.html" class="nav-link" data-page="agents">
              <i class="fas fa-desktop"></i>
              <span>Agents / Endpoints</span>
            </a>
          </div>

          <div class="nav-item">
            <div class="nav-link nav-dropdown" onclick="toggleSubMenu(this)">
              <i class="fas fa-eye"></i>
              <span>OCR &amp; Image Analysis</span>
              <i class="fas fa-chevron-down chevron-icon"></i>
            </div>
            <div class="sub-menu">
              <a
                href="ocr-dashboard.html"
                class="sub-menu-item"
                data-page="ocr-dashboard"
                >OCR Dashboard</a
              >
              <a
                href="ocr-policies.html"
                class="sub-menu-item"
                data-page="ocr-policies"
                >OCR Policies</a
              >
            </div>
          </div>

          <div class="nav-item">
            <div class="nav-link nav-dropdown" onclick="toggleSubMenu(this)">
              <i class="fas fa-file-lines"></i>
              <span>Reports &amp; Logs</span>
              <i class="fas fa-chevron-down chevron-icon"></i>
            </div>
            <div class="sub-menu">
              <a href="reports.html" class="sub-menu-item" data-page="reports"
                >Reports</a
              >
              <a
                href="generate-report.html"
                class="sub-menu-item"
                data-page="generate-report"
                >Generate Report</a
              >
              <a
                href="audit-logs.html"
                class="sub-menu-item"
                data-page="audit-logs"
                >Audit Logs</a
              >
              <a
                href="device-logs.html"
                class="sub-menu-item"
                data-page="device-logs"
                >Device Logs</a
              >
            </div>
          </div>

          <div class="nav-item">
            <div class="nav-link nav-dropdown" onclick="toggleSubMenu(this)">
              <i class="fas fa-users"></i>
              <span>Users &amp; Roles</span>
              <i class="fas fa-chevron-down chevron-icon"></i>
            </div>
            <div class="sub-menu">
              <a href="users.html" class="sub-menu-item" data-page="users"
                >Users</a
              >
              <a href="roles.html" class="sub-menu-item" data-page="roles"
                >Roles &amp; Permissions</a
              >
              <a
                href="permissions.html"
                class="sub-menu-item"
                data-page="permissions"
                >Permissions</a
              >
            </div>
          </div>

          <div class="nav-item">
            <div class="nav-link nav-dropdown" onclick="toggleSubMenu(this)">
              <i class="fas fa-gear"></i>
              <span>Settings</span>
              <i class="fas fa-chevron-down chevron-icon"></i>
            </div>
            <div class="sub-menu">
              <a href="general.html" class="sub-menu-item" data-page="general"
                >General</a
              >
              <a href="security.html" class="sub-menu-item" data-page="security"
                >Security</a
              >
              <a
                href="integrations.html"
                class="sub-menu-item"
                data-page="integrations"
                >Integrations</a
              >
              <a
                href="data-retention.html"
                class="sub-menu-item"
                data-page="data-retention"
                >Data Retention</a
              >
            </div>
          </div>
        </nav>

        <div class="sidebar-footer">
          <button class="collapse-btn" onclick="toggleSidebar()">
            <i class="fas fa-chevron-left"></i>
            <span>Collapse</span>
          </button>
        </div>
      </aside>

    // Mobile Overlay (for sidebar) 
      <div
        class="sidebar-overlay"
        id="sidebarOverlay"
        onclick="closeMobileSidebar()"
      ></div>

     // ==================== HEADER ==================== 
      <header class="top-header" id="topHeader">
        <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">
          <i class="fas fa-bars"></i>
        </button>

        <div class="search-bar">
          <i class="fas fa-search"></i>
          <input
            type="text"
            class="search-input"
            placeholder="Search alerts, agents, policies..."
          />
        </div>

        <div class="header-actions">
          <button class="notification-btn" onclick="toggleNotifications(event)">
            <i class="fas fa-bell"></i>
            <span class="notification-badge" id="alertBadge">5</span>
          </button>

          <div class="user-profile" onclick="toggleUserDropdown(event)">
            <div class="user-avatar">A</div>
            <div class="user-info">
              <div class="user-name">Admin</div>
              <div class="user-role">Security Admin</div>
            </div>
            <i class="fas fa-chevron-down dropdown-icon"></i>

            <div class="user-dropdown" id="userDropdown">
              <a href="general.html" class="dropdown-item">
                <i class="fas fa-gear"></i>
                <span>Settings</span>
              </a>
              <a href="#" class="dropdown-item">
                <i class="fas fa-circle-question"></i>
                <span>Help &amp; Support</span>
              </a>
              <div class="dropdown-divider"></div>
              <a
                href="index.html"
                class="dropdown-item danger"
                onclick="logout(event)"
              >
                <i class="fas fa-right-from-bracket"></i>
                <span>Sign out</span>
              </a>
            </div>
          </div>
        </div>
      </header>

     //  ==================== NOTIFICATIONS PANEL ==================== 
      <div class="notifications-panel" id="notificationsPanel">
        <div class="notifications-header">
          <h3>Notifications</h3>
          <button class="close-notifications" onclick="closeNotifications()">
            <i class="fas fa-times"></i>
          </button>
        </div>

        <div class="notifications-tabs">
          <button class="tab-btn active" onclick="switchTab(event, 'all')">
            All (5)
          </button>
          <button class="tab-btn" onclick="switchTab(event, 'unread')">
            Unread (3)
          </button>
        </div>

        <div class="notifications-content" id="notificationsContent">
          <div class="notification-item unread">
            <div class="notification-icon critical">
              <i class="fas fa-shield-exclamation"></i>
            </div>
            <div class="notification-body">
              <div class="notification-title">Critical Policy Violation</div>
              <div class="notification-text">
                User attempted to copy sensitive files to USB drive
              </div>
              <div class="notification-time">2 minutes ago</div>
            </div>
            <div class="notification-dot"></div>
          </div>

          <div class="notification-item unread">
            <div class="notification-icon warning">
              <i class="fas fa-triangle-exclamation"></i>
            </div>
            <div class="notification-body">
              <div class="notification-title">Agent Offline</div>
              <div class="notification-text">
                DESKTOP-DEF456 has been offline for 2 hours
              </div>
              <div class="notification-time">15 minutes ago</div>
            </div>
            <div class="notification-dot"></div>
          </div>

          <div class="notification-item unread">
            <div class="notification-icon info">
              <i class="fas fa-info-circle"></i>
            </div>
            <div class="notification-body">
              <div class="notification-title">Policy Updated</div>
              <div class="notification-text">
                File Protection Policy has been modified by Admin
              </div>
              <div class="notification-time">1 hour ago</div>
            </div>
            <div class="notification-dot"></div>
          </div>

          <div class="notification-item">
            <div class="notification-icon success">
              <i class="fas fa-check-circle"></i>
            </div>
            <div class="notification-body">
              <div class="notification-title">Agent Connected</div>
              <div class="notification-text">
                New agent LAPTOP-XYZ789 successfully registered
              </div>
              <div class="notification-time">3 hours ago</div>
            </div>
          </div>

          <div class="notification-item">
            <div class="notification-icon info">
              <i class="fas fa-file-alt"></i>
            </div>
            <div class="notification-body">
              <div class="notification-title">Report Generated</div>
              <div class="notification-text">
                Weekly security report is ready for review
              </div>
              <div class="notification-time">5 hours ago</div>
            </div>
          </div>
        </div>

        <div class="notifications-footer">
          <a href="alerts.html" class="view-all-btn">View All Notifications</a>
        </div>
      </div>

  //Notification Overlay 
      <div
        class="notification-overlay"
        id="notificationOverlay"
        onclick="closeNotifications()"
      ></div>

      <main class="main-content" id="mainContent">
        <div class="content-area">
        //  Back Button
          <a href="manage-agents.html" class="back-button">
            <i class="fas fa-arrow-left"></i>
            Back to Agents
          </a>

         //  Page Header
          <div class="page-header">
            <div class="page-title-section">
              <div class="page-icon"><i class="fas fa-edit"></i></div>
              <div class="page-title-text">
                <h1>Edit Agent</h1>
                <p class="page-subtitle">
                  Update agent configuration and settings
                </p>
              </div>
              <div class="agent-status" id="agentStatus">
                <i class="fas fa-circle"></i>
                <span>Loading...</span>
              </div>
            </div>
          </div>

          // Form Container 
          <div class="form-container">
            // Agent Info Card 
            <div class="info-card">
              <h3><i class="fas fa-info-circle"></i> Agent Information</h3>
              <div class="info-item">
                <span class="info-label">Agent ID:</span>
                <span class="info-value" id="agentIdValue">Loading...</span>
              </div>
              <div class="info-item">
                <span class="info-label">Registered:</span>
                <span class="info-value" id="registeredDateValue">Loading...</span>
              </div>
              <div class="info-item">
                <span class="info-label">Last Update:</span>
                <span class="info-value" id="lastUpdateValue">Loading...</span>
              </div>
              <div class="info-item">
                <span class="info-label">Last Seen:</span>
                <span class="info-value" id="lastSeenValue">Loading...</span>
              </div>
            </div>

            <form id="editAgentForm" onsubmit="handleSubmit(event)">
             // Basic Information 
              <div class="form-section">
                <div class="section-header">
                  <i class="fas fa-info-circle"></i>
                  <h2>Basic Information</h2>
                </div>

                <div class="form-row">
                  <div class="form-group">
                    <label>Agent Name <span class="required">*</span></label>
                    <input
                      type="text"
                      id="agentName"
                      value=""
                      required
                      disabled
                    />
                    <span class="form-help"
                      >Unique identifier for this agent</span
                    >
                  </div>

                  <div class="form-group">
                    <label>Hostname <span class="required">*</span></label>
                    <input
                      type="text"
                      id="hostname"
                      value=""
                      required
                      disabled
                    />
                    <span class="form-help">Computer hostname</span>
                  </div>
                </div>

                <div class="form-row">
                  <div class="form-group">
                    <label>IP Address <span class="required">*</span></label>
                    <input
                      type="text"
                      id="ipAddress"
                      value=""
                      required
                      pattern="^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$"
                      disabled
                    />
                    <span class="form-help">Static or DHCP IP address</span>
                  </div>

                  <div class="form-group">
                    <label>MAC Address</label>
                    <input type="text" id="macAddress" value="" disabled />
                    <span class="form-help"
                      >Physical network address (read-only)</span
                    >
                  </div>
                </div>
              </div>

             // User Information 
              <div class="form-section">
                <div class="section-header">
                  <i class="fas fa-user"></i>
                  <h2>User Information</h2>
                </div>

                <div class="form-row">
                  <div class="form-group">
                    <label>Username <span class="required">*</span></label>
                    <input type="text" id="username" value="" required />
                    <span class="form-help">Windows/System username</span>
                  </div>

                  <div class="form-group">
                    <label>Email Address <span class="required">*</span></label>
                    <input type="email" id="email" value="" required />
                  </div>
                </div>

                <div class="form-row">
                  <div class="form-group">
                    <label>Password</label>
                    <div style="display: flex; gap: 10px; align-items: center">
                      <input
                        type="password"
                        id="password"
                        placeholder="••••••••"
                        disabled
                        style="flex: 1"
                      />
                      <button
                        type="button"
                        id="changePasswordBtn"
                        class="btn btn-secondary"
                        style="padding: 12px 20px; white-space: nowrap"
                        onclick="togglePasswordChange()"
                      >
                        <i class="fas fa-key"></i> Change Password
                      </button>
                    </div>
                    <span class="form-help" id="passwordHelp"
                      >Click "Change Password" to set a new password</span
                    >
                  </div>

                  <div class="form-group">
                    <label>Confirm Password</label>
                    <input
                      type="password"
                      id="confirmPassword"
                      placeholder="Confirm new password"
                      disabled
                    />
                    <span class="form-help" id="confirmPasswordHelp"
                      >Confirm your new password</span
                    >
                  </div>
                </div>
              </div>

              // Form Actions 
              <div class="form-actions">
                <button
                  type="button"
                  class="btn btn-secondary"
                  onclick="window.location.href = 'manage-agents.html'"
                >
                  <i class="fas fa-times"></i>
                  Cancel
                </button>
                <button type="submit" class="btn btn-primary">
                  <i class="fas fa-save"></i>
                  Save Changes
                </button>
              </div>
            </form>
          </div>
        </div>
      </main>
    </div>

    <script>
      /* ==================== AUTHENTICATION & USER DATA ==================== */

      async function checkAuth() {
        try {
          const response = await fetch("/api/auth/check", {
            credentials: "include",
          });

          if (!response.ok) {
            throw new Error("Not authenticated");
          }

          const result = await response.json();

          if (!result.success) {
            window.location.href = "index.html";
            return null;
          }

          if (result.data) {
            localStorage.setItem("userData", JSON.stringify(result.data));
            return result.data;
          }

          return null;
        } catch (err) {
          window.location.href = "index.html";
          return null;
        }
      }

      // Load admin info into header
      function loadAdminInfo() {
        const userDataStr = localStorage.getItem("userData");

        if (userDataStr) {
          try {
            const userData = JSON.parse(userDataStr);

            const userName = document.querySelector(".user-name");
            const userAvatar = document.querySelector(".user-avatar");
            const userRole = document.querySelector(".user-role");

            if (userName) {
              const namePart = userData.username || "Admin";
              const formattedName = namePart
                .split(".")
                .map((n) => n.charAt(0).toUpperCase() + n.slice(1))
                .join(" ");
              userName.textContent = formattedName;
            }

            if (userAvatar) {
              const namePart = userData.username || "Admin";
              const initials = namePart
                .split(".")
                .map((n) => (n[0] ? n[0].toUpperCase() : ""))
                .join("");
              userAvatar.textContent = initials || "A";
            }

            if (userRole) {
              userRole.textContent = userData.role || "Security Admin";
            }
          } catch (e) {
            console.error("Error parsing user data:", e);
          }
        }
      }

      async function refreshUserData() {
        const userData = await checkAuth();
        if (userData) {
          localStorage.setItem("userData", JSON.stringify(userData));
          loadAdminInfo();
        }
      }

      // Refresh every 5 minutes
      setInterval(refreshUserData, 5 * 60 * 1000);

      /* ==================== SIDEBAR FUNCTIONS ==================== */

      function toggleSubMenu(element) {
        var sidebar = document.getElementById("sidebar");
        if (sidebar.classList.contains("collapsed")) return;

        var subMenu = element.nextElementSibling;
        var allSubMenus = document.querySelectorAll(".sub-menu");
        var allDropdowns = document.querySelectorAll(".nav-dropdown");

        // Close other open submenus
        allSubMenus.forEach(function (menu) {
          if (menu !== subMenu) menu.classList.remove("open");
        });
        allDropdowns.forEach(function (link) {
          if (link !== element) link.classList.remove("expanded");
        });

        // Toggle current
        element.classList.toggle("expanded");
        subMenu.classList.toggle("open");
      }

      function toggleSidebar() {
        var sidebar = document.getElementById("sidebar");
        var mainContent = document.getElementById("mainContent");
        var header = document.getElementById("topHeader");

        sidebar.classList.toggle("collapsed");
        var isCollapsed = sidebar.classList.contains("collapsed");

        if (mainContent) mainContent.classList.toggle("expanded");

        // Update header left position
        if (header) {
          header.style.left = isCollapsed ? "70px" : "240px";
        }

        // Close all submenus when collapsing
        if (isCollapsed) {
          document.querySelectorAll(".sub-menu").forEach(function (m) {
            m.classList.remove("open");
          });
          document.querySelectorAll(".nav-dropdown").forEach(function (l) {
            l.classList.remove("expanded");
          });
        }

        // Dispatch event for other components
        window.dispatchEvent(
          new CustomEvent("sidebarToggle", {
            detail: { collapsed: isCollapsed },
          })
        );
      }

      function openMobileSidebar() {
        var sidebar = document.getElementById("sidebar");
        var overlay = document.getElementById("sidebarOverlay");
        if (sidebar) sidebar.classList.add("mobile-open");
        if (overlay) overlay.classList.add("active");
      }

      function closeMobileSidebar() {
        var sidebar = document.getElementById("sidebar");
        var overlay = document.getElementById("sidebarOverlay");
        if (sidebar) sidebar.classList.remove("mobile-open");
        if (overlay) overlay.classList.remove("active");
      }

      function toggleMobileMenu() {
        var sidebar = document.getElementById("sidebar");
        var overlay = document.getElementById("sidebarOverlay");
        if (!sidebar) return;

        if (sidebar.classList.contains("mobile-open")) {
          closeMobileSidebar();
        } else {
          openMobileSidebar();
        }
      }

      function setActiveMenuItem() {
        var currentPage = window.location.pathname.split('/').pop() || 'edit-agent.html';

        // First remove all active classes
        document.querySelectorAll('.nav-link, .sub-menu-item').forEach(function(el) {
          el.classList.remove('active');
        });

        // Handle sub-menu items
        document.querySelectorAll('.sub-menu-item[data-page]').forEach(function (item) {
          var href = item.getAttribute('href');
          if (href === currentPage) {
            item.classList.add('active');
            var parentSubMenu = item.closest('.sub-menu');
            if (parentSubMenu) {
              parentSubMenu.classList.add('open');
              var parentNav = parentSubMenu.previousElementSibling;
              if (parentNav) parentNav.classList.add('expanded');
            }
          }
        });

        // Handle main nav links
        document.querySelectorAll('.nav-link[data-page]').forEach(function (link) {
          var href = link.getAttribute('href');
          if (href === currentPage) {
            link.classList.add('active');
          }
        });
      }

      /* ==================== HEADER FUNCTIONS ==================== */

      function toggleNotifications(event) {
        event.stopPropagation();
        var panel = document.getElementById("notificationsPanel");
        var overlay = document.getElementById("notificationOverlay");
        var btn = event.currentTarget;
        if (!panel || !overlay) return;

        if (panel.classList.contains("show")) {
          closeNotifications();
        } else {
          closeUserDropdown();
          panel.classList.add("show");
          overlay.classList.add("show");
          btn.classList.add("active");
          document.body.style.overflow = "hidden";
        }
      }

      function closeNotifications() {
        var panel = document.getElementById("notificationsPanel");
        var overlay = document.getElementById("notificationOverlay");
        var btn = document.querySelector(".notification-btn");
        if (panel) panel.classList.remove("show");
        if (overlay) overlay.classList.remove("show");
        if (btn) btn.classList.remove("active");
        document.body.style.overflow = "";
      }

      function switchTab(event, tabName) {
        document.querySelectorAll(".tab-btn").forEach(function (t) {
          t.classList.remove("active");
        });
        event.currentTarget.classList.add("active");

        document
          .querySelectorAll(".notification-item")
          .forEach(function (item) {
            item.style.display =
              tabName === "unread" && !item.classList.contains("unread")
                ? "none"
                : "flex";
          });
      }

      function toggleUserDropdown(event) {
        event.stopPropagation();
        var dropdown = document.getElementById("userDropdown");
        var userProfile = event.currentTarget;
        if (!dropdown) return;

        if (dropdown.classList.contains("show")) {
          closeUserDropdown();
        } else {
          closeNotifications();
          dropdown.classList.add("show");
          userProfile.classList.add("active");
        }
      }

      function closeUserDropdown() {
        var dropdown = document.getElementById("userDropdown");
        var userProfile = document.querySelector(".user-profile");
        if (dropdown) dropdown.classList.remove("show");
        if (userProfile) userProfile.classList.remove("active");
      }

      function logout(event) {
        event.preventDefault();

        fetch("/api/auth/logout", {
          method: "POST",
          credentials: "include",
        }).finally(() => {
          localStorage.removeItem("isLoggedIn");
          localStorage.removeItem("userEmail");
          localStorage.removeItem("userData");
          window.location.href = "index.html";
        });
      }

      // Close dropdowns when clicking outside
      document.addEventListener("click", function (event) {
        if (!event.target.closest(".user-profile")) {
          closeUserDropdown();
        }
        if (
          !event.target.closest(".notification-btn") &&
          !event.target.closest(".notifications-panel")
        ) {
          closeNotifications();
        }
      });

      /* ==================== EDIT AGENT FUNCTIONS ==================== */

      const originalFormData = {};

      // Get agent ID from URL
      function getAgentIdFromUrl() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get("id");
      }

      async function loadAgentData(agentId) {
        try {
          // Show loading state
          showLoadingState();

          const response = await fetch(`/api/admin/agents`, {
            credentials: "include",
          });

          if (!response.ok) throw new Error("Failed to fetch agents");

          const result = await response.json();

          if (result.success) {
            const agent = result.data.find((a) => a.id.toString() === agentId);
            if (agent) {
              // Populate form fields
              document.getElementById("agentName").value =
                agent.hostname || "N/A";
              document.getElementById("hostname").value =
                agent.hostname || "N/A";
              document.getElementById("ipAddress").value =
                agent.ipAddress || "N/A";
              document.getElementById("macAddress").value =
                agent.macAddress || "Not available";
              document.getElementById("username").value = agent.username || "";
              document.getElementById("email").value = agent.email || "";

              // Clear password fields
              document.getElementById("password").value = "";
              document.getElementById("confirmPassword").value = "";

              setFieldStates(agent);

              // Update status badge
              updateStatusBadge(agent);

              // Update info card with ALL available data
              updateInfoCard(agent);

              // Store original form data for reset
              captureOriginalFormData();
            } else {
              alert("Agent not found");
              window.location.href = "manage-agents.html";
            }
          }
        } catch (error) {
          console.error("Error loading agent:", error);
          showErrorState();
        }
      }

      // Update status badge
      function updateStatusBadge(agent) {
        const statusDiv = document.getElementById("agentStatus");
        if (statusDiv) {
          const isOnline =
            agent.lastHeartbeat &&
            Date.now() - new Date(agent.lastHeartbeat).getTime() < 45000;
          const statusText = isOnline ? "Online" : "Offline";
          const statusClass = isOnline ? "" : "offline";

          statusDiv.className = `agent-status ${statusClass}`;
          statusDiv.innerHTML = `<i class="fas fa-circle"></i><span>${statusText}</span>`;
        }
      }

      // Update info card with agent data
      function updateInfoCard(agent) {
        // Agent ID
        const agentIdEl = document.getElementById("agentIdValue");
        if (agentIdEl) agentIdEl.textContent = agent.id || "N/A";

        // Registered date - use createdAt if available
        const registeredEl = document.getElementById("registeredDateValue");
        if (registeredEl) {
          registeredEl.textContent = agent.createdAt
            ? new Date(agent.createdAt).toLocaleDateString("en-US", {
                year: "numeric",
                month: "short",
                day: "numeric",
              })
            : "N/A";
        }

        // Last Update - use updatedAt if available
        const lastUpdateEl = document.getElementById("lastUpdateValue");
        if (lastUpdateEl) {
          lastUpdateEl.textContent = agent.updatedAt
            ? new Date(agent.updatedAt).toLocaleDateString("en-US", {
                year: "numeric",
                month: "short",
                day: "numeric",
              })
            : "N/A";
        }

        // Last Seen
        const lastSeenEl = document.getElementById("lastSeenValue");
        if (lastSeenEl) {
          lastSeenEl.textContent = agent.lastHeartbeat
            ? formatTimeAgo(agent.lastHeartbeat)
            : "Never";
        }
      }

      // Show loading state
      function showLoadingState() {
        // Set loading text in info card
        document.getElementById("agentIdValue").textContent = "Loading...";
        document.getElementById("registeredDateValue").textContent =
          "Loading...";
        document.getElementById("lastUpdateValue").textContent = "Loading...";
        document.getElementById("lastSeenValue").textContent = "Loading...";

        // Set loading text in form fields
        document.getElementById("agentName").value = "Loading...";
        document.getElementById("hostname").value = "Loading...";
        document.getElementById("ipAddress").value = "Loading...";
        document.getElementById("macAddress").value = "Loading...";
        document.getElementById("username").value = "Loading...";
        document.getElementById("email").value = "Loading...";
      }

      // Show error state
      function showErrorState() {
        document.getElementById("agentIdValue").textContent = "Error loading";
        document.getElementById("registeredDateValue").textContent = "Error";
        document.getElementById("lastUpdateValue").textContent = "Error";
        document.getElementById("lastSeenValue").textContent = "Error";

        // You can add a retry button or message
        const infoCard = document.querySelector(".info-card");
        if (infoCard) {
          const errorMsg = document.createElement("p");
          errorMsg.style.color = "red";
          errorMsg.style.marginTop = "10px";
          errorMsg.innerHTML =
            '<i class="fas fa-exclamation-triangle"></i> Failed to load agent data. <a href="#" onclick="location.reload()">Retry</a>';
          infoCard.appendChild(errorMsg);
        }
      }

      function captureOriginalFormData() {
        const form = document.getElementById("editAgentForm");
        if (form) {
          const inputs = form.querySelectorAll("input, select, textarea");
          inputs.forEach((input) => {
            if (input.type === "checkbox") {
              originalFormData[input.id] = input.checked;
            } else {
              originalFormData[input.id] = input.value;
            }
          });
          console.log("Original form data captured:", originalFormData);
        }
      }

      // Format time ago helper
      function formatTimeAgo(timestamp) {
        if (!timestamp) return "Never";
        const seconds = Math.floor((Date.now() - new Date(timestamp)) / 1000);
        if (seconds < 60) return `${seconds}s ago`;
        if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
        if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
        return `${Math.floor(seconds / 86400)}d ago`;
      }

      function isAgentOnline(agent) {
        if (!agent.lastHeartbeat) return false;
        const secondsSince = Math.floor(
          (Date.now() - new Date(agent.lastHeartbeat).getTime()) / 1000
        );
        return secondsSince <= 15;
      }

      function setFieldStates(agent) {
        const online = isAgentOnline(agent);

        // Disable fields that can only be updated when agent is online
        document.getElementById("agentName").disabled = true;
        document.getElementById("hostname").disabled = true;
        document.getElementById("ipAddress").disabled = true;
        document.getElementById("macAddress").disabled = true;

        // Username and email are always editable by admin
        document.getElementById("username").disabled = false;
        document.getElementById("email").disabled = false;

        // Password fields start disabled
        document.getElementById("password").disabled = true;
        document.getElementById("confirmPassword").disabled = true;
        document.getElementById("password").required = false;
        document.getElementById("confirmPassword").required = false;

        // Reset change password button
        const changeBtn = document.getElementById("changePasswordBtn");
        if (changeBtn) {
          changeBtn.innerHTML = '<i class="fas fa-key"></i> Change Password';
          changeBtn.classList.remove("btn-warning");
          changeBtn.classList.add("btn-secondary");
        }
      }

      function togglePasswordChange() {
        const passwordField = document.getElementById("password");
        const confirmField = document.getElementById("confirmPassword");
        const changeBtn = document.getElementById("changePasswordBtn");

        if (passwordField.disabled) {
          // Enable password fields
          passwordField.disabled = false;
          confirmField.disabled = false;
          passwordField.value = "";
          confirmField.value = "";
          passwordField.placeholder = "Enter new password";
          passwordField.required = true;
          confirmField.required = true;
          changeBtn.innerHTML = '<i class="fas fa-times"></i> Cancel';
          changeBtn.classList.remove("btn-secondary");
          changeBtn.classList.add("btn-warning");
          document.getElementById("passwordHelp").innerHTML =
            "Enter a new password for this agent";
        } else {
          // Disable password fields
          passwordField.disabled = true;
          confirmField.disabled = true;
          passwordField.value = "";
          confirmField.value = "";
          passwordField.placeholder = "••••••••";
          passwordField.required = false;
          confirmField.required = false;
          changeBtn.innerHTML = '<i class="fas fa-key"></i> Change Password';
          changeBtn.classList.remove("btn-warning");
          changeBtn.classList.add("btn-secondary");
          document.getElementById("passwordHelp").innerHTML =
            'Click "Change Password" to set a new password';
        }
      }

      async function handleSubmit(event) {
        event.preventDefault();

        const agentId = getAgentIdFromUrl();
        const username = document.getElementById("username").value;
        const email = document.getElementById("email").value;
        const password = document.getElementById("password").value;
        const passwordDisabled = document.getElementById("password").disabled;
        const confirmPassword = document.getElementById("confirmPassword").value;

        // Validate
        if (!username || !email) {
          alert("Username and Email are required!");
          return;
        }

        // Email validation
        const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailPattern.test(email)) {
          alert("Please enter a valid email address!");
          return;
        }

        // Password validation (only if password is provided AND fields are enabled)
        if (!passwordDisabled && (password || confirmPassword)) {
          if (password !== confirmPassword) {
            alert("Passwords do not match!");
            return;
          }
          if (password.length < 6) {
            alert("Password must be at least 6 characters long!");
            return;
          }
        }

        // Prepare request data
        const requestData = {
          username: username,
          email: email,
        };

        // Only include password if it was changed AND fields are enabled
        if (!passwordDisabled && password) {
          requestData.password = password;
        }

        // Disable submit button
        const submitBtn = event.target.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner"></span> Saving...';

        try {
          const response = await fetch(`/api/admin/agents/${agentId}`, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
            },
            credentials: "include",
            body: JSON.stringify(requestData),
          });

          const result = await response.json();

          if (response.ok && result.success) {
            alert("Agent updated successfully!");
            window.location.href = `agent-view.html?id=${agentId}`;
          } else {
            alert(result.message || "Failed to update agent");
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
          }
        } catch (error) {
          console.error("Error updating agent:", error);
          alert("Network error: Could not connect to server");
          submitBtn.disabled = false;
          submitBtn.innerHTML = originalText;
        }
      }

      // Function to execute scripts after loading components
      function executeScripts(element) {
        const scripts = element.querySelectorAll("script");
        scripts.forEach((oldScript) => {
          const newScript = document.createElement("script");
          Array.from(oldScript.attributes).forEach((attr) => {
            newScript.setAttribute(attr.name, attr.value);
          });
          if (oldScript.textContent) {
            newScript.textContent = oldScript.textContent;
          }
          oldScript.parentNode.replaceChild(newScript, oldScript);
        });
      }

      // Load component function
      async function loadComponent(url, containerId) {
        try {
          const response = await fetch(url);
          const html = await response.text();
          const container = document.getElementById(containerId);
          const tempDiv = document.createElement("div");
          tempDiv.innerHTML = html;
          container.innerHTML = "";
          while (tempDiv.firstChild) {
            container.appendChild(tempDiv.firstChild);
          }
          executeScripts(container);
        } catch (error) {
          console.error("Error loading component:", error);
        }
      }

      /* ==================== EVENT LISTENERS ==================== */

      window.addEventListener("resize", function () {
        const sidebar = document.getElementById("sidebar");
        const mainContent = document.getElementById("mainContent");
        const header = document.getElementById("topHeader");
        const windowWidth = window.innerWidth;

        if (windowWidth <= 968) {
          if (sidebar) sidebar.classList.remove("collapsed");
          if (mainContent) mainContent.classList.remove("expanded");
          if (header) {
            header.style.left = "0";
          }
        } else {
          if (sidebar && mainContent && header) {
            if (sidebar.classList.contains("collapsed")) {
              mainContent.classList.add("expanded");
              header.style.left = "70px";
            } else {
              mainContent.classList.remove("expanded");
              header.style.left = "240px";
            }
          }
        }
      });

      window.addEventListener("sidebarToggle", function (event) {
        const header = document.getElementById("topHeader");
        const mainContent = document.getElementById("mainContent");

        if (header && mainContent) {
          if (event.detail.collapsed) {
            header.style.left = "70px";
            mainContent.classList.add("expanded");
          } else {
            header.style.left = "240px";
            mainContent.classList.remove("expanded");
          }
        }
      });

      document.addEventListener("click", function (e) {
        const sidebar = document.getElementById("sidebar");
        const mobileMenuToggle = document.querySelector(".mobile-menu-toggle");

        if (sidebar && window.innerWidth <= 968) {
          if (
            !sidebar.contains(e.target) &&
            (!mobileMenuToggle || !mobileMenuToggle.contains(e.target))
          ) {
            sidebar.classList.remove("mobile-open");
            const overlay = document.getElementById("sidebarOverlay");
            if (overlay) {
              overlay.classList.remove("active");
            }
          }
        }
      });

      // Warn on unsaved changes
      let formChanged = false;
      const form = document.getElementById("editAgentForm");

      if (form) {
        form.addEventListener("change", function () {
          formChanged = true;
        });
      }

      window.addEventListener("beforeunload", function (e) {
        if (formChanged) {
          e.preventDefault();
          e.returnValue = "";
        }
      });

      // Initialize on DOM ready
      document.addEventListener("DOMContentLoaded", async function () {
        try {
          const userData = await checkAuth();
          if (userData) {
            loadAdminInfo();
          }

          // Get agent ID from URL
          const agentId = getAgentIdFromUrl();
          if (!agentId) {
            alert("No agent ID provided");
            window.location.href = "manage-agents.html";
            return;
          }

          // Set active menu item
          setActiveMenuItem();

          // Load components
          await loadComponent("sidebar.html", "sidebarContainer");
          await loadComponent("page-header.html", "headerContainer");

          // LOAD AGENT DATA AFTER COMPONENTS ARE LOADED
          await loadAgentData(agentId);

          // Initialize sidebar state
          const sidebar = document.getElementById("sidebar");
          const mainContent = document.getElementById("mainContent");
          const header = document.getElementById("topHeader");
          const windowWidth = window.innerWidth;

          if (sidebar && mainContent && header) {
            if (windowWidth <= 968) {
              mainContent.classList.remove("expanded");
              header.style.left = "0";
            } else {
              if (sidebar.classList.contains("collapsed")) {
                mainContent.classList.add("expanded");
                header.style.left = "70px";
              } else {
                mainContent.classList.remove("expanded");
                header.style.left = "240px";
              }
            }
          }
        } catch (error) {
          console.error("Error initializing page:", error);
        }
      });

      // Make functions globally available
      window.toggleSidebar = toggleSidebar;
      window.toggleMobileMenu = toggleMobileMenu;
      window.closeMobileSidebar = closeMobileSidebar;
      window.toggleNotifications = toggleNotifications;
      window.closeNotifications = closeNotifications;
      window.switchTab = switchTab;
      window.toggleUserDropdown = toggleUserDropdown;
      window.logout = logout;
      window.togglePasswordChange = togglePasswordChange;
      window.handleSubmit = handleSubmit;
    </script>
  </body>
</html>-->


<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Edit Agent - DLP Shield</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: #f8fafc;
        color: #1e293b;
        overflow-x: hidden;
      }

      .dashboard-container {
        display: flex;
        min-height: 100vh;
        max-width: 100vw;
        overflow-x: hidden;
      }

      .main-content {
        flex: 1;
        margin-left: 240px;
        transition: margin-left 0.3s ease;
        min-height: 100vh;
        max-width: calc(100vw - 240px);
        overflow-x: hidden;
      }

      .main-content.expanded {
        margin-left: 70px;
        max-width: calc(100vw - 70px);
      }

      .content-area {
        padding: 24px;
        padding-top: 100px;
        max-width: 1400px;
        margin: 0 auto;
        width: 100%;
      }

      /* ================ SIDEBAR STYLES ================ */
      .sidebar {
        width: 240px;
        background: linear-gradient(180deg, #1e40af 0%, #1e3a8a 100%);
        color: white;
        position: fixed;
        height: 100vh;
        display: flex;
        flex-direction: column;
        transition: width 0.3s ease;
        z-index: 1000;
        left: 0;
        top: 0;
        overflow: hidden;
      }

      .sidebar::-webkit-scrollbar {
        width: 4px;
      }

      .sidebar::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.3);
        border-radius: 4px;
      }

      .sidebar-header {
        padding: 18px 16px;
        display: flex;
        align-items: center;
        gap: 10px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        flex-shrink: 0;
      }

      .sidebar-logo {
        width: 38px;
        height: 38px;
        background: white;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
      }

      .sidebar-logo i {
        font-size: 20px;
        color: #2563eb;
      }

      .sidebar-title {
        font-size: 1.2em;
        font-weight: 700;
        white-space: nowrap;
        transition: opacity 0.2s, width 0.3s;
        overflow: hidden;
      }

      .nav-menu {
        padding: 12px 0;
        overflow-y: auto;
        overflow-x: hidden;
        flex: 1;
      }

      .nav-item {
        margin: 2px 8px;
      }

      .nav-link {
        display: flex;
        align-items: center;
        padding: 10px 12px;
        color: rgba(255, 255, 255, 0.8);
        text-decoration: none;
        border-radius: 8px;
        transition: all 0.2s;
        font-size: 0.9em;
        cursor: pointer;
        white-space: nowrap;
      }

      .nav-link:hover {
        background: rgba(255, 255, 255, 0.1);
        color: white;
      }

      .nav-link.active,
      .sub-menu-item.active {
        background: rgba(255, 255, 255, 0.15);
        color: white;
        font-weight: 600;
      }

      .nav-link i:first-child {
        width: 20px;
        font-size: 0.95em;
        margin-right: 10px;
        flex-shrink: 0;
      }

      .chevron-icon {
        margin-left: auto !important;
        font-size: 0.7em !important;
        transition: transform 0.3s;
        width: auto !important;
        flex-shrink: 0;
      }

      .nav-link.expanded .chevron-icon {
        transform: rotate(180deg);
      }

      .sub-menu {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease;
      }

      .sub-menu.open {
        max-height: 500px;
      }

      .sub-menu-item {
        display: flex;
        align-items: center;
        padding: 8px 12px 8px 42px;
        color: rgba(255, 255, 255, 0.7);
        text-decoration: none;
        font-size: 0.85em;
        transition: all 0.2s;
        border-radius: 8px;
        margin: 2px 0;
        white-space: nowrap;
      }

      .sub-menu-item:hover {
        color: white;
        background: rgba(255, 255, 255, 0.08);
      }

      .sub-menu-item::before {
        content: "•";
        margin-right: 10px;
        font-size: 1.2em;
      }

      .sidebar-footer {
        padding: 12px 16px;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        flex-shrink: 0;
      }

      .collapse-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 10px;
        background: rgba(255, 255, 255, 0.1);
        border: none;
        color: white;
        border-radius: 8px;
        cursor: pointer;
        width: 100%;
        font-size: 0.85em;
        transition: all 0.2s;
        white-space: nowrap;
        overflow: hidden;
      }

      .collapse-btn:hover {
        background: rgba(255, 255, 255, 0.15);
      }

      .collapse-btn i {
        transition: transform 0.3s;
        flex-shrink: 0;
      }

      /* Sidebar collapsed state */
      .sidebar.collapsed {
        width: 70px;
      }

      .sidebar.collapsed .sidebar-title {
        opacity: 0;
        width: 0;
      }

      .sidebar.collapsed .nav-link span,
      .sidebar.collapsed .collapse-btn span {
        display: none;
      }

      .sidebar.collapsed .sub-menu {
        display: none !important;
      }

      .sidebar.collapsed .nav-link {
        justify-content: center;
        padding: 10px;
      }

      .sidebar.collapsed .nav-link i:first-child {
        margin-right: 0;
      }

      .sidebar.collapsed .chevron-icon {
        display: none;
      }

      .sidebar.collapsed .collapse-btn {
        justify-content: center;
      }

      .sidebar.collapsed .collapse-btn i {
        transform: rotate(180deg);
      }

      /* Mobile Overlay */
      .sidebar-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 999;
        opacity: 0;
        transition: opacity 0.3s;
      }

      .sidebar-overlay.active {
        display: block;
        opacity: 1;
      }

      /* ================ HEADER STYLES ================ */
      .top-header {
        background: white;
        padding: 14px 24px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        border-bottom: 1px solid #e5e7eb;
        position: fixed;
        top: 0;
        left: 240px;
        right: 0;
        z-index: 500;
        gap: 16px;
        transition: left 0.3s ease;
      }

      .mobile-menu-toggle {
        display: none;
        background: none;
        border: none;
        color: #6b7280;
        font-size: 1.3em;
        cursor: pointer;
        padding: 8px;
        transition: color 0.2s;
      }

      .mobile-menu-toggle:hover {
        color: #111827;
      }

      .search-bar {
        flex: 1;
        max-width: 400px;
        position: relative;
      }

      .search-bar i {
        position: absolute;
        left: 14px;
        top: 50%;
        transform: translateY(-50%);
        color: #9ca3af;
        font-size: 0.9em;
      }

      .search-input {
        width: 100%;
        padding: 9px 14px 9px 38px;
        border: 1.5px solid #e5e7eb;
        border-radius: 8px;
        font-size: 0.9em;
        background: #f9fafb;
        transition: all 0.3s ease;
      }

      .search-input:focus {
        outline: none;
        border-color: #3b82f6;
        background: white;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }

      .header-actions {
        display: flex;
        align-items: center;
        gap: 16px;
      }

      .notification-btn {
        position: relative;
        background: none;
        border: none;
        color: #6b7280;
        font-size: 1.1em;
        cursor: pointer;
        padding: 8px;
        transition: all 0.2s;
        border-radius: 8px;
      }

      .notification-btn:hover {
        color: #111827;
        background: #f3f4f6;
      }

      .notification-btn.active {
        color: #2563eb;
        background: #eff6ff;
      }

      .notification-badge {
        position: absolute;
        top: 4px;
        right: 4px;
        background: #ef4444;
        color: white;
        font-size: 0.65em;
        min-width: 18px;
        height: 18px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        padding: 0 4px;
      }

      .user-profile {
        display: flex;
        align-items: center;
        gap: 10px;
        cursor: pointer;
        padding: 6px 10px;
        border-radius: 8px;
        transition: background 0.2s;
        position: relative;
      }

      .user-profile:hover {
        background: #f3f4f6;
      }

      .user-avatar {
        width: 36px;
        height: 36px;
        background: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        font-size: 0.9em;
        flex-shrink: 0;
      }

      .user-info {
        display: flex;
        flex-direction: column;
      }

      .user-name {
        font-size: 0.9em;
        font-weight: 600;
        color: #111827;
      }

      .user-role {
        font-size: 0.75em;
        color: #6b7280;
      }

      .dropdown-icon {
        color: #6b7280;
        font-size: 0.75em;
        margin-left: 4px;
        transition: transform 0.3s;
      }

      .user-profile.active .dropdown-icon {
        transform: rotate(180deg);
      }

      .user-dropdown {
        position: absolute;
        top: 100%;
        right: 0;
        margin-top: 8px;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07),
          0 10px 15px rgba(0, 0, 0, 0.1);
        min-width: 200px;
        opacity: 0;
        visibility: hidden;
        transform: translateY(-10px);
        transition: all 0.3s ease;
        z-index: 1000;
      }

      .user-dropdown.show {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
      }

      .dropdown-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 14px;
        color: #374151;
        text-decoration: none;
        font-size: 0.9em;
        transition: background 0.2s;
      }

      .dropdown-item:first-child {
        border-radius: 8px 8px 0 0;
      }

      .dropdown-item:last-child {
        border-radius: 0 0 8px 8px;
      }

      .dropdown-item:hover {
        background: #f3f4f6;
      }

      .dropdown-item i {
        width: 18px;
        color: #6b7280;
        font-size: 0.95em;
      }

      .dropdown-item.danger {
        color: #dc2626;
      }

      .dropdown-item.danger i {
        color: #dc2626;
      }

      .dropdown-divider {
        height: 1px;
        background: #e5e7eb;
        margin: 4px 0;
      }

      /* ================ NOTIFICATIONS PANEL ================ */
      .notifications-panel {
        position: fixed;
        top: 0;
        right: -50%;
        width: 50%;
        max-width: 600px;
        height: 100vh;
        background: white;
        box-shadow: -4px 0 15px rgba(0, 0, 0, 0.1);
        z-index: 1001;
        display: flex;
        flex-direction: column;
        transition: right 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .notifications-panel.show {
        right: 0;
      }

      .notifications-header {
        padding: 20px 24px;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
      }

      .notifications-header h3 {
        font-size: 1.2em;
        font-weight: 700;
        color: #111827;
      }

      .close-notifications {
        background: none;
        border: none;
        color: #6b7280;
        font-size: 1.2em;
        cursor: pointer;
        padding: 6px;
        border-radius: 6px;
        transition: all 0.2s;
      }

      .close-notifications:hover {
        background: #f3f4f6;
        color: #111827;
      }

      .notifications-tabs {
        display: flex;
        border-bottom: 1px solid #e5e7eb;
        padding: 0 24px;
        flex-shrink: 0;
      }

      .tab-btn {
        flex: 1;
        padding: 12px;
        background: none;
        border: none;
        color: #6b7280;
        font-size: 0.9em;
        font-weight: 500;
        cursor: pointer;
        border-bottom: 2px solid transparent;
        transition: all 0.2s;
      }

      .tab-btn:hover {
        color: #111827;
      }

      .tab-btn.active {
        color: #2563eb;
        border-bottom-color: #2563eb;
      }

      .notifications-content {
        flex: 1;
        overflow-y: auto;
        padding: 12px 0;
      }

      .notifications-content::-webkit-scrollbar {
        width: 6px;
      }

      .notifications-content::-webkit-scrollbar-thumb {
        background: #d1d5db;
        border-radius: 3px;
      }

      .notification-item {
        display: flex;
        gap: 12px;
        padding: 14px 24px;
        cursor: pointer;
        transition: background 0.2s;
        border-left: 3px solid transparent;
      }

      .notification-item:hover {
        background: #f9fafb;
      }

      .notification-item.unread {
        background: #eff6ff;
        border-left-color: #3b82f6;
      }

      .notification-item.unread:hover {
        background: #dbeafe;
      }

      .notification-icon {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.1em;
        flex-shrink: 0;
      }

      .notification-icon.critical {
        background: #fee2e2;
        color: #dc2626;
      }

      .notification-icon.warning {
        background: #fef3c7;
        color: #f59e0b;
      }

      .notification-icon.info {
        background: #dbeafe;
        color: #3b82f6;
      }

      .notification-icon.success {
        background: #d1fae5;
        color: #10b981;
      }

      .notification-body {
        flex: 1;
      }

      .notification-title {
        font-size: 0.9em;
        font-weight: 600;
        color: #111827;
        margin-bottom: 4px;
      }

      .notification-text {
        font-size: 0.85em;
        color: #6b7280;
        margin-bottom: 6px;
        line-height: 1.4;
      }

      .notification-time {
        font-size: 0.75em;
        color: #9ca3af;
      }

      .notification-dot {
        width: 8px;
        height: 8px;
        background: #3b82f6;
        border-radius: 50%;
        flex-shrink: 0;
        margin-top: 8px;
      }

      .notification-item:not(.unread) .notification-dot {
        display: none;
      }

      .notifications-footer {
        padding: 16px 24px;
        border-top: 1px solid #e5e7eb;
        flex-shrink: 0;
      }

      .view-all-btn {
        display: block;
        width: 100%;
        padding: 10px;
        background: #f3f4f6;
        color: #2563eb;
        text-align: center;
        text-decoration: none;
        border-radius: 8px;
        font-size: 0.9em;
        font-weight: 600;
        transition: all 0.2s;
      }

      .view-all-btn:hover {
        background: #e5e7eb;
      }

      .notification-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.4);
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
      }

      .notification-overlay.show {
        opacity: 1;
        visibility: visible;
      }

      /* Edit Agent Page Styles */
      .back-button {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 10px 16px;
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        color: #475569;
        text-decoration: none;
        font-size: 14px;
        margin-bottom: 20px;
        transition: all 0.2s;
      }

      .back-button:hover {
        background: #f8fafc;
        border-color: #cbd5e1;
      }

      .page-header {
        background: white;
        padding: 24px;
        border-radius: 12px;
        border: 1px solid #e5e7eb;
        margin-bottom: 24px;
      }

      .page-title-section {
        display: flex;
        align-items: center;
        gap: 16px;
        flex-wrap: wrap;
      }

      .page-icon {
        width: 48px;
        height: 48px;
        background: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
      }

      .page-icon i {
        font-size: 22px;
        color: white;
      }

      .page-title-text h1 {
        font-size: 1.5em;
        color: #111827;
        font-weight: 700;
        line-height: 1.2;
      }

      .page-subtitle {
        color: #6b7280;
        font-size: 0.9em;
        margin-top: 4px;
      }

      .agent-status {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 16px;
        background: #ffffff;
        color: #065f46;
        border-radius: 20px;
        font-size: 14px;
        font-weight: 500;
        margin-left: auto;
      }

      .agent-status.offline {
        background: #fee2e2;
        color: #991b1b;
      }

      .form-container {
        background: white;
        padding: 32px;
        border-radius: 12px;
        border: 1px solid #e5e7eb;
        width: 100%;
      }

      .form-section {
        margin-bottom: 32px;
      }

      .form-section:last-child {
        margin-bottom: 0;
      }

      .section-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 20px;
        padding-bottom: 12px;
        border-bottom: 2px solid #f1f5f9;
      }

      .section-header i {
        font-size: 20px;
        color: #3b82f6;
      }

      .section-header h2 {
        font-size: 18px;
        color: #1e293b;
      }

      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
      }

      .form-row.full {
        grid-template-columns: 1fr;
      }

      .form-group {
        display: flex;
        flex-direction: column;
      }

      .form-group label {
        font-size: 14px;
        font-weight: 500;
        color: #475569;
        margin-bottom: 8px;
      }

      .form-group label .required {
        color: #ef4444;
      }

      .form-group input,
      .form-group select,
      .form-group textarea {
        padding: 12px 14px;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        font-size: 14px;
        font-family: inherit;
        transition: all 0.2s;
      }

      .form-group input:focus,
      .form-group select:focus,
      .form-group textarea:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }

      .form-group input:disabled,
      .form-group select:disabled {
        background: #f8fafc;
        color: #94a3b8;
        cursor: not-allowed;
      }

      .form-group textarea {
        resize: vertical;
        min-height: 100px;
      }

      .form-help {
        font-size: 12px;
        color: #94a3b8;
        margin-top: 4px;
      }

      .info-card {
        background: #f0f9ff;
        border: 1px solid #bfdbfe;
        border-left: 4px solid #3b82f6;
        padding: 16px;
        border-radius: 8px;
        margin-bottom: 20px;
      }

      .info-card h3 {
        font-size: 14px;
        color: #1e40af;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .info-card p {
        font-size: 13px;
        color: #475569;
        margin-bottom: 8px;
      }

      .info-card p:last-child {
        margin-bottom: 0;
      }

      .info-item {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid #e0f2fe;
      }

      .info-item:last-child {
        border-bottom: none;
      }

      .info-label {
        font-weight: 500;
        color: #1e40af;
      }

      .info-value {
        color: #475569;
      }

      .form-actions {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        margin-top: 32px;
        padding-top: 24px;
        border-top: 2px solid #f1f5f9;
      }

      .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }

      .btn-primary {
        background: #3b82f6;
        color: white;
      }

      .btn-primary:hover {
        background: #2563eb;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
      }

      .btn-primary:disabled {
        opacity: 0.7;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .btn-secondary {
        background: #e2e8f0;
        color: #475569;
      }

      .btn-secondary:hover {
        background: #cbd5e1;
      }

      .btn-warning {
        background: #f59e0b;
        color: white;
      }

      .btn-warning:hover {
        background: #d97706;
      }

      .spinner {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: #fff;
        animation: spin 0.8s linear infinite;
        margin-right: 8px;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      /* Responsive */
      @media (max-width: 1200px) {
        .main-content {
          margin-left: 70px;
          max-width: calc(100vw - 70px);
        }

        .top-header {
          left: 70px;
        }
      }

      @media (max-width: 968px) {
        .main-content {
          margin-left: 0;
          max-width: 100vw;
        }

        .top-header {
          left: 0;
        }

        .mobile-menu-toggle {
          display: block;
        }

        .sidebar {
          transform: translateX(-100%);
          transition: transform 0.3s ease;
        }

        .sidebar.mobile-open {
          transform: translateX(0);
        }

        .content-area {
          padding: 16px;
          padding-top: 80px;
        }

        .form-row {
          grid-template-columns: 1fr;
        }

        .form-container {
          padding: 20px;
        }

        .form-actions {
          flex-wrap: wrap;
        }

        .page-title-section {
          flex-direction: column;
          align-items: flex-start;
        }

        .agent-status {
          margin-left: 0;
        }

        .user-info {
          display: none;
        }
      }

      @media (max-width: 768px) {
        .notifications-panel {
          width: 90%;
          right: -90%;
        }

        .form-actions {
          flex-direction: column;
        }

        .btn {
          width: 100%;
          justify-content: center;
        }
      }

      @media (max-width: 640px) {
        .content-area {
          padding: 12px;
          padding-top: 70px;
        }

        .form-container {
          padding: 16px;
        }

        .btn {
          padding: 10px 16px;
          font-size: 13px;
        }

        .page-title-text h1 {
          font-size: 1.3em;
        }

        .page-icon {
          width: 40px;
          height: 40px;
        }

        .page-icon i {
          font-size: 18px;
        }
      }
    </style>
  </head>
  <body>
    <div class="dashboard-container">
      <!-- ==================== SIDEBAR ==================== -->
      <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
          <div class="sidebar-logo">
            <i class="fas fa-shield-halved"></i>
          </div>
          <div class="sidebar-title">DLP Shield</div>
        </div>

        <nav class="nav-menu">
          <div class="nav-item">
            <a href="dashboard.html" class="nav-link" data-page="dashboard">
              <i class="fas fa-th-large"></i>
              <span>Dashboard</span>
            </a>
          </div>

          <div class="nav-item">
            <a href="alerts.html" class="nav-link" data-page="alerts">
              <i class="fas fa-triangle-exclamation"></i>
              <span>Alerts &amp; Incidents</span>
            </a>
          </div>

          <div class="nav-item">
            <div class="nav-link nav-dropdown" onclick="toggleSubMenu(this)">
              <i class="fas fa-shield-alt"></i>
              <span>Policies</span>
              <i class="fas fa-chevron-down chevron-icon"></i>
            </div>
            <div class="sub-menu">
              <a
                href="manage-agents.html"
                class="sub-menu-item"
                data-page="manage-agents"
                >Manage Agents</a
              >
              <a
                href="file-policies.html"
                class="sub-menu-item"
                data-page="file-policies"
                >File Policies</a
              >
              <a
                href="assign-policy.html"
                class="sub-menu-item"
                data-page="assign-policy"
                >Assign Policy</a
              >
            </div>
          </div>

          <div class="nav-item">
            <a href="agents.html" class="nav-link" data-page="agents">
              <i class="fas fa-desktop"></i>
              <span>Agents / Endpoints</span>
            </a>
          </div>

          <div class="nav-item">
            <div class="nav-link nav-dropdown" onclick="toggleSubMenu(this)">
              <i class="fas fa-eye"></i>
              <span>OCR &amp; Image Analysis</span>
              <i class="fas fa-chevron-down chevron-icon"></i>
            </div>
            <div class="sub-menu">
              <a
                href="ocr-dashboard.html"
                class="sub-menu-item"
                data-page="ocr-dashboard"
                >OCR Dashboard</a
              >
              <a
                href="ocr-policies.html"
                class="sub-menu-item"
                data-page="ocr-policies"
                >OCR Policies</a
              >
            </div>
          </div>

          <div class="nav-item">
            <div class="nav-link nav-dropdown" onclick="toggleSubMenu(this)">
              <i class="fas fa-file-lines"></i>
              <span>Reports &amp; Logs</span>
              <i class="fas fa-chevron-down chevron-icon"></i>
            </div>
            <div class="sub-menu">
              <a href="reports.html" class="sub-menu-item" data-page="reports"
                >Reports</a
              >
              <a
                href="generate-report.html"
                class="sub-menu-item"
                data-page="generate-report"
                >Generate Report</a
              >
              <a
                href="audit-logs.html"
                class="sub-menu-item"
                data-page="audit-logs"
                >Audit Logs</a
              >
              <a
                href="device-logs.html"
                class="sub-menu-item"
                data-page="device-logs"
                >Device Logs</a
              >
            </div>
          </div>

          <div class="nav-item">
            <div class="nav-link nav-dropdown" onclick="toggleSubMenu(this)">
              <i class="fas fa-users"></i>
              <span>Users &amp; Roles</span>
              <i class="fas fa-chevron-down chevron-icon"></i>
            </div>
            <div class="sub-menu">
              <a href="users.html" class="sub-menu-item" data-page="users"
                >Users</a
              >
              <a href="roles.html" class="sub-menu-item" data-page="roles"
                >Roles &amp; Permissions</a
              >
              <a
                href="permissions.html"
                class="sub-menu-item"
                data-page="permissions"
                >Permissions</a
              >
            </div>
          </div>

          <div class="nav-item">
            <div class="nav-link nav-dropdown" onclick="toggleSubMenu(this)">
              <i class="fas fa-gear"></i>
              <span>Settings</span>
              <i class="fas fa-chevron-down chevron-icon"></i>
            </div>
            <div class="sub-menu">
              <a href="general.html" class="sub-menu-item" data-page="general"
                >General</a
              >
              <a href="security.html" class="sub-menu-item" data-page="security"
                >Security</a
              >
              <a
                href="integrations.html"
                class="sub-menu-item"
                data-page="integrations"
                >Integrations</a
              >
              <a
                href="data-retention.html"
                class="sub-menu-item"
                data-page="data-retention"
                >Data Retention</a
              >
            </div>
          </div>
        </nav>

        <div class="sidebar-footer">
          <button class="collapse-btn" onclick="toggleSidebar()">
            <i class="fas fa-chevron-left"></i>
            <span>Collapse</span>
          </button>
        </div>
      </aside>

      <!-- Mobile Overlay (for sidebar) -->
      <div
        class="sidebar-overlay"
        id="sidebarOverlay"
        onclick="closeMobileSidebar()"
      ></div>

      <!-- ==================== HEADER ==================== -->
      <header class="top-header" id="topHeader">
        <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">
          <i class="fas fa-bars"></i>
        </button>

        <div class="search-bar">
          <i class="fas fa-search"></i>
          <input
            type="text"
            class="search-input"
            placeholder="Search alerts, agents, policies..."
          />
        </div>

        <div class="header-actions">
          <button class="notification-btn" onclick="toggleNotifications(event)">
            <i class="fas fa-bell"></i>
            <span class="notification-badge" id="alertBadge">5</span>
          </button>

          <div class="user-profile" onclick="toggleUserDropdown(event)">
            <div class="user-avatar">A</div>
            <div class="user-info">
              <div class="user-name">Admin</div>
              <div class="user-role">Security Admin</div>
            </div>
            <i class="fas fa-chevron-down dropdown-icon"></i>

            <div class="user-dropdown" id="userDropdown">
              <a href="general.html" class="dropdown-item">
                <i class="fas fa-gear"></i>
                <span>Settings</span>
              </a>
              <a href="#" class="dropdown-item">
                <i class="fas fa-circle-question"></i>
                <span>Help &amp; Support</span>
              </a>
              <div class="dropdown-divider"></div>
              <a
                href="index.html"
                class="dropdown-item danger"
                onclick="logout(event)"
              >
                <i class="fas fa-right-from-bracket"></i>
                <span>Sign out</span>
              </a>
            </div>
          </div>
        </div>
      </header>

      <!-- ==================== NOTIFICATIONS PANEL ==================== -->
      <div class="notifications-panel" id="notificationsPanel">
        <div class="notifications-header">
          <h3>Notifications</h3>
          <button class="close-notifications" onclick="closeNotifications()">
            <i class="fas fa-times"></i>
          </button>
        </div>

        <div class="notifications-tabs">
          <button class="tab-btn active" onclick="switchTab(event, 'all')">
            All (5)
          </button>
          <button class="tab-btn" onclick="switchTab(event, 'unread')">
            Unread (3)
          </button>
        </div>

        <div class="notifications-content" id="notificationsContent">
          <div class="notification-item unread">
            <div class="notification-icon critical">
              <i class="fas fa-shield-exclamation"></i>
            </div>
            <div class="notification-body">
              <div class="notification-title">Critical Policy Violation</div>
              <div class="notification-text">
                User attempted to copy sensitive files to USB drive
              </div>
              <div class="notification-time">2 minutes ago</div>
            </div>
            <div class="notification-dot"></div>
          </div>

          <div class="notification-item unread">
            <div class="notification-icon warning">
              <i class="fas fa-triangle-exclamation"></i>
            </div>
            <div class="notification-body">
              <div class="notification-title">Agent Offline</div>
              <div class="notification-text">
                DESKTOP-DEF456 has been offline for 2 hours
              </div>
              <div class="notification-time">15 minutes ago</div>
            </div>
            <div class="notification-dot"></div>
          </div>

          <div class="notification-item unread">
            <div class="notification-icon info">
              <i class="fas fa-info-circle"></i>
            </div>
            <div class="notification-body">
              <div class="notification-title">Policy Updated</div>
              <div class="notification-text">
                File Protection Policy has been modified by Admin
              </div>
              <div class="notification-time">1 hour ago</div>
            </div>
            <div class="notification-dot"></div>
          </div>

          <div class="notification-item">
            <div class="notification-icon success">
              <i class="fas fa-check-circle"></i>
            </div>
            <div class="notification-body">
              <div class="notification-title">Agent Connected</div>
              <div class="notification-text">
                New agent LAPTOP-XYZ789 successfully registered
              </div>
              <div class="notification-time">3 hours ago</div>
            </div>
          </div>

          <div class="notification-item">
            <div class="notification-icon info">
              <i class="fas fa-file-alt"></i>
            </div>
            <div class="notification-body">
              <div class="notification-title">Report Generated</div>
              <div class="notification-text">
                Weekly security report is ready for review
              </div>
              <div class="notification-time">5 hours ago</div>
            </div>
          </div>
        </div>

        <div class="notifications-footer">
          <a href="alerts.html" class="view-all-btn">View All Notifications</a>
        </div>
      </div>

      <!-- Notification Overlay -->
      <div
        class="notification-overlay"
        id="notificationOverlay"
        onclick="closeNotifications()"
      ></div>

      <main class="main-content" id="mainContent">
        <div class="content-area">
          <!-- Back Button -->
          <a href="manage-agents.html" class="back-button">
            <i class="fas fa-arrow-left"></i>
            Back to Agents
          </a>

          <!-- Page Header -->
          <div class="page-header">
            <div class="page-title-section">
              <div class="page-icon"><i class="fas fa-edit"></i></div>
              <div class="page-title-text">
                <h1>Edit Agent</h1>
                <p class="page-subtitle">
                  Update agent configuration and settings
                </p>
              </div>
              <div class="agent-status" id="agentStatus">
                <i class="fas fa-circle"></i>
                <span>Loading...</span>
              </div>
            </div>
          </div>

          <!-- Form Container -->
          <div class="form-container">
            <!-- Agent Info Card -->
            <div class="info-card">
              <h3><i class="fas fa-info-circle"></i> Agent Information</h3>
              <div class="info-item">
                <span class="info-label">Agent ID:</span>
                <span class="info-value" id="agentIdValue">Loading...</span>
              </div>
              <div class="info-item">
                <span class="info-label">Registered:</span>
                <span class="info-value" id="registeredDateValue">Loading...</span>
              </div>
              <div class="info-item">
                <span class="info-label">Last Update:</span>
                <span class="info-value" id="lastUpdateValue">Loading...</span>
              </div>
              <div class="info-item">
                <span class="info-label">Last Seen:</span>
                <span class="info-value" id="lastSeenValue">Loading...</span>
              </div>
            </div>

            <form id="editAgentForm" onsubmit="handleSubmit(event)">
              <!-- Basic Information -->
              <div class="form-section">
                <div class="section-header">
                  <i class="fas fa-info-circle"></i>
                  <h2>Basic Information</h2>
                </div>

                <div class="form-row">
                  <div class="form-group">
                    <label>Agent Name <span class="required">*</span></label>
                    <input
                      type="text"
                      id="agentName"
                      value=""
                      required
                      disabled
                    />
                    <span class="form-help"
                      >Unique identifier for this agent</span
                    >
                  </div>

                  <div class="form-group">
                    <label>Hostname <span class="required">*</span></label>
                    <input
                      type="text"
                      id="hostname"
                      value=""
                      required
                      disabled
                    />
                    <span class="form-help">Computer hostname</span>
                  </div>
                </div>

                <div class="form-row">
                  <div class="form-group">
                    <label>IP Address <span class="required">*</span></label>
                    <input
                      type="text"
                      id="ipAddress"
                      value=""
                      required
                      pattern="^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$"
                      disabled
                    />
                    <span class="form-help">Static or DHCP IP address</span>
                  </div>

                  <div class="form-group">
                    <label>MAC Address</label>
                    <input type="text" id="macAddress" value="" disabled />
                    <span class="form-help"
                      >Physical network address (read-only)</span
                    >
                  </div>
                </div>
              </div>

              <!-- User Information -->
              <div class="form-section">
                <div class="section-header">
                  <i class="fas fa-user"></i>
                  <h2>User Information</h2>
                </div>

                <div class="form-row">
                  <div class="form-group">
                    <label>Username <span class="required">*</span></label>
                    <input type="text" id="username" value="" required />
                    <span class="form-help">Windows/System username</span>
                  </div>

                  <div class="form-group">
                    <label>Email Address <span class="required">*</span></label>
                    <input type="email" id="email" value="" required />
                  </div>
                </div>

                <div class="form-row">
                  <div class="form-group">
                    <label>Password</label>
                    <div style="display: flex; gap: 10px; align-items: center">
                      <input
                        type="password"
                        id="password"
                        placeholder="••••••••"
                        disabled
                        style="flex: 1"
                      />
                      <button
                        type="button"
                        id="changePasswordBtn"
                        class="btn btn-secondary"
                        style="padding: 12px 20px; white-space: nowrap"
                        onclick="togglePasswordChange()"
                      >
                        <i class="fas fa-key"></i> Change Password
                      </button>
                    </div>
                    <span class="form-help" id="passwordHelp"
                      >Click "Change Password" to set a new password</span
                    >
                  </div>

                  <div class="form-group">
                    <label>Confirm Password</label>
                    <input
                      type="password"
                      id="confirmPassword"
                      placeholder="Confirm new password"
                      disabled
                    />
                    <span class="form-help" id="confirmPasswordHelp"
                      >Confirm your new password</span
                    >
                  </div>
                </div>
              </div>

              <!-- Form Actions -->
              <div class="form-actions">
                <button
                  type="button"
                  class="btn btn-secondary"
                  onclick="window.location.href = 'manage-agents.html'"
                >
                  <i class="fas fa-times"></i>
                  Cancel
                </button>
                <button type="submit" class="btn btn-primary">
                  <i class="fas fa-save"></i>
                  Save Changes
                </button>
              </div>
            </form>
          </div>
        </div>
      </main>
    </div>

    <script>
      /* ==================== AUTHENTICATION & USER DATA ==================== */

      async function checkAuth() {
        try {
          const response = await fetch("/api/auth/check", {
            credentials: "include",
          });

          if (!response.ok) {
            throw new Error("Not authenticated");
          }

          const result = await response.json();

          if (!result.success) {
            window.location.href = "index.html";
            return null;
          }

          if (result.data) {
            localStorage.setItem("userData", JSON.stringify(result.data));
            return result.data;
          }

          return null;
        } catch (err) {
          window.location.href = "index.html";
          return null;
        }
      }

      // Load admin info into header
      function loadAdminInfo() {
        const userDataStr = localStorage.getItem("userData");

        if (userDataStr) {
          try {
            const userData = JSON.parse(userDataStr);

            const userName = document.querySelector(".user-name");
            const userAvatar = document.querySelector(".user-avatar");
            const userRole = document.querySelector(".user-role");

            if (userName) {
              const namePart = userData.username || "Admin";
              const formattedName = namePart
                .split(".")
                .map((n) => n.charAt(0).toUpperCase() + n.slice(1))
                .join(" ");
              userName.textContent = formattedName;
            }

            if (userAvatar) {
              const namePart = userData.username || "Admin";
              const initials = namePart
                .split(".")
                .map((n) => (n[0] ? n[0].toUpperCase() : ""))
                .join("");
              userAvatar.textContent = initials || "A";
            }

            if (userRole) {
              userRole.textContent = userData.role || "Security Admin";
            }
          } catch (e) {
            console.error("Error parsing user data:", e);
          }
        }
      }

      async function refreshUserData() {
        const userData = await checkAuth();
        if (userData) {
          localStorage.setItem("userData", JSON.stringify(userData));
          loadAdminInfo();
        }
      }

      // Refresh every 5 minutes
      setInterval(refreshUserData, 5 * 60 * 1000);

      /* ==================== SIDEBAR FUNCTIONS ==================== */

      function toggleSubMenu(element) {
        var sidebar = document.getElementById("sidebar");
        if (sidebar.classList.contains("collapsed")) return;

        var subMenu = element.nextElementSibling;
        var allSubMenus = document.querySelectorAll(".sub-menu");
        var allDropdowns = document.querySelectorAll(".nav-dropdown");

        // Close other open submenus
        allSubMenus.forEach(function (menu) {
          if (menu !== subMenu) menu.classList.remove("open");
        });
        allDropdowns.forEach(function (link) {
          if (link !== element) link.classList.remove("expanded");
        });

        // Toggle current
        element.classList.toggle("expanded");
        subMenu.classList.toggle("open");
      }

      function toggleSidebar() {
        var sidebar = document.getElementById("sidebar");
        var mainContent = document.getElementById("mainContent");
        var header = document.getElementById("topHeader");

        sidebar.classList.toggle("collapsed");
        var isCollapsed = sidebar.classList.contains("collapsed");

        if (mainContent) mainContent.classList.toggle("expanded");

        // Update header left position
        if (header) {
          header.style.left = isCollapsed ? "70px" : "240px";
        }

        // Close all submenus when collapsing
        if (isCollapsed) {
          document.querySelectorAll(".sub-menu").forEach(function (m) {
            m.classList.remove("open");
          });
          document.querySelectorAll(".nav-dropdown").forEach(function (l) {
            l.classList.remove("expanded");
          });
        }

        // Dispatch event for other components
        window.dispatchEvent(
          new CustomEvent("sidebarToggle", {
            detail: { collapsed: isCollapsed },
          })
        );
      }

      function openMobileSidebar() {
        var sidebar = document.getElementById("sidebar");
        var overlay = document.getElementById("sidebarOverlay");
        if (sidebar) sidebar.classList.add("mobile-open");
        if (overlay) overlay.classList.add("active");
      }

      function closeMobileSidebar() {
        var sidebar = document.getElementById("sidebar");
        var overlay = document.getElementById("sidebarOverlay");
        if (sidebar) sidebar.classList.remove("mobile-open");
        if (overlay) overlay.classList.remove("active");
      }

      function toggleMobileMenu() {
        var sidebar = document.getElementById("sidebar");
        var overlay = document.getElementById("sidebarOverlay");
        if (!sidebar) return;

        if (sidebar.classList.contains("mobile-open")) {
          closeMobileSidebar();
        } else {
          openMobileSidebar();
        }
      }

      function setActiveMenuItem() {
        var currentPage = window.location.pathname.split('/').pop() || 'edit-agent.html';

        // First remove all active classes
        document.querySelectorAll('.nav-link, .sub-menu-item').forEach(function(el) {
          el.classList.remove('active');
        });

        // Handle sub-menu items
        document.querySelectorAll('.sub-menu-item[data-page]').forEach(function (item) {
          var href = item.getAttribute('href');
          if (href === currentPage) {
            item.classList.add('active');
            var parentSubMenu = item.closest('.sub-menu');
            if (parentSubMenu) {
              parentSubMenu.classList.add('open');
              var parentNav = parentSubMenu.previousElementSibling;
              if (parentNav) parentNav.classList.add('expanded');
            }
          }
        });

        // Handle main nav links
        document.querySelectorAll('.nav-link[data-page]').forEach(function (link) {
          var href = link.getAttribute('href');
          if (href === currentPage) {
            link.classList.add('active');
          }
        });
      }

      /* ==================== HEADER FUNCTIONS ==================== */

      function toggleNotifications(event) {
        event.stopPropagation();
        var panel = document.getElementById("notificationsPanel");
        var overlay = document.getElementById("notificationOverlay");
        var btn = event.currentTarget;
        if (!panel || !overlay) return;

        if (panel.classList.contains("show")) {
          closeNotifications();
        } else {
          closeUserDropdown();
          panel.classList.add("show");
          overlay.classList.add("show");
          btn.classList.add("active");
          document.body.style.overflow = "hidden";
        }
      }

      function closeNotifications() {
        var panel = document.getElementById("notificationsPanel");
        var overlay = document.getElementById("notificationOverlay");
        var btn = document.querySelector(".notification-btn");
        if (panel) panel.classList.remove("show");
        if (overlay) overlay.classList.remove("show");
        if (btn) btn.classList.remove("active");
        document.body.style.overflow = "";
      }

      function switchTab(event, tabName) {
        document.querySelectorAll(".tab-btn").forEach(function (t) {
          t.classList.remove("active");
        });
        event.currentTarget.classList.add("active");

        document
          .querySelectorAll(".notification-item")
          .forEach(function (item) {
            item.style.display =
              tabName === "unread" && !item.classList.contains("unread")
                ? "none"
                : "flex";
          });
      }

      function toggleUserDropdown(event) {
        event.stopPropagation();
        var dropdown = document.getElementById("userDropdown");
        var userProfile = event.currentTarget;
        if (!dropdown) return;

        if (dropdown.classList.contains("show")) {
          closeUserDropdown();
        } else {
          closeNotifications();
          dropdown.classList.add("show");
          userProfile.classList.add("active");
        }
      }

      function closeUserDropdown() {
        var dropdown = document.getElementById("userDropdown");
        var userProfile = document.querySelector(".user-profile");
        if (dropdown) dropdown.classList.remove("show");
        if (userProfile) userProfile.classList.remove("active");
      }

      function logout(event) {
        event.preventDefault();

        fetch("/api/auth/logout", {
          method: "POST",
          credentials: "include",
        }).finally(() => {
          localStorage.removeItem("isLoggedIn");
          localStorage.removeItem("userEmail");
          localStorage.removeItem("userData");
          window.location.href = "index.html";
        });
      }

      // Close dropdowns when clicking outside
      document.addEventListener("click", function (event) {
        if (!event.target.closest(".user-profile")) {
          closeUserDropdown();
        }
        if (
          !event.target.closest(".notification-btn") &&
          !event.target.closest(".notifications-panel")
        ) {
          closeNotifications();
        }
      });

      /* ==================== EDIT AGENT FUNCTIONS ==================== */

      const originalFormData = {};

      // Get agent ID from URL
      function getAgentIdFromUrl() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get("id");
      }

      async function loadAgentData(agentId) {
        try {
          // Show loading state
          showLoadingState();

          const response = await fetch(`/api/admin/agents`, {
            credentials: "include",
          });

          if (!response.ok) throw new Error("Failed to fetch agents");

          const result = await response.json();

          if (result.success) {
            const agent = result.data.find((a) => a.id.toString() === agentId);
            if (agent) {
              // Populate form fields
              document.getElementById("agentName").value =
                agent.hostname || "N/A";
              document.getElementById("hostname").value =
                agent.hostname || "N/A";
              document.getElementById("ipAddress").value =
                agent.ipAddress || "N/A";
              document.getElementById("macAddress").value =
                agent.macAddress || "Not available";
              document.getElementById("username").value = agent.username || "";
              document.getElementById("email").value = agent.email || "";

              // Clear password fields
              document.getElementById("password").value = "";
              document.getElementById("confirmPassword").value = "";

              setFieldStates(agent);

              // Update status badge
              updateStatusBadge(agent);

              // Update info card with ALL available data
              updateInfoCard(agent);

              // Store original form data for reset
              captureOriginalFormData();
            } else {
              alert("Agent not found");
              window.location.href = "manage-agents.html";
            }
          }
        } catch (error) {
          console.error("Error loading agent:", error);
          showErrorState();
        }
      }

      // Update status badge
      function updateStatusBadge(agent) {
        const statusDiv = document.getElementById("agentStatus");
        if (statusDiv) {
          const isOnline =
            agent.lastHeartbeat &&
            Date.now() - new Date(agent.lastHeartbeat).getTime() < 45000;
          const statusText = isOnline ? "Online" : "Offline";
          const statusClass = isOnline ? "" : "offline";

          statusDiv.className = `agent-status ${statusClass}`;
          statusDiv.innerHTML = `<i class="fas fa-circle"></i><span>${statusText}</span>`;
        }
      }

      // Update info card with agent data
      function updateInfoCard(agent) {
        // Agent ID
        const agentIdEl = document.getElementById("agentIdValue");
        if (agentIdEl) agentIdEl.textContent = agent.id || "N/A";

        // Registered date - use createdAt if available
        const registeredEl = document.getElementById("registeredDateValue");
        if (registeredEl) {
          registeredEl.textContent = agent.createdAt
            ? new Date(agent.createdAt).toLocaleDateString("en-US", {
                year: "numeric",
                month: "short",
                day: "numeric",
              })
            : "N/A";
        }

        // Last Update - use updatedAt if available
        const lastUpdateEl = document.getElementById("lastUpdateValue");
        if (lastUpdateEl) {
          lastUpdateEl.textContent = agent.updatedAt
            ? new Date(agent.updatedAt).toLocaleDateString("en-US", {
                year: "numeric",
                month: "short",
                day: "numeric",
              })
            : "N/A";
        }

        // Last Seen
        const lastSeenEl = document.getElementById("lastSeenValue");
        if (lastSeenEl) {
          lastSeenEl.textContent = agent.lastHeartbeat
            ? formatTimeAgo(agent.lastHeartbeat)
            : "Never";
        }
      }

      // Show loading state
      function showLoadingState() {
        // Set loading text in info card
        document.getElementById("agentIdValue").textContent = "Loading...";
        document.getElementById("registeredDateValue").textContent =
          "Loading...";
        document.getElementById("lastUpdateValue").textContent = "Loading...";
        document.getElementById("lastSeenValue").textContent = "Loading...";

        // Set loading text in form fields
        document.getElementById("agentName").value = "Loading...";
        document.getElementById("hostname").value = "Loading...";
        document.getElementById("ipAddress").value = "Loading...";
        document.getElementById("macAddress").value = "Loading...";
        document.getElementById("username").value = "Loading...";
        document.getElementById("email").value = "Loading...";
      }

      // Show error state
      function showErrorState() {
        document.getElementById("agentIdValue").textContent = "Error loading";
        document.getElementById("registeredDateValue").textContent = "Error";
        document.getElementById("lastUpdateValue").textContent = "Error";
        document.getElementById("lastSeenValue").textContent = "Error";

        // You can add a retry button or message
        const infoCard = document.querySelector(".info-card");
        if (infoCard) {
          const errorMsg = document.createElement("p");
          errorMsg.style.color = "red";
          errorMsg.style.marginTop = "10px";
          errorMsg.innerHTML =
            '<i class="fas fa-exclamation-triangle"></i> Failed to load agent data. <a href="#" onclick="location.reload()">Retry</a>';
          infoCard.appendChild(errorMsg);
        }
      }

      function captureOriginalFormData() {
        const form = document.getElementById("editAgentForm");
        if (form) {
          const inputs = form.querySelectorAll("input, select, textarea");
          inputs.forEach((input) => {
            if (input.type === "checkbox") {
              originalFormData[input.id] = input.checked;
            } else {
              originalFormData[input.id] = input.value;
            }
          });
          console.log("Original form data captured:", originalFormData);
        }
      }

      // Format time ago helper
      function formatTimeAgo(timestamp) {
        if (!timestamp) return "Never";
        const seconds = Math.floor((Date.now() - new Date(timestamp)) / 1000);
        if (seconds < 60) return `${seconds}s ago`;
        if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
        if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
        return `${Math.floor(seconds / 86400)}d ago`;
      }

      function isAgentOnline(agent) {
        if (!agent.lastHeartbeat) return false;
        const secondsSince = Math.floor(
          (Date.now() - new Date(agent.lastHeartbeat).getTime()) / 1000
        );
        return secondsSince <= 15;
      }

      function setFieldStates(agent) {
        const online = isAgentOnline(agent);

        // Disable fields that can only be updated when agent is online
        document.getElementById("agentName").disabled = true;
        document.getElementById("hostname").disabled = true;
        document.getElementById("ipAddress").disabled = true;
        document.getElementById("macAddress").disabled = true;

        // Username and email are always editable by admin
        document.getElementById("username").disabled = false;
        document.getElementById("email").disabled = false;

        // Password fields start disabled
        document.getElementById("password").disabled = true;
        document.getElementById("confirmPassword").disabled = true;
        document.getElementById("password").required = false;
        document.getElementById("confirmPassword").required = false;

        // Reset change password button
        const changeBtn = document.getElementById("changePasswordBtn");
        if (changeBtn) {
          changeBtn.innerHTML = '<i class="fas fa-key"></i> Change Password';
          changeBtn.classList.remove("btn-warning");
          changeBtn.classList.add("btn-secondary");
        }
      }

      function togglePasswordChange() {
        const passwordField = document.getElementById("password");
        const confirmField = document.getElementById("confirmPassword");
        const changeBtn = document.getElementById("changePasswordBtn");

        if (passwordField.disabled) {
          // Enable password fields
          passwordField.disabled = false;
          confirmField.disabled = false;
          passwordField.value = "";
          confirmField.value = "";
          passwordField.placeholder = "Enter new password";
          passwordField.required = true;
          confirmField.required = true;
          changeBtn.innerHTML = '<i class="fas fa-times"></i> Cancel';
          changeBtn.classList.remove("btn-secondary");
          changeBtn.classList.add("btn-warning");
          document.getElementById("passwordHelp").innerHTML =
            "Enter a new password for this agent";
        } else {
          // Disable password fields
          passwordField.disabled = true;
          confirmField.disabled = true;
          passwordField.value = "";
          confirmField.value = "";
          passwordField.placeholder = "••••••••";
          passwordField.required = false;
          confirmField.required = false;
          changeBtn.innerHTML = '<i class="fas fa-key"></i> Change Password';
          changeBtn.classList.remove("btn-warning");
          changeBtn.classList.add("btn-secondary");
          document.getElementById("passwordHelp").innerHTML =
            'Click "Change Password" to set a new password';
        }
      }

      async function handleSubmit(event) {
        event.preventDefault();

        const agentId = getAgentIdFromUrl();
        const username = document.getElementById("username").value;
        const email = document.getElementById("email").value;
        const password = document.getElementById("password").value;
        const passwordDisabled = document.getElementById("password").disabled;
        const confirmPassword = document.getElementById("confirmPassword").value;

        // Validate
        if (!username || !email) {
          alert("Username and Email are required!");
          return;
        }

        // Email validation
        const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailPattern.test(email)) {
          alert("Please enter a valid email address!");
          return;
        }

        // Password validation (only if password is provided AND fields are enabled)
        if (!passwordDisabled && (password || confirmPassword)) {
          if (password !== confirmPassword) {
            alert("Passwords do not match!");
            return;
          }
          if (password.length < 6) {
            alert("Password must be at least 6 characters long!");
            return;
          }
        }

        // Prepare request data
        const requestData = {
          username: username,
          email: email,
        };

        // Only include password if it was changed AND fields are enabled
        if (!passwordDisabled && password) {
          requestData.password = password;
        }

        // Disable submit button
        const submitBtn = event.target.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner"></span> Saving...';

        try {
          const response = await fetch(`/api/admin/agents/${agentId}`, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
            },
            credentials: "include",
            body: JSON.stringify(requestData),
          });

          const result = await response.json();

          if (response.ok && result.success) {
            alert("Agent updated successfully!");
            window.location.href = `agent-view.html?id=${agentId}`;
          } else {
            alert(result.message || "Failed to update agent");
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
          }
        } catch (error) {
          console.error("Error updating agent:", error);
          alert("Network error: Could not connect to server");
          submitBtn.disabled = false;
          submitBtn.innerHTML = originalText;
        }
      }

      // Function to execute scripts after loading components
      function executeScripts(element) {
        const scripts = element.querySelectorAll("script");
        scripts.forEach((oldScript) => {
          const newScript = document.createElement("script");
          Array.from(oldScript.attributes).forEach((attr) => {
            newScript.setAttribute(attr.name, attr.value);
          });
          if (oldScript.textContent) {
            newScript.textContent = oldScript.textContent;
          }
          oldScript.parentNode.replaceChild(newScript, oldScript);
        });
      }

      // Load component function
      async function loadComponent(url, containerId) {
        try {
          const response = await fetch(url);
          const html = await response.text();
          const container = document.getElementById(containerId);
          const tempDiv = document.createElement("div");
          tempDiv.innerHTML = html;
          container.innerHTML = "";
          while (tempDiv.firstChild) {
            container.appendChild(tempDiv.firstChild);
          }
          executeScripts(container);
        } catch (error) {
          console.error("Error loading component:", error);
        }
      }

      /* ==================== EVENT LISTENERS ==================== */

      window.addEventListener("resize", function () {
        const sidebar = document.getElementById("sidebar");
        const mainContent = document.getElementById("mainContent");
        const header = document.getElementById("topHeader");
        const windowWidth = window.innerWidth;

        if (windowWidth <= 968) {
          if (sidebar) sidebar.classList.remove("collapsed");
          if (mainContent) mainContent.classList.remove("expanded");
          if (header) {
            header.style.left = "0";
          }
        } else {
          if (sidebar && mainContent && header) {
            if (sidebar.classList.contains("collapsed")) {
              mainContent.classList.add("expanded");
              header.style.left = "70px";
            } else {
              mainContent.classList.remove("expanded");
              header.style.left = "240px";
            }
          }
        }
      });

      window.addEventListener("sidebarToggle", function (event) {
        const header = document.getElementById("topHeader");
        const mainContent = document.getElementById("mainContent");

        if (header && mainContent) {
          if (event.detail.collapsed) {
            header.style.left = "70px";
            mainContent.classList.add("expanded");
          } else {
            header.style.left = "240px";
            mainContent.classList.remove("expanded");
          }
        }
      });

      document.addEventListener("click", function (e) {
        const sidebar = document.getElementById("sidebar");
        const mobileMenuToggle = document.querySelector(".mobile-menu-toggle");

        if (sidebar && window.innerWidth <= 968) {
          if (
            !sidebar.contains(e.target) &&
            (!mobileMenuToggle || !mobileMenuToggle.contains(e.target))
          ) {
            sidebar.classList.remove("mobile-open");
            const overlay = document.getElementById("sidebarOverlay");
            if (overlay) {
              overlay.classList.remove("active");
            }
          }
        }
      });

      // Warn on unsaved changes
      let formChanged = false;
      const form = document.getElementById("editAgentForm");

      if (form) {
        form.addEventListener("change", function () {
          formChanged = true;
        });
      }

      window.addEventListener("beforeunload", function (e) {
        if (formChanged) {
          e.preventDefault();
          e.returnValue = "";
        }
      });

      // Initialize on DOM ready
      document.addEventListener("DOMContentLoaded", async function () {
        try {
          const userData = await checkAuth();
          if (userData) {
            loadAdminInfo();
          }

          // Get agent ID from URL
          const agentId = getAgentIdFromUrl();
          if (!agentId) {
            alert("No agent ID provided");
            window.location.href = "manage-agents.html";
            return;
          }

          // Set active menu item
          setActiveMenuItem();

          // Load components
          await loadComponent("sidebar.html", "sidebarContainer");
          await loadComponent("page-header.html", "headerContainer");

          // LOAD AGENT DATA AFTER COMPONENTS ARE LOADED
          await loadAgentData(agentId);

          // Initialize sidebar state
          const sidebar = document.getElementById("sidebar");
          const mainContent = document.getElementById("mainContent");
          const header = document.getElementById("topHeader");
          const windowWidth = window.innerWidth;

          if (sidebar && mainContent && header) {
            if (windowWidth <= 968) {
              mainContent.classList.remove("expanded");
              header.style.left = "0";
            } else {
              if (sidebar.classList.contains("collapsed")) {
                mainContent.classList.add("expanded");
                header.style.left = "70px";
              } else {
                mainContent.classList.remove("expanded");
                header.style.left = "240px";
              }
            }
          }
        } catch (error) {
          console.error("Error initializing page:", error);
        }
      });

      // Make functions globally available
      window.toggleSidebar = toggleSidebar;
      window.toggleMobileMenu = toggleMobileMenu;
      window.closeMobileSidebar = closeMobileSidebar;
      window.toggleNotifications = toggleNotifications;
      window.closeNotifications = closeNotifications;
      window.switchTab = switchTab;
      window.toggleUserDropdown = toggleUserDropdown;
      window.logout = logout;
      window.togglePasswordChange = togglePasswordChange;
      window.handleSubmit = handleSubmit;
    </script>
  </body>
</html>