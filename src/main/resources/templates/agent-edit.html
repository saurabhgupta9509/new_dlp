<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Edit Agent - DLP Shield</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: #f8fafc;
        color: #1e293b;
        overflow-x: hidden;
      }

      /* Dashboard Container */
      .dashboard-container {
        display: flex;
        min-height: 100vh;
        overflow-x: hidden;
      }

      /* Main Content Layout */
      .main-content {
        flex: 1;
        margin-left: 240px;
        transition: margin-left 0.3s ease;
        padding-top: 70px;
        width: calc(100vw - 240px);
        max-width: 100%;
        overflow-x: hidden;
      }

      .main-content.expanded {
        margin-left: 70px;
        width: calc(100vw - 70px);
      }

      .content-area {
        padding: 24px;
        width: 100%;
        max-width: 100%;
        overflow-x: hidden;
      }

      /* Back Button */
      .back-button {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 10px 16px;
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        color: #475569;
        text-decoration: none;
        font-size: 14px;
        margin-bottom: 20px;
        transition: all 0.2s;
      }

      .back-button:hover {
        background: #f8fafc;
        border-color: #cbd5e1;
      }

      /* Page Header */
      .page-header {
        background: white;
        padding: 24px;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        margin-bottom: 24px;
        width: 100%;
      }

      .page-header-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 16px;
      }

      .page-header h1 {
        font-size: 28px;
        color: #1e293b;
        margin-bottom: 8px;
      }

      .page-header p {
        font-size: 14px;
        color: #64748b;
      }

      .agent-status {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 16px;
        background: #d1fae5;
        color: #065f46;
        border-radius: 20px;
        font-size: 14px;
        font-weight: 500;
        margin-left: auto;
      }

      .agent-status.offline {
        background: #fee2e2;
        color: #991b1b;
      }

      /* Form Container */
      .form-container {
        background: white;
        padding: 32px;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        width: 100%;
      }

      .form-section {
        margin-bottom: 32px;
      }

      .form-section:last-child {
        margin-bottom: 0;
      }

      .section-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 20px;
        padding-bottom: 12px;
        border-bottom: 2px solid #f1f5f9;
      }

      .section-header i {
        font-size: 20px;
        color: #3b82f6;
      }

      .section-header h2 {
        font-size: 18px;
        color: #1e293b;
      }

      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
      }

      .form-row.full {
        grid-template-columns: 1fr;
      }

      .form-group {
        display: flex;
        flex-direction: column;
      }

      .form-group label {
        font-size: 14px;
        font-weight: 500;
        color: #475569;
        margin-bottom: 8px;
      }

      .form-group label .required {
        color: #ef4444;
      }

      .form-group input,
      .form-group select,
      .form-group textarea {
        padding: 12px 14px;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        font-size: 14px;
        font-family: inherit;
        transition: all 0.2s;
      }

      .form-group input:focus,
      .form-group select:focus,
      .form-group textarea:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }

      .form-group input:disabled,
      .form-group select:disabled {
        background: #f8fafc;
        color: #94a3b8;
        cursor: not-allowed;
      }

      .form-group textarea {
        resize: vertical;
        min-height: 100px;
      }

      .form-help {
        font-size: 12px;
        color: #94a3b8;
        margin-top: 4px;
      }

      .checkbox-group {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .checkbox-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 12px;
        background: #f8fafc;
        border-radius: 8px;
        border: 1px solid #e2e8f0;
        cursor: pointer;
        transition: all 0.2s;
      }

      .checkbox-item:hover {
        background: #f1f5f9;
        border-color: #cbd5e1;
      }

      .checkbox-item input[type="checkbox"] {
        width: 18px;
        height: 18px;
        cursor: pointer;
      }

      .checkbox-item label {
        cursor: pointer;
        margin: 0;
        font-size: 14px;
        color: #1e293b;
      }

      .checkbox-item .checkbox-description {
        font-size: 12px;
        color: #64748b;
        margin-top: 2px;
      }

      /* Info Card */
      .info-card {
        background: #f0f9ff;
        border: 1px solid #bfdbfe;
        border-left: 4px solid #3b82f6;
        padding: 16px;
        border-radius: 8px;
        margin-bottom: 20px;
      }

      .info-card h3 {
        font-size: 14px;
        color: #1e40af;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .info-card p {
        font-size: 13px;
        color: #475569;
        margin-bottom: 8px;
      }

      .info-card p:last-child {
        margin-bottom: 0;
      }

      .info-item {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid #e0f2fe;
      }

      .info-item:last-child {
        border-bottom: none;
      }

      .info-label {
        font-weight: 500;
        color: #1e40af;
      }

      .info-value {
        color: #475569;
      }

      /* Danger Zone */
      .danger-zone {
        background: #fef2f2;
        border: 1px solid #fecaca;
        border-left: 4px solid #ef4444;
        padding: 20px;
        border-radius: 8px;
        margin-top: 32px;
      }

      .danger-zone h3 {
        font-size: 16px;
        color: #991b1b;
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .danger-zone p {
        font-size: 13px;
        color: #475569;
        margin-bottom: 16px;
      }

      .danger-actions {
        display: flex;
        gap: 12px;
      }

      /* Form Actions */
      .form-actions {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        margin-top: 32px;
        padding-top: 24px;
        border-top: 2px solid #f1f5f9;
      }

      .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }

      .btn-primary {
        background: #3b82f6;
        color: white;
      }

      .btn-primary:hover {
        background: #2563eb;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
      }

      .btn-secondary {
        background: #e2e8f0;
        color: #475569;
      }

      .btn-secondary:hover {
        background: #cbd5e1;
      }

      .btn-danger {
        background: #ef4444;
        color: white;
      }

      .btn-danger:hover {
        background: #dc2626;
      }

      .btn-warning {
        background: #f59e0b;
        color: white;
      }

      .btn-warning:hover {
        background: #d97706;
      }

      /* Responsive */
      @media (max-width: 968px) {
        .main-content {
          margin-left: 0 !important;
          width: 100% !important;
          padding-top: 70px;
        }

        .content-area {
          padding: 16px;
        }

        .form-row {
          grid-template-columns: 1fr;
        }

        .form-container {
          padding: 20px;
        }

        .danger-actions {
          flex-direction: column;
        }

        .form-actions {
          flex-wrap: wrap;
        }

        .page-header-content {
          flex-direction: column;
          align-items: flex-start;
        }
      }

      @media (max-width: 480px) {
        .content-area {
          padding: 12px;
        }

        .form-container {
          padding: 16px;
        }

        .btn {
          padding: 10px 16px;
          font-size: 13px;
        }

        .page-header h1 {
          font-size: 24px;
        }
      }

      /* Page Header */
      .page-header {
        background: white;
        padding: 24px;
        border-radius: 12px;
        border: 1px solid #e5e7eb;
        margin-bottom: 24px;
      }

      .page-title-section {
        display: flex;
        align-items: center;
        gap: 16px;
        flex-wrap: wrap;
      }

      .page-icon {
        width: 48px;
        height: 48px;
        background: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
      }

      .page-icon i {
        font-size: 22px;
        color: white;
      }

      .page-title-text h1 {
        font-size: 1.5em;
        color: #111827;
        font-weight: 700;
        line-height: 1.2;
      }

      .page-subtitle {
        color: #6b7280;
        font-size: 0.9em;
        margin-top: 4px;
      }
      /* Loading Spinner */
      .spinner {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: #fff;
        animation: spin 0.8s linear infinite;
        margin-right: 8px;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .btn-primary:disabled {
        opacity: 0.7;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }
    </style>
  </head>
  <body>
    <!-- Dashboard Container -->
    <div class="dashboard-container">
      <!-- Sidebar Container -->
      <div id="sidebarContainer"></div>

      <!-- Header Container -->
      <div id="headerContainer"></div>

      <!-- Main Content -->
      <main class="main-content" id="mainContent">
        <div class="content-area">
          <!-- Back Button -->
          <a href="manage-agents.html" class="back-button">
            <i class="fas fa-arrow-left"></i>
            Back to Agents
          </a>

          <!-- Page Header -->
          <!-- <div class="page-header">
                    <div class="page-header-content">
                        <div>
                            <h1>Edit Agent</h1>
                            <p>Update agent configuration and settings</p>
                        </div>
                        <div class="agent-status">
                            <i class="fas fa-circle"></i>
                            <span>Online</span>
                        </div>
                    </div>
                </div> -->

          <!-- Page Header -->
          <div class="page-header">
            <div class="page-title-section">
              <div class="page-icon"><i class="fas fa-edit"></i></div>
              <div class="page-title-text">
                <h1>Edit Agent</h1>
                <p class="page-subtitle">
                  Update agent configuration and settings
                </p>
              </div>
              <div class="agent-status">
                <i class="fas fa-circle"></i>
                <span>Online</span>
              </div>
            </div>
          </div>

          <!-- Form Container -->
          <div class="form-container">
            <!-- Agent Info Card -->
            <div class="info-card">
              <h3><i class="fas fa-info-circle"></i> Agent Information</h3>
              <div class="info-item">
                <span class="info-label">Agent ID:</span>
                <span class="info-value" id="agentIdValue">Loading..</span>
              </div>
              <div class="info-item">
                <span class="info-label">Registered:</span>
                <span class="info-value" id="registeredDateValue"
                  >Loading...</span
                >
              </div>
              <div class="info-item">
                <span class="info-label">Last Update:</span>
                <span class="info-value" id="lastUpdateValue">Loading...</span>
              </div>
              <div class="info-item">
                <span class="info-label">Last Seen:</span>
                <span class="info-value" id="lastSeenValue">Loading...</span>
              </div>
            </div>

            <form id="editAgentForm" onsubmit="handleSubmit(event)">
              <!-- Basic Information -->
              <div class="form-section">
                <div class="section-header">
                  <i class="fas fa-info-circle"></i>
                  <h2>Basic Information</h2>
                </div>

                <div class="form-row">
                  <div class="form-group">
                    <label>Agent Name <span class="required">*</span></label>
                    <input
                      type="text"
                      id="agentName"
                      value=""
                      required
                      disabled
                    />
                    <span class="form-help"
                      >Unique identifier for this agent</span
                    >
                  </div>

                  <div class="form-group">
                    <label>Hostname <span class="required">*</span></label>
                    <input
                      type="text"
                      id="hostname"
                      value=""
                      required
                      disabled
                    />
                    <span class="form-help">Computer hostname</span>
                  </div>
                </div>

                <div class="form-row">
                  <div class="form-group">
                    <label>IP Address <span class="required">*</span></label>
                    <input
                      type="text"
                      id="ipAddress"
                      value=""
                      required
                      pattern="^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$"
                      disabled
                    />
                    <span class="form-help">Static or DHCP IP address</span>
                  </div>

                  <div class="form-group">
                    <label>MAC Address</label>
                    <input type="text" id="macAddress" value="" disabled />
                    <span class="form-help"
                      >Physical network address (read-only)</span
                    >
                  </div>
                </div>

                <!-- Commented out Operating System and OS Version fields -->
                <!--
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Operating System <span class="required">*</span></label>
                                    <select id="operatingSystem" required>
                                        <option value="windows11" selected>Windows 11</option>
                                        <option value="windows10">Windows 10</option>
                                        <option value="windows-server">Windows Server</option>
                                        <option value="macos">macOS</option>
                                        <option value="linux">Linux</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label>OS Version</label>
                                    <input type="text" id="osVersion" value="22H2 (Build 22621.2428)">
                                    <span class="form-help">Specific version number</span>
                                </div>
                            </div>
                            -->
              </div>

              <!-- User Information -->
              <div class="form-section">
                <div class="section-header">
                  <i class="fas fa-user"></i>
                  <h2>User Information</h2>
                </div>

                <div class="form-row">
                  <div class="form-group">
                    <label>Username <span class="required">*</span></label>
                    <input type="text" id="username" value="" required />
                    <span class="form-help">Windows/System username</span>
                  </div>

                  <!-- Commented out Full Name field -->
                  <!--
                                <div class="form-group">
                                    <label>Full Name <span class="required">*</span></label>
                                    <input type="text" id="fullName" value="Rajesh Patel" required>
                                </div>
                                -->

                  <div class="form-group">
                    <label>Email Address <span class="required">*</span></label>
                    <input type="email" id="email" value="" required />
                  </div>
                </div>

                <div class="form-row">
                  <div class="form-group">
                    <label>Password</label>
                    <div style="display: flex; gap: 10px; align-items: center">
                      <input
                        type="password"
                        id="password"
                        placeholder="••••••••"
                        disabled
                        style="flex: 1"
                      />
                      <button
                        type="button"
                        id="changePasswordBtn"
                        class="btn btn-secondary"
                        style="padding: 12px 20px; white-space: nowrap"
                        onclick="togglePasswordChange()"
                      >
                        <i class="fas fa-key"></i> Change Password
                      </button>
                    </div>
                    <span class="form-help" id="passwordHelp"
                      >Click "Change Password" to set a new password</span
                    >
                  </div>

                  <div class="form-group">
                    <label>Confirm Password</label>
                    <input
                      type="password"
                      id="confirmPassword"
                      placeholder="Confirm new password"
                      disabled
                    />
                    <span class="form-help" id="confirmPasswordHelp"
                      >Confirm your new password</span
                    >
                  </div>
                </div>

                <!-- Commented out Phone, Department and Job Title fields -->
                <!--
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Phone Number</label>
                                    <input type="tel" id="phone" value="+91 98765 43210">
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label>Department <span class="required">*</span></label>
                                    <select id="department" required>
                                        <option value="IT" selected>IT</option>
                                        <option value="HR">Human Resources</option>
                                        <option value="Finance">Finance</option>
                                        <option value="Sales">Sales</option>
                                        <option value="Marketing">Marketing</option>
                                        <option value="Operations">Operations</option>
                                        <option value="Support">Support</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label>Job Title</label>
                                    <input type="text" id="jobTitle" value="Senior Developer">
                                </div>
                            </div>
                            -->
              </div>

              <!-- Commented out Agent Configuration section -->
              <!--
                        <div class="form-section">
                            <div class="section-header">
                                <i class="fas fa-cog"></i>
                                <h2>Agent Configuration</h2>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label>Agent Version</label>
                                    <select id="agentVersion">
                                        <option value="latest" selected>Latest (v2.5.3)</option>
                                        <option value="2.5.2">v2.5.2</option>
                                        <option value="2.5.1">v2.5.1</option>
                                        <option value="2.5.0">v2.5.0</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label>Monitoring Mode</label>
                                    <select id="monitoringMode">
                                        <option value="active" selected>Active Monitoring</option>
                                        <option value="passive">Passive Monitoring</option>
                                        <option value="audit">Audit Only</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-row full">
                                <div class="form-group">
                                    <label>Description / Notes</label>
                                    <textarea id="description" placeholder="Add any additional notes or description about this agent...">Primary development workstation for Senior Developer Rajesh Patel. High-performance system used for software development and testing.</textarea>
                                </div>
                            </div>
                        </div>
                        -->

              <!-- Commented out Features section -->
              <!--
                        <div class="form-section">
                            <div class="section-header">
                                <i class="fas fa-toggle-on"></i>
                                <h2>Enable Features</h2>
                            </div>

                            <div class="checkbox-group">
                                <div class="checkbox-item">
                                    <input type="checkbox" id="urlMonitoring" checked>
                                    <div>
                                        <label for="urlMonitoring">URL Monitoring</label>
                                        <div class="checkbox-description">Track and log all websites visited by the user</div>
                                    </div>
                                </div>

                                <div class="checkbox-item">
                                    <input type="checkbox" id="appMonitoring" checked>
                                    <div>
                                        <label for="appMonitoring">Application Monitoring</label>
                                        <div class="checkbox-description">Monitor all applications used and their usage time</div>
                                    </div>
                                </div>

                                <div class="checkbox-item">
                                    <input type="checkbox" id="fileMonitoring" checked>
                                    <div>
                                        <label for="fileMonitoring">File Transfer Monitoring</label>
                                        <div class="checkbox-description">Track file transfers via USB, email, and cloud services</div>
                                    </div>
                                </div>

                                <div class="checkbox-item">
                                    <input type="checkbox" id="screenCapture">
                                    <div>
                                        <label for="screenCapture">Screen Capture & OCR</label>
                                        <div class="checkbox-description">Periodic screenshots with AI-powered text analysis</div>
                                    </div>
                                </div>

                                <div class="checkbox-item">
                                    <input type="checkbox" id="usbMonitoring" checked>
                                    <div>
                                        <label for="usbMonitoring">USB Device Monitoring</label>
                                        <div class="checkbox-description">Log all USB device connections and file transfers</div>
                                    </div>
                                </div>

                                <div class="checkbox-item">
                                    <input type="checkbox" id="autoUpdate" checked>
                                    <div>
                                        <label for="autoUpdate">Automatic Updates</label>
                                        <div class="checkbox-description">Automatically update agent to latest version</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        -->

              <!-- Form Actions -->
              <div class="form-actions">
                <!-- Commented out Reset Changes button -->
                <!--
                            <button type="button" class="btn btn-secondary" onclick="resetForm()">
                                <i class="fas fa-rotate-left"></i>
                                Reset Changes
                            </button>
                            -->
                <button
                  type="button"
                  class="btn btn-secondary"
                  onclick="window.location.href = 'manage-agents.html'"
                >
                  <i class="fas fa-times"></i>
                  Cancel
                </button>
                <button type="submit" class="btn btn-primary">
                  <i class="fas fa-save"></i>
                  Save Changes
                </button>
              </div>
            </form>

            <!-- Commented out Danger Zone -->
            <!--
                    <div class="danger-zone">
                        <h3><i class="fas fa-triangle-exclamation"></i> Danger Zone</h3>
                        <p>Perform critical actions that can affect the agent's operation or permanently delete it from the system.</p>
                        <div class="danger-actions">
                            <button class="btn btn-warning" onclick="restartAgent()">
                                <i class="fas fa-power-off"></i>
                                Restart Agent
                            </button>
                            <button class="btn btn-warning" onclick="uninstallAgent()">
                                <i class="fas fa-download"></i>
                                Uninstall Agent
                            </button>
                            <button class="btn btn-danger" onclick="deleteAgent()">
                                <i class="fas fa-trash"></i>
                                Delete Agent
                            </button>
                        </div>
                    </div>
                    -->
          </div>
        </div>
      </main>
    </div>

    <script>
        const originalFormData = {};

      // Get agent ID from URL
      function getAgentIdFromUrl() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get("id");
      }
      async function checkAuth() {
        try {
          const response = await fetch("/api/auth/check", {
            credentials: "include",
          });

          if (!response.ok) {
            throw new Error("Not authenticated");
          }

          const result = await response.json();

          if (!result.success) {
            window.location.href = "index.html";
          }
        } catch (err) {
          window.location.href = "index.html";
        }
      }
      async function loadAgentData(agentId) {
        try {
          // Show loading state
          showLoadingState();

          const response = await fetch(`/api/admin/agents`, {
            credentials: "include",
          });

          if (!response.ok) throw new Error("Failed to fetch agents");

          const result = await response.json();

          if (result.success) {
            const agent = result.data.find((a) => a.id.toString() === agentId);
            if (agent) {
              // Populate form fields
              document.getElementById("agentName").value =
                agent.hostname || "N/A";
              document.getElementById("hostname").value =
                agent.hostname || "N/A";
              document.getElementById("ipAddress").value =
                agent.ipAddress || "N/A";
              document.getElementById("macAddress").value =
                agent.macAddress || "Not available";
              document.getElementById("username").value = agent.username || "";
              document.getElementById("email").value = agent.email || "";

              // Clear password fields
              document.getElementById("password").value = "";
              document.getElementById("confirmPassword").value = "";

              setFieldStates(agent);

              // Update status badge
              updateStatusBadge(agent);

              // Update info card with ALL available data
              updateInfoCard(agent);

               // ✅ Store original form data for reset - NOW it has the real values!
            captureOriginalFormData();
            } else {
              alert("Agent not found");
              window.location.href = "manage-agents.html";
            }
          }
        } catch (error) {
          console.error("Error loading agent:", error);
          showErrorState();
        }
      }

      // Update status badge
      function updateStatusBadge(agent) {
        const statusDiv = document.querySelector(".agent-status");
        if (statusDiv) {
          const isOnline =
            agent.lastHeartbeat &&
            Date.now() - new Date(agent.lastHeartbeat).getTime() < 45000;
          const statusText = isOnline ? "Online" : "Offline";
          const statusClass = isOnline ? "" : "offline";

          statusDiv.className = `agent-status ${statusClass}`;
          statusDiv.innerHTML = `<i class="fas fa-circle"></i><span>${statusText}</span>`;
        }
      }
      // Update info card with agent data
      function updateInfoCard(agent) {
        // Agent ID
        const agentIdEl = document.getElementById("agentIdValue");
        if (agentIdEl) agentIdEl.textContent = agent.id || "N/A";

        // Registered date - use createdAt if available
        const registeredEl = document.getElementById("registeredDateValue");
        if (registeredEl) {
          registeredEl.textContent = agent.createdAt
            ? new Date(agent.createdAt).toLocaleDateString("en-US", {
                year: "numeric",
                month: "short",
                day: "numeric",
              })
            : "N/A";
        }

        // Last Update - use updatedAt if available
        const lastUpdateEl = document.getElementById("lastUpdateValue");
        if (lastUpdateEl) {
          lastUpdateEl.textContent = agent.updatedAt
            ? new Date(agent.updatedAt).toLocaleDateString("en-US", {
                year: "numeric",
                month: "short",
                day: "numeric",
              })
            : "N/A";
        }

        // Last Seen
        const lastSeenEl = document.getElementById("lastSeenValue");
        if (lastSeenEl) {
          lastSeenEl.textContent = agent.lastHeartbeat
            ? formatTimeAgo(agent.lastHeartbeat)
            : "Never";
        }
      }
      // Show loading state
      function showLoadingState() {
        // Set loading text in info card
        document.getElementById("agentIdValue").textContent = "Loading...";
        document.getElementById("registeredDateValue").textContent =
          "Loading...";
        document.getElementById("lastUpdateValue").textContent = "Loading...";
        document.getElementById("lastSeenValue").textContent = "Loading...";

        // Set loading text in form fields
        document.getElementById("agentName").value = "Loading...";
        document.getElementById("hostname").value = "Loading...";
        document.getElementById("ipAddress").value = "Loading...";
        document.getElementById("macAddress").value = "Loading...";
        document.getElementById("username").value = "Loading...";
        document.getElementById("email").value = "Loading...";
      }

      // Show error state
      function showErrorState() {
        document.getElementById("agentIdValue").textContent = "Error loading";
        document.getElementById("registeredDateValue").textContent = "Error";
        document.getElementById("lastUpdateValue").textContent = "Error";
        document.getElementById("lastSeenValue").textContent = "Error";

        // You can add a retry button or message
        const infoCard = document.querySelector(".info-card");
        if (infoCard) {
          const errorMsg = document.createElement("p");
          errorMsg.style.color = "red";
          errorMsg.style.marginTop = "10px";
          errorMsg.innerHTML =
            '<i class="fas fa-exclamation-triangle"></i> Failed to load agent data. <a href="#" onclick="location.reload()">Retry</a>';
          infoCard.appendChild(errorMsg);
        }
      }

     
     function captureOriginalFormData() {
        const form = document.getElementById("editAgentForm");
        if (form) {
            const inputs = form.querySelectorAll("input, select, textarea");
            inputs.forEach((input) => {
            if (input.type === "checkbox") {
                originalFormData[input.id] = input.checked;
            } else {
                originalFormData[input.id] = input.value; // Now this has the REAL values
            }
            });
            console.log("Original form data captured:", originalFormData);
        }
        }
     

      // Format time ago helper
      function formatTimeAgo(timestamp) {
        if (!timestamp) return "Never";
        const seconds = Math.floor((Date.now() - new Date(timestamp)) / 1000);
        if (seconds < 60) return `${seconds}s ago`;
        if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
        if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
        return `${Math.floor(seconds / 86400)}d ago`;
      }

      function isAgentOnline(agent) {
        if (!agent.lastHeartbeat) return false;
        const secondsSince = Math.floor(
          (Date.now() - new Date(agent.lastHeartbeat).getTime()) / 1000,
        );
        return secondsSince <= 15;
      }

      function setFieldStates(agent) {
        const online = isAgentOnline(agent);

        // Disable fields that can only be updated when agent is online
        document.getElementById("agentName").disabled = true;
        document.getElementById("hostname").disabled = true;
        document.getElementById("ipAddress").disabled = true;
        document.getElementById("macAddress").disabled = true;

        // Username and email are always editable by admin
        document.getElementById("username").disabled = false;
        document.getElementById("email").disabled = false;

        // Password fields start disabled
        document.getElementById("password").disabled = true;
        document.getElementById("confirmPassword").disabled = true;
        document.getElementById("password").required = false;
        document.getElementById("confirmPassword").required = false;

        // Reset change password button
        const changeBtn = document.getElementById("changePasswordBtn");
        if (changeBtn) {
          changeBtn.innerHTML = '<i class="fas fa-key"></i> Change Password';
          changeBtn.classList.remove("btn-warning");
          changeBtn.classList.add("btn-secondary");
        }
      }

      function togglePasswordChange() {
        const passwordField = document.getElementById("password");
        const confirmField = document.getElementById("confirmPassword");
        const changeBtn = document.getElementById("changePasswordBtn");

        if (passwordField.disabled) {
          // Enable password fields
          passwordField.disabled = false;
          confirmField.disabled = false;
          passwordField.value = "";
          confirmField.value = "";
          passwordField.placeholder = "Enter new password";
          passwordField.required = true;
          confirmField.required = true;
          changeBtn.innerHTML = '<i class="fas fa-times"></i> Cancel';
          changeBtn.classList.remove("btn-secondary");
          changeBtn.classList.add("btn-warning");
          document.getElementById("passwordHelp").innerHTML =
            "Enter a new password for this agent";
        } else {
          // Disable password fields
          passwordField.disabled = true;
          confirmField.disabled = true;
          passwordField.value = "";
          confirmField.value = "";
          passwordField.placeholder = "••••••••";
          passwordField.required = false;
          confirmField.required = false;
          changeBtn.innerHTML = '<i class="fas fa-key"></i> Change Password';
          changeBtn.classList.remove("btn-warning");
          changeBtn.classList.add("btn-secondary");
          document.getElementById("passwordHelp").innerHTML =
            'Click "Change Password" to set a new password';
        }
      }

      // Function to execute scripts after loading components
      function executeScripts(element) {
        const scripts = element.querySelectorAll("script");
        scripts.forEach((oldScript) => {
          const newScript = document.createElement("script");
          Array.from(oldScript.attributes).forEach((attr) => {
            newScript.setAttribute(attr.name, attr.value);
          });
          if (oldScript.textContent) {
            newScript.textContent = oldScript.textContent;
          }
          oldScript.parentNode.replaceChild(newScript, oldScript);
        });
      }

      // Load component function
      async function loadComponent(url, containerId) {
        try {
          const response = await fetch(url);
          const html = await response.text();
          const container = document.getElementById(containerId);
          const tempDiv = document.createElement("div");
          tempDiv.innerHTML = html;
          container.innerHTML = "";
          while (tempDiv.firstChild) {
            container.appendChild(tempDiv.firstChild);
          }
          executeScripts(container);
        } catch (error) {
          console.error("Error loading component:", error);
        }
      }

      // Load sidebar and header on page load
      document.addEventListener("DOMContentLoaded", async function () {
        // Check authentication
        try {
          const authResponse = await fetch("/api/auth/check", {
            credentials: "include",
          });
          const authResult = await authResponse.json();
          if (!authResult.success) {
            window.location.href = "index.html";
            return;
          }
        } catch (err) {
          window.location.href = "index.html";
          return;
        }

        // Get agent ID from URL
        const agentId = getAgentIdFromUrl();
        if (!agentId) {
          alert("No agent ID provided");
          window.location.href = "manage-agents.html";
          return;
        }

        // Load components
        await loadComponent("sidebar.html", "sidebarContainer");
        await loadComponent("page-header.html", "headerContainer");

        // LOAD AGENT DATA AFTER COMPONENTS ARE LOADED
        await loadAgentData(agentId);

        // Initialize sidebar state
        setTimeout(() => {
          const sidebar = document.getElementById("sidebar");
          const mainContent = document.getElementById("mainContent");
          const header = document.querySelector(".top-header");

          if (sidebar && sidebar.classList.contains("collapsed")) {
            mainContent.classList.add("expanded");
            if (header) header.style.left = "70px";
          }
        }, 300);
      });
      // Listen for sidebar toggle events
      window.addEventListener("sidebarToggle", function (event) {
        const mainContent = document.getElementById("mainContent");
        if (mainContent) {
          if (event.detail.collapsed) {
            mainContent.classList.add("expanded");
          } else {
            mainContent.classList.remove("expanded");
          }
        }
      });



      // Reset form to original values
      function resetForm() {
        if (confirm("Reset all changes to original values?")) {
          const form = document.getElementById("editAgentForm");
          if (form) {
            const inputs = form.querySelectorAll("input, select, textarea");

            inputs.forEach((input) => {
              if (originalFormData.hasOwnProperty(input.id)) {
                if (input.type === "checkbox") {
                  input.checked = originalFormData[input.id];
                } else {
                  input.value = originalFormData[input.id];
                }
              }
            });

            alert("Form reset to original values!");
          }
        }
      }

      async function handleSubmit(event) {
        event.preventDefault();

        const agentId = getAgentIdFromUrl();
        const username = document.getElementById("username").value;
        const email = document.getElementById("email").value;
        const password = document.getElementById("password").value;
        const passwordDisabled = document.getElementById("password").disabled;
        const confirmPassword =
          document.getElementById("confirmPassword").value;

        // Validate
        if (!username || !email) {
          alert("Username and Email are required!");
          return;
        }

        // Email validation
        const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailPattern.test(email)) {
          alert("Please enter a valid email address!");
          return;
        }

        // Password validation (only if password is provided AND fields are enabled)
        if (!passwordDisabled && (password || confirmPassword)) {
          if (password !== confirmPassword) {
            alert("Passwords do not match!");
            return;
          }
          if (password.length < 6) {
            alert("Password must be at least 6 characters long!");
            return;
          }
        }

        // Prepare request data - ✅ DEFINE IT HERE
        const requestData = {
          username: username,
          email: email,
        };

        // Only include password if it was changed AND fields are enabled
        if (!passwordDisabled && password) {
          requestData.password = password;
        }

        // Disable submit button
        const submitBtn = event.target.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner"></span> Saving...';

        try {
          const response = await fetch(`/api/admin/agents/${agentId}`, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
            },
            credentials: "include",
            body: JSON.stringify(requestData),
          });

          const result = await response.json();

          if (response.ok && result.success) {
            alert("Agent updated successfully!");
            window.location.href = `agent-view.html?id=${agentId}`;
          } else {
            alert(result.message || "Failed to update agent");
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
          }
        } catch (error) {
          console.error("Error updating agent:", error);
          alert("Network error: Could not connect to server");
          submitBtn.disabled = false;
          submitBtn.innerHTML = originalText;
        }
      }
      // Warn on unsaved changes
      let formChanged = false;
      const form = document.getElementById("editAgentForm");

      if (form) {
        form.addEventListener("change", function () {
          formChanged = true;
        });
      }

      window.addEventListener("beforeunload", function (e) {
        if (formChanged) {
          e.preventDefault();
          e.returnValue = "";
        }
      });
    </script>
  </body>
</html>
