<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DLP Shield - Assign Policy</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        background: #f3f4f6;
      }
      .dashboard-container {
        display: flex;
        min-height: 100vh;
      }
      .main-content {
        flex: 1;
        margin-left: 240px;
        transition: margin-left 0.3s;
        padding-top: 60px;
      }
      .main-content.expanded {
        margin-left: 70px;
      }
      .content-area {
        padding: 24px;
        margin: 0 auto;
      }

      .page-header {
        background: white;
        padding: 20px 24px;
        border-radius: 12px;
        border: 1px solid #e5e7eb;
        margin-bottom: 24px;
      }
      .page-title-section {
        display: flex;
        align-items: center;
        gap: 16px;
      }
      .page-icon {
        width: 48px;
        height: 48px;
        background: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .page-icon i {
        font-size: 22px;
        color: white;
      }
      .page-title-text h1 {
        font-size: 1.5em;
        color: #111827;
        font-weight: 700;
      }
      .page-subtitle {
        color: #6b7280;
        font-size: 0.9em;
        margin-top: 4px;
      }

      .breadcrumb {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 20px;
        font-size: 0.85em;
      }
      .breadcrumb a {
        color: #6b7280;
        text-decoration: none;
      }
      .breadcrumb a:hover {
        color: #2563eb;
      }
      .breadcrumb span {
        color: #9ca3af;
      }

      .assign-container {
        background: white;
        border-radius: 12px;
        border: 1px solid #e5e7eb;
        padding: 28px;
      }

      .step-indicator {
        display: flex;
        justify-content: space-between;
        margin-bottom: 32px;
        position: relative;
      }
      .step-indicator::before {
        content: "";
        position: absolute;
        top: 20px;
        left: 0;
        right: 0;
        height: 2px;
        background: #e5e7eb;
        z-index: 0;
      }
      .step {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        position: relative;
        z-index: 1;
        flex: 1;
      }
      .step-circle {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: white;
        border: 2px solid #e5e7eb;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        color: #9ca3af;
        transition: all 0.3s;
      }
      .step.active .step-circle {
        background: #2563eb;
        border-color: #2563eb;
        color: white;
      }
      .step.completed .step-circle {
        background: #10b981;
        border-color: #10b981;
        color: white;
      }
      .step-label {
        font-size: 0.85em;
        color: #6b7280;
        font-weight: 500;
      }
      .step.active .step-label {
        color: #2563eb;
        font-weight: 600;
      }

      .section {
        margin-bottom: 28px;
      }
      .section-title {
        font-size: 1.1em;
        font-weight: 600;
        color: #111827;
        margin-bottom: 16px;
      }
      .section-desc {
        font-size: 0.9em;
        color: #6b7280;
        margin-bottom: 20px;
      }

      .form-group {
        margin-bottom: 20px;
      }
      .form-label {
        display: block;
        font-size: 0.9em;
        color: #374151;
        font-weight: 500;
        margin-bottom: 8px;
      }
      .form-select {
        width: 100%;
        padding: 11px 14px;
        border: 1.5px solid #e5e7eb;
        border-radius: 8px;
        font-size: 0.9em;
        background: white;
        cursor: pointer;
      }
      .form-select:focus {
        outline: none;
        border-color: #3b82f6;
      }
      .form-select:disabled {
        background: #f9fafb;
        cursor: not-allowed;
        opacity: 0.6;
      }

      .search-box {
        position: relative;
        margin-bottom: 16px;
      }
      .search-box i {
        position: absolute;
        left: 14px;
        top: 50%;
        transform: translateY(-50%);
        color: #9ca3af;
      }
      .search-input {
        width: 100%;
        padding: 11px 14px 11px 42px;
        border: 1.5px solid #e5e7eb;
        border-radius: 8px;
        font-size: 0.9em;
      }
      .search-input:focus {
        outline: none;
        border-color: #3b82f6;
      }

      .agents-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 12px;
        max-height: 400px;
        overflow-y: auto;
        padding: 12px;
        background: #f9fafb;
        border-radius: 8px;
        border: 1px solid #e5e7eb;
      }
      .agent-card {
        background: white;
        padding: 14px;
        border-radius: 8px;
        border: 1.5px solid #e5e7eb;
        cursor: pointer;
        transition: all 0.2s;
      }
      .agent-card:hover {
        border-color: #3b82f6;
        box-shadow: 0 2px 8px rgba(37, 99, 235, 0.1);
      }
      .agent-card.selected {
        border-color: #2563eb;
        background: #eff6ff;
      }
      .agent-card-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 8px;
      }
      .agent-checkbox {
        width: 18px;
        height: 18px;
        cursor: pointer;
      }
      .agent-name {
        font-weight: 600;
        font-size: 0.9em;
        color: #111827;
        flex: 1;
      }
      .agent-status {
        font-size: 0.75em;
        padding: 3px 8px;
        border-radius: 4px;
      }
      .status-online {
        background: #d1fae5;
        color: #059669;
      }
      .status-offline {
        background: #f3f4f6;
        color: #6b7280;
      }
      .agent-info {
        font-size: 0.8em;
        color: #6b7280;
        display: flex;
        gap: 12px;
        margin-top: 6px;
      }

      .selected-count {
        background: #eff6ff;
        padding: 12px 16px;
        border-radius: 8px;
        border: 1px solid #bfdbfe;
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .selected-count i {
        color: #2563eb;
      }
      .selected-count span {
        font-size: 0.9em;
        color: #1e40af;
        font-weight: 500;
      }

      .summary-box {
        background: #f9fafb;
        padding: 20px;
        border-radius: 8px;
        border: 1px solid #e5e7eb;
      }
      .summary-row {
        display: flex;
        justify-content: space-between;
        padding: 10px 0;
        border-bottom: 1px solid #e5e7eb;
      }
      .summary-row:last-child {
        border-bottom: none;
      }
      .summary-label {
        font-size: 0.9em;
        color: #6b7280;
      }
      .summary-value {
        font-size: 0.9em;
        color: #111827;
        font-weight: 600;
      }

      .policy-preview {
        background: white;
        padding: 16px;
        border-radius: 8px;
        border: 1.5px solid #3b82f6;
        margin-bottom: 16px;
      }
      .policy-preview-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 10px;
      }
      .policy-preview-icon {
        width: 36px;
        height: 36px;
        background: #eff6ff;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #2563eb;
      }
      .policy-preview-title {
        font-weight: 600;
        color: #111827;
      }
      .policy-preview-desc {
        font-size: 0.85em;
        color: #6b7280;
      }

      .domain-input-container {
        margin-top: 16px;
      }
      .domain-input-group {
        display: flex;
        gap: 8px;
        margin-bottom: 12px;
      }
      .domain-input {
        flex: 1;
        padding: 10px 14px;
        border: 1.5px solid #e5e7eb;
        border-radius: 8px;
        font-size: 0.9em;
      }
      .domain-input:focus {
        outline: none;
        border-color: #3b82f6;
      }
      .btn-add-domain {
        padding: 10px 20px;
        background: #2563eb;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.9em;
        font-weight: 600;
      }
      .btn-add-domain:hover {
        background: #1d4ed8;
      }
      .domain-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 12px;
      }
      .domain-tag {
        background: #eff6ff;
        color: #1e40af;
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 0.85em;
        display: flex;
        align-items: center;
        gap: 8px;
        border: 1px solid #bfdbfe;
      }
      .domain-tag i {
        cursor: pointer;
        color: #ef4444;
      }
      .domain-tag i:hover {
        color: #dc2626;
      }

      .btn-group {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        padding-top: 24px;
        border-top: 1px solid #e5e7eb;
      }
      .btn {
        padding: 11px 24px;
        border-radius: 8px;
        font-size: 0.9em;
        font-weight: 600;
        cursor: pointer;
        border: none;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.2s;
      }
      .btn-primary {
        background: #2563eb;
        color: white;
      }
      .btn-primary:hover {
        background: #1d4ed8;
      }
      .btn-primary:disabled {
        background: #9ca3af;
        cursor: not-allowed;
      }
      .btn-secondary {
        background: white;
        color: #374151;
        border: 1.5px solid #e5e7eb;
      }
      .btn-secondary:hover {
        background: #f9fafb;
      }

      .alert {
        padding: 14px 16px;
        border-radius: 8px;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .alert-info {
        background: #eff6ff;
        border: 1px solid #bfdbfe;
        color: #1e40af;
      }
      .alert-success {
        background: #d1fae5;
        border: 1px solid #a7f3d0;
        color: #065f46;
      }
      .alert i {
        font-size: 1.1em;
      }

      /* Mobile responsive */
      @media (max-width: 968px) {
        .main-content {
          margin-left: 0;
          padding-top: 60px;
        }
        .main-content.expanded {
          margin-left: 0;
        }
        .agents-grid {
          grid-template-columns: 1fr;
        }
      }

      @media (max-width: 640px) {
        .content-area {
          padding: 16px;
        }
        .step-indicator {
          flex-direction: column;
          gap: 12px;
        }
        .step-indicator::before {
          display: none;
        }
        .btn-group {
          flex-direction: column;
        }
        .btn {
          width: 100%;
          justify-content: center;
        }
      }
      .loading {
        padding: 40px;
        text-align: center;
        color: #6b7280;
        font-style: italic;
      }

      .error {
        padding: 40px;
        text-align: center;
        color: #ef4444;
        background: #fee2e2;
        border-radius: 8px;
        border: 1px solid #fca5a5;
      }
      .btn-danger {
        background: #ef4444 !important;
        color: white;
      }
      .btn-danger:hover {
        background: #dc2626 !important;
      }

      .status-active {
        color: #059669;
        font-weight: 600;
      }
      .status-inactive {
        color: #6b7280;
        font-weight: 500;
      }
      .summary-domain-tag {
        background: #eff6ff;
        color: #1e40af;
        padding: 4px 10px;
        border-radius: 16px;
        font-size: 0.8em;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        border: 1px solid #bfdbfe;
      }

      .summary-domain-tag i {
        cursor: pointer;
        color: #ef4444;
        font-size: 0.8em;
        transition: all 0.2s;
      }

      .summary-domain-tag i:hover {
        color: #dc2626;
        transform: scale(1.1);
      }

      #summaryDomainTags {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        padding: 8px 0;
      }
      .btn-warning {
        background: #f59e0b !important;
        color: white;
      }
      .btn-warning:hover {
        background: #d97706 !important;
      }
    </style>
  </head>
  <body>
    <div class="dashboard-container">
      <!-- Sidebar will be loaded here -->
      <div id="sidebarContainer"></div>

      <main class="main-content" id="mainContent">
        <!-- Header will be loaded here -->
        <div id="headerContainer"></div>

        <div class="content-area">
          <div class="breadcrumb">
            <a href="../dashboard.html"><i class="fas fa-home"></i></a>
            <span>/</span>
            <a href="file-policies.html">Policies</a>
            <span>/</span>
            <span>Assign Policy</span>
          </div>

          <div class="page-header">
            <div class="page-title-section">
              <div class="page-icon"><i class="fas fa-user-shield"></i></div>
              <div class="page-title-text">
                <h1>Assign Policy to Agents</h1>
                <p class="page-subtitle">
                  Select agents and assign protection policies
                </p>
              </div>
            </div>
          </div>

          <div class="assign-container">
            <div class="step-indicator">
              <div class="step active" data-step="1">
                <div class="step-circle">1</div>
                <div class="step-label">Choose Agent</div>
              </div>
              <div class="step" data-step="2">
                <div class="step-circle">2</div>
                <div class="step-label">Policy Type</div>
              </div>
              <div class="step" data-step="3">
                <div class="step-circle">3</div>
                <div class="step-label">Select Policy</div>
              </div>
              <div class="step" data-step="4">
                <div class="step-circle">4</div>
                <div class="step-label">Review & Apply</div>
              </div>
            </div>

            <!-- STEP 1: Choose Agent -->
            <div id="step1">
              <div class="section">
                <div class="section-title">Step 1: Choose Agent</div>
                <div class="section-desc">
                  Select the agents you want to assign a policy to
                </div>

                <div class="search-box">
                  <i class="fas fa-search"></i>
                  <input
                    type="text"
                    class="search-input"
                    placeholder="Search agents by name, user, or IP..."
                    id="agentSearch"
                  />
                </div>

                <div class="selected-count" id="selectedCount">
                  <i class="fas fa-check-circle"></i>
                  <span>0 agents selected</span>
                </div>

                <div class="agents-grid" id="agentsGrid">
                  <!-- Agent cards will be dynamically generated -->
                </div>

                <div class="alert alert-info">
                  <i class="fas fa-info-circle"></i>
                  <span>Select at least one agent to continue</span>
                </div>
              </div>
            </div>

            <!-- STEP 2: Policy Type -->
            <div id="step2" style="display: none">
              <div class="section">
                <div class="section-title">Step 2: Select Policy Type</div>
                <div class="section-desc">
                  Choose the type of policy you want to assign
                </div>

                <div class="form-group">
                  <label class="form-label">Policy Type</label>
                  <select class="form-select" id="policyType">
                    <option value="">-- Select Policy Type --</option>
                    <option value="network">Network Policy</option>
                    <option value="file">File Protection</option>
                    <option value="usb">USB</option>
                    <option value="ocr">OCR</option>
                  </select>
                </div>

                <div class="alert alert-info">
                  <i class="fas fa-info-circle"></i>
                  <span
                    >Different policy types provide different protection
                    mechanisms</span
                  >
                </div>
              </div>
            </div>

            <!-- STEP 3: Select Policy -->
            <div id="step3" style="display: none">
              <div class="section">
                <div class="section-title">Step 3: Select Policy</div>
                <div class="section-desc">
                  Choose the specific policy to assign
                </div>

                <div class="form-group">
                  <label class="form-label">Available Policies</label>
                  <select class="form-select" id="policySelect" disabled>
                    <option value="">-- Select a policy type first --</option>
                  </select>
                </div>

                <!-- DNS Domain Input (for Network Policy) -->
                <div id="dnsInputContainer" style="display: none">
                  <div class="domain-input-container">
                    <label class="form-label">Block Domains</label>
                    <div class="domain-input-group">
                      <input
                        type="text"
                        class="domain-input"
                        id="domainInput"
                        placeholder="Enter domain (e.g., www.example.com)"
                      />
                      <button class="btn-add-domain" onclick="addDomain()">
                        <i class="fas fa-plus"></i> Add
                      </button>
                    </div>
                    <div class="domain-tags" id="domainTags">
                      <!-- Domain tags will appear here -->
                    </div>
                  </div>
                </div>

                <!-- // USB Type Selection -->
                <!-- <div id="usbTypeContainer" style="display: none">
                  <div class="form-group">
                    <label class="form-label">USB Policy Mode</label>
                    <select class="form-select" id="usbType">
                      <option value="block">Block</option>
                      <option value="monitor">Monitor</option>
                    </select>
                  </div>
                </div> -->

                <!-- File Protection Info -->
                <div id="fileProtectionInfo" style="display: none">
                  <div class="alert alert-info">
                    <i class="fas fa-shield-alt"></i>
                    <span
                      >File Protection policy will block unauthorized file
                      transfers</span
                    >
                  </div>
                </div>

                <!-- OCR Info -->
                <div id="ocrInfo" style="display: none">
                  <div class="alert alert-info">
                    <i class="fas fa-eye"></i>
                    <span
                      >OCR policy will scan and analyze text in images and
                      documents</span
                    >
                  </div>
                </div>
              </div>
            </div>

            <!-- STEP 4: Review & Apply -->
            <div id="step4" style="display: none">
              <div class="section">
                <div class="section-title">Step 4: Review & Apply</div>
                <div class="section-desc">
                  Verify the policy assignment before applying
                </div>

                <div class="summary-box">
                  <div class="summary-row">
                    <span class="summary-label">Agents Selected</span>
                    <span class="summary-value" id="summaryAgentCount">0</span>
                  </div>

                  <div class="summary-row">
                    <span class="summary-label">Policy Type</span>
                    <span class="summary-value" id="summaryPolicyType">-</span>
                  </div>

                  <div class="summary-row">
                    <span class="summary-label">Policy Name</span>
                    <span class="summary-value" id="summaryPolicyName">-</span>
                  </div>

                  <!-- DNS Domains Summary with Remove Buttons -->
                  <div id="summaryDomainsContainer" style="display: none">
                    <div
                      class="summary-row"
                      style="border-bottom: none; padding-bottom: 5px"
                    >
                      <span class="summary-label">Blocked Domains</span>
                      <span
                        class="summary-value"
                        style="display: flex; align-items: center; gap: 10px"
                      >
                        <span id="summaryDomainsCount">0</span> domains
                      </span>
                    </div>
                    <div
                      class="domain-tags"
                      id="summaryDomainTags"
                      style="
                        margin-top: 5px;
                        margin-bottom: 10px;
                        padding-left: 20px;
                      "
                    >
                      <!-- Domain tags with remove buttons will appear here -->
                    </div>
                  </div>

                  <div
                    class="summary-row"
                    id="summaryUsbRow"
                    style="display: none"
                  >
                    <span class="summary-label">USB Mode</span>
                    <span class="summary-value" id="summaryUsbMode">-</span>
                  </div>
                </div>

                <div class="alert alert-success" style="margin-top: 20px">
                  <i class="fas fa-check-circle"></i>
                  <span
                    >The policy will be applied to all selected agents within 5
                    minutes.</span
                  >
                </div>
              </div>
            </div>

            <div class="btn-group">
              <button
                class="btn btn-secondary"
                onclick="previousStep()"
                id="prevBtn"
                style="display: none"
              >
                <i class="fas fa-arrow-left"></i><span>Previous</span>
              </button>
              <button
                class="btn btn-secondary"
                onclick="window.location.href = 'file-policies.html'"
              >
                <i class="fas fa-times"></i><span>Cancel</span>
              </button>
              <button class="btn btn-primary" onclick="nextStep()" id="nextBtn">
                <span>Next</span><i class="fas fa-arrow-right"></i>
              </button>
              <button
                class="btn btn-primary"
                onclick="applyPolicy()"
                id="applyBtn"
                style="display: none"
              >
                <i class="fas fa-check"></i><span>Apply Policy</span>
              </button>
            </div>
          </div>
        </div>
      </main>
    </div>

    <script>
      // Check login status
      async function checkAuth() {
        try {
          const response = await fetch("/api/auth/check", {
            credentials: "include",
          });

          if (!response.ok) {
            throw new Error("Not authenticated");
          }

          const result = await response.json();

          if (!result.success) {
            window.location.href = "index.html";
          }
        } catch (err) {
          window.location.href = "index.html";
        }
      }

      async function callApi(path, options = {}) {
        const defaultOptions = {
          method: "GET",
          credentials: "include",
          headers: { "Content-Type": "application/json" },
        };
        const opts = { ...defaultOptions, ...options };

        try {
          const response = await fetch(path, opts);
          const text = await response.text();

          let json;
          try {
            json = text ? JSON.parse(text) : null;
          } catch (e) {
            throw new Error("Invalid JSON response from server.");
          }

          if (!response.ok) {
            const message =
              json && json.message
                ? json.message
                : `HTTP ${response.status}: ${response.statusText}`;
            throw new Error(message);
          }
          return json;
        } catch (error) {
          console.error(`API call to ${path} failed:`, error);
          throw error;
        }
      }

      // Load components function
      async function loadComponent(url, containerId) {
        try {
          const response = await fetch(url);
          const html = await response.text();
          const container = document.getElementById(containerId);
          if (container) {
            container.innerHTML = html;
            const scripts = container.querySelectorAll("script");
            scripts.forEach((script) => {
              const newScript = document.createElement("script");
              if (script.src) {
                newScript.src = script.src;
              } else {
                newScript.textContent = script.textContent;
              }
              document.body
                .appendChild(newScript)
                .parentNode.removeChild(newScript);
            });
          }
        } catch (error) {
          console.error("Error loading component:", error);
        }
      }

      // Load sidebar and header
      document.addEventListener("DOMContentLoaded", function () {
        loadComponent("sidebar.html", "sidebarContainer");
        loadComponent("page-header.html", "headerContainer");
        checkAuth();
        // Initial load of all data
        Promise.all([initializeAgentCards(), fetchAgentSimpleDetails()])
          .then(() => {
            console.log("All agents loaded successfully");
            startStatusRefresh();
          })
          .catch((error) => {
            console.error("Error loading initial data:", error);
          });

        setTimeout(adjustHeaderPosition, 100);
      });

      function adjustHeaderPosition() {
        const sidebar = document.getElementById("sidebar");
        const header = document.querySelector(".top-header");

        if (sidebar && header) {
          if (sidebar.classList.contains("collapsed")) {
            header.style.left = "70px";
          } else {
            header.style.left = "240px";
          }
        }
      }

      let selectedAgents = new Set();
      let agentsBasicData = {}; // Store agent basic info (from /api/admin/agents)
      let agentsCapabilities = {}; // Store agent capabilities (from /api/admin/agents/{id}/capabilities)
      let currentStep = 1;
      let selectedPolicyType = "";
      let selectedPolicy = "";
      let blockedDomains = [];
      //   let usbMode = "block";
      let isEditingExistingPolicy = false;
      let statusRefreshInterval;

      function startStatusRefresh() {
        if (statusRefreshInterval) {
          clearInterval(statusRefreshInterval);
        }

        // Refresh agent status every 30 seconds
        statusRefreshInterval = setInterval(async () => {
          console.log("Refreshing agent status...");
          await refreshAllAgents();
        }, 10000);
      }

      async function refreshAllAgents() {
        try {
          // Fetch fresh agent data
          const response = await fetch("/api/admin/agents", {
            headers: {
              "Content-Type": "application/json",
            },
            credentials: "include",
          });

          if (!response.ok) {
            throw new Error("Failed to fetch agents");
          }

          const result = await response.json();

          if (result.success && result.data) {
            const agents = result.data;

            // Update agentsBasicData with fresh data
            agents.forEach((agent) => {
              agentsBasicData[agent.id] = agent;
            });

            // Refresh the agent cards UI
            await initializeAgentCards();
          }
        } catch (error) {
          console.error("Error refreshing agents:", error);
        }
      }

      async function initializeAgentCards() {
        const agentsGrid = document.getElementById("agentsGrid");
        if (!agentsGrid) return;

        agentsGrid.innerHTML = '<div class="loading">Loading agents...</div>';

        try {
          // Fetch agents from API
          const response = await fetch("/api/admin/agents", {
            headers: {
              "Content-Type": "application/json",
            },
          });

          if (!response.ok) {
            throw new Error("Failed to fetch agents");
          }

          const result = await response.json();

          if (!result.success || !result.data) {
            throw new Error(result.message || "No agents found");
          }

          const agents = result.data;
          agentsGrid.innerHTML = "";

          agents.forEach((agent) => {
            const agentCard = document.createElement("div");
            agentCard.className = "agent-card";
            agentCard.dataset.id = agent.id;
            agentCard.onclick = () => toggleAgent(agent.id);

            agentCard.innerHTML = `
                <div class="agent-card-header">
                    <input type="checkbox" class="agent-checkbox" ${selectedAgents.has(agent.id) ? "checked" : ""}>
                    <div class="agent-name"> ${agent.username}</div>
                     <span class="agent-status ${isAgentOnline(agent) ? "status-online" : "status-offline"}">
                        ${isAgentOnline(agent) ? "ONLINE" : "OFFLINE"}
                    </span>
                </div>
                <div class="agent-info">
                    <span><i class="fas fa-user"></i> ${agent.hostname || agent.username}</span>\
                    <span><i class="fas fa-id-badge"></i> ${agent.id}</span>
                </div>
                <div class="agent-info">
                    <span><i class="fab fa-${getOSIcon(agent.osType)}"></i> ${agent.osType || "Unknown OS"}</span>
                    <span><i class="fas fa-network-wired"></i> ${agent.ipAddress || "N/A"}</span>
                </div>
            `;

            function isAgentOnline(agent) {
              // Check agentRuntimeState from the API response
              if (
                agent.agentRuntimeState &&
                agent.agentRuntimeState.toUpperCase() === "ONLINE"
              ) {
                return true;
              }

              // Fallback: Check last heartbeat if agentRuntimeState is not available
              if (agent.lastHeartbeat) {
                const lastHeartbeat = new Date(agent.lastHeartbeat).getTime();
                const now = new Date();
                const diffMinutes = Math.floor(
                  (now - lastHeartbeat) / (1000),
                );
                return diffMinutes <= 10; // Consider online if heartbeat within 5 minutes
              }

              return false;
            }

            agentsGrid.appendChild(agentCard);

            if (selectedAgents.has(agent.id)) {
              agentCard.classList.add("selected");
              agentCard.querySelector(".agent-checkbox").checked = true;
            }
          });
        } catch (error) {
          console.error("Error loading agents:", error);
          agentsGrid.innerHTML = `<div class="error">Error loading agents: ${error.message}</div>`;
        }

        updateSelectedCount();
      }

      function getOSIcon(os) {
        if (!os) return "desktop"; // Handle undefined/null

        const osLower = os.toLowerCase();
        if (osLower.includes("windows")) return "windows";
        if (osLower.includes("macos") || osLower.includes("mac"))
          return "apple";
        if (osLower.includes("ubuntu") || osLower.includes("linux"))
          return "linux";
        return "desktop";
      }

      async function toggleAgent(agentId) {
        if (selectedAgents.has(agentId)) {
          selectedAgents.delete(agentId);
          delete agentsCapabilities[agentId];
        } else {
          selectedAgents.add(agentId);
          // Fetch agent capabilities if not already fetched
          if (!agentsCapabilities[agentId]) {
            try {
              await fetchAgentDetails(agentId);
              if (selectedPolicy === "NETWORK_DNS_BLOCK") {
                const capabilities = agentsCapabilities[agentId];
                if (capabilities && capabilities.NETWORK) {
                  const policy = capabilities.NETWORK.find(
                    (p) => p.code === selectedPolicy,
                  );
                  if (policy && policy.isActive) {
                    isEditingExistingPolicy = true;
                  }
                }
              }
            } catch (error) {
              console.error(
                `Failed to fetch capabilities for agent ${agentId}:`,
                error,
              );
              // Still allow selection even if capabilities fail
              agentsCapabilities[agentId] = {};
            }
          }
        }

        const agentCard = document.querySelector(
          `.agent-card[data-id="${agentId}"]`,
        );
        if (agentCard) {
          agentCard.classList.toggle("selected");
          const checkbox = agentCard.querySelector(".agent-checkbox");
          if (checkbox) {
            checkbox.checked = selectedAgents.has(agentId);
          }
        }

        updateSelectedCount();

        // Update policy types based on selected agents
        if (selectedAgents.size > 0) {
          updatePolicyTypes();
        }
      }

      async function fetchAgentDetails(agentId) {
        try {
          const response = await fetch(
            `/api/admin/agents/${agentId}/capabilities`,
            {
              headers: {
                "Content-Type": "application/json",
              },
              credentials: "include",
            },
          );

          if (!response.ok) {
            throw new Error(
              `HTTP ${response.status}: Failed to fetch capabilities`,
            );
          }

          const result = await response.json();
          console.log(`Agent ${agentId} capabilities:`, result); // Debug log

          if (result.success && result.data) {
            // Store capabilities - result.data should be an object with category keys
            agentsCapabilities[agentId] = result.data;
          } else {
            throw new Error(result.message || "Failed to load capabilities");
          }
        } catch (error) {
          console.error(
            `Error fetching capabilities for agent ${agentId}:`,
            error,
          );
          agentsCapabilities[agentId] = {}; // Store empty object if error
          throw error;
        }
      }

      async function fetchAgentSimpleDetails() {
        try {
          const response = await fetch("/api/admin/agents", {
            headers: {
              "Content-Type": "application/json",
            },
            credentials: "include",
          });

          if (!response.ok) throw new Error("Failed to fetch agents");

          const result = await response.json();
          if (result.success && result.data) {
            // Store agent basic info
            result.data.forEach((agent) => {
              agentsBasicData[agent.id] = agent;
            });
          }
        } catch (error) {
          console.error("Error fetching agents:", error);
        }
      }
      async function updatePolicyTypes() {
        if (selectedAgents.size === 0) {
          const policyTypeSelect = document.getElementById("policyType");
          policyTypeSelect.innerHTML =
            '<option value="">-- Select Policy Type --</option>';
          selectedPolicyType = "";
          updatePolicySelect();
          return;
        }

        // Get common categories across all selected agents
        let commonCategories = null;

        for (const agentId of selectedAgents) {
          const capabilities = agentsCapabilities[agentId];

          if (capabilities && Object.keys(capabilities).length > 0) {
            const agentCategories = Object.keys(capabilities);

            if (commonCategories === null) {
              commonCategories = new Set(agentCategories);
            } else {
              // Keep only categories that exist in both sets
              commonCategories = new Set(
                [...commonCategories].filter((cat) =>
                  agentCategories.includes(cat),
                ),
              );
            }
          } else {
            // If agent has no capabilities data, clear everything
            commonCategories = new Set();
            break;
          }
        }

        // Update policy type dropdown
        const policyTypeSelect = document.getElementById("policyType");
        const currentValue = policyTypeSelect.value;

        // Clear existing options
        policyTypeSelect.innerHTML =
          '<option value="">-- Select Policy Type --</option>';

        if (commonCategories && commonCategories.size > 0) {
          // Simply use the category keys from API response
          const sortedCategories = Array.from(commonCategories).sort();

          sortedCategories.forEach((category) => {
            const option = document.createElement("option");
            option.value = category;
            option.textContent = category; // Use the exact key from API
            policyTypeSelect.appendChild(option);
          });

          // Restore previous selection if still valid
          if (currentValue && commonCategories.has(currentValue)) {
            policyTypeSelect.value = currentValue;
            selectedPolicyType = currentValue;
          } else {
            selectedPolicyType = "";
          }
        } else {
          selectedPolicyType = "";
        }

        updatePolicySelect();
      }

      function updateSelectedCount() {
        const count = selectedAgents.size;
        const selectedCountElement = document.getElementById("selectedCount");
        if (selectedCountElement) {
          selectedCountElement.innerHTML = `
                    <i class="fas fa-check-circle"></i>
                    <span>${count} agent${count !== 1 ? "s" : ""} selected</span>
                `;
        }
      }

      // Policy Type change handler
      document.addEventListener("change", function (e) {
        if (e.target && e.target.id === "policyType") {
          selectedPolicyType = e.target.value;
          updatePolicySelect();
        }

        if (e.target && e.target.id === "policySelect") {
          selectedPolicy = e.target.value;
          updatePolicyOptions();
        }
      });

      function updatePolicySelect() {
        const policySelect = document.getElementById("policySelect");
        if (!policySelect) return;

        policySelect.innerHTML =
          '<option value="">-- Select Policy --</option>';

        if (selectedPolicyType && selectedAgents.size > 0) {
          // Get policies common to all selected agents for this category
          let commonPolicies = null;
          let policyStatusMap = new Map(); // Track if policy is already applied
          for (const agentId of selectedAgents) {
            const capabilities = agentsCapabilities[agentId];

            if (capabilities && capabilities[selectedPolicyType]) {
              const agentPolicies = capabilities[selectedPolicyType];

              // agentPolicies should be an array
              if (!Array.isArray(agentPolicies)) {
                console.error(
                  `Agent ${agentId}: Expected array for ${selectedPolicyType}, got:`,
                  agentPolicies,
                );
                commonPolicies = new Map();
                break;
              }

              if (commonPolicies === null) {
                commonPolicies = new Map();
                agentPolicies.forEach((policy) => {
                  if (policy && policy.code) {
                    commonPolicies.set(policy.code, policy);
                    // Initialize status map
                    policyStatusMap.set(policy.code, {
                      [agentId]: policy.isActive || false,
                    });
                  }
                });
              } else {
                // Keep only policies that exist in this agent
                const agentPolicyCodes = new Set(
                  agentPolicies.map((p) => p?.code).filter((code) => code),
                );

                // Update policy status for this agent
                agentPolicies.forEach((policy) => {
                  if (
                    policy &&
                    policy.code &&
                    policyStatusMap.has(policy.code)
                  ) {
                    policyStatusMap.get(policy.code)[agentId] =
                      policy.isActive || false;
                  }
                });

                commonPolicies = new Map(
                  [...commonPolicies].filter(([code, policy]) =>
                    agentPolicyCodes.has(code),
                  ),
                );
              }
            } else {
              // If agent doesn't have this category, clear everything
              commonPolicies = new Map();
              break;
            }
          }

          if (commonPolicies && commonPolicies.size > 0) {
            policySelect.disabled = false;

            // Sort policies by name for better UX
            const sortedPolicies = Array.from(commonPolicies.values())
              .filter((policy) => policy && policy.name)
              .sort((a, b) => a.name.localeCompare(b.name));

            sortedPolicies.forEach((policy) => {
              const option = document.createElement("option");
              option.value = policy.code;

              // Check if policy is already applied to all selected agents
              const statusInfo = policyStatusMap.get(policy.code);
              let appliedCount = 0;
              if (statusInfo) {
                appliedCount = Object.values(statusInfo).filter(
                  (isActive) => isActive,
                ).length;
              }

              let statusText = "";
              if (appliedCount === selectedAgents.size) {
                statusText = " (Applied to all)";
              } else if (appliedCount > 0) {
                statusText = ` (Applied to ${appliedCount}/${selectedAgents.size})`;
              }

              option.textContent = policy.name + statusText;
              option.title = policy.description || "";
              option.dataset.isApplied = appliedCount === selectedAgents.size;

              policySelect.appendChild(option);
            });

            if (sortedPolicies.length > 0) {
              policySelect.value = sortedPolicies[0].code;
              selectedPolicy = sortedPolicies[0].code;
              updatePolicyAppliedStatus();
            }
          } else {
            policySelect.disabled = true;
            policySelect.innerHTML =
              '<option value="">No common policies available</option>';
            selectedPolicy = "";
          }
        } else {
          policySelect.disabled = true;
          policySelect.innerHTML =
            '<option value="">-- Select a policy type first --</option>';
          selectedPolicy = "";
        }

        updatePolicyOptions();
      }
      function updatePolicyAppliedStatus() {
        const policySelect = document.getElementById("policySelect");
        const selectedOption = policySelect.options[policySelect.selectedIndex];
        const isApplied = selectedOption
          ? selectedOption.dataset.isApplied === "true"
          : false;

        // Update next button text based on status
        const nextBtn = document.getElementById("nextBtn");
        const applyBtn = document.getElementById("applyBtn");

        if (currentStep === 3 && isApplied) {
          nextBtn.innerHTML =
            '<span>Next</span><i class="fas fa-arrow-right"></i>';
        }
      }
      function updatePolicyOptions() {
        const dnsContainer = document.getElementById("dnsInputContainer");
        const fileInfo = document.getElementById("fileProtectionInfo");
        const ocrInfo = document.getElementById("ocrInfo");

        if (dnsContainer) dnsContainer.style.display = "none";
        if (fileInfo) fileInfo.style.display = "none";
        if (ocrInfo) ocrInfo.style.display = "none";

        if (!selectedPolicy || !selectedPolicyType) return;

        // Show relevant options based on actual policy code
        if (selectedPolicy === "NETWORK_DNS_BLOCK") {
          if (dnsContainer) dnsContainer.style.display = "block";

          // Try to load existing domains if any
          if (selectedAgents.size === 1) {
            const agentId = Array.from(selectedAgents)[0];
            const capabilities = agentsCapabilities[agentId];
            if (capabilities && capabilities.NETWORK) {
              const policy = capabilities.NETWORK.find(
                (p) => p.code === selectedPolicy,
              );
              if (policy && policy.policyData && policy.policyData !== "null") {
                try {
                  const data = JSON.parse(policy.policyData);
                  if (data.domains && Array.isArray(data.domains)) {
                    blockedDomains = data.domains;
                    isEditingExistingPolicy = true;
                    console.log("Loaded domains:", blockedDomains);
                  } else {
                    blockedDomains = [];
                    isEditingExistingPolicy = false;
                    console.log("Loaded domains:", blockedDomains); // Debug
                  }
                } catch (e) {
                  console.error("Error parsing policy data:", e);
                  blockedDomains = [];
                  isEditingExistingPolicy = false;
                }
              }
            } else {
              // For new assignment, start with empty domains
              blockedDomains = [];
              //   renderDomainTags();
              isEditingExistingPolicy = false;
            }
          } else {
            blockedDomains = [];
            isEditingExistingPolicy = false;
          }
          // ALWAYS render domain tags
          renderDomainTags();
        }
        // Don't hardcode USB mode - let it come from the policy itself
        // else if (selectedPolicyType === "USB") {
        // //   document.getElementById("usbTypeContainer").style.display = "block";

        //   // Try to get USB mode from the actual policy
        //   if (selectedAgents.size > 0) {
        //     const firstAgentId = Array.from(selectedAgents)[0];
        //     const capabilities = agentsCapabilities[firstAgentId];
        //     if (capabilities && capabilities.USB) {
        //       const policy = capabilities.USB.find(
        //         (p) => p.code === selectedPolicy,
        //       );
        //       if (policy) {
        //         // Extract USB mode from policy name or description
        //         if (policy.name.includes("Block")) {
        //           usbMode = "block";
        //         } else if (policy.name.includes("Monitor")) {
        //           usbMode = "monitor";
        //         }
        //       }
        //     }
        //   }

        //   const usbTypeSelect = document.getElementById("usbType");
        //   if (usbTypeSelect) {
        //     usbTypeSelect.value = usbMode;
        //   }
        // }
        // Show info based on policy type
        else if (selectedPolicyType === "FILE") {
          document.getElementById("fileProtectionInfo").style.display = "block";
        } else if (selectedPolicyType === "SECURITY_MONITOR") {
          document.getElementById("ocrInfo").style.display = "block";
        }
      }

      function addDomain() {
        const domainInput = document.getElementById("domainInput");
        let domain = domainInput.value.trim();

        if (!domain) {
          alert("Please enter a domain name");
          return;
        }

        // Clean the domain - remove http://, https://, trailing slashes
        domain = domain.replace(/^https?:\/\//, "");
        domain = domain.replace(/\/$/, "");

        // Convert to lowercase for comparison
        const domainLower = domain.toLowerCase();
        const exists = blockedDomains.some(
          (d) => d.toLowerCase() === domainLower,
        );

        if (exists) {
          alert("Domain already added");
          return;
        }
        blockedDomains.push(domain); // Keep original case for display
        domainInput.value = "";

        renderDomainTags();

        // Also update summary if we're in step 4
        if (currentStep === 4) {
          renderSummaryDomainTags();
          const summaryDomainsCount = document.getElementById(
            "summaryDomainsCount",
          );
          if (summaryDomainsCount) {
            summaryDomainsCount.textContent = blockedDomains.length;
          }
        }
      }

      function renderDomainTags() {
        const domainTags = document.getElementById("domainTags");
        if (!domainTags) return;

        domainTags.innerHTML = "";

        blockedDomains.forEach((domain, index) => {
          const tag = document.createElement("div");
          tag.className = "domain-tag";
          tag.innerHTML = `
                    <span>${domain}</span>
                    <i class="fas fa-times" onclick="removeDomain(${index})"></i>
                `;
          domainTags.appendChild(tag);
        });
      }

      function removeDomain(index) {
        blockedDomains.splice(index, 1);
        renderDomainTags();
      }

      function nextStep() {
        // Validation for each step
        if (currentStep === 1 && selectedAgents.size === 0) {
          alert("Please select at least one agent");
          return;
        }

        if (currentStep === 2 && !selectedPolicyType) {
          alert("Please select a policy type");
          return;
        }

        if (currentStep === 3) {
          if (!selectedPolicy) {
            alert("Please select a policy");
            return;
          }

          // Fix: Use uppercase 'NETWORK' to match API response
          if (
            selectedPolicyType === "NETWORK" &&
            selectedPolicy === "NETWORK_DNS_BLOCK" &&
            blockedDomains.length === 0
          ) {
            alert("Please add at least one domain to block");
            return;
          }
        }

        currentStep++;
        updateStepDisplay();
      }

      function previousStep() {
        currentStep--;
        updateStepDisplay();
      }

      function updateStepDisplay() {
        // Hide all steps
        document.getElementById("step1").style.display = "none";
        document.getElementById("step2").style.display = "none";
        document.getElementById("step3").style.display = "none";
        document.getElementById("step4").style.display = "none";

        // Show current step
        document.getElementById(`step${currentStep}`).style.display = "block";

        // Update step indicators
        document.querySelectorAll(".step").forEach((step, index) => {
          step.classList.remove("active", "completed");
          if (index + 1 < currentStep) {
            step.classList.add("completed");
            step.querySelector(".step-circle").innerHTML =
              '<i class="fas fa-check"></i>';
          } else if (index + 1 === currentStep) {
            step.classList.add("active");
            step.querySelector(".step-circle").textContent = index + 1;
          } else {
            step.querySelector(".step-circle").textContent = index + 1;
          }
        });

        // Update button visibility
        document.getElementById("prevBtn").style.display =
          currentStep > 1 ? "flex" : "none";
        document.getElementById("nextBtn").style.display =
          currentStep < 4 ? "flex" : "none";
        document.getElementById("applyBtn").style.display =
          currentStep === 4 ? "flex" : "none";

        // Update summary on step 4
        if (currentStep === 4) {
          updateSummary();
        }
      }

      function updateSummary() {
        document.getElementById("summaryAgentCount").textContent =
          selectedAgents.size;

        // Use the actual selectedPolicyType
        document.getElementById("summaryPolicyType").textContent =
          selectedPolicyType || "-";

        // Find the policy object from agentsCapabilities
        let policyName = "-";
        let policyCode = "-";
        let isAlreadyApplied = false;
        let appliedCount = 0;

        if (selectedPolicy && selectedPolicyType && selectedAgents.size > 0) {
          const firstAgentId = Array.from(selectedAgents)[0];
          const capabilities = agentsCapabilities[firstAgentId];
          if (capabilities && capabilities[selectedPolicyType]) {
            const policy = capabilities[selectedPolicyType].find(
              (p) => p.code === selectedPolicy,
            );
            if (policy) {
              policyName = policy.name;
              policyCode = policy.code;

              appliedCount = 0;

              // Check if policy is already applied to all agents
              let allApplied = true;
              for (const agentId of selectedAgents) {
                const agentCapabilities = agentsCapabilities[agentId];
                const agentPolicy =
                  agentCapabilities &&
                  agentCapabilities[selectedPolicyType]?.find(
                    (p) => p.code === selectedPolicy,
                  );
                if (agentPolicy && agentPolicy.isActive) {
                  appliedCount++;
                }
              }
              isAlreadyApplied = appliedCount === selectedAgents.size;
            }
          }
        }

        document.getElementById("summaryPolicyName").textContent = policyName;

        // Update apply button based on status
        const applyBtn = document.getElementById("applyBtn");
        if (isAlreadyApplied) {
          applyBtn.innerHTML =
            '<i class="fas fa-times"></i><span>Remove Policy</span>';
          applyBtn.classList.remove("btn-primary");
          applyBtn.classList.add("btn-danger");
          applyBtn.style.background = "#ef4444";
        } else if (appliedCount < selectedAgents.size) {
          // Some agents have this policy, some don't
          applyBtn.innerHTML =
            '<i class="fas fa-sync"></i><span>Update Policy</span>';
          applyBtn.classList.remove("btn-danger");
          applyBtn.classList.add("btn-warning");
          applyBtn.style.background = "#f59e0b";
        } else {
          // All agents have this policy
          applyBtn.innerHTML =
            '<i class="fas fa-times"></i><span>Remove Policy</span>';
          applyBtn.classList.remove("btn-primary");
          applyBtn.classList.add("btn-danger");
          applyBtn.style.background = "#ef4444";
        }

        // Update alert message
        const alertBox = document.querySelector(".alert.alert-success");
        if (alertBox) {
          if (isAlreadyApplied) {
            alertBox.innerHTML =
              '<i class="fas fa-info-circle"></i><span>This policy is already applied to all selected agents. Click "Remove Policy" to deactivate it.</span>';
            alertBox.className = "alert alert-info";
          } else if (appliedCount > 0) {
            alertBox.innerHTML = `<i class="fas fa-info-circle"></i><span>This policy is applied to ${appliedCount}/${selectedAgents.size} selected agents. Click "Update Policy" to apply to all.</span>`;
            alertBox.className = "alert alert-warning";
            alertBox.style.background = "#fff3cd";
            alertBox.style.borderColor = "#ffeeba";
            alertBox.style.color = "#856404";
          } else {
            alertBox.innerHTML =
              '<i class="fas fa-check-circle"></i><span>The policy will be applied to all selected agents within 5 minutes.</span>';
            alertBox.className = "alert alert-success";
            alertBox.style.background = "#d1fae5";
            alertBox.style.borderColor = "#a7f3d0";
            alertBox.style.color = "#065f46";
          }
        }

        // Show/hide conditional summary rows
        // Show/hide conditional summary rows - FIXED: Using summaryDomainsContainer instead of summaryDomainsRow
        const domainsContainer = document.getElementById(
          "summaryDomainsContainer",
        );
        const usbRow = document.getElementById("summaryUsbRow");

        if (selectedPolicy === "NETWORK_DNS_BLOCK") {
          if (blockedDomains.length > 0) {
            domainsContainer.style.display = "block";
            document.getElementById("summaryDomainsCount").textContent =
              blockedDomains.length;
            renderSummaryDomainTags();
          } else {
            domainsContainer.style.display = "none";
          }
        } else {
          if (domainsContainer) domainsContainer.style.display = "none";
        }

        if (selectedPolicyType === "USB") {
          usbRow.style.display = "flex";
          document.getElementById("summaryUsbMode").textContent = policyName
            .replace("USB", "")
            .trim();
        } else {
          if (usbRow) usbRow.style.display = "none";
        }
      }

      // New function to render domains in summary with remove buttons
      function renderSummaryDomainTags() {
        const domainTags = document.getElementById("summaryDomainTags");
        if (!domainTags) return;

        domainTags.innerHTML = "";
        if (blockedDomains.length === 0) {
          const emptyMsg = document.createElement("div");
          emptyMsg.style.color = "#6b7280";
          emptyMsg.style.fontStyle = "italic";
          emptyMsg.style.padding = "8px";
          emptyMsg.textContent = "No domains added";
          domainTags.appendChild(emptyMsg);
          return;
        }
        blockedDomains.forEach((domain, index) => {
          const tag = document.createElement("span");
          tag.className = "summary-domain-tag";
          tag.innerHTML = `
            <span>${domain}</span>
            <i class="fas fa-times" onclick="removeDomainFromSummary(${index})"></i>
        `;
          domainTags.appendChild(tag);
        });
      }
      // Function to remove domain from summary and update both views
      function removeDomainFromSummary(index) {
        blockedDomains.splice(index, 1);

        // Update both domain tag displays
        renderDomainTags(); // Update step 3 tags
        renderSummaryDomainTags(); // Update step 4 tags

        // Update the domains count in summary
        const summaryDomainsCount = document.getElementById(
          "summaryDomainsCount",
        );
        if (summaryDomainsCount) {
          summaryDomainsCount.textContent = blockedDomains.length;
        }

        // If no domains left, maybe show a warning
        if (blockedDomains.length === 0) {
          const domainsContainer = document.getElementById(
            "summaryDomainsContainer",
          );
          if (domainsContainer) {
            domainsContainer.style.display = "none";
          }

          // If we're in step 4 and no domains, show warning
          if (currentStep === 4) {
            const alertBox = document.querySelector(
              ".alert.alert-info, .alert.alert-success",
            );
            if (alertBox) {
              alertBox.innerHTML =
                '<i class="fas fa-exclamation-triangle"></i><span>No domains to block. Please add domains in Step 3.</span>';
              alertBox.className = "alert alert-warning";
              alertBox.style.background = "#fff3cd";
              alertBox.style.borderColor = "#ffeeba";
              alertBox.style.color = "#856404";
            }
          }
        }
      }

      async function applyPolicy() {
        if (
          selectedAgents.size === 0 ||
          !selectedPolicyType ||
          !selectedPolicy
        ) {
          alert("Please complete all steps");
          return;
        }

        try {
          const agentIds = Array.from(selectedAgents);

          // Count how many agents have this policy active
          let appliedCount = 0;
          for (const agentId of selectedAgents) {
            const capabilities = agentsCapabilities[agentId];
            const policy =
              capabilities &&
              capabilities[selectedPolicyType]?.find(
                (p) => p.code === selectedPolicy,
              );
            if (policy && policy.isActive) {
              appliedCount++;
            }
          }

          const isRemoving = appliedCount === selectedAgents.size;
          const isUpdating =
            appliedCount > 0 && appliedCount < selectedAgents.size;

          // Get policy details
          const firstAgentId = agentIds[0];
          const capabilities = agentsCapabilities[firstAgentId];
          const policyDetails =
            capabilities &&
            capabilities[selectedPolicyType]?.find(
              (p) => p.code === selectedPolicy,
            );

          if (!policyDetails) {
            throw new Error("Could not find policy details");
          }

          const requestBody = {
            agentIds: agentIds,
            policyCode: selectedPolicy,
          };

          // For DNS policy, always include domains when applying or updating
          if (selectedPolicy === "NETWORK_DNS_BLOCK" && !isRemoving) {
            if (blockedDomains.length === 0) {
              alert("Please add at least one domain to block");
              return;
            }
            requestBody.policyData = JSON.stringify({
              domains: blockedDomains,
              ips: [],
            });
          }

          const endpoint = isRemoving
            ? "/api/admin/deactivate-protection"
            : "/api/admin/assign-protection";

          console.log("Applying policy:", requestBody);

          const response = await fetch(endpoint, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            credentials: "include",
            body: JSON.stringify(requestBody),
          });

          const result = await response.json();

          if (result.success) {
            const agentNames = agentIds
              .map((id) => {
                const agent = agentsBasicData[id];
                return agent ? agent.hostname || agent.username : `Agent ${id}`;
              })
              .filter((name) => name);

            let message = ` ${result.message}\n\n`;
            message += `Agents: ${agentNames.join(", ")}\n`;
            message += `Policy: ${policyDetails.name}\n`;

            if (isRemoving) {
              message += `Action: Policy removed\n`;
            } else if (isUpdating) {
              message += `Action: Policy updated and applied to remaining agents\n`;
            } else {
              message += `Action: Policy applied\n`;
              if (
                selectedPolicy === "NETWORK_DNS_BLOCK" &&
                blockedDomains.length > 0
              ) {
                message += `Blocked Domains: ${blockedDomains.join(", ")}\n`;
              }
            }

            alert(message);

            // Refresh agent capabilities data
            for (const agentId of selectedAgents) {
              try {
                await fetchAgentDetails(agentId);
              } catch (error) {
                console.error(`Failed to refresh agent ${agentId}:`, error);
              }
            }

            // If removing policy, reset everything and go back to step 1
            if (isRemoving) {
              // Reset all selections
              selectedAgents.clear();
              selectedPolicyType = "";
              selectedPolicy = "";
              blockedDomains = [];
              isEditingExistingPolicy = false;

              // Reset UI
              currentStep = 1;
              updateStepDisplay();
              await initializeAgentCards();
              updateSelectedCount();

              // Show success message in UI
              const alertBox = document.querySelector(".alert.alert-success");
              if (alertBox) {
                alertBox.innerHTML =
                  '<i class="fas fa-check-circle"></i><span>Policy removed successfully. Select new agents to continue.</span>';
                alertBox.className = "alert alert-success";
              }
            } else {
              // Redirect after successful application/update
              setTimeout(() => {
                window.location.href = "file-policies.html";
              }, 2000);
            }
          } else {
            alert(
              ` Failed to ${isRemoving ? "remove" : "apply"} policy: ${result.message}`,
            );
          }
        } catch (error) {
          console.error("Error applying policy:", error);
          alert(
            ` Error ${isRemoving ? "removing" : "applying"} policy: ${error.message}`,
          );
        }
      }

      // Search functionality - modify to work with dynamic data
      document.addEventListener("input", function (e) {
        if (e.target && e.target.id === "agentSearch") {
          const searchTerm = e.target.value.toLowerCase();
          const agentCards = document.querySelectorAll(".agent-card");

          agentCards.forEach((card) => {
            const text = card.textContent.toLowerCase();
            card.style.display = text.includes(searchTerm) ? "block" : "none";
          });
        }
      });

      // Listen for sidebar toggle events
      window.addEventListener("sidebarToggle", function (event) {
        const mainContent = document.getElementById("mainContent");
        if (mainContent) {
          if (event.detail.collapsed) {
            mainContent.classList.add("expanded");
            mainContent.style.marginLeft = "70px";
          } else {
            mainContent.classList.remove("expanded");
            mainContent.style.marginLeft = "240px";
          }
        }

        adjustHeaderPosition();
      });
    </script>
  </body>
</html>
