<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DLP Admin Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* All previous CSS remains the same */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #4361ee;
      --primary-dark: #3a56d4;
      --secondary: #7209b7;
      --success: #06d6a0;
      --warning: #ffd166;
      --danger: #ef476f;
      --dark: #1e1e2d;
      --light: #f8f9fa;
      --gray: #6c757d;
      --gray-light: #e9ecef;
      --border-radius: 12px;
      --box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      --transition: all 0.3s ease;
    }

    body {
      font-family: "Inter", "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
      min-height: 100vh;
      color: var(--dark);
      line-height: 1.6;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    /* Login Styles */
    .login-container {
      max-width: 420px;
      margin: 100px auto;
      background: white;
      padding: 40px;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      text-align: center;
      position: relative;
      overflow: hidden;
    }

    .login-container::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 4px;
      background: linear-gradient(90deg, var(--primary), var(--secondary));
    }

    .login-container h2 {
      margin-bottom: 30px;
      color: var(--dark);
      font-size: 1.8em;
      font-weight: 700;
    }

    .form-group {
      margin-bottom: 20px;
      text-align: left;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--dark);
    }

    .form-control {
      width: 100%;
      padding: 14px;
      border: 2px solid var(--gray-light);
      border-radius: 8px;
      font-size: 15px;
      transition: var(--transition);
      background: #fcfcfc;
    }

    .form-control:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.15);
      background: white;
    }

    .btn-login {
      width: 100%;
      padding: 14px;
      background: linear-gradient(45deg, var(--primary), var(--secondary));
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    .btn-login:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(67, 97, 238, 0.4);
    }

    .btn-login:active {
      transform: translateY(0);
    }

    .login-error {
      color: var(--danger);
      margin-top: 15px;
      padding: 12px;
      background: rgba(239, 71, 111, 0.1);
      border: 1px solid rgba(239, 71, 111, 0.2);
      border-radius: 6px;
      display: none;
      font-weight: 500;
    }

    /* Dashboard Styles */
    .header {
      background: white;
      padding: 20px 30px;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      margin-bottom: 25px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: relative;
      overflow: hidden;
    }

    .header::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 4px;
      background: linear-gradient(90deg, var(--primary), var(--secondary));
    }

    .header h1 {
      color: var(--dark);
      font-size: 2.2em;
      font-weight: 800;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .header-user {
      display: flex;
      align-items: center;
      gap: 15px;
      font-weight: 600;
      color: var(--dark);
    }

    .nav-tabs {
      display: flex;
      background: white;
      border-radius: var(--border-radius);
      padding: 8px;
      margin-bottom: 25px;
      box-shadow: var(--box-shadow);
      overflow-x: auto;
      position: relative;
    }

    .nav-tab {
      padding: 12px 24px;
      margin: 0 4px;
      border: none;
      background: transparent;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      transition: var(--transition);
      color: var(--gray);
      white-space: nowrap;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .nav-tab.active {
      background: linear-gradient(45deg, var(--primary), var(--secondary));
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(67, 97, 238, 0.4);
    }

    .nav-tab:hover:not(.active) {
      background: var(--light);
      color: var(--dark);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
      animation: fadeIn 0.5s ease;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .card {
      background: white;
      border-radius: var(--border-radius);
      padding: 25px;
      margin-bottom: 25px;
      box-shadow: var(--box-shadow);
      border-left: 4px solid var(--primary);
      transition: var(--transition);
    }

    .card:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
    }

    .card h3 {
      color: var(--dark);
      margin-bottom: 20px;
      font-size: 1.4em;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      padding: 25px;
      border-radius: var(--border-radius);
      text-align: center;
      box-shadow: var(--box-shadow);
      transition: var(--transition);
      position: relative;
      overflow: hidden;
      border-top: 4px solid var(--primary);
    }

    .stat-card::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 4px;
      background: linear-gradient(90deg, var(--primary), var(--secondary));
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.12);
    }

    .stat-number {
      font-size: 2.8em;
      font-weight: 800;
      background: linear-gradient(45deg, var(--primary), var(--secondary));
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 10px;
      line-height: 1;
    }

    .stat-label {
      color: var(--gray);
      font-weight: 600;
      font-size: 0.95em;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      overflow: hidden;
      border-radius: var(--border-radius);
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }

    th,
    td {
      padding: 16px;
      text-align: left;
      border-bottom: 1px solid var(--gray-light);
    }

    th {
      background: linear-gradient(45deg, var(--primary), var(--secondary));
      color: white;
      font-weight: 600;
      position: sticky;
      top: 0;
    }

    tr:hover {
      background: rgba(67, 97, 238, 0.05);
    }

    td a {
      color: var(--primary);
      text-decoration: none;
      font-weight: 600;
      transition: var(--transition);
    }

    td a:hover {
      color: var(--secondary);
      text-decoration: underline;
    }

    .btn {
      padding: 10px 18px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: var(--transition);
      margin: 2px;
      font-size: 0.9em;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-danger {
      background: var(--danger);
      color: white;
    }

    .btn-success {
      background: var(--success);
      color: white;
    }

    .btn-warning {
      background: var(--warning);
      color: var(--dark);
    }

    .btn-info {
      background: #17a2b8;
      color: white;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .btn-sm {
      padding: 8px 14px;
      font-size: 0.85em;
    }

    .btn:active {
      transform: translateY(0);
    }

    .hidden {
      display: none !important;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: var(--gray);
    }

    .notification-badge {
      background: var(--danger);
      color: white;
      border-radius: 50%;
      padding: 4px 8px;
      font-size: 12px;
      font-weight: 700;
      margin-left: 5px;
      min-width: 20px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    /* Policy Wizard */
    .wizard-container {
      margin-top: 20px;
      background: var(--light);
      padding: 20px;
      border-radius: var(--border-radius);
    }

    .wizard-step {
      display: none;
      padding: 20px;
      background: white;
      border-radius: var(--border-radius);
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }

    .wizard-step.active {
      display: block;
      animation: slideIn 0.4s ease;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(20px);
      }

      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .wizard-navigation {
      display: flex;
      justify-content: space-between;
      margin-top: 25px;
    }

    .policies-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }

    .policy-card {
      background: white;
      padding: 20px;
      border-radius: 10px;
      border: 2px solid var(--gray-light);
      transition: var(--transition);
      cursor: pointer;
      position: relative;
    }

    .policy-card:hover {
      border-color: var(--primary);
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
    }

    .policy-card.selected {
      border-color: var(--primary);
      background: rgba(67, 97, 238, 0.05);
      box-shadow: 0 5px 15px rgba(67, 97, 238, 0.15);
    }

    .policy-card h5 {
      margin-bottom: 10px;
      color: var(--dark);
      font-weight: 600;
    }

    .policy-action {
      margin-top: 10px;
      padding: 10px;
      background: var(--light);
      border-radius: 6px;
      font-size: 0.9em;
    }

    /* Alert Styles */
    .alert-filters {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .filter-btn {
      padding: 10px 18px;
      border: 1px solid var(--gray-light);
      border-radius: 20px;
      background: white;
      cursor: pointer;
      transition: var(--transition);
      font-weight: 500;
    }

    .filter-btn.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    .filter-btn:hover:not(.active) {
      background: var(--light);
      border-color: var(--primary);
    }

    .action-buttons {
      display: flex;
      gap: 10px;
      margin-top: 15px;
      flex-wrap: wrap;
    }

    /* Agent Selector */
    .agent-selector {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid var(--gray-light);
      border-radius: var(--border-radius);
      padding: 10px;
      background: white;
    }

    .agent-card {
      background: white;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 10px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: var(--transition);
      border-left: 3px solid var(--primary);
    }

    .agent-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
    }

    .agent-info {
      display: flex;
      flex-direction: column;
    }

    .agent-name {
      font-weight: 600;
      color: var(--dark);
    }

    .agent-status {
      font-size: 0.8em;
      color: var(--gray);
    }

    .status-active {
      color: var(--success);
      font-weight: 600;
    }

    .status-inactive {
      color: var(--danger);
      font-weight: 600;
    }

    .status-suspended {
      color: var(--warning);
      font-weight: 600;
    }

    /* Toast Notifications */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 10000;
    }

    .toast {
      padding: 16px 20px;
      margin-bottom: 10px;
      border-radius: var(--border-radius);
      color: white;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
      animation: slideInRight 0.3s ease;
      display: flex;
      align-items: center;
      gap: 10px;
      max-width: 350px;
    }

    .toast-success {
      background: var(--success);
    }

    .toast-error {
      background: var(--danger);
    }

    .toast-warning {
      background: var(--warning);
      color: var(--dark);
    }

    .toast-info {
      background: var(--primary);
    }

    @keyframes slideInRight {
      from {
        transform: translateX(100%);
        opacity: 0;
      }

      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      backdrop-filter: blur(5px);
    }

    .modal-content {
      background: white;
      padding: 30px;
      border-radius: var(--border-radius);
      width: 90%;
      max-width: 800px;
      max-height: 80vh;
      overflow-y: auto;
      position: relative;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    }

    .modal-close {
      position: absolute;
      top: 15px;
      right: 15px;
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: var(--gray);
      transition: var(--transition);
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-close:hover {
      color: var(--dark);
      background: var(--light);
    }

    /* Alert Items */
    .alert-item {
      background: white;
      border-radius: var(--border-radius);
      padding: 20px;
      margin-bottom: 15px;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
      border-left: 4px solid var(--warning);
      transition: var(--transition);
      animation: slideIn 0.4s ease;
    }

    .alert-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
    }

    .alert-item.critical {
      border-left-color: var(--danger);
      background: rgba(239, 71, 111, 0.03);
    }

    .alert-item.high {
      border-left-color: var(--warning);
    }

    .alert-item.medium {
      border-left-color: #17a2b8;
    }

    .alert-item.low {
      border-left-color: var(--success);
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .container {
        padding: 15px;
      }

      .header {
        flex-direction: column;
        gap: 15px;
        text-align: center;
        padding: 20px;
      }

      .header h1 {
        font-size: 1.8em;
      }

      .nav-tabs {
        flex-wrap: wrap;
        justify-content: center;
      }

      .nav-tab {
        padding: 10px 16px;
        font-size: 0.9em;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }

      .policies-grid {
        grid-template-columns: 1fr;
      }

      .action-buttons {
        flex-direction: column;
      }

      .wizard-navigation {
        flex-direction: column;
        gap: 10px;
      }

      .wizard-navigation button {
        width: 100%;
      }

      table {
        display: block;
        overflow-x: auto;
      }
    }

    /* Custom Scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb {
      background: var(--primary);
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--primary-dark);
    }

    /* Loading Animation */
    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .btn-loading {
      position: relative;
      color: transparent;
    }

    .btn-loading .spinner {
      position: absolute;
      left: 50%;
      top: 50%;
      margin-left: -10px;
      margin-top: -10px;
    }

    /* Empty States */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--gray);
    }

    .empty-state h4 {
      margin-bottom: 10px;
      color: var(--dark);
    }

    /* Status Indicators */
    .status-indicator {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 8px;
    }

    .status-active .status-indicator {
      background: var(--success);
    }

    .status-inactive .status-indicator {
      background: var(--danger);
    }

    .status-suspended .status-indicator {
      background: var(--warning);
    }

    /* Severity Badges */
    .severity-badge {
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 0.75em;
      font-weight: 700;
      text-transform: uppercase;
    }

    .severity-badge.high {
      background: rgba(239, 71, 111, 0.15);
      color: var(--danger);
    }

    .severity-badge.medium {
      background: rgba(255, 209, 102, 0.15);
      color: #b88a00;
    }

    .severity-badge.low {
      background: rgba(6, 214, 160, 0.15);
      color: var(--success);
    }

    /* NEW STYLES FOR AGENT DETAILS MODAL */
    .agent-details-modal {
      max-width: 95%;
      width: 1200px;
      max-height: 90vh;
    }

    .agent-details-tabs {
      display: flex;
      border-bottom: 1px solid var(--gray-light);
      margin-bottom: 20px;
      overflow-x: auto;
    }

    .agent-details-tab {
      padding: 12px 24px;
      border: none;
      background: transparent;
      cursor: pointer;
      font-weight: 600;
      transition: var(--transition);
      color: var(--gray);
      white-space: nowrap;
      border-bottom: 3px solid transparent;
    }

    .agent-details-tab.active {
      color: var(--primary);
      border-bottom-color: var(--primary);
    }

    .agent-details-tab:hover:not(.active) {
      color: var(--dark);
    }

    .agent-details-content {
      display: none;
      min-height: 400px;
    }

    .agent-details-content.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }

    .file-browser {
      border: 1px solid var(--gray-light);
      border-radius: var(--border-radius);
      max-height: 400px;
      overflow-y: auto;
      margin-top: 15px;
    }

    .file-item {
      padding: 10px 15px;
      border-bottom: 1px solid var(--gray-light);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: var(--transition);
    }

    .file-item:hover {
      background: var(--light);
    }

    .file-item.selected {
      background: rgba(67, 97, 238, 0.1);
      border-left: 3px solid var(--primary);
    }

    .file-item:last-child {
      border-bottom: none;
    }

    .file-icon {
      font-size: 1.2em;
    }

    .file-path {
      font-family: monospace;
      font-size: 0.9em;
      color: var(--gray);
    }

    .policy-actions {
      display: flex;
      gap: 10px;
      margin-top: 20px;
      flex-wrap: wrap;
    }

    .file-operations {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 10px;
      margin-top: 15px;
    }

    .operation-checkbox {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px;
      border: 1px solid var(--gray-light);
      border-radius: 6px;
      cursor: pointer;
      transition: var(--transition);
    }

    .operation-checkbox:hover {
      border-color: var(--primary);
    }

    .operation-checkbox.selected {
      background: rgba(67, 97, 238, 0.1);
      border-color: var(--primary);
    }

    .file-path-input {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }

    .file-path-input input {
      flex: 1;
    }

    .policy-type-selector {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }

    .policy-type-btn {
      flex: 1;
      padding: 12px;
      border: 2px solid var(--gray-light);
      border-radius: 8px;
      background: white;
      cursor: pointer;
      transition: var(--transition);
      text-align: center;
      font-weight: 600;
    }

    .policy-type-btn.selected {
      border-color: var(--primary);
      background: rgba(67, 97, 238, 0.1);
    }

    .policy-type-btn.block.selected {
      border-color: var(--danger);
      background: rgba(239, 71, 111, 0.1);
    }

    .policy-type-btn.monitor.selected {
      border-color: var(--warning);
      background: rgba(255, 209, 102, 0.1);
    }

    .log-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }

    .log-table th,
    .log-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid var(--gray-light);
    }

    .log-table th {
      background: var(--light);
      font-weight: 600;
    }

    .log-table tr:hover {
      background: rgba(67, 97, 238, 0.05);
    }

    /* NEW STYLES FOR TIME FILTERS AND PAGINATION */
    .time-filters {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .time-filter-btn {
      padding: 8px 16px;
      border: 1px solid var(--gray-light);
      border-radius: 20px;
      background: white;
      cursor: pointer;
      transition: var(--transition);
      font-weight: 500;
    }

    .time-filter-btn.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      margin-top: 20px;
    }

    .pagination-btn {
      padding: 8px 12px;
      border: 1px solid var(--gray-light);
      background: white;
      cursor: pointer;
      border-radius: 6px;
      transition: var(--transition);
    }

    .pagination-btn.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    .pagination-btn:hover:not(.active) {
      background: var(--light);
    }

    .clear-frontend-btn {
      background: var(--warning);
      color: var(--dark);
    }

    /* Event type badges */
    .event-type-badge {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.7em;
      font-weight: 600;
      text-transform: uppercase;
    }

    .event-type-file {
      background: rgba(67, 97, 238, 0.15);
      color: var(--primary);
    }

    .event-type-web {
      background: rgba(6, 214, 160, 0.15);
      color: var(--success);
    }

    .event-type-usb {
      background: rgba(255, 209, 102, 0.15);
      color: #b88a00;
    }

    .event-type-alert {
      background: rgba(239, 71, 111, 0.15);
      color: var(--danger);
    }

    /* Delete Logs Modal Styles */
    .delete-logs-modal {
      max-width: 500px;
    }

    .date-range-selector {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin: 20px 0;
    }

    .date-input-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .date-input-group label {
      font-weight: 600;
      color: var(--dark);
      font-size: 0.9em;
    }

    .date-input {
      padding: 10px;
      border: 2px solid var(--gray-light);
      border-radius: 6px;
      font-size: 14px;
      transition: var(--transition);
    }

    .date-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.15);
    }

    .delete-summary {
      background: rgba(239, 71, 111, 0.1);
      border: 1px solid rgba(239, 71, 111, 0.2);
      border-radius: 8px;
      padding: 15px;
      margin: 15px 0;
    }

    .delete-summary h4 {
      color: var(--danger);
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .summary-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 5px;
      font-size: 0.9em;
    }

    .summary-item:last-child {
      margin-bottom: 0;
      font-weight: 600;
      border-top: 1px solid rgba(239, 71, 111, 0.2);
      padding-top: 8px;
    }

    .delete-confirmation {
      background: rgba(255, 209, 102, 0.1);
      border: 1px solid rgba(255, 209, 102, 0.3);
      border-radius: 6px;
      padding: 12px;
      margin: 15px 0;
      text-align: center;
    }

    .delete-confirmation input {
      margin-right: 8px;
    }

    .warning-text {
      color: var(--danger);
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
      justify-content: center;
      margin-bottom: 10px;
    }

    .delete-actions {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    .delete-actions .btn {
      flex: 1;
    }

    .btn-delete {
      background: var(--danger);
      color: white;
    }

    .btn-delete:disabled {
      background: var(--gray);
      cursor: not-allowed;
      transform: none !important;
      box-shadow: none !important;
    }

    /* OCR Dashboard Styles */
    .agent-ocr-dashboard {
      padding: 20px;
    }

    .dashboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid var(--gray-light);
    }

    .ocr-toggle-container {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 24px;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: 0.4s;
      border-radius: 24px;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 16px;
      width: 16px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: 0.4s;
      border-radius: 50%;
    }

    input:checked + .slider {
      background-color: var(--success);
    }

    input:checked + .slider:before {
      transform: translateX(26px);
    }

    .toggle-label {
      font-weight: 600;
      color: var(--dark);
    }

    /* Enhanced OCR Dashboard Styles - OPTIMIZED */
    .ocr-dashboard-container {
      padding: 20px;
    }

    /* Dashboard Header with Stats */
    .dashboard-stats-bar {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-bottom: 25px;
    }

    .stat-card-compact {
      background: white;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      transition: transform 0.2s ease;
      border-top: 4px solid var(--primary);
    }

    .stat-card-compact:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
    }

    .stat-number-compact {
      font-size: 2em;
      font-weight: 800;
      line-height: 1;
      margin-bottom: 5px;
      background: linear-gradient(45deg, var(--primary), var(--secondary));
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .stat-label-compact {
      font-size: 0.85em;
      color: var(--gray);
      font-weight: 600;
    }

    /* Threat Sections Grid */
    .threat-sections-grid {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    /* Threat Section Cards */
    .threat-section {
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 3px 15px rgba(0, 0, 0, 0.08);
      border: 1px solid var(--gray-light);
    }

    .threat-section-header {
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: white;
      font-weight: 600;
      font-size: 0.95em;
    }

    .threat-section-header.high {
      background: linear-gradient(135deg, var(--danger), #d62d52);
    }

    .threat-section-header.medium {
      background: linear-gradient(135deg, var(--warning), #e6b800);
    }

    .threat-section-header.low {
      background: linear-gradient(135deg, var(--success), #05b88a);
    }

    .threat-section-header.inactive {
      background: linear-gradient(135deg, var(--gray), #5a6268);
    }

    .threat-section-count {
      background: rgba(255, 255, 255, 0.2);
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.9em;
    }

    /* Agent Grid - Enhanced */
    .agents-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 15px;
      padding: 20px;
    }

    /* Agent Card - Enhanced */
    .agent-card-enhanced {
      background: white;
      border-radius: 10px;
      padding: 18px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
      transition: all 0.3s ease;
      cursor: pointer;
      border: 1px solid var(--gray-light);
      position: relative;
      overflow: hidden;
    }

    .agent-card-enhanced:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
      border-color: var(--primary);
    }

    .agent-card-enhanced.high-threat {
      border-left: 4px solid var(--danger);
    }

    .agent-card-enhanced.medium-threat {
      border-left: 4px solid var(--warning);
    }

    .agent-card-enhanced.low-threat {
      border-left: 4px solid var(--success);
    }

    .agent-card-enhanced.inactive {
      border-left: 4px solid var(--gray);
      opacity: 0.7;
    }

    .agent-card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
    }

    .agent-name {
      font-weight: 700;
      font-size: 1.1em;
      color: var(--dark);
    }

    .agent-status-badge {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.75em;
      font-weight: 600;
      text-transform: uppercase;
    }

    .status-active {
      background: rgba(6, 214, 160, 0.1);
      color: var(--success);
    }

    .status-inactive {
/*<!--      background: rgba(108, 117, 125, 0.1);--> */
      color: var(--gray);
    }

    /* Agent Stats Row */
    .agent-stats-row {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-bottom: 12px;
    }

    .agent-stat-item {
      display: flex;
      flex-direction: column;
    }

    .stat-label-small {
      font-size: 0.8em;
      color: var(--gray);
      margin-bottom: 4px;
    }

    .stat-value {
      font-weight: 600;
      font-size: 0.95em;
    }

    .threat-score-value {
      font-size: 1.2em;
      font-weight: 700;
    }

    .high-threat .threat-score-value {
      color: var(--danger);
    }

    .medium-threat .threat-score-value {
      color: #b88a00;
    }

    .low-threat .threat-score-value {
      color: var(--success);
    }

    /* Agent Footer */
    .agent-card-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-top: 10px;
      border-top: 1px solid var(--gray-light);
      font-size: 0.85em;
    }

    .last-activity {
      color: var(--gray);
      font-style: italic;
    }

    .view-details-btn {
      background: rgba(67, 97, 238, 0.1);
      color: var(--primary);
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .view-details-btn:hover {
      background: rgba(67, 97, 238, 0.2);
    }

    /* Empty State */
    .agents-empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--gray);
    }

    .agents-empty-state h4 {
      margin-bottom: 10px;
      color: var(--dark);
    }

    /* Enhanced Agent Details Modal */
    .agent-ocr-modal {
      max-width: 95%;
      width: 1200px !important;
      max-height: 85vh;
      padding: 25px !important;
    }

    /* Certificate Tabs */
    .certificate-tabs {
      display: flex;
      border-bottom: 2px solid var(--gray-light);
      margin-bottom: 20px;
      overflow-x: auto;
    }

    .cert-tab {
      padding: 12px 24px;
      border: none;
      background: transparent;
      cursor: pointer;
      font-weight: 600;
      transition: var(--transition);
      color: var(--gray);
      white-space: nowrap;
      border-bottom: 3px solid transparent;
      margin-bottom: -2px;
    }

    .cert-tab.active {
      color: var(--primary);
      border-bottom-color: var(--primary);
    }

    .cert-tab:hover:not(.active) {
      color: var(--dark);
    }

    .cert-tab-content {
      display: none;
      animation: fadeIn 0.3s ease;
    }

    .cert-tab-content.active {
      display: block;
    }

    /* Certificate Summary - FIXED */
    .certificate-summary {
      background: white;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 25px;
      border: 2px solid;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    .certificate-summary.high {
      border-color: var(--danger);
      background: linear-gradient(to right, rgba(239, 71, 111, 0.03), white);
    }

    .certificate-summary.medium {
      border-color: var(--warning);
      background: linear-gradient(to right, rgba(255, 209, 102, 0.03), white);
    }

    .certificate-summary.low {
      border-color: var(--success);
      background: linear-gradient(to right, rgba(6, 214, 160, 0.03), white);
    }

    .certificate-header {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-bottom: 20px;
    }

    .certificate-emoji {
      font-size: 3em;
    }

    .certificate-title h4 {
      margin: 0;
      font-size: 1.5em;
      color: var(--dark);
    }

    .certificate-subtitle {
      color: var(--gray);
      font-size: 0.9em;
      margin-top: 5px;
    }

    .certificate-details-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 25px;
    }

    .certificate-details-grid > div {
      background: var(--light);
      padding: 15px;
      border-radius: 8px;
      border: 1px solid var(--gray-light);
    }

    .certificate-details-grid strong {
      display: block;
      margin-bottom: 5px;
      color: var(--dark);
      font-size: 0.9em;
    }

    /* Quick Stats Grid */
    .quick-stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .quick-stat-card {
      background: white;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
      border: 1px solid var(--gray-light);
    }

    /* Violations List */
    .violations-list-container {
      max-height: 400px;
      overflow-y: auto;
      padding-right: 10px;
    }

    .violation-item-enhanced {
      background: white;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 10px;
      border-left: 4px solid;
      transition: transform 0.2s ease;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .violation-item-enhanced:hover {
      transform: translateX(5px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .violation-item-enhanced.high {
      border-left-color: var(--danger);
      background: rgba(239, 71, 111, 0.03);
    }

    .violation-item-enhanced.medium {
      border-left-color: var(--warning);
      background: rgba(255, 209, 102, 0.03);
    }

    .violation-item-enhanced.low {
      border-left-color: var(--success);
      background: rgba(6, 214, 160, 0.03);
    }

    .violation-header-enhanced {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .rule-badge {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.8em;
      font-weight: 600;
      text-transform: uppercase;
    }

    .rule-badge.password {
      background: rgba(239, 71, 111, 0.1);
      color: var(--danger);
    }

    .rule-badge.ssn {
      background: rgba(255, 209, 102, 0.1);
      color: #b88a00;
    }

    .rule-badge.aadhaar {
      background: rgba(52, 152, 219, 0.1);
      color: #3498db;
    }

    .rule-badge.credit-card {
      background: rgba(155, 89, 182, 0.1);
      color: #9b59b6;
    }

    .violation-timestamp {
      font-size: 0.85em;
      color: var(--gray);
    }

    .matched-text {
      background: rgba(0, 0, 0, 0.02);
      padding: 12px;
      border-radius: 6px;
      margin: 10px 0;
      font-family: "Courier New", monospace;
      font-size: 0.9em;
      line-height: 1.4;
      border: 1px solid var(--gray-light);
      word-break: break-word;
    }

    .confidence-bars {
      display: flex;
      gap: 20px;
      font-size: 0.85em;
    }

    .confidence-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .confidence-value {
      font-weight: 600;
      font-size: 1.1em;
    }

    .confidence-value.high {
      color: var(--danger);
    }

    .confidence-value.medium {
      color: var(--warning);
    }

    .confidence-value.low {
      color: var(--success);
    }

    /* OCR Extractions List */
    .ocr-extractions-list {
      max-height: 400px;
      overflow-y: auto;
      padding-right: 10px;
    }

    .extraction-item {
      background: white;
      border-radius: 8px;
      padding: 18px;
      margin-bottom: 15px;
      border-left: 4px solid var(--primary);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .extraction-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .extraction-meta {
      display: flex;
      gap: 15px;
      font-size: 0.85em;
      color: var(--gray);
      margin-bottom: 12px;
      flex-wrap: wrap;
    }

    .meta-badge {
      background: rgba(67, 97, 238, 0.1);
      color: var(--primary);
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 0.8em;
      font-weight: 600;
    }

    .extracted-text-preview {
      background: var(--light);
      padding: 15px;
      border-radius: 6px;
      font-size: 0.9em;
      line-height: 1.5;
      max-height: 120px;
      overflow-y: auto;
      border: 1px solid var(--gray-light);
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    }

    /* Certificate History */
    .certificate-history-list {
      max-height: 500px;
      overflow-y: auto;
      padding-right: 10px;
    }

    .certificate-history-item {
      background: white;
      border-radius: 10px;
      padding: 18px;
      margin-bottom: 12px;
      border-left: 4px solid;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .certificate-history-item.high {
      border-left-color: var(--danger);
    }

    .certificate-history-item.medium {
      border-left-color: var(--warning);
    }

    .certificate-history-item.low {
      border-left-color: var(--success);
    }

    .certificate-history-item .btn-sm {
      padding: 6px 12px;
      font-size: 0.85em;
    }

    /* Modal Sections */
    .modal-sections {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-top: 25px;
    }

    .modal-section {
      background: white;
      border-radius: 12px;
      padding: 20px;
      min-height: 300px;
      border: 1px solid var(--gray-light);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .modal-section h4 {
      margin-bottom: 15px;
      color: var(--dark);
      font-size: 1.2em;
      padding-bottom: 10px;
      border-bottom: 2px solid var(--gray-light);
    }

    /* Risk Analysis */
    .risk-analysis {
      background: rgba(0, 0, 0, 0.02);
      padding: 18px;
      border-radius: 8px;
      margin-top: 15px;
      font-size: 0.95em;
      line-height: 1.6;
      border: 1px solid var(--gray-light);
    }

    .risk-analysis.full-width {
      grid-column: 1 / -1;
    }

    .risk-analysis strong {
      color: var(--dark);
      display: block;
      margin-bottom: 8px;
    }

    .risk-analysis ul {
      margin-top: 8px;
      padding-left: 20px;
    }

    .risk-analysis li {
      margin-bottom: 5px;
      line-height: 1.4;
    }

    /* Responsive Design */
    @media (max-width: 1200px) {
      .agent-ocr-modal {
        width: 95% !important;
        max-width: 95% !important;
      }

      .certificate-details-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 992px) {
      .modal-sections {
        grid-template-columns: 1fr;
      }

      .agents-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 768px) {
      .agent-ocr-modal {
        width: 98% !important;
        padding: 15px !important;
      }

      .certificate-details-grid {
        grid-template-columns: 1fr;
      }

      .agents-grid {
        grid-template-columns: 1fr;
      }

      .dashboard-stats-bar {
        grid-template-columns: repeat(2, 1fr);
      }

      .modal-sections {
        gap: 15px;
      }

      .modal-section {
        min-height: auto;
      }

      .confidence-bars {
        flex-direction: column;
        gap: 10px;
      }

      .extraction-meta {
        gap: 10px;
      }
    }

    @media (max-width: 480px) {
      .certificate-tabs {
        flex-wrap: wrap;
        justify-content: center;
      }

      .cert-tab {
        padding: 10px 16px;
        font-size: 0.9em;
      }

      .certificate-header {
        flex-direction: column;
        text-align: center;
        gap: 10px;
      }

      .certificate-emoji {
        font-size: 2.5em;
      }

      .dashboard-stats-bar {
        grid-template-columns: 1fr;
      }

      .quick-stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    /* Animation for certificate expiry */
    @keyframes pulse {
      0% {
        opacity: 1;
      }
      50% {
        opacity: 0.7;
      }
      100% {
        opacity: 1;
      }
    }

    #certificateExpiryCountdown.warning {
      color: var(--warning);
      animation: pulse 2s infinite;
    }

    #certificateExpiryCountdown.critical {
      color: var(--danger);
      animation: pulse 1s infinite;
      font-weight: 700;
    }
    .status-online {
    color: var(--success);
    font-weight: 600;
}

.status-offline {
    color: var(--danger);
    font-weight: 600;
}

.status-idle {
    color: var(--warning);
    font-weight: 600;
}

.status-locked {
    color: var(--warning);
    font-weight: 600;
}

/* Also update the agent-status-badge styles */
.agent-status-badge.status-online {
    background: rgba(6, 214, 160, 0.1);
    color: var(--success);
}

.agent-status-badge.status-offline {
    background: rgba(108, 117, 125, 0.1);
    color: var(--gray);
}

.agent-status-badge.status-idle {
    background: rgba(255, 209, 102, 0.1);
    color: #b88a00;
}

.agent-status-badge.status-locked {
    background: rgba(255, 209, 102, 0.1);
    color: #b88a00;
}
    /* Online/Offline Indicators */
.online-indicator {
    color: var(--success);
    font-weight: 600;
    font-size: 0.9em;
    margin-left: 5px;
    display: inline-flex;
    align-items: center;
    gap: 4px;
}

.online-indicator::before {
    content: "‚óè";
    font-size: 1.2em;
    animation: pulse-online 2s infinite;
}

.offline-indicator {
    color: var(--danger);
    font-weight: 600;
    font-size: 0.9em;
    margin-left: 5px;
    display: inline-flex;
    align-items: center;
    gap: 4px;
}

.offline-indicator::before {
    content: "‚óè";
    font-size: 1.2em;
}

/* Status Dots in Status Column */
.status-dot {
    display: inline-block;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    margin-right: 8px;
    vertical-align: middle;
}

.status-dot-online {
    background-color: var(--success);
    box-shadow: 0 0 0 2px rgba(6, 214, 160, 0.2);
    animation: pulse-online 2s infinite;
}

.status-dot-offline {
    background-color: var(--danger);
    box-shadow: 0 0 0 2px rgba(239, 71, 111, 0.2);
}

@keyframes pulse-online {
    0% {
        box-shadow: 0 0 0 0 rgba(6, 214, 160, 0.7);
    }
    70% {
        box-shadow: 0 0 0 6px rgba(6, 214, 160, 0);
    }
    100% {
        box-shadow: 0 0 0 0 rgba(6, 214, 160, 0);
    }
}

/* Optional: Highlight the entire row for offline agents */
tr[data-agent-id] .offline-indicator {
    font-weight: 700;
}

/* Tooltip for status indicators */
[title] {
    position: relative;
    cursor: help;
}

[title]:hover::after {
    content: attr(title);
    position: absolute;
    background: var(--dark);
    color: white;
    padding: 6px 10px;
    border-radius: 4px;
    font-size: 12px;
    white-space: nowrap;
    z-index: 1000;
    margin-top: 5px;
    margin-left: 5px;
    pointer-events: none;
}
.threat-score-container {
    display: flex;
    align-items: center;
    gap: 5px;
}

.trend-arrow {
    font-size: 1.2em;
    font-weight: bold;
    display: inline-block;
}

.trend-arrow[style*="red"] {
    animation: pulse-red 2s infinite;
}

.trend-arrow[style*="green"] {
    animation: pulse-green 2s infinite;
}

@keyframes pulse-red {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}

@keyframes pulse-green {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}
    .status-online { background-color: #28a745; color: white; }
.status-offline { background-color: #dc3545; color: white; }
.status-idle { background-color: #ffc107; color: black; }
.status-inactive { background-color: #6c757d; color: white; }
  </style>
</head>

<body>
<!-- Login Screen -->
<div id="loginScreen">
  <div class="login-container">
    <h2>üîê DLP Admin Login</h2>
    <div class="form-group">
      <label for="usernameOrEmail">Username or Email</label>
      <input
              type="text"
              id="usernameOrEmail"
              class="form-control"
              placeholder="Enter username or email"
      />
    </div>
    <div class="form-group">
      <label for="password">Password</label>
      <input
              type="password"
              id="password"
              class="form-control"
              placeholder="Enter password"
      />
    </div>
    <button class="btn-login" id="loginBtn" onclick="adminLogin()">
      <span id="loginBtnText">Login to Dashboard</span>
    </button>
    <div id="loginError" class="login-error"></div>
    <div
            style="
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            font-size: 12px;
            color: #666;
          "
    >
<!--      <strong>Default Credentials:</strong><br />-->
<!--      Username: <code>admin</code><br />-->
<!--      Password: <code>admin123</code>-->
      <p><strong>Default Admin:</strong> admin / admin123 (or admin@dlp.local)</p>
    </div>
  </div>
</div>

<!-- Dashboard -->
<div id="dashboard" class="hidden">
  <div class="container">
    <div class="header">
      <h1>üõ°Ô∏è DLP Admin Dashboard</h1>
      <div class="header-user">
        <span id="adminName"></span>
        <button class="btn btn-danger btn-sm" onclick="logout()">
          <span>üö™ Logout</span>
        </button>
      </div>
    </div>

    <div class="nav-tabs">
      <button class="nav-tab active" onclick="showTab('overview')">
        <span>üìä</span>
        <span>Overview</span>
      </button>
      <button class="nav-tab" onclick="showTab('agents')">
        <span>üë•</span>
        <span>Agents</span>
      </button>
      <button class="nav-tab" onclick="showTab('ocr')">
        <span>üß†</span>
        <span>OCR Dashboard</span>
        <span id="ocrNotificationBadge" class="notification-badge hidden"
        >0</span
        >
      </button>
      <button class="nav-tab" onclick="showTab('alerts')">
        <span>üö®</span>
        <span>Alerts</span>
        <span id="alertBadge" class="notification-badge hidden">0</span>
      </button>
    </div>

    <!-- Overview Tab -->
    <div id="overview" class="tab-content active">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-number" id="totalAgents">0</div>
          <div class="stat-label">Total Agents</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="activeAgents">0</div>
          <div class="stat-label">Active Agents</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="totalPolicies">0</div>
          <div class="stat-label">Total Active Policies</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="pendingAlerts">0</div>
          <div class="stat-label">Pending Alerts</div>
        </div>
      </div>
      <div class="card">
        <h3>üìà Recent Activity</h3>
        <div
                style="
                display: grid;
                grid-template-columns: 1fr 2fr;
                gap: 20px;
                align-items: center;
              "
        >
          <div>
            <h4>Alerts by Severity</h4>
            <canvas id="severityPieChart"></canvas>
          </div>
          <div style="width: 100%">
            <h4>Alerts Last 7 Days</h4>
            <canvas id="alertsBarChart"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- Agents Tab -->
    <div id="agents" class="tab-content">
      <div class="card">
        <h3>üë• Manage Agents</h3>
        <div class="action-buttons">
          <button class="btn btn-primary" onclick="loadAgents()">
            <span>üîÑ</span>
            <span>Refresh Agents</span>
          </button>
<!--          <button class="btn btn-success" onclick="createTestAgent()">-->
<!--            <span>üß™</span>-->
<!--            <span>Create Test Agent</span>-->
<!--          </button>-->
        </div>
        <table>
          <thead>
          <tr>
            <th>ID</th>
            <th>UserName</th>
            <th>Status</th>
            <th>OCR Status</th>
            <th>Last Heartbeat</th>
            <th>Policies (Active/Total)</th>
            <th>Actions</th>
          </tr>
          </thead>
          <tbody id="agentsTable"></tbody>
        </table>
      </div>
    </div>

    <!-- OCR Tab Content -->
    <div id="ocr" class="tab-content">
      <div class="card">
        <div class="dashboard-header">
          <h3>üß† OCR Monitoring Dashboard</h3>
          <div class="action-buttons">
            <div class="ocr-toggle-container">
              <span class="toggle-label">Auto-refresh (5s)</span>
              <label class="switch">
                <input type="checkbox" id="ocrAutoRefresh" checked />
                <span class="slider"></span>
              </label>
            </div>
            <button class="btn btn-primary" onclick="loadOcrDashboard()">
              <span>üîÑ</span>
              <span>Refresh Now</span>
            </button>
          </div>
        </div>

        <div id="ocrDashboardContent">
          <div class="loading">Loading OCR monitoring data...</div>
        </div>
      </div>
    </div>

    <!-- Alerts Tab -->
    <div id="alerts" class="tab-content">
      <div class="card">
        <h3>üö® Security Alerts</h3>
        <div
                class="stats-grid"
                style="
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                margin-bottom: 20px;
              "
        >
          <div class="stat-card">
            <div class="stat-number" id="totalAlerts">0</div>
            <div class="stat-label">Total Alerts</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="usbAlerts">0</div>
            <div class="stat-label">USB Alerts</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="pendingAlertsCount">0</div>
            <div class="stat-label">Pending</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="criticalAlerts">0</div>
            <div class="stat-label">Critical</div>
          </div>
        </div>
      </div>
      <div class="alert-filters">
        <button
                class="filter-btn active"
                onclick="filterAlerts('ALL', this)"
        >
          All Alerts
        </button>
        <button class="filter-btn" onclick="filterAlerts('USB', this)">
          üíæ USB
        </button>
<!--        <button class="filter-btn" onclick="filterAlerts('FILE', this)">-->
<!--          üìÅ File-->
<!--        </button>-->
<!--        <button class="filter-btn" onclick="filterAlerts('NETWORK', this)">-->
<!--          üåê Network-->
<!--        </button>-->
        <button class="filter-btn" onclick="filterAlerts('PENDING', this)">
          ‚è≥ Pending
        </button>
        <button class="filter-btn" onclick="filterAlerts('CRITICAL', this)">
          üî¥ Critical
        </button>
      </div>
      <div class="action-buttons">
        <button class="btn btn-primary" onclick="loadAlerts()">
          <span>üîÑ</span>
          <span>Refresh Alerts</span>
        </button>
<!--        <button class="btn btn-success" onclick="createTestUSBAlert()">-->
<!--          <span>üß™</span>-->
<!--          <span>Test USB Alert</span>-->
<!--        </button>-->
      </div>
      <div id="alertsList">
        <div class="loading">Loading alerts...</div>
      </div>
    </div>
  </div>
</div>

<!-- Toast Container -->
<div id="toastContainer" class="toast-container"></div>

<!-- All modals remain the same -->
<!-- Agent Details Modal -->
<div id="agentDetailsModal" class="modal-overlay hidden">
  <div class="modal-content agent-details-modal">
    <button class="modal-close" onclick="closeAgentDetailsModal()">
      √ó
    </button>
    <h3 id="agentDetailsTitle">Agent Details</h3>

    <div class="agent-details-tabs">
      <button
              class="agent-details-tab active"
              onclick="showAgentTab('policies')"
      >
        Policies
      </button>
<!--      <button-->
<!--              class="agent-details-tab"-->
<!--              onclick="showAgentTab('allHistory')"-->
<!--      >-->
<!--        All History-->
<!--      </button>-->
<!--      <button-->
<!--              class="agent-details-tab"-->
<!--              onclick="showAgentTab('fileEvents')"-->
<!--      >-->
<!--        File Events-->
<!--      </button>-->
<!--      <button-->
<!--              class="agent-details-tab"-->
<!--              onclick="showAgentTab('webHistory')"-->
<!--      >-->
<!--        Web History-->
<!--      </button>-->
<!--      <button-->
<!--              class="agent-details-tab"-->
<!--              onclick="showAgentTab('usbHistory')"-->
<!--      >-->
<!--        USB History-->
<!--      </button>-->
    </div>

    <div id="agentPoliciesTab" class="agent-details-content active">
      <div class="policy-actions">
<!--        <button class="btn btn-primary" onclick="openFilePolicyWizard()">-->
<!--          <span>üìÑ</span>-->
<!--          <span>Create File Policy</span>-->
<!--        </button>-->
<!--        <button class="btn btn-success" onclick="openOtherPolicyWizard()">-->
<!--          <span>üõ°Ô∏è</span>-->
<!--          <span>Assign Other Policy</span>-->
<!--        </button>-->
      </div>
      <div id="agentPoliciesList">
        <div class="loading">Loading policies...</div>
      </div>
    </div>

    <!-- NEW: All History Tab -->
    <div id="agentAllHistoryTab" class="agent-details-content">
      <div class="action-buttons">
        <button class="btn btn-primary" onclick="loadAllHistory()">
          <span>üîÑ</span>
          <span>Refresh All History</span>
        </button>
        <button
                class="btn btn-warning clear-frontend-btn"
                onclick="clearFrontendData('allHistory')"
        >
          <span>üßπ</span>
          <span>Clear Frontend Data</span>
        </button>
        <button class="btn btn-danger" onclick="openDeleteLogsModal('ALL')">
          <span>üóëÔ∏è</span>
          <span>Delete from Database</span>
        </button>
      </div>
      <div class="time-filters">
        <button
                class="time-filter-btn active"
                onclick="filterAllHistory('TODAY', this)"
        >
          Today
        </button>
        <button
                class="time-filter-btn"
                onclick="filterAllHistory('LAST_7_DAYS', this)"
        >
          Last 7 Days
        </button>
        <button
                class="time-filter-btn"
                onclick="filterAllHistory('LAST_30_DAYS', this)"
        >
          Last 30 Days
        </button>
        <button
                class="time-filter-btn"
                onclick="filterAllHistory('ALL', this)"
        >
          All Time
        </button>
      </div>
      <div id="agentAllHistoryList">
        <div class="loading">Loading all history...</div>
      </div>
      <div id="allHistoryPagination" class="pagination hidden"></div>
    </div>

    <div id="agentFileEventsTab" class="agent-details-content">
      <div class="action-buttons">
        <button class="btn btn-primary" onclick="loadFileEvents()">
          <span>üîÑ</span>
          <span>Refresh File Events</span>
        </button>
        <button
                class="btn btn-warning clear-frontend-btn"
                onclick="clearFrontendData('fileEvents')"
        >
          <span>üßπ</span>
          <span>Clear Frontend Data</span>
        </button>
        <button
                class="btn btn-danger"
                onclick="openDeleteLogsModal('FILE_EVENTS')"
        >
          <span>üóëÔ∏è</span>
          <span>Delete from Database</span>
        </button>
      </div>
      <div class="time-filters">
        <button
                class="time-filter-btn active"
                onclick="filterFileEvents('TODAY', this)"
        >
          Today
        </button>
        <button
                class="time-filter-btn"
                onclick="filterFileEvents('LAST_7_DAYS', this)"
        >
          Last 7 Days
        </button>
        <button
                class="time-filter-btn"
                onclick="filterFileEvents('LAST_30_DAYS', this)"
        >
          Last 30 Days
        </button>
        <button
                class="time-filter-btn"
                onclick="filterFileEvents('ALL', this)"
        >
          All Time
        </button>
      </div>
      <div id="agentFileEventsList">
        <div class="loading">Loading file events...</div>
      </div>
      <div id="fileEventsPagination" class="pagination hidden"></div>
    </div>

    <div id="agentWebHistoryTab" class="agent-details-content">
      <div class="action-buttons">
        <button class="btn btn-primary" onclick="loadWebHistory()">
          <span>üîÑ</span>
          <span>Refresh Web History</span>
        </button>
        <button
                class="btn btn-warning clear-frontend-btn"
                onclick="clearFrontendData('webHistory')"
        >
          <span>üßπ</span>
          <span>Clear Frontend Data</span>
        </button>
        <button
                class="btn btn-danger"
                onclick="openDeleteLogsModal('WEB_HISTORY')"
        >
          <span>üóëÔ∏è</span>
          <span>Delete from Database</span>
        </button>
      </div>
      <div class="time-filters">
        <button
                class="time-filter-btn active"
                onclick="filterWebHistory('TODAY', this)"
        >
          Today
        </button>
        <button
                class="time-filter-btn"
                onclick="filterWebHistory('LAST_7_DAYS', this)"
        >
          Last 7 Days
        </button>
        <button
                class="time-filter-btn"
                onclick="filterWebHistory('LAST_30_DAYS', this)"
        >
          Last 30 Days
        </button>
        <button
                class="time-filter-btn"
                onclick="filterWebHistory('ALL', this)"
        >
          All Time
        </button>
      </div>
      <div id="agentWebHistoryList">
        <div class="loading">Loading web history...</div>
      </div>
      <div id="webHistoryPagination" class="pagination hidden"></div>
    </div>

    <div id="agentUsbHistoryTab" class="agent-details-content">
      <div class="action-buttons">
        <button class="btn btn-primary" onclick="loadUsbHistory()">
          <span>üîÑ</span>
          <span>Refresh USB History</span>
        </button>
        <button
                class="btn btn-warning clear-frontend-btn"
                onclick="clearFrontendData('usbHistory')"
        >
          <span>üßπ</span>
          <span>Clear Frontend Data</span>
        </button>
        <button
                class="btn btn-danger"
                onclick="openDeleteLogsModal('USB_HISTORY')"
        >
          <span>üóëÔ∏è</span>
          <span>Delete from Database</span>
        </button>
      </div>
      <div class="time-filters">
        <button
                class="time-filter-btn active"
                onclick="filterUsbHistory('TODAY', this)"
        >
          Today
        </button>
        <button
                class="time-filter-btn"
                onclick="filterUsbHistory('LAST_7_DAYS', this)"
        >
          Last 7 Days
        </button>
        <button
                class="time-filter-btn"
                onclick="filterUsbHistory('LAST_30_DAYS', this)"
        >
          Last 30 Days
        </button>
        <button
                class="time-filter-btn"
                onclick="filterUsbHistory('ALL', this)"
        >
          All Time
        </button>
      </div>
      <div id="agentUsbHistoryList">
        <div class="loading">Loading USB history...</div>
      </div>
      <div id="usbHistoryPagination" class="pagination hidden"></div>
    </div>
  </div>
</div>

<!-- File Policy Wizard Modal -->
<div id="filePolicyWizardModal" class="modal-overlay hidden">
  <div class="modal-content">
    <button class="modal-close" onclick="closeFilePolicyWizard()">√ó</button>
    <h3>Create File Protection Policy</h3>

    <div class="wizard-container">
      <div id="fileWizardStep1" class="wizard-step active">
        <h4>Step 1: Select File Operations</h4>
        <p>Choose which file operations you want to monitor or block:</p>

        <div class="file-operations">
          <label
                  class="operation-checkbox"
                  onclick="toggleOperation(this, 'READ')"
          >
            <input type="checkbox" name="fileOperations" value="READ" />
            <span>üìñ Read</span>
          </label>
          <label
                  class="operation-checkbox"
                  onclick="toggleOperation(this, 'WRITE')"
          >
            <input type="checkbox" name="fileOperations" value="WRITE" />
            <span>‚úèÔ∏è Write</span>
          </label>
          <label
                  class="operation-checkbox"
                  onclick="toggleOperation(this, 'CREATE')"
          >
            <input type="checkbox" name="fileOperations" value="CREATE" />
            <span>üìÑ Create</span>
          </label>
          <label
                  class="operation-checkbox"
                  onclick="toggleOperation(this, 'DELETE')"
          >
            <input type="checkbox" name="fileOperations" value="DELETE" />
            <span>üóëÔ∏è Delete</span>
          </label>
          <label
                  class="operation-checkbox"
                  onclick="toggleOperation(this, 'RENAME')"
          >
            <input type="checkbox" name="fileOperations" value="RENAME" />
            <span>üìù Rename</span>
          </label>
          <label
                  class="operation-checkbox"
                  onclick="toggleOperation(this, 'COPY')"
          >
            <input type="checkbox" name="fileOperations" value="COPY" />
            <span>üìã Copy</span>
          </label>
          <label
                  class="operation-checkbox"
                  onclick="toggleOperation(this, 'MOVE')"
          >
            <input type="checkbox" name="fileOperations" value="MOVE" />
            <span>üì¶ Move</span>
          </label>
          <label
                  class="operation-checkbox"
                  onclick="toggleOperation(this, 'EXECUTE')"
          >
            <input type="checkbox" name="fileOperations" value="EXECUTE" />
            <span>‚ö° Execute</span>
          </label>
        </div>
      </div>

      <div id="fileWizardStep2" class="wizard-step">
        <h4>Step 2: Select Files or Folders</h4>
        <p>
          Browse the agent's file system and select files or folders to
          protect:
        </p>

        <div class="file-path-input">
          <input
                  type="text"
                  id="filePathInput"
                  class="form-control"
                  placeholder="Enter file path or browse below"
          />
          <button class="btn btn-primary" onclick="browseFilePath()">
            Browse
          </button>
        </div>

        <div id="fileBrowser" class="file-browser">
          <div class="loading">Loading file system...</div>
        </div>

        <div id="selectedFilesList" style="margin-top: 15px">
          <h5>Selected Files/Folders:</h5>
          <div id="selectedFilesContainer"></div>
        </div>
      </div>

      <div id="fileWizardStep3" class="wizard-step">
        <h4>Step 3: Choose Policy Type</h4>
        <p>Select whether to block or monitor the selected operations:</p>

        <div class="policy-type-selector">
          <div
                  class="policy-type-btn block"
                  onclick="selectPolicyType('BLOCK', this)"
          >
            <span>üö´</span>
            <span>Block</span>
            <p style="font-size: 0.8em; margin-top: 5px">
              Prevent the selected operations
            </p>
          </div>
          <div
                  class="policy-type-btn monitor"
                  onclick="selectPolicyType('MONITOR', this)"
          >
            <span>üëÅÔ∏è</span>
            <span>Monitor</span>
            <p style="font-size: 0.8em; margin-top: 5px">
              Log the selected operations
            </p>
          </div>
        </div>
      </div>

      <div class="wizard-navigation">
        <button
                class="btn btn-warning"
                onclick="previousFileWizardStep()"
                id="filePrevBtn"
                style="display: none"
        >
          <span>‚Üê</span>
          <span>Previous</span>
        </button>
        <button
                class="btn btn-primary"
                onclick="nextFileWizardStep()"
                id="fileNextBtn"
        >
          <span>Next</span>
          <span>‚Üí</span>
        </button>
        <button
                class="btn btn-success"
                onclick="createFilePolicy()"
                id="fileApplyBtn"
                style="display: none"
        >
          <span>‚úÖ</span>
          <span>Create Policy</span>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Other Policy Wizard Modal -->
<div id="otherPolicyWizardModal" class="modal-overlay hidden">
  <div class="modal-content">
    <button class="modal-close" onclick="closeOtherPolicyWizard()">
      √ó
    </button>
    <h3>Assign Protection Policy</h3>

    <div class="wizard-container">
      <div id="otherWizardStep1" class="wizard-step active">
        <h4>Step 1: Select Protection Category</h4>
        <div class="form-group">
          <label>Choose protection type:</label>
          <select
                  id="protectionCategory"
                  class="form-control"
                  onchange="loadProtectionPolicies()"
          >
            <option value="">Select Category</option>
            <option value="USB">üíæ USB Protection</option>
            <option value="NETWORK">üåê Network Protection</option>
          </select>
        </div>
      </div>

      <div id="otherWizardStep2" class="wizard-step">
        <h4>Step 2: Select Protection Policy</h4>
        <div class="form-group">
          <label>Choose a specific policy to assign:</label>
          <div id="policiesContainer" class="policies-grid">
            <div class="loading">Select a category first...</div>
          </div>
        </div>
      </div>

      <div id="otherWizardStep3" class="wizard-step">
        <h4>Step 3: Configure Policy (if needed)</h4>
        <div id="policyConfigContainer">
          <!-- DNS Policy Configuration -->
          <div id="dnsPolicyConfig" class="hidden">
            <div class="form-group">
              <label for="dns-block-list-domains"
              >Domains to Block (comma-separated):</label
              >
              <textarea
                      id="dns-block-list-domains"
                      class="form-control"
                      placeholder="e.g., dropbox.com, mega.nz"
              ></textarea>
            </div>
            <div class="form-group">
              <label for="dns-block-list-ips"
              >IPs to Block (comma-separated):</label
              >
              <textarea
                      id="dns-block-list-ips"
                      class="form-control"
                      placeholder="e.g., 8.8.8.8, 1.1.1.1"
              ></textarea>
            </div>
          </div>
        </div>
      </div>

      <div class="wizard-navigation">
        <button
                class="btn btn-warning"
                onclick="previousOtherWizardStep()"
                id="otherPrevBtn"
                style="display: none"
        >
          <span>‚Üê</span>
          <span>Previous</span>
        </button>
        <button
                class="btn btn-primary"
                onclick="nextOtherWizardStep()"
                id="otherNextBtn"
        >
          <span>Next</span>
          <span>‚Üí</span>
        </button>
        <button
                class="btn btn-success"
                onclick="assignOtherPolicy()"
                id="otherApplyBtn"
                style="display: none"
        >
          <span>‚úÖ</span>
          <span>Assign Policy</span>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Blocklist Editor Modal -->
<div id="blocklistEditorModal" class="modal-overlay hidden">
  <div class="modal-content">
    <button class="modal-close" onclick="closeBlocklistEditor()">√ó</button>
    <h3 id="blocklistEditorTitle">Edit Blocklist</h3>

    <input type="hidden" id="editListAgentId" />
    <input type="hidden" id="editListPolicyCode" />
    <input type="hidden" id="editListHostname" />

    <div class="form-group">
      <label>Currently Blocked Entries:</label>
      <div
              id="currentBlocklistContainer"
              class="agent-selector"
              style="min-height: 100px"
      ></div>
    </div>

    <div class="form-group">
      <label for="newBlocklistItems"
      >Add New Entries (comma-separated):</label
      >
      <textarea
              id="newBlocklistItems"
              class="form-control"
              placeholder="e.g., new-domain.com, 1.2.3.4"
      ></textarea>
    </div>

    <button
            class="btn btn-success"
            style="width: 100%"
            onclick="saveBlocklist()"
    >
      <span>üíæ</span>
      <span>Save Changes</span>
    </button>
  </div>
</div>

<!-- Delete Logs Modal -->
<div id="deleteLogsModal" class="modal-overlay hidden">
  <div class="modal-content delete-logs-modal">
    <button class="modal-close" onclick="closeDeleteLogsModal()">√ó</button>
    <h3>üóëÔ∏è Delete History Logs</h3>

    <div class="form-group">
      <label>Select Log Type to Delete:</label>
      <select
              id="deleteLogType"
              class="form-control"
              onchange="updateDeleteSummary()"
      >
        <option value="ALL">All History (Files, Web, USB, Alerts)</option>
        <option value="FILE_EVENTS">File Events Only</option>
        <option value="WEB_HISTORY">Web History Only</option>
        <option value="USB_HISTORY">USB History Only</option>
        <option value="ALERTS">Alerts Only</option>
      </select>
    </div>

    <div class="date-range-selector">
      <div class="date-input-group">
        <label for="deleteFromDate">From Date:</label>
        <input
                type="date"
                id="deleteFromDate"
                class="date-input"
                onchange="updateDeleteSummary()"
        />
      </div>
      <div class="date-input-group">
        <label for="deleteToDate">To Date:</label>
        <input
                type="date"
                id="deleteToDate"
                class="date-input"
                onchange="updateDeleteSummary()"
        />
      </div>
    </div>

    <div id="deleteSummary" class="delete-summary hidden">
      <h4>‚ö†Ô∏è Delete Summary</h4>
      <div id="summaryContent"></div>
    </div>

    <div class="delete-confirmation">
      <div class="warning-text">
        <span>üö®</span>
        <span>This action cannot be undone!</span>
      </div>
      <label>
        <input
                type="checkbox"
                id="confirmDelete"
                onchange="toggleDeleteButton()"
        />
        I understand this will permanently delete data from the database
      </label>
    </div>

    <div class="delete-actions">
      <button class="btn btn-warning" onclick="closeDeleteLogsModal()">
        <span>‚ùå</span>
        <span>Cancel</span>
      </button>
      <button
              class="btn btn-delete"
              id="deleteLogsBtn"
              disabled
              onclick="deleteLogs()"
      >
        <span>üóëÔ∏è</span>
        <span>Delete Logs</span>
      </button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
<script>
  // --- Global Variables ---
  let currentUser = null;
  let currentAgentId = null;
  let currentAgentHostname = null;
  let currentFileWizardStep = 1;
  let currentOtherWizardStep = 1;
  let selectedFileOperations = [];
  let selectedFiles = [];
  let selectedPolicyType = null;
  let selectedOtherPolicyId = null;
  let allAlerts = [];
  let currentAlertFilter = "ALL";
  let refreshInterval;
  let agentsCache = [];
  let severityPieChart = null;
  let alertsBarChart = null;
  let currentDeleteLogType = "ALL";

  // Variables for pagination and filtering
  let currentFileEventsPage = 1;
  let currentWebHistoryPage = 1;
  let currentUsbHistoryPage = 1;
  let currentAllHistoryPage = 1;
  const ITEMS_PER_PAGE = 10;
  let currentFileEventsFilter = "TODAY";
  let currentWebHistoryFilter = "TODAY";
  let currentUsbHistoryFilter = "TODAY";
  let currentAllHistoryFilter = "TODAY";
  let fileEventsData = [];
  let webHistoryData = [];
  let usbHistoryData = [];
  let allHistoryData = [];
  let stompClient = null;
  let wsConnected = false;
  const wsSubscriptions = new Map(); // agentId -> subscription
  let subscribedAgents = new Set();

  // OCR Dashboard Variables
  let ocrAutoRefreshInterval = null;
  let ocrAutoRefreshEnabled = true;
  let ocrDashboardStats = {
    totalCapableAgents: 0,
    activeOcrAgents: 0,
    highThreatCount: 0,
    totalViolations24h: 0,
    lastUpdated: null,
    summary: null
  };

  // --- OCR Certificates cache ---
  let currentCertificateHistory = [];
  let certificateExpiryTimer = null;

  function unsubscribeAll() {
    try {
      if (stompClient) {
        stompClient.disconnect();
        stompClient = null;
      }
    } catch (e) {
      /* ignore */
    }
  }

  // --- API Abstraction ---
  async function callApi(path, options = {}) {
    const defaultOptions = {
      method: "GET",
      credentials: "include",
      headers: { "Content-Type": "application/json" },
    };
    const opts = { ...defaultOptions, ...options };

    try {
      const response = await fetch(path, opts);
      const text = await response.text();

      let json;
      try {
        json = text ? JSON.parse(text) : null;
      } catch (e) {
        throw new Error("Invalid JSON response from server.");
      }

      if (!response.ok) {
        const message =
          json && json.message
            ? json.message
            : `HTTP ${response.status}: ${response.statusText}`;
        throw new Error(message);
      }
      return json;
    } catch (error) {
      console.error(`API call to ${path} failed:`, error);
      throw error;
    }
  }

  // --- UI Helpers ---
  function showToast(message, type = "info", duration = 3000) {
    const container = document.getElementById("toastContainer");
    const toast = document.createElement("div");
    toast.className = `toast toast-${type}`;

    let icon = "‚ÑπÔ∏è";
    if (type === "success") icon = "‚úÖ";
    else if (type === "error") icon = "‚ùå";
    else if (type === "warning") icon = "‚ö†Ô∏è";

    toast.innerHTML = `<span>${icon}</span><span>${message}</span>`;
    container.appendChild(toast);
    setTimeout(() => toast.remove(), duration);
  }

  // --- Authentication Flow ---
  async function checkAuthStatus() {
    try {
      const result = await callApi("/api/auth/check");
      if (result && result.success) {
        currentUser = result.data;
        showDashboard();
        await loadDashboardData();
      } else {
        showLogin();
      }
    } catch (error) {
      console.warn("Auth check failed, showing login page:", error.message);
      showLogin();
    }
  }

<!--  async function adminLogin() {-->
<!--    const usernameOrEmail  = document.getElementById("usernameOrEmail").value;-->
<!--    const password = document.getElementById("password").value;-->
<!--    const errorDiv = document.getElementById("loginError");-->
<!--    const loginBtn = document.getElementById("loginBtn");-->
<!--    const loginBtnText = document.getElementById("loginBtnText");-->

<!--    errorDiv.style.display = "none";-->
<!--    loginBtn.disabled = true;-->
<!--    loginBtnText.textContent = "Authenticating...";-->

<!--    try {-->
<!--      const result = await callApi("/api/auth/login", {-->
<!--        method: "POST",-->
<!--        body: JSON.stringify({ usernameOrEmail , password }),-->
<!--      });-->
<!--      if (result && result.success) {-->
<!--        currentUser = result.data;-->
<!--        showDashboard();-->
<!--        await loadDashboardData();-->
<!--        showToast("Login successful!", "success");-->
<!--      }-->
<!--    } catch (error) {-->
<!--      errorDiv.textContent = error.message;-->
<!--      errorDiv.style.display = "block";-->
<!--    } finally {-->
<!--      loginBtn.disabled = false;-->
<!--      loginBtnText.textContent = "Login to Dashboard";-->
<!--    }-->
<!--  }-->

<!--  // expose to window-->
<!--  window.adminLogin = adminLogin;-->

async function adminLogin() {
  const usernameOrEmailInput = document.getElementById("usernameOrEmail").value;
  const password = document.getElementById("password").value;
  const errorDiv = document.getElementById("loginError");
  const loginBtn = document.getElementById("loginBtn");
  const loginBtnText = document.getElementById("loginBtnText");

  errorDiv.style.display = "none";
  loginBtn.disabled = true;
  loginBtnText.textContent = "Authenticating...";

  try {
    // Send as usernameOrEmail (let backend handle detection)
    const loginData = { usernameOrEmail: usernameOrEmailInput, password };

    const result = await callApi("/api/auth/login", {
      method: "POST",
      body: JSON.stringify(loginData),
    });

    if (result && result.success) {
      currentUser = result.data;
      showDashboard();
      await loadDashboardData();
      showToast("Login successful!", "success");
    }
  } catch (error) {
    errorDiv.textContent = error.message;
    errorDiv.style.display = "block";
  } finally {
    loginBtn.disabled = false;
    loginBtnText.textContent = "Login to Dashboard";
  }
}

  async function logout() {
    try {
      await callApi("/api/auth/logout", { method: "POST" });
    } finally {
      currentUser = null;
      showLogin();
      showToast("Logged out successfully.", "info");
    }
  }

  function showDashboard() {
    document.getElementById("loginScreen").classList.add("hidden");
    document.getElementById("dashboard").classList.remove("hidden");
    if (currentUser) {
      document.getElementById(
        "adminName"
      ).textContent = `Welcome, ${currentUser.username}`;
    }
    startAutoRefresh();
  }

  function showLogin() {
    document.getElementById("dashboard").classList.add("hidden");
    document.getElementById("loginScreen").classList.remove("hidden");
    stopAutoRefresh();
  }

  // --- Delete History Logs  ---
  function openDeleteLogsModal(logType = "ALL") {
    currentDeleteLogType = logType;

    // Set default dates (last 30 days)
    const today = new Date();
    const thirtyDaysAgo = new Date();
    thirtyDaysAgo.setDate(today.getDate() - 30);
    document.getElementById("deleteFromDate").value = thirtyDaysAgo
      .toISOString()
      .split("T")[0];
    document.getElementById("deleteToDate").value = today
      .toISOString()
      .split("T")[0];
    document.getElementById("deleteLogType").value = logType;
    document.getElementById("confirmDelete").checked = false;
    document.getElementById("deleteLogsBtn").disabled = true;

    // Update summary
    updateDeleteSummary();

    document.getElementById("deleteLogsModal").classList.remove("hidden");
  }

  function closeDeleteLogsModal() {
    document.getElementById("deleteLogsModal").classList.add("hidden");
  }

  async function updateDeleteSummary() {
    const fromDate = document.getElementById("deleteFromDate").value;
    const toDate = document.getElementById("deleteToDate").value;
    const logType = document.getElementById("deleteLogType").value;

    if (!fromDate || !toDate) {
      document.getElementById("deleteSummary").classList.add("hidden");
      return;
    }

    try {
      // Calculate date range for display
      const from = new Date(fromDate);
      const to = new Date(toDate);
      const dayCount = Math.ceil((to - from) / (1000 * 60 * 60 * 24));

      // Get approximate counts from the backend
      const counts = await getLogCounts(fromDate, toDate, logType);

      const summary = document.getElementById("summaryContent");
      summary.innerHTML = `
                <div class="summary-item">
                    <span>Date Range:</span>
                    <span>${from.toLocaleDateString()} to ${to.toLocaleDateString()} (${dayCount} days)</span>
                </div>
                ${
                  logType === "ALL" || logType === "FILE_EVENTS"
                    ? `
                <div class="summary-item">
                    <span>File Events:</span>
                    <span>${counts.fileEvents || 0} records</span>
                </div>
                `
                    : ""
                }
                ${
                  logType === "ALL" || logType === "WEB_HISTORY"
                    ? `
                <div class="summary-item">
                    <span>Web History:</span>
                    <span>${counts.webHistory || 0} records</span>
                </div>
                `
                    : ""
                }
                ${
                  logType === "ALL" || logType === "USB_HISTORY"
                    ? `
                <div class="summary-item">
                    <span>USB History:</span>
                    <span>${counts.usbHistory || 0} records</span>
                </div>
                `
                    : ""
                }
                ${
                  logType === "ALL" || logType === "ALERTS"
                    ? `
                <div class="summary-item">
                    <span>Alerts:</span>
                    <span>${counts.alerts || 0} records</span>
                </div>
                `
                    : ""
                }
                <div class="summary-item">
                    <span>Total to delete:</span>
                    <span style="color: var(--danger); font-weight: 700;">
                        ${counts.total || 0} records
                    </span>
                </div>
            `;

      document.getElementById("deleteSummary").classList.remove("hidden");
    } catch (error) {
      console.error("Error updating delete summary:", error);
      document.getElementById("deleteSummary").classList.add("hidden");
    }
  }

  async function getLogCounts(fromDate, toDate, logType) {
    try {
      const result = await callApi(
        `/api/admin/logs/count?fromDate=${fromDate}&toDate=${toDate}&logType=${logType}&agentId=${
          currentAgentId || ""
        }`
      );
      return result && result.success ? result.data : { total: 0 };
    } catch (error) {
      console.warn("Could not get log counts:", error);
      return { total: "Unknown" };
    }
  }

  function toggleDeleteButton() {
    const confirmCheckbox = document.getElementById("confirmDelete");
    const deleteBtn = document.getElementById("deleteLogsBtn");
    deleteBtn.disabled = !confirmCheckbox.checked;
  }

  async function deleteLogs() {
    const fromDate = document.getElementById("deleteFromDate").value;
    const toDate = document.getElementById("deleteToDate").value;
    const logType = document.getElementById("deleteLogType").value;

    if (!fromDate || !toDate) {
      showToast("Please select both start and end dates.", "warning");
      return;
    }

    if (new Date(fromDate) > new Date(toDate)) {
      showToast("Start date cannot be after end date.", "warning");
      return;
    }

    const confirmMessage = `Are you absolutely sure you want to delete ${logType.toLowerCase()} logs from ${fromDate} to ${toDate}? This action is PERMANENT and cannot be undone!`;

    if (!confirm(confirmMessage)) {
      return;
    }

    try {
      const deleteBtn = document.getElementById("deleteLogsBtn");
      deleteBtn.disabled = true;
      deleteBtn.innerHTML =
        '<span class="spinner"></span><span>Deleting...</span>';

      const body = {
        fromDate: fromDate,
        toDate: toDate,
        logType: logType,
        agentId: currentAgentId || null,
      };

      const result = await callApi("/api/admin/logs/delete", {
        method: "POST",
        body: JSON.stringify(body),
      });

      if (result && result.success) {
        showToast(
          `‚úÖ Successfully deleted ${
            result.data.deletedCount || 0
          } log records`,
          "success"
        );

        // Log the deletion activity
        await logToDatabase("LOGS_DELETED", currentAgentId, {
          logType: logType,
          fromDate: fromDate,
          toDate: toDate,
          deletedCount: result.data.deletedCount || 0,
        });

        closeDeleteLogsModal();

        // Refresh the current view
        const activeTab = document.querySelector(
          ".agent-details-tab.active"
        );
        if (activeTab) {
          const tabName = activeTab.textContent
            .toLowerCase()
            .replace(" ", "");
          switch (tabName) {
            case "allhistory":
              await loadAllHistory();
              break;
            case "fileevents":
              await loadFileEvents();
              break;
            case "webhistory":
              await loadWebHistory();
              break;
            case "usbhistory":
              await loadUsbHistory();
              break;
          }
        }
      } else {
        throw new Error(result?.message || "Failed to delete logs");
      }
    } catch (error) {
      console.error("Error deleting logs:", error);
      showToast(`‚ùå Failed to delete logs: ${error.message}`, "error");
    } finally {
      const deleteBtn = document.getElementById("deleteLogsBtn");
      deleteBtn.disabled = false;
      deleteBtn.innerHTML = "<span>üóëÔ∏è</span><span>Delete Logs</span>";
    }
  }

  // --- Tab & Data Loading ---
  function showTab(tabName) {
    document
      .querySelectorAll(".tab-content")
      .forEach((tab) => tab.classList.remove("active"));
    document
      .querySelectorAll(".nav-tab")
      .forEach((tab) => tab.classList.remove("active"));

    document.getElementById(tabName).classList.add("active");
    document
      .querySelector(`[onclick="showTab('${tabName}')"]`)
      .classList.add("active");

    switch (tabName) {
      case "overview":
        loadOverviewStats();
        break;
      case "agents":
        loadAgents();
        break;
      case "alerts":
        loadAlerts();
        break;
      case "ocr":
        loadOcrDashboard();
        startOcrAutoRefresh();
        break;
    }
  }

  // Helper functions
  function getThreatClass(score) {
    if (score >= 70) return "high-threat";
    if (score >= 40) return "medium-threat";
    return "low-threat";
  }

  function formatTimeAgo(timestamp) {
    if (!timestamp) return "Never";
    const now = new Date();
    const then = new Date(timestamp);
    const diff = Math.floor((now - then) / 1000 / 60); // minutes

    if (diff < 1) return "Just now";
    if (diff < 60) return `${diff}m ago`;
    if (diff < 1440) return `${Math.floor(diff / 60)}h ago`;
    return `${Math.floor(diff / 1440)}d ago`;
  }

  async function loadDashboardData() {
    try {
      await Promise.all([loadAgents(), loadAlerts()]);
      await loadOverviewStats();
      await loadChartData();
    } catch (err) {
      showToast("Failed to load dashboard data.", "error");
    }
  }

  async function loadChartData() {
    try {
      const [severityResult, dateResult] = await Promise.all([
        callApi("/api/admin/stats/alerts-by-severity"),
        callApi("/api/admin/stats/alerts-by-date"),
      ]);

      if (severityResult && severityResult.success) {
        const labels = severityResult.data.map((d) => d.severity);
        const data = severityResult.data.map((d) => d.count);

        const pieCtx = document
          .getElementById("severityPieChart")
          .getContext("2d");
        if (severityPieChart) severityPieChart.destroy();

        severityPieChart = new Chart(pieCtx, {
          type: "doughnut",
          data: {
            labels: labels,
            datasets: [
              {
                label: "Alerts by Severity",
                data: data,
                backgroundColor: [
                  "rgba(239, 71, 111, 0.8)",
                  "rgba(255, 209, 102, 0.8)",
                  "rgba(6, 214, 160, 0.8)",
                  "rgba(52, 152, 219, 0.8)",
                ],
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: { position: "top" },
            },
          },
        });
      }

      if (dateResult && dateResult.success) {
        const formatDate = (dateStr) =>
          new Date(dateStr).toISOString().split("T")[0];
        const labels = dateResult.data.map((d) => formatDate(d.date));
        const data = dateResult.data.map((d) => d.count);

        const barCtx = document
          .getElementById("alertsBarChart")
          .getContext("2d");
        if (alertsBarChart) alertsBarChart.destroy();

        alertsBarChart = new Chart(barCtx, {
          type: "bar",
          data: {
            labels: labels,
            datasets: [
              {
                label: "Alerts per Day",
                data: data,
                backgroundColor: "rgba(67, 97, 238, 0.8)",
                borderColor: "rgba(67, 97, 238, 1)",
                borderWidth: 1,
                borderRadius: 4,
              },
            ],
          },
          options: {
            responsive: true,
            scales: {
              y: {
                beginAtZero: true,
                ticks: { stepSize: 1 },
              },
            },
            plugins: {
              legend: { display: false },
            },
          },
        });
      }
    } catch (error) {
      console.error("Failed to load chart data:", error);
      showToast("Could not load dashboard charts.", "error");
    }
  }

  async function loadOverviewStats() {
    try {
      let agents = agentsCache;
      if (agents.length === 0) {
        const agentsResult = await callApi("/api/admin/agents");
        if (agentsResult && agentsResult.success) {
          agents = agentsResult.data || [];
          agentsCache = agents;
        }
      }

      const alertsResult = await callApi("/api/admin/alerts/pending");
      const alerts =
        alertsResult && alertsResult.success ? alertsResult.data || [] : [];

      const totalAgents = agents.length;
      const activeAgents = agents.filter(
        (a) => a.status === "ACTIVE"
      ).length;
      const totalActivePolicies = agents.reduce(
        (sum, a) => sum + (a.activePolicyCount || 0),
        0
      );

      document.getElementById("totalAgents").textContent = totalAgents;
      document.getElementById("activeAgents").textContent = activeAgents;
      document.getElementById("pendingAlerts").textContent = alerts.length;
      document.getElementById("totalPolicies").textContent =
        totalActivePolicies;
    } catch (err) {
      console.error("Error loading stats:", err);
    }
  }

// <!--async function loadAgents() {-->
// <!--    const tbody = document.getElementById("agentsTable");-->
// <!--    tbody.innerHTML = `<tr><td colspan="7" class="loading">Loading agents...</td></tr>`;-->
// <!--    try {-->
// <!--        // Fetch agents-->
// <!--        const agentsResult = await callApi("/api/admin/agents");-->
// <!--        const agents = agentsResult && agentsResult.success ? agentsResult.data : [];-->
// <!--        agentsCache = agents;-->

// <!--        if (agents.length === 0) {-->
// <!--            tbody.innerHTML = `<tr><td colspan="7" class="empty-state">No agents have registered yet.</td></tr>`;-->
// <!--            return;-->
// <!--        }-->

// <!--        // Fetch OCR status in parallel-->
// <!--        let ocrStatusMap = {};-->
// <!--        try {-->
// <!--            const ocrResult = await callApi("/api/admin/ocr/status");-->
// <!--            if (ocrResult && ocrResult.success && ocrResult.data) {-->
// <!--                ocrResult.data.forEach(agent => {-->
// <!--                    ocrStatusMap[agent.agent_id || agent.agentId] = agent;-->
// <!--                });-->
// <!--            }-->
// <!--        } catch (ocrError) {-->
// <!--            console.warn("Could not fetch OCR status:", ocrError.message);-->
// <!--        }-->

// <!--        // Build the table rows-->
// <!--        const rows = await Promise.all(agents.map(async (agent) => {-->
// <!--            const isActive = agent.status === "ACTIVE";-->
// <!--            const activateBtnText = isActive ? "Deactivate" : "Activate";-->
// <!--            const activateBtnClass = isActive ? "btn-warning" : "btn-success";-->
// <!--            const activateBtnIcon = isActive ? "‚è∏Ô∏è" : "‚ñ∂Ô∏è";-->
// <!--            const lastHeartbeat = agent.lastHeartbeat-->
// <!--                ? new Date(agent.lastHeartbeat).toLocaleString()-->
// <!--                : "Never";-->

// <!--            // Determine if agent is online or offline based on last heartbeat-->
// <!--              let isOnline = false;-->
// <!--              let statusDot = "";-->
// <!--              if (agent.lastHeartbeat) {-->
// <!--                  const lastHeartbeatTime = new Date(agent.lastHeartbeat).getTime();-->
// <!--                  const currentTime = Date.now();-->
// <!--                  const minutesSinceLastHeartbeat = (currentTime - lastHeartbeatTime) / (1000 * 60);-->

// <!--                  // Consider agent online if last heartbeat was within last 2 minutes-->
// <!--                  isOnline = minutesSinceLastHeartbeat < 2;-->

// <!--                  // Create status dot-->
// <!--                  statusDot = isOnline-->
// <!--                      ? '<span class="status-dot status-dot-online" title="Online"></span>'-->
// <!--                      : '<span class="status-dot status-dot-offline" title="Offline"></span>';-->
// <!--              } else {-->
// <!--                  statusDot = '<span class="status-dot status-dot-offline" title="Never Connected"></span>';-->
// <!--              }-->

// <!--            // Determine OCR status-->
// <!--            let ocrStatus = "N/A"; // Default: Not Available-->

// <!--            try {-->
// <!--                // Check if agent has OCR capability-->
// <!--                const capabilitiesResult = await callApi(`/api/admin/agents/${agent.id}/capabilities`);-->
// <!--                if (capabilitiesResult && capabilitiesResult.success) {-->
// <!--                    const categories = capabilitiesResult.data || {};-->
// <!--                    const hasOcrCapability = categories.SECURITY_MONITOR?.some(-->
// <!--                        policy => policy.code === "POLICY_OCR_MONITOR"-->
// <!--                    ) || false;-->

// <!--                    if (hasOcrCapability) {-->
// <!--                        // Check OCR status from OCR status API-->
// <!--                        const ocrAgentData = ocrStatusMap[agent.id];-->
// <!--                        if (ocrAgentData) {-->
// <!--                            ocrStatus = ocrAgentData.ocr_enabled === true || ocrAgentData.ocrEnabled === true-->
// <!--                                ? '<span style="color: var(&#45;&#45;success); font-weight: 600;">‚úÖ Enabled</span>'-->
// <!--                                : '<span style="color: var(&#45;&#45;danger); font-weight: 600;">‚ùå Disabled</span>';-->
// <!--                        } else {-->
// <!--                            ocrStatus = '<span style="color: var(&#45;&#45;gray); font-weight: 600;">‚è≥ Not Reporting</span>';-->
// <!--                        }-->
// <!--                    } else {-->
// <!--                        ocrStatus = '<span style="color: var(&#45;&#45;gray); font-weight: 600;">N/A</span>';-->
// <!--                    }-->
// <!--                }-->
// <!--            } catch (error) {-->
// <!--                console.warn(`Could not check OCR capability for agent ${agent.id}:`, error.message);-->
// <!--                ocrStatus = '<span style="color: var(&#45;&#45;gray); font-weight: 600;">Error</span>';-->
// <!--            }-->

// <!--            return `-->
// <!--            <tr data-agent-id="${agent.id}">-->
// <!--                <td>${agent.id}</td>-->
// <!--                <td><a href="#" onclick="event.preventDefault(); openAgentDetailsModal(${agent.id}, '${agent.username || ""}');">${agent.username}</a></td>-->
// <!--                <td>-->
// <!--                    <span class="status-${(agent.status || "INACTIVE").toLowerCase()}">-->
// <!--                        ${agent.status || "INACTIVE"}-->
// <!--                    </span>-->
// <!--                </td>-->
// <!--                <td>${ocrStatus}</td> &lt;!&ndash; OCR Status column &ndash;&gt;-->
// <!--                <td>${lastHeartbeat}</td>-->
// <!--                <td>${agent.activePolicyCount || 0} / ${agent.capabilityCount || 0}</td>-->
// <!--                <td>-->
// <!--                    <div style="display: flex; gap: 5px; flex-wrap: wrap;">-->
// <!--                        <button class="btn btn-info btn-sm" onclick="openAgentDetailsModal(${agent.id}, '${agent.username || ""}')">-->
// <!--                            <span>üëÅÔ∏è</span>-->
// <!--                            <span>View Details</span>-->
// <!--                        </button>-->
// <!--                        <button class="btn ${activateBtnClass} btn-sm" onclick="updateAgentStatus(${agent.id}, '${isActive ? 'SUSPENDED' : 'ACTIVE'}')">-->
// <!--                            <span>${activateBtnIcon}</span>-->
// <!--                            <span>${activateBtnText}</span>-->
// <!--                        </button>-->
// <!--                        <button class="btn btn-danger btn-sm" onclick="deleteAgent(${agent.id})">-->
// <!--                            <span>üóëÔ∏è</span>-->
// <!--                            <span>Delete</span>-->
// <!--                        </button>-->
// <!--                    </div>-->
// <!--                </td>-->
// <!--            </tr>`;-->
// <!--        }));-->

// <!--        tbody.innerHTML = rows.join("");-->
// <!--    } catch (error) {-->
// <!--        tbody.innerHTML = `<tr><td colspan="7" class="empty-state" style="color: var(&#45;&#45;danger);">${error.message}</td></tr>`;-->
// <!--    }-->
// <!--}-->

async function loadAgents() {
    const tbody = document.getElementById("agentsTable");
    tbody.innerHTML = `<tr><td colspan="7" class="loading">Loading agents...</td></tr>`;
    try {
        // Fetch agents
        const agentsResult = await callApi("/api/admin/agents");
        const agents = agentsResult && agentsResult.success ? agentsResult.data : [];
        agentsCache = agents;

        if (agents.length === 0) {
            tbody.innerHTML = `<tr><td colspan="7" class="empty-state">No agents have registered yet.</td></tr>`;
            return;
        }

        // Fetch OCR status in parallel
        let ocrStatusMap = {};
        try {
            const ocrResult = await callApi("/api/admin/ocr/status");
            if (ocrResult && ocrResult.success && ocrResult.data) {
                ocrResult.data.forEach(agent => {
                    ocrStatusMap[agent.agent_id || agent.agentId] = agent;
                });
            }
        } catch (ocrError) {
            console.warn("Could not fetch OCR status:", ocrError.message);
        }

        // Get current time for online/offline calculation
        const now = Date.now();

        // Build the table rows
        const rows = await Promise.all(agents.map(async (agent) => {
            const isActive = agent.status === "ACTIVE";
            const activateBtnText = isActive ? "Deactivate" : "Activate";
            const activateBtnClass = isActive ? "btn-warning" : "btn-success";
            const activateBtnIcon = isActive ? "‚è∏Ô∏è" : "‚ñ∂Ô∏è";

            // Format last heartbeat time
            let lastHeartbeatDisplay = "Never";
            let onlineStatus = "";
            let statusDot = "";

            if (agent.lastHeartbeat) {
                const lastHeartbeatTime = new Date(agent.lastHeartbeat);
                lastHeartbeatDisplay = lastHeartbeatTime.toLocaleString();

                // Calculate time difference in seconds
                const heartbeatTime = lastHeartbeatTime.getTime();
                const diffSeconds = Math.floor((now - heartbeatTime) / 1000);

                // Determine if agent is online (last heartbeat within 10 seconds)
                const isOnline = diffSeconds <= 10;

                // Create status indicator
                if (isOnline) {
                    onlineStatus = '<span class="online-indicator" title="Online - Last heartbeat: ' + diffSeconds + ' seconds ago"> ‚Ä¢ Online</span>';
                    statusDot = '<span class="status-dot status-dot-online" title="Online"></span>';
                } else {
                    // Calculate minutes/hours since last heartbeat
                    let timeAgo = "";
                    if (diffSeconds < 60) {
                        timeAgo = diffSeconds + "s";
                    } else if (diffSeconds < 3600) {
                        const minutes = Math.floor(diffSeconds / 60);
                        timeAgo = minutes + "m";
                    } else {
                        const hours = Math.floor(diffSeconds / 3600);
                        timeAgo = hours + "h";
                    }

                    onlineStatus = '<span class="offline-indicator" title="Offline - Last seen: ' + timeAgo + ' ago"> ‚Ä¢ Offline (' + timeAgo + ')</span>';
                    statusDot = '<span class="status-dot status-dot-offline" title="Offline"></span>';
                }
            } else {
                onlineStatus = '<span class="offline-indicator" title="Never connected"> ‚Ä¢ Never</span>';
                statusDot = '<span class="status-dot status-dot-offline" title="Never connected"></span>';
            }

            // Determine OCR status
            let ocrStatus = "N/A";

            try {
                const capabilitiesResult = await callApi(`/api/admin/agents/${agent.id}/capabilities`);
                if (capabilitiesResult && capabilitiesResult.success) {
                    const categories = capabilitiesResult.data || {};
                    const hasOcrCapability = categories.SECURITY_MONITOR?.some(
                        policy => policy.code === "POLICY_OCR_MONITOR"
                    ) || false;

                    if (hasOcrCapability) {
                        const ocrAgentData = ocrStatusMap[agent.id];
                        if (ocrAgentData) {
                            ocrStatus = ocrAgentData.ocr_enabled === true || ocrAgentData.ocrEnabled === true
                                ? '<span style="color: var(--success); font-weight: 600;">‚úÖ Enabled</span>'
                                : '<span style="color: var(--danger); font-weight: 600;">‚ùå Disabled</span>';
                        } else {
                            ocrStatus = '<span style="color: var(--gray); font-weight: 600;">‚è≥ Not Reporting</span>';
                        }
                    } else {
                        ocrStatus = '<span style="color: var(--gray); font-weight: 600;">N/A</span>';
                    }
                }
            } catch (error) {
                console.warn(`Could not check OCR capability for agent ${agent.id}:`, error.message);
                ocrStatus = '<span style="color: var(--gray); font-weight: 600;">Error</span>';
            }

            return `
            <tr data-agent-id="${agent.id}">
                <td>${agent.id}</td>
                <td><a href="#" onclick="event.preventDefault(); openAgentDetailsModal(${agent.id}, '${agent.username || ""}');">${agent.username}</a></td>
                <td>
                    ${statusDot}
                    <span class="status-${(agent.status || "INACTIVE").toLowerCase()}">
                        ${agent.status || "INACTIVE"}
                    </span>
                </td>
                <td>${ocrStatus}</td>
                <td>
                    ${lastHeartbeatDisplay}
                    ${onlineStatus}
                </td>
                <td>${agent.activePolicyCount || 0} / ${agent.capabilityCount || 0}</td>
                <td>
                    <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                        <button class="btn btn-info btn-sm" onclick="openAgentDetailsModal(${agent.id}, '${agent.username || ""}')">
                            <span>üëÅÔ∏è</span>
                            <span>View Details</span>
                        </button>
                        <button class="btn ${activateBtnClass} btn-sm" onclick="updateAgentStatus(${agent.id}, '${isActive ? 'SUSPENDED' : 'ACTIVE'}')">
                            <span>${activateBtnIcon}</span>
                            <span>${activateBtnText}</span>
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteAgent(${agent.id})">
                            <span>üóëÔ∏è</span>
                            <span>Delete</span>
                        </button>
                    </div>
                </td>
            </tr>`;
        }));

        tbody.innerHTML = rows.join("");
    } catch (error) {
        tbody.innerHTML = `<tr><td colspan="7" class="empty-state" style="color: var(--danger);">${error.message}</td></tr>`;
    }
}
// Helper function to get status text for heartbeat
function getHeartbeatStatusText(status) {
    switch(status) {
        case 'online': return 'Online (‚â§5 min)';
        case 'idle': return 'Idle (5-15 min)';
        case 'offline': return 'Offline (>15 min)';
        default: return 'Unknown';
    }
}

  // --- Utility function for HTML escaping ---
  function escapeHtml(text) {
    if (!text) return "";
    const div = document.createElement("div");
    div.textContent = text;
    return div.innerHTML;
  }

  function getAgentName(agentId) {
    const agent = agentsCache.find((a) => a.id === agentId);
    return agent ? agent.hostname : `Agent ${agentId}`;
  }

  async function updateAgentStatus(agentId, newStatus) {
    const action = newStatus === "ACTIVE" ? "activate" : "deactivate";
    if (!confirm(`Are you sure you want to ${action} this agent?`)) return;
    try {
      await callApi(
        `/api/admin/agents/${agentId}/status?status=${newStatus}`,
        { method: "PUT" }
      );
      showToast(`Agent ${action}d successfully.`, "success");
      await loadAgents();
      await loadOverviewStats();
    } catch (error) {
      showToast(error.message, "error");
    }
  }

  async function deleteAgent(agentId) {
    if (
      !confirm(
        "Are you sure you want to delete this agent? This cannot be undone."
      )
    )
      return;
    try {
      await callApi(`/api/admin/agents/${agentId}`, { method: "DELETE" });
      showToast("Agent deleted successfully.", "success");
      await loadAgents();
      await loadOverviewStats();
    } catch (error) {
      showToast(error.message, "error");
    }
  }

  // --- Agent Details Modal ---
  function openAgentDetailsModal(agentId, hostname) {
    currentAgentId = agentId;
    currentAgentHostname = hostname;
    document.getElementById(
      "agentDetailsTitle"
    ).textContent = `Agent Details: ${hostname}`;
    document.getElementById("agentDetailsModal").classList.remove("hidden");
    loadAgentPolicies("policies");
  }

  function closeAgentDetailsModal() {
    document.getElementById("agentDetailsModal").classList.add("hidden");
    currentAgentId = null;
    currentAgentHostname = null;
  }

  async function loadAgentPolicies() {
    const container = document.getElementById("agentPoliciesList");
    container.innerHTML = '<div class="loading">Loading policies...</div>';

    try {
      const result = await callApi(
        `/api/admin/agents/${currentAgentId}/capabilities`
      );
      if (result && result.success) {
        const categories = result.data || {};
        if (Object.keys(categories).length === 0) {
          container.innerHTML =
            '<div class="empty-state">This agent has not reported any capabilities yet.</div>';
          return;
        }

        container.innerHTML = Object.entries(categories)
          .map(
            ([category, policies]) => `
                    <div style="margin-bottom: 20px;">
                        <h4>${category}</h4>
                        <div class="policies-grid">
                        ${policies
                          .map((p) => {
                            const btnClass = p.isActive
                              ? "btn-warning"
                              : "btn-success";
                            const btnText = p.isActive
                              ? "Deactivate"
                              : "Activate";
                            const btnIcon = p.isActive ? "‚è∏Ô∏è" : "‚ñ∂Ô∏è";
                            let policyCardHTML = `
                            <div class="policy-card ${
                              p.isActive ? "selected" : ""
                            }">
                                <h5>${p.name}</h5>
                                <p style="font-size: 0.9em; color: #555;">${
                                  p.description
                                }</p>
                                <div class="policy-action" style="display:flex; justify-content:space-between; align-items:center;">
                                    <strong>Status: <span class="${
                                      p.isActive
                                        ? "status-active"
                                        : "status-inactive"
                                    }">${
                              p.isActive ? "ACTIVE" : "INACTIVE"
                            }</span></strong>
                                    <button class="btn ${btnClass} btn-sm" onclick="togglePolicy(${currentAgentId}, '${
                              p.code
                            }', ${p.isActive})">
                                        <span>${btnIcon}</span>
                                        <span>${btnText}</span>
                                    </button>
                                </div>
                            `;

                            // Show Edit button for DNS block policy and custom file policies
                            if (
                              p.code === "NETWORK_DNS_BLOCK" ||
                              p.code.startsWith("FILE_")
                            ) {
                              const policyDataString = p.policyData
                                ? p.policyData.replace(/'/g, "\\'")
                                : "{}";
                              policyCardHTML += `
                                <button class="btn btn-primary btn-sm" style="width: 100%; margin-top: 10px;"
                                        onclick='openBlocklistEditor(${currentAgentId}, "${p.code}", "${currentAgentHostname}", \`${policyDataString}\`)'>
                                    ‚úèÔ∏è Edit Policy
                                </button>
                                `;
                            }

                            policyCardHTML += `</div>`;
                            return policyCardHTML;
                          })
                          .join("")}
                        </div>
                    </div>`
          )
          .join("");
      }
    } catch (error) {
      container.innerHTML = `<div class="empty-state" style="color: var(--danger);">${error.message}</div>`;
    }
  }

  // NEW: All History Tab Functions
  async function loadAllHistory() {
    const container = document.getElementById("agentAllHistoryList");
    container.innerHTML =
      '<div class="loading">Loading all history...</div>';

    try {
      // Load all data types in parallel
      const [fileResult, webResult, usbResult, alertsResult] =
        await Promise.all([
          callApi(`/api/admin/file-events/${currentAgentId}`),
          callApi(`/api/admin/web-history-detailed/${currentAgentId}`),
          callApi(`/api/admin/agents/usb-history/${currentAgentId}`),
          callApi(`/api/admin/alerts/agent/${currentAgentId}`),
        ]);

      // Combine all data into one array with type identifiers
      allHistoryData = [];

      // Add file events
      if (fileResult && fileResult.success && fileResult.data) {
        fileResult.data.forEach((event) => {
          allHistoryData.push({
            ...event,
            type: "FILE",
            eventType: "File Event",
            description: `${event.operation} - ${event.filePath}`,
            timestamp: event.timestamp,
          });
        });
      }

      // Add web history
      if (webResult && webResult.success && webResult.data) {
        webResult.data.forEach((entry) => {
          allHistoryData.push({
            ...entry,
            type: "WEB",
            eventType: "Web Visit",
            description: `Visited: ${entry.url}`,
            timestamp: entry.timestamp,
          });
        });
      }

      // Add USB history
      if (usbResult && usbResult.success && usbResult.data) {
        usbResult.data.forEach((entry) => {
          allHistoryData.push({
            ...entry,
            type: "USB",
            eventType: "USB Device",
            description: `${entry.action} - ${
              entry.deviceName || "Unknown Device"
            }`,
            timestamp: entry.timestamp,
          });
        });
      }

      // Add alerts
      if (alertsResult && alertsResult.success && alertsResult.data) {
        alertsResult.data.forEach((alert) => {
          allHistoryData.push({
            ...alert,
            type: "ALERT",
            eventType: "Security Alert",
            description: alert.description || "Security event detected",
            timestamp: alert.createdAt,
          });
        });
      }

      // Sort by timestamp (newest first)
      allHistoryData.sort(
        (a, b) => new Date(b.timestamp) - new Date(a.timestamp)
      );

      applyAllHistoryFilter();
    } catch (error) {
      container.innerHTML = `<div class="empty-state" style="color: var(--danger);">${error.message}</div>`;
    }
  }

  function filterAllHistory(filter, btnElement) {
    currentAllHistoryFilter = filter;
    document
      .querySelectorAll("#agentAllHistoryTab .time-filter-btn")
      .forEach((btn) => btn.classList.remove("active"));
    btnElement.classList.add("active");
    currentAllHistoryPage = 1;
    applyAllHistoryFilter();
  }

  function applyAllHistoryFilter() {
    const now = new Date();
    let filteredData = [...allHistoryData];

    switch (currentAllHistoryFilter) {
      case "TODAY":
        filteredData = filteredData.filter((event) => {
          const eventDate = new Date(event.timestamp);
          return eventDate.toDateString() === now.toDateString();
        });
        break;
      case "LAST_7_DAYS":
        const sevenDaysAgo = new Date(
          now.getTime() - 7 * 24 * 60 * 60 * 1000
        );
        filteredData = filteredData.filter(
          (event) => new Date(event.timestamp) >= sevenDaysAgo
        );
        break;
      case "LAST_30_DAYS":
        const thirtyDaysAgo = new Date(
          now.getTime() - 30 * 24 * 60 * 60 * 1000
        );
        filteredData = filteredData.filter(
          (event) => new Date(event.timestamp) >= thirtyDaysAgo
        );
        break;
      // 'ALL' case - no filtering needed
    }

    displayAllHistoryWithPagination(filteredData);
  }

  function displayAllHistoryWithPagination(events) {
    const container = document.getElementById("agentAllHistoryList");
    const pagination = document.getElementById("allHistoryPagination");

    const totalPages = Math.ceil(events.length / ITEMS_PER_PAGE);
    const startIndex = (currentAllHistoryPage - 1) * ITEMS_PER_PAGE;
    const paginatedEvents = events.slice(
      startIndex,
      startIndex + ITEMS_PER_PAGE
    );

    if (paginatedEvents.length === 0) {
      container.innerHTML =
        '<div class="empty-state">No history found for this period.</div>';
      pagination.classList.add("hidden");
      return;
    }

    container.innerHTML = `
            <table class="log-table">
                <thead>
                    <tr>
                        <th>Timestamp</th>
                        <th>Type</th>
                        <th>Event</th>
                        <th>Details</th>
                    </tr>
                </thead>
                <tbody>
                    ${paginatedEvents
                      .map((event) => {
                        let typeBadge = "";
                        let icon = "üìÑ";

                        switch (event.type) {
                          case "FILE":
                            typeBadge = "event-type-file";
                            icon = "üìÅ";
                            break;
                          case "WEB":
                            typeBadge = "event-type-web";
                            icon = "üåê";
                            break;
                          case "USB":
                            typeBadge = "event-type-usb";
                            icon = "üíæ";
                            break;
                          case "ALERT":
                            typeBadge = "event-type-alert";
                            icon = "üö®";
                            break;
                        }

                        return `
                        <tr>
                            <td>${new Date(
                              event.timestamp
                            ).toLocaleString()}</td>
                            <td>
                                <span class="event-type-badge ${typeBadge}">
                                    ${icon} ${event.type}
                                </span>
                            </td>
                            <td><strong>${event.eventType}</strong></td>
                            <td>${event.description}</td>
                        </tr>
                    `;
                      })
                      .join("")}
                </tbody>
            </table>
        `;

    // Update pagination
    if (totalPages > 1) {
      pagination.classList.remove("hidden");
      pagination.innerHTML = "";

      // Previous button
      if (currentAllHistoryPage > 1) {
        pagination.innerHTML += `<button class="pagination-btn" onclick="changeAllHistoryPage(${
          currentAllHistoryPage - 1
        })">‚Üê Previous</button>`;
      }

      // Page numbers
      for (let i = 1; i <= totalPages; i++) {
        pagination.innerHTML += `<button class="pagination-btn ${
          i === currentAllHistoryPage ? "active" : ""
        }" onclick="changeAllHistoryPage(${i})">${i}</button>`;
      }

      // Next button
      if (currentAllHistoryPage < totalPages) {
        pagination.innerHTML += `<button class="pagination-btn" onclick="changeAllHistoryPage(${
          currentAllHistoryPage + 1
        })">Next ‚Üí</button>`;
      }
    } else {
      pagination.classList.add("hidden");
    }
  }

  function changeAllHistoryPage(page) {
    currentAllHistoryPage = page;
    applyAllHistoryFilter();
  }

  // Database Logging Functions
  async function logToDatabase(eventType, agentId, details) {
    try {
      const logEntry = {
        eventType: eventType,
        agentId: agentId,
        details: details,
        timestamp: new Date().toISOString(),
      };

      const result = await callApi("/api/admin/log-event", {
        method: "POST",
        body: JSON.stringify(logEntry),
      });

      if (result && result.success) {
        console.log("Event logged to database:", eventType);
      } else {
        console.warn("Failed to log event to database:", eventType);
      }
    } catch (error) {
      console.error("Error logging to database:", error);
    }
  }

  // Example usage - log important events
  async function logPolicyAssignment(agentId, policyCode) {
    await logToDatabase("POLICY_ASSIGNMENT", agentId, {
      policy: policyCode,
      action: "assigned",
    });
  }

  async function logPolicyRemoval(agentId, policyCode) {
    await logToDatabase("POLICY_REMOVAL", agentId, {
      policy: policyCode,
      action: "removed",
    });
  }

  // // Main OCR Dashboard Loading Function - CORRECTED VERSION
  // async function loadOcrDashboard() {
  //   const container = document.getElementById("ocrDashboardContent");
  //   container.innerHTML = `<div class="loading">Loading OCR monitoring data...</div>`;

  //   try {
  //     console.log("üîÑ Loading OCR dashboard data...");
  //    const [statusResult, agentsResult] = await Promise.all([
  //           callApi("/api/admin/ocr/status"),
  //           callApi("/api/admin/agents")
  //       ]);

  //     if (!statusResult || !statusResult.success) {
  //       throw new Error("Failed to load OCR status");
  //     }

  //     const ocrAgents = (statusResult.data || []).map();
  //     const summary = await callApi("/api/admin/ocr/summary");

  //     // Merge runtime state from agents data
  //       if (agentsResult && agentsResult.success) {
  //           const agentsData = agentsResult.data || [];
  //           const agentsMap = {};

  //           // Create a map of agentId -> agentRuntimeState
  //           agentsData.forEach(agent => {
  //               agentsMap[agent.id] = agent.agentRuntimeState || "OFFLINE";
  //           });

  //           // Merge the runtime state into OCR agents
  //           agents = agents.map(ocrAgent => ({
  //               ...ocrAgent,
  //               runtimeState: agentsMap[ocrAgent.agentId] || "OFFLINE"
  //           }));
  //       }

  //     // Store summary for use in stats
  //     ocrDashboardStats.summary = summary;

  //     // Calculate statistics
  //     updateOcrDashboardStats(ocrAgents);

  //     // Render the dashboard
  //     renderOcrDashboard(ocrAgents);

  //     // Update last updated time
  //     ocrDashboardStats.lastUpdated = new Date();

  //     // Update notification badge
  //     updateOcrNotificationBadge(ocrAgents);
  //   } catch (error) {
  //     console.error("‚ùå Error loading OCR dashboard:", error);
  //     container.innerHTML = `
  //       <div class="empty-state" style="color: var(--danger);">
  //           <h4>‚ùå Failed to load OCR data</h4>
  //           <p>${error.message}</p>
  //           <button class="btn btn-primary" onclick="loadOcrDashboard()" style="margin-top: 10px;">
  //               <span>üîÑ</span>
  //               <span>Try Again</span>
  //           </button>
  //       </div>
  //   `;
  //   }
  // }

  async function loadOcrDashboard() {
    const container = document.getElementById("ocrDashboardContent");
    container.innerHTML = `<div class="loading">Loading OCR monitoring data...</div>`;

    try {
        console.log("üîÑ Loading OCR dashboard data...");

        // Fetch both OCR status and agents data in parallel
        const [statusResult, agentsResult] = await Promise.all([
            callApi("/api/admin/ocr/status"),
            callApi("/api/admin/agents")
        ]);

        // Check if statusResult exists and has data
        if (!statusResult || !statusResult.success) {
            throw new Error("Failed to load OCR status");
        }

        // Ensure data is an array
        const ocrData = statusResult.data || [];
        if (!Array.isArray(ocrData)) {
            throw new Error("OCR data is not in expected format");
        }

        // Process OCR agents
        let ocrAgents = ocrData.map(normalizeAgent);

        // Get summary
        const summary = await callApi("/api/admin/ocr/summary");

        // Debug log
        console.log('OCR Agents from OCR API:', ocrAgents);
        console.log('General Agents from API:', agentsResult?.data);

        // Merge runtime state from agents data if available
        if (agentsResult && agentsResult.success && Array.isArray(ocrAgents)) {
            const agentsData = agentsResult.data || [];

            // Create a map of agentId -> agent data
            const agentsMap = new Map();
            agentsData.forEach(agent => {
                if (agent && agent.id) {
                    agentsMap.set(agent.id, agent);
                }
            });

            // Merge the runtime state into OCR agents
            ocrAgents = ocrAgents.map(ocrAgent => {
                const generalAgent = agentsMap.get(parseInt(ocrAgent.agentId));
                if (generalAgent) {
                    return {
                        ...ocrAgent,
                        runtimeState: generalAgent.agentRuntimeState || "OFFLINE",
                        lastHeartbeat: generalAgent.lastHeartbeat || ocrAgent.lastHeartbeat,
                        // Use hostname from general agent if available
                        agentHostname: generalAgent.hostname || generalAgent.username || ocrAgent.agentHostname,
                        agentUsername: generalAgent.username || ocrAgent.agentUsername || ocrAgent.agentHostname
                    };
                }
                return ocrAgent;
            });
        }

        // Store summary for use in stats
        ocrDashboardStats.summary = summary;

        // Calculate statistics
        updateOcrDashboardStats(ocrAgents);

        // Render the dashboard
        renderOcrDashboard(ocrAgents);

        // Update last updated time
        ocrDashboardStats.lastUpdated = new Date();

        // Update notification badge
        updateOcrNotificationBadge(ocrAgents);
    } catch (error) {
        console.error("‚ùå Error loading OCR dashboard:", error);
        container.innerHTML = `
            <div class="empty-state" style="color: var(--danger);">
                <h4>‚ùå Failed to load OCR data</h4>
                <p>${error.message}</p>
                <button class="btn btn-primary" onclick="loadOcrDashboard()" style="margin-top: 10px;">
                    <span>üîÑ</span>
                    <span>Try Again</span>
                </button>
            </div>
        `;
    }
}

  // Update OCR Dashboard Statistics - CORRECTED VERSION
  // function updateOcrDashboardStats(agents) {

  //  if (!agents || !Array.isArray(agents)) {
  //       console.error('Invalid agents data:', agents);
  //       ocrDashboardStats = {
  //           totalCapableAgents: 0,
  //           activeOcrAgents: 0,
  //           highThreatCount: 0,
  //           totalViolations24h: 0,
  //           lastUpdated: new Date(),
  //           summary: ocrDashboardStats.summary
  //       };
  //       return;
  //   }

  //   // Normalize all agents first
  //   const normalizedAgents = agents.map(normalizeAgent);

  //   ocrDashboardStats = {
  //     // Use the summary from API call
  //     totalCapableAgents: ocrDashboardStats.summary?.totalCapableAgents || normalizedAgents.length,
  //     activeOcrAgents: ocrDashboardStats.summary?.activeOcr || normalizedAgents.filter(a => a.ocrEnabled === true).length,
  //     highThreatCount: normalizedAgents.filter(a => (a.currentThreatScore || 0) >= 70).length,
  //     totalViolations24h: normalizedAgents.reduce((sum, a) => sum + (a.violationsLast24h || 0), 0),
  //     lastUpdated: new Date(),
  //   };

  //   console.log('üìä Dashboard stats:', ocrDashboardStats);
  // }

  // Update OCR Dashboard Statistics - CORRECTED VERSION
function updateOcrDashboardStats(agents) {
    if (!agents || !Array.isArray(agents)) {
        console.error('Invalid agents data:', agents);
        ocrDashboardStats = {
            totalCapableAgents: 0,
            activeOcrAgents: 0,
            highThreatCount: 0,
            totalViolations24h: 0,
            lastUpdated: new Date(),
            summary: ocrDashboardStats.summary
        };
        return;
    }

    // Ensure all agents are normalized
    const normalizedAgents = agents.map(agent => normalizeAgent(agent));

    ocrDashboardStats = {
        totalCapableAgents: ocrDashboardStats.summary?.totalCapableAgents || normalizedAgents.length,
        activeOcrAgents: ocrDashboardStats.summary?.activeOcr || normalizedAgents.filter(a => a.ocrEnabled === true).length,
        highThreatCount: normalizedAgents.filter(a => (a.currentThreatScore || 0) >= 70).length,
        totalViolations24h: normalizedAgents.reduce((sum, a) => sum + (a.violationsLast24h || 0), 0),
        lastUpdated: new Date(),
        summary: ocrDashboardStats.summary
    };

    console.log('üìä Dashboard stats:', ocrDashboardStats);
}

  function normalizeAgent(agent) {
    return {
      agentId: agent.agent_id ?? agent.agentId,
      agentHostname: agent.agent_hostname ?? agent.agentHostname,
      agent_username: agent.agent_username ?? agent.agentUsername,
      ocrEnabled: agent.ocr_enabled ?? agent.ocrEnabled ?? false,
      currentThreatScore: agent.current_threat_score ?? agent.currentThreatScore ?? 0,
      violationsLast24h: agent.violations_last_24h ?? agent.violationsLast24h ?? 0,
      lastScreenshotTime: agent.last_screenshot_time ?? agent.lastScreenshotTime,
      screenLocked: agent.screen_locked ?? agent.screenLocked ?? false,
      ocrActive: agent.ocr_active ?? agent.ocrActive ?? false,
      lastHeartbeat: agent.last_heartbeat ?? agent.lastHeartbeat,
         // NEW: Add threat arrow and trend color
        threatArrow: agent.threat_arrow ?? agent.threatArrow ?? "‚Üí",
        trendColor: agent.trend_color ?? agent.trendColor ?? "gray",
      // Add these for compatibility
      agent_id: agent.agent_id ?? agent.agentId,
      agent_hostname: agent.agent_hostname ?? agent.agentHostname,
      ocr_enabled: agent.ocr_enabled ?? agent.ocrEnabled ?? false,
      current_threat_score: agent.current_threat_score ?? agent.currentThreatScore ?? 0,
      violations_last_24h: agent.violations_last_24h ?? agent.violationsLast24h ?? 0,
       threat_arrow: agent.threat_arrow ?? agent.threatArrow ?? "‚Üí",
        trend_color: agent.trend_color ?? agent.trendColor ?? "gray"
    };
  }

  // Update Notification Badge
  // function updateOcrNotificationBadge(agents) {
  //   const badge = document.getElementById("ocrNotificationBadge");
  //   const highThreatCount = agents.filter(
  //     (a) => a.currentThreatScore > 70
  //   ).length;

  //   if (highThreatCount > 0) {
  //     badge.textContent = highThreatCount;
  //     badge.classList.remove("hidden");
  //     // Add pulse animation for high threat
  //     badge.style.animation = "pulse 2s infinite";
  //   } else {
  //     badge.classList.add("hidden");
  //   }
  // }

  // Update Notification Badge
function updateOcrNotificationBadge(agents) {
    const badge = document.getElementById("ocrNotificationBadge");
    
    if (!agents || !Array.isArray(agents)) {
        badge.classList.add("hidden");
        return;
    }
    
    const highThreatCount = agents.filter(
        (a) => (a.currentThreatScore || 0) > 70
    ).length;

    if (highThreatCount > 0) {
        badge.textContent = highThreatCount;
        badge.classList.remove("hidden");
        // Add pulse animation for high threat
        badge.style.animation = "pulse 2s infinite";
    } else {
        badge.classList.add("hidden");
    }
}

// <!--  // Render OCR Dashboard-->
// <!--  function renderOcrDashboard(agents) {-->
// <!--    const container = document.getElementById("ocrDashboardContent");-->

// <!--    // Group agents by threat level-->
// <!--    const highThreatAgents = agents.filter(-->
// <!--      (a) => a.currentThreatScore > 70-->
// <!--    );-->
// <!--    const mediumThreatAgents = agents.filter(-->
// <!--      (a) => a.currentThreatScore > 40 && a.currentThreatScore <= 70-->
// <!--    );-->
// <!--    const lowThreatAgents = agents.filter(-->
// <!--      (a) => a.currentThreatScore <= 40 && a.currentThreatScore > 0-->
// <!--    );-->
// <!--    const inactiveAgents = agents.filter(-->
// <!--      (a) => a.currentThreatScore === 0 || !a.ocrEnabled-->
// <!--    );-->

// <!--    container.innerHTML = `-->
// <!--    <div class="ocr-dashboard-container">-->
// <!--        &lt;!&ndash; Stats Bar &ndash;&gt;-->
// <!--        <div class="dashboard-stats-bar">-->
// <!--            <div class="stat-card-compact">-->
// <!--                <div class="stat-number-compact">${-->
// <!--                  ocrDashboardStats.totalCapableAgents || 0-->
// <!--                }</div>-->
// <!--                <div class="stat-label-compact">Total OCR Capable Agents</div>-->
// <!--            </div>-->
// <!--            <div class="stat-card-compact">-->
// <!--                <div class="stat-number-compact">${-->
// <!--                  ocrDashboardStats.activeOcrAgents || 0-->
// <!--                }</div>-->
// <!--                <div class="stat-label-compact">Active OCR</div>-->
// <!--            </div>-->
// <!--            <div class="stat-card-compact">-->
// <!--                <div class="stat-number-compact" style="color: var(&#45;&#45;danger);">${-->
// <!--                  ocrDashboardStats.highThreatCount || 0-->
// <!--                }</div>-->
// <!--                <div class="stat-label-compact">High Threats</div>-->
// <!--            </div>-->
// <!--            <div class="stat-card-compact">-->
// <!--                <div class="stat-number-compact">${-->
// <!--                  ocrDashboardStats.totalViolations24h || 0-->
// <!--                }</div>-->
// <!--                <div class="stat-label-compact">Violations (24h)</div>-->
// <!--            </div>-->
// <!--        </div>-->

// <!--        &lt;!&ndash; Threat Sections &ndash;&gt;-->
// <!--        <div class="threat-sections-grid">-->
// <!--            &lt;!&ndash; High Threat Section &ndash;&gt;-->
// <!--            ${-->
// <!--              highThreatAgents.length > 0-->
// <!--                ? renderThreatSection("high", highThreatAgents)-->
// <!--                : ""-->
// <!--            }-->

// <!--            &lt;!&ndash; Medium Threat Section &ndash;&gt;-->
// <!--            ${-->
// <!--              mediumThreatAgents.length > 0-->
// <!--                ? renderThreatSection("medium", mediumThreatAgents)-->
// <!--                : ""-->
// <!--            }-->

// <!--            &lt;!&ndash; Low Threat Section &ndash;&gt;-->
// <!--            ${-->
// <!--              lowThreatAgents.length > 0-->
// <!--                ? renderThreatSection("low", lowThreatAgents)-->
// <!--                : ""-->
// <!--            }-->

// <!--            &lt;!&ndash; Inactive Section &ndash;&gt;-->
// <!--            ${-->
// <!--              inactiveAgents.length > 0-->
// <!--                ? renderThreatSection("inactive", inactiveAgents)-->
// <!--                : ""-->
// <!--            }-->

// <!--            ${-->
// <!--              agents.length === 0-->
// <!--                ? `-->
// <!--            <div class="agents-empty-state">-->
// <!--                <h4>No OCR Agents Found</h4>-->
// <!--                <p>No agents have reported OCR data yet.</p>-->
// <!--            </div>-->
// <!--            `-->
// <!--                : ""-->
// <!--            }-->
// <!--        </div>-->

// <!--        &lt;!&ndash; Last Updated &ndash;&gt;-->
// <!--        <div style="text-align: center; margin-top: 20px; color: var(&#45;&#45;gray); font-size: 0.9em;">-->
// <!--            Last updated: ${new Date().toLocaleTimeString()}-->
// <!--        </div>-->
// <!--    </div>-->
// <!--`;-->

    // Render OCR Dashboard
  function renderOcrDashboard(agents) {
    const container = document.getElementById("ocrDashboardContent");

    // Group agents by status
    const activeAgents = agents.filter(a => a.ocrEnabled === true);
    const inactiveAgents = agents.filter(a => a.ocrEnabled === false);

    // Within active agents, further categorize by threat level
    const activeHighThreat = activeAgents.filter(a => a.currentThreatScore > 70);
    const activeMediumThreat = activeAgents.filter(a => a.currentThreatScore > 40 && a.currentThreatScore <= 70);
    const activeLowThreat = activeAgents.filter(a => a.currentThreatScore <= 40 && a.currentThreatScore > 0);
    const activeNoThreat = activeAgents.filter(a => a.currentThreatScore === 0 || !a.currentThreatScore);

    container.innerHTML = `
    <div class="ocr-dashboard-container">
        <!-- Stats Bar -->
        <div class="dashboard-stats-bar">
            <div class="stat-card-compact">
                <div class="stat-number-compact">${ocrDashboardStats.totalCapableAgents || 0}</div>
                <div class="stat-label-compact">Total OCR Capable Agents</div>
            </div>
            <div class="stat-card-compact">
                <div class="stat-number-compact">${ocrDashboardStats.activeOcrAgents || 0}</div>
                <div class="stat-label-compact">Active OCR Agents</div>
            </div>
            <div class="stat-card-compact">
                <div class="stat-number-compact" style="color: var(--danger);">${activeHighThreat.length || 0}</div>
                <div class="stat-label-compact">High Threats</div>
            </div>
            <div class="stat-card-compact">
                <div class="stat-number-compact">${ocrDashboardStats.totalViolations24h || 0}</div>
                <div class="stat-label-compact">Violations (24h)</div>
            </div>
        </div>

        <!-- ACTIVE AGENTS SECTION -->
        ${activeAgents.length > 0 ? `
            <div class="threat-section">
                <div class="threat-section-header success" style="background: linear-gradient(135deg, var(--success), #05b88a);">
                    <span>‚úÖ Active OCR Agents (${activeAgents.length})</span>
                    <span class="threat-section-count">${activeAgents.length} active</span>
                </div>

                <!-- Active High Threat -->
                ${activeHighThreat.length > 0 ? `
                    <div style="padding: 15px;">
                        <h4 style="color: var(--danger); margin-bottom: 10px;">üî¥ High Threat (${activeHighThreat.length})</h4>
                        <div class="agents-grid">
                            ${activeHighThreat.map((agent) => renderAgentCard(agent, "high")).join("")}
                        </div>
                    </div>
                ` : ""}

                <!-- Active Medium Threat -->
                ${activeMediumThreat.length > 0 ? `
                    <div style="padding: 15px;">
                        <h4 style="color: var(--warning); margin-bottom: 10px;">üü° Medium Threat (${activeMediumThreat.length})</h4>
                        <div class="agents-grid">
                            ${activeMediumThreat.map((agent) => renderAgentCard(agent, "medium")).join("")}
                        </div>
                    </div>
                ` : ""}

                <!-- Active Low Threat -->
                ${activeLowThreat.length > 0 ? `
                    <div style="padding: 15px;">
                        <h4 style="color: var(--success); margin-bottom: 10px;">üü¢ Low Threat (${activeLowThreat.length})</h4>
                        <div class="agents-grid">
                            ${activeLowThreat.map((agent) => renderAgentCard(agent, "low")).join("")}
                        </div>
                    </div>
                ` : ""}

                <!-- Active No Threat -->
                ${activeNoThreat.length > 0 ? `
                    <div style="padding: 15px;">
                        <h4 style="color: var(--gray); margin-bottom: 10px;">‚ö™ No Threat (${activeNoThreat.length})</h4>
                        <div class="agents-grid">
                            ${activeNoThreat.map((agent) => renderAgentCard(agent, "none")).join("")}
                        </div>
                    </div>
                ` : ""}
            </div>
        ` : ""}

        <!-- INACTIVE AGENTS SECTION -->
        ${inactiveAgents.length > 0 ? `
            <div class="threat-section">
                <div class="threat-section-header inactive">
                    <span>‚ö´ Inactive OCR Agents</span>
                    <span class="threat-section-count">${inactiveAgents.length} inactive</span>
                </div>
                <div class="agents-grid">
                    ${inactiveAgents.map((agent) => renderAgentCard(agent, "inactive")).join("")}
                </div>
            </div>
        ` : ""}

        <!-- NO AGENTS FOUND -->
        ${agents.length === 0 ? `
            <div class="agents-empty-state">
                <h4>No OCR Agents Found</h4>
                <p>No agents have reported OCR data yet.</p>
            </div>
        ` : ""}

        <!-- Last Updated -->
        <div style="text-align: center; margin-top: 20px; color: var(--gray); font-size: 0.9em;">
            Last updated: ${new Date().toLocaleTimeString()}
        </div>
    </div>
    `;

    // Initialize auto-refresh toggle
    const autoRefreshToggle = document.getElementById("ocrAutoRefresh");
    if (autoRefreshToggle) {
      autoRefreshToggle.addEventListener("change", toggleOcrAutoRefresh);
    }
  }

  // Render Threat Section
  function renderThreatSection(threatLevel, agents) {
    const threatConfig = {
      high: { title: "üî¥ High Threat Agents", class: "high", icon: "üî¥" },
      medium: {
        title: "üü° Medium Threat Agents",
        class: "medium",
        icon: "üü°",
      },
      low: { title: "üü¢ Low Threat Agents", class: "low", icon: "üü¢" },
      inactive: {
        title: "‚ö´ Inactive Agents",
        class: "inactive",
        icon: "‚ö´",
      },
    };

    const config = threatConfig[threatLevel];

    return `
    <div class="threat-section">
        <div class="threat-section-header ${config.class}">
            <span>${config.icon} ${config.title}</span>
            <span class="threat-section-count">${
              agents.length
            } agents</span>
        </div>
        <div class="agents-grid">
            ${agents
              .map((agent) => renderAgentCard(agent, threatLevel))
              .join("")}
        </div>
    </div>
`;
  }

/*
  // Render Agent Card
  function renderAgentCard(agent, threatLevel) {
    const threatClass = threatLevel === "inactive" ? "inactive" :
                        threatLevel === "none" ? "inactive" : threatLevel;

    const hostname = agent.agentHostname || `Agent ${agent.agentId || '??'}`;
    const ocrEnabled = !!agent.ocrEnabled;
    const threatScore = (agent.currentThreatScore !== undefined && agent.currentThreatScore !== null) ? Number(agent.currentThreatScore).toFixed(1) : '0.0';
    const violations24h = agent.violationsLast24h || 0;
    const lastScreenshot = agent.lastScreenshotTime ? formatLastActivity(agent.lastScreenshotTime) : 'Never';
    const agentId = agent.agentId ?? 'undefined';

    return `
    <div class="agent-card-enhanced ${threatClass}-threat" onclick="openAgentOcrDetails(${
      agent.agentId
    })">
        <div class="agent-card-header">
            <div class="agent-name">${
              agent.agentHostname || `Agent ${agent.agentId}`
            }</div>
            <span class="agent-status-badge ${
              agent.ocrEnabled ? "status-active" : "status-inactive"
            }">
                ${agent.ocrEnabled ? "ACTIVE" : "INACTIVE"}
            </span>
        </div>

        <div class="agent-stats-row">
            <div class="agent-stat-item">
                <span class="stat-label-small">Threat Score</span>
                <span class="stat-value threat-score-value">${
                  agent.currentThreatScore?.toFixed(1) || 0
                }/100</span>
            </div>
            <div class="agent-stat-item">
                <span class="stat-label-small">Violations (24h)</span>
                <span class="stat-value">${
                  agent.violationsLast24h || 0
                }</span>
            </div>
        </div>

        <div class="agent-stats-row">
            <div class="agent-stat-item">
                <span class="stat-label-small">OCR Status</span>
                <span class="stat-value">${
                  agent.ocrEnabled ? "‚úÖ Enabled" : "‚ùå Disabled"
                }</span>
            </div>
            <div class="agent-stat-item">
                <span class="stat-label-small">Last Screenshot</span>
                <span class="stat-value">${formatLastActivity(
                  agent.lastScreenshotTime
                )}</span>
            </div>
        </div>

        <div class="agent-card-footer">
            <span class="last-activity">Click to view details</span>
            <button class="view-details-btn" onclick="event.stopPropagation(); openAgentOcrDetails(${
              agent.agentId
            })">
                üîç View Details
            </button>
        </div>
    </div>
`;
  }
*/
/*
// Render Agent Card
function renderAgentCard(agent, threatLevel) {
    const threatClass = threatLevel === "inactive" ? "inactive" :
                        threatLevel === "none" ? "inactive" : threatLevel;

    const hostname = agent.agentHostname || `Agent ${agent.agentId || '??'}`;
    const ocrEnabled = !!agent.ocrEnabled;
    const threatScore = (agent.currentThreatScore !== undefined && agent.currentThreatScore !== null) ?
                       Number(agent.currentThreatScore).toFixed(1) : '0.0';
    const violations24h = agent.violationsLast24h || 0;
    const lastScreenshot = agent.lastScreenshotTime ? formatLastActivity(agent.lastScreenshotTime) : 'Never';

    return `
    <div class="agent-card-enhanced ${threatClass}-threat" onclick="openAgentOcrDetails(${agent.agentId})">
        <div class="agent-card-header">
            <div class="agent-name">${hostname}</div>
            <span class="agent-status-badge ${ocrEnabled ? "status-active" : "status-inactive"}">
                ${ocrEnabled ? "ACTIVE" : "INACTIVE"}
            </span>
        </div>

        <div class="agent-stats-row">
            <div class="agent-stat-item">
                <span class="stat-label-small">Threat Score</span>
                <span class="stat-value threat-score-value">${threatScore}/100</span>
            </div>
            <div class="agent-stat-item">
                <span class="stat-label-small">Violations (24h)</span>
                <span class="stat-value">${violations24h}</span>
            </div>
        </div>

        <div class="agent-stats-row">
            <div class="agent-stat-item">
                <span class="stat-label-small">OCR Status</span>
                <span class="stat-value">${ocrEnabled ? "‚úÖ Enabled" : "‚ùå Disabled"}</span>
            </div>
            <div class="agent-stat-item">
                <span class="stat-label-small">Last Screenshot</span>
                <span class="stat-value">${lastScreenshot}</span>
            </div>
        </div>

        <div class="agent-card-footer">
            <span class="last-activity">Agent ID: ${agent.agentId}</span>
            <button class="view-details-btn" onclick="event.stopPropagation(); openAgentOcrDetails(${agent.agentId})">
                üîç View Details
            </button>
        </div>
    </div>
    `;
}
*/
// Render Agent Card
function renderAgentCard(agent, threatLevel) {
    const threatClass = threatLevel === "inactive" ? "inactive" :
                        threatLevel === "none" ? "inactive" : threatLevel;

    // Get username (fallback to hostname, then to agent ID)
    const username = agent.agent_username || agent.agentUsername ||
                     agent.agent_hostname || agent.agentHostname ||
                     `Agent ${agent.agent_id || agent.agentId || '??'}`;

    // Map API snake_case to camelCase
    const hostname = agent.agent_hostname || agent.agentHostname || username;
    const ocrEnabled = !!(agent.ocr_enabled !== undefined ? agent.ocr_enabled : agent.ocrEnabled);
    const threatScore = (agent.current_threat_score !== undefined ? agent.current_threat_score :
                        (agent.currentThreatScore !== undefined ? agent.currentThreatScore : 0));
    const threatScoreFormatted = Number(threatScore).toFixed(1);

    // Get threat arrow and calculate trend color based on threat score
    const threatArrow = agent.threatArrow || "‚Üí";
    const trendColor = getTrendColor(threatScore, threatArrow);

    const violations24h = agent.violations_last_24h || agent.violationsLast24h || 0;
    const lastScreenshot = agent.last_screenshot_time || agent.lastScreenshotTime ?
                          formatLastActivity(agent.last_screenshot_time || agent.lastScreenshotTime) : 'Never';

    const agentId = agent.agent_id || agent.agentId || '??';

    // Calculate runtime state based on heartbeat or other logic
    let runtimeState = agent.runtimeState || "ONLINE"; // Default to ONLINE if not specified
    let runtimeStateClass = "status-online";

    // Map runtime states to CSS classes
    switch(runtimeState.toUpperCase()) {
        case "ONLINE":
            runtimeStateClass = "status-online";
            break;
        case "OFFLINE":
            runtimeStateClass = "status-offline";
            break;
        case "IDLE":
        case "LOCKED":
            runtimeStateClass = "status-idle";
            break;
        default:
            runtimeStateClass = "status-inactive";
    }

    return `
    <div class="agent-card-enhanced ${threatClass}-threat" onclick="openAgentOcrDetails(${agentId})">
        <div class="agent-card-header">
            <div class="agent-name">${username}</div>
            <span class="agent-status-badge ${runtimeStateClass}">
                ${runtimeState}
            </span>
        </div>

        <div class="agent-stats-row">
            <div class="agent-stat-item">
                <span class="stat-label-small">Threat Score</span>
                <div class="threat-score-container">
                    <span class="stat-value threat-score-value">${threatScoreFormatted}/100</span>
                    ${threatArrow ? `
                        <span class="trend-arrow" style="color: ${trendColor}" title="${getTrendTitle(threatArrow)}">
                            ${threatArrow}
                        </span>
                    ` : ''}
                </div>
            </div>
            <div class="agent-stat-item">
                <span class="stat-label-small">Violations (24h)</span>
                <span class="stat-value">${violations24h}</span>
            </div>
        </div>

        <div class="agent-stats-row">
            <div class="agent-stat-item">
                <span class="stat-label-small">OCR Status</span>
                <span class="stat-value">${ocrEnabled ? "‚úÖ Enabled" : "‚ùå Disabled"}</span>
            </div>
            <div class="agent-stat-item">
                <span class="stat-label-small">Last Screenshot</span>
                <span class="stat-value">${lastScreenshot}</span>
            </div>
        </div>

        <div class="agent-card-footer">
            <span class="last-activity">Agent ID: ${agentId}</span>
            <button class="view-details-btn" onclick="event.stopPropagation(); openAgentOcrDetails(${agentId})">
                üîç View Details
            </button>
        </div>
    </div>
    `;
}

// Helper function to get trend title
function getTrendTitle(arrow) {
    switch(arrow) {
        case "‚Üë": return "Threat increasing";
        case "‚Üì": return "Threat decreasing";
        case "‚Üí": return "Threat stable";
        default: return "No trend data";
    }
}

// Helper function to get trend color based on threat score and arrow
function getTrendColor(threatScore, arrow) {
    // If threat is increasing (‚Üë) and score is already high, make it more alarming
    if (arrow === "‚Üë") {
        if (threatScore >= 70) return "#ff4444"; // Bright red
        if (threatScore >= 40) return "#ff8800"; // Orange
        return "#ffaa00"; // Yellow
    }

    // If threat is decreasing (‚Üì), use calming colors
    if (arrow === "‚Üì") {
        if (threatScore >= 70) return "#cc0000"; // Darker red
        if (threatScore >= 40) return "#e68900"; // Darker orange
        return "#999999"; // Gray
    }

    // Stable (‚Üí) or no arrow
    if (threatScore >= 70) return "#cc0000"; // Dark red
    if (threatScore >= 40) return "#e68900"; // Orange
    if (threatScore >= 20) return "#ffcc00"; // Yellow
    return "#999999"; // Gray
}

// Helper function to format "X time ago"
function formatLastActivity(timestamp) {
    if (!timestamp) return 'Never';

    const now = new Date();
    const past = new Date(timestamp);
    const diffMs = now - past;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);

    if (diffMins < 1) return 'Just now';
    if (diffMins < 60) return `${diffMins}m ago`;
    if (diffHours < 24) return `${diffHours}h ago`;
    return `${diffDays}d ago`;
}
  // --- Enhanced Agent OCR Details Modal ---
  async function openAgentOcrDetails(agentId) {
    if (!agentId || agentId === 'undefined') {
      showToast('Invalid agent ID', 'error');
      return;
    }

    try {
      // Load required data in parallel
      console.log(`üìä Loading OCR details for agent ${agentId}...`);
      let liveResult;
            try {
                liveResult = await callApi(`/api/admin/ocr/live/${agentId}`);
            } catch (liveError) {
                console.warn(`Could not load live OCR data: ${liveError.message}`);
                liveResult = { success: false, data: [] };
            }
      const [
        violationsResult,
        latestCertResult,
        allCertsResult,
      ] = await Promise.all([
        callApi(`/api/admin/ocr/violations/${agentId}`),
        callApi(`/api/admin/ocr/certificate/${agentId}/latest`),
        callApi(`/api/admin/ocr/certificate/${agentId}/all`),
      ]);

      const liveData = liveResult?.success ? liveResult.data : [];
      const violations = violationsResult?.data || [];
      const latestCertificate = latestCertResult?.data;
      const allCertificates = allCertsResult?.data || [];

      // Create modal content with certificate area
      const hostname = getAgentName(agentId) || `Agent ${agentId}`;

      const modalHtml = `
        <div class="agent-ocr-dashboard">
            <div class="dashboard-header">
                <h3>üß† OCR Details - ${hostname} (ID: ${agentId})</h3>
            </div>

            <div style="display:flex; gap:12px; align-items:center; margin-top:10px;">
                <label style="font-weight:600;">Select Certificate:</label>
                <select id="certificateSelector" style="flex:1; padding:8px; border-radius:6px; border:1px solid var(--gray-light);">
                    ${
                      allCertificates.length === 0
                        ? '<option value="">-- No certificates --</option>'
                        : allCertificates
                            .map(
                              (c) =>
                                `<option value="${c.id}">${new Date(
                                  c.assessmentTime
                                ).toLocaleString()} ‚Äî ${
                                  c.threatLevel || "UNKNOWN"
                                } ‚Äî ${
                                  c.threatScore?.toFixed
                                    ? c.threatScore.toFixed(1)
                                    : c.threatScore
                                }</option>`
                            )
                            .join("")
                    }
                </select>
                <button class="btn btn-sm btn-primary" id="viewCertBtn">View</button>
                <button class="btn btn-sm" id="downloadCertBtn">üìÑ Download</button>
            </div>

            <div id="certificateDetailsContainer" style="margin-top:20px;">
                <!-- Certificate details will be injected here -->
            </div>

            <hr />

            <div class="modal-sections" style="margin-top:10px;">
                <div class="modal-section" style="min-height:200px;">
                    <h4>üìä Quick Stats</h4>
                    <div class="quick-stats-grid">
                        <div class="quick-stat-card">
                            <div class="stat-number-compact">${
                              liveData.length
                            }</div>
                            <div class="stat-label-compact">Active Screenshots</div>
                        </div>
                        <div class="quick-stat-card">
                            <div class="stat-number-compact">${
                              violations.length
                            }</div>
                            <div class="stat-label-compact">Total Violations</div>
                        </div>
                        <div class="quick-stat-card">
                            <div class="stat-number-compact">${
                              latestCertificate ? "‚úÖ" : "‚ùå"
                            }</div>
                            <div class="stat-label-compact">Certificate</div>
                        </div>
                        <div class="quick-stat-card">
                            <div class="stat-number-compact">${new Date().getHours()}:${new Date().getMinutes()}</div>
                            <div class="stat-label-compact">Last Updated</div>
                        </div>
                    </div>
                </div>

                <div class="modal-section">
                    <h4>üö® Recent Violations</h4>
                    ${renderViolationsList(violations.slice(0, 10))}
                </div>

               <div class="modal-section">
              <h4>üìù Recent OCR Extractions</h4>
              ${liveData.length > 0
                  ? renderOcrExtractionsList(liveData.slice(0, 5))
                  : '<div class="empty-state">No recent OCR data available or service temporarily unavailable.</div>'
              }
          </div>
            </div>

            <div style="text-align:center; margin-top:12px;">
                <button class="btn btn-primary" onclick="refreshAgentOcrDetails(${agentId})">üîÑ Refresh Details</button>
            </div>
        </div>
    `;

      // Show modal
      const modal = document.createElement("div");
      modal.className = "modal-overlay";
      modal.innerHTML = `
        <div class="modal-content agent-ocr-modal">
            <button class="modal-close" onclick="this.parentElement.parentElement.remove()">√ó</button>
            ${modalHtml}
        </div>
    `;
      document.body.appendChild(modal);

      // Wire up selector + buttons
      const selector = document.getElementById("certificateSelector");
      const viewBtn = document.getElementById("viewCertBtn");
      const downloadBtn = document.getElementById("downloadCertBtn");

      // If dropdown has value, show first certificate immediately
      if (selector && selector.value) {
        await loadAndRenderCertificateDetails(selector.value);
      }

      selector?.addEventListener("change", async (e) => {
        const certId = e.target.value;
        await loadAndRenderCertificateDetails(certId);
      });

      viewBtn?.addEventListener("click", async () => {
        const certId = selector?.value;
        if (!certId) {
          showToast("No certificate selected", "warning");
          return;
        }
        await loadAndRenderCertificateDetails(certId);
      });

      downloadBtn?.addEventListener("click", async () => {
        const certId = selector?.value;
        if (!certId) {
          showToast("No certificate selected", "warning");
          return;
        }
        downloadCertificateById(certId);
      });
    } catch (error) {
      console.error("Failed to open agent OCR details:", error);
      showToast(
        `Failed to load agent OCR details: ${error.message}`,
        "error"
      );
    }
  }

  async function loadAndRenderCertificateDetails(certId) {
    if (!certId) {
      document.getElementById("certificateDetailsContainer").innerHTML =
        '<div class="empty-state">Select a certificate to view details.</div>';
      return;
    }
    try {
      const result = await callApi(
        `/api/admin/ocr/certificate/view/${certId}`
      );
      if (!result || !result.success)
        throw new Error(result?.message || "Failed to fetch certificate");

      const payload = result.data || {};
      const cert = payload.certificate;
      const violations = payload.violations || [];

      // Render top certificate summary
      const expiresAtDisplay = cert.expiresAt
        ? new Date(cert.expiresAt).toLocaleString()
        : "N/A";
      const createdAtDisplay = cert.createdAt
        ? new Date(cert.createdAt).toLocaleString()
        : cert.assessmentTime
        ? new Date(cert.assessmentTime).toLocaleString()
        : "N/A";

      const certHtml = `
        <div class="certificate-summary ${getThreatClass(
          cert.threatScore || 0
        )}">
            <div class="certificate-header">
                <div class="certificate-emoji">${cert.emoji || "üìã"}</div>
                <div class="certificate-title">
                    <h4>${cert.threatLevel || "NO_THREAT"} Certificate</h4>
                    <div class="certificate-subtitle">Generated: ${createdAtDisplay}</div>
                </div>
            </div>

            <div class="certificate-details-grid" style="margin-top:12px;">
                <div><strong>Agent ID:</strong><br/>${cert.agentId}</div>
                <div><strong>Device:</strong><br/>${
                  cert.userDevice || "N/A"
                }</div>
                <div><strong>Threat Level:</strong><br/>${
                  cert.threatLevel || "UNKNOWN"
                }</div>
                <div><strong>Threat Score:</strong><br/>${
                  cert.threatScore !== undefined
                    ? (cert.threatScore.toFixed
                        ? cert.threatScore.toFixed(1)
                        : cert.threatScore) + "/100"
                    : "N/A"
                }</div>
                <div><strong>Primary Context:</strong><br/>${
                  cert.primaryContext || "N/A"
                }</div>
                <div><strong>Total Violations:</strong><br/>
                ${violations.length}
                </div>
                <div><strong>Created At:</strong><br/>${createdAtDisplay}</div>
                <div><strong>Expires At:</strong><br/>${expiresAtDisplay} <div style="font-size:0.9em; color:var(--gray);" id="certExpiryTimer-${
        cert.id
      }"></div></div>
            </div>

            ${
              cert.riskAnalysis
                ? `<div class="risk-analysis" style="margin-top:12px;"><strong>Risk Analysis:</strong> ${escapeHtml(
                    cert.riskAnalysis
                  )}</div>`
                : ""
            }

            ${
              cert.immediateActions && cert.immediateActions.length > 0
                ? `<div style="margin-top:12px;"><strong>Immediate Actions:</strong><ul>${cert.immediateActions
                    .map((a) => `<li>${escapeHtml(a)}</li>`)
                    .join("")}</ul></div>`
                : ""
            }

            <div style="margin-top:12px; text-align:center;">
                <button class="btn btn-primary" onclick="downloadCertificateById(${
                  cert.id
                })" ${!cert.certificateFilePath ? "disabled" : ""}>
                    <span>üìÑ</span><span>Download PDF</span>
                </button>
            </div>
        </div>

        <div style="margin-top:16px;">
            <h4>üîé Violations included in this certificate (${
              violations.length
            })</h4>
            ${
              violations.length === 0
                ? '<div class="empty-state">No violations attached to this certificate.</div>'
                : `
                <div class="violations-list-container">
                    ${violations
                      .map(
                        (v) => `
                        <div class="violation-item-enhanced ${getConfidenceClass(
                          v.confidence
                        )}">
                            <div class="violation-header-enhanced">
                                <span class="rule-badge ${
                                  v.ruleType?.toLowerCase() || "unknown"
                                }">${v.ruleType || "UNKNOWN"}</span>
                                <span class="violation-timestamp">${new Date(
                                  v.timestamp
                                ).toLocaleString()}</span>
                            </div>
                            <div class="matched-text">"${escapeHtml(
                              v.matchedText || "No text"
                            )}"</div>
                            <div class="confidence-bars">
                                <div class="confidence-item"><span>Confidence:</span><span class="confidence-value ${getConfidenceClass(
                                  v.confidence
                                )}">${((v.confidence || 0) * 100).toFixed(
                          1
                        )}%</span></div>
                                <div class="confidence-item"><span>Context:</span><span class="confidence-value ${getConfidenceClass(
                                  v.contextConfidence
                                )}">${(
                          (v.contextConfidence || 0) * 100
                        ).toFixed(1)}%</span></div>
                            </div>
                            <div style="margin-top:8px; display:flex; gap:8px; align-items:center;">
                                <button class="btn btn-sm btn-primary" onclick="viewViolationScreenshot('${
                                  v.screenshotPath || ""
                                }')">üëÅÔ∏è View</button>
                                <button class="btn btn-sm" onclick="showViolationDetails(${
                                  v.id
                                })">Details</button>
                            </div>
                        </div>
                    `
                      )
                      .join("")}
                </div>
            `
            }
        </div>
    `;

      document.getElementById("certificateDetailsContainer").innerHTML =
        certHtml;

      // Start expiry timer update if expiresAt present
      if (cert.expiresAt) {
        startCertificateExpiryTimer(cert.id, cert.expiresAt);
      }
    } catch (e) {
      console.error(e);
      document.getElementById(
        "certificateDetailsContainer"
      ).innerHTML = `<div class="empty-state" style="color:var(--danger);">Failed to load certificate: ${e.message}</div>`;
    }
  }

  function downloadCertificateById(certId) {
    if (!certId) {
      showToast("No certificate selected", "warning");
      return;
    }
    const url = `/api/admin/ocr/certificate/download/${certId}`;
    window.open(url, "_blank");
  }

   // Render Certificate Summary
      function renderCertificateSummary(certificate, threatClass) {
        return `
        <div class="certificate-summary ${threatClass}">
            <div class="certificate-header">
                <div class="certificate-emoji">${
                  certificate.emoji || "üìã"
                }</div>
                <div class="certificate-title">
                    <h4>${
                      certificate.threatLevel || "NO THREAT"
                    } Certificate</h4>
                    <div class="certificate-subtitle">
                        Generated: ${new Date(
                          certificate.assessmentTime
                        ).toLocaleString()}
                    </div>
                </div>
            </div>

            <div class="certificate-stats">
                <div class="certificate-stat">
                    <div class="certificate-stat-label">Threat Score</div>
                    <div class="certificate-stat-value">${
                      certificate.threatScore?.toFixed(1) || 0
                    }/100</div>
                </div>
                <div class="certificate-stat">
                    <div class="certificate-stat-label">Total Violations</div>
                    <div class="certificate-stat-value">${
                      certificate.totalViolations || 0
                    }</div>
                </div>
                <div class="certificate-stat">
                    <div class="certificate-stat-label">Primary Context</div>
                    <div class="certificate-stat-value">${
                      certificate.primaryContext || "Unknown"
                    }</div>
                </div>
                <div class="certificate-stat">
                    <div class="certificate-stat-label">Certificate ID</div>
                    <div class="certificate-stat-value" style="font-size: 0.9em;">${
                      certificate.certificateId?.substring(0, 8) || "N/A"
                    }</div>
                </div>
            </div>

            ${
              certificate.riskAnalysis
                ? `
            <div class="risk-analysis">
                <strong>Risk Analysis:</strong> ${certificate.riskAnalysis}
            </div>
            `
                : ""
            }
        </div>
    `;
      }

      // Render No Certificate Message
      function renderNoCertificate() {
        return `
        <div class="certificate-summary low" style="text-align: center; padding: 30px;">
            <div class="certificate-emoji" style="font-size: 3em; margin-bottom: 15px;">üìÑ</div>
            <h4>No Certificate Available</h4>
            <p style="color: var(--gray); margin-top: 10px;">
                No security certificate has been generated for this agent yet.
            </p>
        </div>
    `;
      }

      // function normalizeViolation(v) {
      //   return {
      //     id: v.id,
      //     ruleType: v.ruleType || v.rule_type || "Not Available",
      //     matchedText: v.matchedText || v.matched_text || "No text...",
      //     confidence: v.confidence ?? 0,
      //     contextConfidence: v.contextConfidence ?? v.context_confidence ?? 0,
      //     screenshotPath: v.screenshotPath || v.screenshot_path || null,
      //     timestamp: v.timestamp || "N/A",
      //   };
      // }

      function normalizeViolation(v) {
      return {
          id: v.id,
          ruleType: v.rule_type ?? v.ruleType ?? "UNKNOWN",
          matchedText: v.matched_text ?? v.matchedText ?? "No text...",
          confidence: v.confidence ?? 0,
          contextConfidence: v.context_confidence ?? v.contextConfidence ?? 0,
          screenshotPath: v.screenshot_path ?? v.screenshotPath ?? null,
          timestamp: v.timestamp ?? "N/A",
          // Add both formats for compatibility
          rule_type: v.rule_type ?? v.ruleType ?? "UNKNOWN",
          matched_text: v.matched_text ?? v.matchedText ?? "No text...",
          context_confidence: v.context_confidence ?? v.contextConfidence ?? 0,
          screenshot_path: v.screenshot_path ?? v.screenshotPath ?? null
      };
  }

      // Render Violations List
    //   function renderViolationsList(violations) {

    //     violations = violations.map(normalizeViolation);
    //     if (violations.length === 0) {
    //       return '<div class="empty-state">No violations detected for this agent.</div>';
    //     }

    //     return `
    //     <div class="violations-list-container">
    //         ${violations
    //           .map(
    //             (violation) => `
    //             <div class="violation-item-enhanced ${getConfidenceClass(
    //               violation.confidence
    //             )}">
    //                 <div class="violation-header-enhanced">
    //                     <span class="rule-badge ${
    //                       violation.ruleType?.toLowerCase() || "unknown"
    //                     }">
    //                         ${violation.ruleType || "UNKNOWN"}
    //                     </span>
    //                     <span class="violation-timestamp">
    //                         ${new Date(
    //                           violation.timestamp
    //                         ).toLocaleTimeString()}
    //                     </span>
    //                 </div>
    //                 <div class="matched-text">"${
    //                   violation.matchedText?.substring(0, 100) || "No text"
    //                 }..."</div>
    //                 <div class="confidence-bars">
    //                     <div class="confidence-item">
    //                         <span>Confidence:</span>
    //                         <span class="confidence-value ${getConfidenceClass(
    //                           violation.confidence
    //                         )}">
    //                             ${(violation.confidence * 100).toFixed(1)}%
    //                         </span>
    //                     </div>
    //                     <div class="confidence-item">
    //                         <span>Context:</span>
    //                         <span class="confidence-value ${getConfidenceClass(
    //                           violation.contextConfidence
    //                         )}">
    //                             ${(violation.contextConfidence * 100).toFixed(
    //                               1
    //                             )}%
    //                         </span>
    //                     </div>
    //                 </div>
    //             </div>
    //         `
    //           )
    //           .join("")}
    //     </div>
    // `;
      // }
      function renderViolationsList(violations) {
    if (!violations || violations.length === 0) {
        return '<div class="empty-state">No violations detected for this agent.</div>';
    }

    // Normalize all violations
    const normalized = violations.map(normalizeViolation);

    return `
    <div class="violations-list-container">
        ${normalized.map(violation => {
            // Safely get values with fallbacks
            const ruleType = violation.ruleType || violation.rule_type || "UNKNOWN";
            const matchedText = violation.matchedText || violation.matched_text || "No text";
            const confidence = parseFloat(violation.confidence || 0);
            const contextConfidence = parseFloat(violation.contextConfidence || violation.context_confidence || 0);

            return `
            <div class="violation-item-enhanced ${getConfidenceClass(confidence)}">
                <div class="violation-header-enhanced">
                    <span class="rule-badge ${ruleType.toLowerCase().replace(/_/g, '-')}">
                        ${ruleType}
                    </span>
                    <span class="violation-timestamp">
                        ${new Date(violation.timestamp).toLocaleTimeString()}
                    </span>
                </div>
                <div class="matched-text">"${escapeHtml(matchedText.substring(0, 100))}${matchedText.length > 100 ? '...' : ''}"</div>
                <div class="confidence-bars">
                    <div class="confidence-item">
                        <span>Confidence:</span>
                        <span class="confidence-value ${getConfidenceClass(confidence)}">
                            ${(confidence * 100).toFixed(1)}%
                        </span>
                    </div>
                    <div class="confidence-item">
                        <span>Context:</span>
                        <span class="confidence-value ${getConfidenceClass(contextConfidence)}">
                            ${(contextConfidence * 100).toFixed(1)}%
                        </span>
                    </div>
                </div>
            </div>
            `;
        }).join('')}
    </div>
    `;
}

      // Render OCR Extractions List
      function renderOcrExtractionsList(extractions) {
        if (extractions.length === 0) {
          return '<div class="empty-state">No OCR extractions available.</div>';
        }

        return `
        <div class="ocr-extractions-list">
            ${extractions
              .map(
                (extraction) => `
                <div class="extraction-item">
                    <div class="extraction-header">
                        <span style="font-weight: 600;">OCR Extraction</span>
                        <span class="violation-timestamp">
                            ${new Date(
                              extraction.timestamp
                            ).toLocaleTimeString()}
                        </span>
                    </div>
                    <div class="extraction-meta">
                        <span class="meta-badge">${
                          extraction.language || "Unknown"
                        }</span>
                        <span>Readability: ${
                          extraction.readabilityScore?.toFixed(1) || 0
                        }</span>
                        <span>Context: ${
                          extraction.primaryContext || "Unknown"
                        }</span>
                    </div>
                    <div class="extracted-text-preview">
                        ${escapeHtml(
                          extraction.extractedText?.substring(0, 200) ||
                            "No text extracted"
                        )}
                        ${extraction.extractedText?.length > 200 ? "..." : ""}
                    </div>
                </div>
            `
              )
              .join("")}
        </div>
    `;
      }

      function downloadCertificatePdf(filePath) {
        if (!filePath) {
          showToast("No PDF file available for this certificate", "warning");
          return;
        }

        const downloadUrl = `/api/admin/ocr/certificate/download?path=${encodeURIComponent(
          filePath
        )}`;
        window.open(downloadUrl, "_blank");
      }

      // <!--// Show Agent OCR Modal-->
      // <!--function showAgentOcrModal(agentId, liveData, violations, latestCertificate, allCertificates) {-->
      // <!--    const agent = agentsCache.find(a => a.id === agentId);-->
      // <!--    const hostname = agent?.hostname || `Agent ${agentId}`;-->
      // <!--    const threatClass = getThreatClass(latestCertificate?.threatScore || 0);-->

      // <!--    const content = createAgentOcrModalContent(-->
      // <!--        agentId,-->
      // <!--        hostname,-->
      // <!--        liveData,-->
      // <!--        violations,-->
      // <!--        latestCertificate,-->
      // <!--        allCertificates,-->
      // <!--        threatClass-->
      // <!--    );-->

      // <!--    const modal = document.createElement('div');-->
      // <!--    modal.className = 'modal-overlay';-->
      // <!--    modal.innerHTML = `-->
      // <!--        <div class="modal-content agent-ocr-modal">-->
      // <!--            <button class="modal-close" onclick="this.parentElement.parentElement.remove()">√ó</button>-->
      // <!--            ${content}-->
      // <!--            <div class="action-buttons" style="margin-top: 20px; justify-content: center;">-->
      // <!--                <button class="btn btn-primary" onclick="this.parentElement.parentElement.parentElement.remove(); openAgentOcrDetails(${content.match(/Agent (\d+)/)?.[1] || '0'})">-->
      // <!--                    <span>üîÑ</span>-->
      // <!--                    <span>Refresh Details</span>-->
      // <!--                </button>-->
      // <!--            </div>-->
      // <!--        </div>-->
      // <!--    `;-->

      // <!--    document.body.appendChild(modal);-->
      // <!--}-->

      function showAgentOcrModal(
        agentId,
        contentHtml,
        latestCertificate,
        allCertificates
      ) {
        const modal = document.createElement("div");
        modal.className = "modal-overlay";

        modal.innerHTML = `
        <div class="modal-content agent-ocr-modal">
            <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">√ó</button>
            ${contentHtml}
            <div class="action-buttons" style="margin-top: 20px; justify-content: center;">
                <button class="btn btn-primary" onclick="this.closest('.modal-overlay').remove(); openAgentOcrDetails(${agentId})">
                    <span>üîÑ</span>
                    <span>Refresh Details</span>
                </button>
            </div>
        </div>
    `;

        document.body.appendChild(modal);

        // Inject latest certificate HTML
        const latestDiv = modal.querySelector("#cert-latest");
        if (latestDiv) {
          latestDiv.innerHTML = renderLatestCertificate(latestCertificate);
        }

        // Inject history list
        const historyDiv = modal.querySelector("#cert-history");
        if (historyDiv) {
          historyDiv.innerHTML = renderCertificateHistory(allCertificates);
        }

        // Start expiry countdown timer
        if (latestCertificate) {
          startCertificateExpiryTimer(
            latestCertificate.id,
            latestCertificate.expiresAt
          );
        }
      }

      function renderLatestCertificate(cert) {
        if (!cert) {
          return `
            <div class="certificate-summary low" style="text-align:center; padding: 30px;">
                <div class="certificate-emoji" style="font-size:3em; margin-bottom:15px;">üìÑ</div>
                <h4>No Certificate Available</h4>
                <p style="color: var(--gray); margin-top:10px;">
                    No security certificate has been generated for this agent yet.
                </p>
            </div>
        `;
        }

        const createdAt = cert.assessmentTime
          ? new Date(cert.assessmentTime).toLocaleString()
          : cert.createdAt
          ? new Date(cert.createdAt).toLocaleString()
          : "Unknown";

        const expiresAt = cert.expiresAt
          ? new Date(cert.expiresAt).toLocaleString()
          : "N/A";

        const threatClass = getThreatClass(cert.threatScore || 0); // 'high-threat' / 'medium-threat' / 'low-threat'

        return `
        <div class="certificate-summary full-view ${threatClass}">
            <div class="certificate-header">
                <div class="certificate-emoji">${cert.emoji || "üìÑ"}</div>
                <div class="certificate-title">
                    <h4>${cert.threatLevel || "NO_THREAT"} Certificate</h4>
                    <div class="certificate-subtitle">
                        Generated: ${createdAt}
                    </div>
                </div>
            </div>

            <div class="certificate-details-grid">
                <div>
                    <strong>Agent ID:</strong><br>
                    ${cert.agentId}
                </div>
                <div>
                    <strong>Device:</strong><br>
                    ${cert.userDevice || "Unknown"}
                </div>
                <div>
                    <strong>Threat Level:</strong><br>
                    ${cert.threatLevel || "UNKNOWN"}
                </div>
                <div>
                    <strong>Threat Score:</strong><br>
                    ${(cert.threatScore ?? 0).toFixed(1)}/100
                </div>
                <div>
                    <strong>Primary Context:</strong><br>
                    ${cert.primaryContext || "Unknown"}
                </div>
                <div>
                    <strong>Total Violations:</strong><br>
<!--                    ${cert.totalViolations || 0}-->
${
                       violations.length
                    }
                </div>
                <div>
                    <strong>Created At:</strong><br>
                    ${createdAt}
                </div>
                <div>
                    <strong>Expires At:</strong><br>
                    ${expiresAt}<br>
                    <span style="font-size:0.85em; color:var(--gray);">
<!--                        Auto delete in: <span id="certificateExpiryCountdown">calculating...</span>-->
                    <span id="certExpiryTimer-${cert.id}">calculating...</span>

                    </span>
                </div>

                ${
                  cert.riskAnalysis
                    ? `
                <div class="risk-analysis full-width">
                    <strong>Risk Analysis:</strong> ${cert.riskAnalysis}
                </div>`
                    : ""
                }

                ${
                  cert.immediateActions && cert.immediateActions.length > 0
                    ? `
                <div class="risk-analysis full-width">
                    <strong>Immediate Actions:</strong>
                    <ul style="margin-top: 8px; padding-left: 20px;">
                        ${cert.immediateActions
                          .map((a) => `<li>${a}</li>`)
                          .join("")}
                    </ul>
                </div>`
                    : ""
                }
            </div>

            <div style="text-align:center; margin-top:20px;">
                <button class="btn btn-primary"
                        onclick="downloadCertificatePdf('${
                          cert.certificateFilePath || ""
                        }')"
                        ${!cert.certificateFilePath ? "disabled" : ""}>
                    <span>üìÑ</span>
                    <span>Download PDF</span>
                </button>
            </div>
        </div>
    `;
      }

      function renderCertificateHistory(list) {
        if (!list || list.length === 0) {
          return `<div class="empty-state">No certificate history found.</div>`;
        }

        return `
        <div class="certificate-history-list">
            ${list
              .map((cert) => {
                const createdAt = cert.assessmentTime
                  ? new Date(cert.assessmentTime).toLocaleString()
                  : cert.createdAt
                  ? new Date(cert.createdAt).toLocaleString()
                  : "Unknown";
                const cls = getThreatClass(cert.threatScore || 0);
                return `
                    <div class="certificate-history-item ${cls}">
                        <div>
                            <strong>${createdAt}</strong>
                            <p style="margin:5px 0; font-size:0.9em;">
                                ${cert.threatLevel || "UNKNOWN"} ‚Äî Score: ${(
                  cert.threatScore ?? 0
                ).toFixed(1)}
                            </p>
                            <p style="font-size:0.8em; color: var(--gray);">
                                ${cert.primaryContext || "No context"}
                            </p>
                        </div>
                        <div style="display:flex; flex-direction:column; gap:6px;">
                            <button class="btn btn-sm" onclick="viewCertificateFromHistory(${
                              cert.id
                            })">
                                <span>üëÅÔ∏è</span>
                                <span>View</span>
                            </button>
                            <button class="btn btn-sm" onclick="downloadCertificatePdf('${
                              cert.certificateFilePath || ""
                            }')"
                                    ${
                                      !cert.certificateFilePath
                                        ? "disabled"
                                        : ""
                                    }>
                                <span>üìÑ</span>
                                <span>Download</span>
                            </button>
                        </div>
                    </div>
                `;
              })
              .join("")}
        </div>
    `;
      }

      // expiry timer: shows countdown or "Expired"
      function startCertificateExpiryTimer(certId, expiresAtIso) {
        if (!certId || !expiresAtIso) return;

        const elId = `certExpiryTimer-${certId}`;
        const el = document.getElementById(elId);
        if (!el) {
          console.warn("Timer element not found:", elId);
          return;
        }
        let interval = null; // ‚Üê declare
        function update() {
          const now = new Date();
          const exp = new Date(expiresAtIso);
          const diff = exp - now;
          if (diff <= 0) {
            el.textContent = "Expired (auto-delete pending)";
            clearInterval(interval);
            return;
          }
          const mins = Math.floor(diff / (1000 * 60));
          const secs = Math.floor((diff % (1000 * 60)) / 1000);
          el.textContent = `Auto delete in: ${mins}m ${secs}s`;
        }
        interval = setInterval(update, 1000);
        update();
      }

      // View screenshot (open in new tab)
      function viewViolationScreenshot(path) {
        if (!path) {
          showToast("No screenshot available", "warning");
          return;
        }
        // If path is server-local, adjust to endpoint that serves screenshot
        // Example: /api/admin/ocr/screenshot?path=...
        const url = `/api/admin/ocr/screenshot?path=${encodeURIComponent(
          path
        )}`; // implement backend if needed
        window.open(url, "_blank");
      }

      function showViolationDetails(violationId) {
        // Optionally fetch /api/admin/ocr/violations/{id} if you have it
        showToast(
          "Open detailed violation view (implement endpoint if needed)",
          "info"
        );
      }

      function viewCertificateFromHistory(certificateId) {
        const cert = currentCertificateHistory.find(
          (c) => c.id === certificateId
        );
        if (!cert) {
          showToast("Certificate not found in history", "error");
          return;
        }

        const modal = document.querySelector(".agent-ocr-modal");
        if (!modal) return;

        const latestDiv = modal.querySelector("#cert-latest");
        if (!latestDiv) return;

        latestDiv.innerHTML = renderLatestCertificate(cert);
        startCertificateExpiryTimer(cert, modal);
        switchCertTab("latest");
      }

      /*
<!--function startCertificateExpiryTimer(cert, rootElement) {-->
<!--    if (certificateExpiryTimer) {-->
<!--        clearInterval(certificateExpiryTimer);-->
<!--        certificateExpiryTimer = null;-->
<!--    }-->

<!--    if (!cert.expiresAt) {-->
<!--        const span = (rootElement || document).querySelector('#certificateExpiryCountdown');-->
<!--        if (span) span.textContent = 'N/A';-->
<!--        return;-->
<!--    }-->

<!--    const expiry = new Date(cert.expiresAt).getTime();-->
<!--    if (isNaN(expiry)) {-->
<!--        const span = (rootElement || document).querySelector('#certificateExpiryCountdown');-->
<!--        if (span) span.textContent = 'N/A';-->
<!--        return;-->
<!--    }-->

<!--    function updateCountdown() {-->
<!--        const now = Date.now();-->
<!--        let diff = expiry - now;-->

<!--        const span = (rootElement || document).querySelector('#certificateExpiryCountdown');-->
<!--        if (!span) {-->
<!--            clearInterval(certificateExpiryTimer);-->
<!--            return;-->
<!--        }-->

<!--        if (diff <= 0) {-->
<!--            span.textContent = 'Expired (auto-delete pending)';-->
<!--            clearInterval(certificateExpiryTimer);-->
<!--            return;-->
<!--        }-->

<!--        const seconds = Math.floor(diff / 1000) % 60;-->
<!--        const minutes = Math.floor(diff / (1000 * 60)) % 60;-->
<!--        const hours = Math.floor(diff / (1000 * 60 * 60));-->

<!--        span.textContent = `${hours.toString().padStart(2,'0')}:${minutes.toString().padStart(2,'0')}:${seconds.toString().padStart(2,'0')}`;-->
<!--    }-->

<!--    updateCountdown();-->
<!--    certificateExpiryTimer = setInterval(updateCountdown, 1000);-->

<!--}-->
*/

      function switchCertTab(tab) {
        document
          .querySelectorAll(".cert-tab")
          .forEach((btn) => btn.classList.remove("active"));
        document
          .querySelectorAll(".cert-tab-content")
          .forEach((div) => div.classList.remove("active"));

        if (tab === "latest") {
          document.querySelectorAll(".cert-tab")[0]?.classList.add("active");
          document.getElementById("cert-latest")?.classList.add("active");
        } else {
          document.querySelectorAll(".cert-tab")[1]?.classList.add("active");
          document.getElementById("cert-history")?.classList.add("active");
        }
      }

      // Helper Functions
      function getThreatClass(score) {
        if (score > 70) return "high";
        if (score > 40) return "medium";
        return "low";
      }

      function getConfidenceClass(confidence) {
        if (confidence > 0.8) return "high";
        if (confidence > 0.5) return "medium";
        return "low";
      }

      function escapeHtml(text) {
        if (!text) return "";
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      // Auto-Refresh Functions
      function toggleOcrAutoRefresh() {
        const toggle = document.getElementById("ocrAutoRefresh");
        ocrAutoRefreshEnabled = toggle.checked;

        if (ocrAutoRefreshEnabled) {
          startOcrAutoRefresh();
          showToast("OCR auto-refresh enabled", "success");
        } else {
          stopOcrAutoRefresh();
          showToast("OCR auto-refresh disabled", "warning");
        }
      }

      function startOcrAutoRefresh() {
        stopOcrAutoRefresh(); // Clear any existing interval

        ocrAutoRefreshInterval = setInterval(() => {
          const activeTab = document.querySelector(".tab-content.active")?.id;
          if (activeTab === "ocr" && ocrAutoRefreshEnabled) {
            console.log("üîÑ Auto-refreshing OCR dashboard...");
            loadOcrDashboard();
          }
        }, 5000); // Refresh every 5 seconds
      }

      function stopOcrAutoRefresh() {
        if (ocrAutoRefreshInterval) {
          clearInterval(ocrAutoRefreshInterval);
          ocrAutoRefreshInterval = null;
        }
      }

      // Clean up when switching away from OCR tab
      function stopAllAutoRefresh() {
        stopAutoRefresh(); // Original dashboard refresh
        stopOcrAutoRefresh(); // OCR-specific refresh
      }

      // Update original showTab to stop OCR refresh when switching tabs
      const originalShowTab = showTab;
      window.showTab = function (tabName) {
        if (tabName !== "ocr") {
          stopOcrAutoRefresh();
        }
        return originalShowTab(tabName);
      };

      // Initialize on page load
      document.addEventListener("DOMContentLoaded", () => {
        // Add OCR tab to the showTab function
        console.log("üß† OCR Dashboard initialized");

        // Start OCR auto-refresh if OCR tab is active on load
        setTimeout(() => {
          const activeTab = document.querySelector(".tab-content.active")?.id;
          if (activeTab === "ocr") {
            startOcrAutoRefresh();
          }
        }, 1000);
      });

      // Blocklist Editor Functions
      function openBlocklistEditor(
        agentId,
        policyCode,
        hostname,
        policyDataString
      ) {
        document.getElementById(
          "blocklistEditorTitle"
        ).textContent = `Edit ${policyCode} for ${hostname}`;
        document.getElementById("editListAgentId").value = agentId;
        document.getElementById("editListPolicyCode").value = policyCode;
        document.getElementById("editListHostname").value = hostname;
        document.getElementById("newBlocklistItems").value = "";

        const container = document.getElementById("currentBlocklistContainer");
        container.innerHTML = "";

        let policyData = {
          domains: [],
          ips: [],
          filePaths: [],
          operations: [],
        };
        try {
          if (policyDataString) {
            policyData = JSON.parse(policyDataString) || policyData;
          }
        } catch (e) {
          console.warn("Could not parse policy data", policyDataString);
        }

        // Handle different policy types
        let allEntries = [];
        if (policyCode === "NETWORK_DNS_BLOCK") {
          allEntries = [
            ...(policyData.domains || []),
            ...(policyData.ips || []),
          ];
        } else if (policyCode.startsWith("FILE_")) {
          allEntries = policyData.filePaths || [];
        }

        if (allEntries.length === 0) {
          container.innerHTML =
            '<div class="empty-state" style="padding: 10px;">No entries configured.</div>';
        } else {
          container.innerHTML = allEntries
            .map(
              (entry) => `
                    <div class="agent-card" id="entry-${entry.replace(
                      /[^a-zA-Z0-9]/g,
                      "_"
                    )}">
                        <span class="agent-name">${entry}</span>
                        <button class="btn btn-danger btn-sm" onclick="removeBlocklistEntry('${entry.replace(
                          /'/g,
                          "\\'"
                        )}')">
                            &times;
                        </button>
                    </div>
                `
            )
            .join("");
        }

        document
          .getElementById("blocklistEditorModal")
          .classList.remove("hidden");
      }

      function closeBlocklistEditor() {
        document.getElementById("blocklistEditorModal").classList.add("hidden");
      }

      function removeBlocklistEntry(entry) {
        const safeId = `entry-${entry.replace(/[^a-zA-Z0-9]/g, "_")}`;
        const entryElement = document.getElementById(safeId);
        if (entryElement) {
          entryElement.remove();
        }
      }

      async function saveBlocklist() {
        const agentId = document.getElementById("editListAgentId").value;
        const policyCode = document.getElementById("editListPolicyCode").value;
        const hostname = document.getElementById("editListHostname").value;

        // Get all existing entries that are still in the list
        const existingEntries = Array.from(
          document.querySelectorAll("#currentBlocklistContainer .agent-name")
        ).map((el) => el.textContent);

        // Get all new entries from the text box
        const newEntryText = document.getElementById("newBlocklistItems").value;
        const newEntries = newEntryText
          .split(",")
          .map((e) => e.trim())
          .filter((e) => e.length > 0);

        // Combine them and remove duplicates
        const allEntries = [...new Set([...existingEntries, ...newEntries])];

        let policyDataJson = null;

        if (policyCode === "NETWORK_DNS_BLOCK") {
          // Separate domains and IPs
          const domains = allEntries.filter(
            (e) => e.includes(".") && !e.match(/^\d+\.\d+\.\d+\.\d+$/)
          );
          const ips = allEntries.filter((e) => e.match(/^\d+\.\d+\.\d+\.\d+$/));
          policyDataJson = JSON.stringify({ domains, ips });
        } else if (policyCode.startsWith("FILE_")) {
          // For file policies, just use the file paths
          policyDataJson = JSON.stringify({ filePaths: allEntries });
        }

        try {
          const body = {
            agentId: parseInt(agentId),
            policyCode: policyCode,
            policyData: policyDataJson,
          };

          await callApi("/api/admin/update-policy-data", {
            method: "POST",
            body: JSON.stringify(body),
          });

          // Log the blocklist update
          await logToDatabase("BLOCKLIST_UPDATE", parseInt(agentId), {
            policy: policyCode,
            entries: allEntries,
          });

          showToast("Policy data updated successfully!", "success");
          closeBlocklistEditor();
          await loadAgentPolicies();
        } catch (error) {
          showToast(`Error updating data: ${error.message}`, "error");
        }
      }

      // Enhanced File Events with filtering and pagination
      async function loadFileEvents() {
        const container = document.getElementById("agentFileEventsList");
        container.innerHTML =
          '<div class="loading">Loading file events...</div>';

        try {
          const result = await callApi(
            `/api/admin/file-events/${currentAgentId}`
          );
          if (result && result.success) {
            fileEventsData = result.data || [];
            applyFileEventsFilter();
          }
        } catch (error) {
          container.innerHTML = `<div class="empty-state" style="color: var(--danger);">${error.message}</div>`;
        }
      }

      function filterFileEvents(filter, btnElement) {
        currentFileEventsFilter = filter;
        document
          .querySelectorAll("#agentFileEventsTab .time-filter-btn")
          .forEach((btn) => btn.classList.remove("active"));
        btnElement.classList.add("active");
        currentFileEventsPage = 1;
        applyFileEventsFilter();
      }

      function applyFileEventsFilter() {
        const now = new Date();
        let filteredData = [...fileEventsData];

        switch (currentFileEventsFilter) {
          case "TODAY":
            filteredData = filteredData.filter((event) => {
              const eventDate = new Date(event.timestamp);
              return eventDate.toDateString() === now.toDateString();
            });
            break;
          case "LAST_7_DAYS":
            const sevenDaysAgo = new Date(
              now.getTime() - 7 * 24 * 60 * 60 * 1000
            );
            filteredData = filteredData.filter(
              (event) => new Date(event.timestamp) >= sevenDaysAgo
            );
            break;
          case "LAST_30_DAYS":
            const thirtyDaysAgo = new Date(
              now.getTime() - 30 * 24 * 60 * 60 * 1000
            );
            filteredData = filteredData.filter(
              (event) => new Date(event.timestamp) >= thirtyDaysAgo
            );
            break;
        }

        displayFileEventsWithPagination(filteredData);
      }

      function displayFileEventsWithPagination(events) {
        const container = document.getElementById("agentFileEventsList");
        const pagination = document.getElementById("fileEventsPagination");

        const totalPages = Math.ceil(events.length / ITEMS_PER_PAGE);
        const startIndex = (currentFileEventsPage - 1) * ITEMS_PER_PAGE;
        const paginatedEvents = events.slice(
          startIndex,
          startIndex + ITEMS_PER_PAGE
        );

        if (paginatedEvents.length === 0) {
          container.innerHTML =
            '<div class="empty-state">No file events found for this period.</div>';
          pagination.classList.add("hidden");
          return;
        }

        container.innerHTML = `
                <table class="log-table">
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>Operation</th>
                            <th>File Path</th>
                            <th>User</th>
                            <th>Process</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${paginatedEvents
                          .map(
                            (event) => `
                            <tr>
                                <td>${new Date(
                                  event.timestamp
                                ).toLocaleString()}</td>
                                <td><span class="severity-badge ${event.operation.toLowerCase()}">${
                              event.operation
                            }</span></td>
                                <td><code>${event.filePath}</code></td>
                                <td>${event.user || "N/A"}</td>
                                <td>${event.process || "N/A"}</td>
                            </tr>
                        `
                          )
                          .join("")}
                    </tbody>
                </table>
            `;

        if (totalPages > 1) {
          pagination.classList.remove("hidden");
          pagination.innerHTML = "";

          if (currentFileEventsPage > 1) {
            pagination.innerHTML += `<button class="pagination-btn" onclick="changeFileEventsPage(${
              currentFileEventsPage - 1
            })">‚Üê Previous</button>`;
          }

          for (let i = 1; i <= totalPages; i++) {
            pagination.innerHTML += `<button class="pagination-btn ${
              i === currentFileEventsPage ? "active" : ""
            }" onclick="changeFileEventsPage(${i})">${i}</button>`;
          }

          if (currentFileEventsPage < totalPages) {
            pagination.innerHTML += `<button class="pagination-btn" onclick="changeFileEventsPage(${
              currentFileEventsPage + 1
            })">Next ‚Üí</button>`;
          }
        } else {
          pagination.classList.add("hidden");
        }
      }

      function changeFileEventsPage(page) {
        currentFileEventsPage = page;
        applyFileEventsFilter();
      }

      // Enhanced Web History with filtering and pagination
      async function loadWebHistory() {
        const container = document.getElementById("agentWebHistoryList");
        container.innerHTML =
          '<div class="loading">Loading web history...</div>';

        try {
          const result = await callApi(
            `/api/admin/web-history-detailed/${currentAgentId}`
          );
          if (result && result.success) {
            webHistoryData = result.data || [];
            applyWebHistoryFilter();
          }
        } catch (error) {
          container.innerHTML = `<div class="empty-state" style="color: var(--danger);">${error.message}</div>`;
        }
      }

      function filterWebHistory(filter, btnElement) {
        currentWebHistoryFilter = filter;
        document
          .querySelectorAll("#agentWebHistoryTab .time-filter-btn")
          .forEach((btn) => btn.classList.remove("active"));
        btnElement.classList.add("active");
        currentWebHistoryPage = 1;
        applyWebHistoryFilter();
      }

      function applyWebHistoryFilter() {
        const now = new Date();
        let filteredData = [...webHistoryData];

        switch (currentWebHistoryFilter) {
          case "TODAY":
            filteredData = filteredData.filter((entry) => {
              const entryDate = new Date(entry.timestamp);
              return entryDate.toDateString() === now.toDateString();
            });
            break;
          case "LAST_7_DAYS":
            const sevenDaysAgo = new Date(
              now.getTime() - 7 * 24 * 60 * 60 * 1000
            );
            filteredData = filteredData.filter(
              (entry) => new Date(entry.timestamp) >= sevenDaysAgo
            );
            break;
          case "LAST_30_DAYS":
            const thirtyDaysAgo = new Date(
              now.getTime() - 30 * 24 * 60 * 60 * 1000
            );
            filteredData = filteredData.filter(
              (entry) => new Date(entry.timestamp) >= thirtyDaysAgo
            );
            break;
        }

        displayWebHistoryWithPagination(filteredData);
      }

      function displayWebHistoryWithPagination(history) {
        const container = document.getElementById("agentWebHistoryList");
        const pagination = document.getElementById("webHistoryPagination");

        const totalPages = Math.ceil(history.length / ITEMS_PER_PAGE);
        const startIndex = (currentWebHistoryPage - 1) * ITEMS_PER_PAGE;
        const paginatedHistory = history.slice(
          startIndex,
          startIndex + ITEMS_PER_PAGE
        );

        if (paginatedHistory.length === 0) {
          container.innerHTML =
            '<div class="empty-state">No web history found for this period.</div>';
          pagination.classList.add("hidden");
          return;
        }

        container.innerHTML = `
                <table class="log-table">
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>URL</th>
                            <th>Domain</th>
                            <th>User</th>
                            <th>Browser</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${paginatedHistory
                          .map(
                            (entry) => `
                            <tr>
                                <td>${new Date(
                                  entry.timestamp
                                ).toLocaleString()}</td>
                                <td><a href="${entry.url}" target="_blank">${
                              entry.url.length > 50
                                ? entry.url.substring(0, 50) + "..."
                                : entry.url
                            }</a></td>
                                <td>${entry.domain || "N/A"}</td>
                                <td>${entry.user || "N/A"}</td>
                                <td>${entry.browser || "N/A"}</td>
                            </tr>
                        `
                          )
                          .join("")}
                    </tbody>
                </table>
            `;

        if (totalPages > 1) {
          pagination.classList.remove("hidden");
          pagination.innerHTML = "";

          if (currentWebHistoryPage > 1) {
            pagination.innerHTML += `<button class="pagination-btn" onclick="changeWebHistoryPage(${
              currentWebHistoryPage - 1
            })">‚Üê Previous</button>`;
          }

          for (let i = 1; i <= totalPages; i++) {
            pagination.innerHTML += `<button class="pagination-btn ${
              i === currentWebHistoryPage ? "active" : ""
            }" onclick="changeWebHistoryPage(${i})">${i}</button>`;
          }

          if (currentWebHistoryPage < totalPages) {
            pagination.innerHTML += `<button class="pagination-btn" onclick="changeWebHistoryPage(${
              currentWebHistoryPage + 1
            })">Next ‚Üí</button>`;
          }
        } else {
          pagination.classList.add("hidden");
        }
      }

      function changeWebHistoryPage(page) {
        currentWebHistoryPage = page;
        applyWebHistoryFilter();
      }

      // Enhanced USB History with filtering and pagination
      async function loadUsbHistory() {
        const container = document.getElementById("agentUsbHistoryList");
        container.innerHTML =
          '<div class="loading">Loading USB history...</div>';

        try {
          const result = await callApi(
            `/api/admin/agents/usb-history/${currentAgentId}`
          );
          if (result && result.success) {
            usbHistoryData = result.data || [];
            applyUsbHistoryFilter();
          }
        } catch (error) {
          container.innerHTML = `<div class="empty-state" style="color: var(--danger);">${error.message}</div>`;
        }
      }

      function filterUsbHistory(filter, btnElement) {
        currentUsbHistoryFilter = filter;
        document
          .querySelectorAll("#agentUsbHistoryTab .time-filter-btn")
          .forEach((btn) => btn.classList.remove("active"));
        btnElement.classList.add("active");
        currentUsbHistoryPage = 1;
        applyUsbHistoryFilter();
      }

      function applyUsbHistoryFilter() {
        const now = new Date();
        let filteredData = [...usbHistoryData];

        switch (currentUsbHistoryFilter) {
          case "TODAY":
            filteredData = filteredData.filter((entry) => {
              const entryDate = new Date(entry.timestamp);
              return entryDate.toDateString() === now.toDateString();
            });
            break;
          case "LAST_7_DAYS":
            const sevenDaysAgo = new Date(
              now.getTime() - 7 * 24 * 60 * 60 * 1000
            );
            filteredData = filteredData.filter(
              (entry) => new Date(entry.timestamp) >= sevenDaysAgo
            );
            break;
          case "LAST_30_DAYS":
            const thirtyDaysAgo = new Date(
              now.getTime() - 30 * 24 * 60 * 60 * 1000
            );
            filteredData = filteredData.filter(
              (entry) => new Date(entry.timestamp) >= thirtyDaysAgo
            );
            break;
        }

        displayUsbHistoryWithPagination(filteredData);
      }

      function displayUsbHistoryWithPagination(history) {
        const container = document.getElementById("agentUsbHistoryList");
        const pagination = document.getElementById("usbHistoryPagination");

        const totalPages = Math.ceil(history.length / ITEMS_PER_PAGE);
        const startIndex = (currentUsbHistoryPage - 1) * ITEMS_PER_PAGE;
        const paginatedHistory = history.slice(
          startIndex,
          startIndex + ITEMS_PER_PAGE
        );

        if (paginatedHistory.length === 0) {
          container.innerHTML =
            '<div class="empty-state">No USB history found for this period.</div>';
          pagination.classList.add("hidden");
          return;
        }

        container.innerHTML = `
                <table class="log-table">
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>Device Name</th>
                            <th>Vendor ID</th>
                            <th>Product ID</th>
                            <th>Serial Number</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${paginatedHistory
                          .map(
                            (entry) => `
                            <tr>
                                <td>${new Date(
                                  entry.timestamp
                                ).toLocaleString()}</td>
                                <td>${entry.deviceName || "Unknown"}</td>
                                <td>${entry.vendorId || "N/A"}</td>
                                <td>${entry.productId || "N/A"}</td>
                                <td>${entry.serialNumber || "N/A"}</td>
                                <td><span class="severity-badge ${entry.action.toLowerCase()}">${
                              entry.action
                            }</span></td>
                            </tr>
                        `
                          )
                          .join("")}
                    </tbody>
                </table>
            `;

        if (totalPages > 1) {
          pagination.classList.remove("hidden");
          pagination.innerHTML = "";

          if (currentUsbHistoryPage > 1) {
            pagination.innerHTML += `<button class="pagination-btn" onclick="changeUsbHistoryPage(${
              currentUsbHistoryPage - 1
            })">‚Üê Previous</button>`;
          }

          for (let i = 1; i <= totalPages; i++) {
            pagination.innerHTML += `<button class="pagination-btn ${
              i === currentUsbHistoryPage ? "active" : ""
            }" onclick="changeUsbHistoryPage(${i})">${i}</button>`;
          }

          if (currentUsbHistoryPage < totalPages) {
            pagination.innerHTML += `<button class="pagination-btn" onclick="changeUsbHistoryPage(${
              currentUsbHistoryPage + 1
            })">Next ‚Üí</button>`;
          }
        } else {
          pagination.classList.add("hidden");
        }
      }

      function changeUsbHistoryPage(page) {
        currentUsbHistoryPage = page;
        applyUsbHistoryFilter();
      }

      // Clear frontend data function
      function clearFrontendData(type) {
        if (
          !confirm(
            "Are you sure you want to clear the frontend data? This will only clear the display, not the database."
          )
        )
          return;

        switch (type) {
          case "allHistory":
            allHistoryData = [];
            document.getElementById("agentAllHistoryList").innerHTML =
              '<div class="empty-state">Data cleared. Refresh to load again.</div>';
            break;
          case "fileEvents":
            fileEventsData = [];
            document.getElementById("agentFileEventsList").innerHTML =
              '<div class="empty-state">Data cleared. Refresh to load again.</div>';
            break;
          case "webHistory":
            webHistoryData = [];
            document.getElementById("agentWebHistoryList").innerHTML =
              '<div class="empty-state">Data cleared. Refresh to load again.</div>';
            break;
          case "usbHistory":
            usbHistoryData = [];
            document.getElementById("agentUsbHistoryList").innerHTML =
              '<div class="empty-state">Data cleared. Refresh to load again.</div>';
            break;
        }

        showToast("Frontend data cleared successfully", "success");
      }

      // Enhanced togglePolicy with database logging
      async function togglePolicy(agentId, policyCode, isCurrentlyActive) {
        const endpoint = isCurrentlyActive
          ? "/api/admin/deactivate-protection"
          : "/api/admin/assign-protection";
        const actionText = isCurrentlyActive ? "deactivate" : "activate";
        if (!confirm(`Are you sure you want to ${actionText} "${policyCode}"?`))
          return;

        try {
          // For DNS policies, preserve the policy data when reactivating
          let policyData = null;
          if (policyCode === "NETWORK_DNS_BLOCK" && !isCurrentlyActive) {
            // Get current policy data to preserve it
            const policiesResult = await callApi(
              `/api/admin/agents/${agentId}/capabilities`
            );
            if (policiesResult && policiesResult.success) {
              const categories = policiesResult.data || {};
              for (const category of Object.values(categories)) {
                for (const policy of category) {
                  if (policy.code === policyCode && policy.policyData) {
                    policyData = policy.policyData;
                    break;
                  }
                }
              }
            }
          }

          const body = {
            policyCode: policyCode,
            agentIds: [agentId],
          };

          // Include policy data when reactivating DNS policies
          if (
            policyCode === "NETWORK_DNS_BLOCK" &&
            !isCurrentlyActive &&
            policyData
          ) {
            body.policyData = policyData;
          }

          await callApi(endpoint, {
            method: "POST",
            body: JSON.stringify(body),
          });

          // Log the policy change to database
          if (isCurrentlyActive) {
            await logPolicyRemoval(agentId, policyCode);
          } else {
            await logPolicyAssignment(agentId, policyCode);
          }

          showToast(`Policy ${actionText}d successfully!`, "success");
          await loadAgentPolicies();
          await loadAgents();
          await loadOverviewStats();
        } catch (error) {
          showToast(`Error: ${error.message}`, "error");
        }
      }

      // Rest of the code remains the same (File Policy Wizard, Other Policy Wizard, Alerts Tab, etc.)
      // ... [Previous code for File Policy Wizard, Other Policy Wizard, Alerts Tab remains exactly the same]

      // --- File Policy Wizard ---
      function openFilePolicyWizard() {
        resetFileWizard();
        document
          .getElementById("filePolicyWizardModal")
          .classList.remove("hidden");

        // Subscribe websocket updates for current agent
        if (currentAgentId) {
          subscribeToAgentBrowse(currentAgentId);
        }
      }

      function closeFilePolicyWizard() {
        document
          .getElementById("filePolicyWizardModal")
          .classList.add("hidden");
        unsubscribeFromAgentBrowse();
      }

      function resetFileWizard() {
        currentFileWizardStep = 1;
        selectedFileOperations = [];
        selectedFiles = [];
        selectedPolicyType = null;

        document
          .querySelectorAll(".wizard-step")
          .forEach((s) => s.classList.remove("active"));
        document.getElementById("fileWizardStep1").classList.add("active");

        document.querySelectorAll(".operation-checkbox").forEach((cb) => {
          cb.classList.remove("selected");
          cb.querySelector("input").checked = false;
        });

        document.getElementById("selectedFilesContainer").innerHTML = "";
        document
          .querySelectorAll(".policy-type-btn")
          .forEach((btn) => btn.classList.remove("selected"));

        updateFileWizardNavigation();
      }

      function toggleOperation(element, operation) {
        const checkbox = element.querySelector("input");
        checkbox.checked = !checkbox.checked;

        if (checkbox.checked) {
          element.classList.add("selected");
          if (!selectedFileOperations.includes(operation)) {
            selectedFileOperations.push(operation);
          }
        } else {
          element.classList.remove("selected");
          const index = selectedFileOperations.indexOf(operation);
          if (index > -1) {
            selectedFileOperations.splice(index, 1);
          }
        }
      }

      function nextFileWizardStep() {
        if (
          currentFileWizardStep === 1 &&
          selectedFileOperations.length === 0
        ) {
          showToast("Please select at least one file operation.", "warning");
          return;
        }

        if (currentFileWizardStep === 2 && selectedFiles.length === 0) {
          showToast("Please select at least one file or folder.", "warning");
          return;
        }

        if (currentFileWizardStep >= 3) return;

        document
          .getElementById(`fileWizardStep${currentFileWizardStep}`)
          .classList.remove("active");
        currentFileWizardStep++;
        document
          .getElementById(`fileWizardStep${currentFileWizardStep}`)
          .classList.add("active");

        if (currentFileWizardStep === 2) {
          connectWebsocket(() => subscribeToAgentBrowse(currentAgentId));
          browseFilePath();
        }

        updateFileWizardNavigation();
      }

      function previousFileWizardStep() {
        if (currentFileWizardStep <= 1) return;

        document
          .getElementById(`fileWizardStep${currentFileWizardStep}`)
          .classList.remove("active");
        currentFileWizardStep--;
        document
          .getElementById(`fileWizardStep${currentFileWizardStep}`)
          .classList.add("active");

        updateFileWizardNavigation();
      }

      function updateFileWizardNavigation() {
        document.getElementById("filePrevBtn").style.display =
          currentFileWizardStep > 1 ? "block" : "none";
        document.getElementById("fileNextBtn").style.display =
          currentFileWizardStep < 3 ? "block" : "none";
        document.getElementById("fileApplyBtn").style.display =
          currentFileWizardStep === 3 ? "block" : "none";
      }

      async function browseFilePath(path = "") {
        const container = document.getElementById("fileBrowser");
        container.innerHTML =
          '<div class="loading">Loading file system...</div>';
        if (!currentAgentId) {
          container.innerHTML =
            '<div class="empty-state">No agent selected.</div>';
          return;
        }

        // ensure websocket subscription
        subscribeToAgentBrowse(currentAgentId);

        try {
          const q =
            `/api/admin/agents/${currentAgentId}/browse-files` +
            (path ? `?path=${encodeURIComponent(path)}` : "");
          const result = await callApi(q, { method: "GET" });

          if (result && result.success && Array.isArray(result.data)) {
            // If server returned immediate cached data, render it
            renderFileItems(result.data);
            return;
          }

          // else pending: show waiting UI and let websocket messages update the UI
          container.innerHTML =
            '<div class="loading">Waiting for agent to respond...</div>';

          // keep a short timeout fallback (optional)
          setTimeout(() => {
            // if nothing received after e.g. 20s, show friendly message or re-try
            if (container.querySelector(".file-item") === null) {
              container.innerHTML =
                '<div class="empty-state" style="color: var(--danger);">Agent did not respond in time. Try again.</div>';
            }
          }, 20000);
        } catch (error) {
          container.innerHTML = `<div class="empty-state" style="color: var(--danger);">${error.message}</div>`;
        }
      }

      /**
       * Override / safe wrapper for your renderFileItems to ensure consistent UI shape.
       * If you already have renderFileItems defined (you do), then this will replace it
       * with a more robust implementation. If you prefer to keep your old one, skip this block.
       */
      function renderFileItems(files) {
        const container = document.getElementById("fileBrowser");
        if (!container) return;

        if (!files || files.length === 0) {
          container.innerHTML =
            '<div class="empty-state">No files or folders found.</div>';
          return;
        }

        // render items
        container.innerHTML = files
          .map((file) => {
            const path = file.path || file.fullPath || file.full_path || "";
            const isDir = !!file.isDirectory || !!file.is_directory;
            return `
                <div class="file-item" onclick="selectFile('${escapeJsString(
                  path
                )}', this, ${isDir})">
                    <span class="file-icon">${isDir ? "üìÅ" : "üìÑ"}</span>
                    <div>
                        <div>${escapeHtml(file.name)}</div>
                        <div class="file-path">${escapeHtml(path)}</div>
                    </div>
                </div>
            `;
          })
          .join("");
      }

      // small escaping helpers to avoid markup/JS injection
      function escapeHtml(text) {
        if (!text) return "";
        return text.replace(/[&<>"']/g, function (m) {
          return {
            "&": "&amp;",
            "<": "&lt;",
            ">": "&gt;",
            '"': "&quot;",
            "'": "&#39;",
          }[m];
        });
      }
      function escapeJsString(s) {
        if (!s) return "";
        return s.replace(/\\/g, "\\\\").replace(/'/g, "\\'");
      }

      function selectFile(path, element, isDirectory) {
        if (isDirectory) {
          browseFilePath(path);
          return;
        }

        // Toggle selection
        if (element.classList.contains("selected")) {
          element.classList.remove("selected");
          const index = selectedFiles.indexOf(path);
          if (index > -1) {
            selectedFiles.splice(index, 1);
          }
        } else {
          element.classList.add("selected");
          if (!selectedFiles.includes(path)) {
            selectedFiles.push(path);
          }
        }

        updateSelectedFilesList();
      }

      function updateSelectedFilesList() {
        const container = document.getElementById("selectedFilesContainer");

        if (selectedFiles.length === 0) {
          container.innerHTML =
            '<div class="empty-state">No files selected</div>';
          return;
        }

        container.innerHTML = selectedFiles
          .map(
            (file) => `
                <div class="file-item">
                    <span class="file-icon">üìÑ</span>
                    <div>
                        <div>${
                          file.split("/").pop() || file.split("\\").pop()
                        }</div>
                        <div class="file-path">${file}</div>
                    </div>
                    <button class="btn btn-danger btn-sm" onclick="removeSelectedFile('${file}')">
                        <span>√ó</span>
                    </button>
                </div>
            `
          )
          .join("");
      }

      function removeSelectedFile(path) {
        const index = selectedFiles.indexOf(path);
        if (index > -1) {
          selectedFiles.splice(index, 1);
        }

        // Also remove from visual selection in browser
        document.querySelectorAll(".file-item").forEach((item) => {
          if (item.textContent.includes(path)) {
            item.classList.remove("selected");
          }
        });

        updateSelectedFilesList();
      }

      function selectPolicyType(type, element) {
        selectedPolicyType = type;
        document
          .querySelectorAll(".policy-type-btn")
          .forEach((btn) => btn.classList.remove("selected"));
        element.classList.add("selected");
      }

      async function createFilePolicy() {
        if (!selectedPolicyType) {
          showToast(
            "Please select a policy type (Block or Monitor).",
            "warning"
          );
          return;
        }

        try {
          const policyData = {
            filePaths: selectedFiles,
            operations: selectedFileOperations,
            policyType: selectedPolicyType,
          };

          const body = {
            agentId: currentAgentId,
            operations: selectedFileOperations,
            filePaths: selectedFiles,
            policyType: selectedPolicyType,
            policyData: JSON.stringify(policyData),
          };

          const result = await callApi("/api/admin/file-policy/create", {
            method: "POST",
            body: JSON.stringify(body),
          });

          if (result && result.success) {
            showToast("File policy created successfully!", "success");
            closeFilePolicyWizard();
            await loadAgentPolicies();
          } else {
            throw new Error(result?.message || "Failed to create policy");
          }
        } catch (error) {
          showToast(`Error creating policy: ${error.message}`, "error");
        }
      }

      // --- Other Policy Wizard ---
      function openOtherPolicyWizard() {
        resetOtherWizard();
        document
          .getElementById("otherPolicyWizardModal")
          .classList.remove("hidden");
      }

      function closeOtherPolicyWizard() {
        document
          .getElementById("otherPolicyWizardModal")
          .classList.add("hidden");
      }

      function resetOtherWizard() {
        currentOtherWizardStep = 1;
        selectedOtherPolicyId = null;

        document
          .querySelectorAll(".wizard-step")
          .forEach((s) => s.classList.remove("active"));
        document.getElementById("otherWizardStep1").classList.add("active");

        document.getElementById("protectionCategory").value = "";
        document.getElementById("policiesContainer").innerHTML =
          '<div class="loading">Select a category first...</div>';
        document.getElementById("dnsPolicyConfig").classList.add("hidden");

        updateOtherWizardNavigation();
      }

      async function loadProtectionPolicies() {
        const category = document.getElementById("protectionCategory").value;
        const container = document.getElementById("policiesContainer");

        if (!category) {
          container.innerHTML =
            '<div class="loading">Select a category first...</div>';
          return;
        }

        try {
          const result = await callApi("/api/admin/protection-policies");
          const policies =
            result && result.success && result.data
              ? result.data[category] || []
              : [];

          if (policies.length === 0) {
            container.innerHTML = `<div class="empty-state">No policies found for this category.</div>`;
            return;
          }

          container.innerHTML = policies
            .map(
              (policy) => `
                    <div class="policy-card" onclick="selectOtherPolicy('${
                      policy.policyCode
                    }', this)">
                        <h5>${policy.name}</h5>
                        <p style="font-size: 0.9em; color: #555;">${
                          policy.description
                        }</p>
                        <div class="policy-action">
                            <span><strong>Action:</strong> ${
                              policy.action
                            }</span>
                            <span class="severity-badge ${(
                              policy.severity || "LOW"
                            ).toLowerCase()}">${policy.severity || "N/A"}</span>
                        </div>
                    </div>
                `
            )
            .join("");
        } catch (error) {
          container.innerHTML = `<div class="empty-state" style="color: var(--danger);">Error: ${error.message}</div>`;
        }
      }

      function selectOtherPolicy(policyCode, element) {
        selectedOtherPolicyId = policyCode;
        document
          .querySelectorAll("#policiesContainer .policy-card")
          .forEach((c) => c.classList.remove("selected"));
        element.classList.add("selected");

        // Show configuration if needed
        if (policyCode === "NETWORK_DNS_BLOCK") {
          document.getElementById("dnsPolicyConfig").classList.remove("hidden");
        } else {
          document.getElementById("dnsPolicyConfig").classList.add("hidden");
        }
      }

      function nextOtherWizardStep() {
        if (
          currentOtherWizardStep === 1 &&
          !document.getElementById("protectionCategory").value
        ) {
          showToast("Please select a protection category.", "warning");
          return;
        }

        if (currentOtherWizardStep === 2 && !selectedOtherPolicyId) {
          showToast("Please select a protection policy.", "warning");
          return;
        }

        if (currentOtherWizardStep >= 3) return;

        document
          .getElementById(`otherWizardStep${currentOtherWizardStep}`)
          .classList.remove("active");
        currentOtherWizardStep++;
        document
          .getElementById(`otherWizardStep${currentOtherWizardStep}`)
          .classList.add("active");

        updateOtherWizardNavigation();
      }

      function previousOtherWizardStep() {
        if (currentOtherWizardStep <= 1) return;

        document
          .getElementById(`otherWizardStep${currentOtherWizardStep}`)
          .classList.remove("active");
        currentOtherWizardStep--;
        document
          .getElementById(`otherWizardStep${currentOtherWizardStep}`)
          .classList.add("active");

        updateOtherWizardNavigation();
      }

      function updateOtherWizardNavigation() {
        document.getElementById("otherPrevBtn").style.display =
          currentOtherWizardStep > 1 ? "block" : "none";
        document.getElementById("otherNextBtn").style.display =
          currentOtherWizardStep < 3 ? "block" : "none";
        document.getElementById("otherApplyBtn").style.display =
          currentOtherWizardStep === 3 ? "block" : "none";
      }

      async function assignOtherPolicy() {
        if (!selectedOtherPolicyId) {
          showToast("Please select a policy to assign.", "warning");
          return;
        }

        try {
          let policyDataJson = null;

          if (selectedOtherPolicyId === "NETWORK_DNS_BLOCK") {
            const domainText = document.getElementById(
              "dns-block-list-domains"
            ).value;
            const ipText = document.getElementById("dns-block-list-ips").value;

            const domains = domainText
              .split(",")
              .map((d) => d.trim())
              .filter((d) => d.length > 0);
            const ips = ipText
              .split(",")
              .map((ip) => ip.trim())
              .filter((ip) => ip.length > 0);

            if (domains.length === 0 && ips.length === 0) {
              showToast(
                "Please enter at least one domain or IP to block.",
                "warning"
              );
              return;
            }

            policyDataJson = JSON.stringify({ domains, ips });
          }

          const body = {
            policyCode: selectedOtherPolicyId,
            agentIds: [currentAgentId],
            policyData: policyDataJson,
          };

          await callApi("/api/admin/assign-protection", {
            method: "POST",
            body: JSON.stringify(body),
          });
          showToast(`Policy assigned successfully!`, "success");
          closeOtherPolicyWizard();
          await loadAgentPolicies();
        } catch (error) {
          showToast(`Error: ${error.message}`, "error");
        }
      }

      // --- Alerts Tab ---
      async function loadAlerts() {
        const container = document.getElementById("alertsList");
        container.innerHTML = `<div class="loading">Loading alerts...</div>`;
        try {
          const result = await callApi("/api/admin/alerts/all");

          if (!result || !result.success) {
            throw new Error(result?.message || "Failed to load alerts");
          }
          allAlerts = result && result.success ? result.data || [] : [];

          updateAlertStatistics();
          displayFilteredAlerts();

          const pendingCount = allAlerts.filter(
            (a) => a.status === "PENDING"
          ).length;
          const badge = document.getElementById("alertBadge");
          badge.textContent = pendingCount;
          badge.classList.toggle("hidden", pendingCount === 0);
        } catch (error) {
          console.error("‚ùå Error loading alerts:", error.message);
          showAlertError(error.message);
        }
      }

      function showAlertError(message) {
        const container = document.getElementById("alertsList");
        container.innerHTML = `
                <div class="empty-state" style="color: var(--danger);">
                    <h4>‚ùå Error loading alerts</h4>
                    <p>${message}</p>
                    <button class="btn btn-primary" onclick="loadAlerts()" style="margin-top: 10px;">
                        <span>üîÑ</span>
                        <span>Try Again</span>
                    </button>
                </div>
            `;
      }

      function updateAlertStatistics() {
        const totalAlerts = allAlerts.length;
        const usbAlerts = allAlerts.filter(
          (a) => a.alertType && a.alertType.includes("USB")
        ).length;
        const pendingAlerts = allAlerts.filter(
          (a) => a.status === "PENDING"
        ).length;
        const criticalAlerts = allAlerts.filter(
          (a) => a.severity === "CRITICAL" || a.severity === "HIGH"
        ).length;

        document.getElementById("totalAlerts").textContent = totalAlerts;
        document.getElementById("usbAlerts").textContent = usbAlerts;
        document.getElementById("pendingAlertsCount").textContent =
          pendingAlerts;
        document.getElementById("criticalAlerts").textContent = criticalAlerts;
      }

      function displayFilteredAlerts() {
        const container = document.getElementById("alertsList");
        const filtered = filterAlertsByType(allAlerts, currentAlertFilter);
        if (filtered.length === 0) {
          container.innerHTML = `<div class="empty-state">No alerts match this filter.</div>`;
          return;
        }
        container.innerHTML = filtered.map(renderAlertCard).join("");
      }

      function filterAlerts(filter, btnElement) {
        currentAlertFilter = filter;
        document
          .querySelectorAll(".filter-btn")
          .forEach((btn) => btn.classList.remove("active"));
        btnElement.classList.add("active");
        displayFilteredAlerts();
      }

      function filterAlertsByType(alerts, filter) {
        if (filter === "ALL") return alerts;
        return alerts.filter(
          (a) =>
            (filter === "PENDING" && a.status === "PENDING") ||
            a.alertType?.includes(filter)
        );
      }

      function renderAlertCard(alert) {
        const severity = alert.severity || "MEDIUM";
        const severityClass = severity.toLowerCase();
        const isPending = alert.status === "PENDING";

        let alertClass = `alert-item ${severityClass} ${
          isPending ? "pending-alert" : ""
        }`;
        const alertIcon = alert.alertType?.includes("USB") ? "üíæ" : "üö®";

        const agentName = alert.agentName || "System";

        return `
                <div class="${alertClass}" id="alert-${alert.id}">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 1.2em;">${alertIcon}</span>
                            <div>
                                <strong>${
                                  alert.alertType || "Security Alert"
                                }</strong>
                                <div style="font-size: 0.9em; color: #666; margin-top: 2px;">
                                    Agent: <span style="font-weight: 600;">${agentName}</span> ‚Ä¢
                                    Severity: <span class="severity-${severityClass}">${severity}</span> ‚Ä¢
                                    Status: <span class="status-${
                                      alert.status?.toLowerCase() || "pending"
                                    }">${alert.status || "PENDING"}</span>
                                </div>
                            </div>
                        </div>
                        <span style="font-size: 0.9em; color: #666;">
                            ${new Date(alert.createdAt).toLocaleString()}
                        </span>
                    </div>

                    <div style="margin-top: 15px;">
                        <p><strong>Description:</strong> ${
                          alert.description || "No description"
                        }</p>
                        ${
                          alert.deviceInfo
                            ? `<p><strong>Device:</strong> ${alert.deviceInfo}</p>`
                            : ""
                        }
                        ${
                          alert.actionTaken
                            ? `<p><strong>Action Taken:</strong> ${alert.actionTaken}</p>`
                            : ""
                        }
                    </div>

                    ${
                      isPending
                        ? `
                    <div class="action-buttons">
                        <button class="btn btn-info btn-sm" onclick="takeAlertAction(${alert.agentId}, '${agentName}')">
                            <span>‚ö°</span>
                            <span>Take Action</span>
                        </button>
                        <button class="btn btn-primary btn-sm" onclick="handleAlertDecision(${alert.id}, 'RESOLVED')">
                            <span>‚úÖ</span>
                            <span>Resolve</span>
                        </button>
                        <button class="btn btn-warning btn-sm" onclick="handleAlertDecision(${alert.id}, 'IGNORED')">
                            <span>ü§∑</span>
                            <span>Ignore</span>
                        </button>
                    </div>
                    `
                        : `
                    <div style="margin-top: 10px; padding: 8px; background: #e8f5e8; border-radius: 4px;">
                        <strong>Decision:</strong> This alert has been ${alert.status.toLowerCase()}
                    </div>
                    `
                    }
                </div>
            `;
      }

      function takeAlertAction(agentId, agentName) {
        if (!agentId) {
          showToast(
            "This alert is not associated with a specific agent.",
            "warning"
          );
          return;
        }
        showTab("agents");
        openAgentDetailsModal(agentId, agentName);
      }

      async function handleAlertDecision(alertId, decision) {
        try {
          const result = await callApi(
            `/api/admin/alerts/${alertId}/decision?decision=${encodeURIComponent(
              decision
            )}`,
            { method: "POST" }
          );

          if (result && result.success) {
            showToast(
              `Alert ${decision.toLowerCase()} successfully!`,
              "success"
            );
            await loadAlerts();
          } else {
            showToast("Error: " + (result?.message || "Failed"), "error");
          }
        } catch (error) {
          console.error("Error handling alert:", error.message);
          showToast("Error handling alert: " + error.message, "error");
        }
      }

      async function createTestAgent() {
        try {
          const result = await callApi("/api/admin/agents/create-test", {
            method: "POST",
          });
          if (result && result.success) {
            showToast("Test agent created!", "success");
            await loadAgents();
          } else {
            showToast(
              "Error: " + (result?.message || "Failed to create test agent"),
              "error"
            );
          }
        } catch (error) {
          showToast("Error creating test agent: " + error.message, "error");
        }
      }

      async function createTestUSBAlert() {
        try {
          const result = await callApi(
            "/api/admin/alerts/create-test?agentId=1&alertType=USB_INSERTION&description=Test+USB+detected&deviceInfo=F:&fileDetails=Test+file+copied",
            { method: "POST" }
          );
          if (result && result.success) {
            showToast("Test alert created!", "success");
            await loadAlerts();
          } else {
            showToast(
              "Error: " + (result?.message || "Failed to create test alert"),
              "error"
            );
          }
        } catch (error) {
          showToast("Error creating test alert: " + error.message, "error");
        }
      }

      // --- Auto-Refresh & Initial Load ---
      function startAutoRefresh() {
        stopAutoRefresh();
        refreshInterval = setInterval(() => {
          const activeTabId = document.querySelector(".tab-content.active")?.id;
          if (activeTabId === "overview") loadOverviewStats();
          if (activeTabId === "agents") loadAgents();
          if (activeTabId === "alerts") loadAlerts();
          if (activeTabId === "ocr") loadOcrDashboard();
        }, 10000);
      }

      function stopAutoRefresh() {
        if (refreshInterval) clearInterval(refreshInterval);
      }

      // Ensure certain functions used in inline attributes are available on window
      (function exportInlineFunctions() {
        const fnNames = [
          "adminLogin",
          "logout",
          "showTab",
          ,
          "loadAgents",
          "createTestAgent",
          "filterAlerts",
          "loadAlerts",
          "createTestUSBAlert",
          "closeAgentDetailsModal",
          "openAgentDetailsModal",
          "openFilePolicyWizard",
          "openOtherPolicyWizard",
          "openDeleteLogsModal",
          "openBlocklistEditor",
        ];
        fnNames.forEach((name) => {
          try {
            if (typeof window[name] === "undefined") {
              const fn = eval(name);
              if (typeof fn === "function") window[name] = fn;
            }
          } catch (e) {
            // ignore unresolved names
          }
        });
      })();


  // Initialize on page load
  document.addEventListener("DOMContentLoaded", () => {
    checkAuthStatus();
    console.log("üß† OCR Dashboard initialized");

    // Start OCR auto-refresh if OCR tab is active on load
    setTimeout(() => {
      const activeTab = document.querySelector(".tab-content.active")?.id;
      if (activeTab === "ocr") {
        startOcrAutoRefresh();
      }
    }, 1000);
  });

  document.getElementById("password").addEventListener("keypress", (e) => {
    if (e.key === "Enter") adminLogin();
  });

  document.getElementById("usernameOrEmail").addEventListener("keypress", (e) => {
  if (e.key === "Enter") {
    document.getElementById("password").focus();
  }
});

</script>
</body>
</html>