<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Python Cybersecurity Monitor - Admin Panel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3a0ca3;
            --success-color: #4cc9f0;
            --danger-color: #f72585;
            --warning-color: #f8961e;
            --dark-color: #212529;
            --light-color: #f8f9fa;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding-bottom: 20px;
        }

        .dashboard-container {
            background: rgba(255, 255, 255, 0.98);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
            margin-bottom: 20px;
        }

        .navbar-custom {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border-radius: 15px 15px 0 0;
            padding: 15px 25px;
        }

        .stat-card {
            border: none;
            border-radius: 15px;
            transition: transform 0.3s, box-shadow 0.3s;
            background: white;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            height: 100%;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }

        .stat-card i {
            font-size: 2.5rem;
            margin-bottom: 15px;
        }

        .device-card {
            border: none;
            border-radius: 15px;
            transition: all 0.3s;
            background: white;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            margin-bottom: 20px;
            border-left: 5px solid transparent;
        }

        .device-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            border-left: 5px solid var(--primary-color);
        }

        .device-header {
            background: linear-gradient(135deg, rgba(67, 97, 238, 0.1), rgba(114, 9, 183, 0.1));
            border-radius: 15px 15px 0 0;
            padding: 15px 20px;
            border-bottom: 2px solid rgba(67, 97, 238, 0.2);
        }

        .device-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
        }

        .device-status {
            display: inline-block;
            padding: 3px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .status-active {
            background: rgba(76, 201, 240, 0.2);
            color: #4cc9f0;
        }

        .status-inactive {
            background: rgba(248, 150, 30, 0.2);
            color: #f8961e;
        }

        .status-shutdown {
            background: rgba(247, 37, 133, 0.2);
            color: #f72585;
        }

        .tab-content {
            padding: 25px;
            background: white;
            border-radius: 0 0 15px 15px;
        }

        .nav-tabs .nav-link {
            border: none;
            color: #6c757d;
            font-weight: 500;
            padding: 12px 25px;
        }

        .nav-tabs .nav-link.active {
            color: var(--primary-color);
            border-bottom: 3px solid var(--primary-color);
            background: transparent;
        }

        .connection-status {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }

        .connected {
            background: #4cc9f0;
            box-shadow: 0 0 10px #4cc9f0;
        }

        .disconnected {
            background: #f8961e;
        }

        .last-seen {
            font-size: 0.85rem;
            color: #6c757d;
        }

        .log-badge {
            font-size: 0.7rem;
            padding: 2px 8px;
        }

        .certificate-card {
            border: none;
            border-radius: 15px;
            transition: all 0.3s ease;
            background: white;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            height: 100%;
        }

        .certificate-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
            border: 2px solid rgba(67, 97, 238, 0.3);
        }

        .certificate-score {
            font-size: 2.5rem;
            font-weight: bold;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.2);
        }

        .certificate-type-badge {
            font-size: 0.7rem;
            padding: 3px 8px;
        }

        .ai-badge {
            background: linear-gradient(135deg, #4361ee, #7209b7);
        }

        .baseline-badge {
            background: linear-gradient(135deg, #6c757d, #495057);
        }

        .url-progress-bar {
            border-radius: 10px;
            overflow: hidden;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin: 20px 0;
        }

        .chart-container-small {
            position: relative;
            height: 150px;
            width: 100%;
        }

        .real-time-badge {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            border-radius: 15px;
        }

        .device-details-btn {
            transition: all 0.3s;
        }

        .device-details-btn:hover {
            transform: scale(1.05);
        }

        .app-usage-card {
            transition: all 0.3s;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
        }

        .app-usage-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
            background: #f8f9fa;
        }

        .device-summary-item {
            padding: 10px 15px;
            border-radius: 10px;
            background: #f8f9fa;
            transition: all 0.3s;
            border: 1px solid #e9ecef;
        }

        .device-summary-item:hover {
            background: #e9ecef;
            cursor: pointer;
            transform: translateY(-2px);
        }

        .device-timeline {
            border-left: 3px solid var(--primary-color);
            padding-left: 20px;
            margin-left: 10px;
        }

        .timeline-item {
            position: relative;
            margin-bottom: 20px;
        }

        .timeline-item:before {
            content: '';
            position: absolute;
            left: -26px;
            top: 5px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--primary-color);
            border: 3px solid white;
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
        }

        .url-item {
            padding: 8px 12px;
            margin-bottom: 5px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #4cc9f0;
        }

        .url-item.suspicious {
            border-left-color: #f8961e;
            background: rgba(248, 150, 30, 0.1);
        }

        .url-item.blocked {
            border-left-color: #f72585;
            background: rgba(247, 37, 133, 0.1);
        }

        .app-category-badge {
            font-size: 0.65rem;
            padding: 2px 6px;
        }

        @media (max-width: 768px) {
            .dashboard-container {
                margin: 10px;
                border-radius: 15px;
            }

            .navbar-custom {
                border-radius: 15px 15px 0 0;
            }

            .stat-card {
                margin-bottom: 15px;
            }
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>

<body>
    <div class="container-fluid py-4">
        <div class="dashboard-container">
            <!-- Header -->
            <nav class="navbar navbar-expand-lg navbar-custom">
                <div class="container-fluid">
                    <a class="navbar-brand text-white" href="#">
                        <i class="bi bi-shield-lock-fill me-2"></i>
                        <span class="fw-bold">Python Cybersecurity Monitor</span>
                    </a>
                    <div class="d-flex align-items-center">
                        <span class="text-white me-3 d-none d-md-block">
                            <span class="connection-status connected"></span>
                            <span id="connectionStatus">Connected to Backend</span>
                        </span>
                        <button class="btn btn-light btn-sm me-2" id="refreshBtn">
                            <i class="bi bi-arrow-clockwise"></i> Refresh
                        </button>
                        <span class="badge bg-danger real-time-badge" id="liveBadge">
                            <i class="bi bi-circle-fill me-1"></i> LIVE
                        </span>
                    </div>
                </div>
            </nav>

            <!-- Statistics Cards -->
            <div class="row p-4">
                <div class="col-md-3 col-sm-6 mb-3">
                    <div class="card stat-card">
                        <div class="card-body text-center">
                            <i class="bi bi-laptop text-primary"></i>
                            <h5 class="card-title">Total Devices</h5>
                            <h2 class="display-6 fw-bold" id="totalDevices">0</h2>
                            <p class="text-muted mb-0" id="activeDevices">0 Active</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6 mb-3">
                    <div class="card stat-card">
                        <div class="card-body text-center">
                            <i class="bi bi-clock-history text-warning"></i>
                            <h5 class="card-title">Total Logs</h5>
                            <h2 class="display-6 fw-bold" id="totalLogs">0</h2>
                            <p class="text-muted mb-0">All devices</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6 mb-3">
                    <div class="card stat-card">
                        <div class="card-body text-center">
                            <i class="bi bi-globe text-success"></i>
                            <h5 class="card-title">URLs Monitored</h5>
                            <h2 class="display-6 fw-bold" id="totalUrls">0</h2>
                            <p class="text-muted mb-0">Total visits</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6 mb-3">
                    <div class="card stat-card">
                        <div class="card-body text-center">
                            <i class="bi bi-shield-check text-danger"></i>
                            <h5 class="card-title">Certificates</h5>
                            <h2 class="display-6 fw-bold" id="totalCerts">0</h2>
                            <p class="text-muted mb-0">Latest per device</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="px-4">
                <ul class="nav nav-tabs" id="dashboardTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="devices-tab" data-bs-toggle="tab" data-bs-target="#devices"
                            type="button" role="tab">
                            <i class="bi bi-laptop me-2"></i>Devices
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="logs-tab" data-bs-toggle="tab" data-bs-target="#logs" type="button"
                            role="tab">
                            <i class="bi bi-journal-text me-2"></i>Logs
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="urls-tab" data-bs-toggle="tab" data-bs-target="#urls" type="button"
                            role="tab">
                            <i class="bi bi-link me-2"></i>URL History
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="apps-tab" data-bs-toggle="tab" data-bs-target="#apps" type="button"
                            role="tab">
                            <i class="bi bi-app me-2"></i>App Usage
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="certificates-tab" data-bs-toggle="tab"
                            data-bs-target="#certificates" type="button" role="tab">
                            <i class="bi bi-shield-check me-2"></i>Certificates
                        </button>
                    </li>
                    <!-- New Blocked URLs Tab -->
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="blocked-tab" data-bs-toggle="tab" data-bs-target="#blocked" type="button"
                            role="tab">
                            <i class="bi bi-ban me-2"></i>Blocked URLs
                        </button>
                    </li>
                    <!-- New Partial Access Tab -->
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="partial-access-tab" data-bs-toggle="tab" data-bs-target="#partial-access" type="button"
                                role="tab">
                            <i class="bi bi-shield-half me-2"></i>Partial Access
                        </button>
                    </li>
                </ul>

                <div class="tab-content" id="dashboardContent">
                    <!-- Devices Tab -->
                    <div class="tab-pane fade show active" id="devices" role="tabpanel">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h4><i class="bi bi-laptop text-primary me-2"></i>Connected Devices</h4>
                            <div class="input-group" style="max-width: 300px;">
                                <input type="text" class="form-control" placeholder="Search devices..."
                                    id="searchDevices">
                                <button class="btn btn-outline-primary" type="button" id="searchDevicesBtn">
                                    <i class="bi bi-search"></i>
                                </button>
                            </div>
                        </div>
                        <div id="devicesContainer">
                            <!-- Devices grouped by deviceId will be loaded here -->
                        </div>
                        <div class="text-center mt-3">
                            <div class="spinner-border text-primary" role="status" id="devicesLoading">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>

                    <!-- Logs Tab -->
                    <div class="tab-pane fade" id="logs" role="tabpanel">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h4><i class="bi bi-journal-text text-warning me-2"></i>Logs by Device</h4>
                            <div class="input-group" style="max-width: 300px;">
                                <input type="text" class="form-control" placeholder="Search logs..." id="searchLogs">
                                <button class="btn btn-outline-warning" type="button" id="searchLogsBtn">
                                    <i class="bi bi-search"></i>
                                </button>
                            </div>
                        </div>
                        <div id="logsContainer">
                            <!-- Logs grouped by deviceId will be loaded here -->
                        </div>
                    </div>

                    <!-- URLs Tab -->
                    <div class="tab-pane fade" id="urls" role="tabpanel">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h4><i class="bi bi-link text-success me-2"></i>URL History by Device</h4>
                            <div class="input-group" style="max-width: 300px;">
                                <input type="text" class="form-control" placeholder="Search URLs..." id="searchUrls">
                                <button class="btn btn-outline-success" type="button" id="searchUrlsBtn">
                                    <i class="bi bi-search"></i>
                                </button>
                            </div>
                        </div>
                        <div id="urlsContainer">
                            <!-- URLs grouped by deviceId will be loaded here -->
                        </div>
                    </div>

                    <!-- App Usage Tab -->
                    <div class="tab-pane fade" id="apps" role="tabpanel">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h4><i class="bi bi-app text-info me-2"></i>App Usage by Device</h4>
                            <div class="btn-group">
                                <button class="btn btn-outline-secondary btn-sm active" id="showAllDevices">All Devices</button>
                                <button class="btn btn-outline-info btn-sm" id="showCurrentApps">Current Sessions</button>
                            </div>
                        </div>
                        <div id="appsContainer">
                            <!-- App usage grouped by deviceId will be loaded here -->
                        </div>
                    </div>

                    <!-- Certificates Tab -->
                    <div class="tab-pane fade" id="certificates" role="tabpanel">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h4><i class="bi bi-shield-check text-danger me-2"></i>Latest Certificates by Device</h4>
                            <button class="btn btn-primary" id="generateAllCerts">
                                <i class="bi bi-robot me-1"></i> Generate All Certificates
                            </button>
                        </div>
                        <div class="row" id="certificatesContainer">
                            <!-- Latest certificate per device will be loaded here -->
                        </div>
                    </div>

                    <!-- Blocked URLs Tab -->
                    <div class="tab-pane fade" id="blocked" role="tabpanel">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h4><i class="bi bi-ban text-danger me-2"></i>Blocked URL Management</h4>
                            <div class="btn-group">
                                <button class="btn btn-primary" id="addBlockedUrlBtn">
                                    <i class="bi bi-plus-circle me-1"></i> Add URL
                                </button>
                                <button class="btn btn-success" id="addBulkBlockedUrlBtn">
                                    <i class="bi bi-plus-circle-dotted me-1"></i> Bulk Add
                                </button>
                            </div>
                        </div>        
                        <!-- Statistics Row -->
                        <div class="row mb-4">
                            <div class="col-md-3 col-sm-6 mb-3">
                                <div class="card stat-card">
                                    <div class="card-body text-center">
                                        <i class="bi bi-globe text-primary"></i>
                                        <h5 class="card-title">Total URLs</h5>
                                        <h2 class="display-6 fw-bold" id="totalBlockedUrls">0</h2>
                                        <p class="text-muted mb-0" id="activeBlockedUrls">0 Active</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 col-sm-6 mb-3">
                                <div class="card stat-card">
                                    <div class="card-body text-center">
                                        <i class="bi bi-globe-americas text-warning"></i>
                                        <h5 class="card-title">Global Rules</h5>
                                        <h2 class="display-6 fw-bold" id="globalBlockedUrls">0</h2>
                                        <p class="text-muted mb-0">Applied to all</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 col-sm-6 mb-3">
                                <div class="card stat-card">
                                    <div class="card-body text-center">
                                        <i class="bi bi-tags text-info"></i>
                                        <h5 class="card-title">Categories</h5>
                                        <h2 class="display-6 fw-bold" id="totalBlockedCategories">0</h2>
                                        <p class="text-muted mb-0">Different types</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Search and Filters -->
                        <div class="card mb-4">
                            <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <div class="input-group">
                                            <input type="text" class="form-control" placeholder="Search URLs..." id="searchBlockedUrls">
                                            <button class="btn btn-outline-secondary" type="button" id="searchBlockedBtn">
                                                <i class="bi bi-search"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <select class="form-select" id="filterStatus">
                                            <option value="">All Status</option>
                                            <option value="active">Active</option>
                                            <option value="inactive">Inactive</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <select class="form-select" id="filterScope">
                                            <option value="">All Scope</option>
                                            <option value="global">Global</option>
                                            <option value="device">Device Specific</option>
                                            <option value="user">User Specific</option>
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <button class="btn btn-secondary w-100" id="refreshBlockedBtn">
                                            <i class="bi bi-arrow-clockwise"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Blocked URLs Table -->
                        <div class="card">
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover" id="blockedUrlsTable">
                                        <thead>
                                            <tr>
                                                <th>URL Pattern</th>
                                                <th>Domain</th>
                                                <th>Category</th>
                                                <th>Scope</th>
                                                <th>Status</th>
                                                <th>Updated</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="blockedUrlsTableBody">
                                            <!-- Blocked URLs will be loaded here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Most Blocked URLs -->
                        <div class="mt-4">
                            <h5><i class="bi bi-bar-chart text-danger me-2"></i>Most Blocked URLs</h5>
                            <div id="mostBlockedUrlsContainer">
                                <!-- Most blocked URLs will be loaded here -->
                            </div>
                        </div>
                    </div>

                    <!-- Partial Access Tab -->
                <div class="tab-pane fade" id="partial-access" role="tabpanel">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h4><i class="bi bi-shield-half text-info me-2"></i>Partial Access Site Management</h4>
                        <div class="btn-group">
                            <button class="btn btn-primary" id="addPartialAccessBtn">
                                <i class="bi bi-plus-circle me-1"></i> Add Site
                            </button>
                            <button class="btn btn-success" id="addBulkPartialAccessBtn">
                                <i class="bi bi-plus-circle-dotted me-1"></i> Bulk Add
                            </button>
                        </div>
                    </div>                        
    <!-- Statistics Row -->
    <div class="row mb-4">
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="card stat-card">
                <div class="card-body text-center">
                    <i class="bi bi-globe text-info"></i>
                    <h5 class="card-title">Total Sites</h5>
                    <h2 class="display-6 fw-bold" id="totalPartialSites">0</h2>
                    <p class="text-muted mb-0" id="activePartialSites">0 Active</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="card stat-card">
                <div class="card-body text-center">
                    <i class="bi bi-tags text-primary"></i>
                    <h5 class="card-title">Categories</h5>
                    <h2 class="display-6 fw-bold" id="totalPartialCategories">0</h2>
                    <p class="text-muted mb-0">Different types</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Search and Filters -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-4">
                    <div class="input-group">
                        <input type="text" class="form-control" placeholder="Search sites..." id="searchPartialSites">
                        <button class="btn btn-outline-secondary" type="button" id="searchPartialBtn">
                            <i class="bi bi-search"></i>
                        </button>
                    </div>
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="filterPartialStatus">
                        <option value="">All Status</option>
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="filterPartialScope">
                        <option value="">All Scope</option>
                        <option value="global">Global</option>
                        <option value="device">Device Specific</option>
                        <option value="user">User Specific</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-secondary w-100" id="refreshPartialBtn">
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

        <!-- Partial Access Sites Table -->
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="partialAccessTable">
                        <thead>
                            <tr>
                                <th>URL Pattern</th>
                                <th>Domain</th>
                                <th>Permissions</th>
                                <th>Category</th>
                                <th>Scope</th>
                                <th>Status</th>
                                <th>Updated</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="partialAccessTableBody">
                            <!-- Partial access sites will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Most Attempted Sites -->
        <div class="mt-4">
            <h5><i class="bi bi-bar-chart text-info me-2"></i>Most Attempted Sites</h5>
            <div id="mostAttemptedSitesContainer">
                <!-- Most attempted sites will be loaded here -->
            </div>
        </div>
    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Device Details Modal -->
    <div class="modal fade" id="deviceModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-laptop me-2"></i>
                        <span id="modalDeviceId">Device Details</span>
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card h-100">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0"><i class="bi bi-info-circle me-2"></i>Device Information</h6>
                                </div>
                                <div class="card-body" id="deviceInfoContent">
                                    <!-- Device info will be loaded here -->
                                </div>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <ul class="nav nav-tabs" id="deviceDetailTabs">
                                <li class="nav-item">
                                    <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#deviceLogs">Logs</button>
                                </li>
                                <li class="nav-item">
                                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#deviceUrls">URLs</button>
                                </li>
                                <li class="nav-item">
                                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#deviceApps">App Usage</button>
                                </li>
                                <li class="nav-item">
                                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#deviceCerts">Certificates</button>
                                </li>
                                <!-- New Blocked URLs Tab in Device Details -->
                                <li class="nav-item">
                                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#deviceBlockedUrls">Blocked URLs</button>
                                </li>
                                <li class="nav-item">
                                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#devicePartialAccess">Partial Access</button>
                                </li>
                            </ul>
                            <div class="tab-content mt-3">
                                <div class="tab-pane fade show active" id="deviceLogs">
                                    <div class="card">
                                        <div class="card-body" style="max-height: 500px; overflow-y: auto;">
                                            <div id="deviceLogsContent">
                                                <!-- Device logs will be loaded here -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="deviceUrls">
                                    <div class="card">
                                        <div class="card-body" style="max-height: 500px; overflow-y: auto;">
                                            <div id="deviceUrlsContent">
                                                <!-- Device URLs will be loaded here -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
<div class="tab-pane fade" id="deviceApps" role="tabpanel">
    <div class="card">
        <div class="card-header bg-light">
            <div class="d-flex justify-content-between align-items-center">
                <h6 class="mb-0">App Usage</h6>
                <div class="input-group" style="width: 200px;">
                    <input type="date" class="form-control form-control-sm" id="deviceAppsDate" 
                           value="${new Date().toISOString().split('T')[0]}">
                    <button class="btn btn-sm btn-outline-primary" id="refreshDeviceApps">
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                </div>
            </div>
        </div>
        <div class="card-body" style="max-height: 500px; overflow-y: auto;">
            <div id="deviceAppsContent">
                <!-- Device app usage will be loaded here -->
            </div>
        </div>
    </div>
</div>
                                <div class="tab-pane fade" id="deviceCerts">
                                    <div class="card">
                                        <div class="card-body" style="max-height: 500px; overflow-y: auto;">
                                            <div id="deviceCertsContent">
                                                <!-- Device certificates will be loaded here -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- New Blocked URLs Tab Content -->
                                <div class="tab-pane fade" id="deviceBlockedUrls">
                                    <div class="card">
                                        <div class="card-header bg-light">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <h6 class="mb-0">Device-Specific Blocked URLs</h6>
                                                <button class="btn btn-sm btn-primary" id="addDeviceBlockedUrlBtn">
                                                    <i class="bi bi-plus-circle me-1"></i> Add URL
                                                </button>
                                            </div>
                                        </div>
                                        <div class="card-body" style="max-height: 500px; overflow-y: auto;">
                                            <div id="deviceBlockedUrlsContent">
                                                <!-- Device-specific blocked URLs will be loaded here -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- Partial Access Tab Content -->
                                <div class="tab-pane fade" id="devicePartialAccess">
                                    <div class="card">
                                        <div class="card-header bg-light">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <h6 class="mb-0">Device-Specific Partial Access Sites</h6>
                                                <button class="btn btn-sm btn-primary" id="addDevicePartialAccessBtn">
                                                    <i class="bi bi-plus-circle me-1"></i> Add Site
                                                </button>
                                            </div>
                                        </div>
                                        <div class="card-body" style="max-height: 500px; overflow-y: auto;">
                                            <div id="devicePartialAccessContent">
                                                <!-- Device-specific partial access sites will be loaded here -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Blocked URL Modal -->
    <div class="modal fade" id="addBlockedUrlModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-ban me-2"></i>
                        Add Blocked URL
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addBlockedUrlForm">
                        <div class="mb-3">
                            <label for="urlPattern" class="form-label">URL Pattern *</label>
                            <input type="text" class="form-control" id="urlPattern" required 
                                   placeholder="e.g., *.example.com, https://malicious.com/*">
                            <div class="form-text">
                                Use wildcards (*) for patterns. Example: *.facebook.com blocks all Facebook subdomains
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="reason" class="form-label">Reason for Blocking</label>
                            <textarea class="form-control" id="reason" rows="2" 
                                      placeholder="Why is this URL being blocked?"></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="category" class="form-label">Category</label>
                                    <select class="form-select" id="category">
                                        <option value="">Select Category</option>
                                        <option value="social">Social Media</option>
                                        <option value="gaming">Gaming</option>
                                        <option value="shopping">Shopping</option>
                                        <option value="entertainment">Entertainment</option>
                                        <option value="malware">Malware/Phishing</option>
                                        <option value="productivity">Productivity</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="scope" class="form-label">Scope</label>
                                    <select class="form-select" id="scope">
                                        <option value="global">Global (All Devices)</option>
                                        <option value="device">Specific Device</option>
                                        <option value="user">Specific User</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row" id="scopeSpecificFields" style="display: none;">
                            <div class="col-md-6" id="deviceIdField" style="display: none;">
                                <div class="mb-3">
                                    <label for="deviceId" class="form-label">Device ID</label>
                                    <input type="text" class="form-control" id="deviceId" 
                                           placeholder="Enter device ID">
                                </div>
                            </div>
                            <div class="col-md-6" id="userIdField" style="display: none;">
                                <div class="mb-3">
                                    <label for="userId" class="form-label">User ID</label>
                                    <input type="text" class="form-control" id="userId" 
                                           placeholder="Enter user ID">
                                </div>
                            </div>
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="active" checked>
                            <label class="form-check-label" for="active">Active (Start blocking immediately)</label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveBlockedUrlBtn">Save URL</button>
                </div>
            </div>
        </div>
    </div>

        <!-- Add Partial Access Site Modal -->
    <div class="modal fade" id="addPartialAccessModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-shield-half me-2"></i>
                        Add Partial Access Site
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addPartialAccessForm">
                        <div class="mb-3">
                            <label for="partialUrlPattern" class="form-label">URL Pattern *</label>
                            <input type="text" class="form-control" id="partialUrlPattern" required 
                                placeholder="e.g., chat.deepseek.com">
                            <div class="form-text">
                                Use wildcards (*) for patterns. Example: *.work.com allows access to work-related sites
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="partialReason" class="form-label">Reason</label>
                            <textarea class="form-control" id="partialReason" rows="2" 
                                    placeholder="Why is this site partially accessible?"></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="partialCategory" class="form-label">Category</label>
                                    <select class="form-select" id="partialCategory">
                                        <option value="">Select Category</option>
                                        <option value="work">Work/Productivity</option>
                                        <option value="education">Education</option>
                                        <option value="research">Research</option>
                                        <option value="shopping">Shopping</option>
                                        <option value="entertainment">Entertainment</option>
                                        <option value="social">Social Media</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="partialScope" class="form-label">Scope</label>
                                    <select class="form-select" id="partialScope">
                                        <option value="global">Global (All Devices)</option>
                                        <option value="device">Specific Device</option>
                                        <option value="user">Specific User</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row" id="partialScopeSpecificFields" style="display: none;">
                            <div class="col-md-6" id="partialDeviceIdField" style="display: none;">
                                <div class="mb-3">
                                    <label for="partialDeviceId" class="form-label">Device ID</label>
                                    <input type="text" class="form-control" id="partialDeviceId" 
                                        placeholder="Enter device ID">
                                </div>
                            </div>
                            <div class="col-md-6" id="partialUserIdField" style="display: none;">
                                <div class="mb-3">
                                    <label for="partialUserId" class="form-label">User ID</label>
                                    <input type="text" class="form-control" id="partialUserId" 
                                        placeholder="Enter user ID">
                                </div>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="allowUpload">
                                    <label class="form-check-label" for="allowUpload">Allow File Upload</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="allowDownload">
                                    <label class="form-check-label" for="allowDownload">Allow File Download</label>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="monitorMode" class="form-label">Monitor Mode</label>
                            <select class="form-select" id="monitorMode">
                                <option value="block">Block (Default)</option>
                                <option value="warn">Warn Only</option>
                                <option value="log-only">Log Only</option>
                            </select>
                            <div class="form-text">
                                <strong>Block:</strong> Prevent actions | <strong>Warn:</strong> Show warning | <strong>Log Only:</strong> Only log attempts
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="restrictedFileTypes" class="form-label">Restricted File Types (Optional)</label>
                            <input type="text" class="form-control" id="restrictedFileTypes" 
                                placeholder="exe, zip, bat, dmg (comma separated)">
                            <div class="form-text">
                                File types that are still restricted even on partial access sites
                            </div>
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="partialActive" checked>
                            <label class="form-check-label" for="partialActive">Active (Start monitoring immediately)</label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-info" id="savePartialAccessBtn">Save Site</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk Add Partial Access Sites Modal -->
    <div class="modal fade" id="bulkAddPartialAccessModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-plus-circle-dotted me-2"></i>
                        Bulk Add Partial Access Sites
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Enter URLs (one per line):</label>
                        <textarea class="form-control" id="bulkPartialUrls" rows="10" 
                                placeholder="Enter URLs one per line, e.g.:
    *.work.com
    *.education.com
    https://research-portal.com/*
    http://*.shopping.com/path"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="bulkPartialCategory" class="form-label">Category (applies to all)</label>
                                <select class="form-select" id="bulkPartialCategory">
                                    <option value="">Select Category</option>
                                    <option value="work">Work/Productivity</option>
                                    <option value="education">Education</option>
                                    <option value="research">Research</option>
                                    <option value="shopping">Shopping</option>
                                    <option value="entertainment">Entertainment</option>
                                    <option value="social">Social Media</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="bulkPartialReason" class="form-label">Reason (applies to all)</label>
                                <input type="text" class="form-control" id="bulkPartialReason" 
                                    placeholder="Reason for partial access">
                            </div>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="bulkAllowUpload" checked>
                                <label class="form-check-label" for="bulkAllowUpload">Allow Upload</label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="bulkAllowDownload" checked>
                                <label class="form-check-label" for="bulkAllowDownload">Allow Download</label>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="bulkPartialScope" class="form-label">Scope (applies to all)</label>
                        <select class="form-select" id="bulkPartialScope">
                            <option value="global">Global (All Devices)</option>
                            <option value="device">Specific Device</option>
                            <option value="user">Specific User</option>
                        </select>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="bulkPartialActive" checked>
                        <label class="form-check-label" for="bulkPartialActive">Active</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" id="saveBulkPartialAccessBtn">Add Sites</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Partial Access Site Modal -->
    <div class="modal fade" id="editPartialAccessModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-warning text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-pencil-square me-2"></i>
                        Edit Partial Access Site
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editPartialAccessForm">
                        <input type="hidden" id="editPartialId">
                        <div class="mb-3">
                            <label for="editPartialUrlPattern" class="form-label">URL Pattern *</label>
                            <input type="text" class="form-control" id="editPartialUrlPattern" required>
                        </div>
                        <div class="mb-3">
                            <label for="editPartialReason" class="form-label">Reason</label>
                            <textarea class="form-control" id="editPartialReason" rows="2"></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editPartialCategory" class="form-label">Category</label>
                                    <select class="form-select" id="editPartialCategory">
                                        <option value="">Select Category</option>
                                        <option value="work">Work/Productivity</option>
                                        <option value="education">Education</option>
                                        <option value="research">Research</option>
                                        <option value="shopping">Shopping</option>
                                        <option value="entertainment">Entertainment</option>
                                        <option value="social">Social Media</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Scope</label>
                                    <div class="form-control bg-light" id="editPartialScopeDisplay"></div>
                                    <input type="hidden" id="editPartialDeviceId">
                                    <input type="hidden" id="editPartialUserId">
                                    <div class="form-text" id="editPartialScopeInfo"></div>
                                </div>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="editAllowUpload">
                                    <label class="form-check-label" for="editAllowUpload">Allow File Upload</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="editAllowDownload">
                                    <label class="form-check-label" for="editAllowDownload">Allow File Download</label>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="editMonitorMode" class="form-label">Monitor Mode</label>
                            <select class="form-select" id="editMonitorMode">
                                <option value="block">Block</option>
                                <option value="warn">Warn Only</option>
                                <option value="log-only">Log Only</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="editRestrictedFileTypes" class="form-label">Restricted File Types</label>
                            <input type="text" class="form-control" id="editRestrictedFileTypes" 
                                placeholder="exe, zip, bat, dmg (comma separated)">
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="editPartialActive">
                            <label class="form-check-label" for="editPartialActive">Active</label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" id="deletePartialAccessBtn">Delete</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-warning" id="updatePartialAccessBtn">Update</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk Add Blocked URLs Modal -->
    <div class="modal fade" id="bulkAddBlockedUrlModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-plus-circle-dotted me-2"></i>
                        Bulk Add Blocked URLs
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Enter URLs (one per line):</label>
                        <textarea class="form-control" id="bulkUrls" rows="10" 
                                  placeholder="Enter URLs one per line, e.g.:
*.facebook.com
*.youtube.com
https://malicious-site.com/*
http://*.example.com/path"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="bulkCategory" class="form-label">Category (applies to all)</label>
                                <select class="form-select" id="bulkCategory">
                                    <option value="">Select Category</option>
                                    <option value="social">Social Media</option>
                                    <option value="gaming">Gaming</option>
                                    <option value="shopping">Shopping</option>
                                    <option value="entertainment">Entertainment</option>
                                    <option value="malware">Malware/Phishing</option>
                                    <option value="productivity">Productivity</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="bulkReason" class="form-label">Reason (applies to all)</label>
                                <input type="text" class="form-control" id="bulkReason" 
                                       placeholder="Reason for blocking">
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="bulkScope" class="form-label">Scope (applies to all)</label>
                        <select class="form-select" id="bulkScope">
                            <option value="global">Global (All Devices)</option>
                            <option value="device">Specific Device</option>
                            <option value="user">Specific User</option>
                        </select>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="bulkActive" checked>
                        <label class="form-check-label" for="bulkActive">Active (Start blocking immediately)</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" id="saveBulkBlockedUrlsBtn">Add URLs</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Blocked URL Modal -->
    <div class="modal fade" id="editBlockedUrlModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-warning text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-pencil-square me-2"></i>
                        Edit Blocked URL
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editBlockedUrlForm">
                        <input type="hidden" id="editId">
                        <div class="mb-3">
                            <label for="editUrlPattern" class="form-label">URL Pattern *</label>
                            <input type="text" class="form-control" id="editUrlPattern" required>
                        </div>
                        <div class="mb-3">
                            <label for="editReason" class="form-label">Reason for Blocking</label>
                            <textarea class="form-control" id="editReason" rows="2"></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editCategory" class="form-label">Category</label>
                                    <select class="form-select" id="editCategory">
                                        <option value="">Select Category</option>
                                        <option value="social">Social Media</option>
                                        <option value="gaming">Gaming</option>
                                        <option value="shopping">Shopping</option>
                                        <option value="entertainment">Entertainment</option>
                                        <option value="malware">Malware/Phishing</option>
                                        <option value="productivity">Productivity</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Scope</label>
                                    <div class="form-control bg-light" id="editScopeDisplay"></div>
                                    <input type="hidden" id="editDeviceId">
                                    <input type="hidden" id="editUserId">
                                    <div class="form-text" id="editScopeInfo"></div>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="editActive">
                            <label class="form-check-label" for="editActive">Active</label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" id="deleteBlockedUrlBtn">Delete</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-warning" id="updateBlockedUrlBtn">Update</button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>

    <script>
        // Configuration
        // const API_BASE_URL = 'https://dlp.maximusatlas.com/api/python-client';
        const API_BASE_URL = '/api/python-client';
        const REFRESH_INTERVAL = 10000; // 10 seconds
        let refreshTimer;
        let currentDeviceId = null;
        let allDevices = [];
        let deviceDataCache = {};
        let blockedUrlsData = [];

        // Initialize
        $(document).ready(function () {
            // Load initial data
            loadDashboardData();
            loadAllData();

            // Set up auto-refresh
            startAutoRefresh();

            // Set up event listeners
            setupEventListeners();
        });

        function setupEventListeners() {
            // Refresh button
            $('#refreshBtn').click(function () {
                refreshAllData();
            });

            // Search functionality
            $('#searchDevicesBtn').click(() => searchDevices($('#searchDevices').val()));
            $('#searchLogsBtn').click(() => searchLogs($('#searchLogs').val()));
            $('#searchUrlsBtn').click(() => searchUrls($('#searchUrls').val()));

            $('#searchDevices').on('keyup', function(e) {
                if (e.key === 'Enter') searchDevices($(this).val());
            });
            $('#searchLogs').on('keyup', function(e) {
                if (e.key === 'Enter') searchLogs($(this).val());
            });
            $('#searchUrls').on('keyup', function(e) {
                if (e.key === 'Enter') searchUrls($(this).val());
            });

            // Tab change
            $('button[data-bs-toggle="tab"]').on('shown.bs.tab', function (e) {
                const target = $(e.target).attr('data-bs-target');
                if (target === '#logs') loadLogsByDevice();
                if (target === '#urls') loadUrlsByDevice();
                if (target === '#apps') loadAppUsageByDevice();
                if (target === '#certificates') loadCertificatesByDevice();
                if (target === '#blocked') {
                    loadBlockedUrls();
                    loadBlockedUrlsStats();
                }
                if (target === '#partial-access') {
                    loadPartialAccessSites();
                    loadPartialAccessStats();
                }
            });

            // App filters
            $('#showAllDevices').click(function() {
                $(this).addClass('active');
                $('#showCurrentApps').removeClass('active');
                loadAppUsageByDevice();
            });
            $('#showCurrentApps').click(function() {
                $(this).addClass('active');
                $('#showAllDevices').removeClass('active');
                filterCurrentApps();
            });

            // Generate certificates
            $('#generateAllCerts').click(triggerCertificateGeneration);

            // Blocked URLs functionality
            $('#addBlockedUrlBtn').click(() => $('#addBlockedUrlModal').modal('show'));
            $('#addBulkBlockedUrlBtn').click(() => $('#bulkAddBlockedUrlModal').modal('show'));
            $('#refreshBlockedBtn').click(() => {
                loadBlockedUrls();
                loadBlockedUrlsStats();
            });
            $('#searchBlockedBtn').click(() => searchBlockedUrls($('#searchBlockedUrls').val()));
            $('#searchBlockedUrls').on('keyup', function(e) {
                if (e.key === 'Enter') searchBlockedUrls($(this).val());
            });
            $('#filterStatus').change(filterBlockedUrls);
            $('#filterScope').change(filterBlockedUrls);
            $('#scope').change(handleScopeChange);
            $('#bulkScope').change(handleBulkScopeChange);
            $('#saveBlockedUrlBtn').click(saveBlockedUrl);
            $('#saveBulkBlockedUrlsBtn').click(saveBulkBlockedUrls);
            $('#addDeviceBlockedUrlBtn').click(addDeviceBlockedUrl);
            $('#updateBlockedUrlBtn').click(updateBlockedUrl);
            $('#deleteBlockedUrlBtn').click(deleteBlockedUrl);
            // Partial Access functionality
            $('#addPartialAccessBtn').click(() => $('#addPartialAccessModal').modal('show'));
            $('#addBulkPartialAccessBtn').click(() => $('#bulkAddPartialAccessModal').modal('show'));
            $('#refreshPartialBtn').click(() => {
                loadPartialAccessSites();
                loadPartialAccessStats();
            });
            $('#searchPartialBtn').click(() => searchPartialSites($('#searchPartialSites').val()));
            $('#searchPartialSites').on('keyup', function(e) {
                if (e.key === 'Enter') searchPartialSites($(this).val());
            });
            $('#filterPartialStatus').change(filterPartialSites);
            $('#filterPartialScope').change(filterPartialSites);
            $('#partialScope').change(handlePartialScopeChange);
            $('#bulkPartialScope').change(handleBulkPartialScopeChange);
            $('#savePartialAccessBtn').click(savePartialAccessSite);
            $('#saveBulkPartialAccessBtn').click(saveBulkPartialAccessSites);
            $('#addDevicePartialAccessBtn').click(addDevicePartialAccessSite);
            $('#updatePartialAccessBtn').click(updatePartialAccessSite);
            $('#deletePartialAccessBtn').click(deletePartialAccessSite);
            
            $('#refreshDeviceApps').click(function() {
    const date = $('#deviceAppsDate').val();
    if (currentDeviceId) {
        loadDeviceAppsByDate(currentDeviceId, date);
    }
});

$('#deviceAppsDate').change(function() {
    const date = $(this).val();
    if (currentDeviceId) {
        loadDeviceAppsByDate(currentDeviceId, date);
    }
});
        }

        // Main data loading functions
        function loadAllData() {
            loadDevicesByGroup();
            loadLogsByDevice();
            loadUrlsByDevice();
            loadAppUsageByDevice();
            loadCertificatesByDevice();
        }

        function loadDashboardData() {
            $.ajax({
                url: `${API_BASE_URL}/stats`,
                method: 'GET',
                success: function (data) {
                    if (data.success) {
                        const stats = data.data;
                        $('#totalDevices').text(stats.totalDevices || 0);
                        $('#activeDevices').text(`${stats.activeDevices || 0} Active`);
                        $('#totalLogs').text(stats.totalLogs || 0);
                        $('#totalUrls').text(stats.totalUrlData || 0);
                        $('#totalCerts').text(stats.totalCertificates || 0);
                        updateConnectionStatus(true);
                    }
                },
                error: function () {
                    updateConnectionStatus(false);
                }
            });
        }

        // Blocked URLs Functions
        function loadBlockedUrls() {
            $.ajax({
                url: `${API_BASE_URL}/blocked-urls`,
                method: 'GET',
                success: function (data) {
                    if (data.success && data.data) {
                        blockedUrlsData = data.data;
                        renderBlockedUrls(blockedUrlsData);
                    }
                }
            });
        }

        function loadBlockedUrlsStats() {
            $.ajax({
                url: `${API_BASE_URL}/blocked-urls/stats`,
                method: 'GET',
                success: function (data) {
                    if (data.success && data.data) {
                        const stats = data.data;
                        $('#totalBlockedUrls').text(stats.totalUrls || 0);
                        $('#activeBlockedUrls').text(`${stats.activeUrls || 0} Active`);
                        $('#globalBlockedUrls').text(stats.globalUrls || 0);
                        $('#totalBlockedHits').text(stats.totalHits || 0);
                        $('#totalBlockedCategories').text(Object.keys(stats.categoryBreakdown || {}).length || 0);
                        
                        // Load most blocked URLs
                        loadMostBlockedUrls();
                    }
                }
            });
        }

        function loadMostBlockedUrls() {
            $.ajax({
                url: `${API_BASE_URL}/blocked-urls/most-blocked?limit=5`,
                method: 'GET',
                success: function (data) {
                    if (data.success && data.data) {
                        renderMostBlockedUrls(data.data);
                    }
                }
            });
        }

        function renderBlockedUrls(urls) {
            const tbody = $('#blockedUrlsTableBody');
            tbody.empty();

            if (!urls || urls.length === 0) {
                tbody.html(`
                    <tr>
                        <td colspan="8" class="text-center text-muted py-4">
                            <i class="bi bi-ban display-6 mb-3"></i>
                            <h5>No blocked URLs configured</h5>
                            <p>Add URLs to block using the buttons above</p>
                        </td>
                    </tr>
                `);
                return;
            }

            urls.forEach(url => {
                const scope = getScopeDisplay(url);
                const statusBadge = url.active ? 
                    '<span class="badge bg-success">Active</span>' : 
                    '<span class="badge bg-secondary">Inactive</span>';
                
                const row = `
                    <tr data-url-id="${url.id}">
                        <td>
                            <div class="fw-bold">${url.urlPattern}</div>
                            <small class="text-muted">${url.reason || 'No reason specified'}</small>
                        </td>
                        <td>${url.domain || 'N/A'}</td>
                        <td>
                            <span class="badge bg-info">${url.category || 'Uncategorized'}</span>
                        </td>
                        <td>${scope}</td>
                        <td>${statusBadge}</td>
                        <td>
                            <small>${formatTimeAgo(url.updatedAt)}</small>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-warning me-1" onclick="editBlockedUrl('${url.id}')">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-${url.active ? 'secondary' : 'success'}" 
                                    onclick="toggleBlockedUrl('${url.id}', ${!url.active})">
                                <i class="bi bi-power"></i>
                            </button>
                        </td>
                    </tr>
                `;
                tbody.append(row);
            });
        }

        function renderMostBlockedUrls(urls) {
            const container = $('#mostBlockedUrlsContainer');
            container.empty();

            if (!urls || urls.length === 0) {
                container.html('<div class="text-muted">No blocked URL data available</div>');
                return;
            }

            const html = `
                <div class="card">
                    <div class="card-body">
                        ${urls.map((url, index) => `
                            <div class="mb-2 p-2 border rounded">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div style="flex: 1;">
                                        <div class="small text-truncate" title="${url.urlPattern}">
                                            <span class="badge bg-secondary me-2">#${index + 1}</span>
                                            ${url.urlPattern}
                                        </div>
                                        <small class="text-muted">${url.domain || ''}</small>
                                    </div>
                                    <div class="text-end">
                                        <div class="h5 text-danger">${url.hitCount || 0}</div>
                                        <small class="text-muted">blocked</small>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            container.html(html);
        }

        function getScopeDisplay(url) {
            if (url.global) {
                return '<span class="badge bg-primary">Global</span>';
            } else if (url.deviceId) {
                return `<span class="badge bg-warning">Device: ${url.deviceId.substring(0, 8)}...</span>`;
            } else if (url.userId) {
                return `<span class="badge bg-info">User: ${url.userId.substring(0, 8)}...</span>`;
            }
            return '<span class="badge bg-secondary">Unknown</span>';
        }

        function handleScopeChange() {
            const scope = $('#scope').val();
            $('#scopeSpecificFields').show();
            $('#deviceIdField').toggle(scope === 'device');
            $('#userIdField').toggle(scope === 'user');
        }

        function handleBulkScopeChange() {
            const scope = $('#bulkScope').val();
            // You can add similar logic for bulk if needed
        }

        function saveBlockedUrl() {
            const urlPattern = $('#urlPattern').val().trim();
            const reason = $('#reason').val().trim();
            const category = $('#category').val();
            const scope = $('#scope').val();
            const deviceId = scope === 'device' ? $('#deviceId').val().trim() : null;
            const userId = scope === 'user' ? $('#userId').val().trim() : null;
            const active = $('#active').is(':checked');

            if (!urlPattern) {
                showError('URL Pattern is required');
                return;
            }

            const data = {
                urlPattern: urlPattern,
                reason: reason,
                category: category,
                active: active,
                deviceId: deviceId,
                userId: userId
            };

            $.ajax({
                url: `${API_BASE_URL}/blocked-urls`,
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(data),
                success: function (response) {
                    if (response.success) {
                        $('#addBlockedUrlModal').modal('hide');
                        $('#addBlockedUrlForm')[0].reset();
                        showSuccess('Blocked URL added successfully');
                        loadBlockedUrls();
                        loadBlockedUrlsStats();
                    } else {
                        showError(response.message || 'Failed to add blocked URL');
                    }
                },
                error: function (xhr, status, error) {
                    showError('Failed to add blocked URL: ' + error);
                }
            });
        }

        function saveBulkBlockedUrls() {
            const urlsText = $('#bulkUrls').val().trim();
            if (!urlsText) {
                showError('Please enter at least one URL');
                return;
            }

            const urls = urlsText.split('\n')
                .map(url => url.trim())
                .filter(url => url.length > 0);

            if (urls.length === 0) {
                showError('No valid URLs found');
                return;
            }

            const category = $('#bulkCategory').val();
            const reason = $('#bulkReason').val().trim();
            const scope = $('#bulkScope').val();
            const active = $('#bulkActive').is(':checked');

            const blockedUrls = urls.map(url => ({
                urlPattern: url,
                reason: reason,
                category: category,
                active: active
            }));

            const data = {
                blockedUrls: blockedUrls
            };

            $.ajax({
                url: `${API_BASE_URL}/blocked-urls/bulk`,
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(data),
                success: function (response) {
                    if (response.success) {
                        $('#bulkAddBlockedUrlModal').modal('hide');
                        $('#bulkUrls').val('');
                        showSuccess(`Successfully added ${response.data.addedCount} blocked URLs`);
                        loadBlockedUrls();
                        loadBlockedUrlsStats();
                    } else {
                        showError(response.message || 'Failed to add blocked URLs');
                    }
                },
                error: function (xhr, status, error) {
                    showError('Failed to add blocked URLs: ' + error);
                }
            });
        }

        function editBlockedUrl(id) {
            const url = blockedUrlsData.find(u => u.id === id);
            if (!url) return;

            $('#editId').val(url.id);
            $('#editUrlPattern').val(url.urlPattern);
            $('#editReason').val(url.reason || '');
            $('#editCategory').val(url.category || '');
            $('#editActive').prop('checked', url.active);
            $('#editDeviceId').val(url.deviceId || '');
            $('#editUserId').val(url.userId || '');

            let scopeDisplay = '';
            let scopeInfo = '';
            
            if (url.global) {
                scopeDisplay = 'Global (All Devices)';
                scopeInfo = 'Applied to all devices';
            } else if (url.deviceId) {
                scopeDisplay = `Device: ${url.deviceId}`;
                scopeInfo = `Only applied to device: ${url.deviceId}`;
            } else if (url.userId) {
                scopeDisplay = `User: ${url.userId}`;
                scopeInfo = `Only applied to user: ${url.userId}`;
            }

            $('#editScopeDisplay').text(scopeDisplay);
            $('#editScopeInfo').text(scopeInfo);

            $('#editBlockedUrlModal').modal('show');
        }

        function updateBlockedUrl() {
            const id = $('#editId').val();
            const urlPattern = $('#editUrlPattern').val().trim();
            const reason = $('#editReason').val().trim();
            const category = $('#editCategory').val();
            const active = $('#editActive').is(':checked');
            const deviceId = $('#editDeviceId').val();
            const userId = $('#editUserId').val();

            if (!urlPattern) {
                showError('URL Pattern is required');
                return;
            }

            const data = {
                urlPattern: urlPattern,
                reason: reason,
                category: category,
                active: active,
                deviceId: deviceId || null,
                userId: userId || null
            };

            $.ajax({
                url: `${API_BASE_URL}/blocked-urls/${id}`,
                method: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify(data),
                success: function (response) {
                    if (response.success) {
                        $('#editBlockedUrlModal').modal('hide');
                        showSuccess('Blocked URL updated successfully');
                        loadBlockedUrls();
                        loadBlockedUrlsStats();
                    } else {
                        showError(response.message || 'Failed to update blocked URL');
                    }
                },
                error: function (xhr, status, error) {
                    showError('Failed to update blocked URL: ' + error);
                }
            });
        }

        function deleteBlockedUrl() {
            const id = $('#editId').val();
            
            if (!confirm('Are you sure you want to delete this blocked URL?')) {
                return;
            }

            $.ajax({
                url: `${API_BASE_URL}/blocked-urls/${id}`,
                method: 'DELETE',
                success: function (response) {
                    if (response.success) {
                        $('#editBlockedUrlModal').modal('hide');
                        showSuccess('Blocked URL deleted successfully');
                        loadBlockedUrls();
                        loadBlockedUrlsStats();
                    } else {
                        showError(response.message || 'Failed to delete blocked URL');
                    }
                },
                error: function (xhr, status, error) {
                    showError('Failed to delete blocked URL: ' + error);
                }
            });
        }

        function toggleBlockedUrl(id, active) {
            $.ajax({
                url: `${API_BASE_URL}/blocked-urls/${id}/toggle?active=${active}`,
                method: 'PATCH',
                success: function (response) {
                    if (response.success) {
                        showSuccess(`Blocked URL ${active ? 'activated' : 'deactivated'} successfully`);
                        loadBlockedUrls();
                        loadBlockedUrlsStats();
                    } else {
                        showError(response.message || 'Failed to toggle blocked URL');
                    }
                },
                error: function (xhr, status, error) {
                    showError('Failed to toggle blocked URL: ' + error);
                }
            });
        }

        function addDeviceBlockedUrl() {
            if (!currentDeviceId) return;

            // Pre-fill the form with device ID
            $('#scope').val('device');
            $('#deviceId').val(currentDeviceId);
            $('#addBlockedUrlModal').modal('show');
        }

        function searchBlockedUrls(query) {
            if (!query.trim()) {
                $('#blockedUrlsTableBody tr').show();
                return;
            }

            $.ajax({
                url: `${API_BASE_URL}/blocked-urls/search?keyword=${encodeURIComponent(query)}`,
                method: 'GET',
                success: function (data) {
                    if (data.success && data.data) {
                        renderBlockedUrls(data.data);
                    }
                }
            });
        }

        function filterBlockedUrls() {
            const status = $('#filterStatus').val();
            const scope = $('#filterScope').val();

            $('#blockedUrlsTableBody tr').each(function () {
                const $row = $(this);
                let show = true;

                if (status) {
                    const isActive = $row.find('.badge.bg-success').length > 0;
                    if (status === 'active' && !isActive) show = false;
                    if (status === 'inactive' && isActive) show = false;
                }

                if (scope) {
                    const scopeText = $row.find('td:nth-child(4)').text().toLowerCase();
                    if (scope === 'global' && !scopeText.includes('global')) show = false;
                    if (scope === 'device' && !scopeText.includes('device')) show = false;
                    if (scope === 'user' && !scopeText.includes('user')) show = false;
                }

                $row.toggle(show);
            });
        }

        // Device-specific blocked URLs
        function loadDeviceBlockedUrls(deviceId) {
            $.ajax({
                url: `${API_BASE_URL}/blocked-urls`,
                method: 'GET',
                success: function (data) {
                    if (data.success && data.data) {
                        // Filter URLs for this device (global + device-specific)
                        const deviceUrls = data.data.filter(url => 
                            url.global || url.deviceId === deviceId
                        );
                        renderDeviceBlockedUrls(deviceUrls, deviceId);
                    }
                }
            });
        }

        function renderDeviceBlockedUrls(urls, deviceId) {
            const container = $('#deviceBlockedUrlsContent');
            container.empty();

            if (!urls || urls.length === 0) {
                container.html(`
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-ban display-4 mb-3"></i>
                        <h5>No blocked URLs for this device</h5>
                        <p>Add URLs using the button above</p>
                    </div>
                `);
                return;
            }

            const html = `
                <div class="list-group">
                    ${urls.map(url => `
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="fw-bold">${url.urlPattern}</div>
                                    <small class="text-muted">${url.reason || 'No reason specified'}</small>
                                    <div class="mt-1">
                                        <span class="badge bg-info me-1">${url.category || 'Uncategorized'}</span>
                                        ${url.global ? 
                                            '<span class="badge bg-primary">Global</span>' : 
                                            '<span class="badge bg-warning">Device Specific</span>'}
                                        ${url.active ? 
                                            '<span class="badge bg-success">Active</span>' : 
                                            '<span class="badge bg-secondary">Inactive</span>'}
                                    </div>
                                </div>
                                <div>
                                    <button class="btn btn-sm btn-outline-warning me-1" 
                                            onclick="editBlockedUrl('${url.id}')">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-${url.active ? 'secondary' : 'success'}"
                                            onclick="toggleBlockedUrl('${url.id}', ${!url.active})">
                                        <i class="bi bi-power"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            container.html(html);
        }

        // Devices - Grouped by deviceId
        function loadDevicesByGroup() {
            $('#devicesLoading').show();
            $.ajax({
                url: `${API_BASE_URL}/devices`,
                method: 'GET',
                success: function (data) {
                    $('#devicesLoading').hide();
                    if (data.success && data.data) {
                        allDevices = data.data;
                        renderDevicesByGroup(allDevices);
                    } else {
                        $('#devicesContainer').html(`
                            <div class="text-center text-muted py-5">
                                <i class="bi bi-laptop display-4 mb-3"></i>
                                <h5>No devices connected</h5>
                                <p>Python devices will appear here when they register</p>
                            </div>
                        `);
                    }
                },
                error: function () {
                    $('#devicesLoading').hide();
                    showError('Failed to load devices');
                }
            });
        }

        function renderDevicesByGroup(devices) {
            const container = $('#devicesContainer');
            container.empty();

            if (!devices || devices.length === 0) {
                container.html(`
                    <div class="text-center text-muted py-5">
                        <i class="bi bi-laptop display-4 mb-3"></i>
                        <h5>No devices connected</h5>
                        <p>Python devices will appear here when they register</p>
                    </div>
                `);
                return;
            }

            // Sort devices by last heartbeat
            devices.sort((a, b) => new Date(b.lastHeartbeat) - new Date(a.lastHeartbeat));

            devices.forEach(device => {
                // Get latest data for this device
                getLatestLogForDevice(device.deviceId, (latestLog) => {
                    getLatestCertificateForDevice(device.deviceId, (latestCert) => {
                        const deviceCard = createDeviceCard(device, latestLog, latestCert);
                        container.append(deviceCard);
                    });
                });
            });
        }

        function createDeviceCard(device, latestLog, latestCert) {
            const lastSeen = formatTimeAgo(device.lastHeartbeat);
            const statusClass = device.status ? `status-${device.status.toLowerCase()}` : 'status-inactive';
            const deviceName = device.deviceName || device.deviceId.substring(0, 8);
            
            return `
                <div class="card device-card" data-device-id="${device.deviceId}">
                    <div class="device-header">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <div class="d-flex align-items-center">
                                    <div class="device-icon me-3">
                                        <i class="bi bi-laptop"></i>
                                    </div>
                                    <div>
                                        <h5 class="mb-1">${deviceName}</h5>
                                        <div class="d-flex align-items-center">
                                            <span class="device-status ${statusClass} me-2">
                                                ${device.status || 'INACTIVE'}
                                            </span>
                                            <span class="last-seen">
                                                <i class="bi bi-clock me-1"></i>Last seen: ${lastSeen}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4 text-end">
                                <button class="btn btn-primary device-details-btn" 
                                        onclick="showDeviceDetails('${device.deviceId}')">
                                    <i class="bi bi-eye me-1"></i> View Details
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <!-- Latest Log -->
                            <div class="col-md-4">
                                <h6><i class="bi bi-journal-text text-warning me-2"></i>Latest Log</h6>
                                ${latestLog ? `
                                    <div class="device-summary-item" onclick="showDeviceDetails('${device.deviceId}', 'logs')">
                                        <div class="small text-truncate mb-1" title="${latestLog.logContent || 'No content'}">
                                            ${latestLog.logContent ? truncateText(latestLog.logContent, 50) : 'No logs available'}
                                        </div>
                                        <div class="d-flex justify-content-between">
                                            <span class="badge bg-warning log-badge">${latestLog.logType || 'LOG'}</span>
                                            <small class="text-muted">${formatTimeAgo(latestLog.timestamp)}</small>
                                        </div>
                                    </div>
                                ` : `
                                    <div class="text-muted small">No logs available</div>
                                `}
                            </div>
                            
                            <!-- Latest Certificate -->
                            <div class="col-md-4">
                                <h6><i class="bi bi-shield-check text-danger me-2"></i>Latest Certificate</h6>
                                ${latestCert ? `
                                    <div class="device-summary-item" onclick="showCertificateDetails('${latestCert.certificateId}')">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <span class="badge ${getScoreClass(latestCert.score || 0)} certificate-type-badge">
                                                Score: ${latestCert.score || 'N/A'}
                                            </span>
                                            <span class="badge bg-primary certificate-type-badge">
                                                ${latestCert.type || 'CERTIFICATE'}
                                            </span>
                                        </div>
                                        <div class="small text-muted">
                                            <i class="bi bi-calendar me-1"></i>
                                            ${formatTimeAgo(latestCert.generated || latestCert.uploadedAt)}
                                        </div>
                                    </div>
                                ` : `
                                    <div class="text-muted small">No certificates available</div>
                                `}
                            </div>
                            
                            <!-- Device Info -->
                            <div class="col-md-4">
                                <h6><i class="bi bi-info-circle text-primary me-2"></i>Device Info</h6>
                                <div class="small">
                                    <div class="mb-1">
                                        <i class="bi bi-cpu me-2"></i>
                                        <strong>Platform:</strong> ${device.platform || 'Unknown'}
                                    </div>
                                    <div class="mb-1">
                                        <i class="bi bi-tag me-2"></i>
                                        <strong>Version:</strong> ${device.monitorVersion || 'Unknown'}
                                    </div>
                                    <div>
                                        <i class="bi bi-calendar me-2"></i>
                                        <strong>First Seen:</strong> ${formatTimeAgo(device.firstSeen)}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        let partialAccessData = [];

        function loadPartialAccessSites() {
            $.ajax({
                url: `${API_BASE_URL}/partial-access`,
                method: 'GET',
                success: function (data) {
                    if (data.success && data.data) {
                        partialAccessData = data.data;
                        renderPartialAccessSites(partialAccessData);
                    }
                }
            });
        }

        function loadPartialAccessStats() {
            $.ajax({
                url: `${API_BASE_URL}/partial-access/stats`,
                method: 'GET',
                success: function (data) {
                    if (data.success && data.data) {
                        const stats = data.data;
                        $('#totalPartialSites').text(stats.totalSites || 0);
                        $('#activePartialSites').text(`${stats.activeSites || 0} Active`);
                        $('#totalPartialCategories').text(Object.keys(stats.categoryBreakdown || {}).length || 0);
                        
                    }
                }
            });
        }

        function renderPartialAccessSites(sites) {
            const tbody = $('#partialAccessTableBody');
            tbody.empty();

            if (!sites || sites.length === 0) {
                tbody.html(`
                    <tr>
                        <td colspan="9" class="text-center text-muted py-4">
                            <i class="bi bi-shield-half display-6 mb-3"></i>
                            <h5>No partial access sites configured</h5>
                            <p>Add sites using the buttons above</p>
                        </td>
                    </tr>
                `);
                return;
            }

            sites.forEach(site => {
                const scope = getPartialScopeDisplay(site);
                const statusBadge = site.active ? 
                    '<span class="badge bg-success">Active</span>' : 
                    '<span class="badge bg-secondary">Inactive</span>';
                
                const permissions = `
                    ${site.allowUpload ? '<span class="badge bg-warning me-1"><i class="bi bi-upload"></i> Upload</span>' : ''}
                    ${site.allowDownload ? '<span class="badge bg-info"><i class="bi bi-download"></i> Download</span>' : ''}
                    ${!site.allowUpload && !site.allowDownload ? '<span class="badge bg-secondary">Monitor Only</span>' : ''}
                `;
                
                const row = `
                    <tr data-site-id="${site.id}">
                        <td>
                            <div class="fw-bold">${site.urlPattern}</div>
                            <small class="text-muted">${site.reason || 'No reason specified'}</small>
                        </td>
                        <td>${site.domain || 'N/A'}</td>
                        <td>${permissions}</td>
                        <td>
                            <span class="badge bg-info">${site.category || 'Uncategorized'}</span>
                        </td>
                        <td>${scope}</td>
                        <td>${statusBadge}</td>
                        <td>
                            <small>${formatTimeAgo(site.updatedAt)}</small>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-warning me-1" onclick="editPartialAccessSite('${site.id}')">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-${site.active ? 'secondary' : 'success'}" 
                                    onclick="togglePartialAccessSite('${site.id}', ${!site.active})">
                                <i class="bi bi-power"></i>
                            </button>
                        </td>
                    </tr>
                `;
                tbody.append(row);
            });
        }

        function renderMostAttemptedSites(sites) {
            const container = $('#mostAttemptedSitesContainer');
            container.empty();

            if (!sites || sites.length === 0) {
                container.html('<div class="text-muted">No partial access attempt data available</div>');
                return;
            }

            const html = `
                <div class="card">
                    <div class="card-body">
                        ${sites.map((site, index) => `
                            <div class="mb-2 p-2 border rounded">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div style="flex: 1;">
                                        <div class="small text-truncate" title="${site.urlPattern}">
                                            <span class="badge bg-secondary me-2">#${index + 1}</span>
                                            ${site.urlPattern}
                                        </div>
                                        <small class="text-muted">${site.domain || ''}</small>
                                        <div class="mt-1">
                                            ${site.allowUpload ? '<span class="badge bg-warning badge-sm me-1">Upload</span>' : ''}
                                            ${site.allowDownload ? '<span class="badge bg-info badge-sm">Download</span>' : ''}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            container.html(html);
        }

        function getPartialScopeDisplay(site) {
            if (site.global) {
                return '<span class="badge bg-primary">Global</span>';
            } else if (site.deviceId) {
                return `<span class="badge bg-warning">Device: ${site.deviceId.substring(0, 8)}...</span>`;
            } else if (site.userId) {
                return `<span class="badge bg-info">User: ${site.userId.substring(0, 8)}...</span>`;
            }
            return '<span class="badge bg-secondary">Unknown</span>';
        }

        function handlePartialScopeChange() {
            const scope = $('#partialScope').val();
            $('#partialScopeSpecificFields').show();
            $('#partialDeviceIdField').toggle(scope === 'device');
            $('#partialUserIdField').toggle(scope === 'user');
        }

        function handleBulkPartialScopeChange() {
            const scope = $('#bulkPartialScope').val();
            // Similar logic for bulk if needed
        }

        function savePartialAccessSite() {
            const urlPattern = $('#partialUrlPattern').val().trim();
            const reason = $('#partialReason').val().trim();
            const category = $('#partialCategory').val();
            const scope = $('#partialScope').val();
            const deviceId = scope === 'device' ? $('#partialDeviceId').val().trim() : null;
            const userId = scope === 'user' ? $('#partialUserId').val().trim() : null;
            const allowUpload = $('#allowUpload').is(':checked');
            const allowDownload = $('#allowDownload').is(':checked');
            const monitorMode = $('#monitorMode').val();
            const restrictedFileTypes = $('#restrictedFileTypes').val().trim();
            const active = $('#partialActive').is(':checked');

            if (!urlPattern) {
                showError('URL Pattern is required');
                return;
            }

            // Parse restricted file types
            const fileTypesList = restrictedFileTypes ? 
                restrictedFileTypes.split(',').map(type => type.trim()).filter(type => type) : 
                [];

            const data = {
                urlPattern: urlPattern,
                domain: extractDomainFromPattern(urlPattern),
                reason: reason,
                category: category,
                active: active,
                global: scope === 'global',
                deviceId: deviceId,
                userId: userId,
                allowUpload: allowUpload,
                allowDownload: allowDownload,
                monitorMode: monitorMode,
                restrictedFileTypes: fileTypesList
            };

            $.ajax({
                url: `${API_BASE_URL}/partial-access`,
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(data),
                success: function (response) {
                    if (response.success) {
                        $('#addPartialAccessModal').modal('hide');
                        $('#addPartialAccessForm')[0].reset();
                        showSuccess('Partial access site added successfully');
                        loadPartialAccessSites();
                        loadPartialAccessStats();
                    } else {
                        showError(response.message || 'Failed to add partial access site');
                    }
                },
                error: function (xhr, status, error) {
                    showError('Failed to add partial access site: ' + error);
                }
            });
        }

        function saveBulkPartialAccessSites() {
            const urlsText = $('#bulkPartialUrls').val().trim();
            if (!urlsText) {
                showError('Please enter at least one URL');
                return;
            }

            const urls = urlsText.split('\n')
                .map(url => url.trim())
                .filter(url => url.length > 0);

            if (urls.length === 0) {
                showError('No valid URLs found');
                return;
            }

            const category = $('#bulkPartialCategory').val();
            const reason = $('#bulkPartialReason').val().trim();
            const scope = $('#bulkPartialScope').val();
            const allowUpload = $('#bulkAllowUpload').is(':checked');
            const allowDownload = $('#bulkAllowDownload').is(':checked');
            const active = $('#bulkPartialActive').is(':checked');

            const sites = urls.map(url => ({
                urlPattern: url,
                domain: extractDomainFromPattern(url),
                reason: reason,
                category: category,
                active: active,
                global: scope === 'global',
                allowUpload: allowUpload,
                allowDownload: allowDownload,
                monitorMode: 'block'
            }));

            const data = {
                partialAccessSites: sites
            };

            $.ajax({
                url: `${API_BASE_URL}/partial-access/bulk`,
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(data),
                success: function (response) {
                    if (response.success) {
                        $('#bulkAddPartialAccessModal').modal('hide');
                        $('#bulkPartialUrls').val('');
                        showSuccess(`Successfully added ${response.data.addedCount} partial access sites`);
                        loadPartialAccessSites();
                        loadPartialAccessStats();
                    } else {
                        showError(response.message || 'Failed to add partial access sites');
                    }
                },
                error: function (xhr, status, error) {
                    showError('Failed to add partial access sites: ' + error);
                }
            });
        }

        function editPartialAccessSite(id) {
            const site = partialAccessData.find(s => s.id === id);
            if (!site) return;

            $('#editPartialId').val(site.id);
            $('#editPartialUrlPattern').val(site.urlPattern);
            $('#editPartialReason').val(site.reason || '');
            $('#editPartialCategory').val(site.category || '');
            $('#editAllowUpload').prop('checked', site.allowUpload || false);
            $('#editAllowDownload').prop('checked', site.allowDownload || false);
            $('#editMonitorMode').val(site.monitorMode || 'block');
            $('#editPartialActive').prop('checked', site.active);
            $('#editPartialDeviceId').val(site.deviceId || '');
            $('#editPartialUserId').val(site.userId || '');

            // Parse and display restricted file types
            if (site.restrictedFileTypes && Array.isArray(site.restrictedFileTypes)) {
                $('#editRestrictedFileTypes').val(site.restrictedFileTypes.join(', '));
            } else if (site.restrictedFileTypes) {
                $('#editRestrictedFileTypes').val(site.restrictedFileTypes);
            } else {
                $('#editRestrictedFileTypes').val('');
            }

            let scopeDisplay = '';
            let scopeInfo = '';
            
            if (site.global) {
                scopeDisplay = 'Global (All Devices)';
                scopeInfo = 'Applied to all devices';
            } else if (site.deviceId) {
                scopeDisplay = `Device: ${site.deviceId}`;
                scopeInfo = `Only applied to device: ${site.deviceId}`;
            } else if (site.userId) {
                scopeDisplay = `User: ${site.userId}`;
                scopeInfo = `Only applied to user: ${site.userId}`;
            }

            $('#editPartialScopeDisplay').text(scopeDisplay);
            $('#editPartialScopeInfo').text(scopeInfo);

            $('#editPartialAccessModal').modal('show');
        }

        function updatePartialAccessSite() {
            const id = $('#editPartialId').val();
            const urlPattern = $('#editPartialUrlPattern').val().trim();
            const reason = $('#editPartialReason').val().trim();
            const category = $('#editPartialCategory').val();
            const allowUpload = $('#editAllowUpload').is(':checked');
            const allowDownload = $('#editAllowDownload').is(':checked');
            const monitorMode = $('#editMonitorMode').val();
            const restrictedFileTypes = $('#editRestrictedFileTypes').val().trim();
            const active = $('#editPartialActive').is(':checked');
            const deviceId = $('#editPartialDeviceId').val();
            const userId = $('#editPartialUserId').val();

            if (!urlPattern) {
                showError('URL Pattern is required');
                return;
            }

            // Parse restricted file types
            const fileTypesList = restrictedFileTypes ? 
                restrictedFileTypes.split(',').map(type => type.trim()).filter(type => type) : 
                [];

            const data = {
                urlPattern: urlPattern,
                reason: reason,
                category: category,
                active: active,
                global: !deviceId && !userId,
                deviceId: deviceId || null,
                userId: userId || null,
                allowUpload: allowUpload,
                allowDownload: allowDownload,
                monitorMode: monitorMode,
                restrictedFileTypes: fileTypesList
            };

            $.ajax({
                url: `${API_BASE_URL}/partial-access/${id}`,
                method: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify(data),
                success: function (response) {
                    if (response.success) {
                        $('#editPartialAccessModal').modal('hide');
                        showSuccess('Partial access site updated successfully');
                        loadPartialAccessSites();
                        loadPartialAccessStats();
                    } else {
                        showError(response.message || 'Failed to update partial access site');
                    }
                },
                error: function (xhr, status, error) {
                    showError('Failed to update partial access site: ' + error);
                }
            });
        }

        function deletePartialAccessSite() {
            const id = $('#editPartialId').val();
            
            if (!confirm('Are you sure you want to delete this partial access site?')) {
                return;
            }

            $.ajax({
                url: `${API_BASE_URL}/partial-access/${id}`,
                method: 'DELETE',
                success: function (response) {
                    if (response.success) {
                        $('#editPartialAccessModal').modal('hide');
                        showSuccess('Partial access site deleted successfully');
                        loadPartialAccessSites();
                        loadPartialAccessStats();
                    } else {
                        showError(response.message || 'Failed to delete partial access site');
                    }
                },
                error: function (xhr, status, error) {
                    showError('Failed to delete partial access site: ' + error);
                }
            });
        }

        function togglePartialAccessSite(id, active) {
            $.ajax({
                url: `${API_BASE_URL}/partial-access/${id}/toggle?active=${active}`,
                method: 'PATCH',
                success: function (response) {
                    if (response.success) {
                        showSuccess(`Partial access site ${active ? 'activated' : 'deactivated'} successfully`);
                        loadPartialAccessSites();
                        loadPartialAccessStats();
                    } else {
                        showError(response.message || 'Failed to toggle partial access site');
                    }
                },
                error: function (xhr, status, error) {
                    showError('Failed to toggle partial access site: ' + error);
                }
            });
        }

        function addDevicePartialAccessSite() {
            if (!currentDeviceId) return;

            // Pre-fill the form with device ID
            $('#partialScope').val('device');
            $('#partialDeviceId').val(currentDeviceId);
            $('#addPartialAccessModal').modal('show');
        }

        function searchPartialSites(query) {
            if (!query.trim()) {
                $('#partialAccessTableBody tr').show();
                return;
            }

            $.ajax({
                url: `${API_BASE_URL}/partial-access/search?keyword=${encodeURIComponent(query)}`,
                method: 'GET',
                success: function (data) {
                    if (data.success && data.data) {
                        renderPartialAccessSites(data.data);
                    }
                }
            });
        }

        function filterPartialSites() {
            const status = $('#filterPartialStatus').val();
            const scope = $('#filterPartialScope').val();

            $('#partialAccessTableBody tr').each(function () {
                const $row = $(this);
                let show = true;

                if (status) {
                    const isActive = $row.find('.badge.bg-success').length > 0;
                    if (status === 'active' && !isActive) show = false;
                    if (status === 'inactive' && isActive) show = false;
                }

                if (scope) {
                    const scopeText = $row.find('td:nth-child(5)').text().toLowerCase();
                    if (scope === 'global' && !scopeText.includes('global')) show = false;
                    if (scope === 'device' && !scopeText.includes('device')) show = false;
                    if (scope === 'user' && !scopeText.includes('user')) show = false;
                }

                $row.toggle(show);
            });
        }

        // Device-specific partial access sites
        function loadDevicePartialAccessSites(deviceId) {
            $.ajax({
                url: `${API_BASE_URL}/partial-access`,
                method: 'GET',
                success: function (data) {
                    if (data.success && data.data) {
                        // Filter sites for this device (global + device-specific)
                        const deviceSites = data.data.filter(site => 
                            site.global || site.deviceId === deviceId
                        );
                        renderDevicePartialAccessSites(deviceSites, deviceId);
                    }
                }
            });
        }

        function renderDevicePartialAccessSites(sites, deviceId) {
            const container = $('#devicePartialAccessContent');
            container.empty();

            if (!sites || sites.length === 0) {
                container.html(`
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-shield-half display-4 mb-3"></i>
                        <h5>No partial access sites for this device</h5>
                        <p>Add sites using the button above</p>
                    </div>
                `);
                return;
            }

            const html = `
                <div class="list-group">
                    ${sites.map(site => `
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="fw-bold">${site.urlPattern}</div>
                                    <small class="text-muted">${site.reason || 'No reason specified'}</small>
                                    <div class="mt-1">
                                        <span class="badge bg-info me-1">${site.category || 'Uncategorized'}</span>
                                        ${site.global ? 
                                            '<span class="badge bg-primary">Global</span>' : 
                                            '<span class="badge bg-warning">Device Specific</span>'}
                                        ${site.active ? 
                                            '<span class="badge bg-success">Active</span>' : 
                                            '<span class="badge bg-secondary">Inactive</span>'}
                                        ${site.allowUpload ? 
                                            '<span class="badge bg-warning me-1"><i class="bi bi-upload"></i></span>' : ''}
                                        ${site.allowDownload ? 
                                            '<span class="badge bg-info"><i class="bi bi-download"></i></span>' : ''}
                                        <span class="badge bg-dark">${site.monitorMode || 'block'}</span>
                                    </div>
                                </div>
                                <div>
                                    <button class="btn btn-sm btn-outline-warning me-1" 
                                            onclick="editPartialAccessSite('${site.id}')">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-${site.active ? 'secondary' : 'success'}"
                                            onclick="togglePartialAccessSite('${site.id}', ${!site.active})">
                                        <i class="bi bi-power"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            container.html(html);
        }

        // Helper function to extract domain from pattern
        function extractDomainFromPattern(pattern) {
            if (!pattern) return '';
            try {
                let domain = pattern.toLowerCase();
                // Remove protocol
                if (domain.includes('://')) {
                    domain = domain.split('://')[1];
                }
                // Remove path and query
                domain = domain.split('/')[0];
                // Remove wildcards
                domain = domain.replace('*', '');
                // Remove port
                domain = domain.split(':')[0];
                return domain;
            } catch (e) {
                return pattern;
            }
        }
        // Device Details Modal
        function showDeviceDetails(deviceId, defaultTab = 'logs') {
    currentDeviceId = deviceId;
    
    // Reset date filter
    $('#deviceAppsDate').val(new Date().toISOString().split('T')[0]);
    
    // Load device info
    $.ajax({
        url: `${API_BASE_URL}/devices/${deviceId}`,
        method: 'GET',
        success: function (data) {
            if (data.success && data.data) {
                const device = data.data;
                $('#modalDeviceId').text(device.deviceName || device.deviceId);
                renderDeviceInfo(device);
                
                // Load all tabs data
                loadDeviceLogs(deviceId);
                loadDeviceUrls(deviceId);
                loadDeviceAppsByDate(deviceId, new Date().toISOString().split('T')[0]); // Load today's data
                loadDeviceCertificates(deviceId);
                loadDeviceBlockedUrls(deviceId);
                loadDevicePartialAccessSites(deviceId);
                
                // Show default tab
                if (defaultTab) {
                    const tabId = defaultTab === 'blocked' ? 'deviceBlockedUrls' : 
                                 defaultTab === 'partial' ? 'devicePartialAccess' :
                                 `device${defaultTab.charAt(0).toUpperCase() + defaultTab.slice(1)}`;
                    $(`#deviceDetailTabs button[data-bs-target="#${tabId}"]`).tab('show');
                }
                
                $('#deviceModal').modal('show');
            }
        }
    });
}
        // Logs - Grouped by deviceId
        function loadLogsByDevice() {
    $.ajax({
        url: `${API_BASE_URL}/logs`,
        method: 'GET',
        success: function (data) {
            if (data.success && data.data) {
                renderLogsByDevice(data.data);
            } else {
                $('#logsContainer').html(`
                    <div class="text-center text-muted py-5">
                        <i class="bi bi-journal-x display-4 mb-3"></i>
                        <h5>No logs available</h5>
                        <p>Log data will appear here when devices send logs</p>
                    </div>
                `);
            }
        }
    });
}

        function renderLogsByDevice(logs) {
    const container = $('#logsContainer');
    container.empty();

    if (!logs || logs.length === 0) {
        container.html(`
            <div class="text-center text-muted py-5">
                <i class="bi bi-journal-x display-4 mb-3"></i>
                <h5>No logs available</h5>
                <p>Log data will appear here when devices send logs</p>
            </div>
        `);
        return;
    }

    // Group logs by deviceId
    const groupedLogs = {};
    logs.forEach(log => {
        if (!groupedLogs[log.deviceId]) {
            groupedLogs[log.deviceId] = [];
        }
        groupedLogs[log.deviceId].push(log);
    });

    // Sort by most recent log timestamp
    const sortedDeviceIds = Object.keys(groupedLogs).sort((a, b) => {
        const lastA = new Date(groupedLogs[a][0].timestamp);
        const lastB = new Date(groupedLogs[b][0].timestamp);
        return lastB - lastA;
    });

    // Render each device's logs
    sortedDeviceIds.forEach(deviceId => {
        const deviceLogs = groupedLogs[deviceId];
        const device = allDevices.find(d => d.deviceId === deviceId) || {};
        const deviceName = device.deviceName || deviceId.substring(0, 8);
        
        const deviceLogsCard = `
            <div class="card device-card mb-3" data-device-id="${deviceId}">
                <div class="device-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <i class="bi bi-laptop me-2"></i>
                            ${deviceName}
                            <small class="text-muted ms-2">(${deviceId.substring(0, 8)}...)</small>
                        </h6>
                        <button class="btn btn-sm btn-outline-warning" 
                                onclick="showDeviceDetails('${deviceId}', 'logs')">
                            View All Logs (${deviceLogs.length})
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="device-timeline">
                        ${deviceLogs.slice(0, 3).map(log => `
                            <div class="timeline-item">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <div>
                                        <span class="badge ${getLogBadgeClass(log.logType)} me-2">
                                            ${log.logType || 'LOG'}
                                        </span>
                                        <strong>${formatTimeAgo(log.timestamp)}</strong>
                                    </div>
                                    <small class="text-muted">
                                        ${new Date(log.timestamp).toLocaleTimeString()}
                                    </small>
                                </div>
                                <div class="small">
                                    ${log.logContent ? truncateText(log.logContent, 100) : 'No content'}
                                </div>
                            </div>
                        `).join('')}
                        ${deviceLogs.length > 3 ? `
                            <div class="text-center mt-3">
                                <button class="btn btn-sm btn-outline-secondary"
                                        onclick="showDeviceDetails('${deviceId}', 'logs')">
                                    <i class="bi bi-chevron-down me-1"></i>
                                    Show ${deviceLogs.length - 3} more logs
                                </button>
                            </div>
                        ` : ''}
                    </div>
                </div>
            </div>
        `;
        container.append(deviceLogsCard);
    });
}

// URLs - Grouped by deviceId
        function loadUrlsByDevice() {
    $.ajax({
        url: `${API_BASE_URL}/urls`,
        method: 'GET',
        success: function (data) {
            if (data.success && data.data) {
                renderUrlsByDevice(data.data);
            } else {
                $('#urlsContainer').html(`
                    <div class="text-center text-muted py-5">
                        <i class="bi bi-link-45deg display-4 mb-3"></i>
                        <h5>No URL data available</h5>
                        <p>URL monitoring data will appear here</p>
                    </div>
                `);
            }
        }
    });
}

        function renderUrlsByDevice(urls) {
    const container = $('#urlsContainer');
    container.empty();

    if (!urls || urls.length === 0) {
        container.html(`
            <div class="text-center text-muted py-5">
                <i class="bi bi-link-45deg display-4 mb-3"></i>
                <h5>No URL data available</h5>
                <p>URL monitoring data will appear here</p>
            </div>
        `);
        return;
    }

    // Group URLs by deviceId
    const groupedUrls = {};
    urls.forEach(url => {
        if (!groupedUrls[url.deviceId]) {
            groupedUrls[url.deviceId] = [];
        }
        groupedUrls[url.deviceId].push(url);
    });

    // Sort by most recent URL
    const sortedDeviceIds = Object.keys(groupedUrls).sort((a, b) => {
        const lastA = new Date(groupedUrls[a][0].timestamp);
        const lastB = new Date(groupedUrls[b][0].timestamp);
        return lastB - lastA;
    });

    sortedDeviceIds.forEach(deviceId => {
        const deviceUrls = groupedUrls[deviceId];
        const device = allDevices.find(d => d.deviceId === deviceId) || {};
        const deviceName = device.deviceName || deviceId.substring(0, 8);
        
        // Extract all URLs
        let allUrls = [];
        let totalVisits = 0;
        let blockedCount = 0;
        let suspiciousCount = 0;
        
        deviceUrls.forEach(url => {
            totalVisits += url.totalVisits || 0;
            blockedCount += url.blockedCount || 0;
            suspiciousCount += url.suspiciousCount || 0;
            
            if (url.urls) {
                try {
                    const urlList = typeof url.urls === 'string' ? JSON.parse(url.urls) : url.urls;
                    if (Array.isArray(urlList)) {
                        allUrls = allUrls.concat(urlList);
                    }
                } catch (e) {
                    console.error('Error parsing URLs:', e);
                }
            }
        });

        const uniqueUrls = [...new Set(allUrls)];

        const deviceUrlsCard = `
            <div class="card device-card mb-3" data-device-id="${deviceId}">
                <div class="device-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <i class="bi bi-laptop me-2"></i>
                            ${deviceName}
                            <small class="text-muted ms-2">(${deviceId.substring(0, 8)}...)</small>
                        </h6>
                        <button class="btn btn-sm btn-outline-success" 
                                onclick="showDeviceDetails('${deviceId}', 'urls')">
                            View All URLs (${uniqueUrls.length})
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6><i class="bi bi-link-45deg me-2"></i>Recent URLs</h6>
                            <div style="max-height: 200px; overflow-y: auto;">
                                ${uniqueUrls.slice(0, 5).map(url => `
                                    <div class="url-item ${url.includes('suspicious') ? 'suspicious' : ''}">
                                        <div class="small text-truncate" title="${url}">
                                            <i class="bi bi-link-45deg text-secondary me-2"></i>
                                            ${truncateText(url, 40)}
                                        </div>
                                    </div>
                                `).join('')}
                                ${uniqueUrls.length === 0 ? '<div class="text-muted small">No URLs available</div>' : ''}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6><i class="bi bi-graph-up me-2"></i>URL Statistics</h6>
                            <div class="row text-center">
                                <div class="col-4">
                                    <div class="display-6 text-primary">${totalVisits}</div>
                                    <small class="text-muted">Total Visits</small>
                                </div>
                                <div class="col-4">
                                    <div class="display-6 text-warning">${suspiciousCount}</div>
                                    <small class="text-muted">Suspicious</small>
                                </div>
                                <div class="col-4">
                                    <div class="display-6 text-danger">${blockedCount}</div>
                                    <small class="text-muted">Blocked</small>
                                </div>
                            </div>
                            <div class="mt-3">
                                <div class="progress" style="height: 20px;">
                                    <div class="progress-bar bg-success" style="width: ${totalVisits > 0 ? ((totalVisits - suspiciousCount - blockedCount) / totalVisits * 100) : 0}%">
                                        Safe
                                    </div>
                                    <div class="progress-bar bg-warning" style="width: ${totalVisits > 0 ? (suspiciousCount / totalVisits * 100) : 0}%">
                                        Suspicious
                                    </div>
                                    <div class="progress-bar bg-danger" style="width: ${totalVisits > 0 ? (blockedCount / totalVisits * 100) : 0}%">
                                        Blocked
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        container.append(deviceUrlsCard);
    });
}

// App Usage - Grouped by deviceId
        function loadAppUsageByDevice() {
    $.ajax({
        url: `${API_BASE_URL}/app-usage`,
        method: 'GET',
        success: function (data) {
            if (data.success && data.data) {
                renderAppUsageByDevice(data.data);
            } else {
                $('#appsContainer').html(`
                    <div class="text-center text-muted py-5">
                        <i class="bi bi-app display-4 mb-3"></i>
                        <h5>No app usage data available</h5>
                        <p>App usage data will appear here</p>
                    </div>
                `);
            }
        }
    });
}

        async function renderAppUsageByDevice(apps) {
    const container = $('#appsContainer');
    container.empty();

    if (!apps || apps.length === 0) {
        container.html(`
            <div class="text-center text-muted py-5">
                <i class="bi bi-app display-4 mb-3"></i>
                <h5>No app usage data available</h5>
                <p>App usage data will appear here</p>
            </div>
        `);
        return;
    }

    // Group app usage by deviceId
    const groupedApps = {};
    apps.forEach(app => {
        if (!groupedApps[app.deviceId]) {
            groupedApps[app.deviceId] = [];
        }
        groupedApps[app.deviceId].push(app);
    });

    // Sort by most recent app usage
    const sortedDeviceIds = Object.keys(groupedApps).sort((a, b) => {
        const lastA = new Date(groupedApps[a][0].timestamp);
        const lastB = new Date(groupedApps[b][0].timestamp);
        return lastB - lastA;
    });

    // Process each device
    for (const deviceId of sortedDeviceIds) {
        const deviceApps = groupedApps[deviceId];
        const device = allDevices.find(d => d.deviceId === deviceId) || {};
        const deviceName = device.deviceName || deviceId.substring(0, 8);
        
        // Get daily usage data from the new endpoint
        const dailyUsageData = await getDailyAppUsageForDevice(deviceId);
        
        const dailyUsage = parseFloat(dailyUsageData.dailyUsage) || 0;
        const categoryBreakdown = dailyUsageData.categoryBreakdown || {};
        const latestApp = dailyUsageData.latestApp || '';
        const latestSessionDuration = parseFloat(dailyUsageData.latestSessionDuration) || 0;
        const topApps = dailyUsageData.topApps || [];

        const deviceAppsCard = `
            <div class="card device-card mb-3" data-device-id="${deviceId}">
                <div class="device-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <i class="bi bi-laptop me-2"></i>
                            ${deviceName}
                            <small class="text-muted ms-2">(${deviceId.substring(0, 8)}...)</small>
                        </h6>
                        <button class="btn btn-sm btn-outline-info" 
                                onclick="showDeviceDetails('${deviceId}', 'apps')">
                            View All App Data
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="text-center mb-3">
                                <div class="display-6 text-primary">${formatSecondsToTime(dailyUsage)}</div>
                                <small class="text-muted">Today's Usage</small>
                            </div>
                            ${latestApp ? `
                                <div class="text-center">
                                    <div class="h5">${latestApp}</div>
                                    <small class="text-muted">Current: ${formatSecondsToTime(latestSessionDuration)}</small>
                                </div>
                            ` : ''}
                        </div>
                        <div class="col-md-8">
                            <h6><i class="bi bi-bar-chart me-2"></i>App Categories (Today)</h6>
                            ${Object.keys(categoryBreakdown).length > 0 ? `
                                <div class="row">
                                    ${Object.entries(categoryBreakdown).map(([category, time]) => `
                                        <div class="col-6 mb-2">
                                            <div class="d-flex justify-content-between">
                                                <span class="small">${category}</span>
                                                <span class="small text-muted">${formatSecondsToTime(time)}</span>
                                            </div>
                                            <div class="progress" style="height: 5px;">
                                                <div class="progress-bar bg-info" style="width: ${(time / (dailyUsage || 1) * 100) || 0}%"></div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : '<div class="text-muted small">No category data available</div>'}
                        </div>
                    </div>
                    ${topApps.length > 0 ? `
                        <div class="mt-3">
                            <h6><i class="bi bi-star me-2"></i>Top Apps Today</h6>
                            <div class="row">
                                ${topApps.slice(0, 3).map(app => `
                                    <div class="col-md-4">
                                        <div class="card bg-light">
                                            <div class="card-body text-center">
                                                <div class="h6">${app.app || 'Unknown'}</div>
                                                <div class="small text-muted">
                                                    ${formatSecondsToTime(app.active_time || app.total_time || 0)}
                                                </div>
                                                <div class="small">
                                                    <span class="badge bg-secondary">${app.category || 'General'}</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    <div class="mt-3">
                        <h6><i class="bi bi-clock-history me-2"></i>Recent Sessions</h6>
                        ${deviceApps.slice(0, 3).map(app => `
                            <div class="app-usage-card">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>${app.currentApp || 'Unknown App'}</strong>
                                        <div class="small text-muted">
                                            Session: ${formatSecondsToTime(app.currentSessionDuration || 0)}
                                        </div>
                                    </div>
                                    <div class="text-end">
                                        <small class="text-muted d-block">${formatTimeAgo(app.timestamp)}</small>
                                        <small class="text-muted">${new Date(app.timestamp).toLocaleTimeString()}</small>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>
        `;
        container.append(deviceAppsCard);
    }
}
// Certificates - Latest per device
        function loadCertificatesByDevice() {
    $.ajax({
        url: `${API_BASE_URL}/certificates`,
        method: 'GET',
        success: function (data) {
            if (data.success && data.data) {
                renderCertificatesByDevice(data.data);
            } else {
                $('#certificatesContainer').html(`
                    <div class="col-12 text-center text-muted py-5">
                        <i class="bi bi-shield-check display-4 mb-3"></i>
                        <h5>No certificates available</h5>
                        <p>AI-generated certificates will appear here</p>
                    </div>
                `);
            }
        }
    });
}

        function renderCertificatesByDevice(certificates) {
    const container = $('#certificatesContainer');
    container.empty();

    if (!certificates || certificates.length === 0) {
        container.html(`
            <div class="col-12 text-center text-muted py-5">
                <i class="bi bi-shield-check display-4 mb-3"></i>
                <h5>No certificates available</h5>
                        <p>AI-generated certificates will appear here</p>
                    </div>
                `);
                return;
            }

            // Group certificates by deviceId and get the latest one for each
            const latestCertificates = {};
            certificates.forEach(cert => {
                if (!latestCertificates[cert.deviceId] || 
                    new Date(cert.generated || cert.uploadedAt) > 
                    new Date(latestCertificates[cert.deviceId].generated || latestCertificates[cert.deviceId].uploadedAt)) {
                    latestCertificates[cert.deviceId] = cert;
                }
            });

            // Sort by most recent certificate
            const sortedDeviceIds = Object.keys(latestCertificates).sort((a, b) => {
                const dateA = new Date(latestCertificates[a].generated || latestCertificates[a].uploadedAt);
                const dateB = new Date(latestCertificates[b].generated || latestCertificates[b].uploadedAt);
                return dateB - dateA;
            });

            sortedDeviceIds.forEach(deviceId => {
                const cert = latestCertificates[deviceId];
                const device = allDevices.find(d => d.deviceId === deviceId) || {};
                const deviceName = device.deviceName || deviceId.substring(0, 8);
                
                // Parse certificate data - check if it's in JSON fields or direct objects
                let securityMetrics = {};
                if (cert.securityMetrics) {
                    securityMetrics = cert.securityMetrics;
                } else if (cert.securityMetricsJson) {
                    try {
                        securityMetrics = JSON.parse(cert.securityMetricsJson);
                    } catch (e) {
                        console.error('Error parsing security metrics:', e);
                    }
                }
                
                let detailedAnalysis = {};
                if (cert.detailedAnalysis) {
                    detailedAnalysis = cert.detailedAnalysis;
                } else if (cert.detailedAnalysisJson) {
                    try {
                        detailedAnalysis = JSON.parse(cert.detailedAnalysisJson);
                    } catch (e) {
                        console.error('Error parsing detailed analysis:', e);
                    }
                }
                
                // Get score and grade from your data structure
                const score = securityMetrics.overall_score || 0;
                const grade = securityMetrics.grade || 'N/A';
                const threatLevel = securityMetrics.threat_level || 'unknown';
                const safeUrls = securityMetrics.safe_urls || 0;
                const suspiciousUrls = securityMetrics.suspicious_urls || 0;
                const riskyUrls = securityMetrics.risky_urls || 0;
                const totalUrls = securityMetrics.total_urls_analyzed || 0;
                
                // Get statistics from detailed analysis
                const statistics = detailedAnalysis.statistics || {};
                const benignCount = statistics.benign || 0;
                const phishingCount = statistics.phishing || 0;
                const maliciousCount = statistics.malicious || 0;
                const totalAnalyzed = detailedAnalysis.analyzed_urls_count || 0;

                const certificateCard = `
                    <div class="col-md-4 mb-4">
                        <div class="card certificate-card">
                            <div class="card-header" style="background: ${getScoreColor(score)}20; border-bottom: 3px solid ${getScoreColor(score)}">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0">
                                        <i class="bi bi-shield-check me-2"></i>
                                        ${deviceName}
                                    </h6>
                                    <span class="badge ${getScoreClass(score)} certificate-type-badge">
                                        ${grade}
                                    </span>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="text-center mb-3">
                                    <div class="certificate-score" style="color: ${getScoreColor(score)}">
                                        ${typeof score === 'number' ? score.toFixed(1) : '0.0'}
                                    </div>
                                    <small class="text-muted">Security Score</small>
                                </div>
                                
                                <div class="mb-3">
                                    <small class="text-muted d-block">Threat Level:</small>
                                    <span class="badge ${threatLevel === 'low' ? 'bg-success' : threatLevel === 'medium' ? 'bg-warning' : 'bg-danger'}">
                                        ${threatLevel.toUpperCase()}
                                    </span>
                                </div>
                                
                                <div class="mb-3">
                                    <small class="text-muted d-block">URL Analysis:</small>
                                    <div class="url-progress-bar">
                                        ${totalAnalyzed > 0 ? `
                                            <div class="progress mb-1" style="height: 24px;">
                                                ${benignCount > 0 ? `
                                                    <div class="progress-bar bg-success" style="width: ${(benignCount / totalAnalyzed * 100)}%">
                                                        ${benignCount} Safe
                                                    </div>
                                                ` : ''}
                                                ${phishingCount > 0 ? `
                                                    <div class="progress-bar bg-danger" style="width: ${(phishingCount / totalAnalyzed * 100)}%">
                                                        ${phishingCount} Phishing
                                                    </div>
                                                ` : ''}
                                                ${maliciousCount > 0 ? `
                                                    <div class="progress-bar bg-danger" style="width: ${(maliciousCount / totalAnalyzed * 100)}%">
                                                        ${maliciousCount} Malicious
                                                    </div>
                                                ` : ''}
                                            </div>
                                            <div class="small text-center text-muted">
                                                ${totalAnalyzed} URLs analyzed
                                            </div>
                                        ` : `
                                            <div class="text-center text-muted small">
                                                <i class="bi bi-info-circle me-1"></i>
                                                No URL data analyzed
                                            </div>
                                        `}
                                    </div>
                                </div>
                                
                                <!-- URL Breakdown -->
                                <div class="row text-center small mb-3">
                                    <div class="col-4">
                                        <div class="text-success fw-bold">${benignCount}</div>
                                        <small class="text-muted">Safe</small>
                                    </div>
                                    <div class="col-4">
                                        <div class="text-warning fw-bold">${suspiciousUrls}</div>
                                        <small class="text-muted">Suspicious</small>
                                    </div>
                                    <div class="col-4">
                                        <div class="text-danger fw-bold">${phishingCount + maliciousCount}</div>
                                        <small class="text-muted">Risky</small>
                                    </div>
                                </div>
                                
                                <div class="row text-center mb-3">
                                    <div class="col-6">
                                        <small class="text-muted">Device</small>
                                        <div><strong>${deviceName}</strong></div>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted">Generated</small>
                                        <div><strong>${formatTimeAgo(cert.generated || cert.uploadedAt)}</strong></div>
                                    </div>
                                </div>
                            </div>
                            <div class="card-footer bg-transparent">
                                <div class="d-grid gap-2">
                                    <button class="btn btn-sm btn-outline-primary view-cert-btn"
                                            onclick="showCertificateDetails('${cert.certificateId}')">
                                        <i class="bi bi-eye me-1"></i> View Details
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary"
                                            onclick="showDeviceDetails('${deviceId}', 'certificates')">
                                        <i class="bi bi-list-ul me-1"></i> All Certificates
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                container.append(certificateCard);
            });
        }

        function renderDeviceInfo(device) {
            const deviceName = device.deviceName || 'Unknown';
            const platform = device.platform || 'Unknown';
            const version = device.monitorVersion || 'Unknown';
            const firstSeen = device.firstSeen ? new Date(device.firstSeen).toLocaleString() : 'Unknown';
            const lastHeartbeat = device.lastHeartbeat ? new Date(device.lastHeartbeat).toLocaleString() : 'Unknown';
            const status = device.status || 'unknown';
            
            const content = `
                <div class="mb-3">
                    <h6>Device ID:</h6>
                    <div class="text-truncate bg-light p-2 rounded">
                        <code>${device.deviceId}</code>
                    </div>
                </div>
                <table class="table table-sm">
                    <tr><th>Device Name:</th><td>${deviceName}</td></tr>
                    <tr><th>Platform:</th><td>${platform}</td></tr>
                    <tr><th>Version:</th><td>${version}</td></tr>
                    <tr><th>Status:</th><td><span class="device-status status-${status.toLowerCase()}">${status.toUpperCase()}</span></td></tr>
                    <tr><th>First Seen:</th><td>${firstSeen}</td></tr>
                    <tr><th>Last Heartbeat:</th><td>${lastHeartbeat}</td></tr>
                    <tr><th>User ID:</th><td><small>${device.userId || 'N/A'}</small></td></tr>
                </table>
            `;
            $('#deviceInfoContent').html(content);
        }

        function loadDeviceLogs(deviceId) {
            $.ajax({
                url: `${API_BASE_URL}/devices/${deviceId}/logs`,
                method: 'GET',
                success: function (data) {
                    if (data.success && data.data) {
                        const logs = data.data;
                        const logsHtml = logs.length > 0 ? logs.map(log => `
                            <div class="timeline-item mb-3">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <span class="badge ${getLogBadgeClass(log.logType)} me-2">
                                            ${log.logType || 'LOG'}
                                        </span>
                                        <strong>${formatTimeAgo(log.timestamp)}</strong>
                                    </div>
                                    <small class="text-muted">
                                        ${new Date(log.timestamp).toLocaleString()}
                                    </small>
                                </div>
                                <div class="mt-2 p-2 bg-light rounded">${log.logContent || 'No content'}</div>
                            </div>
                        `).join('') : '<div class="text-muted text-center py-4">No logs available</div>';
                        $('#deviceLogsContent').html(logsHtml);
                    }
                }
            });
        }

        function loadDeviceUrls(deviceId) {
            $.ajax({
                url: `${API_BASE_URL}/devices/${deviceId}/urls`,
                method: 'GET',
                success: function (data) {
                    if (data.success && data.data) {
                        const urls = data.data;
                        let allUrls = [];
                        let totalVisits = 0;
                        let blockedCount = 0;
                        let suspiciousCount = 0;
                        
                        urls.forEach(url => {
                            totalVisits += url.totalVisits || 0;
                            blockedCount += url.blockedCount || 0;
                            suspiciousCount += url.suspiciousCount || 0;
                            
                            if (url.urls) {
                                try {
                                    const urlList = typeof url.urls === 'string' ? JSON.parse(url.urls) : url.urls;
                                    if (Array.isArray(urlList)) {
                                        allUrls = allUrls.concat(urlList);
                                    }
                                } catch (e) {
                                    console.error('Error parsing URLs:', e);
                                }
                            }
                        });
                        
                        const uniqueUrls = [...new Set(allUrls)];
                        const urlsHtml = `
                            <div class="mb-4">
                                <div class="row text-center">
                                    <div class="col-4">
                                        <div class="display-4 text-primary">${totalVisits}</div>
                                        <small class="text-muted">Total Visits</small>
                                    </div>
                                    <div class="col-4">
                                        <div class="display-4 text-warning">${suspiciousCount}</div>
                                        <small class="text-muted">Suspicious</small>
                                    </div>
                                    <div class="col-4">
                                        <div class="display-4 text-danger">${blockedCount}</div>
                                        <small class="text-muted">Blocked</small>
                                    </div>
                                </div>
                            </div>
                            <h6>All URLs (${uniqueUrls.length} unique):</h6>
                            <div style="max-height: 300px; overflow-y: auto;">
                                ${uniqueUrls.map(url => `
                                    <div class="url-item mb-2">
                                        <div class="small">
                                            <i class="bi bi-link-45deg text-secondary me-2"></i>
                                            ${url}
                                        </div>
                                    </div>
                                `).join('')}
                                ${uniqueUrls.length === 0 ? '<div class="text-muted text-center py-4">No URLs available</div>' : ''}
                            </div>
                        `;
                        $('#deviceUrlsContent').html(urlsHtml);
                    }
                }
            });
        }

        function loadDeviceApps(deviceId) {
    // First, load the daily summary
    $.ajax({
        url: `${API_BASE_URL}/devices/${deviceId}/app-usage/daily`,
        method: 'GET',
        success: function (dailyData) {
            if (dailyData.success && dailyData.data) {
                const dailyUsage = dailyData.data;
                
                // Then load all historical sessions for the list
                $.ajax({
                    url: `${API_BASE_URL}/devices/${deviceId}/app-usage`,
                    method: 'GET',
                    success: function (allData) {
                        if (allData.success && allData.data) {
                            const allApps = allData.data;
                            renderDeviceApps(dailyUsage, allApps);
                        }
                    }
                });
            } else {
                // Fallback to old method if daily endpoint fails
                $.ajax({
                    url: `${API_BASE_URL}/devices/${deviceId}/app-usage`,
                    method: 'GET',
                    success: function (data) {
                        if (data.success && data.data) {
                            const apps = data.data;
                            // Create a mock daily data structure
                            const mockDailyData = {
                                dailyUsage: 0,
                                categoryBreakdown: {},
                                latestApp: '',
                                latestSessionDuration: 0,
                                topApps: []
                            };
                            renderDeviceApps(mockDailyData, apps);
                        }
                    }
                });
            }
        },
        error: function () {
            // Fallback if daily endpoint fails
            $.ajax({
                url: `${API_BASE_URL}/devices/${deviceId}/app-usage`,
                method: 'GET',
                success: function (data) {
                    if (data.success && data.data) {
                        const apps = data.data;
                        // Create a mock daily data structure
                        const mockDailyData = {
                            dailyUsage: 0,
                            categoryBreakdown: {},
                            latestApp: '',
                            latestSessionDuration: 0,
                            topApps: []
                        };
                        renderDeviceApps(mockDailyData, apps);
                    }
                }
            });
        }
    });
}
        
        function loadDeviceCertificates(deviceId) {
            $.ajax({
                url: `${API_BASE_URL}/devices/${deviceId}/certificates`,
                method: 'GET',
                success: function (data) {
                    if (data.success && data.data) {
                        const certificates = data.data;
                        const certsHtml = certificates.length > 0 ? certificates.map(cert => {
                            // Parse certificate data
                            let securityMetrics = {};
                            if (cert.securityMetrics) {
                                securityMetrics = cert.securityMetrics;
                            } else if (cert.securityMetricsJson) {
                                try {
                                    securityMetrics = JSON.parse(cert.securityMetricsJson);
                                } catch (e) {
                                    console.error('Error parsing security metrics:', e);
                                }
                            }
                            
                            const score = securityMetrics.overall_score || 0;
                            const grade = securityMetrics.grade || 'N/A';
                            const certId = cert.certificateId || 'Unknown';
                            const generated = cert.generated || cert.uploadedAt;
                            
                            return `
                                <div class="card mb-3">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <h6 class="mb-1">${certId}</h6>
                                                <small class="text-muted">
                                                    Generated: ${formatTimeAgo(generated)}
                                                </small>
                                            </div>
                                            <div class="text-end">
                                                <div class="display-6" style="color: ${getScoreColor(score)}">
                                                    ${typeof score === 'number' ? score.toFixed(1) : '0.0'}
                                                </div>
                                                <small class="text-muted">${grade}</small>
                                            </div>
                                        </div>
                                        <button class="btn btn-sm btn-outline-primary w-100 mt-2"
                                                onclick="showCertificateDetails('${certId}')">
                                            View Details
                                        </button>
                                    </div>
                                </div>
                            `;
                        }).join('') : '<div class="text-muted text-center py-4">No certificates available</div>';
                        $('#deviceCertsContent').html(certsHtml);
                    }
                }
            });
        }

        // Certificate Details Modal
        function showCertificateDetails(certificateId) {
            // Create modal dynamically
            const modalHtml = `
                <div class="modal fade" id="certModal" tabindex="-1">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                            <div class="modal-header bg-primary text-white">
                                <h5 class="modal-title">
                                    <i class="bi bi-shield-check me-2"></i>
                                    Certificate Details
                                </h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body" id="certModalContent">
                                <div class="text-center">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if any
            $('#certModal').remove();
            $('body').append(modalHtml);
            
            // Load certificate data
            $.ajax({
                url: `${API_BASE_URL}/certificates`,
                method: 'GET',
                success: function (data) {
                    if (data.success && data.data) {
                        const cert = data.data.find(c => c.certificateId === certificateId);
                        if (cert) {
                            renderCertificateDetails(cert);
                            $('#certModal').modal('show');
                        }
                    }
                }
            });
        }

        function renderCertificateDetails(cert) {
            // Parse certificate data
            let securityMetrics = {};
            if (cert.securityMetrics) {
                securityMetrics = cert.securityMetrics;
            } else if (cert.securityMetricsJson) {
                try {
                    securityMetrics = JSON.parse(cert.securityMetricsJson);
                } catch (e) {
                    console.error('Error parsing security metrics:', e);
                }
            }
            
            let detailedAnalysis = {};
            if (cert.detailedAnalysis) {
                detailedAnalysis = cert.detailedAnalysis;
            } else if (cert.detailedAnalysisJson) {
                try {
                    detailedAnalysis = JSON.parse(cert.detailedAnalysisJson);
                } catch (e) {
                    console.error('Error parsing detailed analysis:', e);
                }
            }
            
            let recommendations = [];
            if (cert.recommendations) {
                recommendations = cert.recommendations;
            } else if (cert.recommendationsJson) {
                try {
                    recommendations = JSON.parse(cert.recommendationsJson);
                } catch (e) {
                    console.error('Error parsing recommendations:', e);
                }
            }
            
            let signature = {};
            if (cert.signature) {
                signature = cert.signature;
            } else if (cert.signatureJson) {
                try {
                    signature = JSON.parse(cert.signatureJson);
                } catch (e) {
                    console.error('Error parsing signature:', e);
                }
            }
            
            // Extract data
            const score = securityMetrics.overall_score || 0;
            const grade = securityMetrics.grade || 'N/A';
            const threatLevel = securityMetrics.threat_level || 'unknown';
            const safeUrls = securityMetrics.safe_urls || 0;
            const suspiciousUrls = securityMetrics.suspicious_urls || 0;
            const riskyUrls = securityMetrics.risky_urls || 0;
            const totalUrls = securityMetrics.total_urls_analyzed || 0;
            const checksPassed = securityMetrics.checks_passed || 0;
            const checksTotal = securityMetrics.checks_total || 0;
            const modelConfidence = securityMetrics.model_confidence || 'unknown';
            
            const statistics = detailedAnalysis.statistics || {};
            const benignCount = statistics.benign || 0;
            const phishingCount = statistics.phishing || 0;
            const maliciousCount = statistics.malicious || 0;
            const defacementCount = statistics.defacement || 0;
            const suspiciousCount = statistics.suspicious || 0;
            const totalAnalyzed = detailedAnalysis.analyzed_urls_count || 0;
            
            const urlResults = detailedAnalysis.detailed_url_results || detailedAnalysis.sample_results || [];
            const modelsUsed = detailedAnalysis.models_used || ['URLBERT', 'RoBERTa'];
            const analysisMethod = detailedAnalysis.analysis_method || 'dual_model_ai';
            
            const content = `
                <div class="row">
                    <div class="col-md-4">
                        <div class="card h-100">
                            <div class="card-body text-center">
                                <div class="display-2 fw-bold" style="color: ${getScoreColor(score)}">
                                    ${typeof score === 'number' ? score.toFixed(1) : '0.0'}
                                </div>
                                <div class="h3 mb-3" style="color: ${getScoreColor(score)}">
                                    ${grade}
                                </div>
                                <div class="mb-3">
                                    <span class="badge ${threatLevel === 'low' ? 'bg-success' : threatLevel === 'medium' ? 'bg-warning' : 'bg-danger'} fs-6">
                                        ${threatLevel.toUpperCase()} THREAT LEVEL
                                    </span>
                                </div>
                                <div class="small text-muted">
                                    <div>Model Confidence: <span class="badge bg-info">${modelConfidence.toUpperCase()}</span></div>
                                    <div>Checks: ${checksPassed}/${checksTotal} passed</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <div class="card h-100">
                            <div class="card-body">
                                <h6>Certificate Information</h6>
                                <table class="table table-sm">
                                    <tr><th>Certificate ID:</th><td>${cert.certificateId}</td></tr>
                                    <tr><th>Device:</th><td>${cert.device || 'N/A'}</td></tr>
                                    <tr><th>Device ID:</th><td>${cert.deviceId}</td></tr>
                                    <tr><th>Generated:</th><td>${formatTimeAgo(cert.generated || cert.uploadedAt)}</td></tr>
                                    <tr><th>Analysis Method:</th><td>${analysisMethod}</td></tr>
                                    <tr><th>Models Used:</th><td>${Array.isArray(modelsUsed) ? modelsUsed.join(', ') : modelsUsed}</td></tr>
                                    ${signature.generated_by ? `<tr><th>Generated By:</th><td>${signature.generated_by}</td></tr>` : ''}
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row mt-4">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">URL Analysis Summary</h6>
                            </div>
                            <div class="card-body">
                                <div class="row text-center">
                                    <div class="col-3">
                                        <div class="h4 text-success">${benignCount}</div>
                                        <small class="text-muted">Safe</small>
                                    </div>
                                    <div class="col-3">
                                        <div class="h4 text-warning">${suspiciousCount}</div>
                                        <small class="text-muted">Suspicious</small>
                                    </div>
                                    <div class="col-3">
                                        <div class="h4 text-danger">${phishingCount}</div>
                                        <small class="text-muted">Phishing</small>
                                    </div>
                                    <div class="col-3">
                                        <div class="h4 text-danger">${maliciousCount}</div>
                                        <small class="text-muted">Malicious</small>
                                    </div>
                                </div>
                                <div class="progress mt-3" style="height: 25px;">
                                    ${benignCount > 0 ? `
                                        <div class="progress-bar bg-success" style="width: ${(benignCount / totalAnalyzed * 100)}%">
                                            Safe: ${benignCount}
                                        </div>
                                    ` : ''}
                                    ${suspiciousCount > 0 ? `
                                        <div class="progress-bar bg-warning" style="width: ${(suspiciousCount / totalAnalyzed * 100)}%">
                                            Suspicious: ${suspiciousCount}
                                        </div>
                                    ` : ''}
                                    ${phishingCount > 0 ? `
                                        <div class="progress-bar bg-danger" style="width: ${(phishingCount / totalAnalyzed * 100)}%">
                                            Phishing: ${phishingCount}
                                        </div>
                                    ` : ''}
                                    ${maliciousCount > 0 ? `
                                        <div class="progress-bar bg-danger" style="width: ${(maliciousCount / totalAnalyzed * 100)}%">
                                            Malicious: ${maliciousCount}
                                        </div>
                                    ` : ''}
                                </div>
                                <div class="text-center mt-2 small text-muted">
                                    Total URLs analyzed: ${totalAnalyzed}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">Top Recommendations</h6>
                            </div>
                            <div class="card-body">
                                ${recommendations.length > 0 ? recommendations.map(rec => `
                                    <div class="mb-2 p-2 border rounded">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <strong>${rec.action || 'N/A'}</strong>
                                            <span class="badge ${rec.priority === 'high' ? 'bg-danger' : rec.priority === 'medium' ? 'bg-warning' : 'bg-info'}">
                                                ${rec.priority || 'low'} priority
                                            </span>
                                        </div>
                                        <div class="small text-muted">${rec.description || ''}</div>
                                    </div>
                                `).join('') : '<div class="text-muted text-center py-3">No recommendations available</div>'}
                            </div>
                        </div>
                    </div>
                </div>
                
                ${urlResults.length > 0 ? `
                    <div class="mt-4">
                        <div class="card">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">Detailed URL Analysis (${urlResults.length} URLs)</h6>
                            </div>
                            <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                                ${urlResults.map(result => {
                                    const url = result.url || 'Unknown URL';
                                    const domain = result.domain || url.split('/')[2] || url;
                                    const finalCategory = result.final_category || 'unknown';
                                    const finalConfidence = result.final_confidence || 0;
                                    const urlbertPredictions = result.urlbert_predictions || {};
                                    
                                    return `
                                        <div class="mb-3 p-3 border rounded">
                                            <div class="d-flex justify-content-between align-items-start">
                                                <div style="flex: 1;">
                                                    <div class="small text-truncate" title="${url}">
                                                        <i class="bi bi-link-45deg me-1"></i>
                                                        ${url}
                                                    </div>
                                                    <div class="mt-2">
                                                        <span class="badge ${getCategoryBadgeClass(finalCategory)} me-2">
                                                            ${finalCategory.toUpperCase()}
                                                        </span>
                                                        <span class="badge bg-dark">${domain}</span>
                                                    </div>
                                                </div>
                                                <div class="text-end">
                                                    <div class="h5">${finalConfidence.toFixed(1)}%</div>
                                                    <small class="text-muted">Confidence</small>
                                                </div>
                                            </div>
                                            ${Object.keys(urlbertPredictions).length > 0 ? `
                                                <div class="mt-2">
                                                    <small class="text-muted d-block mb-1">Model Predictions:</small>
                                                    <div class="row g-2">
                                                        ${Object.entries(urlbertPredictions).map(([category, confidence]) => `
                                                            <div class="col-6">
                                                                <div class="d-flex justify-content-between small">
                                                                    <span>${category}:</span>
                                                                    <span class="fw-bold">${confidence.toFixed(2)}%</span>
                                                                </div>
                                                                <div class="progress" style="height: 3px;">
                                                                    <div class="progress-bar ${getCategoryProgressBarClass(category)}" style="width: ${confidence}%"></div>
                                                                </div>
                                                            </div>
                                                        `).join('')}
                                                    </div>
                                                </div>
                                            ` : ''}
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                ` : ''}
            `;
            
            $('#certModalContent').html(content);
        }

        // Helper functions for getting latest data
        function getLatestLogForDevice(deviceId, callback) {
            $.ajax({
                url: `${API_BASE_URL}/devices/${deviceId}/logs`,
                method: 'GET',
                success: function (data) {
                    if (data.success && data.data && data.data.length > 0) {
                        // Get the latest log (first in the array since it's sorted by timestamp desc)
                        callback(data.data[0]);
                    } else {
                        callback(null);
                    }
                },
                error: function () {
                    callback(null);
                }
            });
        }

        function getLatestCertificateForDevice(deviceId, callback) {
            $.ajax({
                url: `${API_BASE_URL}/devices/${deviceId}/certificates`,
                method: 'GET',
                success: function (data) {
                    if (data.success && data.data && data.data.length > 0) {
                        // Get the latest certificate (first in the array)
                        const cert = data.data[0];
                        
                        // Parse score for display
                        let securityMetrics = {};
                        if (cert.securityMetrics) {
                            securityMetrics = cert.securityMetrics;
                        } else if (cert.securityMetricsJson) {
                            try {
                                securityMetrics = JSON.parse(cert.securityMetricsJson);
                            } catch (e) {
                                console.error('Error parsing security metrics:', e);
                            }
                        }
                        
                        cert.score = securityMetrics.overall_score || 0;
                        cert.type = 'AI Certificate';
                        callback(cert);
                    } else {
                        callback(null);
                    }
                },
                error: function () {
                    callback(null);
                }
            });
        }

        // Search and filter functions
        function searchDevices(query) {
            query = query.toLowerCase();
            if (!query.trim()) {
                $('.device-card[data-device-id]').show();
                return;
            }
            
            $('.device-card[data-device-id]').each(function () {
                const text = $(this).text().toLowerCase();
                $(this).toggle(text.includes(query));
            });
        }

        function searchLogs(query) {
            query = query.toLowerCase();
            if (!query.trim()) {
                $('#logsContainer .device-card').show();
                return;
            }
            
            $('#logsContainer .device-card').each(function () {
                const text = $(this).text().toLowerCase();
                $(this).toggle(text.includes(query));
            });
        }

        function searchUrls(query) {
            query = query.toLowerCase();
            if (!query.trim()) {
                $('#urlsContainer .device-card').show();
                return;
            }
            
            $('#urlsContainer .device-card').each(function () {
                const text = $(this).text().toLowerCase();
                $(this).toggle(text.includes(query));
            });
        }

        function filterCurrentApps() {
            $('#appsContainer .device-card').each(function () {
                const hasCurrent = $(this).find('.app-usage-card').length > 0;
                $(this).toggle(hasCurrent);
            });
        }

        // Utility functions
        function formatSecondsToTime(seconds) {
            if (!seconds) return '0s';
            seconds = parseFloat(seconds);
            const hrs = Math.floor(seconds / 3600);
            const mins = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);
            
            if (hrs > 0) return `${hrs}h ${mins.toString().padStart(2, '0')}m`;
            if (mins > 0) return `${mins}m ${secs.toString().padStart(2, '0')}s`;
            return `${secs}s`;
        }

        function getLogBadgeClass(logType) {
            if (!logType) return 'bg-secondary';
            const type = logType.toLowerCase();
            if (type.includes('alert') || type.includes('block')) return 'bg-danger';
            if (type.includes('url')) return 'bg-success';
            if (type.includes('app')) return 'bg-info';
            return 'bg-secondary';
        }

        function getScoreColor(score) {
            if (score >= 80) return '#4cc9f0'; // Blue for good
            if (score >= 60) return '#f8961e'; // Orange for medium
            return '#f72585'; // Red for poor
        }

        function getCategoryBadgeClass(category) {
            if (!category) return 'bg-secondary';
            const cat = category.toLowerCase();
            if (cat.includes('benign') || cat.includes('safe')) return 'bg-success';
            if (cat.includes('malicious') || cat.includes('malware')) return 'bg-danger';
            if (cat.includes('phishing')) return 'bg-danger';
            if (cat.includes('suspicious')) return 'bg-warning';
            if (cat.includes('defacement')) return 'bg-warning';
            return 'bg-secondary';
        }

        function getCategoryProgressBarClass(category) {
            if (!category) return 'bg-secondary';
            const cat = category.toLowerCase();
            if (cat.includes('benign') || cat.includes('safe')) return 'bg-success';
            if (cat.includes('malicious') || cat.includes('malware')) return 'bg-danger';
            if (cat.includes('phishing')) return 'bg-danger';
            if (cat.includes('suspicious')) return 'bg-warning';
            if (cat.includes('defacement')) return 'bg-warning';
            return 'bg-secondary';
        }

        // Helper functions
        function showSuccess(message) {
            const toast = `
                <div class="toast align-items-center text-white bg-success border-0 position-fixed" 
                     style="bottom: 20px; right: 20px; z-index: 9999;">
                    <div class="d-flex">
                        <div class="toast-body">
                            <i class="bi bi-check-circle me-2"></i>${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `;
            $('body').append(toast);
            $('.toast').toast('show');
            setTimeout(() => $('.toast').remove(), 3000);
        }

        function showError(message) {
            const toast = `
                <div class="toast align-items-center text-white bg-danger border-0 position-fixed" 
                     style="bottom: 20px; right: 20px; z-index: 9999;">
                    <div class="d-flex">
                        <div class="toast-body">
                            <i class="bi bi-exclamation-triangle me-2"></i>${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `;
            $('body').append(toast);
            $('.toast').toast('show');
            setTimeout(() => $('.toast').remove(), 5000);
        }

        function formatTimeAgo(timestamp) {
            if (!timestamp) return 'Unknown';
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;

            if (diff < 60000) return 'Just now';
            if (diff < 3600000) return `${Math.floor(diff / 60000)} minutes ago`;
            if (diff < 86400000) return `${Math.floor(diff / 3600000)} hours ago`;
            return `${Math.floor(diff / 86400000)} days ago`;
        }

        function truncateText(text, maxLength) {
            if (!text) return 'No content';
            if (text.length <= maxLength) return text;
            return text.substring(0, maxLength) + '...';
        }

        function getScoreClass(score) {
            if (score >= 80) return 'bg-success';
            if (score >= 60) return 'bg-warning';
            return 'bg-danger';
        }

        function updateConnectionStatus(connected) {
            const statusEl = $('#connectionStatus');
            const badge = $('.connection-status');
            if (connected) {
                statusEl.text('Connected to Backend');
                badge.removeClass('disconnected').addClass('connected');
                $('#liveBadge').show();
            } else {
                statusEl.text('Disconnected');
                badge.removeClass('connected').addClass('disconnected');
                $('#liveBadge').hide();
            }
        }

        function refreshAllData() {
            loadDashboardData();
            loadAllData();
        }

        function startAutoRefresh() {
            refreshTimer = setInterval(refreshAllData, REFRESH_INTERVAL);
        }

        $(window).on('beforeunload', function () {
            if (refreshTimer) clearInterval(refreshTimer);
        });

        // Certificate generation
        function triggerCertificateGeneration() {
            $.ajax({
                url: `${API_BASE_URL}/certificates/generate-all`,
                method: 'POST',
                success: function (data) {
                    if (data.success) {
                        alert('Certificate generation triggered!');
                        setTimeout(() => loadCertificatesByDevice(), 3000);
                    } else {
                        alert('Failed to generate certificates: ' + (data.message || 'Unknown error'));
                    }
                },
                error: function (xhr, status, error) {
                    alert('Failed to generate certificates: ' + error);
                }
            });
        }

        function getDailyAppUsageForDevice(deviceId) {
    return new Promise((resolve, reject) => {
        $.ajax({
            url: `${API_BASE_URL}/devices/${deviceId}/app-usage/daily`,
            method: 'GET',
            success: function (data) {
                if (data.success && data.data) {
                    resolve(data.data);
                } else {
                    resolve({
                        dailyUsage: 0,
                        categoryBreakdown: {}
                    });
                }
            },
            error: function () {
                resolve({
                    dailyUsage: 0,
                    categoryBreakdown: {}
                });
            }
        });
    });
}
    
        function renderDeviceApps(dailyUsage, allApps) {
    const dailyTotal = parseFloat(dailyUsage.dailyUsage) || 0;
    const categoryBreakdown = dailyUsage.categoryBreakdown || {};
    const latestApp = dailyUsage.latestApp || '';
    const latestSessionDuration = parseFloat(dailyUsage.latestSessionDuration) || 0;
    const topApps = dailyUsage.topApps || [];
    
    // Calculate total historical time from all apps
    let totalHistoricalTime = 0;
    if (allApps && allApps.length > 0) {
        allApps.forEach(app => {
            totalHistoricalTime += parseFloat(app.activeUsageTime) || 0;
        });
    }
    
    const appsHtml = `
        <div class="mb-4">
            <div class="row text-center">
                <div class="col-6">
                    <div class="display-4 text-primary">${formatSecondsToTime(dailyTotal)}</div>
                    <small class="text-muted">Today's Usage</small>
                </div>
                <div class="col-6">
                    <div class="display-4 text-info">${formatSecondsToTime(totalHistoricalTime)}</div>
                    <small class="text-muted">Total Historical</small>
                </div>
            </div>
        </div>
        
        ${Object.keys(categoryBreakdown).length > 0 ? `
            <div class="mb-4">
                <h6>Today's Category Breakdown:</h6>
                <div class="row">
                    ${Object.entries(categoryBreakdown).map(([category, time]) => `
                        <div class="col-12 mb-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <div style="flex: 1;">
                                    <strong>${category}</strong>
                                    <div class="progress mt-1" style="height: 8px;">
                                        <div class="progress-bar bg-info" style="width: ${(time / (dailyTotal || 1) * 100) || 0}%"></div>
                                    </div>
                                </div>
                                <span class="text-muted ms-2">${formatSecondsToTime(time)}</span>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        ` : '<div class="text-muted text-center py-4">No category data available for today</div>'}
        
        ${topApps.length > 0 ? `
            <div class="mb-4">
                <h6>Top Apps Today:</h6>
                <div class="row">
                    ${topApps.slice(0, 4).map(app => `
                        <div class="col-md-3 col-6 mb-2">
                            <div class="card bg-light h-100">
                                <div class="card-body text-center">
                                    <div class="h6 text-truncate" title="${app.app || 'Unknown'}">
                                        ${app.app || 'Unknown'}
                                    </div>
                                    <div class="small text-muted">
                                        ${formatSecondsToTime(app.active_time || app.total_time || 0)}
                                    </div>
                                    <div class="small">
                                        <span class="badge bg-secondary">${app.category || 'General'}</span>
                                    </div>
                                    ${app.sessions ? `<div class="small mt-1">${app.sessions} sessions</div>` : ''}
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        ` : ''}
        
        <h6 class="mt-4">Recent Sessions (${allApps.length} total):</h6>
        <div style="max-height: 400px; overflow-y: auto;">
            ${allApps.length > 0 ? allApps.map(app => {
                const appTime = parseFloat(app.activeUsageTime) || 0;
                const sessionTime = parseFloat(app.currentSessionDuration) || 0;
                const appName = app.currentApp || 'Unknown App';
                
                return `
                    <div class="app-usage-card mb-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <div style="flex: 1;">
                                <strong>${appName}</strong>
                                <div class="small text-muted">
                                    Session: ${formatSecondsToTime(sessionTime)} | 
                                    Daily Total: ${formatSecondsToTime(appTime)}
                                </div>
                                <div class="small">
                                    ${app.timestamp ? new Date(app.timestamp).toLocaleString() : 'Unknown time'}
                                </div>
                            </div>
                            <div class="text-end">
                                <small class="text-muted d-block">${formatTimeAgo(app.timestamp)}</small>
                                ${app.totalAppsTracked ? `
                                    <small class="text-muted">${app.totalAppsTracked} apps tracked</small>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('') : '<div class="text-muted text-center py-4">No app sessions available</div>'}
        </div>
    `;
    
    $('#deviceAppsContent').html(appsHtml);
}
    
        // Add this helper function
        function getDeviceAppUsageByDate(deviceId, date) {
    return new Promise((resolve, reject) => {
        $.ajax({
            url: `${API_BASE_URL}/devices/${deviceId}/app-usage/daily?date=${date}`,
            method: 'GET',
            success: function (data) {
                if (data.success && data.data) {
                    resolve(data.data);
                } else {
                    resolve({
                        dailyUsage: 0,
                        categoryBreakdown: {}
                    });
                }
            },
            error: function () {
                resolve({
                    dailyUsage: 0,
                    categoryBreakdown: {}
                });
            }
        });
    });
}
  
        // New function for date-specific loading
        function loadDeviceAppsByDate(deviceId, dateString) {
    const date = dateString || new Date().toISOString().split('T')[0];
    
    // Load daily summary for the specific date
    $.ajax({
        url: `${API_BASE_URL}/devices/${deviceId}/app-usage/daily?date=${date}`,
        method: 'GET',
        success: function (dailyData) {
            if (dailyData.success && dailyData.data) {
                const dailyUsage = dailyData.data;
                
                // Load historical data filtered by date
                const dateObj = new Date(date);
                const startOfDay = dateObj.toISOString();
                dateObj.setDate(dateObj.getDate() + 1);
                const endOfDay = dateObj.toISOString();
                
                // Load all apps and filter by date client-side
                $.ajax({
                    url: `${API_BASE_URL}/devices/${deviceId}/app-usage`,
                    method: 'GET',
                    success: function (allData) {
                        if (allData.success && allData.data) {
                            // Filter to selected date
                            const filteredApps = allData.data.filter(app => {
                                if (!app.timestamp) return false;
                                const appDate = new Date(app.timestamp).toISOString().split('T')[0];
                                return appDate === date;
                            });
                            
                            renderDeviceAppsByDate(dailyUsage, filteredApps, date);
                        }
                    }
                });
            }
        },
        error: function () {
            showError('Failed to load app usage data for selected date');
        }
    });
}

        function renderDeviceAppsByDate(dailyUsage, filteredApps, date) {
    const dailyTotal = parseFloat(dailyUsage.dailyUsage) || 0;
    const categoryBreakdown = dailyUsage.categoryBreakdown || {};
    const latestApp = dailyUsage.latestApp || '';
    const latestSessionDuration = parseFloat(dailyUsage.latestSessionDuration) || 0;
    const topApps = dailyUsage.topApps || [];
    
    const appsHtml = `
        <div class="mb-4">
            <div class="alert alert-info">
                <i class="bi bi-calendar me-2"></i>
                Showing data for <strong>${date}</strong>
            </div>
            <div class="row text-center">
                <div class="col-12">
                    <div class="display-3 text-primary">${formatSecondsToTime(dailyTotal)}</div>
                    <small class="text-muted">Total Usage for ${date}</small>
                </div>
            </div>
        </div>
        
        ${Object.keys(categoryBreakdown).length > 0 ? `
            <div class="mb-4">
                <h6>Category Breakdown for ${date}:</h6>
                <div class="row">
                    ${Object.entries(categoryBreakdown).map(([category, time]) => `
                        <div class="col-12 mb-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <div style="flex: 1;">
                                    <strong>${category}</strong>
                                    <div class="progress mt-1" style="height: 8px;">
                                        <div class="progress-bar bg-info" style="width: ${(time / (dailyTotal || 1) * 100) || 0}%"></div>
                                    </div>
                                </div>
                                <span class="text-muted ms-2">${formatSecondsToTime(time)}</span>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        ` : '<div class="text-muted text-center py-4">No category data available for this date</div>'}
        
        <h6 class="mt-4">Sessions on ${date} (${filteredApps.length}):</h6>
        <div style="max-height: 400px; overflow-y: auto;">
            ${filteredApps.length > 0 ? filteredApps.map(app => {
                const appTime = parseFloat(app.activeUsageTime) || 0;
                const sessionTime = parseFloat(app.currentSessionDuration) || 0;
                const appName = app.currentApp || 'Unknown App';
                
                return `
                    <div class="app-usage-card mb-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <div style="flex: 1;">
                                <strong>${appName}</strong>
                                <div class="small text-muted">
                                    Session: ${formatSecondsToTime(sessionTime)} | 
                                    Total: ${formatSecondsToTime(appTime)}
                                </div>
                                <div class="small">
                                    ${app.timestamp ? new Date(app.timestamp).toLocaleTimeString() : 'Unknown time'}
                                </div>
                            </div>
                            <div class="text-end">
                                <small class="text-muted">${app.totalAppsTracked || 0} apps</small>
                            </div>
                        </div>
                    </div>
                `;
            }).join('') : '<div class="text-muted text-center py-4">No app sessions for this date</div>'}
        </div>
    `;
    
    $('#deviceAppsContent').html(appsHtml);
}
  
  </script>
</body>
</html>